<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMP√ÅS - Dise√±o ciudadano de la salud</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // Verificaci√≥n temprana
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('firebase')) {
                console.error('Error cargando Firebase:', e);
            }
        });
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; }
        .header { background: white; color: #333; padding: 1.5rem 2rem; border-bottom: 1px solid #e9ecef; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header-left { display: flex; align-items: center; gap: 1.5rem; }
        .logo-sas { display: flex; align-items: center; gap: 0.5rem; }
        .logo-sas-a { width: 50px; height: 50px; }
        .logo-sas-text { display: flex; flex-direction: column; font-size: 0.65rem; line-height: 1.3; }
        .logo-sas-text .sas-nombre { font-weight: 700; font-size: 0.75rem; color: #94d40b; }
        .logo-sas-text .sas-consejeria { color: #666; }
        .logo-itaca-distrito { display: flex; align-items: center; gap: 1rem; }
        .logo-distrito { height: 55px; width: auto; }
        .separador-vertical { width: 2px; height: 45px; background: linear-gradient(180deg, #0074c8 0%, #00acd9 25%, #94d40b 50%, #ffb61b 75%, #ff6600 100%); border-radius: 1px; }
        .itaca-branding { display: flex; flex-direction: column; justify-content: center; }
        .itaca-nombre { font-size: 1.8rem; font-weight: 700; background: linear-gradient(90deg, #0074c8 0%, #00acd9 20%, #94d40b 40%, #ffb61b 60%, #ff6600 80%, #dc143c 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: 3px; line-height: 1; }
        .itaca-descripcion { font-size: 0.75rem; background: linear-gradient(90deg, #0074c8 0%, #00acd9 20%, #94d40b 40%, #ffb61b 60%, #ff6600 80%, #dc143c 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-top: 2px; font-weight: 500; }

        .municipio-selector { display: flex; align-items: center; gap: 0.5rem; }
        .municipio-selector label { font-weight: 600; }
        .municipio-selector select { padding: 0.5rem 1rem; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; background: white; }
        
        /* Logos institucionales */
        .logos-institucionales { display: flex; justify-content: center; align-items: center; gap: 1.5rem; margin-bottom: 2rem; flex-wrap: nowrap; }
        .logo-institucional { height: 120px; width: auto; max-width: 350px; object-fit: contain; }
        .logo-institucional.consejeria { height: 170px; }
        .logo-institucional.distrito { height: 140px; }
        .logo-institucional.relas { height: 150px; }
        .logo-institucional.violencia { height: 120px; }
        .logo-institucional.rasselh { height: 140px; }
        .franja { height: 6px; background: linear-gradient(90deg, #0074c8 0%, #00acd9 20%, #94d40b 40%, #ffb61b 60%, #ff6600 80%, #dc143c 100%); }
        .relas-container { background: white; border-bottom: 1px solid #e9ecef; padding: 1.5rem; }
        .relas-fases { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .fase { text-align: center; flex: 1; min-width: 120px; padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .fase:hover { transform: translateY(-2px); }
        .fase.activa { background: #0074c8; color: white; }
        .fase-num { font-size: 1.5rem; font-weight: 700; }
        .fase-nombre { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .fase:nth-child(1) { border-left: 4px solid #0074c8; }
        .fase:nth-child(2) { border-left: 4px solid #00acd9; }
        .fase:nth-child(3) { border-left: 4px solid #94d40b; }
        .fase:nth-child(4) { border-left: 4px solid #ffb61b; }
        .fase:nth-child(5) { border-left: 4px solid #dc143c; }
        .fase:nth-child(6) { border-left: 4px solid #00acd9; }
        .main { max-width: 1200px; margin: 2.5rem auto; padding: 0 1rem; }
        .btn-accion { display: inline-block; background: #0074c8; color: white; padding: 0.85rem 1.2rem; border: 2px solid #0074c8; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-bottom: 1rem; white-space: nowrap; }
        .btn-accion:hover { background: #0074c8; border-color: #0074c8; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 116, 200, 0.4); }
        .btn-accion.activo { background: #0074c8; border-color: #ffb61b; box-shadow: 0 0 0 3px rgba(255, 182, 27, 0.3); }
        .btn-accion.activo::after { content: ' ‚ñ≤'; }
        .btn-accion:not(.activo)::after { content: ' ‚ñº'; }
        
        /* ESTILO PDF INSTITUCIONAL - Informe epidemiol√≥gico */
        #btn-valoracion { 
            background: linear-gradient(135deg, #FF6B35 0%, #F05A28 100%); 
            border: 3px solid #1B365D; 
            border-radius: 0; 
            padding: 1.2rem 2rem; 
            font-size: 1.05rem; 
            font-weight: 700; 
            letter-spacing: 0.3px;
            box-shadow: 0 4px 8px rgba(27, 54, 93, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-transform: none;
            position: relative;
            overflow: hidden;
        }
        #btn-valoracion::before {
            content: 'üìã';
            font-size: 1.3rem;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        #btn-valoracion::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #1B365D;
        }
        #btn-valoracion:hover { 
            background: linear-gradient(135deg, #1B365D 0%, #2B4670 100%); 
            border-color: #FF6B35; 
            transform: translateY(-3px); 
            box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        #btn-valoracion.activo { 
            background: #1B365D; 
            border-color: #FF6B35; 
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.3), inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #btn-valoracion.activo::after { 
            content: ' ‚ñ≤'; 
            position: static;
            background: none;
            height: auto;
        }
        #btn-valoracion:not(.activo)::after { 
            content: ' ‚ñº'; 
            position: static;
            background: none;
            height: auto;
        }
        
        .btn-accion.secundario { background: #94d40b; border-color: #94d40b; }
        .btn-accion.secundario:hover { background: #0074c8; }
        .btn-accion.secundario.activo { background: #0074c8; border-color: #94d40b; }
        .btn-accion.terciario { background: #ff6600; border-color: #ff6600; }
        .btn-accion.terciario:hover { background: #ff6600; }
        .btn-accion.terciario.activo { background: #cc5200; border-color: #ffb61b; }
        .btn-exportar { background: #00acd9; border-color: #00acd9; font-size: 0.85rem; padding: 0.5rem 1rem; }
        .btn-exportar:hover { background: #00acd9; }
        .btn-exportar::after { content: '' !important; }
        .btn-export { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.5rem 0.8rem; background: white; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.8rem; color: #475569; cursor: pointer; transition: all 0.2s; }
        .btn-export:hover { background: #f1f5f9; border-color: #94a3b8; }
        .btn-export span { font-size: 1rem; }
        .export-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .botones-fase { margin-bottom: 2rem; display: flex; flex-wrap: nowrap; gap: 0.5rem; overflow-x: auto; }
        .registro-container, .informe-container, .hoja-ruta-container { display: none; margin-top: 2rem; background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .registro-container.visible, .informe-container.visible, .hoja-ruta-container.visible { display: block; }
        
        /* Cabecera institucional dentro del informe */
        .informe-container .header-institucional { 
            padding: 1.5rem 0; 
            margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            background: white;
            border-bottom: 6px solid;
            border-image: linear-gradient(90deg, #0074c8 0%, #00acd9 20%, #94d40b 40%, #ffb61b 60%, #ff6600 80%, #dc143c 100%) 1;
        }
        .informe-container .header-institucional img { max-height: 100px; }
        
        /* ESTILO PDF INSTITUCIONAL - Contenedor del Informe */
        .informe-container { 
            border-radius: 0; 
            border-top: 4px solid #FF6B35; 
            box-shadow: 0 4px 12px rgba(27, 54, 93, 0.15); 
        }
        .informe-container h3 { 
            color: #1B365D; 
            margin: 1.5rem 0 1rem; 
            padding: 0.8rem 1.2rem; 
            background: linear-gradient(90deg, #FF6B35 0%, #F05A28 100%); 
            color: white;
            border-left: none; 
            border-radius: 0; 
            font-weight: 700; 
            font-size: 1.2rem;
            letter-spacing: 0.5px;
            text-transform: none;
            border-bottom: 3px solid #1B365D;
        }
        .informe-container h3:first-child { margin-top: 0; }
        .informe-container h2 {
            color: #999999;
            font-size: 3.5rem;
            font-weight: 300;
            margin: 2rem 0 0.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #1B365D;
            letter-spacing: -2px;
        }
        .informe-container h2 + h3 {
            margin-top: 0.5rem;
        }
        .informe-container h4 { 
            color: #FF6B35; 
            margin: 1.2rem 0 0.6rem; 
            font-weight: 700; 
            border-bottom: 2px solid #FF6B35;
            padding-bottom: 0.3rem;
        }
        .informe-container p { margin-bottom: 1rem; line-height: 1.7; color: #333; }
        .informe-container strong { color: #1B365D; font-weight: 700; }
        .informe-container ul, .informe-container ol { margin-bottom: 1rem; padding-left: 1.5rem; }
        .informe-container li { margin-bottom: 0.5rem; line-height: 1.7; }
        
        /* Tablas estilo PDF institucional */
        .informe-container table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .informe-container th {
            background: linear-gradient(90deg, #FF6B35 0%, #F05A28 100%);
            color: white;
            padding: 0.9rem 1rem;
            text-align: left;
            font-weight: 700;
            border-bottom: 3px solid #1B365D;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
        }
        .informe-container td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }
        .informe-container tr:nth-child(even) td {
            background: #f9f9f9;
        }
        .informe-container tr:hover td {
            background: #fff8f5;
        }
        .informe-contenido { line-height: 1.6; }
        .registro-container h3 { color: #0074c8; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #94d40b; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; font-family: inherit; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #0074c8; box-shadow: 0 0 0 2px rgba(0, 116, 200, 0.2); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .btn-registrar { background: #94d40b; color: #333; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 1rem; }
        .btn-registrar:hover { background: #94d40b; }
        .miembros-lista { margin-top: 2rem; }
        .miembros-lista h4 { color: #0074c8; margin-bottom: 1rem; }
        .sin-miembros { color: #666; font-style: italic; }
        .btn-eliminar { background: none; border: none; cursor: pointer; padding: 0.25rem 0.5rem; font-size: 1.1rem; border-radius: 4px; }
        .btn-eliminar:hover { background: #ffebee; }
        .acordeon-item { background: white; border-radius: 8px; margin-bottom: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; border: 1px solid #e9ecef; }
        .acordeon-header { background: linear-gradient(135deg, #0074c8 0%, #00acd9 100%); color: white; padding: 1rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; transition: all 0.3s; }
        .acordeon-header:hover { background: linear-gradient(135deg, #0074c8 0%, #00acd9 100%); box-shadow: 0 2px 8px rgba(0,116,200,0.3); }
        .acordeon-item.abierto .acordeon-header .flecha { transform: rotate(180deg); }
        .acordeon-contenido { display: none; padding: 1.5rem; background: white; }
        .acordeon-item.abierto .acordeon-contenido { display: block; }
        .acordeon-contenido h3 { color: #0074c8; margin: 1.5rem 0 1rem; padding: 0.5rem 1rem; background: white; border-left: 4px solid #0074c8; border-radius: 0 8px 8px 0; font-weight: 700; }
        .acordeon-contenido h3:first-child { margin-top: 0; }
        .acordeon-contenido h4 { color: #00acd9; margin: 1rem 0 0.5rem; font-weight: 600; }
        .acordeon-contenido p { margin-bottom: 1rem; line-height: 1.6; }
        .acordeon-contenido strong { color: #0074c8; }
        .acordeon-contenido ul, .acordeon-contenido ol { margin-bottom: 1rem; padding-left: 1.5rem; }
        .acordeon-contenido li { margin-bottom: 0.5rem; line-height: 1.6; }
        .indicadores-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
        .indicador-card { background: #f8f9fa; border-radius: 8px; padding: 1rem; text-align: center; }
        .indicador-valor { font-size: 1.8rem; font-weight: 700; color: #0074c8; }
        .indicador-label { font-size: 0.8rem; color: #666; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.85rem; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        th { background: linear-gradient(135deg, #0074c8 0%, #0074c8 100%); color: white; padding: 0.75rem; text-align: left; font-weight: 600; }
        td { padding: 0.75rem; border-bottom: 1px solid #e9ecef; }
        tr:hover { background: #f8f9fa; }
        tr:nth-child(even) { background: #fafbfc; }
        
        /* C√≥digo semaf√≥rico */
        .semaforo { font-size: 1.2rem; display: inline-block; }
        .semaforo-verde { color: #94d40b; }
        .semaforo-amarillo { color: #ffb61b; }
        .semaforo-rojo { color: #dc143c; }
        
        /* Badges de valores */
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .badge-azul { background: #e6f2ff; color: #0074c8; }
        .badge-cian { background: #e6f9ff; color: #00acd9; }
        .badge-verde { background: #f0fff4; color: #94d40b; }
        .badge-naranja { background: #fff8e6; color: #ffb61b; }
        .badge-rojo { background: #fff0f0; color: #dc143c; }
        
        .autor-licencia { 
            background: white; 
            padding: 0.75rem 1rem; 
            border-radius: 8px; 
            margin-bottom: 1.5rem; 
            border-left: 4px solid #0074c8;
            font-size: 0.85rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .autor-licencia p { margin: 0.2rem 0; }
        .autor-licencia strong { color: #0074c8; }
        
        .elaboracion-informe {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
            border: 2px solid #e9ecef;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .elaboracion-informe h3 {
            color: #0074c8;
            margin: 0 0 1rem 0;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .epidemiologo-nombre {
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(90deg, #0074c8 0%, #00acd9 50%, #94d40b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0.5rem 0;
        }
        .epidemiologo-cargo {
            font-size: 1rem;
            color: #495057;
            font-style: italic;
            margin: 0.25rem 0;
        }
        .epidemiologo-entidad {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0.25rem 0;
        }

        .fuente { font-size: 0.75rem; color: #666; font-style: italic; margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; }
        .destacado { background: white; border-left: 4px solid #ffb61b; padding: 1rem 1.5rem; margin: 1rem 0; border-radius: 0 8px 8px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .destacado strong { color: #ffb61b; }
        .destacado-verde { border-left-color: #94d40b; }
        .destacado-verde strong { color: #94d40b; }
        .destacado-rojo { border-left-color: #dc143c; }
        .destacado-rojo strong { color: #dc143c; }
        .destacado-azul { border-left-color: #0074c8; }
        .destacado-azul strong { color: #0074c8; }
        .destacado-cian { border-left-color: #00acd9; }
        .destacado-cian strong { color: #00acd9; }
        .destacado-naranja { border-left-color: #ff6600; }
        .destacado-naranja strong { color: #ff6600; }
        .panel-gestion { background: white; border: 2px dashed #0074c8; border-radius: 12px; padding: 2rem; text-align: center; margin: 1rem 0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .panel-gestion h3 { color: #0074c8; margin-bottom: 1rem; }
        .panel-gestion p { color: #666; margin-bottom: 1.5rem; }
        .hoja-ruta { background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 4px solid #ff6600; }
        .hoja-ruta h3 { color: #ff6600; margin-bottom: 0.5rem; }
        .hoja-ruta-intro { color: #666; margin-bottom: 1rem; font-style: italic; }
        .hoja-ruta-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #f0f0f0; }
        .hoja-ruta-acciones { display: flex; gap: 0.5rem; }
        .btn-ordenar-fecha, .btn-a√±adir-hito { color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 0.9rem; }
        .btn-ordenar-fecha { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); }
        .btn-a√±adir-hito { background: linear-gradient(135deg, #ff6600 0%, #ff6600 100%); }
        .hitos-lista { display: flex; flex-direction: column; gap: 0.75rem; }
        .hito-card { background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 1rem; display: grid; grid-template-columns: auto 1fr auto auto; gap: 1rem; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .hito-card:hover { border-color: #ff6600; box-shadow: 0 2px 6px rgba(255,102,0,0.15); }
        .hito-card.completado { background: #f0fff4; border-color: #94d40b; }
        .hito-card.en-curso { background: #f0f7ff; border-color: #0074c8; }
        .hito-drag { color: #aaa; font-size: 1.2rem; }
        .hito-info { display: flex; flex-direction: column; gap: 0.25rem; }
        .hito-nombre { font-weight: 600; }
        .hito-descripcion-mini { font-size: 0.85rem; color: #666; }
        .hito-fecha-input { padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; width: 140px; }
        .hito-estado-select { padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; background: white; }
        .formulario-hito { background: white; border: 2px solid #ff6600; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; display: none; box-shadow: 0 2px 8px rgba(255,102,0,0.15); }
        .formulario-hito h4 { color: #ff6600; margin-bottom: 1rem; }
        .formulario-hito-botones { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .btn-guardar-hito { background: linear-gradient(135deg, #ff6600 0%, #ff6600 100%); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-cancelar-hito { background: #6c757d; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; }
        .fase-contenido { display: none; }
        .fase-contenido.activa { display: block; }
        
        /* ESTILOS DETERMINANTES - Valores estimados Bettersurveys */
        .determinantes-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .determinantes-tab { padding: 0.75rem 1.5rem; background: white; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .determinantes-tab:hover { border-color: #0074c8; color: #0074c8; transform: translateY(-1px); }
        .determinantes-tab.activo { background: linear-gradient(135deg, #0074c8 0%, #00acd9 100%); color: white; border-color: transparent; box-shadow: 0 2px 8px rgba(0,116,200,0.3); }
        .determinantes-area { display: none; }
        .determinantes-area.activa { display: block; }
        .escala-info { background: white; border: 2px solid #0074c8; border-radius: 10px; padding: 1rem; margin: 1rem 0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .escala-info h4 { color: #0074c8; margin-bottom: 0.5rem; font-size: 0.95rem; }
        .escala-info p { margin: 0.25rem 0; font-size: 0.9rem; color: #555; }
        .grupo-determinantes { margin: 1.5rem 0; }
        .grupo-determinantes-titulo { color: white; font-weight: 600; padding: 0.75rem 1rem; background: linear-gradient(90deg, #0074c8 0%, #00acd9 100%); border-radius: 8px; margin-bottom: 1rem; font-size: 1.1rem; }
        
        /* Tabla de indicadores con valores */
        .tabla-determinantes { width: 100%; border-collapse: collapse; margin: 1rem 0; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .tabla-determinantes th { background: linear-gradient(135deg, #0074c8 0%, #00acd9 100%); color: white; padding: 0.75rem; text-align: left; font-size: 0.85rem; font-weight: 600; }
        .tabla-determinantes th:nth-child(1) { width: 80px; }
        .tabla-determinantes th:nth-child(2) { width: auto; }
        .tabla-determinantes th:nth-child(3),
        .tabla-determinantes th:nth-child(4),
        .tabla-determinantes th:nth-child(5) { width: 100px; text-align: center; }
        .tabla-determinantes td { padding: 0.6rem 0.75rem; border-bottom: 1px solid #e9ecef; vertical-align: middle; }
        .tabla-determinantes tr:hover { background: #f8f9fa; }
        .tabla-determinantes tr:nth-child(even) { background: #fafbfc; }
        .tabla-determinantes .codigo { background: linear-gradient(135deg, #0074c8 0%, #00acd9 100%); color: white; padding: 0.25rem 0.6rem; border-radius: 6px; font-weight: 600; font-size: 0.8rem; display: inline-block; }
        .tabla-determinantes .indicador-texto { font-size: 0.9rem; font-weight: 500; }
        .tabla-determinantes input[type="number"] {
            width: 80px; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; 
            text-align: center; font-size: 0.9rem; font-weight: 600;
        }
        .tabla-determinantes input[type="number"]:focus { border-color: #0074c8; outline: none; box-shadow: 0 0 0 2px rgba(0, 116, 200, 0.2); }
        .tabla-determinantes .valor-referencia { font-size: 0.85rem; color: #666; text-align: center; }
        .tabla-determinantes .unidad { font-size: 0.75rem; color: #888; margin-left: 2px; }
        
        /* Comparativa visual */
        .comparativa { display: flex; align-items: center; gap: 0.5rem; justify-content: center; }
        .comparativa .mejor { color: #94d40b; font-weight: 700; }
        .comparativa .peor { color: #dc143c; font-weight: 700; }
        .comparativa .igual { color: #6c757d; }
        
        /* Conclusiones */
        .conclusion-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin: 1.5rem 0; }
        .conclusion-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 4px solid #0074c8; }
        .conclusion-card:nth-child(6n+1) { border-top-color: #0074c8; }
        .conclusion-card:nth-child(6n+2) { border-top-color: #00acd9; }
        .conclusion-card:nth-child(6n+3) { border-top-color: #94d40b; }
        .conclusion-card:nth-child(6n+4) { border-top-color: #ffb61b; }
        .conclusion-card:nth-child(6n+5) { border-top-color: #ff6600; }
        .conclusion-card:nth-child(6n+6) { border-top-color: #dc143c; }
        .conclusion-card h4 { color: #0074c8; font-size: 2rem; margin-bottom: 0.5rem; }
        .conclusion-card .tipo { font-weight: 700; color: #333; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        .conclusion-card p { font-size: 0.9rem; line-height: 1.5; }
        .conclusion-card .recomendacion { margin-top: 1rem; padding: 1rem; background: #f0fff4; border-radius: 8px; border-left: 4px solid #94d40b; }
        .conclusion-card .recomendacion .tipo { color: #94d40b; }
        
        /* Priorizaci√≥n */
        .priorizacion-resultado { background: white; border: 2px solid #ff6600; border-radius: 12px; padding: 2rem; margin: 1.5rem 0; box-shadow: 0 2px 8px rgba(255,102,0,0.15); }
        .priorizacion-resultado h4 { color: #ff6600; margin-bottom: 1rem; }
        .lineas-estrategicas { display: flex; gap: 1rem; flex-wrap: wrap; margin: 1rem 0; }
        .linea-estrategica { background: white; border-radius: 8px; padding: 1rem; flex: 1; min-width: 150px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #ff6600; }
        .linea-estrategica h5 { color: #ff6600; margin-bottom: 0.5rem; font-weight: 600; }
        
        /* Herramienta de seguimiento - Tablas de indicadores */
        .tabla-categoria { font-size: 1rem; margin: 1.5rem 0 0.75rem; padding: 0.75rem 1rem; background: white; border-left: 4px solid #0074c8; border-radius: 0 8px 8px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .tabla-categoria strong { color: #0074c8; }
        .tabla-categoria:first-of-type { margin-top: 1rem; }
        .tabla-indicadores { width: 100%; border-collapse: collapse; margin-bottom: 1.5rem; font-size: 0.8rem; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .tabla-indicadores thead th { background: linear-gradient(135deg, #0074c8 0%, #00acd9 100%); color: white; padding: 0.6rem 0.4rem; text-align: center; font-size: 0.75rem; font-weight: 600; }
        .tabla-indicadores thead th:nth-child(1) { width: 40px; }
        .tabla-indicadores thead th:nth-child(2) { text-align: left; }
        .tabla-indicadores thead th:nth-child(3) { width: 70px; }
        .tabla-indicadores thead th:nth-child(4) { width: 55px; }
        .tabla-indicadores thead th:nth-child(5),
        .tabla-indicadores thead th:nth-child(6) { width: 55px; }
        .tabla-indicadores thead th:nth-child(7) { width: 65px; }
        .tabla-indicadores tbody td { padding: 0.5rem 0.4rem; border-bottom: 1px solid #e9ecef; vertical-align: middle; }
        .tabla-indicadores tbody td:nth-child(1) { text-align: center; font-weight: 700; color: #0074c8; }
        .tabla-indicadores tbody td:nth-child(2) { font-weight: 500; }
        .tabla-indicadores tbody td:nth-child(3) { text-align: center; }
        .tabla-indicadores tbody td:nth-child(4) { text-align: center; font-size: 0.75rem; color: #666; }
        .tabla-indicadores tbody td:nth-child(5),
        .tabla-indicadores tbody td:nth-child(6) { text-align: center; font-size: 0.95rem; }
        .tabla-indicadores tbody td:nth-child(7) { text-align: center; font-size: 1.1rem; }
        .tabla-indicadores tbody tr:hover { background: #f8f9fa; }
        .tabla-indicadores tbody tr:nth-child(even) { background: #fafbfc; }
        
        /* Cuadro de mandos integral */
        .cuadro-mandos-container { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .cuadro-header { text-align: center; padding-bottom: 1.5rem; border-bottom: 2px solid #f0f0f0; margin-bottom: 2rem; }
        .dimensiones-resumen { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .dimension-card { background: white; border-radius: 8px; padding: 1rem; display: flex; align-items: center; gap: 1rem; transition: all 0.3s; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .dimension-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .dimension-icono { font-size: 2rem; }
        .dimension-info { flex: 1; }
        .dimension-nombre { font-weight: 700; font-size: 0.95rem; color: #333; }
        .dimension-stats { font-size: 0.85rem; color: #666; margin-top: 0.25rem; }
        .dimension-tabla { margin-bottom: 2rem; background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .dimension-tabla h3 { margin: 0 0 1rem; padding: 0.75rem 1rem; background: white; color: #333; border-radius: 8px; font-weight: 700; }
        .dimension-tabla table { box-shadow: none; }
        .dimension-tabla table th { font-weight: 700; }
        .dimension-tabla table td:nth-child(1) { font-weight: 700; }
        .dimension-tabla table td:nth-child(2) { font-weight: 500; }
        
        @media (max-width: 768px) {
            .header-content, .header-left { flex-direction: column; text-align: center; }
            .fase { min-width: 100px; }
            .hito-card { grid-template-columns: 1fr; }
            .determinantes-tabs { flex-direction: column; }
            .tabla-determinantes { font-size: 0.8rem; }
            .tabla-determinantes th:nth-child(4),
            .tabla-determinantes th:nth-child(5),
            .tabla-determinantes td:nth-child(4),
            .tabla-determinantes td:nth-child(5) { display: none; }
            .conclusion-grid { grid-template-columns: 1fr; }
            .lineas-estrategicas { flex-direction: column; }
            .tabla-indicadores { font-size: 0.7rem; }
            .tabla-indicadores thead th:nth-child(3),
            .tabla-indicadores thead th:nth-child(5),
            .tabla-indicadores thead th:nth-child(6),
            .tabla-indicadores tbody td:nth-child(3),
            .tabla-indicadores tbody td:nth-child(5),
            .tabla-indicadores tbody td:nth-child(6) { display: none; }
            .plan-accion-stats { flex-direction: column; gap: 0.5rem; }
            .panel-carga-grid { grid-template-columns: 1fr !important; }
        }
        
        /* Panel de Carga de datos */
        .panel-carga-datos { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 2px solid #e2e8f0; position: relative; }
        .panel-carga-header { margin-bottom: 1.5rem; }
        .panel-carga-header h3 { color: #1e293b; margin: 0 0 0.5rem; }
        .panel-carga-header p { color: #64748b; margin: 0; }
        .panel-carga-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
        .panel-carga-seccion { background: #f8fafc; border-radius: 10px; overflow: hidden; border: 1px solid #e2e8f0; }
        .panel-carga-seccion .seccion-header { color: white; padding: 0.75rem 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .panel-carga-seccion .seccion-body { padding: 1rem; }
        .panel-carga-seccion .seccion-body p { font-size: 0.85rem; color: #64748b; margin: 0 0 0.75rem; }
        .carga-opciones { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn-upload { display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; padding: 0.5rem 1rem; background: white; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-upload:hover { border-color: #0074c8; color: #0074c8; background: #f0f9ff; }
        .estado-carga { margin-top: 0.75rem; padding: 0.5rem; background: white; border-radius: 6px; font-size: 0.8rem; text-align: center; }
        .estado-carga .estado-pendiente { color: #f59e0b; }
        .estado-carga .estado-ok { color: #10b981; }
        .estado-carga .estado-warning { color: #f59e0b; font-weight: 600; }
        .estado-carga .estado-error { color: #dc143c; }
        .carga-tabs { display: flex; gap: 0.25rem; margin-bottom: 0.75rem; }
        .carga-tab { flex: 1; padding: 0.4rem; background: #e2e8f0; border: none; border-radius: 4px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .carga-tab.activo { background: #0074c8; color: white; }
        .carga-tab-content { display: none; }
        .carga-tab-content.activo { display: block; }
        .carga-tab-content textarea { width: 100%; padding: 0.6rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.85rem; font-family: inherit; resize: vertical; }
        .carga-tab-content input[type="text"] { width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 0.85rem; }
        .panel-carga-footer { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        
        /* Plan de acci√≥n - Sistema EPVSA */
        .plan-accion-header { background: linear-gradient(135deg, #0074c815 0%, #00acd915 100%); border: 2px solid #0074c8; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .plan-accion-header h2 { color: #0074c8; margin-bottom: 0.5rem; }
        .plan-accion-header p { color: #555; margin-bottom: 1rem; }
        .plan-accion-stats { display: flex; gap: 1rem; flex-wrap: wrap; }
        .stat-mini { background: white; padding: 0.5rem 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-mini span { display: block; font-size: 1.5rem; font-weight: 700; color: #0074c8; }
        .plan-accion-container { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .plan-accion-footer { margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; }
        .plan-resumen-container { margin-top: 1.5rem; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* √Årbol de l√≠neas estrat√©gicas */
        .epvsa-linea { border: 3px solid #0074c8; border-radius: 12px; margin-bottom: 1rem; overflow: hidden; }
        .epvsa-linea-header { padding: 1rem 1.5rem; color: white; cursor: pointer; display: flex; align-items: center; gap: 1rem; }
        .epvsa-linea-header input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .epvsa-linea-title { flex: 1; font-weight: 600; }
        .epvsa-linea-toggle { font-size: 1.2rem; transition: transform 0.3s; }
        .epvsa-linea.abierta .epvsa-linea-toggle { transform: rotate(180deg); }
        .epvsa-linea-content { display: none; padding: 1rem; background: #f8f9fa; }
        .epvsa-linea.abierta .epvsa-linea-content { display: block; }
        
        /* Objetivos */
        .epvsa-objetivo { background: white; border: 2px solid #e5e7eb; border-radius: 8px; margin-bottom: 0.75rem; overflow: hidden; }
        .epvsa-objetivo-header { padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        .epvsa-objetivo-header input[type="checkbox"] { width: 18px; height: 18px; }
        .epvsa-objetivo-codigo { background: #0074c8; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
        .epvsa-objetivo-nombre { flex: 1; font-size: 0.9rem; }
        .epvsa-objetivo-content { display: none; padding: 1rem; border-top: 1px solid #e5e7eb; background: #fafbfc; }
        .epvsa-objetivo.abierto .epvsa-objetivo-content { display: block; }
        
        /* Indicadores */
        .epvsa-seccion-titulo { font-weight: 600; color: #4b5563; font-size: 0.85rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .epvsa-indicador { display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.4rem; background: #f3f4f6; border-radius: 4px; margin-bottom: 0.25rem; font-size: 0.85rem; }
        .epvsa-indicador input[type="checkbox"] { width: 16px; height: 16px; margin-top: 2px; flex-shrink: 0; }
        
        /* Programas */
        .epvsa-programa { background: #fff9e6; border-left: 4px solid #f59e0b; border-radius: 0 8px 8px 0; padding: 0.75rem; margin-bottom: 0.5rem; }
        .epvsa-programa-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .epvsa-programa-header input[type="checkbox"] { width: 18px; height: 18px; }
        .epvsa-programa-codigo { background: #f59e0b; color: white; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
        .epvsa-programa-nombre { font-weight: 600; color: #ff6600; font-size: 0.9rem; }
        
        /* Actuaciones */
        .epvsa-actuacion { display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.3rem 0.5rem; font-size: 0.85rem; color: #ffb61b; }
        .epvsa-actuacion input[type="checkbox"] { width: 14px; height: 14px; margin-top: 2px; flex-shrink: 0; }
        
        /* ========== NUEVO SISTEMA PLAN DE ACCI√ìN ========== */
        .plan-modo-selector { background: linear-gradient(135deg, #0074c8 0%, #00acd9 100%); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; color: white; }
        .plan-modo-selector h2 { margin: 0 0 0.25rem 0; font-size: 1.8rem; }
        .plan-modo-selector > p { opacity: 0.9; margin-bottom: 1.5rem; }
        .plan-modos { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .plan-modo-btn { background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; padding: 1.5rem; cursor: pointer; text-align: left; transition: all 0.3s; display: flex; flex-direction: column; gap: 0.5rem; }
        .plan-modo-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
        .plan-modo-btn.activo { background: rgba(255,255,255,0.95); border-color: #10b981; color: #0074c8; }
        .plan-modo-btn .modo-icon { font-size: 2rem; }
        .plan-modo-btn .modo-titulo { font-size: 1.1rem; font-weight: 700; }
        .plan-modo-btn .modo-desc { font-size: 0.85rem; opacity: 0.8; line-height: 1.4; }
        .plan-modo-btn.activo .modo-desc { opacity: 0.7; }
        
        /* Modo Autom√°tico */
        .plan-auto-header { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #10b981; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center; }
        .plan-auto-header h3 { color: #94d40b; margin: 0 0 0.5rem 0; }
        .plan-auto-header p { color: #94d40b; margin-bottom: 1rem; }
        .btn-generar-propuesta { background: linear-gradient(135deg, #10b981 0%, #00acd9 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-generar-propuesta:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5); }
        

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Propuesta Autom√°tica */
        .propuesta-resumen { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .propuesta-resumen h3 { color: #0074c8; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem; }
        .analisis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .analisis-card { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 10px; padding: 1rem; border-left: 4px solid #0074c8; }
        .analisis-card h4 { font-size: 0.85rem; color: #64748b; margin: 0 0 0.5rem 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .analisis-card .valor { font-size: 1.5rem; font-weight: 700; color: #0074c8; }
        .analisis-card .detalle { font-size: 0.8rem; color: #64748b; margin-top: 0.25rem; }
        .analisis-card.alerta { border-left-color: #dc143c; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); }
        .analisis-card.alerta .valor { color: #dc143c; }
        .analisis-card.positivo { border-left-color: #10b981; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
        .analisis-card.positivo .valor { color: #00acd9; }
        
        .justificacion-box { background: #fffbeb; border: 1px solid #fcd34d; border-radius: 10px; padding: 1rem; margin-top: 1rem; }
        .justificacion-box h4 { color: #ff6600; margin: 0 0 0.5rem 0; font-size: 0.9rem; }
        .justificacion-box p { color: #ffb61b; font-size: 0.9rem; line-height: 1.5; margin: 0; }
        
        /* Detalle Propuesta */
        .propuesta-detalle { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .propuesta-linea { border: 2px solid; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden; }
        .propuesta-linea-header { padding: 1rem 1.5rem; color: white; display: flex; align-items: center; gap: 1rem; }
        .propuesta-linea-header h4 { margin: 0; flex: 1; }
        .propuesta-linea-relevancia { background: rgba(255,255,255,0.2); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; }
        .propuesta-linea-content { padding: 1.5rem; background: #fafbfc; }
        
        .propuesta-objetivo { background: white; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; border: 1px solid #e5e7eb; }
        .propuesta-objetivo-header { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem; }
        .propuesta-objetivo-codigo { padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; color: white; }
        .propuesta-objetivo-nombre { font-weight: 600; color: #0074c8; flex: 1; }
        .propuesta-objetivo-match { font-size: 0.75rem; color: #00acd9; background: #dcfce7; padding: 0.2rem 0.5rem; border-radius: 4px; }
        
        .propuesta-indicadores { margin: 0.75rem 0; padding: 0.75rem; background: #f3f4f6; border-radius: 8px; }
        .propuesta-indicadores h5 { font-size: 0.8rem; color: #6b7280; margin: 0 0 0.5rem 0; }
        .propuesta-indicador-item { font-size: 0.85rem; color: #374151; padding: 0.25rem 0; display: flex; align-items: center; gap: 0.5rem; }
        .propuesta-indicador-item::before { content: "üìä"; font-size: 0.75rem; }
        
        .propuesta-programas { margin-top: 0.75rem; }
        .propuesta-programa { background: linear-gradient(135deg, #fff9e6 0%, #ffd966 100%); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; }
        .propuesta-programa-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .propuesta-programa-codigo { background: #f59e0b; color: white; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .propuesta-programa-nombre { font-weight: 600; color: #ff6600; font-size: 0.9rem; }
        .propuesta-actuacion { font-size: 0.85rem; color: #ffb61b; padding: 0.2rem 0 0.2rem 1rem; display: flex; align-items: center; gap: 0.4rem; }
        .propuesta-actuacion::before { content: "‚ñ∏"; color: #ffb61b; }
        
        /* Acciones Propuesta */
        .propuesta-acciones { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap; }
        
        /* Documento Plan */
        .plan-documento-container { background: white; border-radius: 16px; padding: 2rem; margin-top: 1.5rem; box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        .plan-documento { max-width: 800px; margin: 0 auto; }
        .plan-documento-header { text-align: center; padding-bottom: 1.5rem; border-bottom: 3px solid #0074c8; margin-bottom: 2rem; }
        .plan-documento-header h1 { color: #0074c8; font-size: 1.8rem; margin: 0 0 0.5rem 0; }
        .plan-documento-header .subtitulo { color: #64748b; font-size: 1rem; }
        .plan-documento-header .municipio-nombre { color: #10b981; font-size: 1.3rem; font-weight: 700; margin-top: 0.5rem; }
        .plan-documento-header .fecha { color: #94a3b8; font-size: 0.9rem; margin-top: 0.5rem; }
        
        .plan-documento-seccion { margin-bottom: 2rem; page-break-inside: avoid; }
        .plan-documento-seccion h2 { color: #0074c8; font-size: 1.2rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .plan-documento-seccion h3 { color: #374151; font-size: 1rem; margin: 1rem 0 0.5rem 0; }
        
        .doc-linea { border-left: 4px solid; padding-left: 1rem; margin-bottom: 1.5rem; }
        .doc-linea h3 { margin-top: 0; }
        .doc-objetivo { background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .doc-objetivo-titulo { font-weight: 600; color: #0074c8; margin-bottom: 0.5rem; }
        .doc-indicadores { font-size: 0.9rem; color: #64748b; margin: 0.5rem 0; padding-left: 1rem; }
        .doc-programa { background: #fffbeb; border-radius: 6px; padding: 0.75rem; margin: 0.5rem 0; }
        .doc-programa-titulo { font-weight: 600; color: #ff6600; font-size: 0.9rem; }
        .doc-actuaciones { font-size: 0.85rem; color: #ffb61b; padding-left: 1rem; margin-top: 0.5rem; }
        
        .plan-documento-footer { text-align: center; padding-top: 1.5rem; border-top: 2px solid #e5e7eb; margin-top: 2rem; }
        .plan-documento-footer p { color: #94a3b8; font-size: 0.85rem; margin: 0; }
        
        .plan-documento-acciones { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; }
        
        @media (max-width: 768px) {
            .plan-modos { grid-template-columns: 1fr; }
            .analisis-grid { grid-template-columns: 1fr; }
        }
        
        @media print {
            .plan-documento-acciones { display: none; }
            .plan-documento-container { box-shadow: none; padding: 0; }
        }
        
        /* ========== AGENDAS ANUALES - FASE 6 ========== */
        /* Selector de tipo de agenda */
        .agendas-tipo-selector { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .btn-agenda-tipo { background: #f1f5f9; border: 2px solid #e2e8f0; padding: 1rem 1.5rem; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 1rem; }
        .btn-agenda-tipo:hover { background: #e2e8f0; }
        .btn-agenda-tipo.activo { background: linear-gradient(135deg, #94d40b 0%, #94d40b 100%); color: white; border-color: #94d40b; }

        /* Agenda tipo Listado - Cat√°logo de referencia */
        .agenda-tipo-listado { display: flex; flex-direction: column; gap: 0; }

        /* L√≠neas estrat√©gicas en Agenda tipo */
        .agenda-tipo-linea { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .agenda-tipo-linea-header { padding: 1rem 1.25rem; display: flex; align-items: center; gap: 0.75rem; }
        .agenda-tipo-linea-codigo { color: white; padding: 0.3rem 0.7rem; border-radius: 6px; font-size: 0.85rem; font-weight: 700; }
        .agenda-tipo-linea-nombre { flex: 1; font-weight: 600; color: #1e293b; font-size: 1.05rem; }
        .agenda-tipo-linea-count { background: #e2e8f0; padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.8rem; color: #64748b; }
        .agenda-tipo-linea-objetivos { padding: 0.75rem 1.25rem; background: #f8fafc; font-size: 0.85rem; color: #475569; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }

        .agenda-tipo-programas { padding: 1rem; }

        /* Programas en Agenda tipo */
        .agenda-tipo-programa { background: #fefefe; border-radius: 10px; border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 0.75rem; }
        .agenda-tipo-programa:last-child { margin-bottom: 0; }
        .agenda-tipo-programa-header { background: linear-gradient(135deg, #f59e0b10 0%, #fff9e610 100%); padding: 0.9rem 1.1rem; display: flex; align-items: center; gap: 0.6rem; cursor: pointer; border-bottom: 1px solid transparent; flex-wrap: wrap; }
        .agenda-tipo-programa-header:hover { background: linear-gradient(135deg, #f59e0b20 0%, #fff9e620 100%); }
        .agenda-tipo-programa.abierto .agenda-tipo-programa-header { border-bottom-color: #e2e8f0; }
        .agenda-tipo-programa-codigo { background: #f59e0b; color: white; padding: 0.2rem 0.5rem; border-radius: 5px; font-size: 0.75rem; font-weight: 700; }
        .agenda-tipo-programa-nombre { flex: 1; font-weight: 600; color: #ff6600; font-size: 0.9rem; min-width: 200px; }
        .agenda-tipo-programa-ambito { background: #fff9e6; color: #ff6600; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; }
        .agenda-tipo-programa-count { background: #f1f5f9; padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.75rem; color: #64748b; }
        .agenda-tipo-toggle { color: #94a3b8; transition: transform 0.2s; }
        .agenda-tipo-programa.abierto .agenda-tipo-toggle { transform: rotate(180deg); }
        .agenda-tipo-programa-content { padding: 1rem; display: none; background: #fafafa; }
        .agenda-tipo-programa.abierto .agenda-tipo-programa-content { display: block; }
        .agenda-tipo-programa-info { font-size: 0.85rem; color: #64748b; margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #e2e8f0; }
        .agenda-tipo-programa-info p { margin: 0.25rem 0; }
        .agenda-tipo-actuaciones-titulo { font-weight: 600; color: #475569; margin-bottom: 0.75rem; font-size: 0.9rem; }


        .agenda-tipo-actuacion { display: flex; align-items: flex-start; gap: 0.6rem; padding: 0.6rem 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.4rem; border: 1px solid #f1f5f9; }
        .agenda-tipo-actuacion:hover { background: #f8fafc; border-color: #e2e8f0; }
        .agenda-tipo-actuacion-num { background: #e2e8f0; color: #64748b; width: 20px; height: 20px; border-radius: 50%; font-size: 0.7rem; font-weight: 600; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .agenda-tipo-actuacion-codigo { background: #0074c8; color: white; padding: 0.1rem 0.35rem; border-radius: 3px; font-size: 0.65rem; font-weight: 600; font-family: monospace; white-space: nowrap; }
        .agenda-tipo-actuacion-nombre { flex: 1; font-size: 0.85rem; color: #374151; line-height: 1.4; }
        .agenda-tipo-actuacion-btn { background: linear-gradient(135deg, #10b981 0%, #00acd9 100%); color: white; border: none; padding: 0.35rem 0.7rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; opacity: 0.85; }
        .agenda-tipo-actuacion-btn:hover { opacity: 1; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4); }
        .agenda-tipo-actuacion:hover .agenda-tipo-actuacion-btn { opacity: 1; }

        .agendas-header { background: linear-gradient(135deg, #94d40b 0%, #94d40b 100%); border-radius: 16px; padding: 1.5rem 2rem; margin-bottom: 1.5rem; color: white; }
        .agendas-header-top { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; }
        .agendas-header h2 { margin: 0 0 0.25rem 0; font-size: 1.6rem; }
        .agendas-header > div > p { margin: 0; opacity: 0.9; }
        .agendas-header-actions { display: flex; gap: 0.75rem; }
        .btn-nueva-accion { background: white; color: #94d40b; border: none; padding: 0.75rem 1.25rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .btn-nueva-accion:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-exportar-agendas { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.5); padding: 0.75rem 1.25rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-exportar-agendas:hover { background: rgba(255,255,255,0.3); }
        
        .agendas-filtros { display: flex; gap: 1.5rem; margin-top: 1.25rem; align-items: center; flex-wrap: wrap; }
        .agendas-filtros label { font-size: 0.85rem; opacity: 0.9; margin-right: 0.5rem; }
        .agendas-filtros select { background: rgba(255,255,255,0.95); border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer; }
        .agendas-stats { margin-left: auto; }
        .stat-badge { background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; }
        
        /* Kanban Board */
        .agendas-kanban { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        .kanban-columna { background: #f8fafc; border-radius: 12px; min-height: 400px; display: flex; flex-direction: column; }
        .kanban-header { padding: 1rem; border-radius: 12px 12px 0 0; display: flex; align-items: center; gap: 0.5rem; color: white; font-weight: 600; }
        .kanban-header.sanitario { background: linear-gradient(135deg, #0074c8 0%, #0074c8 100%); }
        .kanban-header.comunitario { background: linear-gradient(135deg, #00acd9 0%, #00acd9 100%); }
        .kanban-header.educativo { background: linear-gradient(135deg, #ea580c 0%, #f97316 100%); }
        .kanban-header.laboral { background: linear-gradient(135deg, #00acd9 0%, #00acd9 100%); }
        .kanban-icon { font-size: 1.25rem; }
        .kanban-titulo { flex: 1; }
        .kanban-count { background: rgba(255,255,255,0.3); padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; }
        .kanban-body { flex: 1; padding: 0.75rem; overflow-y: auto; min-height: 300px; }
        .kanban-body.drag-over { background: #e0f2fe; border: 2px dashed #0074c8; }
        
        /* Tarjetas de Acci√≥n Mejoradas */
        .accion-card { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: grab; transition: all 0.2s; border-left: 4px solid #e5e7eb; position: relative; }
        .accion-card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.12); transform: translateY(-2px); }
        .accion-card.dragging { opacity: 0.5; cursor: grabbing; }
        .accion-card.prioridad-alta { border-left-color: #dc143c; }
        .accion-card.prioridad-media { border-left-color: #f59e0b; }
        .accion-card.prioridad-baja { border-left-color: #94d40b; }
        
        .accion-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.6rem; }
        .accion-nombre { font-weight: 600; color: #1e293b; font-size: 0.9rem; flex: 1; line-height: 1.35; }
        .accion-menu { position: relative; }
        .accion-menu-btn { background: none; border: none; cursor: pointer; padding: 0.25rem; font-size: 1rem; opacity: 0.5; transition: opacity 0.2s; }
        .accion-menu-btn:hover { opacity: 1; }
        .accion-menu-dropdown { position: absolute; right: 0; top: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 100; display: none; min-width: 140px; overflow: hidden; }
        .accion-menu-dropdown.visible { display: block; }
        .accion-menu-item { padding: 0.6rem 1rem; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; transition: background 0.15s; }
        .accion-menu-item:hover { background: #f1f5f9; }
        .accion-menu-item.eliminar { color: #dc143c; }
        .accion-menu-item.eliminar:hover { background: #fef2f2; }
        
        .accion-badges { display: flex; gap: 0.35rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
        .badge-epvsa { background: linear-gradient(135deg, #0074c8 0%, #334155 100%); color: white; font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 700; letter-spacing: 0.5px; }
        .badge-linea { color: white; font-size: 0.65rem; padding: 0.2rem 0.45rem; border-radius: 4px; font-weight: 700; }
        .badge-anio { background: #dbeafe; color: #1e40af; font-size: 0.65rem; padding: 0.2rem 0.45rem; border-radius: 4px; font-weight: 600; }
        .badge-trimestre { background: #f3e8ff; color: #00acd9; font-size: 0.65rem; padding: 0.2rem 0.45rem; border-radius: 4px; font-weight: 600; }
        
        .accion-programa-ref { font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem; padding: 0.35rem 0.5rem; background: #f8fafc; border-radius: 4px; }
        
        .accion-descripcion { font-size: 0.8rem; color: #475569; line-height: 1.4; margin-bottom: 0.6rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .accion-info-grid { display: flex; flex-direction: column; gap: 0.3rem; margin-bottom: 0.6rem; }
        .info-item { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: #64748b; }
        .info-icon { font-size: 0.85rem; }
        .info-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .accion-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: #94a3b8; border-top: 1px solid #f1f5f9; padding-top: 0.5rem; margin-top: 0.5rem; gap: 0.5rem; }
        .accion-responsable { display: flex; align-items: center; gap: 0.25rem; flex: 1; min-width: 0; }
        .accion-responsable span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .resp-icon { flex-shrink: 0; }
        .accion-org { color: #64748b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px; }
        
        /* Modal Detalle Acci√≥n */
        .modal-detalle { background: white; border-radius: 16px; width: 100%; max-width: 800px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
        .modal-detalle-header { padding: 1.5rem 2rem; color: white; position: relative; }
        .modal-detalle-badges { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .modal-detalle-badges span { background: rgba(255,255,255,0.2); padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .badge-prioridad { font-weight: 700 !important; }
        .modal-detalle-header h2 { margin: 0; font-size: 1.4rem; line-height: 1.3; padding-right: 2rem; }
        .modal-cerrar-detalle { position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; transition: background 0.2s; }
        .modal-cerrar-detalle:hover { background: rgba(255,255,255,0.3); }
        
        .modal-detalle-body { padding: 1.5rem 2rem; overflow-y: auto; flex: 1; }
        .detalle-seccion { margin-bottom: 1.5rem; }
        .detalle-seccion:last-child { margin-bottom: 0; }
        .detalle-seccion h4 { color: #1e293b; font-size: 0.95rem; margin: 0 0 0.75rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
        .detalle-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .detalle-item { display: flex; flex-direction: column; gap: 0.25rem; }
        .detalle-item.full-width { grid-column: 1 / -1; }
        .detalle-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .detalle-value { font-size: 0.9rem; color: #1e293b; line-height: 1.4; }
        .detalle-descripcion { font-size: 0.95rem; color: #374151; line-height: 1.6; background: #f8fafc; padding: 1rem; border-radius: 8px; }
        
        .modal-detalle-footer { padding: 1rem 2rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc; }
        .btn-editar-detalle { background: linear-gradient(135deg, #0074c8 0%, #00acd9 100%); color: white; border: none; padding: 0.6rem 1.25rem; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-editar-detalle:hover { opacity: 0.9; }
        .btn-cerrar-detalle { background: #e5e7eb; color: #374151; border: none; padding: 0.6rem 1.25rem; border-radius: 8px; font-weight: 500; cursor: pointer; }
        .btn-cerrar-detalle:hover { background: #d1d5db; }
        
        @media (max-width: 600px) {
            .modal-detalle-body { padding: 1rem; }
            .modal-detalle-header { padding: 1rem; }
            .modal-detalle-header h2 { font-size: 1.1rem; }
            .detalle-grid { grid-template-columns: 1fr; }
        }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-accion { background: white; border-radius: 16px; width: 100%; max-width: 650px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { background: linear-gradient(135deg, #94d40b 0%, #94d40b 100%); color: white; padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 1.2rem; }
        .modal-cerrar { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; transition: background 0.2s; }
        .modal-cerrar:hover { background: rgba(255,255,255,0.3); }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
        .modal-body .form-group { margin-bottom: 1rem; }
        .modal-body .form-group label { display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.35rem; }
        .modal-body .form-group input,
        .modal-body .form-group select,
        .modal-body .form-group textarea { width: 100%; padding: 0.6rem 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; transition: border-color 0.2s; }
        .modal-body .form-group input:focus,
        .modal-body .form-group select:focus,
        .modal-body .form-group textarea:focus { outline: none; border-color: #94d40b; }
        .modal-body .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc; }
        .btn-cancelar { background: #e5e7eb; color: #374151; border: none; padding: 0.6rem 1.25rem; border-radius: 8px; font-weight: 500; cursor: pointer; }
        .btn-cancelar:hover { background: #d1d5db; }
        .btn-guardar { background: linear-gradient(135deg, #94d40b 0%, #94d40b 100%); color: white; border: none; padding: 0.6rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-guardar:hover { opacity: 0.9; }
        
        /* Timeline */
        .agendas-timeline { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .agendas-timeline h3 { margin: 0 0 1rem 0; color: #1e293b; }
        .timeline-container { overflow-x: auto; }
        .timeline-grid { display: grid; grid-template-columns: 120px repeat(5, 1fr); gap: 2px; min-width: 800px; }
        .timeline-header { background: #1e293b; color: white; padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.9rem; }
        .timeline-header:first-child { border-radius: 8px 0 0 0; }
        .timeline-header:last-child { border-radius: 0 8px 0 0; }
        .timeline-row-label { background: #f1f5f9; padding: 0.75rem; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; }
        .timeline-cell { background: #fafafa; padding: 0.5rem; min-height: 60px; border: 1px solid #e5e7eb; }
        .timeline-cell:hover { background: #f0fdf4; }
        .timeline-item { background: white; border-radius: 4px; padding: 0.35rem 0.5rem; font-size: 0.7rem; margin-bottom: 0.25rem; border-left: 3px solid #94d40b; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .timeline-item:hover { background: #f0fdfa; }
        .timeline-item.sanitario { border-left-color: #0074c8; }
        .timeline-item.comunitario { border-left-color: #00acd9; }
        .timeline-item.educativo { border-left-color: #f97316; }
        .timeline-item.laboral { border-left-color: #00acd9; }
        
        /* Empty state */
        .kanban-empty { text-align: center; padding: 2rem 1rem; color: #94a3b8; }
        .kanban-empty-icon { font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5; }
        .kanban-empty-text { font-size: 0.85rem; }
        
        @media (max-width: 1200px) {
            .agendas-kanban { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .agendas-kanban { grid-template-columns: 1fr; }
            .agendas-header-top { flex-direction: column; }
            .agendas-filtros { flex-direction: column; align-items: flex-start; }
            .modal-body .form-row { grid-template-columns: 1fr; }
        }
        
        /* ========== PERFIL DE SALUD LOCAL - FASE 2 ========== */
        .perfil-header { background: linear-gradient(135deg, #1e40af 0%, #0074c8 100%); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; color: white; display: flex; align-items: center; gap: 1.5rem; }
        .perfil-header-icon { font-size: 3.5rem; background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 16px; }
        .perfil-header-text h2 { margin: 0 0 0.5rem 0; font-size: 1.8rem; }
        .perfil-header-text p { margin: 0; opacity: 0.9; font-size: 1rem; }
        .perfil-secciones { display: flex; flex-direction: column; gap: 0; }
        .perfil-secciones .acordeon-item { border-radius: 0; margin: 0; border-bottom: 1px solid #e5e7eb; }
        .perfil-secciones .acordeon-item:first-child { border-radius: 12px 12px 0 0; }
        .perfil-secciones .acordeon-item:last-child { border-radius: 0 0 12px 12px; border-bottom: none; }
        .perfil-secciones .acordeon-header { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); color: #1e293b; padding: 1.25rem 1.5rem; font-size: 1.05rem; }
        .perfil-secciones .acordeon-header:hover { background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); color: #00acd9; }
        .perfil-secciones .acordeon-contenido { padding: 1.5rem; background: white; }
        
        @media (max-width: 768px) {
            .perfil-header { flex-direction: column; text-align: center; padding: 1.5rem; }
            .perfil-header-icon { font-size: 2.5rem; padding: 0.75rem; }
        }
        
        /* ========== PLACEHOLDERS FASES EN DESARROLLO ========== */
        .fase-placeholder { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 2px dashed #cbd5e1; border-radius: 16px; padding: 3rem 2rem; text-align: center; max-width: 600px; margin: 2rem auto; }
        .placeholder-icon { font-size: 4rem; margin-bottom: 1rem; }
        .fase-placeholder h3 { color: #1e293b; font-size: 1.5rem; margin: 0 0 0.75rem 0; }
        .fase-placeholder > p { color: #64748b; font-size: 1rem; margin-bottom: 1.5rem; line-height: 1.5; }
        .placeholder-features { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
        .placeholder-features .feature { background: white; padding: 0.75rem 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #475569; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .placeholder-features .feature span { font-size: 1.1rem; }
        .placeholder-status { color: #f59e0b; font-weight: 600; font-size: 0.9rem; margin: 0; }
        
        @media (max-width: 600px) {
            .placeholder-features { grid-template-columns: 1fr; }
        }
        
        /* =====================================================
           SISTEMA DE NOTIFICACIONES TOAST
           ===================================================== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: toastSlideIn 0.3s ease-out;
            border-left: 4px solid #94a3b8;
        }
        
        .toast.toast-success { border-left-color: #10b981; }
        .toast.toast-error { border-left-color: #dc143c; }
        .toast.toast-warning { border-left-color: #f59e0b; }
        .toast.toast-info { border-left-color: #0074c8; }
        .toast.toast-loading { border-left-color: #00acd9; }
        
        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 0.9rem;
            color: #64748b;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0;
            line-height: 1;
        }
        
        .toast-close:hover { color: #64748b; }
        
        .toast-progress {
            height: 3px;
            background: #e2e8f0;
            border-radius: 0 0 8px 8px;
            margin: 0.75rem -1.5rem -1rem -1.5rem;
            overflow: hidden;
        }
        
        .toast-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #0074c8, #00acd9);
            animation: toastProgress 3s linear forwards;
        }
        
        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes toastSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes toastProgress {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        .toast.closing {
            animation: toastSlideOut 0.3s ease-in forwards;
        }
        
        /* Spinner de carga */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top-color: #00acd9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ============================================ */
        /* BOT√ìN FLOTANTE AUTO-DIAGN√ìSTICO */
        /* ============================================ */
        
        /* ==================== SISTEMA DE VOTACI√ìN CIUDADANA ==================== */
        
        /* Panel de administraci√≥n votaci√≥n */
        .votacion-panel { background: white; border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .votacion-panel h3 { color: #1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        
        .votacion-controles { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem; }
        .votacion-btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.5rem; }
        .votacion-btn.iniciar { background: linear-gradient(135deg, #94d40b, #00acd9); color: white; }
        .votacion-btn.detener { background: linear-gradient(135deg, #dc143c, #ff6600); color: white; }
        .votacion-btn.reiniciar { background: #f1f5f9; color: #475569; }
        .votacion-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .votacion-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .votacion-estado { display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.25rem; border-radius: 10px; margin-bottom: 1rem; font-weight: 500; }
        .votacion-estado.activa { background: rgba(148, 212, 11, 0.15); color: #5a8a00; }
        .votacion-estado.inactiva { background: rgba(220, 20, 60, 0.15); color: #dc143c; }
        .votacion-estado.esperando { background: rgba(255, 182, 27, 0.15); color: #cc9200; }
        .votacion-estado-dot { width: 10px; height: 10px; border-radius: 50%; }
        .votacion-estado.activa .votacion-estado-dot { background: #94d40b; animation: pulseVot 1.5s infinite; }
        .votacion-estado.inactiva .votacion-estado-dot { background: #dc143c; }
        .votacion-estado.esperando .votacion-estado-dot { background: #ffb61b; animation: pulseVot 1.5s infinite; }
        @keyframes pulseVot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        .votacion-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; }
        
        /* QR Section */
        .votacion-qr-section { text-align: center; padding: 1.5rem; background: #f8fafc; border-radius: 10px; }
        .votacion-qr-container { display: inline-block; padding: 1rem; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin: 1rem 0; }
        .votacion-qr-url { margin-top: 1rem; padding: 0.75rem 1rem; background: #e2e8f0; border-radius: 8px; font-family: monospace; font-size: 0.75rem; word-break: break-all; color: #475569; }
        .votacion-qr-instrucciones { margin-top: 1rem; color: #64748b; font-size: 0.85rem; line-height: 1.5; }
        
        /* Stats en tiempo real */
        .votacion-stats-card { background: #f8fafc; border-radius: 10px; padding: 1.25rem; }
        .votacion-stats-card h4 { color: #1e293b; margin-bottom: 1rem; font-size: 0.95rem; }
        .votacion-stats-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .votacion-stat-mini { background: white; border-radius: 8px; padding: 1rem; text-align: center; border: 1px solid #e2e8f0; }
        .votacion-stat-mini .icono { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .votacion-stat-mini .valor { font-size: 1.75rem; font-weight: 700; color: #0074c8; }
        .votacion-stat-mini .etiqueta { font-size: 0.7rem; color: #64748b; margin-top: 0.25rem; }
        
        /* Feed en vivo */
        .votacion-feed { max-height: 300px; overflow-y: auto; }
        .votacion-feed-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; margin: 0.5rem 0; background: #f8fafc; border-radius: 8px; animation: slideInVot 0.3s ease; }
        @keyframes slideInVot { from { opacity: 0; transform: translateX(-15px); } to { opacity: 1; transform: translateX(0); } }
        .votacion-feed-item .icono { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; background: linear-gradient(135deg, #0074c8, #00acd9); color: white; }
        .votacion-feed-item .info { flex: 1; }
        .votacion-feed-item .info .titulo { font-weight: 600; font-size: 0.9rem; color: #1e293b; }
        .votacion-feed-item .info .meta { font-size: 0.75rem; color: #64748b; }
        .votacion-feed-item .hora { font-size: 0.7rem; color: #94a3b8; }
        
        /* Resultados */
        .votacion-resultado-item { display: flex; align-items: center; margin: 0.75rem 0; }
        .votacion-resultado-label { width: 120px; font-size: 0.8rem; color: #475569; }
        .votacion-resultado-bar { flex: 1; height: 24px; background: #e2e8f0; border-radius: 12px; overflow: hidden; margin: 0 0.5rem; position: relative; }
        .votacion-resultado-fill { height: 100%; border-radius: 12px; transition: width 0.5s ease; display: flex; align-items: center; padding-left: 0.5rem; }
        .votacion-resultado-fill span { color: white; font-size: 0.7rem; font-weight: 600; }
        .votacion-resultado-pct { width: 45px; text-align: right; font-weight: 700; color: #0074c8; font-size: 0.9rem; }
        
        /* ==================== MODO ENCUESTA CIUDADANA ==================== */
        .encuesta-mode { background: linear-gradient(135deg, #0074c8 0%, #00acd9 25%, #94d40b 50%, #ffb61b 75%, #ff6600 100%); min-height: 100vh; }
        .encuesta-mode .header { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); box-shadow: none; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .encuesta-mode .header h1 { color: white; }
        
        .encuesta-container { max-width: 600px; margin: 0 auto; padding: 1rem; }
        .encuesta-card { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        
        .encuesta-progress { background: #e2e8f0; height: 6px; border-radius: 3px; margin-bottom: 1.5rem; overflow: hidden; }
        .encuesta-progress-fill { height: 100%; background: linear-gradient(90deg, #0074c8, #00acd9, #94d40b); transition: width 0.3s; border-radius: 3px; }
        
        .encuesta-pregunta { margin-bottom: 1.5rem; }
        .encuesta-pregunta > label { display: block; margin-bottom: 0.75rem; font-weight: 600; color: #1e293b; font-size: 1rem; }
        .encuesta-pregunta .nota { font-size: 0.85rem; color: #64748b; margin-bottom: 0.75rem; }
        
        .encuesta-opciones { display: flex; flex-direction: column; gap: 0.5rem; }
        .encuesta-opcion { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; background: #f8fafc; border-radius: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .encuesta-opcion:hover { background: #f1f5f9; }
        .encuesta-opcion.selected { background: rgba(0, 116, 200, 0.1); border-color: #0074c8; }
        .encuesta-opcion input { display: none; }
        .encuesta-opcion .icono { font-size: 1.25rem; }
        .encuesta-opcion .texto { flex: 1; font-size: 0.9rem; color: #334155; }
        
        .encuesta-input-edad { width: 100%; padding: 0.875rem 1rem; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; transition: border-color 0.2s; }
        .encuesta-input-edad:focus { outline: none; border-color: #0074c8; }
        
        .encuesta-nav { display: flex; justify-content: space-between; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; }
        .encuesta-nav-btn { padding: 0.75rem 1.5rem; border: none; border-radius: 25px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .encuesta-nav-btn.siguiente { background: #0074c8; color: white; }
        .encuesta-nav-btn.anterior { background: #f1f5f9; color: #475569; }
        .encuesta-nav-btn.enviar { background: #94d40b; color: white; }
        .encuesta-nav-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .encuesta-nav-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .encuesta-completada { text-align: center; padding: 3rem 1.5rem; }
        .encuesta-completada .icono { font-size: 4rem; margin-bottom: 1rem; }
        .encuesta-completada h2 { color: #94d40b; margin-bottom: 0.5rem; }
        .encuesta-completada p { color: #64748b; }
        
        /* Responsive votaci√≥n */
        @media (max-width: 768px) {
            .votacion-grid { grid-template-columns: 1fr; }
            .votacion-stats-row { grid-template-columns: repeat(2, 1fr); }
            .votacion-controles { flex-direction: column; }
            .votacion-btn { width: 100%; justify-content: center; }
            .encuesta-container { padding: 0.75rem; }
            .encuesta-card { padding: 1.25rem; border-radius: 12px; }
            .encuesta-opcion { padding: 0.75rem; }
            .encuesta-opcion .texto { font-size: 0.85rem; }
            .votacion-resultado-label { width: 90px; font-size: 0.7rem; }
        }
    </style>
</head>
<body>

<!-- Contenedor de notificaciones toast -->
<div id="toast-container" class="toast-container"></div>

<header class="header" style="padding: 1.5rem 2rem;">
    <div class="header-content" style="display: flex; justify-content: center; text-align: center; flex-direction: column; align-items: center;">
        <!-- Logos institucionales -->
        <div class="logos-institucionales">
            <img alt="Consejer√≠a de Sanidad, Presidencia y Emergencias" class="logo-institucional consejeria">
            <img alt="Distrito de atenci√≥n primaria Granada-Metropolitano" class="logo-institucional distrito">
            <img alt="RELAS - Red de acci√≥n local en salud" class="logo-institucional relas">
            <img alt="Centros comprometidos contra la Violencia de G√©nero" class="logo-institucional violencia">
            <img alt="RASSELH" class="logo-institucional rasselh">
        </div>
        
        <div class="itaca-branding" style="text-align: center; margin-top: 1.5rem;">
            <span class="itaca-nombre" style="
                font-size: 4rem; 
                font-weight: 700; 
                letter-spacing: 18px; 
                text-transform: uppercase;
                color: #2c3e50;
                display: block;
                margin-bottom: 0.75rem;
            ">COMP√ÅS</span>
            <span class="itaca-descripcion" style="
                font-size: 1.1rem; 
                letter-spacing: 12px; 
                text-transform: uppercase;
                font-weight: 300;
                color: #666;
                display: block;
            ">Dise√±o ciudadano de la salud</span>
            <div style="display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap; margin-top:0.75rem;">
                <button onclick="mostrarMetodologia()" style="background:transparent; border:1px solid #0074c8; color:#0074c8; padding:0.4rem 1rem; border-radius:20px; font-size:0.85rem; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#0074c8';this.style.color='white'" onmouseout="this.style.background='transparent';this.style.color='#0074c8'">‚ÑπÔ∏è Qu√© es COMP√ÅS</button>
                <button onclick="abrirDrawerDocumentos()" style="background:transparent; border:1px solid #6366f1; color:#6366f1; padding:0.4rem 1rem; border-radius:20px; font-size:0.85rem; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#6366f1';this.style.color='white'" onmouseout="this.style.background='transparent';this.style.color='#6366f1'">üìã Documentos del proceso</button>
            </div>
        </div>
        <div style="margin-top: 1.5rem; display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap; justify-content: center;">
            <!-- Selector de Estrategia de Salud (COMPAS EU) -->
            <div class="estrategia-selector" style="display: flex; align-items: center; gap: 0.5rem;">
                <label for="estrategia-salud" style="font-weight: 600; color: #334155;">üá™üá∏ Estrategia:</label>
                <select id="estrategia-salud" onchange="onCambioEstrategia(this.value)" style="padding: 0.5rem 1rem; border-radius: 4px; border: 2px solid #0074c8; font-size: 0.95rem; background: white; cursor: pointer; min-width: 280px;">
                    <option value="es-andalucia-epvsa">üá™üá∏ EPVSA - Andaluc√≠a (Espa√±a)</option>
                </select>
            </div>
            
            <div class="municipio-selector">
                <label for="municipio">üìç Seleccione su distrito sanitario, municipio o mancomunidad:</label>
                <select id="municipio">
                    <option value="">-- Seleccionar --</option>
                    <!-- Los municipios se cargan din√°micamente seg√∫n la estrategia -->
                </select>
            </div>
            

        </div>
    </div>
        
</header>
<div class="franja"></div>

<nav class="relas-container">
    <div class="relas-fases">
        <div class="fase activa" data-fase="1"><div class="fase-num">1</div><div class="fase-nombre">üìã Fase Inicial</div></div>
        <div class="fase" data-fase="2"><div class="fase-num">2</div><div class="fase-nombre">ü©∫ Perfil de salud local</div></div>
        <div class="fase" data-fase="3"><div class="fase-num">3</div><div class="fase-nombre">üéØ Plan de acci√≥n</div></div>
        <div class="fase" data-fase="4"><div class="fase-num">4</div><div class="fase-nombre">üìÑ Plan local de salud</div></div>
        <div class="fase" data-fase="5"><div class="fase-num">5</div><div class="fase-nombre">üöÄ Implantaci√≥n</div></div>
        <div class="fase" data-fase="6"><div class="fase-num">6</div><div class="fase-nombre">üìà Evaluaci√≥n</div></div>
    </div>
</nav>

<main class="main">
    <!-- FASE 1 -->
    <div class="fase-contenido activa" id="fase-1-contenido">
        <div class="botones-fase">
            <button class="btn-accion" id="btn-valoracion">Informe de la situaci√≥n de salud de <span class="nombre-municipio-dinamico">Padul</span></button>
            <button class="btn-accion secundario" id="btn-registro">Registro del Grupo-Motor</button>
            <button class="btn-accion terciario" id="btn-hoja-ruta">Hoja de ruta</button>
            <button class="btn-accion btn-exportar" id="btn-exportar-json" style="background:#00acd9;border-color:#00acd9;">üìä Exportar JSON</button>
        </div>
        <div class="informe-container" id="informe-container">
            <div class="export-buttons export-top" style="margin-bottom:1rem; padding:0.75rem 1rem; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0; display:flex; align-items:center; flex-wrap:wrap; gap:0.5rem;">
                <span style="color:#475569; font-size:0.9rem; font-weight:600;">üì• Exportar:</span>
                <button onclick="exportarInformeWord()" class="btn-export"><span>üìÑ</span> Word</button>
                <button onclick="exportarInformePDF()" class="btn-export"><span>üìë</span> PDF</button>
                <button onclick="imprimirInforme()" class="btn-export"><span>üñ®Ô∏è</span> Imprimir</button>
            </div>
            <div id="contenido-informe-dinamico"></div>
            <div class="export-buttons export-bottom" style="margin-top:1.5rem; padding:0.75rem 1rem; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0; display:flex; align-items:center; flex-wrap:wrap; gap:0.5rem;">
                <span style="color:#475569; font-size:0.9rem; font-weight:600;">üì• Exportar:</span>
                <button onclick="exportarInformeWord()" class="btn-export"><span>üìÑ</span> Word</button>
                <button onclick="exportarInformePDF()" class="btn-export"><span>üìë</span> PDF</button>
                <button onclick="imprimirInforme()" class="btn-export"><span>üñ®Ô∏è</span> Imprimir</button>
            </div>
        </div>
        <div class="registro-container" id="registro-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3>üìã Registro de miembros del Grupo-Motor</h3>
                <div class="export-buttons">
                    <button onclick="exportarMiembrosWord()" class="btn-export"><span>üìÑ</span> Word</button>
                    <button onclick="exportarMiembrosPDF()" class="btn-export"><span>üìë</span> PDF</button>
                    <button onclick="imprimirMiembros()" class="btn-export"><span>üñ®Ô∏è</span> Imprimir</button>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Nombre *</label><input type="text" id="nombre" required></div>
                <div class="form-group"><label>Tel√©fono</label><input type="tel" id="telefono"></div>
                <div class="form-group"><label>Email *</label><input type="email" id="email" required></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Organizaci√≥n</label><input type="text" id="organizacion"></div>
                <div class="form-group"><label>Cargo</label><input type="text" id="cargo"></div>
                <div class="form-group"><label>Sector *</label>
                    <select id="sector" required>
                        <option value="">Seleccionar...</option>
                        <option value="politico-institucional">Pol√≠tico-institucional</option>
                        <option value="salud-sspa">Salud (SSPA)</option>
                        <option value="tecnico-aapp">T√©cnico/a AAPP</option>
                        <option value="tejido-asociativo">Tejido asociativo</option>
                    </select>
                </div>
            </div>
            <button class="btn-registrar" onclick="registrarMiembro()">‚úÖ Registrar</button>
            <div class="miembros-lista"><h4>üë• Miembros</h4><div id="tabla-miembros"><p class="sin-miembros">No hay miembros.</p></div></div>
        </div>
        <div class="hoja-ruta-container" id="hoja-ruta-container">
            <div class="hoja-ruta">
                <div class="hoja-ruta-header">
                    <div><h3>üó∫Ô∏è Hoja de ruta</h3><p class="hoja-ruta-intro">Gestione los hitos del proceso.</p></div>
                    <div class="hoja-ruta-acciones">
                        <button onclick="exportarHojaRutaWord()" class="btn-export" title="Exportar a Word"><span>üìÑ</span></button>
                        <button onclick="exportarHojaRutaPDF()" class="btn-export" title="Exportar a PDF"><span>üìë</span></button>
                        <button onclick="imprimirHojaRuta()" class="btn-export" title="Imprimir"><span>üñ®Ô∏è</span></button>
                        <button class="btn-ordenar-fecha" onclick="ordenarHitosPorFecha()">üìÖ Ordenar</button>
                        <button class="btn-a√±adir-hito" onclick="mostrarFormularioHito()">‚ûï A√±adir</button>
                    </div>
                </div>
                <div id="formulario-hito-personalizado" class="formulario-hito">
                    <h4>‚úèÔ∏è Nuevo hito</h4>
                    <div class="form-row">
                        <div class="form-group"><label>Nombre *</label><input type="text" id="hito-custom-nombre"></div>
                        <div class="form-group"><label>Fecha</label><input type="date" id="hito-custom-fecha"></div>
                    </div>
                    <div class="formulario-hito-botones">
                        <button class="btn-guardar-hito" onclick="guardarHitoPersonalizado()">üíæ Guardar</button>
                        <button class="btn-cancelar-hito" onclick="ocultarFormularioHito()">Cancelar</button>
                    </div>
                </div>
                <div class="hitos-lista" id="hitos-lista"></div>
            </div>
        </div>

    </div>

    <!-- FASE 2: Perfil de salud local -->
    <div class="fase-contenido" id="fase-2-contenido">

        <!-- HEADER -->
        <div style="background:linear-gradient(135deg,#f8fafc,#f1f5f9); border-radius:12px; padding:1.5rem; margin-bottom:1.5rem; border:1px solid #e2e8f0; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem;">
            <div style="display:flex; align-items:center; gap:1rem;">
                <div style="font-size:2.5rem;">ü©∫</div>
                <div>
                    <h2 style="margin:0; color:#1e293b;">Perfil de salud local de <span class="nombre-municipio-dinamico" style="color:#0074c8;">Padul</span></h2>
                    <p style="margin:0.25rem 0 0; color:#64748b; font-size:0.9rem;">Diagn√≥stico integral ¬∑ fuentes diferenciadas por fiabilidad</p>
                </div>
            </div>
            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                <button onclick="togglePanelCargaDatos()" style="background:white; border:1px solid #cbd5e1; color:#475569; padding:0.5rem 1rem; border-radius:8px; cursor:pointer; font-size:0.85rem; font-weight:600;">‚öôÔ∏è Gestionar fuentes</button>
                <button onclick="generarPerfilSaludLocal()" style="background:linear-gradient(135deg,#0074c8,#00acd9); color:white; border:none; padding:0.5rem 1rem; border-radius:8px; cursor:pointer; font-size:0.85rem; font-weight:600;">üìï Exportar PDF</button>
            </div>
        </div>

        <!-- LEYENDA DE FIABILIDAD -->
        <div style="display:flex; gap:0.75rem; flex-wrap:wrap; margin-bottom:1.5rem; padding:0.75rem 1rem; background:white; border-radius:8px; border:1px solid #e2e8f0;">
            <span style="font-size:0.8rem; color:#64748b; font-weight:600; align-self:center;">Fiabilidad de la fuente:</span>
            <span style="background:#dcfce7; color:#166534; padding:0.2rem 0.6rem; border-radius:20px; font-size:0.75rem; font-weight:600;">üü¢ Dato real</span>
            <span style="background:#fef9c3; color:#854d0e; padding:0.2rem 0.6rem; border-radius:20px; font-size:0.75rem; font-weight:600;">‚ö†Ô∏è Estimaci√≥n estad√≠stica</span>
            <span style="background:#fee2e2; color:#991b1b; padding:0.2rem 0.6rem; border-radius:20px; font-size:0.75rem; font-weight:600;">üî∂ Datos parciales</span>
        </div>

        <!-- PANEL DE CARGA DE FUENTES -->
        <div id="panel-carga-datos" style="display:none; margin-bottom:1.5rem;">
            <div style="background:white; border-radius:12px; border:1px solid #e2e8f0; overflow:hidden;">
                <div style="background:linear-gradient(135deg,#1e293b,#334155); color:white; padding:1.25rem 1.5rem; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="margin:0; font-size:1.1rem;">üì• Gesti√≥n de fuentes del perfil</h3>
                        <p style="margin:0.25rem 0 0; font-size:0.8rem; opacity:0.75;">Municipio: <strong class="nombre-municipio-dinamico">Padul</strong></p>
                    </div>
                    <button onclick="togglePanelCargaDatos()" style="background:rgba(255,255,255,0.15); border:none; color:white; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:1rem;">‚úï</button>
                </div>
                <div style="padding:1.5rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1rem;">

                    <!-- 1. INFORME Word -->
                    <div style="border:2px solid #bbf7d0; border-radius:10px; overflow:hidden;">
                        <div style="background:linear-gradient(135deg,#16a34a,#15803d); color:white; padding:0.75rem 1rem; display:flex; align-items:center; gap:0.5rem;">
                            <span>üìÑ</span><strong>Informe de Situaci√≥n de Salud</strong>
                            <span style="margin-left:auto; background:rgba(255,255,255,0.25); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem;">üü¢ Dato real</span>
                        </div>
                        <div style="padding:1rem;">
                            <p style="margin:0 0 0.75rem; font-size:0.85rem; color:#475569;">Informe epidemiol√≥gico en formato Word (.docx)</p>
                            <label style="display:block; background:#f0fdf4; border:1px dashed #86efac; border-radius:6px; padding:0.6rem 1rem; text-align:center; cursor:pointer; font-size:0.85rem; font-weight:600; color:#16a34a;">
                                <input type="file" accept=".docx,.doc" onchange="cargarInformeWord(this)" hidden>
                                üìÅ Cargar Word (.docx)
                            </label>
                            <div id="estado-informe" style="margin-top:0.5rem; font-size:0.8rem; color:#64748b;"><span>‚è≥ Sin cargar</span></div>
                        </div>
                    </div>

                    <!-- 2. ESTUDIOS COMPLEMENTARIOS (IBSE u otros) -->
                    <div style="border:2px solid #bbf7d0; border-radius:10px; overflow:hidden;">
                        <div style="background:linear-gradient(135deg,#0369a1,#0284c7); color:white; padding:0.75rem 1rem; display:flex; align-items:center; gap:0.5rem;">
                            <span>üß†</span><strong>Estudios complementarios</strong>
                            <span style="margin-left:auto; background:rgba(255,255,255,0.25); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem;">üü¢ Dato real</span>
                        </div>
                        <div style="padding:1rem;">
                            <p style="margin:0 0 0.75rem; font-size:0.85rem; color:#475569;">IBSE, estudios locales, informes espec√≠ficos (PDF, Word, txt)</p>
                            <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
                                <label style="flex:1; background:#f0f9ff; border:1px dashed #7dd3fc; border-radius:6px; padding:0.6rem; text-align:center; cursor:pointer; font-size:0.8rem; font-weight:600; color:#0369a1;">
                                    <input type="file" accept=".pdf,.docx,.doc,.txt,.csv" multiple onchange="cargarEstudiosComplementarios(this)" hidden>
                                    üìÅ Word / PDF / CSV / txt
                                </label>
                            </div>
                            <textarea id="texto-estudio-libre" placeholder="O pega aqu√≠ el texto del estudio directamente..." rows="3" style="width:100%; padding:0.5rem; border:1px solid #bae6fd; border-radius:6px; font-size:0.8rem; resize:vertical;" onchange="cargarEstudioTextoLibre(this)"></textarea>
                            <div id="estado-estudios" style="margin-top:0.5rem; font-size:0.8rem; color:#64748b;"><span>‚è≥ Sin cargar</span></div>
                        </div>
                    </div>

                    <!-- 3. PRIORIZACI√ìN POPULAR -->
                    <div style="border:2px solid #bbf7d0; border-radius:10px; overflow:hidden;">
                        <div style="background:linear-gradient(135deg,#7c3aed,#6d28d9); color:white; padding:0.75rem 1rem; display:flex; align-items:center; gap:0.5rem;">
                            <span>üó≥Ô∏è</span><strong>Priorizaci√≥n popular</strong>
                            <span style="margin-left:auto; background:rgba(255,255,255,0.25); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem;">üü¢ Dato real</span>
                        </div>
                        <div style="padding:1rem;">
                            <p style="margin:0 0 0.75rem; font-size:0.85rem; color:#475569;">Datos de la votaci√≥n ciudadana (Tab 3 ‚Üí Priorizaci√≥n EPVSA y de h√°bitos)</p>
                            <div id="estado-priorizacion-popular" style="font-size:0.85rem; color:#64748b; padding:0.5rem; background:#f5f3ff; border-radius:6px; text-align:center;">
                                ‚è≥ Pendiente de realizar en Tab 3
                            </div>
                        </div>
                    </div>

                    <!-- 4. DETERMINANTES EAS -->
                    <div style="border:2px solid #fde68a; border-radius:10px; overflow:hidden;">
                        <div style="background:linear-gradient(135deg,#d97706,#b45309); color:white; padding:0.75rem 1rem; display:flex; align-items:center; gap:0.5rem;">
                            <span>üè†</span><strong>Determinantes (EAS)</strong>
                            <span style="margin-left:auto; background:rgba(255,255,255,0.25); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem;">‚ö†Ô∏è Estimaci√≥n</span>
                        </div>
                        <div style="padding:1rem;">
                            <p style="margin:0 0 0.75rem; font-size:0.85rem; color:#475569;">Valores estimados de la Encuesta Andaluza de Salud</p>
                            <div style="display:flex; gap:0.5rem;">
                                <label style="flex:1; background:#fffbeb; border:1px dashed #fcd34d; border-radius:6px; padding:0.6rem; text-align:center; cursor:pointer; font-size:0.8rem; font-weight:600; color:#d97706;">
                                    <input type="file" accept=".csv" onchange="cargarDeterminantesCSV(this)" hidden>
                                    üìÅ CSV
                                </label>
                                <button onclick="descargarPlantillaDeterminantes()" style="background:#fffbeb; border:1px solid #fcd34d; border-radius:6px; padding:0.6rem 0.75rem; cursor:pointer; font-size:0.8rem; color:#d97706;">üì• Plantilla</button>
                            </div>
                            <div id="estado-determinantes" style="margin-top:0.5rem; font-size:0.8rem; color:#64748b;"><span>‚è≥ Sin cargar</span></div>
                        </div>
                    </div>

                    <!-- 5. INDICADORES -->
                    <div style="border:2px solid #fecaca; border-radius:10px; overflow:hidden;">
                        <div style="background:linear-gradient(135deg,#dc2626,#b91c1c); color:white; padding:0.75rem 1rem; display:flex; align-items:center; gap:0.5rem;">
                            <span>üìà</span><strong>Indicadores (50)</strong>
                            <span style="margin-left:auto; background:rgba(255,255,255,0.25); padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem;">üî∂ Parciales</span>
                        </div>
                        <div style="padding:1rem;">
                            <p style="margin:0 0 0.75rem; font-size:0.85rem; color:#475569;">Cuadro de mandos integral con 50 indicadores de salud</p>
                            <div style="display:flex; gap:0.5rem;">
                                <label style="flex:1; background:#fff1f2; border:1px dashed #fca5a5; border-radius:6px; padding:0.6rem; text-align:center; cursor:pointer; font-size:0.8rem; font-weight:600; color:#dc2626;">
                                    <input type="file" accept=".csv" onchange="cargarIndicadoresCSV(this)" hidden>
                                    üìÅ CSV
                                </label>
                                <button onclick="descargarPlantillaIndicadores()" style="background:#fff1f2; border:1px solid #fca5a5; border-radius:6px; padding:0.6rem 0.75rem; cursor:pointer; font-size:0.8rem; color:#dc2626;">üì• Plantilla</button>
                            </div>
                            <div id="estado-indicadores" style="margin-top:0.5rem; font-size:0.8rem; color:#64748b;"><span>‚è≥ Sin cargar</span></div>
                        </div>
                    </div>

                    <!-- 6. MARCO ESTRAT√âGICO -->
                    <div style="border:2px solid #e2e8f0; border-radius:10px; overflow:hidden; grid-column:1/-1;">
                        <div style="background:linear-gradient(135deg,#334155,#475569); color:white; padding:0.75rem 1rem; display:flex; align-items:center; gap:0.5rem;">
                            <span>üéØ</span><strong>Configuraci√≥n del Marco estrat√©gico</strong>
                        </div>
                        <div style="padding:1rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:0.75rem;">
                            <div>
                                <label style="font-size:0.8rem; color:#64748b; display:block; margin-bottom:0.25rem;">A√±o del Informe</label>
                                <input type="number" id="config-anio-informe" value="2026" min="2020" max="2030" onchange="guardarConfigMarco()" style="width:100%; padding:0.4rem 0.6rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.9rem;">
                            </div>
                            <div>
                                <label style="font-size:0.8rem; color:#64748b; display:block; margin-bottom:0.25rem;">A√±o de la Encuesta</label>
                                <input type="number" id="config-anio-encuesta" value="2024" min="2020" max="2030" onchange="guardarConfigMarco()" style="width:100%; padding:0.4rem 0.6rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.9rem;">
                            </div>
                            <div>
                                <label style="font-size:0.8rem; color:#64748b; display:block; margin-bottom:0.25rem;">Mes de Priorizaci√≥n</label>
                                <select id="config-mes-priorizacion" onchange="guardarConfigMarco()" style="width:100%; padding:0.4rem 0.6rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.9rem;">
                                    <option value="enero">Enero</option><option value="febrero" selected>Febrero</option><option value="marzo">Marzo</option><option value="abril">Abril</option><option value="mayo">Mayo</option><option value="junio">Junio</option><option value="julio">Julio</option><option value="agosto">Agosto</option><option value="septiembre">Septiembre</option><option value="octubre">Octubre</option><option value="noviembre">Noviembre</option><option value="diciembre">Diciembre</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.8rem; color:#64748b; display:block; margin-bottom:0.25rem;">A√±o de Priorizaci√≥n</label>
                                <input type="number" id="config-anio-priorizacion" value="2026" min="2020" max="2030" onchange="guardarConfigMarco()" style="width:100%; padding:0.4rem 0.6rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.9rem;">
                            </div>
                            <div>
                                <label style="font-size:0.8rem; color:#64748b; display:block; margin-bottom:0.25rem;">L√≠neas estrat√©gicas</label>
                                <input type="text" id="config-lineas-estrategia" value="1, 3 y 4" onchange="guardarConfigMarco()" style="width:100%; padding:0.4rem 0.6rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.9rem;">
                            </div>
                            <div>
                                <label style="font-size:0.8rem; color:#64748b; display:block; margin-bottom:0.25rem;">Distrito sanitario</label>
                                <input type="text" id="config-distrito" value="Distrito sanitario Granada-Metropolitano" onchange="guardarConfigMarco()" style="width:100%; padding:0.4rem 0.6rem; border:1px solid #cbd5e1; border-radius:6px; font-size:0.9rem;">
                            </div>
                        </div>
                        <div style="padding:0 1rem 1rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
                            <button onclick="guardarTodoFirebase()" style="background:#0074c8; color:white; border:none; padding:0.5rem 1rem; border-radius:6px; cursor:pointer; font-size:0.85rem;">üíæ Guardar en Firebase</button>
                            <button onclick="actualizarMunicipio()" style="background:#f1f5f9; color:#475569; border:1px solid #cbd5e1; padding:0.5rem 1rem; border-radius:6px; cursor:pointer; font-size:0.85rem;">üîÑ Recargar</button>
                            <button onclick="borrarDatosMunicipio()" style="background:#fee2e2; color:#dc2626; border:1px solid #fca5a5; padding:0.5rem 1rem; border-radius:6px; cursor:pointer; font-size:0.85rem; margin-left:auto;">üóëÔ∏è Borrar datos</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- SECCIONES DEL PERFIL -->
        <div id="contenido-perfil-dinamico">

            <!-- 01 MARCO ESTRAT√âGICO (siempre visible) -->
            <div class="acordeon-item" style="margin-bottom:0.75rem;">
                <div class="acordeon-header" onclick="toggleAcordeon(this)" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>01 Marco estrat√©gico</span>
                    <span class="flecha">‚ñº</span>
                </div>
                <div class="acordeon-contenido" id="seccion-marco-estrategico"></div>
            </div>

            <!-- 02 INFORME DE SITUACI√ìN -->
            <div class="acordeon-item" style="margin-bottom:0.75rem;">
                <div class="acordeon-header" onclick="toggleAcordeon(this)" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <span>02 Informe de situaci√≥n de salud</span>
                        <span style="background:#dcfce7; color:#166534; padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem; font-weight:600;">üü¢ Dato real</span>
                    </div>
                    <span class="flecha">‚ñº</span>
                </div>
                <div class="acordeon-contenido" id="seccion-informe-situacion">
                    <div style="padding:1.5rem; text-align:center; color:#94a3b8;">
                        <p>üìÑ Carga el Informe de Situaci√≥n de Salud en <strong>‚öôÔ∏è Gestionar fuentes</strong></p>
                    </div>
                </div>
            </div>

            <!-- 03 ESTUDIOS COMPLEMENTARIOS -->
            <div class="acordeon-item" style="margin-bottom:0.75rem;">
                <div class="acordeon-header" onclick="toggleAcordeon(this)" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <span>03 Estudios complementarios (IBSE y otros)</span>
                        <span style="background:#dcfce7; color:#166534; padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem; font-weight:600;">üü¢ Dato real</span>
                    </div>
                    <span class="flecha">‚ñº</span>
                </div>
                <div class="acordeon-contenido" id="seccion-estudios-complementarios">
                    <div style="padding:1.5rem; text-align:center; color:#94a3b8;">
                        <p>üß† Carga estudios complementarios en <strong>‚öôÔ∏è Gestionar fuentes</strong></p>
                    </div>
                </div>
            </div>

            <!-- 04 PRIORIZACI√ìN POPULAR -->
            <div class="acordeon-item" style="margin-bottom:0.75rem;">
                <div class="acordeon-header" onclick="toggleAcordeon(this)" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <span>04 Priorizaci√≥n popular</span>
                        <span style="background:#dcfce7; color:#166534; padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem; font-weight:600;">üü¢ Dato real</span>
                    </div>
                    <span class="flecha">‚ñº</span>
                </div>
                <div class="acordeon-contenido" id="seccion-priorizacion-popular">
                    <div style="padding:1.5rem; text-align:center; color:#94a3b8;">
                        <p>üó≥Ô∏è Realiza la votaci√≥n ciudadana en el <strong>Tab 3 ‚Üí Priorizaci√≥n EPVSA y de h√°bitos</strong></p>
                    </div>
                </div>
            </div>

            <!-- 05 DETERMINANTES -->
            <div class="acordeon-item" style="margin-bottom:0.75rem;">
                <div class="acordeon-header" onclick="toggleAcordeon(this)" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <span>05 Determinantes sociales de la salud</span>
                        <span style="background:#fef9c3; color:#854d0e; padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem; font-weight:600;">‚ö†Ô∏è Estimaci√≥n EAS</span>
                    </div>
                    <span class="flecha">‚ñº</span>
                </div>
                <div class="acordeon-contenido" id="seccion-determinantes"></div>
            </div>

            <!-- 06 INDICADORES -->
            <div class="acordeon-item" style="margin-bottom:0.75rem;">
                <div class="acordeon-header" onclick="toggleAcordeon(this)" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <span>06 Indicadores de salud (50)</span>
                        <span style="background:#fee2e2; color:#991b1b; padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem; font-weight:600;">üî∂ Datos parciales</span>
                    </div>
                    <span class="flecha">‚ñº</span>
                </div>
                <div class="acordeon-contenido" id="seccion-indicadores"></div>
            </div>

            <!-- 07 AN√ÅLISIS IA -->
            <div class="acordeon-item" style="margin-bottom:0.75rem; border:2px solid #e0e7ff;">
                <div class="acordeon-header" onclick="toggleAcordeon(this)" style="display:flex; justify-content:space-between; align-items:center; background:linear-gradient(135deg,#eef2ff,#e0e7ff);">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <span style="color:#3730a3; font-weight:700;">07 üß† Conclusiones, recomendaciones y prioridades</span>
                        <span style="background:#e0e7ff; color:#3730a3; padding:0.15rem 0.5rem; border-radius:10px; font-size:0.7rem; font-weight:600;">IA ¬∑ Claude</span>
                    </div>
                    <span class="flecha">‚ñº</span>
                </div>
                <div class="acordeon-contenido" id="seccion-analisis-ia">

                    <!-- Estado inicial: bot√≥n de generaci√≥n -->
                    <div id="ia-estado-inicial" style="padding:2rem; text-align:center;">
                        <div style="font-size:3rem; margin-bottom:1rem;">üß†</div>
                        <h3 style="color:#3730a3; margin:0 0 0.5rem;">An√°lisis inteligente</h3>
                        <p style="color:#64748b; margin:0 0 1.5rem; max-width:500px; margin-left:auto; margin-right:auto;">
                            Claude analizar√° todas las fuentes disponibles y generar√° conclusiones, recomendaciones y propuesta de prioridades EPVSA.
                        </p>

                        <!-- Checklist de fuentes disponibles -->
                        <div id="ia-fuentes-check" style="display:inline-block; text-align:left; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:1rem 1.5rem; margin-bottom:1.5rem;">
                            <p style="font-size:0.8rem; color:#64748b; font-weight:600; margin:0 0 0.5rem;">Fuentes que se incluir√°n en el an√°lisis:</p>
                            <div id="ia-check-informe" style="font-size:0.85rem; color:#94a3b8;">‚¨ú Informe de Situaci√≥n de Salud</div>
                            <div id="ia-check-estudios" style="font-size:0.85rem; color:#94a3b8;">‚¨ú Estudios complementarios</div>
                            <div id="ia-check-priorizacion" style="font-size:0.85rem; color:#94a3b8;">‚¨ú Priorizaci√≥n popular</div>
                            <div id="ia-check-determinantes" style="font-size:0.85rem; color:#94a3b8;">‚¨ú Determinantes EAS</div>
                            <div id="ia-check-indicadores" style="font-size:0.85rem; color:#94a3b8;">‚¨ú Indicadores de salud</div>
                        </div>

                        <!-- API Key: oculta si ya est√° guardada -->
                        <div id="ia-apikey-bloque" style="margin-bottom:1rem; max-width:420px; margin-left:auto; margin-right:auto; display:none;">
                            <label style="display:block; font-size:0.8rem; color:#64748b; margin-bottom:0.35rem; text-align:left;">üîë API Key de Anthropic</label>
                            <input type="password" id="anthropic-api-key" placeholder="sk-ant-api-..." style="width:100%; padding:0.5rem 0.75rem; border:1px solid #c7d2fe; border-radius:8px; font-size:0.85rem; font-family:monospace;" oninput="guardarApiKey(this.value)">
                            <p style="font-size:0.75rem; color:#94a3b8; margin:0.25rem 0 0;">Se guarda en este navegador. <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:#6366f1;">Obtener API Key</a></p>
                        </div>
                        <div id="ia-apikey-ok" style="margin-bottom:1rem; font-size:0.8rem; color:#166534; display:none;">üîë API Key configurada ¬∑ <button onclick="olvidarApiKey()" style="background:none;border:none;color:#6366f1;cursor:pointer;font-size:0.8rem;text-decoration:underline;">cambiar</button></div>
                        <div><button onclick="generarAnalisisIA()" id="btn-generar-ia" style="background:linear-gradient(135deg,#4f46e5,#7c3aed); color:white; border:none; padding:0.85rem 2rem; border-radius:10px; font-size:1rem; font-weight:700; cursor:pointer; box-shadow:0 4px 15px rgba(79,70,229,0.35);">
                            üß† Generar an√°lisis con IA
                        </button></div>
                    </div>

                    <!-- Progreso -->
                    <div id="ia-progreso" style="display:none; padding:2rem; text-align:center;">
                        <div style="width:48px; height:48px; border:4px solid #e0e7ff; border-top-color:#4f46e5; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 1rem;"></div>
                        <p id="ia-progreso-texto" style="color:#4f46e5; font-weight:600;">Analizando fuentes disponibles...</p>
                        <p style="color:#94a3b8; font-size:0.85rem;">Esto puede tardar 20-30 segundos</p>
                    </div>

                    <!-- Resultado -->
                    <div id="ia-resultado" style="display:none; padding:1.5rem;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.25rem; flex-wrap:wrap; gap:0.5rem;">
                            <div style="display:flex; align-items:center; gap:0.5rem;">
                                <span style="background:#dcfce7; color:#166534; padding:0.25rem 0.75rem; border-radius:20px; font-size:0.8rem; font-weight:600;">‚úÖ An√°lisis generado</span>
                                <span id="ia-fecha-generacion" style="font-size:0.75rem; color:#94a3b8;"></span>
                            </div>
                            <button onclick="regenerarAnalisisIA()" style="background:white; border:1px solid #cbd5e1; color:#475569; padding:0.4rem 0.75rem; border-radius:6px; cursor:pointer; font-size:0.8rem;">üîÑ Regenerar</button>
                        </div>

                        <!-- CONCLUSIONES -->
                        <div style="margin-bottom:1.5rem;">
                            <h4 style="color:#1e293b; margin:0 0 0.75rem; display:flex; align-items:center; gap:0.5rem;">
                                <span style="background:#dbeafe; color:#1e40af; width:28px; height:28px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.8rem;">C</span>
                                Conclusiones
                            </h4>
                            <div id="ia-conclusiones" style="display:flex; flex-direction:column; gap:0.75rem;"></div>
                        </div>

                        <!-- RECOMENDACIONES -->
                        <div style="margin-bottom:1.5rem;">
                            <h4 style="color:#1e293b; margin:0 0 0.75rem; display:flex; align-items:center; gap:0.5rem;">
                                <span style="background:#dcfce7; color:#166534; width:28px; height:28px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.8rem;">R</span>
                                Recomendaciones
                            </h4>
                            <div id="ia-recomendaciones" style="display:flex; flex-direction:column; gap:0.75rem;"></div>
                        </div>

                        <!-- PRIORIDADES EPVSA -->
                        <div>
                            <h4 style="color:#1e293b; margin:0 0 0.75rem; display:flex; align-items:center; gap:0.5rem;">
                                <span style="background:#ede9fe; color:#6d28d9; width:28px; height:28px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.8rem;">P</span>
                                Propuesta de prioridades EPVSA
                            </h4>
                            <div id="ia-prioridades" style="display:flex; flex-direction:column; gap:0.75rem;"></div>
                            <div style="margin-top:1rem; padding:0.75rem 1rem; background:#f5f3ff; border-radius:8px; font-size:0.85rem; color:#6d28d9;">
                                üí° Esta propuesta puede usarse directamente en el <strong>Tab 3 ‚Üí Modo Autom√°tico</strong>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div><!-- fin contenido-perfil-dinamico -->

    </div>

        <!-- FASE 3: Plan de acci√≥n -->
    <div class="fase-contenido" id="fase-3-contenido">
        <!-- Header con t√≠tulo -->
        <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #e2e8f0;">
            <h2 style="margin: 0 0 0.5rem 0; color: #1e293b;">üéØ Plan de acci√≥n</h2>
            <p style="margin: 0; color: #64748b;">Territorio: <strong class="nombre-municipio-dinamico" style="color: #0074c8;">Padul</strong> ¬∑ Seleccione el modo de planificaci√≥n</p>
        </div>
        
        <!-- Selector de modo - TARJETAS VISUALES -->
        <div class="plan-modo-selector" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            
            <!-- TARJETA MODO AUTOM√ÅTICO -->
            <div class="plan-modo-card" id="card-modo-auto" onclick="cambiarModoPlan('auto')" style="background: white; border-radius: 16px; border: 3px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.3s; overflow: hidden;">
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 1.25rem; color: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 2rem;">ü§ñ</span>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700;">AUTOM√ÅTICO</div>
                            <div style="font-size: 0.85rem; opacity: 0.9;">Basado en an√°lisis de datos</div>
                        </div>
                        <div id="badge-modo-auto" style="margin-left: auto; background: white; color: #10b981; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display:none;">ACTIVO</div>
                    </div>
                </div>
                <div style="padding: 1.25rem;">
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
                            <span style="color: #10b981;">üß†</span>
                            <span>An√°lisis inteligente salutog√©nico</span>
                        </div>

                        <div style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
                            <span style="color: #f59e0b;">üì¶</span>
                            <span>Carga de paquete completo</span>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb; font-size: 0.8rem; color: #6b7280;">
                        üí° Genera propuesta a partir del informe de salud, estudios y priorizaci√≥n ciudadana
                    </div>
                </div>
            </div>
            
            <!-- TARJETA MODO MANUAL -->
            <div class="plan-modo-card" id="card-modo-manual" onclick="cambiarModoPlan('manual')" style="background: white; border-radius: 16px; border: 3px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.3s; overflow: hidden;">
                <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); padding: 1.25rem; color: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 2rem;">‚úã</span>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700;">MANUAL</div>
                            <div style="font-size: 0.85rem; opacity: 0.9;">Selecci√≥n participativa</div>
                        </div>
                        <div id="badge-modo-manual" style="margin-left: auto; background: rgba(255,255,255,0.2); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: none;">ACTIVO</div>
                    </div>
                </div>
                <div style="padding: 1.25rem;">
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
                            <span style="color: #6366f1;">üìã</span>
                            <span>Selecci√≥n l√≠neas/objetivos EPVSA</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
                            <span style="color: #ec4899;">üó≥Ô∏è</span>
                            <span>Priorizaci√≥n EPVSA</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: #374151;">
                            <span style="color: #f59e0b;">üéØ</span>
                            <span>Priorizaci√≥n participativa</span>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb; font-size: 0.8rem; color: #6b7280;">
                        üí° Control total sobre cada componente del plan
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botones ocultos para mantener compatibilidad -->
        <button class="plan-modo-btn activo" id="btn-modo-auto" onclick="cambiarModoPlan('auto')" style="display:none;"></button>
        <button class="plan-modo-btn" id="btn-modo-manual" onclick="cambiarModoPlan('manual')" style="display:none;"></button>

        <!-- MODO AUTOMATIZADO -->
        <div class="plan-contenido" id="plan-modo-auto" style="display:none;">

            <!-- ESTADO INICIAL -->
            <div id="auto-ia-estado-inicial" style="padding:2rem; text-align:center;">
                <div style="font-size:3rem; margin-bottom:0.75rem;">üß†</div>
                <h3 style="color:#059669; margin:0 0 0.5rem;">Propuesta autom√°tica con IA</h3>
                <p style="color:#64748b; margin:0 0 1.5rem; max-width:480px; margin-left:auto; margin-right:auto;">
                    Claude analizar√° el informe de salud, los estudios complementarios y la priorizaci√≥n ciudadana para proponer las l√≠neas, objetivos y programas EPVSA m√°s adecuados.
                </p>
                <button onclick="generarPropuestaIA()" style="background:linear-gradient(135deg,#10b981,#059669); color:white; border:none; padding:0.85rem 2rem; border-radius:10px; font-size:1rem; font-weight:700; cursor:pointer; box-shadow:0 4px 15px rgba(16,185,129,0.35);">
                    üß† Generar propuesta con IA
                </button>
            </div>

            <!-- PROGRESO -->
            <div id="auto-ia-progreso" style="display:none; padding:2rem; text-align:center;">
                <div style="width:48px; height:48px; border:4px solid #d1fae5; border-top-color:#10b981; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 1rem;"></div>
                <p style="color:#059669; font-weight:600;">Analizando fuentes y generando propuesta EPVSA...</p>
                <p style="color:#94a3b8; font-size:0.85rem;">Esto puede tardar 20-30 segundos</p>
            </div>

            <!-- CONTENEDOR DE RESULTADOS -->
            <div id="propuesta-automatica-container" style="display:none;">
                <div class="propuesta-resumen" id="propuesta-resumen"></div>
                <div class="propuesta-detalle" id="propuesta-detalle"></div>
                <div class="propuesta-acciones">
                    <button class="btn-accion" id="btn-aceptar-propuesta" onclick="aceptarPropuesta()">‚úÖ Aceptar propuesta</button>
                    <button class="btn-accion secundario" onclick="regenerarPropuestaIA()">üîÑ Regenerar</button>
                </div>
                <div id="propuesta-aceptada-acciones" style="display:none; margin-top:1.5rem; padding:1.5rem; background:linear-gradient(135deg,#ecfdf5,#d1fae5); border:2px solid #10b981; border-radius:12px; text-align:center;">
                    <p style="margin:0 0 1rem; color:#065f46; font-weight:600;">‚úÖ Propuesta aceptada. Ahora genere el documento para completar el plan de acci√≥n.</p>
                    <button class="btn-accion" onclick="generarDocumentoPlan()" style="background:linear-gradient(135deg,#10b981,#059669);">üìÑ Generar documento del plan de acci√≥n</button>
                </div>
            </div>

        </div>

        <!-- MODO MANUAL -->
        <div class="plan-contenido" id="plan-modo-manual" style="display:none;">
            
            <!-- Navegaci√≥n interna del modo manual -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0;">
                <button id="tab-seleccion-epvsa" onclick="cambiarTabManual('seleccion')" style="background: #6366f1; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üìã</span> Selecci√≥n EPVSA
                </button>
                <button id="tab-votacion-ciudadana" onclick="cambiarTabManual('votacion')" style="background: #f1f5f9; color: #64748b; border: none; padding: 0.75rem 1.5rem; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üó≥Ô∏è</span> Priorizaci√≥n EPVSA
                </button>
                <button id="tab-votacion-relas" onclick="cambiarTabManual('votacion-relas')" style="background: #f1f5f9; color: #64748b; border: none; padding: 0.75rem 1.5rem; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üó≥Ô∏è</span> Prioridades ciudadanas
                </button>
                <button id="tab-analizador-relas" onclick="cambiarTabManual('relas')" style="background: #f1f5f9; color: #64748b; border: none; padding: 0.75rem 1.5rem; border-radius: 8px 8px 0 0; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                    <span>üìã</span> Analizador RELAS
                </button>
            </div>
            
            <!-- TAB: SELECCI√ìN EPVSA -->
            <div id="contenido-tab-seleccion" style="display: block;">
                <div class="plan-accion-header">
                    <h3>üìã Selecci√≥n manual de componentes EPVSA</h3>
                    <p>Seleccione las l√≠neas estrat√©gicas, objetivos, indicadores, programas y actuaciones.</p>
                    <div class="plan-accion-stats">
                        <div class="stat-mini"><span id="stat-lineas">0</span> L√≠neas</div>
                        <div class="stat-mini"><span id="stat-objetivos">0</span> Objetivos</div>
                        <div class="stat-mini"><span id="stat-indicadores-plan">0</span> Indicadores</div>
                        <div class="stat-mini"><span id="stat-programas">0</span> Programas</div>
                        <div class="stat-mini"><span id="stat-actuaciones">0</span> Actuaciones</div>
                    </div>
                </div>
                <div class="plan-accion-container" id="plan-accion-container"></div>
                <div class="plan-accion-footer">
                    <button class="btn-accion" onclick="generarDocumentoPlan()">üìÑ Generar plan de acci√≥n</button>
                    <button class="btn-accion secundario" onclick="exportarPlanJSON()">üíæ Exportar (JSON)</button>
                </div>
            </div>
            
            <!-- TAB: VOTACI√ìN CIUDADANA -->
            <div id="contenido-tab-votacion" style="display: none;">
                <div class="votacion-panel" id="votacion-panel-interno" style="display: block; background: white; border-radius: 12px; padding: 1.5rem; border: 1px solid #e2e8f0;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #ec4899, #be185d); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üó≥Ô∏è</div>
                        <div>
                            <h3 style="margin: 0; color: #1e293b;">Votaci√≥n popular de <span class="nombre-municipio-dinamico">Municipio</span></h3>
                        </div>
                    </div>
                    <p style="color: #64748b; margin-bottom: 1.5rem; padding: 1rem; background: #fdf4ff; border-radius: 8px; border-left: 4px solid #ec4899;">
                        Sistema de participaci√≥n ciudadana para <strong>priorizaci√≥n de objetivos</strong> del Plan local de salud. La ciudadan√≠a vota mediante <strong>c√≥digo QR, enlace web o votaci√≥n directa en pantalla</strong>. Los resultados se incorporan al plan.
                    </p>
                    
                    <!-- Controles de sesi√≥n -->
                    <div class="votacion-controles">
                        <button class="votacion-btn iniciar" id="btn-iniciar-votacion" onclick="iniciarSesionVotacion()">‚ñ∂Ô∏è Iniciar sesi√≥n</button>
                        <button class="votacion-btn detener" id="btn-detener-votacion" onclick="detenerSesionVotacion()" disabled>‚èπÔ∏è Detener</button>
                        <button class="votacion-btn reiniciar" onclick="reiniciarVotacion()">üîÑ Reiniciar</button>
                        <button class="votacion-btn" style="background: linear-gradient(135deg, #7c3aed, #a78bfa); color: white;" onclick="simularVotos()">üß™ Simular 150</button>
                    </div>
                    
                    <!-- Nuevos controles adicionales -->
                    <div class="votacion-controles" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                        <button class="votacion-btn" style="background: linear-gradient(135deg, #10b981, #059669); color: white;" onclick="abrirVotacionDirecta()" id="btn-votar-directo" disabled>
                            üñ•Ô∏è Votar desde aqu√≠
                        </button>
                        <button class="votacion-btn" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;" onclick="abrirFormularioManual()" id="btn-agregar-manual" disabled>
                            ‚úçÔ∏è Agregar voto manual
                        </button>
                        <button class="votacion-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;" onclick="generarFlyerPapel()">
                            üìÑ Generar flyer para imprimir
                        </button>
                    </div>
                    
                    <!-- Estado de la sesi√≥n -->
                    <div class="votacion-estado esperando" id="votacion-estado">
                        <div class="votacion-estado-dot"></div>
                        <span id="votacion-estado-texto">Pulse ¬´Iniciar sesi√≥n¬ª para comenzar</span>
                    </div>
                    
                    <!-- Grid principal -->
                    <div class="votacion-grid">
                        <!-- QR Code -->
                        <div class="votacion-qr-section">
                            <h4 style="margin-bottom: 1rem; color: #1e293b;">üì± C√≥digo QR</h4>
                            <div class="votacion-qr-container" id="votacion-qrcode">
                                <div style="width: 180px; height: 180px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 3rem;">üì±</div>
                            </div>
                            <div class="votacion-qr-url" id="votacion-url">El enlace aparecer√° aqu√≠</div>
                            <button id="btn-copiar-url" onclick="copiarEnlaceVotacion()" style="display: none; margin-top: 0.5rem; padding: 0.5rem 1rem; background: #0074c8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; width: 100%;">
                                üìã Copiar enlace para compartir
                            </button>
                            <div class="votacion-qr-instrucciones">
                                <strong>Instrucciones:</strong><br>
                                1. Inicie sesi√≥n<br>
                                2. Proyecte el QR<br>
                                3. Los ciudadanos escanean y votan
                            </div>
                        </div>
                        
                        <!-- QU√â SE VOTA - Opciones disponibles -->
                        <div class="votacion-stats-card" style="grid-column: span 2;">
                            <h4>üó≥Ô∏è ¬øQu√© se vota?</h4>
                            <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">Los ciudadanos responder√°n a dos preguntas sobre prioridades de salud:</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                                <!-- Pregunta 1: Objetivos EPVSA -->
                                <div style="background: #f0fdf4; border-radius: 8px; padding: 1rem; border-left: 4px solid #10b981;">
                                    <h5 style="color: #059669; margin: 0 0 0.75rem 0; font-size: 0.9rem;">üéØ Pregunta 1: Objetivo de salud prioritario</h5>
                                    <div style="display: flex; flex-direction: column; gap: 0.35rem; font-size: 0.8rem;">
                                        <div>ü§± Lactancia materna y alimentaci√≥n saludable</div>
                                        <div>üèÉ Actividad f√≠sica y reducci√≥n del sedentarismo</div>
                                        <div>üò¥ Horas y calidad del sue√±o</div>
                                        <div>üòä Calidad de vida y bienestar emocional</div>
                                        <div>‚ù§Ô∏è Satisfacci√≥n con relaciones sexuales</div>
                                        <div>üì± Reducci√≥n del uso de pantallas</div>
                                        <div>üèòÔ∏è Activos comunitarios</div>
                                        <div>üè¢ Empresas saludables</div>
                                        <div>üì¢ Difusi√≥n de h√°bitos saludables</div>
                                        <div>üéì Formaci√≥n e investigaci√≥n</div>
                                    </div>
                                </div>
                                
                                <!-- Pregunta 2: Colectivos -->
                                <div style="background: #eff6ff; border-radius: 8px; padding: 1rem; border-left: 4px solid #3b82f6;">
                                    <h5 style="color: #1d4ed8; margin: 0 0 0.75rem 0; font-size: 0.9rem;">üë• Pregunta 2: Colectivo prioritario</h5>
                                    <div style="display: flex; flex-direction: column; gap: 0.35rem; font-size: 0.8rem;">
                                        <div>üë• Poblaci√≥n general</div>
                                        <div>üë∂ Infancia</div>
                                        <div>üßí Adolescencia</div>
                                        <div>üë®‚Äçüéì Juventud</div>
                                        <div>üë¥ Mayores</div>
                                        <div>üë© Mujeres</div>
                                        <div>üè≥Ô∏è‚Äçüåà LGTBIQ+</div>
                                        <div>‚ú® Otros</div>
                                    </div>
                                </div>
                            </div>
                            
                            <p style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.75rem; font-style: italic;">
                                üí° Adem√°s se recoge sexo y edad de forma an√≥nima para an√°lisis demogr√°fico.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Estad√≠sticas y Feed en tiempo real -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.25rem;">
                        <!-- Estad√≠sticas en tiempo real -->
                        <div class="votacion-stats-card">
                            <h4>üìä Participaci√≥n</h4>
                            <div class="votacion-stats-row">
                                <div class="votacion-stat-mini">
                                    <div class="icono">üë•</div>
                                    <div class="valor" id="vot-stat-total">0</div>
                                    <div class="etiqueta">Votos</div>
                                </div>
                                <div class="votacion-stat-mini">
                                    <div class="icono">üë®</div>
                                    <div class="valor" id="vot-stat-hombres">0</div>
                                    <div class="etiqueta">Hombres</div>
                                </div>
                                <div class="votacion-stat-mini">
                                    <div class="icono">üë©</div>
                                    <div class="valor" id="vot-stat-mujeres">0</div>
                                    <div class="etiqueta">Mujeres</div>
                                </div>
                                <div class="votacion-stat-mini">
                                    <div class="icono">üìÖ</div>
                                    <div class="valor" id="vot-stat-edad-media">--</div>
                                    <div class="etiqueta">Edad media</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Feed en vivo -->
                        <div class="votacion-stats-card">
                            <h4>üî¥ En vivo</h4>
                            <div class="votacion-feed" id="votacion-feed">
                                <div style="text-align: center; color: #94a3b8; padding: 2rem;">Esperando votos...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resultados -->
                    <div style="margin-top: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.25rem;">
                        <!-- Top Objetivos EPVSA -->
                        <div class="votacion-stats-card">
                            <h4>üéØ Objetivos EPVSA m√°s votados</h4>
                            <div id="votacion-resultados-objetivos">
                                <p style="text-align: center; color: #94a3b8; padding: 1rem;">Sin datos a√∫n</p>
                            </div>
                        </div>
                        
                        <!-- Top Colectivos -->
                        <div class="votacion-stats-card">
                            <h4>üë• Colectivos prioritarios</h4>
                            <div id="votacion-resultados-colectivos">
                                <p style="text-align: center; color: #94a3b8; padding: 1rem;">Sin datos a√∫n</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Exportar resultados -->
                    <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <button class="btn-export" onclick="exportarVotacionCSV()"><span>üì•</span> Exportar CSV</button>
                        <button class="btn-accion" id="btn-incorporar-votacion" onclick="incorporarResultadosAlPlan()" style="background: linear-gradient(135deg, #10b981, #059669); padding: 0.6rem 1.2rem;"><span>üìã</span> Incorporar al plan de acci√≥n</button>
                    </div>
                </div>
            </div>

            <!-- =====================================================
                 TAB: VOTACI√ìN RELAS (H√°bitos, Problemas, Colectivos)
                 ===================================================== -->
            <div id="contenido-tab-votacion-relas" style="display:none;">
              <div style="background:white;border-radius:12px;padding:1.5rem;border:1px solid #e2e8f0;">

                <!-- Cabecera -->
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;">
                  <div style="width:50px;height:50px;background:linear-gradient(135deg,#0074c8,#00acd9);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;">üó≥Ô∏è</div>
                  <div>
                    <h3 style="margin:0;color:#1e293b;">Votaci√≥n Popular RELAS ¬∑ <span class="nombre-municipio-dinamico">Municipio</span></h3>
                    <p style="margin:0;color:#64748b;font-size:.85rem;">Temas prioritarios de salud</p>
                  </div>
                </div>

                <!-- Aviso -->
                <p style="color:#64748b;margin-bottom:1.5rem;padding:1rem;background:#f0f9ff;border-radius:8px;border-left:4px solid #0074c8;font-size:.9rem;">
                  Los resultados <strong>suman autom√°ticamente</strong> los votos previos cargados desde REDCap (CSV) y los votos recogidos en tiempo real durante este acto. Carga primero el CSV en el Analizador RELAS si dispones de votos previos.
                </p>

                <!-- Controles de sesi√≥n -->
                <div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1rem;">
                  <button onclick="vrelas_iniciarSesion()" id="vrelas-btn-iniciar" style="padding:.75rem 1.5rem;background:linear-gradient(135deg,#0074c8,#00acd9);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:.5rem;">‚ñ∂Ô∏è Iniciar sesi√≥n</button>
                  <button onclick="vrelas_detenerSesion()" id="vrelas-btn-detener" disabled style="padding:.75rem 1.5rem;background:linear-gradient(135deg,#dc143c,#ff6600);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;opacity:.5;">‚èπÔ∏è Detener</button>
                  <button onclick="vrelas_reiniciar()" style="padding:.75rem 1.5rem;background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;border-radius:8px;font-weight:600;cursor:pointer;">üîÑ Reiniciar</button>
                  <button onclick="vrelas_simular()" style="padding:.75rem 1.5rem;background:linear-gradient(135deg,#7c3aed,#a78bfa);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">üß™ Simular 50</button>
                </div>
                <div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1.25rem;padding-top:1rem;border-top:1px solid #e2e8f0;">
                  <button onclick="vrelas_votarAhora()" id="vrelas-btn-votar" disabled style="padding:.75rem 1.5rem;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;opacity:.5;">üñ•Ô∏è Votar desde aqu√≠</button>
                  <button onclick="vrelas_votoManual()" id="vrelas-btn-manual" style="padding:.75rem 1.5rem;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">‚úçÔ∏è Agregar voto manual</button>
                  <button onclick="vrelas_generarFlyer()" style="padding:.75rem 1.5rem;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">üìÑ Imprimir flyer</button>
                  <button onclick="relas_abrirPresentacion();vrelas_conectarPresentacion();" style="padding:.75rem 1.5rem;background:linear-gradient(135deg,#0074c8,#00acd9);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;">üñ•Ô∏è Presentar resultados</button>
                </div>

                <!-- Estado sesi√≥n -->
                <div id="vrelas-estado" style="display:flex;align-items:center;gap:.75rem;padding:.85rem 1.1rem;border-radius:10px;margin-bottom:1.25rem;background:#f1f5f9;color:#64748b;font-weight:500;font-size:.9rem;">
                  <div id="vrelas-estado-dot" style="width:10px;height:10px;border-radius:50%;background:#94a3b8;flex-shrink:0;"></div>
                  <span id="vrelas-estado-txt">Pulse ¬´Iniciar sesi√≥n¬ª para comenzar</span>
                </div>

                <!-- Grid principal: QR + Qu√© se vota -->
                <div style="display:grid;grid-template-columns:220px 1fr;gap:1.25rem;margin-bottom:1.25rem;">

                  <!-- QR -->
                  <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1.1rem;text-align:center;">
                    <h4 style="margin:0 0 .75rem;color:#1e293b;font-size:.9rem;">üì± C√≥digo QR</h4>
                    <div id="vrelas-qr" style="display:flex;align-items:center;justify-content:center;margin-bottom:.6rem;">
                      <div style="width:160px;height:160px;background:#f1f5f9;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:2.5rem;">üì±</div>
                    </div>
                    <div id="vrelas-url" style="font-size:.7rem;color:#64748b;word-break:break-all;margin-bottom:.5rem;">El enlace aparecer√° aqu√≠</div>
                    <button id="vrelas-btn-copiar" onclick="vrelas_copiarEnlace()" style="display:none;width:100%;padding:.45rem;background:#0074c8;color:white;border:none;border-radius:6px;font-size:.78rem;cursor:pointer;">üìã Copiar enlace</button>
                    <div style="margin-top:.75rem;font-size:.72rem;color:#94a3b8;text-align:left;line-height:1.5;">
                      <strong>Instrucciones:</strong><br>
                      1. Inicie sesi√≥n<br>
                      2. Proyecte el QR<br>
                      3. Ciudadanos escanean y votan
                    </div>
                  </div>

                  <!-- Qu√© se vota -->
                  <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1.1rem;">
                    <h4 style="margin:0 0 .6rem;color:#1e293b;font-size:.9rem;">üó≥Ô∏è ¬øQu√© se vota?</h4>
                    <p style="font-size:.82rem;color:#64748b;margin-bottom:.8rem;">La ciudadan√≠a responde <strong>una √∫nica pregunta</strong>, eligiendo hasta 5 temas:</p>
                    <div style="background:#e0f2fe;border-left:3px solid #0074c8;border-radius:6px;padding:.7rem 1rem;margin-bottom:.9rem;">
                      <span style="font-size:.85rem;font-weight:700;color:#0369a1;">üéØ ¬øSobre qu√© temas de salud deber√≠a actuar tu Ayuntamiento?</span>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:.4rem;">
                      <span style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.35rem .6rem;background:#f0fdf4;border-radius:6px;border:1px solid #86efac;">ü•ó Alimentaci√≥n</span>
                      <span style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.35rem .6rem;background:#eff6ff;border-radius:6px;border:1px solid #93c5fd;">üèÉ Actividad f√≠sica</span>
                      <span style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.35rem .6rem;background:#fdf4ff;border-radius:6px;border:1px solid #d8b4fe;">üß† Bienestar emocional y salud mental</span>
                      <span style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.35rem .6rem;background:#fff7ed;border-radius:6px;border:1px solid #fdba74;">üì± Uso de pantallas y redes sociales</span>
                      <span style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.35rem .6rem;background:#f0f9ff;border-radius:6px;border:1px solid #7dd3fc;">üò¥ Sue√±o y descanso</span>
                      <span style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.35rem .6rem;background:#fef2f2;border-radius:6px;border:1px solid #fca5a5;">üö¨ Tabaco, vapeadores, alcohol y otras drogas</span>
                      <span style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.35rem .6rem;background:#fff1f2;border-radius:6px;border:1px solid #fda4af;">‚ù§Ô∏è Sexualidad y salud</span>
                      <span style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.35rem .6rem;background:#fdf2f8;border-radius:6px;border:1px solid #f0abfc;">‚úä Violencia de g√©nero</span>
                      <span style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.35rem .6rem;background:#f0fdf4;border-radius:6px;border:1px solid #4ade80;">üåø Medioambiente y municipio</span>
                      <span style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;padding:.35rem .6rem;background:#fefce8;border-radius:6px;border:1px solid #fde047;">‚ö†Ô∏è Accidentes en el hogar y la v√≠a p√∫blica</span>
                    </div>
                    <p style="font-size:.72rem;color:#94a3b8;margin-top:.7rem;font-style:italic;">üí° M√°ximo 5 selecciones por votante ¬∑ voto an√≥nimo</p>
                  </div>
                </div>

                <!-- Estad√≠sticas en tiempo real -->
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-bottom:1.25rem;">
                  <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;">
                    <h4 style="margin:0 0 .75rem;color:#1e293b;font-size:.9rem;">üìä Participaci√≥n total</h4>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;text-align:center;">
                      <div><div id="vrelas-stat-total" style="font-size:1.8rem;font-weight:800;color:#0074c8;">0</div><div style="font-size:.7rem;color:#64748b;">Total</div></div>
                      <div><div id="vrelas-stat-previos" style="font-size:1.8rem;font-weight:800;color:#94d40b;">0</div><div style="font-size:.7rem;color:#64748b;">CSV previos</div></div>
                      <div><div id="vrelas-stat-acto" style="font-size:1.8rem;font-weight:800;color:#ff6600;">0</div><div style="font-size:.7rem;color:#64748b;">En el acto</div></div>
                      <div><div id="vrelas-stat-ahora" style="font-size:1.8rem;font-weight:800;color:#dc143c;">üî¥</div><div style="font-size:.7rem;color:#64748b;">En vivo</div></div>
                    </div>
                  </div>
                  <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;">
                    <h4 style="margin:0 0 .75rem;color:#1e293b;font-size:.9rem;">üî¥ √öltimos votos</h4>
                    <div id="vrelas-feed" style="display:flex;flex-direction:column;gap:.3rem;max-height:100px;overflow-y:auto;">
                      <div style="text-align:center;color:#94a3b8;font-size:.8rem;padding:.5rem;">Esperando votos...</div>
                    </div>
                  </div>
                </div>

                <!-- Gr√°ficos de resultados -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem;" id="vrelas-charts-wrap">
                  <!-- Ranking horizontal -->
                  <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;grid-column:span 2;">
                    <h4 style="margin:0 0 .75rem;color:#0074c8;font-size:.85rem;">üèÜ Ranking de temas prioritarios</h4>
                    <div id="vrelas-res-temas" style="font-size:.8rem;color:#94a3b8;">Esperando votos‚Ä¶</div>
                    <canvas id="vrelas-chartBar" style="display:none;width:100%;height:260px;"></canvas>
                    <p id="vrelas-txt-bar" style="display:none;margin-top:.75rem;font-size:.78rem;color:#475569;line-height:1.6;border-top:1px solid #e2e8f0;padding-top:.65rem;"></p>
                  </div>
                  <!-- Radar -->
                  <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;">
                    <h4 style="margin:0 0 .75rem;color:#7c3aed;font-size:.85rem;">üï∏Ô∏è Radar de prioridades</h4>
                    <div id="vrelas-radar-empty" style="font-size:.8rem;color:#94a3b8;">Esperando votos‚Ä¶</div>
                    <canvas id="vrelas-chartRadarCiu" style="display:none;width:100%;height:260px;"></canvas>
                    <p id="vrelas-txt-radar" style="display:none;margin-top:.75rem;font-size:.78rem;color:#475569;line-height:1.6;border-top:1px solid #e2e8f0;padding-top:.65rem;"></p>
                  </div>
                  <!-- Distribuci√≥n n¬∫ selecciones -->
                  <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:1rem;">
                    <h4 style="margin:0 0 .75rem;color:#059669;font-size:.85rem;">üì¶ N¬∫ de temas elegidos por votante</h4>
                    <div id="vrelas-dist-empty" style="font-size:.8rem;color:#94a3b8;">Esperando votos‚Ä¶</div>
                    <canvas id="vrelas-chartDist" style="display:none;width:100%;height:260px;"></canvas>
                    <p id="vrelas-txt-dist" style="display:none;margin-top:.75rem;font-size:.78rem;color:#475569;line-height:1.6;border-top:1px solid #e2e8f0;padding-top:.65rem;"></p>
                  </div>
                </div>

                <!-- Botones exportar -->
                <div style="display:flex;gap:.75rem;flex-wrap:wrap;">
                  <button onclick="vrelas_exportarCSV()" style="padding:.5rem 1rem;background:white;border:1px solid #e2e8f0;border-radius:6px;font-size:.85rem;cursor:pointer;">üì• Exportar CSV</button>
                  <button onclick="vrelas_incorporarAlPlan()" style="padding:.5rem 1.2rem;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:6px;font-size:.85rem;font-weight:600;cursor:pointer;">üìã Incorporar al plan</button>
                </div>

              </div>
            </div>

            <!-- =====================================================
                 TAB: ANALIZADOR RELAS
                 ===================================================== -->
            <div id="contenido-tab-relas" style="display:none;">
              <style>
                /* ‚îÄ‚îÄ namespace relas- para no colisionar con COMP√ÅS ‚îÄ‚îÄ */
                .relas-wrap{font-family:system-ui,sans-serif;color:#1a1a1a;padding:1rem 0}
                .relas-topbar{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin-bottom:1.2rem}
                .relas-upload-area{border:2px dashed #74c69d;border-radius:10px;padding:1.5rem;text-align:center;cursor:pointer;background:#f4faf6;transition:background .2s}
                .relas-upload-area:hover,.relas-upload-area.drag-over{background:#d8f3dc}
                .relas-upload-area h3{margin:0 0 .4rem;color:#2d6a4f;font-size:1rem}
                .relas-upload-area p{margin:0;font-size:.78rem;color:#666}
                .relas-statusbar{display:none;background:linear-gradient(135deg,#2d6a4f,#40916c);color:#fff;border-radius:10px;padding:.8rem 1.2rem;display:none;gap:1.5rem;align-items:center;flex-wrap:wrap;margin-bottom:1rem}
                .relas-stat{text-align:center}.relas-stat-val{font-size:1.3rem;font-weight:700}.relas-stat-lbl{font-size:.65rem;opacity:.8;text-transform:uppercase}
                .relas-tabs{display:flex;gap:.3rem;flex-wrap:wrap;border-bottom:2px solid #d8f3dc;margin-bottom:1rem}
                .relas-tab{background:none;border:none;padding:.55rem 1rem;border-radius:6px 6px 0 0;font-size:.8rem;cursor:pointer;color:#555;border-bottom:2px solid transparent;margin-bottom:-2px}
                .relas-tab.active{background:#d8f3dc;color:#2d6a4f;font-weight:700;border-bottom:2px solid #40916c}
                .relas-panel{display:none}.relas-panel.active{display:block}
                .relas-empty{text-align:center;padding:2rem;color:#aaa;font-size:.85rem}
                .relas-chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;margin-top:1rem}
                .relas-chart-box{background:#fff;border:1px solid #e8f5e9;border-radius:8px;padding:1rem}
                .relas-chart-box h4{margin:0 0 .5rem;font-size:.82rem;color:#2d6a4f}
                .relas-chart-box canvas{max-height:220px}
                .relas-kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.8rem;margin-bottom:1rem}
                .relas-kpi{background:linear-gradient(135deg,#f4faf6,#d8f3dc);border-radius:8px;padding:.8rem;text-align:center}
                .relas-kpi-val{font-size:1.6rem;font-weight:700;color:#2d6a4f}
                .relas-kpi-lbl{font-size:.68rem;color:#555;margin-top:.2rem}
                .relas-rank-list{display:flex;flex-direction:column;gap:.4rem}
                .relas-rank-item{display:flex;align-items:center;gap:.5rem;font-size:.78rem}
                .relas-rank-num{width:22px;height:22px;border-radius:50%;background:#2d6a4f;color:#fff;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;flex-shrink:0}
                .relas-rank-label{width:140px;flex-shrink:0}
                .relas-rank-bar-wrap{flex:1;height:10px;background:#e8f5e9;border-radius:5px;overflow:hidden}
                .relas-rank-bar{height:100%;background:linear-gradient(90deg,#40916c,#74c69d);border-radius:5px;transition:width .6s}
                .relas-rank-pct{width:55px;text-align:right;color:#555}
                .relas-strategy-block{background:#f4faf6;border:1px solid #b7e4c7;border-radius:10px;padding:1rem;margin-bottom:1rem}
                .relas-strategy-header{display:flex;gap:.7rem;align-items:flex-start;margin-bottom:.8rem}
                .relas-strategy-icon{font-size:1.5rem;line-height:1}
                .relas-strategy-name{font-weight:700;font-size:.9rem;color:#2d6a4f}
                .relas-strategy-subtitle{font-size:.72rem;color:#777}
                .relas-strategy-items{display:flex;flex-direction:column;gap:.3rem}
                .relas-strategy-item{display:flex;align-items:center;gap:.5rem;font-size:.78rem;padding:.25rem .5rem;border-radius:4px}
                .relas-strategy-item.alta{background:#d8f3dc}.relas-strategy-item.media{background:#fff9c4}.relas-strategy-item.baja{background:#f1f5f9}
                .relas-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
                .relas-dot-alta{background:#2d6a4f}.relas-dot-media{background:#f59e0b}.relas-dot-baja{background:#94a3b8}
                .relas-insight{background:#fff;border:1px solid #e8f5e9;border-left:4px solid #40916c;border-radius:6px;padding:.9rem;margin-bottom:.7rem}
                .relas-ins-title{font-weight:700;font-size:.82rem;color:#2d6a4f;margin-bottom:.35rem}
                .relas-recom-table{width:100%;border-collapse:collapse;font-size:.78rem}
                .relas-recom-table th{background:#2d6a4f;color:#fff;padding:.5rem .6rem;text-align:left;font-size:.72rem}
                .relas-recom-table td{padding:.45rem .6rem;border-bottom:1px solid #f0f4f0}
                .relas-recom-table tr:hover td{background:#f4faf6}
                .relas-priority-tag{display:inline-block;padding:.1rem .45rem;border-radius:4px;font-size:.68rem;font-weight:700}
                .relas-p-alta{background:#d8f3dc;color:#2d6a4f}.relas-p-media{background:#fff9c4;color:#92400e}
                .relas-strategy-link{font-size:.7rem;background:#e0f2fe;color:#0369a1;padding:.1rem .35rem;border-radius:3px}
                .relas-heatmap-table{border-collapse:collapse;font-size:.72rem;width:100%}
                .relas-heatmap-table th,.relas-heatmap-table td{padding:.3rem .4rem;border:1px solid #e8f5e9;text-align:center}
                .relas-heatmap-table th{background:#f4faf6;color:#2d6a4f;font-weight:600}
                .relas-heatmap-table .row-label{text-align:left;font-size:.7rem;max-width:110px;background:#f9fbf9}
                /* Simulador */
                .relas-sim-layout{display:grid;grid-template-columns:280px 1fr;gap:1rem}
                @media(max-width:700px){.relas-sim-layout{grid-template-columns:1fr}}
                .relas-sim-panel{background:#f4faf6;border:1px solid #b7e4c7;border-radius:10px;padding:1rem}
                .relas-sim-section{margin-bottom:1rem}
                .relas-sim-section h4{font-size:.78rem;color:#2d6a4f;margin:0 0 .5rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em}
                .relas-chip-grid{display:flex;flex-wrap:wrap;gap:.3rem}
                .relas-chip{padding:.2rem .55rem;border-radius:4px;font-size:.7rem;cursor:pointer;border:1.5px solid #b7e4c7;background:#fff;transition:all .15s}
                .relas-chip.sel{background:#2d6a4f;color:#fff;border-color:#2d6a4f}
                .relas-run-btn{width:100%;padding:.7rem;background:linear-gradient(135deg,#2d6a4f,#52b788);color:#fff;border:none;border-radius:8px;font-weight:700;font-size:.85rem;cursor:pointer;margin-top:.5rem}
                .relas-export-btn{padding:.45rem .9rem;background:#fff;border:1.5px solid #74c69d;border-radius:6px;font-size:.75rem;cursor:pointer;color:#2d6a4f;font-weight:600}
                .relas-export-btn:hover{background:#d8f3dc}
                .relas-results-area{min-height:200px}
                .relas-ssh-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
                .relas-ssh-title{font-weight:700;font-size:1rem;color:#1a1a1a}
                .relas-ssh-sub{font-size:.72rem;color:#888}
                .relas-score-circle{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#2d6a4f,#52b788);display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0}
                .relas-score-num{font-size:1.2rem;font-weight:700;color:#fff;line-height:1}
                .relas-score-lbl{font-size:.5rem;color:rgba(255,255,255,.8);text-transform:uppercase}
                .relas-dims{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-bottom:.8rem}
                @media(max-width:600px){.relas-dims{grid-template-columns:repeat(2,1fr)}}
                .relas-dim{font-size:.72rem}
                .relas-dim-label{color:#888;margin-bottom:.2rem}
                .relas-dim-bar{height:8px;background:#e8f5e9;border-radius:4px;overflow:hidden;margin-bottom:.15rem}
                .relas-dim-fill{height:100%;background:linear-gradient(90deg,#40916c,#74c69d);border-radius:4px}
                .relas-dim-val{color:#2d6a4f;font-weight:600}
                .relas-iv-card{background:#fff;border:1px solid #d0e0d6;border-left:4px solid #40916c;border-radius:6px;padding:.8rem;margin-bottom:.6rem;cursor:pointer;transition:box-shadow .15s}
                .relas-iv-card:hover{box-shadow:0 3px 12px rgba(45,106,79,.15)}
                .relas-iv-title{font-weight:700;color:#2d6a4f;font-size:.85rem}
                .relas-iv-meta{font-size:.72rem;color:#777;margin:.25rem 0}
                .relas-ev-bar{height:8px;border-radius:4px;background:#e8f5e9;overflow:hidden;margin-bottom:.3rem}
                .relas-ev-fill{height:100%;background:linear-gradient(90deg,#40916c,#95d5b2);border-radius:4px}
                .relas-triple-btn{margin-top:.8rem;width:100%;padding:.65rem;background:linear-gradient(135deg,#6366f1,#7c3aed);color:#fff;border:none;border-radius:8px;font-weight:700;font-size:.82rem;cursor:pointer}
                .relas-triple-modal{display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
                .relas-triple-modal.open{display:flex}
                .relas-triple-box{background:#fff;border-radius:14px;padding:1.5rem;max-width:800px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
                .relas-triple-cols{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin:1rem 0}
                @media(max-width:600px){.relas-triple-cols{grid-template-columns:1fr}}
                .relas-triple-col{border-radius:8px;padding:.8rem;border:1px solid #e2e8f0}
                .relas-triple-col h4{margin:0 0 .5rem;font-size:.8rem;font-weight:700}
                .relas-triple-col.epi{border-left:4px solid #6366f1;background:#f5f3ff}
                .relas-triple-col.ciu{border-left:4px solid #ec4899;background:#fdf4ff}
                .relas-triple-col.rel{border-left:4px solid #10b981;background:#f0fdf4}
                .relas-confirm-btn{width:100%;padding:.7rem;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-top:.5rem}
                /* Ficha modal */
                .relas-ficha-overlay{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
                .relas-ficha-overlay.open{display:flex}
                .relas-ficha-box{background:#fff;border-radius:14px;padding:0;max-width:720px;width:95%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
                .relas-ficha-header{background:linear-gradient(135deg,#2d6a4f,#40916c);color:#fff;padding:1.2rem 1.5rem;display:flex;justify-content:space-between;align-items:flex-start;border-radius:14px 14px 0 0}
                .relas-ficha-close{background:rgba(255,255,255,.2);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center}
                .relas-ficha-body{padding:1.2rem 1.5rem}
                .relas-ficha-section{margin-bottom:1rem}
                .relas-ficha-section-title{font-weight:700;font-size:.78rem;color:#2d6a4f;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.5rem;padding-bottom:.25rem;border-bottom:1px solid #e8f5e9}
                .relas-ficha-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.6rem}
                .relas-ficha-field{background:#f4faf6;border-radius:6px;padding:.5rem .7rem}
                .relas-ficha-field-label{font-size:.65rem;color:#888;text-transform:uppercase;font-weight:600}
                .relas-ficha-field-val{font-size:.8rem;color:#1a1a1a;margin-top:.15rem;font-weight:600}
                .relas-ev-meter{background:#f4faf6;border-radius:6px;padding:.5rem .7rem}
                .relas-ev-label{font-size:.65rem;color:#888;font-weight:600;text-transform:uppercase;margin-bottom:.3rem}
                .relas-int-recursos{display:flex;flex-wrap:wrap;gap:.3rem}
                .relas-int-recursos span{background:#e8f5e9;color:#2d6a4f;padding:.15rem .4rem;border-radius:4px;font-size:.7rem}
                .relas-int-steps{list-style:none;margin:0;padding:0}
                .relas-int-steps li{padding:.25rem 0 .25rem 1.2rem;position:relative;font-size:.78rem;border-bottom:1px solid #f0f4f0}
                .relas-int-steps li:before{content:'‚Üí';position:absolute;left:0;color:#40916c}
                .relas-ficha-print-btn{width:100%;padding:.65rem;background:linear-gradient(135deg,#264653,#2a9d8f);color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-top:.7rem;font-size:.82rem}
              </style>

              <div class="relas-wrap">
                <!-- Topbar de carga -->
                <div class="relas-topbar">
                  <button onclick="relas_loadDemo()" style="padding:.5rem 1rem;background:#2d6a4f;color:#fff;border:none;border-radius:6px;font-size:.8rem;cursor:pointer;font-weight:600">üß™ Datos demo</button>
                  <label style="padding:.5rem 1rem;background:#40916c;color:#fff;border:none;border-radius:6px;font-size:.8rem;cursor:pointer;font-weight:600">
                    üìÇ Cargar CSV RELAS <input type="file" accept=".csv" onchange="relas_handleFile(event)" style="display:none">
                  </label>
                  <button onclick="relas_cargarDesdeFirebase(getMunicipioActual())" style="padding:.5rem 1rem;background:#6366f1;color:#fff;border:none;border-radius:6px;font-size:.8rem;cursor:pointer;font-weight:600">üî• Cargar desde Firebase</button>
                  <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center">
                    <button id="relas-btn-presentar" onclick="relas_abrirPresentacion()" style="display:none;padding:.5rem 1.1rem;background:linear-gradient(135deg,#0074c8,#00acd9);color:#fff;border:none;border-radius:6px;font-size:.8rem;cursor:pointer;font-weight:700;box-shadow:0 2px 8px rgba(0,116,200,.4)">üñ•Ô∏è Presentar resultados</button>
                    <button class="relas-export-btn" onclick="relas_exportarInforme()">üìÑ Exportar informe</button>
                    <button class="relas-export-btn" onclick="relas_exportarCSVResumen()">üìä Exportar CSV</button>
                  </div>
                </div>

                <!-- Status bar -->
                <div class="relas-statusbar" id="relas-statusbar" style="display:none">
                  <div class="relas-stat"><div class="relas-stat-val" id="relas-st-total">0</div><div class="relas-stat-lbl">Participantes</div></div>
                  <div class="relas-stat"><div class="relas-stat-val" id="relas-st-hab">‚Äî</div><div class="relas-stat-lbl">Top h√°bito</div></div>
                  <div class="relas-stat"><div class="relas-stat-val" id="relas-st-prob">‚Äî</div><div class="relas-stat-lbl">Top problema</div></div>
                  <div class="relas-stat"><div class="relas-stat-val" id="relas-st-col">‚Äî</div><div class="relas-stat-lbl">Top colectivo</div></div>
                </div>

                <!-- Zona drop si no hay datos -->
                <div class="relas-upload-area" id="relas-dropZone">
                  <h3>üìÅ Arrastra aqu√≠ el CSV de RELAS o usa los botones de arriba</h3>
                  <p>Columnas esperadas: habitos_vida___1‚Ä¶6, problemas_salud___1‚Ä¶8, colectivos___1‚Ä¶6</p>
                </div>

                <!-- Tabs internos RELAS -->
                <div class="relas-tabs" id="relas-mainTabs" style="display:none;margin-top:1rem">
                  <button class="relas-tab active" onclick="relas_showTab('frecuencias')">üìä Frecuencias</button>
                  <button class="relas-tab" onclick="relas_showTab('ranking')">üèÜ Ranking</button>
                  <button class="relas-tab" onclick="relas_showTab('correlaciones')">üîó Correlaciones</button>
                  <button class="relas-tab" onclick="relas_showTab('estrategias')">üå± Estrategias</button>
                  <button class="relas-tab" onclick="relas_showTab('insights')">üí° Insights</button>
                  <button class="relas-tab" onclick="relas_showTab('recomendaciones')">üìã Recomendaciones</button>
                  <button class="relas-tab" onclick="relas_showTab('simulador')">üß™ Simulador</button>
                </div>

                <!-- Panel Frecuencias -->
                <div class="relas-panel active" id="relas-panel-frecuencias">
                  <div class="relas-empty" id="relas-empty-frecuencias">Carga datos para ver las frecuencias</div>
                  <div id="relas-content-frecuencias" style="display:none">
                    <div class="relas-kpi-grid" id="relas-kpiGrid"></div>
                    <div class="relas-chart-grid">
                      <div class="relas-chart-box"><h4>ü•ó H√°bitos de vida</h4><canvas id="relas-chartHabitos"></canvas></div>
                      <div class="relas-chart-box"><h4>üè• Problemas de salud</h4><canvas id="relas-chartProblemas"></canvas></div>
                      <div class="relas-chart-box"><h4>üë• Colectivos</h4><canvas id="relas-chartColectivos"></canvas></div>
                      <div class="relas-chart-box"><h4>üì¶ Distribuci√≥n de selecciones</h4><canvas id="relas-chartSelCount"></canvas></div>
                    </div>
                  </div>
                </div>

                <!-- Panel Ranking -->
                <div class="relas-panel" id="relas-panel-ranking">
                  <div class="relas-empty" id="relas-empty-ranking">Carga datos para ver el ranking</div>
                  <div id="relas-content-ranking" style="display:none">
                    <div class="relas-chart-grid">
                      <div class="relas-chart-box"><h4>ü•ó Ranking H√°bitos</h4><div class="relas-rank-list" id="relas-rankHabitos"></div></div>
                      <div class="relas-chart-box"><h4>üè• Ranking Problemas</h4><div class="relas-rank-list" id="relas-rankProblemas"></div></div>
                      <div class="relas-chart-box"><h4>üë• Ranking Colectivos</h4><div class="relas-rank-list" id="relas-rankColectivos"></div></div>
                      <div class="relas-chart-box" style="min-height:260px"><h4>üï∏Ô∏è Radar de prioridades</h4><canvas id="relas-chartRadar"></canvas></div>
                    </div>
                  </div>
                </div>

                <!-- Panel Correlaciones -->
                <div class="relas-panel" id="relas-panel-correlaciones">
                  <div class="relas-empty" id="relas-empty-correlaciones">Carga datos para ver correlaciones</div>
                  <div id="relas-content-correlaciones" style="display:none">
                    <div class="relas-chart-grid">
                      <div class="relas-chart-box"><h4>üîó Top combinaciones</h4><div id="relas-topCombos"></div></div>
                      <div class="relas-chart-box" style="grid-column:span 2"><h4>üå°Ô∏è Mapa de calor H√°bitos √ó Problemas</h4><div style="overflow-x:auto" id="relas-heatmap-hp"></div></div>
                      <div class="relas-chart-box" style="grid-column:span 2"><h4>üå°Ô∏è Mapa de calor Problemas √ó Colectivos</h4><div style="overflow-x:auto" id="relas-heatmap-pc"></div></div>
                    </div>
                  </div>
                </div>

                <!-- Panel Estrategias -->
                <div class="relas-panel" id="relas-panel-estrategias">
                  <div class="relas-empty" id="relas-empty-estrategias">Carga datos para ver alineaci√≥n estrat√©gica</div>
                  <div id="relas-content-estrategias" style="display:none">
                    <div class="relas-chart-grid">
                      <div id="relas-epvsaBlock"></div>
                      <div id="relas-escaBlock"></div>
                      <div class="relas-chart-box" style="min-height:240px"><h4>üéØ Alineaci√≥n estrat√©gica</h4><canvas id="relas-chartAlineacion"></canvas></div>
                    </div>
                  </div>
                </div>

                <!-- Panel Insights -->
                <div class="relas-panel" id="relas-panel-insights">
                  <div class="relas-empty" id="relas-empty-insights">Carga datos para ver insights</div>
                  <div id="relas-content-insights" style="display:none">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                      <div id="relas-insightsContainer"></div>
                      <div class="relas-chart-box" style="min-height:260px"><h4>üìà Perfil de prioridades</h4><canvas id="relas-chartPerfil"></canvas></div>
                    </div>
                  </div>
                </div>

                <!-- Panel Recomendaciones -->
                <div class="relas-panel" id="relas-panel-recomendaciones">
                  <div class="relas-empty" id="relas-empty-recomendaciones">Carga datos para ver recomendaciones</div>
                  <div id="relas-content-recomendaciones" style="display:none">
                    <div style="overflow-x:auto;margin-bottom:1rem">
                      <table class="relas-recom-table"><thead><tr><th>Intervenci√≥n</th><th>√Åmbito</th><th>Colectivo</th><th>Prioridad</th><th>Marco</th></tr></thead>
                      <tbody id="relas-recomBody"></tbody></table>
                    </div>
                    <div class="relas-chart-box" style="min-height:300px"><h4>üìä Matriz de priorizaci√≥n</h4><canvas id="relas-chartMatriz"></canvas></div>
                  </div>
                </div>

                <!-- Panel Simulador -->
                <div class="relas-panel" id="relas-panel-simulador">
                  <div class="relas-sim-layout">
                    <div class="relas-sim-panel">
                      <div class="relas-sim-section">
                        <label style="font-size:.78rem;color:#555;font-weight:600">Nombre del escenario</label>
                        <input id="relas-simNombre" placeholder="Ej: Escenario J√≥venes 2026" style="width:100%;padding:.4rem .6rem;border:1px solid #b7e4c7;border-radius:6px;font-size:.78rem;margin-top:.25rem;box-sizing:border-box">
                      </div>
                      <div class="relas-sim-section">
                        <h4>ü•ó H√°bitos de vida</h4>
                        <div class="relas-chip-grid" id="relas-sim-hab"></div>
                      </div>
                      <div class="relas-sim-section">
                        <h4>üè• Problemas de salud</h4>
                        <div class="relas-chip-grid" id="relas-sim-prob"></div>
                      </div>
                      <div class="relas-sim-section">
                        <h4>üë• Colectivos</h4>
                        <div class="relas-chip-grid" id="relas-sim-col"></div>
                      </div>
                      <button class="relas-run-btn" onclick="relas_runSimulator()">‚ñ∂ Ejecutar simulaci√≥n</button>
                      <button class="relas-triple-btn" onclick="relas_mostrarPriorizacionTriple()">‚ö° Fusi√≥n triple (Epi + Ciudadana + RELAS)</button>
                    </div>
                    <div>
                      <div id="relas-simResultsArea" class="relas-results-area">
                        <div style="text-align:center;padding:3rem;color:#aaa">
                          <div style="font-size:2rem;margin-bottom:.5rem">üß™</div>
                          <div>Configura un escenario y ejecuta la simulaci√≥n para ver las intervenciones recomendadas</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div><!-- /relas-wrap -->


            </div><!-- /contenido-tab-relas -->

        </div>

        <!-- DOCUMENTO GENERADO (compartido por ambos modos) -->
        <div class="plan-documento-container" id="plan-documento-container" style="display:none;">
            <div class="plan-documento" id="plan-documento"></div>
            <div class="plan-documento-acciones">
                <button class="btn-export" onclick="imprimirPlan()"><span>üñ®Ô∏è</span> Imprimir</button>
                <button class="btn-export" onclick="exportarPlanPDF()"><span>üìë</span> PDF</button>
                <button class="btn-accion secundario" onclick="cerrarDocumentoPlan()">‚ùå Cerrar</button>
            </div>
        </div>
        
        <!-- ACCESO R√ÅPIDO A VOTACI√ìN CIUDADANA (siempre visible) -->
        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px dashed #e2e8f0;">
            <button class="btn-accion terciario" id="btn-votacion-ciudadana" onclick="toggleVotacionPanel()" style="background: linear-gradient(135deg, #ec4899, #be185d); color: white;">
                üó≥Ô∏è Abrir herramienta de Priorizaci√≥n Popular
            </button>
            <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">Acceso directo a la elecci√≥n de prioridades independientemente del modo de planificaci√≥n seleccionado.</p>
        </div>
    </div>
    <div class="fase-contenido" id="fase-4-contenido">
        <div class="compilador-pls">
            <div class="compilador-header" style="background: linear-gradient(135deg, #ffb61b15 0%, #ff660015 100%); border: 2px solid #ffb61b; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h2 style="color: #1e293b; margin: 0;">üìÑ Plan local de salud de <span class="nombre-municipio-dinamico">Padul</span></h2>
                        <p style="color: #475569; margin: 0.5rem 0 0 0;">Documento integrador: Perfil de salud + Plan de acci√≥n + Agenda anual</p>
                    </div>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <button class="btn-accion" onclick="previsualizarPLS()" style="margin: 0;">üëÅÔ∏è Previsualizar</button>
                        <button class="btn-export" onclick="generarPLS()" id="btn-generar-pls"><span>üñ®Ô∏è</span> Imprimir</button>
                        <button class="btn-export" onclick="exportarPDFPlanLocal()"><span>üìë</span> PDF</button>
                        <button class="btn-export" onclick="exportarHTMLPlan()"><span>üì•</span> HTML</button>
                    </div>
                </div>
            </div>
            
            <!-- Estado del compilador -->
            <div class="compilador-estado" style="background: #f8fafc; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid #e2e8f0;">
                <h4 style="margin: 0 0 1rem 0; color: #1e293b; font-size: 1rem;">üìã Estado del documento</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #0074c8, #00acd9); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85rem;">1</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 0.9rem;">Perfil de salud</div>
                            <div id="estado-perfil" style="font-size: 0.8rem;"><span style="color:#f59e0b;">‚è≥ Pendiente - Genera el perfil en Fase 2</span></div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #94d40b, #94d40b); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85rem;">2</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 0.9rem;">Plan de acci√≥n</div>
                            <div id="estado-plan" style="font-size: 0.8rem;"><span style="color:#f59e0b;">‚è≥ Pendiente - Genera el plan en Fase 3</span></div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #ff6600, #dc143c); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85rem;">3</div>
                        <div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 0.9rem;">Agenda anual 2026</div>
                            <div id="estado-agenda" style="font-size: 0.8rem;"><span style="color:#f59e0b;">‚è≥ Pendiente - A√±ada actuaciones en Fase 6</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Badges detallados de datos cargados -->
                <div id="badges-datos-cargados" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e2e8f0;">
                    <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem;">Datos del municipio:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="badges-container">
                        <span class="badge-dato" id="badge-informe" style="background:#fff9e6;color:#ff6600;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;">üìÑ Informe: --</span>
                        <span class="badge-dato" id="badge-determinantes" style="background:#fff9e6;color:#ff6600;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;">üìä Determinantes: --</span>
                        <span class="badge-dato" id="badge-conclusiones" style="background:#fff9e6;color:#ff6600;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;">üí° Conclusiones: --</span>
                        <span class="badge-dato" id="badge-priorizacion" style="background:#fff9e6;color:#ff6600;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;">üó≥Ô∏è Priorizaci√≥n: --</span>
                    </div>
                </div>
            </div>
            
            <div class="compilador-contenido" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <!-- Parte 1: Perfil de salud -->
                <div class="compilador-seccion" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #0074c8;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #0074c8, #00acd9); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">1</div>
                        <h3 style="margin: 0; color: #1e293b;">Perfil de salud local</h3>
                    </div>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem; color: #475569;">
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üìã Marco estrat√©gico EPVSA</li>
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üìä Informe situaci√≥n de salud</li>
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üè† Determinantes de la salud</li>
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üí° Conclusiones y recomendaciones</li>
                        <li style="padding: 0.4rem 0;">üó≥Ô∏è Priorizaci√≥n del Grupo motor</li>
                    </ul>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f1f5f9;">
                        <button onclick="irAFase(2)" style="background: #0074c8; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">Ir a Fase 2 ‚Üí</button>
                    </div>
                </div>
                
                <!-- Parte 2: Plan de acci√≥n -->
                <div class="compilador-seccion" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #94d40b;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #94d40b, #94d40b); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">2</div>
                        <h3 style="margin: 0; color: #1e293b;">Plan de acci√≥n</h3>
                    </div>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem; color: #475569;">
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üéØ L√≠neas estrat√©gicas priorizadas</li>
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üìã Objetivos por entorno</li>
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üìä Programas y actuaciones</li>
                        <li style="padding: 0.4rem 0;">üìà Indicadores de seguimiento</li>
                    </ul>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f1f5f9;">
                        <button onclick="irAFase(3)" style="background: #94d40b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">Ir a Fase 3 ‚Üí</button>
                    </div>
                </div>
                
                <!-- Parte 3: Agenda anual -->
                <div class="compilador-seccion" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #ff6600;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ff6600, #dc143c); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">3</div>
                        <h3 style="margin: 0; color: #1e293b;">Agenda anual 2026</h3>
                    </div>
                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem; color: #475569;">
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üè• Actuaciones entorno sanitario</li>
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üèòÔ∏è Actuaciones entorno comunitario</li>
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üéì Actuaciones entorno educativo</li>
                        <li style="padding: 0.4rem 0; border-bottom: 1px solid #f1f5f9;">üè¢ Actuaciones entorno laboral</li>
                        <li style="padding: 0.4rem 0;">üìÜ Cronograma por trimestres</li>
                    </ul>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f1f5f9;">
                        <button onclick="irAFase(5)" style="background: #ff6600; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">Ir a Fase 6 ‚Üí</button>
                    </div>
                </div>
            </div>
            
            <!-- Nota sobre el Cuadro de mandos -->
            <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 10px; padding: 1rem 1.25rem; margin-top: 1.5rem;">
                <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
                    <strong>üìä Cuadro de mandos integral (50 indicadores):</strong> El seguimiento y evaluaci√≥n del Plan se realiza en la <strong>Fase 6 - Evaluaci√≥n</strong>.
                </p>
            </div>
            
            <!-- Previsualizaci√≥n -->
            <div id="pls-preview-container" style="display: none; margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                    <h3 style="margin: 0; color: #1e293b;">üìã Previsualizaci√≥n del documento</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="maximizarPreviewPLS()" style="background: #0074c8; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.3rem;">üîç Ampliar</button>
                        <button onclick="abrirPreviewVentana()" style="background: #94d40b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.3rem;">‚ÜóÔ∏è Nueva ventana</button>
                        <button onclick="cerrarPreviewPLS()" style="background: #dc143c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï Cerrar</button>
                    </div>
                </div>
                <div id="pls-preview-content" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-height: 70vh; overflow-y: auto; overflow-x: hidden;"></div>
            </div>
        </div>
    </div>
    <div class="fase-contenido" id="fase-5-contenido">
        <!-- Mensaje de requisito de Plan de acci√≥n -->
        <div id="fase-5-bloqueada" style="display: none; background: linear-gradient(135deg, #fff9e6 0%, #ffd966 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
            <h3 style="color: #ff6600; margin: 0 0 1rem 0;">Fase Bloqueada - Se Requiere Plan de acci√≥n</h3>
            <p style="color: #ffb61b; margin: 0 0 1.5rem 0; font-size: 1.05rem; line-height: 1.6;">
                Para acceder a la <strong>Agenda anual</strong> y seleccionar <strong>Programas y Actuaciones Tipo</strong>, 
                primero debe completar la <strong>Fase 3 - Plan de acci√≥n</strong>.<br><br>
                No tiene sentido planificar actuaciones concretas sin haber definido previamente:
            </p>
            <div style="background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                <div style="display: flex; align-items: start; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <span style="font-size: 1.5rem;">üìã</span>
                    <div>
                        <strong style="color: #1e293b;">L√≠neas estrat√©gicas</strong><br>
                        <span style="color: #64748b; font-size: 0.9rem;">√Åreas prioritarias de actuaci√≥n</span>
                    </div>
                </div>
                <div style="display: flex; align-items: start; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <span style="font-size: 1.5rem;">üéØ</span>
                    <div>
                        <strong style="color: #1e293b;">Objetivos Espec√≠ficos</strong><br>
                        <span style="color: #64748b; font-size: 0.9rem;">Metas concretas a alcanzar</span>
                    </div>
                </div>
                <div style="display: flex; align-items: start; gap: 0.75rem;">
                    <span style="font-size: 1.5rem;">üìä</span>
                    <div>
                        <strong style="color: #1e293b;">Indicadores de Contexto e Impacto</strong><br>
                        <span style="color: #64748b; font-size: 0.9rem;">Medici√≥n de resultados</span>
                    </div>
                </div>
            </div>
            <button onclick="document.querySelector('[data-fase=\\'3\\']').click()" style="background: #f59e0b; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.05rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                ‚û°Ô∏è Ir a Fase 3 - Plan de acci√≥n
            </button>
        </div>
        
        <div id="fase-5-contenido-activo">
        <!-- Selector de tipo de agenda -->
        <div class="agendas-tipo-selector" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
            <button class="btn-agenda-tipo activo" onclick="cambiarTipoAgenda('tipo')" id="btn-agenda-tipo">
                üìã Agenda anual Tipo
            </button>
            <button class="btn-agenda-tipo" onclick="cambiarTipoAgenda('municipio')" id="btn-agenda-municipio">
                üèòÔ∏è Agendas Anuales <span class="nombre-municipio-dinamico">del Territorio</span>
            </button>
        </div>
        
        <!-- AGENDA ANUAL TIPO -->
        <div id="agenda-tipo-contenido">
            <div class="agendas-header" style="background: linear-gradient(135deg, #0074c815 0%, #00acd915 100%); border: 2px solid #0074c8;">
                <div class="agendas-header-top">
                    <div>
                        <h2 style="color: #1e293b;">üìã Agenda anual Tipo</h2>
                        <p style="color: #475569;">Cat√°logo de actuaciones-tipo de la EPVSA que pueden ser incorporadas a cualquier Plan local de salud.</p>
                    </div>
                </div>
                <div class="agendas-filtros">
                    <div class="filtro-entorno">
                        <label style="color: #475569;">√Åmbito:</label>
                        <select id="filtro-ambito-tipo" onchange="filtrarAgendaTipo()">
                            <option value="todos">Todos los √°mbitos</option>
                            <option value="Comunitario">üèòÔ∏è Comunitario</option>
                            <option value="Sanitario">üè• Sanitario</option>
                            <option value="Educativo">üéì Educativo</option>
                            <option value="Servicios sociales">üë• Servicios sociales</option>
                            <option value="Laboral">üè¢ Laboral</option>
                            <option value="Empresarial">üè≠ Empresarial</option>
                            <option value="Informaci√≥n y comunicaci√≥n">üì¢ Informaci√≥n y comunicaci√≥n</option>
                            <option value="Formaci√≥n e investigaci√≥n">üî¨ Formaci√≥n e investigaci√≥n</option>
                        </select>
                    </div>
                    <div class="filtro-programa">
                        <label style="color: #475569;">Programa:</label>
                        <select id="filtro-programa-tipo" onchange="filtrarAgendaTipo()">
                            <option value="todos">Todos los programas</option>
                        </select>
                    </div>
                    <div class="filtro-linea">
                        <label style="color: #475569;">L√≠nea estrat√©gica:</label>
                        <select id="filtro-linea-tipo" onchange="filtrarAgendaTipo()">
                            <option value="todos">Todas</option>
                            <option value="LE1">LE1 - Promoci√≥n h√°bitos saludables</option>
                            <option value="LE2">LE2 - Responsabilidad social empresarial</option>
                            <option value="LE3">LE3 - Informaci√≥n y comunicaci√≥n</option>
                            <option value="LE4">LE4 - Formaci√≥n e investigaci√≥n</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Explicaci√≥n de la Agenda tipo -->
            <div class="agenda-tipo-info" style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                <h4 style="color: #1e40af; margin: 0 0 0.5rem 0;">üìö Cat√°logo de Actuaciones-Tipo EPVSA</h4>
                <p style="color: #1e40af; margin: 0; font-size: 0.9rem; line-height: 1.6;">
                    Este cat√°logo recoge todas las <strong>actuaciones-tipo</strong> definidas en la EPVSA 2024-2030, organizadas por l√≠neas estrat√©gicas, programas y √°mbitos de intervenci√≥n.<br><br>
                    <strong>üí° ¬øC√≥mo usarlo?</strong> Navegue por las actuaciones-tipo y pulse <strong>"‚ûï A√±adir a agenda"</strong> en aquellas que desee implementar en su municipio. 
                    Se abrir√° el formulario con la vinculaci√≥n EPVSA ya pre-rellenada, y solo tendr√° que completar los datos espec√≠ficos de su acci√≥n local (referente, fechas, descripci√≥n concreta, etc.).
                </p>
            </div>
            
            <!-- Listado de actuaciones tipo por programa -->
            <div id="agenda-tipo-listado" class="agenda-tipo-listado"></div>
        </div>
        
        <!-- AGENDAS ANUALES MUNICIPIO -->
        <div id="agenda-municipio-contenido" style="display: none;">
            <div class="agendas-header">
                <div class="agendas-header-top">
                    <div>
                        <h2>üìÖ Agenda anual <span class="nombre-municipio-dinamico">del Territorio</span> 2026</h2>
                        <p>Acciones concretas de salud planificadas para su municipio. Cada acci√≥n se vincula a la estructura de la EPVSA.</p>
                    </div>
                    <div class="agendas-header-actions">
                        <button class="btn-nueva-accion" onclick="mostrarModalNuevaAccion()">‚ûï Nueva acci√≥n</button>
                        <button class="btn-exportar-agendas" onclick="exportarAgendas()">üì• Exportar</button>
                    </div>
                </div>
                <div class="agendas-filtros">
                    <div class="filtro-anio">
                        <label>A√±o:</label>
                        <select id="filtro-anio" onchange="filtrarAgendas()">
                            <option value="2026" selected>2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                            <option value="todos">Todos (2026-2030)</option>
                        </select>
                    </div>
                    <div class="filtro-entorno">
                        <label>Entorno:</label>
                        <select id="filtro-entorno" onchange="filtrarAgendas()">
                            <option value="todos">Todos</option>
                            <option value="sanitario">üè• Sanitario</option>
                            <option value="comunitario">üèòÔ∏è Comunitario</option>
                            <option value="educativo">üéì Educativo</option>
                            <option value="laboral">üè¢ Laboral</option>
                        </select>
                    </div>
                    <div class="agendas-stats">
                        <span class="stat-badge" id="stat-total-acciones">0 acciones</span>
                    </div>
                </div>
            </div>

            <!-- Vista por Entornos (Kanban) -->
            <div class="agendas-kanban" id="agendas-kanban">
                <div class="kanban-columna" data-entorno="sanitario">
                    <div class="kanban-header sanitario">
                        <span class="kanban-icon">üè•</span>
                        <span class="kanban-titulo">entorno sanitario</span>
                        <span class="kanban-count" id="count-sanitario">0</span>
                    </div>
                    <div class="kanban-body" id="kanban-sanitario" ondrop="dropAccion(event, 'sanitario')" ondragover="allowDrop(event)"></div>
                </div>
                <div class="kanban-columna" data-entorno="comunitario">
                    <div class="kanban-header comunitario">
                        <span class="kanban-icon">üèòÔ∏è</span>
                        <span class="kanban-titulo">entorno comunitario</span>
                        <span class="kanban-count" id="count-comunitario">0</span>
                    </div>
                    <div class="kanban-body" id="kanban-comunitario" ondrop="dropAccion(event, 'comunitario')" ondragover="allowDrop(event)"></div>
                </div>
                <div class="kanban-columna" data-entorno="educativo">
                    <div class="kanban-header educativo">
                        <span class="kanban-icon">üéì</span>
                        <span class="kanban-titulo">entorno educativo</span>
                        <span class="kanban-count" id="count-educativo">0</span>
                    </div>
                    <div class="kanban-body" id="kanban-educativo" ondrop="dropAccion(event, 'educativo')" ondragover="allowDrop(event)"></div>
                </div>
                <div class="kanban-columna" data-entorno="laboral">
                    <div class="kanban-header laboral">
                        <span class="kanban-icon">üè¢</span>
                        <span class="kanban-titulo">entorno laboral</span>
                        <span class="kanban-count" id="count-laboral">0</span>
                    </div>
                    <div class="kanban-body" id="kanban-laboral" ondrop="dropAccion(event, 'laboral')" ondragover="allowDrop(event)"></div>
                </div>
            </div>
        </div>

        <!-- Modal Nueva/Editar acci√≥n -->
        <div class="modal-overlay" id="modal-accion" style="display:none;">
            <div class="modal-accion">
                <div class="modal-header">
                    <h3 id="modal-titulo">‚ûï Nueva acci√≥n</h3>
                    <button class="modal-cerrar" onclick="cerrarModalAccion()">‚úï</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="accion-id">
                    
                    <div class="form-group">
                        <label>Nombre de la acci√≥n *</label>
                        <input type="text" id="accion-nombre" placeholder="Ej: Taller de alimentaci√≥n saludable">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>C√≥digo EPVSA</label>
                            <input type="text" id="accion-codigo-epvsa" placeholder="Ej: P03-A01">
                        </div>
                        <div class="form-group">
                            <label>Programa EPVSA</label>
                            <input type="text" id="accion-programa" placeholder="Ej: RELAS, Forma Joven...">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Entorno *</label>
                            <select id="accion-entorno">
                                <option value="sanitario">üè• Sanitario</option>
                                <option value="comunitario">üèòÔ∏è Comunitario</option>
                                <option value="educativo">üéì Educativo</option>
                                <option value="laboral">üè¢ Laboral</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>A√±o *</label>
                            <select id="accion-anio">
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Trimestre</label>
                            <select id="accion-trimestre">
                                <option value="T1">T1 (Ene-Mar)</option>
                                <option value="T2">T2 (Abr-Jun)</option>
                                <option value="T3">T3 (Jul-Sep)</option>
                                <option value="T4">T4 (Oct-Dic)</option>
                                <option value="anual">Todo el a√±o</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea id="accion-descripcion" rows="2" placeholder="Descripci√≥n breve de la acci√≥n..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>L√≠nea EPVSA</label>
                            <select id="accion-linea-epvsa">
                                <option value="">Sin vincular</option>
                                <option value="1">L1: Bienestar emocional y salud mental</option>
                                <option value="2">L2: Responsabilidad social empresarial</option>
                                <option value="3">L3: Alimentaci√≥n saludable</option>
                                <option value="4">L4: Actividad f√≠sica</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Objetivo EPVSA</label>
                            <input type="text" id="accion-objetivo-epvsa" placeholder="Ej: OE 1.1 - Incrementar...">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Poblaci√≥n diana</label>
                            <input type="text" id="accion-poblacion" placeholder="Ej: Adultos mayores, escolares...">
                        </div>
                        <div class="form-group">
                            <label>Etapa de vida</label>
                            <input type="text" id="accion-etapa-vida" placeholder="Ej: Infancia, Adultos, Mayores...">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Responsable</label>
                            <input type="text" id="accion-responsable" placeholder="Persona o rol responsable">
                        </div>
                        <div class="form-group">
                            <label>Organizaci√≥n</label>
                            <input type="text" id="accion-organizacion" placeholder="Ej: Centro de Salud, Ayuntamiento...">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Profesionales implicados</label>
                        <input type="text" id="accion-profesionales" placeholder="Ej: Enfermeras, M√©dicos, T√©cnicos...">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Indicador de seguimiento</label>
                            <input type="text" id="accion-indicador" placeholder="Ej: N¬∫ de participantes...">
                        </div>
                        <div class="form-group">
                            <label>Meta</label>
                            <input type="text" id="accion-meta" placeholder="Ej: ‚â•100 participantes">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Frecuencia</label>
                            <input type="text" id="accion-frecuencia" placeholder="Ej: Semanal, Mensual...">
                        </div>
                        <div class="form-group">
                            <label>Prioridad</label>
                            <select id="accion-prioridad">
                                <option value="alta">üî¥ Alta</option>
                                <option value="media" selected>üü° Media</option>
                                <option value="baja">üü¢ Baja</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Recursos necesarios</label>
                        <input type="text" id="accion-recursos" placeholder="Ej: Material, sala, profesionales...">
                    </div>
                    
                    <div class="form-group">
                        <label>Base de evidencia</label>
                        <input type="text" id="accion-evidencia" placeholder="Ej: OMS, PAPPS, Gu√≠as cl√≠nicas...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancelar" onclick="cerrarModalAccion()">Cancelar</button>
                    <button class="btn-guardar" onclick="guardarAccion()">üíæ Guardar acci√≥n</button>
                </div>
            </div>
        </div>

        <!-- Vista Timeline por A√±o -->
        <div class="agendas-timeline" id="agendas-timeline" style="margin-top: 2rem;">
            <h3>üìä Vista cronol√≥gica</h3>
            <div class="timeline-container" id="timeline-container"></div>
        </div>
        </div><!-- Fin fase-5-contenido-activo -->
    </div>
    <div class="fase-contenido" id="fase-6-contenido">
        <div style="margin-bottom: 2rem;">
            <h2 style="color: #0074c8; margin-bottom: 0.5rem;">üìà Evaluaci√≥n del Plan local de salud</h2>
            <p style="color: #666;">Seguimiento y evaluaci√≥n del Plan mediante el Cuadro de mandos integral.</p>
        </div>
        
        <div style="max-width: 1000px; margin: 0 auto;">
            <!-- Placeholder para futura implementaci√≥n -->
            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px dashed #0074c8; border-radius: 12px; padding: 3rem; text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üöß</div>
                <h3 style="color: #0074c8; margin-bottom: 1rem;">M√≥dulo en desarrollo</h3>
                <p style="color: #64748b; max-width: 500px; margin: 0 auto; line-height: 1.6;">
                    Esta secci√≥n albergar√° el <strong>Cuadro de mandos integral</strong> con los 50 indicadores para el seguimiento y evaluaci√≥n del Plan local de salud.
                </p>
                <div style="margin-top: 2rem; padding: 1rem; background: white; border-radius: 8px; display: inline-block;">
                    <p style="margin: 0; color: #94a3b8; font-size: 0.9rem;">
                        <strong>Incluir√°:</strong> Evaluaci√≥n de proceso ¬∑ Evaluaci√≥n de resultados ¬∑ An√°lisis de tendencias
                    </p>
                </div>
            </div>
        </div>
    </div>

</main>

<!-- Modal Metodolog√≠a COMP√ÅS -->
<div id="modal-metodologia" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:10000; overflow-y:auto; padding:2rem;">
    <div style="background:white; max-width:800px; margin:0 auto; border-radius:16px; overflow:hidden; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);">
        <div style="background:linear-gradient(135deg, #0074c8 0%, #00acd9 100%); color:white; padding:1.5rem 2rem; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:1.5rem;">üìê COMP√ÅS: metodolog√≠a de acompa√±amiento municipal</h2>
            <button onclick="cerrarMetodologia()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:1.2rem;">‚úï</button>
        </div>
        <div style="padding:2rem; line-height:1.7; color:#334155;">

            <!-- POR QU√â EXISTE -->
            <h3 style="color:#0074c8; margin-top:0;">¬øPara qu√© sirve COMP√ÅS?</h3>
            <p>Los ayuntamientos tienen competencias en salud p√∫blica, pero pocas herramientas para ejercerlas. Los datos existen ‚Äî encuestas de salud, informes epidemiol√≥gicos, indicadores validados ‚Äî pero est√°n dispersos, son dif√≠ciles de interpretar y a√∫n m√°s dif√≠ciles de convertir en decisiones y documentos concretos.</p>
            <p><strong>COMP√ÅS resuelve eso.</strong> Es una plataforma web que gu√≠a al equipo municipal paso a paso: desde el primer an√°lisis de la situaci√≥n de salud hasta la redacci√≥n del Plan Local de Salud, pasando por la participaci√≥n ciudadana y la evaluaci√≥n anual. Todo en un solo lugar, sin necesidad de conocimientos t√©cnicos avanzados.</p>

            <!-- MARCO DE REFERENCIA ANDALUZ -->
            <h3 style="color:#0074c8;">Marco normativo y estrat√©gico andaluz</h3>
            <p>COMP√ÅS est√° dise√±ado √≠ntegramente para el √°mbito andaluz y se fundamenta en cuatro pilares normativos y estrat√©gicos:</p>
            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:1rem; margin:1rem 0 1.5rem;">

                <div style="background:#f0f9ff; padding:1.1rem; border-radius:10px; border-left:4px solid #0074c8;">
                    <div style="font-weight:700; color:#0074c8; margin-bottom:0.25rem;">‚öñÔ∏è LAULA ¬∑ Ley 5/2010, de 11 de junio</div>
                    <div style="font-size:0.78rem; color:#94a3b8; margin-bottom:0.4rem;">Ley de Autonom√≠a Local de Andaluc√≠a</div>
                    <div style="font-size:0.82rem; color:#334155; line-height:1.5;">
                        <strong>Art. 9.13</strong> ‚Äî Establece como competencia propia de los municipios andaluces la <em>¬´promoci√≥n, defensa y protecci√≥n de la salud p√∫blica¬ª</em>, que comprende:
                        <ul style="margin:.4rem 0 0 1rem; padding:0; font-size:0.81rem; color:#475569;">
                            <li><em>¬´La elaboraci√≥n, aprobaci√≥n, implantaci√≥n y ejecuci√≥n del Plan Local de Salud¬ª</em></li>
                            <li><em>¬´El desarrollo de pol√≠ticas de acci√≥n local y comunitaria en materia de salud¬ª</em></li>
                            <li><em>¬´El desarrollo de programas de promoci√≥n de la salud, educaci√≥n para la salud y protecci√≥n de la salud¬ª</em></li>
                        </ul>
                    </div>
                </div>

                <div style="background:#f0fdf4; padding:1.1rem; border-radius:10px; border-left:4px solid #10b981;">
                    <div style="font-weight:700; color:#065f46; margin-bottom:0.25rem;">‚öïÔ∏è Ley 16/2011, de 23 de diciembre</div>
                    <div style="font-size:0.78rem; color:#94a3b8; margin-bottom:0.4rem;">Ley de Salud P√∫blica de Andaluc√≠a</div>
                    <div style="font-size:0.82rem; color:#334155; line-height:1.5;">
                        <strong>Art. 41 ‚Äî El Plan Local de Salud</strong>: es <em>¬´el instrumento b√°sico que recoge la planificaci√≥n, ordenaci√≥n y coordinaci√≥n de las actuaciones que se realicen en materia de salud p√∫blica en el √°mbito de un municipio o de una mancomunidad de municipios¬ª</em>.<br>
                        <strong style="margin-top:.4rem;display:inline-block;">Art. 40 ‚Äî Autonom√≠a local en salud p√∫blica</strong>: los municipios asumen <em>¬´la responsabilidad del ejercicio de la coordinaci√≥n de las intervenciones en materia de promoci√≥n de la salud comunitaria en su territorio, incorporando y articulando la acci√≥n de los diferentes sectores p√∫blicos y privados¬ª</em>, con participaci√≥n ciudadana.
                    </div>
                </div>

                <div style="background:#f0f9ff; padding:1.1rem; border-radius:10px; border-left:4px solid #0074c8;">
                    <div style="font-weight:700; color:#0074c8; margin-bottom:0.25rem;">üá™üá∏ EPVSA 2024‚Äì2030</div>
                    <div style="font-size:0.78rem; color:#94a3b8; margin-bottom:0.5rem;">Estrategia de Promoci√≥n de una Vida Saludable en Andaluc√≠a</div>
                    <div style="font-size:0.82rem; color:#334155;">Marco estrat√©gico del SAS estructurado en 4 l√≠neas estrat√©gicas, 10 objetivos espec√≠ficos y 15 programas. Eje vertebrador del plan de acci√≥n municipal en COMP√ÅS.</div>
                </div>

                <div style="background:#fef9ee; padding:1.1rem; border-radius:10px; border-left:4px solid #ffb61b;">
                    <div style="font-weight:700; color:#b45309; margin-bottom:0.25rem;">üî¨ Proyecto RELAS</div>
                    <div style="font-size:0.78rem; color:#94a3b8; margin-bottom:0.5rem;">Red de Acci√≥n Local en Salud ¬∑ Distrito Granada-Metropolitano</div>
                    <div style="font-size:0.82rem; color:#334155;">Metodolog√≠a de diagn√≥stico comunitario participativo mediante cuestionario validado (REDCap). Analiza h√°bitos de vida, problemas de salud y colectivos prioritarios para orientar la planificaci√≥n local.</div>
                </div>

            </div>

            <!-- LAS 7 FASES -->
            <h3 style="color:#0074c8;">Un proceso en 6 fases</h3>
            <p>COMP√ÅS organiza el trabajo en un ciclo anual estructurado. Cada fase tiene sus herramientas, sus documentos y su momento:</p>
            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:0.6rem; margin:0.75rem 0 1.5rem;">
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:0.75rem; font-size:0.85rem;">
                    <div style="font-weight:700; color:#0074c8; margin-bottom:0.2rem;">‚ë† Fase inicial</div>
                    <div style="color:#64748b;">Constituci√≥n del Grupo Motor, informe de situaci√≥n de salud y hoja de ruta del proceso.</div>
                </div>
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:0.75rem; font-size:0.85rem;">
                    <div style="font-weight:700; color:#0074c8; margin-bottom:0.2rem;">‚ë° Perfil de salud</div>
                    <div style="color:#64748b;">An√°lisis epidemiol√≥gico, determinantes sociales, 50 indicadores y generaci√≥n autom√°tica de conclusiones.</div>
                </div>
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:0.75rem; font-size:0.85rem;">
                    <div style="font-weight:700; color:#0074c8; margin-bottom:0.2rem;">‚ë¢ Plan de acci√≥n</div>
                    <div style="color:#64748b;">Priorizaci√≥n de l√≠neas estrat√©gicas, votaci√≥n ciudadana, an√°lisis RELAS y generaci√≥n del plan.</div>
                </div>
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:0.75rem; font-size:0.85rem;">
                    <div style="font-weight:700; color:#0074c8; margin-bottom:0.2rem;">‚ë£ Plan local de salud</div>
                    <div style="color:#64748b;">Compilaci√≥n del documento integrador: perfil + plan de acci√≥n + agenda anual.</div>
                </div>
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:0.75rem; font-size:0.85rem;">
                    <div style="font-weight:700; color:#0074c8; margin-bottom:0.2rem;">‚ë§ Implantaci√≥n</div>
                    <div style="color:#64748b;">Agenda anual de actuaciones organizada por l√≠neas estrat√©gicas y programas, con cronograma y responsables.</div>
                </div>
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:0.75rem; font-size:0.85rem;">
                    <div style="font-weight:700; color:#0074c8; margin-bottom:0.2rem;">‚ë• Evaluaci√≥n</div>
                    <div style="color:#64748b;">Cuadro de mandos con 50 indicadores de seguimiento, evoluci√≥n por municipio y rendici√≥n de cuentas.</div>
                </div>
            </div>

            <!-- HERRAMIENTAS CLAVE -->
            <h3 style="color:#0074c8;">Herramientas principales</h3>
            <div style="display:flex; flex-direction:column; gap:0.75rem; margin-bottom:1.5rem;">
                <div style="display:flex; gap:1rem; align-items:flex-start; padding:0.85rem 1rem; background:#f0f9ff; border-radius:8px; border-left:3px solid #0074c8;">
                    <span style="font-size:1.4rem; flex-shrink:0;">üó≥Ô∏è</span>
                    <div>
                        <div style="font-weight:700; color:#1e293b; font-size:0.9rem;">Votaci√≥n popular en tiempo real</div>
                        <div style="font-size:0.83rem; color:#64748b;">Genera un QR que los ciudadanos escanean con el m√≥vil para votar sus prioridades de salud. Los resultados aparecen en pantalla en directo, pensados para proyectarse en eventos p√∫blicos.</div>
                    </div>
                </div>
                <div style="display:flex; gap:1rem; align-items:flex-start; padding:0.85rem 1rem; background:#f0fdf4; border-radius:8px; border-left:3px solid #94d40b;">
                    <span style="font-size:1.4rem; flex-shrink:0;">üß™</span>
                    <div>
                        <div style="font-weight:700; color:#1e293b; font-size:0.9rem;">Analizador RELAS</div>
                        <div style="font-size:0.83rem; color:#64748b;">Carga el CSV del cuestionario de priorizaci√≥n ciudadana (REDCap) y obtiene an√°lisis de frecuencias, rankings, correlaciones y recomendaciones de intervenci√≥n. Incluye simulador de escenarios y pantalla de presentaci√≥n de resultados para eventos.</div>
                    </div>
                </div>
                <div style="display:flex; gap:1rem; align-items:flex-start; padding:0.85rem 1rem; background:#fff7ed; border-radius:8px; border-left:3px solid #ffb61b;">
                    <span style="font-size:1.4rem; flex-shrink:0;">‚ö°</span>
                    <div>
                        <div style="font-weight:700; color:#1e293b; font-size:0.9rem;">Fusi√≥n triple de priorizaci√≥n</div>
                        <div style="font-size:0.83rem; color:#64748b;">Combina tres fuentes ‚Äî datos epidemiol√≥gicos (55%), voto ciudadano (30%) y an√°lisis RELAS (15%) ‚Äî en un √∫nico ranking ponderado. El resultado se guarda como decisi√≥n oficial del municipio.</div>
                    </div>
                </div>
                <div style="display:flex; gap:1rem; align-items:flex-start; padding:0.85rem 1rem; background:#f8fafc; border-radius:8px; border-left:3px solid #6366f1;">
                    <span style="font-size:1.4rem; flex-shrink:0;">üìÑ</span>
                    <div>
                        <div style="font-weight:700; color:#1e293b; font-size:0.9rem;">Generaci√≥n autom√°tica de documentos</div>
                        <div style="font-size:0.83rem; color:#64748b;">Convocatorias, actas, registro del Grupo Motor, hoja de ruta, perfil de salud, plan de acci√≥n, plan local y agenda anual. En Word, PDF o HTML, con los datos del municipio ya incorporados.</div>
                    </div>
                </div>
                <div style="display:flex; gap:1rem; align-items:flex-start; padding:0.85rem 1rem; background:#faf5ff; border-radius:8px; border-left:3px solid #8b5cf6;">
                    <span style="font-size:1.4rem; flex-shrink:0;">üìà</span>
                    <div>
                        <div style="font-weight:700; color:#1e293b; font-size:0.9rem;">Sistema de indicadores (50)</div>
                        <div style="font-size:0.83rem; color:#64748b;">Cuadro de mandos integral con 50 indicadores de salud organizados por dimensi√≥n. Permite seguimiento anual, comparaci√≥n con referencias de Andaluc√≠a y visualizaci√≥n del avance del plan.</div>
                    </div>
                </div>
            </div>

            <!-- MARCO Y FILOSOF√çA -->
            <h3 style="color:#0074c8;">Marco de referencia</h3>
            <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem; margin:0.75rem 0 1.5rem;">
                <div style="background:#f0f9ff; padding:1rem; border-radius:8px; border-left:4px solid #0074c8;">
                    <strong style="color:#0074c8;">RELAS</strong><br>
                    <span style="font-size:0.85rem; color:#64748b;">Red Local de Acci√≥n en Salud. La estructura organizativa del proceso: qui√©n participa, c√≥mo se toman las decisiones y qu√© √≥rganos existen en el municipio.</span>
                </div>
                <div style="background:#f0fdf4; padding:1rem; border-radius:8px; border-left:4px solid #94d40b;">
                    <strong style="color:#5a8500;">EPVSA 2024‚Äì2030</strong><br>
                    <span style="font-size:0.85rem; color:#64748b;">El marco estrat√©gico auton√≥mico que da coherencia y legitimidad al plan local. COMP√ÅS traduce sus l√≠neas y objetivos en acciones concretas para cada municipio.</span>
                </div>
                <div style="background:#fef9ee; padding:1rem; border-radius:8px; border-left:4px solid #ffb61b;">
                    <strong style="color:#b45309;">Firebase</strong><br>
                    <span style="font-size:0.85rem; color:#64748b;">Todos los datos se guardan en la nube en tiempo real. Varios t√©cnicos pueden trabajar sobre el mismo municipio desde distintos dispositivos sin riesgo de p√©rdida.</span>
                </div>
            </div>

            <div style="background:linear-gradient(135deg,#f0f9ff,#f0fdf4); border-radius:10px; padding:1.1rem 1.25rem; border:1px solid #e2e8f0; margin-bottom:1rem;">
                <p style="margin:0; font-size:0.9rem; color:#334155;">El nombre no es casual. <strong>COMP√ÅS</strong> evoca el instrumento que traza c√≠rculos perfectos manteniendo un punto fijo ‚Äî el municipio como centro ‚Äî, el ritmo musical que permite que distintos instrumentos toquen juntos, y el acompa√±amiento: estar al lado, no por encima. <strong style="color:#0074c8;">aCOMP√ÅSado</strong> a la estrategia de salud significa sincronizado con ella, no sometido a ella. Cada municipio tiene su tempo, sus prioridades, su contexto.</p>
            </div>

            <p id="footer-version" style="text-align:center; margin-top:1.5rem; padding-top:1rem; border-top:1px solid #e2e8f0; color:#94a3b8; font-size:0.85rem;">
                <!-- Se actualiza din√°micamente con COMPAS_VERSION -->
            </p>
        </div>
    </div>
</div>

<script>
// ==========================================
// COMP√ÅS - CONFIGURACI√ìN DE VERSI√ìN
// ==========================================
const COMPAS_VERSION = {
    numero: '1.0',
    nombre: 'COMP√ÅS',
    get fecha() { const m=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; const d=new Date(); return m[d.getMonth()]+' '+d.getFullYear(); },
    autor: 'B. Hermoso',
    organizacion: 'Servicio Andaluz de Salud / Distrito Sanitario Granada-Metropolitano',
    licencia: 'MIT',
    get completa() { return `${this.nombre} v${this.numero} ‚Äî ${this.fecha}`; },
    get footer() { return `${this.completa}<br>${this.organizacion}`; },
    get copyright() { return `¬© ${new Date().getFullYear()} ${this.autor} ¬∑ Licencia ${this.licencia}`; },
    get docFooter() { return `Documento generado con ${this.nombre} ¬∑ ${this.copyright}`; }
};

// Helper para usar en templates de documentos
function getCompasCopyright() {
    return COMPAS_VERSION.docFooter;
}

// Verificar que Firebase est√° cargado
if (typeof firebase === 'undefined') {
    console.error('‚ùå Firebase no est√° definido. Los scripts CDN no se cargaron.');
    console.error('   Posibles causas:');
    console.error('   1. Sin conexi√≥n a internet');
    console.error('   2. Firewall o proxy bloqueando gstatic.com');
    console.error('   3. Extensi√≥n del navegador bloqueando scripts');
    console.error('   4. Error de red temporal');
    
    // Mostrar error visual
    document.addEventListener('DOMContentLoaded', function() {
        document.body.innerHTML = '<div style="padding:2rem;text-align:center;font-family:sans-serif;max-width:600px;margin:2rem auto;">' +
            '<h1 style="color:#dc3545;">‚ö†Ô∏è Error de conexi√≥n</h1>' +
            '<p style="margin:1rem 0;">No se pudo cargar la librer√≠a de Firebase desde:</p>' +
            '<code style="background:#f8f9fa;padding:0.5rem;display:block;margin:1rem 0;font-size:0.8rem;">https://www.gstatic.com/firebasejs/9.22.0/</code>' +
            '<p><strong>Posibles soluciones:</strong></p>' +
            '<ul style="text-align:left;margin:1rem 2rem;">' +
            '<li>Verifica tu conexi√≥n a internet</li>' +
            '<li>Desactiva temporalmente el bloqueador de anuncios</li>' +
            '<li>Prueba en otro navegador</li>' +
            '<li>Verifica que no haya firewall bloqueando</li>' +
            '</ul>' +
            '<button onclick="location.reload()" style="margin-top:1rem;padding:0.75rem 1.5rem;font-size:1rem;cursor:pointer;background:#0074c8;color:white;border:none;border-radius:8px;">üîÑ Reintentar</button>' +
            '</div>';
    });
    throw new Error('Firebase no est√° disponible - scripts CDN no cargados');
}

// Firebase inicializaci√≥n - COMP√ÅS
var db;
try {
    firebase.initializeApp({
        apiKey: "AIzaSyCdAivJATiX76xuOJAMc4Yt7sLq-3GDuDw",
        authDomain: "itaca-3ba7b.firebaseapp.com",
        databaseURL: "https://itaca-3ba7b-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "itaca-3ba7b",
        storageBucket: "itaca-3ba7b.firebasestorage.app",
        messagingSenderId: "891982060410",
        appId: "1:891982060410:web:cd954a8602eb89ebccd4c3"
    });
    db = firebase.database();
    console.log('‚úÖ Firebase COMP√ÅS inicializado correctamente');
} catch (e) {
    console.error('‚ùå Error inicializando Firebase:', e);
    throw e;
}

// Variable global para almacenar datos cargados del municipio
var datosMunicipioActual = null;

// ==========================================
// OBJETO GLOBAL PARA EL COMPILADOR DE PLAN LOCAL DE SALUD
// ==========================================
// Este objeto almacena los contenidos generados en cada fase
// para que el compilador de la Fase 4 pueda integrarlos
var planLocalSalud = {
    municipio: null,
    perfil: {
        completado: false,
        html: null,
        fecha: null
    },
    planAccion: {
        completado: false,
        html: null,
        seleccion: null,  // La selecci√≥n de l√≠neas/objetivos/programas
        fecha: null
    },
    agenda: {
        completado: false,
        actuaciones: [],
        a√±o: 2026,
        fecha: null
    },
    cuadroMandos: {
        completado: false,
        html: null,
        fecha: null
    }
};

// ==========================================
// COMPAS EU - SISTEMA DE CONFIGURACI√ìN DE ESTRATEGIAS DE SALUD
// ==========================================
// Este sistema permite que COMPAS se adapte a diferentes estrategias
// de salud europeas, cada una con su propia estructura y terminolog√≠a

// Variable para la estrategia actualmente seleccionada
var estrategiaActual = 'es-andalucia-epvsa';

// Configuraci√≥n de estrategias disponibles
const ESTRATEGIAS_SALUD = {
    'es-andalucia-epvsa': {
        id: 'es-andalucia-epvsa',
        nombre: 'EPVSA',
        nombreCompleto: 'Estrategia de Promoci√≥n de una Vida Saludable en Andaluc√≠a',
        pais: 'Espa√±a',
        region: 'Andaluc√≠a',
        idioma: 'es',
        a√±o: 2020,
        niveles: [
            { id: 'linea', nombre: 'L√≠nea Estrat√©gica', nombrePlural: 'L√≠neas Estrat√©gicas', codigo: 'LE', color: true },
            { id: 'objetivo', nombre: 'Objetivo Espec√≠fico', nombrePlural: 'Objetivos Espec√≠ficos', codigo: 'OE', parent: 'linea' },
            { id: 'indicador', nombre: 'Indicador', nombrePlural: 'Indicadores', parent: 'objetivo' },
            { id: 'programa', nombre: 'Programa', nombrePlural: 'Programas', codigo: 'P', parent: 'linea' },
            { id: 'actuacion', nombre: 'Actuaci√≥n', nombrePlural: 'Actuaciones', parent: 'programa' }
        ],
        // datos: ESTRUCTURA_EPVSA se asigna m√°s adelante cuando est√© definida
        datosRef: 'ESTRUCTURA_EPVSA'
    },
};

// ==========================================
// TERRITORIOS POR PA√çS/ESTRATEGIA
// ==========================================
const TERRITORIOS = {
    'es-andalucia-epvsa': {
        label: 'üìç Seleccione su distrito sanitario, municipio o mancomunidad:',
        placeholder: '-- Seleccionar --',
        items: [
            { value: 'agron', nombre: 'Agr√≥n' },
            { value: 'albolote', nombre: 'Albolote' },
            { value: 'albunuelas', nombre: 'Albu√±uelas' },
            { value: 'alfacar', nombre: 'Alfacar' },
            { value: 'algarinejo', nombre: 'Algarinejo' },
            { value: 'alhama-de-granada', nombre: 'Alhama de Granada' },
            { value: 'alhendin', nombre: 'Alhend√≠n' },
            { value: 'arenas-del-rey', nombre: 'Arenas del Rey' },
            { value: 'armilla', nombre: 'Armilla' },
            { value: 'atarfe', nombre: 'Atarfe' },
            { value: 'benalua-de-las-villas', nombre: 'Benal√∫a de las Villas' },
            { value: 'cacin', nombre: 'Cac√≠n' },
            { value: 'cajar', nombre: 'C√°jar' },
            { value: 'calicasas', nombre: 'Calicasas' },
            { value: 'campotejar', nombre: 'Campot√©jar' },
            { value: 'cenes-de-la-vega', nombre: 'Cenes de la Vega' },
            { value: 'chauchina', nombre: 'Chauchina' },
            { value: 'chimeneas', nombre: 'Chimeneas' },
            { value: 'churriana-de-la-vega', nombre: 'Churriana de la Vega' },
            { value: 'cijuela', nombre: 'Cijuela' },
            { value: 'cogollos-vega', nombre: 'Cogollos Vega' },
            { value: 'colomera', nombre: 'Colomera' },
            { value: 'cullar-vega', nombre: 'C√∫llar-Vega' },
            { value: 'deifontes', nombre: 'Deifontes' },
            { value: 'dilar', nombre: 'D√≠lar' },
            { value: 'dudar', nombre: 'D√∫dar' },
            { value: 'durcal', nombre: 'D√∫rcal' },
            { value: 'el-pinar', nombre: 'El Pinar' },
            { value: 'el-valle', nombre: 'El Valle' },
            { value: 'escuzar', nombre: 'Esc√∫zar' },
            { value: 'fuente-vaqueros', nombre: 'Fuente Vaqueros' },
            { value: 'gobernador', nombre: 'Gobernador' },
            { value: 'gojar', nombre: 'G√≥jar' },
            { value: 'granada-albaicin', nombre: 'Granada - Albaic√≠n' },
            { value: 'granada-beiro', nombre: 'Granada - Beiro' },
            { value: 'granada-centro', nombre: 'Granada - Centro' },
            { value: 'granada-chana', nombre: 'Granada - Chana' },
            { value: 'granada-genil', nombre: 'Granada - Genil' },
            { value: 'granada-norte', nombre: 'Granada - Norte' },
            { value: 'granada-ronda', nombre: 'Granada - Ronda' },
            { value: 'granada-zaidin', nombre: 'Granada - Zaid√≠n' },
            { value: 'guadahortuna', nombre: 'Guadahortuna' },
            { value: 'guejar-sierra', nombre: 'G√ºejar Sierra' },
            { value: 'guevejar', nombre: 'G√ºev√©jar' },
            { value: 'huetor-tajar', nombre: 'Hu√©tor-T√°jar' },
            { value: 'huetor-vega', nombre: 'Hu√©tor-Vega' },
            { value: 'illora', nombre: '√çllora' },
            { value: 'iznalloz', nombre: 'Iznalloz' },
            { value: 'jayena', nombre: 'Jayena' },
            { value: 'la-malaha', nombre: 'La Malah√°' },
            { value: 'la-zubia', nombre: 'La Zubia' },
            { value: 'lachar', nombre: 'L√°char' },
            { value: 'las-gabias', nombre: 'Las Gabias' },
            { value: 'lecrin', nombre: 'Lecr√≠n' },
            { value: 'loja', nombre: 'Loja' },
            { value: 'mancomunidad-alhama', nombre: 'Mancomunidad de Alhama de Granada' },
            { value: 'mancomunidad-lecrin', nombre: 'Mancomunidad del Valle de Lecr√≠n' },
            { value: 'maracena', nombre: 'Maracena' },
            { value: 'moclin', nombre: 'Mocl√≠n' },
            { value: 'monachil', nombre: 'Monachil' },
            { value: 'montefrio', nombre: 'Montefr√≠o' },
            { value: 'montejicar', nombre: 'Montej√≠car' },
            { value: 'montillana', nombre: 'Montillana' },
            { value: 'moraleda-de-zafayona', nombre: 'Moraleda de Zafayona' },
            { value: 'niguelas', nombre: 'Nig√ºelas' },
            { value: 'nivar', nombre: 'N√≠var' },
            { value: 'ogijares', nombre: 'Og√≠jares' },
            { value: 'otura', nombre: 'Otura' },
            { value: 'padul', nombre: 'Padul' },
            { value: 'peligros', nombre: 'Peligros' },
            { value: 'pinar', nombre: 'P√≠√±ar' },
            { value: 'pinos-genil', nombre: 'Pinos-Genil' },
            { value: 'pinos-puente', nombre: 'Pinos-Puente' },
            { value: 'pulianas', nombre: 'Pulianas' },
            { value: 'quentar', nombre: 'Qu√©ntar' },
            { value: 'salar', nombre: 'Salar' },
            { value: 'santa-cruz-del-comercio', nombre: 'Santa Cruz del Comercio' },
            { value: 'santa-fe', nombre: 'Santa Fe' },
            { value: 'torre-cardela', nombre: 'Torre-Cardela' },
            { value: 'vegas-del-genil', nombre: 'Vegas del Genil' },
            { value: 'ventas-de-huelma', nombre: 'Ventas de Huelma' },
            { value: 'villamena', nombre: 'Villamena' },
            { value: 'villanueva-mesia', nombre: 'Villanueva Mes√≠a' },
            { value: 'viznar', nombre: 'V√≠znar' },
            { value: 'zafarraya', nombre: 'Zafarraya' },
            { value: 'zagra', nombre: 'Zagra' }
        ]
    }
};

/**
 * Puebla Firebase con los municipios de TERRITORIOS (ejecutar una sola vez)
 * Llama a: poblarFirebaseConTerritorios() desde la consola del navegador
 */
function poblarFirebaseConTerritorios() {
    if (!confirm('¬øPoblar Firebase con los municipios de TERRITORIOS? Esto solo debe hacerse una vez.')) {
        return;
    }
    
    const updates = {};
    
    Object.entries(TERRITORIOS).forEach(([estrategiaId, config]) => {
        config.items.forEach(item => {
            updates[`estrategias/${estrategiaId}/municipios/${item.value}/nombre`] = item.nombre;
        });
    });
    
    console.log('üì¶ Poblando Firebase con:', Object.keys(updates).length, 'entradas');
    
    db.ref().update(updates)
        .then(() => {
            console.log('‚úÖ Firebase poblado correctamente');
            mostrarToast('Firebase poblado con ' + Object.keys(updates).length + ' municipios', 'success');
            // Recargar selector
            cargarMunicipiosDisponibles();
        })
        .catch(err => {
            console.error('‚ùå Error poblando Firebase:', err);
            mostrarToast('Error poblando Firebase', 'error');
        });
}

/**
 * Recarga el selector de municipios/territorios seg√∫n la estrategia actual
 */
function recargarSelectorTerritorios() {
    const select = document.getElementById('municipio');
    const label = document.querySelector('.municipio-selector label');
    if (!select) return;
    
    const territorios = TERRITORIOS[estrategiaActual];
    if (!territorios) {
        console.warn('‚ö†Ô∏è No hay territorios definidos para:', estrategiaActual);
        return;
    }
    
    // Actualizar label
    if (label) {
        label.textContent = territorios.label;
    }
    
    // Limpiar y recargar opciones
    select.innerHTML = `<option value="">${territorios.placeholder}</option>`;
    
    territorios.items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = item.nombre;
        select.appendChild(option);
    });
    
    console.log(`‚úÖ Selector de territorios recargado: ${territorios.items.length} items`);
}

/**
 * Obtiene la configuraci√≥n de la estrategia actualmente seleccionada
 * @returns {Object} Objeto de configuraci√≥n de la estrategia
 */
function getConfigActual() {
    return ESTRATEGIAS_SALUD[estrategiaActual] || ESTRATEGIAS_SALUD['es-andalucia-epvsa'];
}

/**
 * Obtiene los datos (estructura jer√°rquica) de la estrategia actual
 * @returns {Array} Array con la estructura de datos de la estrategia
 */
function getEstructuraActual() {
    const config = getConfigActual();
    // Resuelve la referencia a los datos
    if (config.datosRef === 'ESTRUCTURA_EPVSA' && typeof ESTRUCTURA_EPVSA !== 'undefined') {
        return ESTRUCTURA_EPVSA;
    }
    // Fallback a EPVSA si los datos no est√°n disponibles
    if (typeof ESTRUCTURA_EPVSA !== 'undefined') {
        return ESTRUCTURA_EPVSA;
    }
    console.warn('‚ö†Ô∏è No se encontraron datos para la estrategia:', config.id);
    return [];
}

/**
 * Obtiene la configuraci√≥n de un nivel espec√≠fico de la estrategia actual
 * @param {string} nivelId - ID del nivel (ej: 'linea', 'objetivo', 'programa')
 * @returns {Object|null} Configuraci√≥n del nivel o null si no existe
 */
function getNivelConfig(nivelId) {
    const config = getConfigActual();
    return config.niveles.find(n => n.id === nivelId) || null;
}

/**
 * Obtiene el nivel principal (con color) de la estrategia actual
 * @returns {Object} Configuraci√≥n del nivel principal
 */
function getNivelPrincipal() {
    const config = getConfigActual();
    return config.niveles.find(n => n.color === true) || config.niveles[0];
}

/**
 * Cambia la estrategia activa
 * @param {string} estrategiaId - ID de la nueva estrategia
 */
function cambiarEstrategia(estrategiaId) {
    if (ESTRATEGIAS_SALUD[estrategiaId]) {
        estrategiaActual = estrategiaId;
        console.log('‚úÖ Estrategia cambiada a:', ESTRATEGIAS_SALUD[estrategiaId].nombreCompleto);
        // Disparar evento para que los componentes se actualicen
        document.dispatchEvent(new CustomEvent('estrategiaCambiada', { 
            detail: { estrategia: estrategiaId }
        }));
        return true;
    }
    console.warn('‚ö†Ô∏è Estrategia no encontrada:', estrategiaId);
    return false;
}

/**
 * Obtiene el texto para un nivel en la terminolog√≠a de la estrategia actual
 * @param {string} nivelId - ID del nivel
 * @param {boolean} plural - Si debe devolver el plural
 * @returns {string} Nombre del nivel en la terminolog√≠a actual
 */
function getTerminologia(nivelId, plural = false) {
    const nivel = getNivelConfig(nivelId);
    if (nivel) {
        return plural ? nivel.nombrePlural : nivel.nombre;
    }
    // Fallback gen√©rico
    return plural ? (nivelId + 's') : nivelId;
}

console.log('‚úÖ COMPAS EU - Sistema de estrategias inicializado');
console.log('   Estrategia actual:', getConfigActual().nombreCompleto);

/**
 * Handler para el cambio de estrategia desde la interfaz
 * @param {string} estrategiaId - ID de la estrategia seleccionada
 */
function onCambioEstrategia(estrategiaId) {
    // 1. Actualizar variable global
    estrategiaActual = estrategiaId;
    
    // 2. Obtener el selector de municipios y los territorios de esta estrategia
    const select = document.getElementById('municipio');
    const territorios = TERRITORIOS[estrategiaId];
    
    if (!select || !territorios) {
        console.error('‚ùå No se encontr√≥ selector o territorios para:', estrategiaId);
        return;
    }
    
    // 3. Vaciar el selector de municipios
    select.innerHTML = '';
    
    // 4. A√±adir placeholder
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = territorios.placeholder;
    select.appendChild(placeholder);
    
    // 5. Rellenar con los municipios de esta estrategia
    territorios.items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = item.nombre;
        select.appendChild(option);
    });
    
    // 6. Actualizar el label del selector
    const label = document.querySelector('.municipio-selector label');
    if (label) {
        label.textContent = territorios.label;
    }
    
    // 7. Notificar
    const config = ESTRATEGIAS_SALUD[estrategiaId];
    mostrarToast(`Estrategia: ${config.nombreCompleto}`, 'success');
    console.log(`üîÑ Estrategia cambiada a: ${config.nombre} (${territorios.items.length} municipios)`);
}

// Funci√≥n para verificar si el Plan Local est√° completo
function verificarPlanLocalCompleto() {
    return planLocalSalud.perfil.completado && 
           planLocalSalud.planAccion.completado && 
           planLocalSalud.agenda.completado;
}

// Funci√≥n para actualizar el estado visual del compilador
function actualizarEstadoCompilador() {
    const estadoPerfil = document.getElementById('estado-perfil');
    const estadoPlan = document.getElementById('estado-plan');
    const estadoAgenda = document.getElementById('estado-agenda');
    const btnGenerar = document.getElementById('btn-generar-pls');
    
    if (estadoPerfil) {
        estadoPerfil.innerHTML = planLocalSalud.perfil.completado ? 
            '<span style="color:#10b981;">‚úÖ Completado</span>' : 
            '<span style="color:#f59e0b;">‚è≥ Pendiente - Genera el perfil en Fase 2</span>';
    }
    if (estadoPlan) {
        estadoPlan.innerHTML = planLocalSalud.planAccion.completado ? 
            '<span style="color:#10b981;">‚úÖ Completado</span>' : 
            '<span style="color:#f59e0b;">‚è≥ Pendiente - Genera el plan en Fase 3</span>';
    }
    if (estadoAgenda) {
        estadoAgenda.innerHTML = planLocalSalud.agenda.completado ? 
            '<span style="color:#10b981;">‚úÖ Completado (' + planLocalSalud.agenda.actuaciones.length + ' actuaciones)</span>' : 
            '<span style="color:#f59e0b;">‚è≥ Pendiente - A√±ada actuaciones en Fase 6</span>';
    }
    if (btnGenerar) {
        if (verificarPlanLocalCompleto()) {
            btnGenerar.disabled = false;
            btnGenerar.style.opacity = '1';
            btnGenerar.title = 'Generar documento PDF';
        } else {
            btnGenerar.disabled = true;
            btnGenerar.style.opacity = '0.5';
            btnGenerar.title = 'Completa todas las secciones primero';
        }
    }
}

// Funci√≥n para guardar el perfil generado
function guardarPerfilParaCompilador(html) {
    planLocalSalud.perfil.completado = true;
    planLocalSalud.perfil.html = html;
    planLocalSalud.perfil.fecha = new Date().toISOString();
    planLocalSalud.municipio = getMunicipioActual();
    actualizarEstadoCompilador();
    console.log('‚úÖ Perfil guardado para el compilador');
}

// Funci√≥n para guardar el plan de acci√≥n generado
function guardarPlanAccionParaCompilador(html, seleccion) {
    planLocalSalud.planAccion.completado = true;
    planLocalSalud.planAccion.html = html;
    planLocalSalud.planAccion.seleccion = seleccion;
    planLocalSalud.planAccion.fecha = new Date().toISOString();
    actualizarEstadoCompilador();
    verificarAccesoFase6(); // Actualizar estado de Fase 6
    console.log('‚úÖ Plan de acci√≥n guardado para el compilador');
}

// Funci√≥n para guardar la agenda
function guardarAgendaParaCompilador(actuaciones) {
    planLocalSalud.agenda.completado = actuaciones && actuaciones.length > 0;
    planLocalSalud.agenda.actuaciones = actuaciones || [];
    planLocalSalud.agenda.fecha = new Date().toISOString();
    actualizarEstadoCompilador();
    console.log('‚úÖ Agenda guardada para el compilador:', actuaciones ? actuaciones.length : 0, 'actuaciones');
}

// Resetear el plan cuando cambia el municipio
function resetearPlanLocal() {
    planLocalSalud.municipio = null;
    planLocalSalud.perfil = { completado: false, html: null, fecha: null };
    planLocalSalud.planAccion = { completado: false, html: null, seleccion: null, fecha: null };
    planLocalSalud.agenda = { completado: false, actuaciones: [], a√±o: 2026, fecha: null };
    planLocalSalud.cuadroMandos = { completado: false, html: null, fecha: null };
    actualizarEstadoCompilador();
    verificarAccesoFase6(); // Actualizar estado de Fase 6
}

// Verificar si se puede acceder a la Fase 6 (Agenda anual)
function verificarAccesoFase6() {
    const bloqueado = document.getElementById('fase-5-bloqueada');
    const contenidoActivo = document.getElementById('fase-5-contenido-activo');
    const fase6Tab = document.querySelector('.fase[data-fase="5"]');
    
    if (planLocalSalud.planAccion.completado) {
        // Plan de acci√≥n completado - desbloquear Fase 6
        if (bloqueado) bloqueado.style.display = 'none';
        if (contenidoActivo) contenidoActivo.style.display = 'block';
        if (fase6Tab) {
            fase6Tab.style.opacity = '1';
            fase6Tab.style.cursor = 'pointer';
            fase6Tab.title = '';
        }
    } else {
        // Plan de acci√≥n NO completado - bloquear Fase 6
        if (bloqueado) bloqueado.style.display = 'block';
        if (contenidoActivo) contenidoActivo.style.display = 'none';
        if (fase6Tab) {
            fase6Tab.style.opacity = '0.5';
            fase6Tab.style.cursor = 'not-allowed';
            fase6Tab.title = 'Completar Fase 3 - Plan de acci√≥n';
        }
    }
}

// Funci√≥n para cargar todos los datos de un municipio desde Firebase


// ==========================================
// CUADRO DE MANDOS INTEGRAL - 50 INDICADORES APQ
// ==========================================
// Estructura basada en el documento "Objetivo_APQ.docx"
// Organizado en 4 categor√≠as principales: Demograf√≠a, Determinantes, Eventos no transmisibles y Prevenci√≥n

const CUADRO_MANDOS_INTEGRAL = {
    // CATEGOR√çA 1: DETERMINANTES DE LA SALUD (11 indicadores - INFOWEB)
    determinantes: {
        nombre: "Determinantes de la salud",
        icono: "üå±",
        color: "#94d40b",
        fuente: "INFOWEB",
        indicadores: [
            {numero: 1, nombre: "Personas con Consumo de Alcohol de alto riesgo", unidad: "N"},
            {numero: 2, nombre: "Personas con Dependencia otras sustancias", unidad: "N"},
            {numero: 3, nombre: "Autonom√≠a funcional (65 y m√°s a√±os)", unidad: "%"},
            {numero: 4, nombre: "Lactancia materna (6 meses)", unidad: "%"},
            {numero: 5, nombre: "poblaci√≥n infantil que inicia Lactancia Materna", unidad: "%"},
            {numero: 6, nombre: "Personas valoradas en dieta mediterr√°nea", unidad: "N"},
            {numero: 7, nombre: "Personas valoradas en dieta con adhesi√≥n a la dieta mediterr√°nea", unidad: "N"},
            {numero: 8, nombre: "Personas valoradas en actividad f√≠sica (de 15 a 64 a√±os)", unidad: "N"},
            {numero: 9, nombre: "Personas valoradas en actividad f√≠sica sin sedentarismo (de 15 a 64 a√±os)", unidad: "N"},
            {numero: 10, nombre: "Personas valoradas en act f√≠sica sin sedentarismo, 65y+", unidad: "N"},
            {numero: 11, nombre: "Personas valoradas en actividad f√≠sica con 65 y m√°s a√±os", unidad: "N"}
        ]
    },
    
    // CATEGOR√çA 2: EVENTOS NO TRANSMISIBLES (22 indicadores - INFOWEB)
    eventos_no_transmisibles: {
        nombre: "Eventos no transmisibles",
        icono: "üè•",
        color: "#ff6600",
        fuente: "INFOWEB",
        indicadores: [
            {numero: 12, nombre: "Personas con Asma", unidad: "N"},
            {numero: 13, nombre: "Personas con Cardiopat√≠a isqu√©mica", unidad: "N"},
            {numero: 14, nombre: "Personas con Cirrosis hep√°tica", unidad: "N"},
            {numero: 15, nombre: "Personas con Diabetes", unidad: "N"},
            {numero: 16, nombre: "Personas con Diagn√≥stico de pie diab√©tico", unidad: "N"},
            {numero: 17, nombre: "Personas con Dislipemia", unidad: "N"},
            {numero: 18, nombre: "Personas con EPOC", unidad: "N"},
            {numero: 19, nombre: "Personas con Hipertensi√≥n", unidad: "N"},
            {numero: 20, nombre: "Prevalencia insuficiencia cardiaca", unidad: "%"},
            {numero: 21, nombre: "Personas con Insuficiencia renal cr√≥nica", unidad: "N"},
            {numero: 22, nombre: "Personas con Obesidad", unidad: "N"},
            {numero: 23, nombre: "Caries infancia", unidad: "%"},
            {numero: 24, nombre: "Estado Dentadura (15 a√±os o m√°s)", unidad: "%"},
            {numero: 25, nombre: "Prevalencia de Ansiedad", unidad: "%"},
            {numero: 26, nombre: "Consumo de psicotropos", unidad: "%"},
            {numero: 27, nombre: "Prevalencia de Demencia", unidad: "%"},
            {numero: 28, nombre: "Prevalencia de Trastorno conducta alimentaria (TCA)", unidad: "%"},
            {numero: 29, nombre: "Personas con Trastorno del espectro autista", unidad: "N"},
            {numero: 30, nombre: "Personas con Trastorno esquizofr√©nico", unidad: "N"},
            {numero: 31, nombre: "Personas con Trastorno estado √°nimo", unidad: "N"},
            {numero: 32, nombre: "Personas con Trastorno personalidad y comportamiento adulto", unidad: "N"},
            {numero: 33, nombre: "Consumo Benzodiacepinas (N¬∫ DDD/TAFE bzd)", unidad: "DDD/TAFE"}
        ]
    },
    
    // CATEGOR√çA 3: PREVENCI√ìN (17 indicadores - INFOWEB)
    prevencion: {
        nombre: "Prevenci√≥n",
        icono: "üíâ",
        color: "#9b59b6",
        fuente: "INFOWEB",
        indicadores: [
            {numero: 34, nombre: "Participaci√≥n cribado c√°ncer Colorrectal", unidad: "%"},
            {numero: 35, nombre: "Participaci√≥n cribado c√°ncer de Mama", unidad: "%"},
            {numero: 36, nombre: "Participaci√≥n Cribado Cuello Uterino", unidad: "%"},
            {numero: 37, nombre: "Captaci√≥n Precoz Embarazo (<12 semana)", unidad: "%"},
            {numero: 38, nombre: "poblaci√≥n infantil con cribado de hipoacusia antes del mes de vida", unidad: "%"},
            {numero: 39, nombre: "poblaci√≥n infantil con cribado de displasia de caderas", unidad: "%"},
            {numero: 40, nombre: "poblaci√≥n infantil con 2 exploraciones testiculares en los primeros 6 meses de vida", unidad: "%"},
            {numero: 41, nombre: "Cribado de enfermedad metab√≥lica", unidad: "%"},
            {numero: 42, nombre: "poblaci√≥n infantil con Test de visi√≥n de cerca", unidad: "%"},
            {numero: 43, nombre: "Cobertura Primovacunaci√≥n", unidad: "%"},
            {numero: 44, nombre: "Porcentaje vacunaci√≥n completa", unidad: "%"},
            {numero: 45, nombre: "Cobertura vacunaci√≥n Triple V√≠rica (2 dosis)", unidad: "%"},
            {numero: 46, nombre: "Cobertura DTPa-VPI/Tdpa 6 a√±os", unidad: "%"},
            {numero: 47, nombre: "Cobertura VPH a los 12 a√±os", unidad: "%"},
            {numero: 48, nombre: "Cobertura vacunal gripe 65 y m√°s a√±os", unidad: "%"},
            {numero: 49, nombre: "Cobertura neumococo adultos", unidad: "%"},
            {numero: 50, nombre: "Cobertura covid", unidad: "%"}
        ]
    }
};

// Funci√≥n para generar HTML del Cuadro de mandos con estructura hardcodeada
function generarCuadroMandosIntegral(datosIndicadores) {
    let html = '<div class="cuadro-mandos-container">';
    
    // Header
    html += '<div class="cuadro-header">';
    html += '<h2 style="color:#0074c8;margin:0;">üìä Cuadro de mandos integral</h2>';
    html += '<p style="color:#666;margin:0.5rem 0 0;"><strong>50 indicadores</strong> organizados en <strong>3 categor√≠as</strong></p>';
    html += '</div>';
    
    // Resumen por dimensiones
    html += '<div class="dimensiones-resumen">';
    Object.entries(CUADRO_MANDOS_INTEGRAL).forEach(([key, dim]) => {
        const numIndicadores = dim.indicadores.length;
        const cargados = datosIndicadores ? 
            dim.indicadores.filter(ind => datosIndicadores[ind.numero]).length : 0;
        
        html += '<div class="dimension-card" style="border-left:4px solid ' + dim.color + ';">';
        html += '<div class="dimension-icono">' + dim.icono + '</div>';
        html += '<div class="dimension-info">';
        html += '<div class="dimension-nombre" style="color:' + dim.color + ';">' + dim.nombre + '</div>';
        html += '<div class="dimension-stats"><strong>' + numIndicadores + '</strong> indicadores';
        if (datosIndicadores) {
            html += ' <span style="color:' + (cargados === numIndicadores ? '#94d40b' : '#ffb61b') + '; font-weight:600;">(' + cargados + ' con valor)</span>';
        }
        html += '</div>';
        html += '</div></div>';
    });
    html += '</div>';
    
    // Tablas por dimensi√≥n
    Object.entries(CUADRO_MANDOS_INTEGRAL).forEach(([key, dim]) => {
        html += '<div class="dimension-tabla" style="border-top:4px solid ' + dim.color + ';">';
        html += '<h3 style="color:' + dim.color + ';"><span style="margin-right:0.5rem;">' + dim.icono + '</span>' + dim.nombre + '</h3>';
        html += '<table class="tabla-indicadores">';
        html += '<thead><tr>';
        html += '<th style="width:50px;background:linear-gradient(135deg, ' + dim.color + ' 0%, ' + ajustarColor(dim.color, -20) + ' 100%);">N¬∫</th>';
        html += '<th style="background:linear-gradient(135deg, ' + dim.color + ' 0%, ' + ajustarColor(dim.color, -20) + ' 100%);"><strong>Indicador</strong></th>';
        html += '<th style="width:100px;text-align:center;background:linear-gradient(135deg, ' + dim.color + ' 0%, ' + ajustarColor(dim.color, -20) + ' 100%);"><strong>Valor</strong></th>';
        html += '<th style="width:80px;text-align:center;background:linear-gradient(135deg, ' + dim.color + ' 0%, ' + ajustarColor(dim.color, -20) + ' 100%);"><strong>Unidad</strong></th>';
        html += '<th style="width:80px;text-align:center;background:linear-gradient(135deg, ' + dim.color + ' 0%, ' + ajustarColor(dim.color, -20) + ' 100%);"><strong>Tendencia</strong></th>';
        html += '</tr></thead><tbody>';
        
        dim.indicadores.forEach(ind => {
            const dato = datosIndicadores && datosIndicadores[ind.numero] ? datosIndicadores[ind.numero] : {};
            const valor = dato.dato || dato.valor || '';
            const tendenciaObservada = dato.tendenciaObservada || '';
            const tendenciaDeseada = dato.tendenciaDeseada || '';
            
            // C√≥digo semaf√≥rico basado en tendencias
            let semaforo = '';
            if (tendenciaObservada && tendenciaDeseada) {
                if (tendenciaObservada === tendenciaDeseada) {
                    semaforo = '<span class="semaforo semaforo-verde">üü¢</span>';
                } else if ((tendenciaObservada === 'ascendente' && tendenciaDeseada === 'descendente') ||
                           (tendenciaObservada === 'descendente' && tendenciaDeseada === 'ascendente')) {
                    semaforo = '<span class="semaforo semaforo-rojo">üî¥</span>';
                } else {
                    semaforo = '<span class="semaforo semaforo-amarillo">üü°</span>';
                }
            }
            
            html += '<tr>';
            html += '<td style="text-align:center;font-weight:700;color:' + dim.color + ';">' + ind.numero + '</td>';
            html += '<td><strong>' + ind.nombre + '</strong></td>';
            html += '<td style="text-align:center;font-weight:700;">' + (valor || '‚Äî') + '</td>';
            html += '<td style="text-align:center;color:#666;">' + ind.unidad + '</td>';
            html += '<td style="text-align:center;">' + (semaforo || '‚Äî') + '</td>';
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        html += '</div>';
    });
    
    html += '</div>';
    return html;
}

// Funci√≥n auxiliar para ajustar color (oscurecer)
function ajustarColor(color, porcentaje) {
    const num = parseInt(color.replace("#",""), 16);
    const amt = Math.round(2.55 * porcentaje);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
        (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
        .toString(16).slice(1);
}


function cargarDatosMunicipioFirebase(municipioKey, callback) {
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipioKey).once('value', snap => {
        datosMunicipioActual = snap.val();
        if (callback) callback(datosMunicipioActual);
    });
}


const MUNICIPIOS = {
    'agron': { nombre: 'Agr√≥n', tieneInforme: false },
    'albolote': { nombre: 'Albolote', tieneInforme: false },
    'albunuelas': { nombre: 'Albu√±uelas', tieneInforme: false },
    'alfacar': { nombre: 'Alfacar', tieneInforme: false },
    'algarinejo': { nombre: 'Algarinejo', tieneInforme: false },
    'alhama-de-granada': { nombre: 'Alhama de Granada', tieneInforme: false },
    'alhendin': { nombre: 'Alhend√≠n', tieneInforme: false },
    'arenas-del-rey': { nombre: 'Arenas del Rey', tieneInforme: false },
    'armilla': { nombre: 'Armilla', tieneInforme: false },
    'atarfe': { nombre: 'Atarfe', tieneInforme: false },
    'benalua-de-las-villas': { nombre: 'Benal√∫a de las Villas', tieneInforme: false },
    'cacin': { nombre: 'Cac√≠n', tieneInforme: false },
    'cajar': { nombre: 'C√°jar', tieneInforme: false },
    'calicasas': { nombre: 'Calicasas', tieneInforme: false },
    'campotejar': { nombre: 'Campot√©jar', tieneInforme: false },
    'cenes-de-la-vega': { nombre: 'Cenes de la Vega', tieneInforme: false },
    'chauchina': { nombre: 'Chauchina', tieneInforme: false },
    'chimeneas': { nombre: 'Chimeneas', tieneInforme: false },
    'churriana-de-la-vega': { nombre: 'Churriana de la Vega', tieneInforme: false },
    'cijuela': { nombre: 'Cijuela', tieneInforme: false },
    'cogollos-vega': { nombre: 'Cogollos Vega', tieneInforme: false },
    'colomera': { nombre: 'Colomera', tieneInforme: false },
    'cullar-vega': { nombre: 'C√∫llar-Vega', tieneInforme: false },
    'deifontes': { nombre: 'Deifontes', tieneInforme: false },
    'dilar': { nombre: 'D√≠lar', tieneInforme: false },
    'dudar': { nombre: 'D√∫dar', tieneInforme: false },
    'durcal': { nombre: 'D√∫rcal', tieneInforme: false },
    'el-pinar': { nombre: 'El Pinar', tieneInforme: false },
    'el-valle': { nombre: 'El Valle', tieneInforme: false },
    'escuzar': { nombre: 'Esc√∫zar', tieneInforme: false },
    'fuente-vaqueros': { nombre: 'Fuente Vaqueros', tieneInforme: false },
    'gobernador': { nombre: 'Gobernador', tieneInforme: false },
    'gojar': { nombre: 'G√≥jar', tieneInforme: false },
    'granada-albaicin': { nombre: 'Granada - Albaic√≠n', tieneInforme: false },
    'granada-beiro': { nombre: 'Granada - Beiro', tieneInforme: false },
    'granada-centro': { nombre: 'Granada - Centro', tieneInforme: false },
    'granada-chana': { nombre: 'Granada - Chana', tieneInforme: false },
    'granada-genil': { nombre: 'Granada - Genil', tieneInforme: false },
    'granada-norte': { nombre: 'Granada - Norte', tieneInforme: false },
    'granada-ronda': { nombre: 'Granada - Ronda', tieneInforme: false },
    'granada-zaidin': { nombre: 'Granada - Zaid√≠n', tieneInforme: false },
    'guadahortuna': { nombre: 'Guadahortuna', tieneInforme: false },
    'guejar-sierra': { nombre: 'G√ºejar Sierra', tieneInforme: false },
    'guevejar': { nombre: 'G√ºev√©jar', tieneInforme: false },
    'huetor-tajar': { nombre: 'Hu√©tor-T√°jar', tieneInforme: false },
    'huetor-vega': { nombre: 'Hu√©tor-Vega', tieneInforme: false },
    'illora': { nombre: '√çllora', tieneInforme: false },
    'iznalloz': { nombre: 'Iznalloz', tieneInforme: false },
    'jayena': { nombre: 'Jayena', tieneInforme: false },
    'la-malaha': { nombre: 'La Malah√°', tieneInforme: false },
    'la-zubia': { nombre: 'La Zubia', tieneInforme: false },
    'lachar': { nombre: 'L√°char', tieneInforme: false },
    'las-gabias': { nombre: 'Las Gabias', tieneInforme: false },
    'lecrin': { nombre: 'Lecr√≠n', tieneInforme: false },
    'loja': { nombre: 'Loja', tieneInforme: false },
    'mancomunidad-alhama': { nombre: 'Mancomunidad de Alhama de Granada', tieneInforme: false },
    'mancomunidad-lecrin': { nombre: 'Mancomunidad del Valle de Lecr√≠n', tieneInforme: false },
    'maracena': { nombre: 'Maracena', tieneInforme: false },
    'moclin': { nombre: 'Mocl√≠n', tieneInforme: false },
    'monachil': { nombre: 'Monachil', tieneInforme: false },
    'montefrio': { nombre: 'Montefr√≠o', tieneInforme: false },
    'montejicar': { nombre: 'Montej√≠car', tieneInforme: false },
    'montillana': { nombre: 'Montillana', tieneInforme: false },
    'moraleda-de-zafayona': { nombre: 'Moraleda de Zafayona', tieneInforme: false },
    'niguelas': { nombre: 'Nig√ºelas', tieneInforme: false },
    'nivar': { nombre: 'N√≠var', tieneInforme: false },
    'ogijares': { nombre: 'Og√≠jares', tieneInforme: false },
    'otura': { nombre: 'Otura', tieneInforme: false },
    'padul': { nombre: 'Padul', tieneInforme: true },
    'peligros': { nombre: 'Peligros', tieneInforme: false },
    'pinar': { nombre: 'P√≠√±ar', tieneInforme: false },
    'pinos-genil': { nombre: 'Pinos-Genil', tieneInforme: false },
    'pinos-puente': { nombre: 'Pinos-Puente', tieneInforme: false },
    'pulianas': { nombre: 'Pulianas', tieneInforme: false },
    'quentar': { nombre: 'Qu√©ntar', tieneInforme: false },
    'salar': { nombre: 'Salar', tieneInforme: false },
    'santa-cruz-del-comercio': { nombre: 'Santa Cruz del Comercio', tieneInforme: false },
    'santa-fe': { nombre: 'Santa Fe', tieneInforme: false },
    'torre-cardela': { nombre: 'Torre-Cardela', tieneInforme: false },
    'vegas-del-genil': { nombre: 'Vegas del Genil', tieneInforme: false },
    'ventas-de-huelma': { nombre: 'Ventas de Huelma', tieneInforme: false },
    'villamena': { nombre: 'Villamena', tieneInforme: false },
    'villanueva-mesia': { nombre: 'Villanueva Mes√≠a', tieneInforme: false },
    'viznar': { nombre: 'V√≠znar', tieneInforme: false },
    'zafarraya': { nombre: 'Zafarraya', tieneInforme: false },
    'zagra': { nombre: 'Zagra', tieneInforme: false }
};

// ESTRUCTURA DETERMINANTES - Valores estimados con Bettersurveys
// PADUL: Valores ESTIMADOS reponderados (ejemplo) - SUSTITUIR por CSV real cuando est√© disponible
// Granada y Andaluc√≠a: Valores de referencia de la EAS 2023
// ESTRUCTURA de los determinantes (solo c√≥digos y textos, sin valores)
// Los valores se cargan desde Firebase: referencias/ y municipios/{municipio}/determinantes/
const ESTRUCTURA_DETERMINANTES = {
    // ============================================================================
    // NOTA METODOL√ìGICA GENERAL
    // ============================================================================
    // Todos los datos proceden de la Encuesta Andaluza de Salud (EAS) 2023.
    // Son datos de AUTORREPORTE obtenidos mediante entrevista poblacional.
    // 
    // CLASIFICACI√ìN DE INDICADORES POR TIPO DE DATO:
    // - "autorreporte_conducta": Conductas autodeclaradas (fumar, beber, ejercicio)
    // - "autorreporte_percepcion": Percepciones subjetivas (salud percibida, calidad entorno)
    // - "escala_validada": Instrumentos psicom√©tricos validados (SF-12, DUKE-UNC, CAGE, PREDIMED)
    // - "autorreporte_situacion": Situaci√≥n objetivable declarada (vivienda, econom√≠a)
    //
    // LIMITACIONES: 
    // - Sesgo de deseabilidad social en conductas
    // - Variabilidad en interpretaci√≥n de escalas subjetivas
    // - Los datos de percepci√≥n ambiental NO sustituyen mediciones objetivas
    // ============================================================================
    
    _metadatos: {
        fuente: "Encuesta Andaluza de Salud (EAS) 2023",
        metodologia: "Encuesta poblacional por muestreo aleatorio estratificado",
        tecnicaRecogida: "Entrevista personal asistida por ordenador (CAPI)",
        procesamientoLocal: "Estimaciones municipales mediante reponderaci√≥n Bettersurveys",
        limitaciones: [
            "Todos los datos son de autorreporte, sujetos a sesgos de memoria y deseabilidad social",
            "Las estimaciones municipales tienen mayor error muestral que las provinciales/auton√≥micas",
            "Los indicadores de percepci√≥n ambiental reflejan experiencia subjetiva, no mediciones objetivas",
            "Las conductas autodeclaradas pueden infraestimar comportamientos socialmente censurados"
        ],
        referencias: [
            "IECA. Encuesta Andaluza de Salud 2023. Metodolog√≠a.",
            "Ware JE et al. SF-12: How to Score the SF-12 Physical and Mental Health Summary Scales.",
            "Broadhead WE et al. The Duke-UNC Functional Social Support Questionnaire.",
            "Ewing JA. Detecting alcoholism: The CAGE questionnaire.",
            "Mart√≠nez-Gonz√°lez MA et al. PREDIMED Study."
        ]
    },
    
    area1: {
        nombre: "Salud percibida y calidad de vida relacionada con la salud",
        icono: "ü©∫",
        descripcion: "Indicadores de salud autopercibida. Reflejan la valoraci√≥n subjetiva del estado de salud, validada como predictor de morbimortalidad.",
        tipoDatoArea: "autorreporte_percepcion",
        notaMetodologica: "La salud percibida es un constructo subjetivo validado epidemiol√≥gicamente como predictor independiente de mortalidad y uso de servicios sanitarios.",
        escalas: [
            { 
                nombre: "SF-12 (Short Form-12 Health Survey)", 
                items: 12, 
                mide: "Calidad de vida relacionada con la salud (componente f√≠sico y mental)",
                validacion: "Instrumento validado internacionalmente con propiedades psicom√©tricas establecidas",
                referencia: "Ware JE et al. Med Care. 1996;34(3):220-33"
            }
        ],
        indicadores: [
            { codigo: "P7", texto: "Declara salud percibida buena o muy buena", unidad: "%", polaridad: 1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P7b", texto: "Declara salud mental percibida buena o muy buena", unidad: "%", polaridad: 1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P8a", texto: "Declara limitaci√≥n para esfuerzos moderados", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P8b", texto: "Declara limitaci√≥n para subir escaleras", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P9a", texto: "Declara haber hecho menos de lo deseado por salud f√≠sica", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P9b", texto: "Declara haber dejado tareas por salud f√≠sica", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P10a", texto: "Declara haber hecho menos por problema emocional", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P10b", texto: "Declara menor cuidado por problema emocional", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P11", texto: "Declara que el dolor dificulta trabajo (bastante/mucho)", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P12a", texto: "Declara sentirse calmado y tranquilo frecuentemente", unidad: "%", polaridad: 1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P12b", texto: "Declara tener mucha energ√≠a frecuentemente", unidad: "%", polaridad: 1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P12c", texto: "Declara sentirse desanimado y triste frecuentemente", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
            { codigo: "P13", texto: "Declara que problemas de salud dificultaron vida social", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" }
        ]
    },
    area2: {
        nombre: "Estilos de vida y conductas de salud (autodeclaradas)",
        icono: "üèÉ",
        descripcion: "Conductas relacionadas con la salud seg√∫n declaraci√≥n de la persona entrevistada. Sujetas a sesgo de deseabilidad social.",
        tipoDatoArea: "autorreporte_conducta",
        notaMetodologica: "Las conductas autodeclaradas tienden a infraestimar comportamientos socialmente censurados (tabaco, alcohol) y sobreestimar conductas deseables (ejercicio, dieta).",
        grupos: [
            {
                nombre: "Consumo de tabaco (autodeclarado)",
                notaGrupo: "Posible infraestimaci√≥n por deseabilidad social",
                indicadores: [
                    { codigo: "P23", texto: "Declara ser fumador diario", unidad: "%", polaridad: -1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P23_ex", texto: "Declara ser exfumador", unidad: "%", polaridad: 1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P25d", texto: "Declara usar cigarrillo electr√≥nico", unidad: "%", polaridad: -1, tipoDato: "autorreporte_conducta" }
                ]
            },
            {
                nombre: "Consumo de alcohol (autodeclarado)",
                notaGrupo: "Posible infraestimaci√≥n por deseabilidad social. CAGE es escala de cribado, no diagn√≥stica.",
                indicadores: [
                    { codigo: "P29", texto: "Presenta consumo de riesgo de alcohol (autodeclarado)", unidad: "%", polaridad: -1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P32_CAGE", texto: "CAGE positivo (‚â•2 respuestas afirmativas)", unidad: "%", polaridad: -1, tipoDato: "escala_validada", escala: "CAGE", referencia: "Ewing JA. JAMA. 1984;252(14):1905-7" }
                ]
            },
            {
                nombre: "Sue√±o y descanso (autodeclarado)",
                indicadores: [
                    { codigo: "P33", texto: "Horas de sue√±o declaradas (media entre semana)", unidad: "h", polaridad: 0, tipoDato: "autorreporte_conducta" },
                    { codigo: "P33_fin", texto: "Horas de sue√±o declaradas (media fin de semana)", unidad: "h", polaridad: 0, tipoDato: "autorreporte_conducta" },
                    { codigo: "P33a", texto: "Declara descanso suficiente", unidad: "%", polaridad: 1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P33b_insomnio", texto: "Declara problemas de sue√±o frecuentes", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" }
                ]
            },
            {
                nombre: "Actividad f√≠sica (autodeclarada)",
                notaGrupo: "Posible sobreestimaci√≥n por deseabilidad social",
                indicadores: [
                    { codigo: "P34", texto: "Declara trabajo sedentario (sentado la mayor parte)", unidad: "%", polaridad: -1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P34a_intenso", texto: "Declara ejercicio intenso en tiempo libre", unidad: "%", polaridad: 1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P34a_moderado", texto: "Declara ejercicio moderado en tiempo libre", unidad: "%", polaridad: 1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P34a_nada", texto: "Declara no realizar ejercicio en tiempo libre", unidad: "%", polaridad: -1, tipoDato: "autorreporte_conducta" }
                ]
            },
            {
                nombre: "Alimentaci√≥n - Cuestionario PREDIMED (autodeclarada)",
                notaGrupo: "PREDIMED es escala validada de adherencia a dieta mediterr√°nea",
                indicadores: [
                    { codigo: "P36b1", texto: "Declara aceite de oliva como grasa principal", unidad: "%", polaridad: 1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P36b_aceite", texto: "Cucharadas aceite oliva/d√≠a declaradas (media)", unidad: "ud", polaridad: 1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P36b_verdura", texto: "Raciones verdura/d√≠a declaradas (media)", unidad: "ud", polaridad: 1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P36b_fruta", texto: "Piezas fruta/d√≠a declaradas (media)", unidad: "ud", polaridad: 1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P36b_carne", texto: "Raciones carnes rojas/d√≠a declaradas (media)", unidad: "ud", polaridad: -1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P36b_azucar", texto: "Bebidas azucaradas/d√≠a declaradas (media)", unidad: "ud", polaridad: -1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P36b_legumbres", texto: "Raciones legumbres/semana declaradas (media)", unidad: "ud", polaridad: 1, tipoDato: "autorreporte_conducta" },
                    { codigo: "P36b_pescado", texto: "Raciones pescado/semana declaradas (media)", unidad: "ud", polaridad: 1, tipoDato: "autorreporte_conducta" },
                    { codigo: "PREDIMED", texto: "Alta adherencia a dieta mediterr√°nea (escala PREDIMED)", unidad: "%", polaridad: 1, tipoDato: "escala_validada", escala: "PREDIMED", referencia: "Mart√≠nez-Gonz√°lez MA et al. J Nutr. 2012;142(9):1672-8" }
                ]
            }
        ]
    },
    area3: {
        nombre: "Entorno, determinantes sociales y apoyo (datos declarados)",
        icono: "üè†",
        descripcion: "Indicadores sobre condiciones de vida, entorno y apoyo social seg√∫n declaraci√≥n de la persona entrevistada.",
        tipoDatoArea: "mixto",
        notaMetodologica: "Esta √°rea combina indicadores de situaci√≥n objetivable (vivienda, econom√≠a), percepciones subjetivas (entorno) y escalas validadas (Duke-UNC).",
        grupos: [
            {
                nombre: "Condiciones de vivienda (situaci√≥n declarada)",
                notaGrupo: "Indicadores de privaci√≥n material declarada, objetivables",
                indicadores: [
                    { codigo: "P4d_frio", texto: "Declara no poder mantener vivienda c√°lida en invierno", unidad: "%", polaridad: -1, tipoDato: "autorreporte_situacion" },
                    { codigo: "P4d_calor", texto: "Declara no poder mantener vivienda fresca en verano", unidad: "%", polaridad: -1, tipoDato: "autorreporte_situacion" }
                ]
            },
            {
                nombre: "Percepci√≥n del medio ambiente del barrio",
                notaGrupo: "‚ö†Ô∏è DATOS DE PERCEPCI√ìN SUBJETIVA. No sustituyen mediciones objetivas de calidad ambiental (redes de vigilancia atmosf√©rica, mapas de ruido, etc.)",
                tipoDatoGrupo: "autorreporte_percepcion",
                indicadores: [
                    { codigo: "P5_ruido", texto: "Percibe ruido exterior molesto en su barrio", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P5_olores", texto: "Percibe malos olores del exterior en su barrio", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P5_contaminacion", texto: "Percibe contaminaci√≥n del aire elevada en su barrio", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P5_industria", texto: "Percibe industria contaminante cerca de su vivienda", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P5_zonas_verdes", texto: "Percibe escasez de zonas verdes en su barrio", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P5_delincuencia", texto: "Percibe delincuencia o inseguridad en su barrio", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P5_trafico", texto: "Percibe tr√°fico intenso en su barrio", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P5b", texto: "Valora calidad del medio ambiente de su barrio como buena/muy buena", unidad: "%", polaridad: 1, tipoDato: "autorreporte_percepcion" }
                ]
            },
            {
                nombre: "Apoyo social funcional - Escala Duke-UNC",
                notaGrupo: "Escala validada de apoyo social percibido. Punto de corte <32 indica bajo apoyo.",
                indicadores: [
                    { codigo: "DUKE_bajo", texto: "Presenta apoyo social bajo seg√∫n Duke-UNC (<32 puntos)", unidad: "%", polaridad: -1, tipoDato: "escala_validada", escala: "Duke-UNC", referencia: "Broadhead WE et al. Med Care. 1988;26(7):709-23" },
                    { codigo: "DUKE_media", texto: "Puntuaci√≥n media en escala Duke-UNC", unidad: "pts", polaridad: 1, tipoDato: "escala_validada", escala: "Duke-UNC" }
                ]
            },
            {
                nombre: "Bienestar emocional (autopercibido)",
                notaGrupo: "Indicadores de bienestar subjetivo, no sustituyen evaluaci√≥n cl√≠nica de salud mental",
                indicadores: [
                    { codigo: "P57b1", texto: "Declara sentirse deprimido frecuentemente", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P57b2", texto: "Declara sentirse feliz frecuentemente", unidad: "%", polaridad: 1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P57b3", texto: "Declara sentirse solo frecuentemente", unidad: "%", polaridad: -1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P57b4", texto: "Declara disfrutar de la vida frecuentemente", unidad: "%", polaridad: 1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P57b5", texto: "Declara sentirse con energ√≠a frecuentemente", unidad: "%", polaridad: 1, tipoDato: "autorreporte_percepcion" },
                    { codigo: "P57b6", texto: "Declara sentirse tranquilo frecuentemente", unidad: "%", polaridad: 1, tipoDato: "autorreporte_percepcion" }
                ]
            },
            {
                nombre: "Situaci√≥n econ√≥mica (declarada)",
                notaGrupo: "Indicador de privaci√≥n econ√≥mica subjetiva, complementario a indicadores objetivos de renta",
                indicadores: [
                    { codigo: "P71_dificultad", texto: "Declara llegar a fin de mes con dificultad", unidad: "%", polaridad: -1, tipoDato: "autorreporte_situacion" },
                    { codigo: "P71_mucha_dif", texto: "Declara llegar a fin de mes con mucha dificultad", unidad: "%", polaridad: -1, tipoDato: "autorreporte_situacion" }
                ]
            }
        ]
    }
};

// Variable global para referencias (Granada y Andaluc√≠a) - se carga desde Firebase
let referenciasEAS = {};

// Variable global para valores del municipio actual - se carga desde Firebase
let valoresMunicipio = {};

// Alias para compatibilidad con c√≥digo existente
const DETERMINANTES_EAS = ESTRUCTURA_DETERMINANTES;

// Generar HTML de secci√≥n Determinantes
function generarSeccionDeterminantes() {
    return `
    <div class="acordeon-item">
        <div class="acordeon-header" onclick="toggleAcordeon(this)">
            <span>03 Determinantes de la salud (Selecci√≥n EAS 2023)</span>
            <span class="flecha">‚ñº</span>
        </div>
        <div class="acordeon-contenido">
            <div class="destacado destacado-morado">
                <strong>üìä Datos de autorreporte mediante encuesta poblacional</strong><br>
                Estimaciones territoriales a partir de la Encuesta Andaluza de Salud 2023 para el municipio de <strong><span class="nombre-municipio-dinamico">Padul</span></strong>. 
                Los valores se comparan con las referencias provinciales (Granada) y auton√≥micas (Andaluc√≠a).
            </div>
            
            ${generarNotaMetodologicaInforme()}
            
            <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; margin: 1rem 0; padding: 0.75rem; background: #f8fafc; border-radius: 8px; font-size: 0.85rem;">
                <span><strong>Leyenda:</strong></span>
                <span style="color: #059669; font-weight: bold;">‚óè Verde</span> = Mejor que Andaluc√≠a
                <span style="color: #dc143c; font-weight: bold;">‚óè Rojo</span> = Peor que Andaluc√≠a
                <span style="color: #333;">‚óè Normal</span> = Similar, neutral o sin referencia
            </div>
            
            <div class="determinantes-tabs">
                <button class="determinantes-tab activo" onclick="mostrarAreaDet('area1')">ü©∫ √Årea 1: Salud percibida</button>
                <button class="determinantes-tab" onclick="mostrarAreaDet('area2')">üèÉ √Årea 2: Conductas (autodeclaradas)</button>
                <button class="determinantes-tab" onclick="mostrarAreaDet('area3')">üè† √Årea 3: Entorno y apoyo (declarado)</button>
            </div>
            
            <div id="det-area1" class="determinantes-area activa">${generarAreaDet('area1')}</div>
            <div id="det-area2" class="determinantes-area">${generarAreaDet('area2')}</div>
            <div id="det-area3" class="determinantes-area">${generarAreaDet('area3')}</div>
            
            <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <button class="btn-registrar" onclick="guardarDeterminantes()" style="background: linear-gradient(135deg, #0074c8 0%, #00acd9 100%);">üíæ Guardar valores</button>
                <button class="btn-registrar" onclick="exportarDeterminantesCSV()" style="background: #00acd9;">üì• Exportar CSV</button>
            </div>
            
            <p class="fuente" style="margin-top: 1.5rem;">Fuente: Estimaciones Bettersurveys a partir de la Encuesta Andaluza de Salud 2023. Consejer√≠a de Sanidad, Presidencia y Emergencias. Junta de Andaluc√≠a.</p>
        </div>
    </div>`;
}

function generarAreaDet(areaId) {
    const area = DETERMINANTES_EAS[areaId];
    let html = `<h3>${area.icono} ${area.nombre}</h3>`;
    html += `<p style="color: #666; font-style: italic; margin-bottom: 1rem;">${area.descripcion}</p>`;
    
    // Nota metodol√≥gica del √°rea si existe
    if (area.notaMetodologica) {
        html += `<div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem; color: #1e40af;">
            <strong>‚ÑπÔ∏è Nota:</strong> ${area.notaMetodologica}
        </div>`;
    }
    
    if (area.escalas) {
        area.escalas.forEach(e => {
            html += `<div class="escala-info"><h4>üìê ${e.nombre}</h4>
                <p><strong>√çtems:</strong> ${e.items} | <strong>Mide:</strong> ${e.mide}</p>
                ${e.validacion ? `<p style="font-size: 0.8rem; color: #64748b;"><strong>Validaci√≥n:</strong> ${e.validacion}</p>` : ''}
                ${e.referencia ? `<p style="font-size: 0.75rem; color: #94a3b8;"><strong>Ref:</strong> ${e.referencia}</p>` : ''}
            </div>`;
        });
    }
    
    if (area.indicadores) {
        html += generarTablaIndicadores(area.indicadores);
    }
    
    if (area.grupos) {
        area.grupos.forEach(g => {
            // Comprobar si es el grupo de percepci√≥n ambiental para a√±adir aviso
            const esPercepcionAmbiental = g.nombre.toLowerCase().includes('percepci√≥n') && g.nombre.toLowerCase().includes('ambiente');
            
            html += `<div class="grupo-determinantes">
                <div class="grupo-determinantes-titulo">${g.nombre}</div>
                ${g.notaGrupo ? `<div style="background: ${esPercepcionAmbiental ? '#fef2f2' : '#fefce8'}; border-left: 4px solid ${esPercepcionAmbiental ? '#dc2626' : '#eab308'}; padding: 0.5rem 0.75rem; margin-bottom: 0.75rem; font-size: 0.8rem; color: ${esPercepcionAmbiental ? '#991b1b' : '#854d0e'};">
                    <strong>‚ö†Ô∏è</strong> ${g.notaGrupo}
                </div>` : ''}
                ${esPercepcionAmbiental ? generarAvisoPercepcionAmbiental() : ''}
                ${generarTablaIndicadores(g.indicadores)}
            </div>`;
        });
    }
    
    return html;
}

function generarTablaIndicadores(indicadores) {
    let html = `
    <table class="tabla-determinantes">
        <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Indicador</th>
                <th>Tipo</th>
                <th>Territorio</th>
                <th>Granada</th>
                <th>Andaluc√≠a</th>
            </tr>
        </thead>
        <tbody>`;
    
    // Mapeo de tipos de dato a etiquetas legibles
    const tiposEtiqueta = {
        'autorreporte_conducta': '<span title="Conducta autodeclarada" style="font-size:0.7rem;background:#dbeafe;color:#1e40af;padding:0.15rem 0.35rem;border-radius:3px;">Conducta</span>',
        'autorreporte_percepcion': '<span title="Percepci√≥n subjetiva" style="font-size:0.7rem;background:#fef3c7;color:#92400e;padding:0.15rem 0.35rem;border-radius:3px;">Percepci√≥n</span>',
        'escala_validada': '<span title="Escala psicom√©trica validada" style="font-size:0.7rem;background:#d1fae5;color:#065f46;padding:0.15rem 0.35rem;border-radius:3px;">Escala</span>',
        'autorreporte_situacion': '<span title="Situaci√≥n declarada" style="font-size:0.7rem;background:#e0e7ff;color:#3730a3;padding:0.15rem 0.35rem;border-radius:3px;">Situaci√≥n</span>'
    };
    
    indicadores.forEach(ind => {
        // Obtener referencias desde Firebase (variable global)
        const ref = referenciasEAS[ind.codigo] || {};
        const refGranada = ref.refGranada;
        const refAndalucia = ref.refAndalucia;
        
        // Determinar polaridad: 1 = mayor es mejor, -1 = menor es mejor
        const polaridad = ind.polaridad || (ind.texto.toLowerCase().match(/no |poco|triste|solo|desanimado|agotado|problem|riesgo|dificultad|sedent/) ? -1 : 1);
        
        // Tipo de dato
        const tipoDato = ind.tipoDato || 'autorreporte_percepcion';
        const tipoHTML = tiposEtiqueta[tipoDato] || '';
        
        // El valor del municipio empieza vac√≠o, se carga desde Firebase despu√©s
        html += `
        <tr data-codigo="${ind.codigo}" data-tipo-dato="${tipoDato}">
            <td><span class="codigo">${ind.codigo}</span></td>
            <td class="indicador-texto">${ind.texto}${ind.escala ? `<br><span style="font-size:0.7rem;color:#64748b;">Escala: ${ind.escala}</span>` : ''}</td>
            <td style="text-align: center;">${tipoHTML}</td>
            <td style="text-align: center;">
                <input type="number" id="det-${ind.codigo}" class="det-input" step="0.1" placeholder="‚Äî" value=""
                    data-ref-granada="${refGranada !== undefined ? refGranada : ''}"
                    data-ref-andalucia="${refAndalucia !== undefined ? refAndalucia : ''}"
                    data-polaridad="${polaridad}"
                    onchange="actualizarColorDeterminante(this)">
                <span class="unidad">${ind.unidad}</span>
            </td>
            <td class="valor-referencia" id="ref-gr-${ind.codigo}">${refGranada !== undefined ? refGranada + ' ' + ind.unidad : '‚Äî'}</td>
            <td class="valor-referencia" id="ref-and-${ind.codigo}">${refAndalucia !== undefined ? refAndalucia + ' ' + ind.unidad : '‚Äî'}</td>
        </tr>`;
    });
    
    html += `</tbody></table>`;
    return html;
}

// Actualizar color de un determinante seg√∫n comparaci√≥n con referencias
function actualizarColorDeterminante(input) {
    const valor = parseFloat(input.value);
    const refGranada = parseFloat(input.dataset.refGranada);
    const refAndalucia = parseFloat(input.dataset.refAndalucia);
    const polaridad = parseInt(input.dataset.polaridad);
    
    // Reset estilo
    input.style.color = '#333';
    input.style.fontWeight = 'normal';
    input.style.background = 'white';
    
    if (isNaN(valor)) return;
    
    // Polaridad 0 = neutral (ej: horas de sue√±o), no se colorea
    if (polaridad === 0) return;
    
    // Umbral de diferencia significativa (5%)
    const umbral = 0.05;
    
    if (!isNaN(refAndalucia)) {
        const diferencia = (valor - refAndalucia) / refAndalucia;
        
        if (polaridad === 1) {
            // Mayor es mejor (ej: salud buena, energ√≠a, felicidad)
            if (diferencia > umbral) {
                // Mejor que Andaluc√≠a ‚Üí verde
                input.style.color = '#059669';
                input.style.fontWeight = 'bold';
                input.style.background = '#ecfdf5';
            } else if (diferencia < -umbral) {
                // Peor que Andaluc√≠a ‚Üí rojo
                input.style.color = '#dc143c';
                input.style.fontWeight = 'bold';
                input.style.background = '#fef2f2';
            }
        } else if (polaridad === -1) {
            // Menor es mejor (ej: limitaciones, fumadores, problemas)
            if (diferencia < -umbral) {
                // Mejor que Andaluc√≠a (menos problemas) ‚Üí verde
                input.style.color = '#059669';
                input.style.fontWeight = 'bold';
                input.style.background = '#ecfdf5';
            } else if (diferencia > umbral) {
                // Peor que Andaluc√≠a (m√°s problemas) ‚Üí rojo
                input.style.color = '#dc143c';
                input.style.fontWeight = 'bold';
                input.style.background = '#fef2f2';
            }
        }
    }
}

// Actualizar todos los colores de determinantes
function actualizarColoresDeterminantes() {
    document.querySelectorAll('.det-input').forEach(input => {
        if (input.value !== '') {
            actualizarColorDeterminante(input);
        }
    });
}

function mostrarAreaDet(areaId) {
    document.querySelectorAll('.determinantes-area').forEach(a => a.classList.remove('activa'));
    document.querySelectorAll('.determinantes-tab').forEach(t => t.classList.remove('activo'));
    document.getElementById('det-' + areaId).classList.add('activa');
    event.target.classList.add('activo');
}

function guardarDeterminantes() {
    const municipio = getMunicipioActual();
    const valores = {};
    document.querySelectorAll('.det-input').forEach(input => {
        if (input.value !== '') {
            const codigo = input.id.replace('det-', '');
            valores[codigo] = parseFloat(input.value);
        }
    });
    
    if (Object.keys(valores).length === 0) {
        alert('No hay valores que guardar');
        return;
    }
    
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/determinantes').set(valores)
        .then(() => alert('‚úÖ ' + Object.keys(valores).length + ' valores guardados correctamente'))
        .catch(err => alert('‚ùå Error: ' + err.message));
}

function cargarDeterminantes() {
    const municipio = getMunicipioActual();
    
    // Cargar determinantes desde Firebase para todos los municipios
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/determinantes').once('value', snap => {
        const valores = snap.val() || {};
        // Limpiar todos los inputs primero
        document.querySelectorAll('.det-input').forEach(input => {
            input.value = '';
            input.style.color = '#333';
            input.style.fontWeight = 'normal';
            input.style.background = 'white';
        });
        // Cargar valores guardados
        Object.entries(valores).forEach(([codigo, data]) => {
            const input = document.getElementById('det-' + codigo);
            if (input) {
                // Manejar tanto formato {valor: X} como valor directo
                const valor = typeof data === 'object' ? data.valor : data;
                if (valor !== null && valor !== undefined) input.value = valor;
            }
        });
        // Aplicar colores seg√∫n comparaci√≥n con referencias
        actualizarColoresDeterminantes();
    });
}

function exportarDeterminantesCSV() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    let csv = 'Codigo;Indicador;Valor_' + nombre + ';Unidad\n';
    
    document.querySelectorAll('.det-input').forEach(input => {
        const codigo = input.id.replace('det-', '');
        const valor = input.value || '';
        const unidad = input.nextElementSibling?.textContent || '';
        const fila = input.closest('tr');
        const texto = fila?.querySelector('.indicador-texto')?.textContent || '';
        csv += `${codigo};"${texto}";${valor};${unidad}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'determinantes_' + municipio + '.csv';
    a.click();
}

// =====================================================
// PANEL DE CARGA DE DATOS - FUNCIONES
// =====================================================

function togglePanelCargaDatos() {
    const panel = document.getElementById('panel-carga-datos');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    if (panel.style.display === 'block') {
        actualizarEstadosCarga();
    }
}

function cambiarTabCarga(seccion, tab) {
    document.querySelectorAll('#' + seccion + '-csv, #' + seccion + '-texto').forEach(el => el.classList.remove('activo'));
    document.getElementById(seccion + '-' + tab).classList.add('activo');
    
    const tabs = document.querySelectorAll('#panel-carga-datos .panel-carga-seccion');
    tabs.forEach(sec => {
        if (sec.querySelector('#' + seccion + '-csv') || sec.querySelector('#' + seccion + '-texto')) {
            sec.querySelectorAll('.carga-tab').forEach(t => t.classList.remove('activo'));
            event.target.classList.add('activo');
        }
    });
}

function actualizarEstadosCarga() {
    const municipio = getMunicipioActual();
    
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio).once('value', snap => {
        const datos = snap.val() || {};
        
        // Informe
        const estadoInforme = document.getElementById('estado-informe');
        if (estadoInforme) {
            if (datos.informe && datos.informe.htmlCompleto) {
                estadoInforme.innerHTML = '<span class="estado-ok">‚úÖ Cargado</span>';
            } else {
                estadoInforme.innerHTML = '<span class="estado-pendiente">‚è≥ Sin cargar</span>';
            }
        }
        
        // Indicadores
        const estadoIndicadores = document.getElementById('estado-indicadores');
        if (estadoIndicadores) {
            if (datos.indicadores && Object.keys(datos.indicadores).length > 0) {
                estadoIndicadores.innerHTML = '<span class="estado-ok">‚úÖ ' + Object.keys(datos.indicadores).length + ' indicadores</span>';
            } else {
                estadoIndicadores.innerHTML = '<span class="estado-pendiente">‚è≥ Sin cargar</span>';
            }
        }
        
        // Determinantes
        const estadoDeterminantes = document.getElementById('estado-determinantes');
        if (estadoDeterminantes) {
            if (datos.determinantes && Object.keys(datos.determinantes).length > 0) {
                const numDet = Object.keys(datos.determinantes).length;
                const TOTAL_ESPERADO = 55;
                if (numDet >= TOTAL_ESPERADO) {
                    estadoDeterminantes.innerHTML = '<span class="estado-ok">‚úÖ ' + numDet + '/' + TOTAL_ESPERADO + '</span>';
                } else {
                    estadoDeterminantes.innerHTML = '<span class="estado-warning">‚ö†Ô∏è ' + numDet + '/' + TOTAL_ESPERADO + '</span>';
                }
            } else {
                estadoDeterminantes.innerHTML = '<span class="estado-pendiente">‚è≥ Sin cargar</span>';
            }
        }
        
        // Conclusiones
        const estadoConclusiones = document.getElementById('estado-conclusiones');
        if (estadoConclusiones) {
            if (datos.conclusiones && Object.keys(datos.conclusiones).length > 0) {
                estadoConclusiones.innerHTML = '<span class="estado-ok">‚úÖ ' + Object.keys(datos.conclusiones).length + ' conclusiones</span>';
            } else {
                estadoConclusiones.innerHTML = '<span class="estado-pendiente">‚è≥ Sin cargar</span>';
            }
        }
        
        // Recomendaciones
        const estadoRecomendaciones = document.getElementById('estado-recomendaciones');
        if (estadoRecomendaciones) {
            if (datos.recomendaciones && Object.keys(datos.recomendaciones).length > 0) {
                estadoRecomendaciones.innerHTML = '<span class="estado-ok">‚úÖ ' + Object.keys(datos.recomendaciones).length + ' recomendaciones</span>';
            } else {
                estadoRecomendaciones.innerHTML = '<span class="estado-pendiente">‚è≥ Sin cargar</span>';
            }
        }
        
        // Priorizaci√≥n
        const estadoPriorizacion = document.getElementById('estado-priorizacion');
        if (estadoPriorizacion) {
            if (datos.priorizacion) {
                const numAreas = datos.priorizacion.areas ? Object.keys(datos.priorizacion.areas).length : 0;
                estadoPriorizacion.innerHTML = numAreas > 0 
                    ? '<span class="estado-ok">‚úÖ ' + numAreas + ' √°reas</span>'
                    : '<span class="estado-ok">‚úÖ Configurada</span>';
            } else {
                estadoPriorizacion.innerHTML = '<span class="estado-pendiente">‚è≥ Sin cargar</span>';
            }
        }
        
        // Programas
        const estadoProgramas = document.getElementById('estado-programas');
        if (estadoProgramas) {
            if (datos.programas && Object.keys(datos.programas).length > 0) {
                estadoProgramas.innerHTML = '<span class="estado-ok">‚úÖ ' + Object.keys(datos.programas).length + ' programas</span>';
            } else {
                estadoProgramas.innerHTML = '<span class="estado-pendiente">‚è≥ Sin cargar</span>';
            }
        }
    });
    
    // Tambi√©n verificar estado de referencias (globales, no por municipio)
    const estadoReferencias = document.getElementById('estado-referencias');
    if (estadoReferencias) {
        db.ref('referencias').once('value', snap => {
            const refs = snap.val();
            if (refs && Object.keys(refs).length > 0) {
                estadoReferencias.innerHTML = '<span class="estado-ok">‚úÖ ' + Object.keys(refs).length + ' referencias</span>';
            } else {
                estadoReferencias.innerHTML = '<span class="estado-pendiente">‚è≥ Sin cargar</span>';
            }
        });
    }
    
    // Actualizar badges de Fase 4 (Plan local de salud)
    actualizarBadgesFase4();
}

// Funci√≥n para actualizar los badges de datos en Fase 4
function actualizarBadgesFase4() {
    const municipio = getMunicipioActual();
    if (!municipio) return;
    
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio).once('value', snap => {
        const datos = snap.val() || {};
        
        const TOTAL_DET = 55;
        const estiloOk = 'background:#d1fae5;color:#94d40b;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;';
        const estiloWarning = 'background:#fff9e6;color:#ff6600;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;';
        const estiloPendiente = 'background:#fee2e2;color:#991b1b;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.75rem;';
        
        // Badge Informe
        const badgeInforme = document.getElementById('badge-informe');
        if (badgeInforme) {
            if (datos.informe && datos.informe.htmlCompleto) {
                badgeInforme.style.cssText = estiloOk;
                badgeInforme.textContent = 'üìÑ Informe: ‚úÖ';
            } else {
                badgeInforme.style.cssText = estiloPendiente;
                badgeInforme.textContent = 'üìÑ Informe: ‚ùå';
            }
        }
        
        // Badge Determinantes
        const badgeDet = document.getElementById('badge-determinantes');
        if (badgeDet) {
            if (datos.determinantes) {
                const numDet = Object.keys(datos.determinantes).length;
                if (numDet >= TOTAL_DET) {
                    badgeDet.style.cssText = estiloOk;
                    badgeDet.textContent = 'üìä Determinantes: ' + numDet + '/' + TOTAL_DET;
                } else {
                    badgeDet.style.cssText = estiloWarning;
                    badgeDet.textContent = 'üìä Determinantes: ' + numDet + '/' + TOTAL_DET;
                }
            } else {
                badgeDet.style.cssText = estiloPendiente;
                badgeDet.textContent = 'üìä Determinantes: 0/' + TOTAL_DET;
            }
        }
        
        // Badge Conclusiones
        const badgeConc = document.getElementById('badge-conclusiones');
        if (badgeConc) {
            if (datos.conclusiones && Object.keys(datos.conclusiones).length > 0) {
                badgeConc.style.cssText = estiloOk;
                badgeConc.textContent = 'üí° Conclusiones: ' + Object.keys(datos.conclusiones).length;
            } else {
                badgeConc.style.cssText = estiloPendiente;
                badgeConc.textContent = 'üí° Conclusiones: 0';
            }
        }
        
        // Badge Priorizaci√≥n
        const badgePrio = document.getElementById('badge-priorizacion');
        if (badgePrio) {
            if (datos.priorizacion && datos.priorizacion.areas) {
                const numAreas = Object.keys(datos.priorizacion.areas).length;
                badgePrio.style.cssText = estiloOk;
                badgePrio.textContent = 'üó≥Ô∏è Priorizaci√≥n: ' + numAreas + ' √°reas';
            } else {
                badgePrio.style.cssText = estiloPendiente;
                badgePrio.textContent = 'üó≥Ô∏è Priorizaci√≥n: ‚ùå';
            }
        }
    });
}

// Borrar todos los datos del municipio actual en Firebase
function borrarDatosMunicipio() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    if (!confirm('‚ö†Ô∏è ¬øEst√° seguro de borrar TODOS los datos de ' + nombre + '?\n\nEsto eliminar√°:\n‚Ä¢ Informe epidemiol√≥gico\n‚Ä¢ Indicadores\n‚Ä¢ Determinantes\n‚Ä¢ Conclusiones y recomendaciones\n‚Ä¢ Priorizaci√≥n\n‚Ä¢ Programas\n\nEsta acci√≥n NO se puede deshacer.')) {
        return;
    }
    
    // Borrar datos del municipio
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio).remove()
        .then(() => {
            // Limpiar tambi√©n las referencias si se desea
            // (comentado porque son comunes a todos los municipios)
            // return db.ref('referencias').remove();
            return Promise.resolve();
        })
        .then(() => {
            alert('‚úÖ Datos de ' + nombre + ' eliminados correctamente.\nLa p√°gina se recargar√°.');
            // Recargar para mostrar estado vac√≠o
            location.reload();
        })
        .catch(err => {
            alert('‚ùå Error al borrar datos: ' + err.message);
        });
}

// Borrar solo las referencias (Granada/Andaluc√≠a)
function borrarReferencias() {
    if (!confirm('‚ö†Ô∏è ¬øBorrar las referencias de Granada y Andaluc√≠a?\n\nEstas referencias son comunes a todos los municipios.')) {
        return;
    }
    
    db.ref('referencias').remove()
        .then(() => {
            referenciasEAS = {}; // Limpiar variable global
            alert('‚úÖ Referencias eliminadas. Recarga la p√°gina.');
            location.reload();
        })
        .catch(err => alert('‚ùå Error: ' + err.message));
}

// Cargar informe Word (.docx)
function cargarInformeWord(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Usamos mammoth.js para convertir Word a HTML
    const reader = new FileReader();
    reader.onload = function(e) {
        const arrayBuffer = e.target.result;
        
        // Verificar si mammoth est√° disponible
        if (typeof mammoth !== 'undefined') {
            mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                .then(function(result) {
                    guardarInformeHTML(result.value, file.name);
                })
                .catch(function(err) {
                    alert('‚ùå Error al procesar Word: ' + err.message);
                });
        } else {
            // Cargar mammoth.js din√°micamente
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js';
            script.onload = function() {
                mammoth.convertToHtml({arrayBuffer: arrayBuffer})
                    .then(function(result) {
                        guardarInformeHTML(result.value, file.name);
                    })
                    .catch(function(err) {
                        alert('‚ùå Error al procesar Word: ' + err.message);
                    });
            };
            document.head.appendChild(script);
        }
    };
    reader.readAsArrayBuffer(file);
}

function guardarInformeHTML(contenidoHTML, nombreArchivo) {
    const municipio = getMunicipioActual();
    
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/informe').set({
        htmlCompleto: contenidoHTML,
        fechaCarga: new Date().toISOString(),
        nombreArchivo: nombreArchivo
    }).then(() => {
        document.getElementById('estado-informe').innerHTML = '<span class="estado-ok">‚úÖ Cargado: ' + nombreArchivo + '</span>';
        alert('‚úÖ Informe cargado correctamente');
        actualizarMunicipio();
        
        // Regenerar y guardar perfil en el compilador
        setTimeout(() => {
            cargarDatosMunicipioFirebase(municipio, function(datos) {
                if (datos && datos.informe && datos.informe.htmlCompleto) {
                    const nombre = MUNICIPIOS[municipio] ? MUNICIPIOS[municipio].nombre : municipio;
                    const perfilHTML = generarPerfilDesdeFirebase(datos, nombre);
                    guardarPerfilParaCompilador(perfilHTML);
                    console.log('‚úÖ Perfil actualizado en el compilador');
                }
            });
        }, 500);
    }).catch(err => {
        document.getElementById('estado-informe').innerHTML = '<span class="estado-error">‚ùå Error</span>';
        alert('‚ùå Error: ' + err.message);
    });
}

// =====================================================
// FUNCI√ìN CENTRALIZADA DE PARSING CSV
// =====================================================
// Esta funci√≥n unifica el parsing de todos los tipos de CSV
// Tipos soportados: indicadores, determinantes, conclusiones, recomendaciones, priorizacion, programas, referencias

/**
 * Valida la estructura de un archivo CSV antes de procesarlo
 * @param {string} contenido - Contenido del archivo CSV
 * @param {string} tipo - Tipo esperado de CSV
 * @returns {Object} - { valido: boolean, error: string|null, advertencias: [], columnas: number, filas: number }
 */
function validarCSV(contenido, tipo) {
    const resultado = {
        valido: true,
        error: null,
        advertencias: [],
        columnas: 0,
        filas: 0,
        tipoDetectado: null
    };
    
    if (!contenido) {
        resultado.valido = false;
        resultado.error = 'El archivo est√° vac√≠o';
        return resultado;
    }
    
    const lineas = contenido.split('\n').filter(l => l.trim());
    resultado.filas = lineas.length - 1; // Sin cabecera
    
    if (lineas.length < 2) {
        resultado.valido = false;
        resultado.error = 'El archivo no tiene datos (solo cabecera o vac√≠o)';
        return resultado;
    }
    
    // Verificar que usa punto y coma como separador
    const cabecera = lineas[0];
    if (!cabecera.includes(';')) {
        // Verificar si usa coma
        if (cabecera.includes(',')) {
            resultado.valido = false;
            resultado.error = 'El archivo usa coma como separador. COMP√ÅS requiere punto y coma (;)';
            return resultado;
        }
        resultado.advertencias.push('La cabecera no parece tener separadores de columna');
    }
    
    const columnasEsperadas = {
        'indicadores': { min: 2, nombres: ['numero', 'indicador'] },
        'determinantes': { min: 3, nombres: ['codigo'] }, // Reducido a 3 para formato simple
        'conclusiones': { min: 2, nombres: ['numero', 'texto'] },
        'recomendaciones': { min: 2, nombres: ['numero', 'recomendacion'] },
        'priorizacion': { min: 3, nombres: ['numero', 'areaprioritaria'] },
        'programas': { min: 3, nombres: ['codigo', 'nombre', 'ambito'] },
        'referencias': { min: 6, nombres: ['area', 'codigo', 'refgranada'] }
    };
    
    const cols = cabecera.split(';');
    resultado.columnas = cols.length;
    
    // Detectar tipo autom√°ticamente si no se especific√≥
    resultado.tipoDetectado = detectarTipoCSV(contenido);
    
    // Verificar columnas m√≠nimas seg√∫n tipo
    if (tipo && columnasEsperadas[tipo]) {
        const esperado = columnasEsperadas[tipo];
        if (cols.length < esperado.min) {
            resultado.advertencias.push(`Se esperaban al menos ${esperado.min} columnas para ${tipo}, se encontraron ${cols.length}`);
        }
        
        // Verificar nombres de columnas clave
        const cabeceraLower = cabecera.toLowerCase();
        const columnasEncontradas = esperado.nombres.filter(n => cabeceraLower.includes(n));
        if (columnasEncontradas.length < esperado.nombres.length / 2) {
            resultado.advertencias.push(`La cabecera no parece corresponder al tipo "${tipo}"`);
            if (resultado.tipoDetectado && resultado.tipoDetectado !== tipo) {
                resultado.advertencias.push(`El archivo parece ser de tipo "${resultado.tipoDetectado}"`);
            }
        }
    }
    
    // Verificar consistencia de columnas en las filas
    let columnasInconsistentes = 0;
    lineas.slice(1).forEach((linea, idx) => {
        const colsLinea = linea.split(';').length;
        if (colsLinea !== cols.length && linea.trim()) {
            columnasInconsistentes++;
        }
    });
    
    if (columnasInconsistentes > 0) {
        resultado.advertencias.push(`${columnasInconsistentes} fila(s) tienen n√∫mero de columnas diferente a la cabecera`);
    }
    
    return resultado;
}

/**
 * Parsea un contenido CSV y devuelve datos estructurados seg√∫n el tipo
 * @param {string} contenido - Contenido del archivo CSV
 * @param {string} tipo - Tipo de CSV: indicadores|determinantes|conclusiones|recomendaciones|priorizacion|programas|referencias
 * @returns {Object} - { datos: {}, referencias: {}, contador: number, error: string|null }
 */
function parsearCSV(contenido, tipo) {
    const resultado = {
        datos: {},
        referencias: {},  // Solo para determinantes con refs Granada/Andaluc√≠a
        contador: 0,
        error: null,
        validacion: null
    };
    
    if (!contenido || !tipo) {
        resultado.error = 'Contenido o tipo no especificado';
        return resultado;
    }
    
    // Validar estructura antes de parsear
    const validacion = validarCSV(contenido, tipo);
    resultado.validacion = validacion;
    
    if (!validacion.valido) {
        resultado.error = validacion.error;
        return resultado;
    }
    
    const lineas = contenido.split('\n');
    if (lineas.length < 2) {
        resultado.error = 'El archivo est√° vac√≠o o no tiene datos';
        return resultado;
    }
    
    // Detectar si tiene cabecera v√°lida (primera l√≠nea)
    const cabecera = lineas[0]?.toLowerCase() || '';
    
    try {
        switch (tipo) {
            case 'indicadores':
                // Formato: Numero;Indicador;Valor;Unidad;TendenciaObservada;TendenciaDeseada
                lineas.forEach((linea, idx) => {
                    if (idx === 0 || !linea.trim()) return;
                    const cols = linea.split(';');
                    if (cols.length >= 2 && cols[0].trim()) {
                        const num = cols[0].trim();
                        resultado.datos[num] = {
                            nombre: cols[1]?.replace(/"/g, '').trim() || '',
                            dato: cols[2]?.trim() || '',
                            unidad: cols[3]?.trim() || '',
                            tendenciaObservada: cols[4]?.trim() || '',
                            tendenciaDeseada: cols[5]?.trim() || ''
                        };
                        resultado.contador++;
                    }
                });
                break;
                
            case 'determinantes':
                // Detectar formato seg√∫n cabecera
                // Formato nuevo con referencias: Area;Codigo;Pregunta;Unidad;ValorMunicipio;RefGranada;RefAndalucia
                // Formato antiguo 5 cols: Area;Codigo;Pregunta;Escala;Valor
                // Formato simple 4 cols: Codigo;Indicador;Valor;Unidad
                const tieneReferencias = cabecera.includes('granada') || cabecera.includes('andalucia') || cabecera.includes('refgranada');
                
                // Detectar formato simple: primera columna es "codigo" (no "area")
                const primeraColumna = cabecera.split(';')[0]?.trim().toLowerCase() || '';
                const esFormatoSimple = primeraColumna === 'codigo' || primeraColumna === 'c√≥digo';
                
                console.log('üìä Parseo determinantes:', { cabecera: cabecera.substring(0, 50), primeraColumna, esFormatoSimple, tieneReferencias });
                
                lineas.forEach((linea, idx) => {
                    if (idx === 0 || !linea.trim()) return;
                    const cols = linea.split(';');
                    
                    if (esFormatoSimple && cols.length >= 3) {
                        // Formato simple: Codigo;Indicador;Valor;Unidad
                        const codigo = cols[0]?.trim();
                        if (codigo) {
                            resultado.datos[codigo] = {
                                area: '',
                                codigo: codigo,
                                pregunta: cols[1]?.replace(/"/g, '').trim() || '',
                                unidad: cols[3]?.trim() || '%',
                                valor: cols[2]?.trim() ? parseFloat(cols[2].replace(',', '.')) : null
                            };
                            resultado.contador++;
                        }
                    } else if (cols.length >= 3 && cols[1]?.trim()) {
                        const codigo = cols[1].trim();
                        
                        if (tieneReferencias && cols.length >= 7) {
                            // Formato nuevo con referencias
                            resultado.datos[codigo] = {
                                area: cols[0]?.trim() || '',
                                codigo: codigo,
                                pregunta: cols[2]?.trim() || '',
                                unidad: cols[3]?.trim() || '',
                                valor: cols[4]?.trim() ? parseFloat(cols[4].replace(',', '.')) : null
                            };
                            // Guardar referencias separadamente
                            const refGranada = cols[5]?.trim() ? parseFloat(cols[5].replace(',', '.')) : null;
                            const refAndalucia = cols[6]?.trim() ? parseFloat(cols[6].replace(',', '.')) : null;
                            if (refGranada !== null || refAndalucia !== null) {
                                resultado.referencias[codigo] = {
                                    refGranada: refGranada,
                                    refAndalucia: refAndalucia
                                };
                            }
                        } else {
                            // Formato antiguo sin referencias
                            resultado.datos[codigo] = {
                                area: cols[0]?.trim() || '',
                                codigo: codigo,
                                pregunta: cols[2]?.trim() || '',
                                escala: cols[3]?.trim() || '',
                                valor: cols[4]?.trim() ? parseFloat(cols[4].replace(',', '.')) : null
                            };
                        }
                        resultado.contador++;
                    }
                });
                break;
                
            case 'conclusiones':
            case 'recomendaciones':
                // Formato: Numero;Texto (puede tener m√°s columnas, se concatenan)
                lineas.forEach((linea, idx) => {
                    if (idx === 0 || !linea.trim()) return;
                    const cols = linea.split(';');
                    if (cols.length >= 2) {
                        const num = cols[0].trim();
                        const texto = cols.slice(1).join(';').replace(/^"|"$/g, '').trim();
                        if (texto) {
                            resultado.datos[num] = texto;
                            resultado.contador++;
                        }
                    }
                });
                break;
                
            case 'priorizacion':
                // Formato: Numero;AreaPrioritaria;Problema;Justificacion;ProgramasRelacionados;Indicador;Meta
                const areas = {};
                lineas.forEach((linea, idx) => {
                    if (idx === 0 || !linea.trim()) return;
                    const cols = linea.split(';');
                    if (cols.length >= 2 && cols[0].trim()) {
                        const num = cols[0].trim();
                        areas[num] = {
                            areaPrioritaria: cols[1]?.trim() || '',
                            problema: cols[2]?.trim() || '',
                            justificacion: cols[3]?.trim() || '',
                            programasRelacionados: cols[4]?.trim().split('|').map(p => p.trim()).filter(p => p) || [],
                            indicador: cols[5]?.trim() || '',
                            meta: cols[6]?.trim() || ''
                        };
                        resultado.contador++;
                    }
                });
                resultado.datos = { areas: areas, fechaCarga: new Date().toISOString() };
                break;
                
            case 'programas':
                // Formato: Codigo;Nombre;Ambito;Descripcion;PoblacionDiana;Objetivos;Actuaciones
                lineas.forEach((linea, idx) => {
                    if (idx === 0 || !linea.trim()) return;
                    const cols = linea.split(';');
                    if (cols.length >= 2 && cols[0].trim()) {
                        const codigo = cols[0].trim();
                        resultado.datos[codigo] = {
                            codigo: codigo,
                            nombre: cols[1]?.trim() || '',
                            ambito: cols[2]?.trim() || '',
                            descripcion: cols[3]?.trim() || '',
                            poblacionDiana: cols[4]?.trim() || '',
                            objetivos: cols[5]?.trim().split('|').map(o => o.trim()).filter(o => o) || [],
                            actuaciones: cols[6]?.trim().split('|').map(a => a.trim()).filter(a => a) || []
                        };
                        resultado.contador++;
                    }
                });
                break;
                
            case 'referencias':
                // Formato: Area;Codigo;Pregunta;Unidad;RefGranada;RefAndalucia
                lineas.forEach((linea, idx) => {
                    if (idx === 0 || !linea.trim()) return;
                    const cols = linea.split(';');
                    if (cols.length >= 6 && cols[1]?.trim()) {
                        const codigo = cols[1].trim();
                        resultado.datos[codigo] = {
                            area: cols[0]?.trim() || '',
                            codigo: codigo,
                            pregunta: cols[2]?.trim() || '',
                            unidad: cols[3]?.trim() || '',
                            refGranada: cols[4]?.trim() ? parseFloat(cols[4].replace(',', '.')) : null,
                            refAndalucia: cols[5]?.trim() ? parseFloat(cols[5].replace(',', '.')) : null
                        };
                        resultado.contador++;
                    }
                });
                break;
                
            default:
                resultado.error = 'Tipo de CSV no reconocido: ' + tipo;
        }
    } catch (e) {
        resultado.error = 'Error parseando CSV: ' + e.message;
    }
    
    return resultado;
}

/**
 * Detecta autom√°ticamente el tipo de CSV por su cabecera
 * @param {string} contenido - Contenido del archivo CSV
 * @returns {string|null} - Tipo detectado o null si no se reconoce
 */
function detectarTipoCSV(contenido) {
    if (!contenido) return null;
    
    const cabecera = contenido.split('\n')[0]?.toLowerCase() || '';
    
    // Detectar por palabras clave en cabecera
    if (cabecera.includes('indicador') && cabecera.includes('unidadmedida')) return 'indicadores';
    if (cabecera.includes('determinante') || (cabecera.includes('codigo') && cabecera.includes('pregunta'))) return 'determinantes';
    if (cabecera.includes('conclusion') || (cabecera.includes('numero') && cabecera.includes('texto'))) return 'conclusiones';
    if (cabecera.includes('recomendacion')) return 'recomendaciones';
    if (cabecera.includes('areaprioritaria') || cabecera.includes('problema')) return 'priorizacion';
    if (cabecera.includes('ambito') && cabecera.includes('poblaciondiana')) return 'programas';
    if (cabecera.includes('refgranada') && cabecera.includes('refandalucia') && !cabecera.includes('valormunicipio')) return 'referencias';
    
    return null;
}

// =====================================================
// FUNCIONES DE CARGA DE CSV (usando parsearCSV central)
// =====================================================

// Cargar determinantes desde CSV (usa parsearCSV central)
function cargarDeterminantesCSV(input) {
    const file = input.files[0];
    if (!file) return;
    
    const TOTAL_ESPERADO = 55; // Total de determinantes esperados seg√∫n EPVSA
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const resultado = parsearCSV(e.target.result, 'determinantes');
        
        if (resultado.error) {
            alert('‚ùå ' + resultado.error);
            return;
        }
        
        if (resultado.contador === 0) {
            alert('‚ùå No se encontraron determinantes v√°lidos en el CSV');
            return;
        }
        
        const municipio = getMunicipioActual();
        
        // Guardar determinantes del municipio
        db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/determinantes').set(resultado.datos)
            .then(() => {
                // Si hay referencias, guardarlas usando funci√≥n unificada
                if (Object.keys(resultado.referencias).length > 0) {
                    return guardarReferenciasEAS(resultado.referencias, true); // merge = true
                }
                return true;
            })
            .then(() => {
                const tieneRefs = Object.keys(resultado.referencias).length > 0;
                const faltan = TOTAL_ESPERADO - resultado.contador;
                
                // Mensaje de estado seg√∫n completitud
                let estadoHTML, alertMsg;
                if (resultado.contador >= TOTAL_ESPERADO) {
                    estadoHTML = '<span class="estado-ok">‚úÖ ' + resultado.contador + '/' + TOTAL_ESPERADO + ' determinantes</span>';
                    alertMsg = '‚úÖ ' + resultado.contador + ' determinantes cargados correctamente';
                } else {
                    estadoHTML = '<span class="estado-warning">‚ö†Ô∏è ' + resultado.contador + '/' + TOTAL_ESPERADO + ' (faltan ' + faltan + ')</span>';
                    alertMsg = '‚ö†Ô∏è ' + resultado.contador + '/' + TOTAL_ESPERADO + ' determinantes cargados (faltan ' + faltan + ')';
                }
                
                if (tieneRefs) {
                    alertMsg += '\n+ referencias Granada/Andaluc√≠a incluidas';
                }
                
                document.getElementById('estado-determinantes').innerHTML = estadoHTML;
                alert(alertMsg);
                actualizarMunicipio();
            })
            .catch(err => alert('‚ùå Error: ' + err.message));
    };
    reader.readAsText(file);
}

// Cargar indicadores desde CSV (usa parsearCSV central)
function cargarIndicadoresCSV(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const resultado = parsearCSV(e.target.result, 'indicadores');
        
        if (resultado.error) {
            alert('‚ùå ' + resultado.error);
            return;
        }
        
        if (resultado.contador === 0) {
            alert('‚ùå No se encontraron indicadores v√°lidos en el CSV');
            return;
        }
        
        const municipio = getMunicipioActual();
        db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/indicadores').set(resultado.datos)
            .then(() => {
                document.getElementById('estado-indicadores').innerHTML = '<span class="estado-ok">‚úÖ ' + resultado.contador + ' indicadores</span>';
                alert('‚úÖ ' + resultado.contador + ' indicadores cargados');
                actualizarMunicipio();
            }).catch(err => alert('‚ùå Error: ' + err.message));
    };
    reader.readAsText(file);
}

// Cargar conclusiones desde CSV (usa parsearCSV central)
function cargarConclusionesCSV(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const resultado = parsearCSV(e.target.result, 'conclusiones');
        
        if (resultado.error) {
            alert('‚ùå ' + resultado.error);
            return;
        }
        
        if (resultado.contador === 0) {
            alert('‚ùå No se encontraron conclusiones v√°lidas en el CSV');
            return;
        }
        
        const municipio = getMunicipioActual();
        db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/conclusiones').set(resultado.datos)
            .then(() => {
                document.getElementById('estado-conclusiones').innerHTML = '<span class="estado-ok">‚úÖ ' + resultado.contador + ' conclusiones</span>';
                alert('‚úÖ ' + resultado.contador + ' conclusiones cargadas');
                actualizarMunicipio();
            }).catch(err => alert('‚ùå Error: ' + err.message));
    };
    reader.readAsText(file);
}

// Guardar conclusiones desde textarea
function guardarConclusionesTexto() {
    const texto = document.getElementById('textarea-conclusiones').value.trim();
    if (!texto) {
        alert('Escriba al menos una conclusi√≥n');
        return;
    }
    
    const lineas = texto.split('\n').filter(l => l.trim());
    const conclusiones = {};
    
    lineas.forEach((linea, idx) => {
        conclusiones[idx + 1] = linea.replace(/^\d+[\.\)\-]\s*/, '').trim();
    });
    
    const municipio = getMunicipioActual();
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/conclusiones').set(conclusiones)
        .then(() => {
            document.getElementById('estado-conclusiones').innerHTML = '<span class="estado-ok">‚úÖ ' + Object.keys(conclusiones).length + ' conclusiones</span>';
            alert('‚úÖ Conclusiones guardadas');
            actualizarMunicipio();
        }).catch(err => alert('‚ùå Error: ' + err.message));
}

// Cargar recomendaciones desde CSV (usa parsearCSV central)
function cargarRecomendacionesCSV(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const resultado = parsearCSV(e.target.result, 'recomendaciones');
        
        if (resultado.error) {
            alert('‚ùå ' + resultado.error);
            return;
        }
        
        if (resultado.contador === 0) {
            alert('‚ùå No se encontraron recomendaciones v√°lidas en el CSV');
            return;
        }
        
        const municipio = getMunicipioActual();
        db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/recomendaciones').set(resultado.datos)
            .then(() => {
                document.getElementById('estado-recomendaciones').innerHTML = '<span class="estado-ok">‚úÖ ' + resultado.contador + ' recomendaciones</span>';
                alert('‚úÖ ' + resultado.contador + ' recomendaciones cargadas');
                actualizarMunicipio();
            }).catch(err => alert('‚ùå Error: ' + err.message));
    };
    reader.readAsText(file);
}

// Guardar recomendaciones desde textarea
function guardarRecomendacionesTexto() {
    const texto = document.getElementById('textarea-recomendaciones').value.trim();
    if (!texto) {
        alert('Escriba al menos una recomendaci√≥n');
        return;
    }
    
    const lineas = texto.split('\n').filter(l => l.trim());
    const recomendaciones = {};
    
    lineas.forEach((linea, idx) => {
        recomendaciones[idx + 1] = linea.replace(/^\d+[\.\)\-]\s*/, '').trim();
    });
    
    const municipio = getMunicipioActual();
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/recomendaciones').set(recomendaciones)
        .then(() => {
            document.getElementById('estado-recomendaciones').innerHTML = '<span class="estado-ok">‚úÖ ' + Object.keys(recomendaciones).length + ' recomendaciones</span>';
            alert('‚úÖ Recomendaciones guardadas');
            actualizarMunicipio();
        }).catch(err => alert('‚ùå Error: ' + err.message));
}

// Cargar priorizaci√≥n desde CSV (usa parsearCSV central)
function cargarPriorizacionCSV(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const resultado = parsearCSV(e.target.result, 'priorizacion');
        
        if (resultado.error) {
            alert('‚ùå ' + resultado.error);
            return;
        }
        
        // Para priorizaci√≥n, el contador est√° en resultado.datos.areas
        const numAreas = resultado.datos.areas ? Object.keys(resultado.datos.areas).length : 0;
        
        if (numAreas === 0) {
            alert('‚ùå No se encontraron √°reas de priorizaci√≥n v√°lidas');
            return;
        }
        
        const municipio = getMunicipioActual();
        db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/priorizacion').set(resultado.datos)
            .then(() => {
                document.getElementById('estado-priorizacion').innerHTML = '<span class="estado-ok">‚úÖ ' + numAreas + ' √°reas</span>';
                alert('‚úÖ ' + numAreas + ' √°reas de priorizaci√≥n cargadas');
                actualizarMunicipio();
            }).catch(err => alert('‚ùå Error: ' + err.message));
    };
    reader.readAsText(file);
}

// Guardar priorizaci√≥n desde formulario
function guardarPriorizacionTexto() {
    const fechaSesion = document.getElementById('input-fecha-priorizacion').value.trim();
    const ejeCentral = document.getElementById('input-eje-central').value.trim();
    const textoAdicional = document.getElementById('textarea-priorizacion').value.trim();
    
    const lineas = {};
    [1, 2, 3, 4].forEach(num => {
        const checkbox = document.getElementById('prio-linea-' + num);
        if (checkbox && checkbox.checked) {
            const nombres = {
                1: 'Promoci√≥n de h√°bitos de vida saludable',
                2: 'Responsabilidad social empresarial en salud',
                3: 'Informaci√≥n y comunicaci√≥n',
                4: 'Formaci√≥n, investigaci√≥n e innovaci√≥n'
            };
            lineas[num] = { seleccionada: true, nombre: nombres[num] };
        }
    });
    
    if (Object.keys(lineas).length === 0) {
        alert('Seleccione al menos una l√≠nea estrat√©gica');
        return;
    }
    
    const priorizacion = { lineas, fechaSesion, ejeCentral, textoAdicional };
    
    const municipio = getMunicipioActual();
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/priorizacion').set(priorizacion)
        .then(() => {
            document.getElementById('estado-priorizacion').innerHTML = '<span class="estado-ok">‚úÖ Configurada</span>';
            alert('‚úÖ Priorizaci√≥n guardada');
            actualizarMunicipio();
        }).catch(err => alert('‚ùå Error: ' + err.message));
}

// Cargar programas desde CSV (usa parsearCSV central)
function cargarProgramasCSV(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const resultado = parsearCSV(e.target.result, 'programas');
        
        if (resultado.error) {
            alert('‚ùå ' + resultado.error);
            return;
        }
        
        if (resultado.contador === 0) {
            alert('‚ùå No se encontraron programas v√°lidos');
            return;
        }
        
        const municipio = getMunicipioActual();
        db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/programas').set(resultado.datos)
            .then(() => {
                const estadoProgramas = document.getElementById('estado-programas');
                if (estadoProgramas) {
                    estadoProgramas.innerHTML = '<span class="estado-ok">‚úÖ ' + resultado.contador + ' programas</span>';
                }
                alert('‚úÖ ' + resultado.contador + ' programas cargados');
                actualizarMunicipio();
            }).catch(err => alert('‚ùå Error: ' + err.message));
    };
    reader.readAsText(file);
}

// =====================================================
// CARGA MASIVA DE CSV
// =====================================================
// Detecta tipo y municipio por nombre de archivo: tipo_municipio.csv

// =====================================================
// MUNICIPIOS Y TIPOS DE DATOS
// =====================================================
// Lista de municipios conocidos (se pueden a√±adir m√°s aqu√≠)
// Formato: 'alias': 'clave-firebase'

const MUNICIPIOS_VALIDOS = {
    // Municipios del Distrito Granada Metropolitano
    'agron': 'agron',
    'albolote': 'albolote',
    'albunuelas': 'albunuelas',
    'alfacar': 'alfacar',
    'algarinejo': 'algarinejo',
    'alhama-de-granada': 'alhama-de-granada',
    'alhama': 'alhama-de-granada',
    'alhendin': 'alhendin',
    'arenas-del-rey': 'arenas-del-rey',
    'arenas': 'arenas-del-rey',
    'armilla': 'armilla',
    'atarfe': 'atarfe',
    'benalua-de-las-villas': 'benalua-de-las-villas',
    'benalua': 'benalua-de-las-villas',
    'cacin': 'cacin',
    'cajar': 'cajar',
    'calicasas': 'calicasas',
    'campotejar': 'campotejar',
    'cenes-de-la-vega': 'cenes-de-la-vega',
    'cenes': 'cenes-de-la-vega',
    'chauchina': 'chauchina',
    'chimeneas': 'chimeneas',
    'churriana-de-la-vega': 'churriana-de-la-vega',
    'churriana': 'churriana-de-la-vega',
    'cijuela': 'cijuela',
    'cogollos-vega': 'cogollos-vega',
    'cogollos': 'cogollos-vega',
    'colomera': 'colomera',
    'cullar-vega': 'cullar-vega',
    'cullar': 'cullar-vega',
    'deifontes': 'deifontes',
    'dilar': 'dilar',
    'dudar': 'dudar',
    'durcal': 'durcal',
    'el-pinar': 'el-pinar',
    'pinar': 'el-pinar',
    'el-valle': 'el-valle',
    'valle': 'el-valle',
    'escuzar': 'escuzar',
    'fuente-vaqueros': 'fuente-vaqueros',
    'fuentevaqueros': 'fuente-vaqueros',
    'gobernador': 'gobernador',
    'gojar': 'gojar',
    // Distritos de Granada ciudad
    'granada-albaicin': 'granada-albaicin',
    'albaicin': 'granada-albaicin',
    'granada-beiro': 'granada-beiro',
    'beiro': 'granada-beiro',
    'granada-centro': 'granada-centro',
    'granada-chana': 'granada-chana',
    'chana': 'granada-chana',
    'granada-genil': 'granada-genil',
    'genil': 'granada-genil',
    'granada-norte': 'granada-norte',
    'norte': 'granada-norte',
    'granada-ronda': 'granada-ronda',
    'ronda': 'granada-ronda',
    'granada-zaidin': 'granada-zaidin',
    'zaidin': 'granada-zaidin',
    // Resto de municipios
    'guadahortuna': 'guadahortuna',
    'guejar-sierra': 'guejar-sierra',
    'guejar': 'guejar-sierra',
    'guevejar': 'guevejar',
    'huetor-tajar': 'huetor-tajar',
    'huetor-vega': 'huetor-vega',
    'illora': 'illora',
    'iznalloz': 'iznalloz',
    'jayena': 'jayena',
    'la-malaha': 'la-malaha',
    'malaha': 'la-malaha',
    'la-zubia': 'la-zubia',
    'zubia': 'la-zubia',
    'lachar': 'lachar',
    'las-gabias': 'las-gabias',
    'gabias': 'las-gabias',
    'lecrin': 'lecrin',
    'loja': 'loja',
    // Mancomunidades
    'mancomunidad-alhama': 'mancomunidad-alhama',
    'mancomunidad-lecrin': 'mancomunidad-lecrin',
    // Resto
    'maracena': 'maracena',
    'moclin': 'moclin',
    'monachil': 'monachil',
    'montefrio': 'montefrio',
    'montejicar': 'montejicar',
    'montillana': 'montillana',
    'moraleda-de-zafayona': 'moraleda-de-zafayona',
    'moraleda': 'moraleda-de-zafayona',
    'niguelas': 'niguelas',
    'nivar': 'nivar',
    'ogijares': 'ogijares',
    'otura': 'otura',
    'padul': 'padul',
    'peligros': 'peligros',
    'pinos-genil': 'pinos-genil',
    'pinos-puente': 'pinos-puente',
    'pulianas': 'pulianas',
    'quentar': 'quentar',
    'salar': 'salar',
    'santa-cruz-del-comercio': 'santa-cruz-del-comercio',
    'santa-fe': 'santa-fe',
    'santafe': 'santa-fe',
    'torre-cardela': 'torre-cardela',
    'vegas-del-genil': 'vegas-del-genil',
    'vegasdelgenil': 'vegas-del-genil',
    'ventas-de-huelma': 'ventas-de-huelma',
    'villamena': 'villamena',
    'villanueva-mesia': 'villanueva-mesia',
    'viznar': 'viznar',
    'zafarraya': 'zafarraya',
    'zagra': 'zagra'
};

// Funci√≥n para normalizar nombre de municipio (quita acentos, espacios, etc.)
function normalizarMunicipio(nombre) {
    return nombre.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // quitar acentos
        .replace(/\s+/g, '-') // espacios a guiones
        .replace(/[^a-z0-9-]/g, ''); // solo letras, n√∫meros y guiones
}

// Funci√≥n para detectar municipio de un nombre de archivo
// Si no est√° en la lista, intenta extraerlo del nombre
function detectarMunicipio(nombreArchivo) {
    const nombreLower = nombreArchivo.toLowerCase();
    
    // Primero buscar en la lista conocida
    for (const [alias, key] of Object.entries(MUNICIPIOS_VALIDOS)) {
        if (nombreLower.includes(alias)) {
            return key;
        }
    }
    
    // Si no est√° en la lista, intentar extraer del nombre
    // Patr√≥n: tipo_municipio.csv o municipio_tipo.csv
    const sinExtension = nombreLower.replace('.csv', '').replace('.docx', '');
    const partes = sinExtension.split('_');
    
    for (const parte of partes) {
        // Ignorar si es un tipo conocido
        if (TIPOS_CSV.includes(parte)) continue;
        if (parte === 'informe' || parte === 'referencias') continue;
        
        // Si tiene al menos 3 caracteres, asumirlo como municipio
        if (parte.length >= 3) {
            return normalizarMunicipio(parte);
        }
    }
    
    return null;
}

const TIPOS_CSV = ['indicadores', 'determinantes', 'conclusiones', 'recomendaciones', 'priorizacion', 'programas'];

function cargaMasivaCSV(input) {
    const files = Array.from(input.files);
    if (files.length === 0) return;
    
    const logEl = document.getElementById('carga-masiva-log');
    const resumenEl = document.getElementById('carga-masiva-resumen');
    logEl.style.display = 'block';
    logEl.innerHTML = '';
    resumenEl.style.display = 'none';
    
    const log = (msg, tipo = 'info') => {
        const colores = { info: '#94a3b8', ok: '#10b981', error: '#dc143c', warn: '#f59e0b' };
        logEl.innerHTML += `<div style="color: ${colores[tipo]}; margin: 0.25rem 0;">${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    };
    
    log(`üì¶ Iniciando carga masiva de ${files.length} archivo(s)...`);
    
    const resultados = { ok: 0, error: 0, detalles: [] };
    let procesados = 0;
    
    files.forEach(file => {
        const nombre = file.name.toLowerCase().replace('.csv', '');
        const partes = nombre.split('_');
        
        // Detectar si es archivo de referencias (no tiene municipio)
        if (nombre.includes('referencias') || nombre === 'referencias_eas') {
            log(`üìÑ ${file.name} ‚Üí Archivo de REFERENCIAS (Granada/Andaluc√≠a)`);
            const reader = new FileReader();
            reader.onload = function(e) {
                procesarCSVReferencias(e.target.result, file.name, resultados, log, () => {
                    procesados++;
                    checkFin();
                });
            };
            reader.onerror = function() {
                log(`‚ùå ${file.name}: Error de lectura`, 'error');
                resultados.error++;
                procesados++;
                checkFin();
            };
            reader.readAsText(file);
            return;
        }
        
        // Detectar tipo y municipio
        let tipo = null, municipioKey = null;
        
        for (const t of TIPOS_CSV) {
            if (nombre.includes(t)) {
                tipo = t;
                break;
            }
        }
        
        // Usar la nueva funci√≥n de detecci√≥n de municipio
        municipioKey = detectarMunicipio(file.name);
        
        if (!tipo) {
            log(`‚ö†Ô∏è ${file.name}: No se detect√≥ tipo (indicadores, conclusiones, etc.)`, 'warn');
            resultados.error++;
            procesados++;
            checkFin();
            return;
        }
        
        if (!municipioKey) {
            log(`‚ö†Ô∏è ${file.name}: No se detect√≥ municipio. Usa formato: tipo_municipio.csv`, 'warn');
            resultados.error++;
            procesados++;
            checkFin();
            return;
        }
        
        log(`üìÑ ${file.name} ‚Üí Tipo: ${tipo}, Municipio: ${municipioKey}`);
        
        // Leer y procesar archivo
        const reader = new FileReader();
        reader.onload = function(e) {
            const contenido = e.target.result;
            procesarCSVMasivo(tipo, municipioKey, contenido, file.name, resultados, log, () => {
                procesados++;
                checkFin();
            });
        };
        reader.onerror = function() {
            log(`‚ùå ${file.name}: Error de lectura`, 'error');
            resultados.error++;
            procesados++;
            checkFin();
        };
        reader.readAsText(file);
    });
    
    function checkFin() {
        if (procesados === files.length) {
            log(`\n‚úÖ Carga masiva completada: ${resultados.ok} OK, ${resultados.error} errores`, resultados.error > 0 ? 'warn' : 'ok');
            
            // Mostrar resumen
            resumenEl.style.display = 'block';
            resumenEl.innerHTML = `
                <h4 style="margin: 0 0 0.5rem 0; color: #1e293b;">üìä Resumen de carga</h4>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div style="background: #10b98120; color: #00acd9; padding: 0.5rem 1rem; border-radius: 6px;">
                        <strong>${resultados.ok}</strong> archivos cargados
                    </div>
                    ${resultados.error > 0 ? `<div style="background: #dc143c20; color: #dc143c; padding: 0.5rem 1rem; border-radius: 6px;">
                        <strong>${resultados.error}</strong> errores
                    </div>` : ''}
                </div>
                <p style="margin: 1rem 0 0 0; font-size: 0.9rem; color: #64748b;">
                    Seleccione un municipio en el desplegable superior para ver los datos cargados.
                </p>
            `;
            
            // Recargar vista actual y sincronizar estados del panel
            actualizarMunicipio();
            actualizarEstadosCarga();
        }
    }
}

// Procesar CSV de referencias (usa parsearCSV central)
function procesarCSVReferencias(contenido, nombreArchivo, resultados, log, callback) {
    try {
        const resultado = parsearCSV(contenido, 'referencias');
        
        if (resultado.error) {
            log(`‚ùå ${nombreArchivo}: ${resultado.error}`, 'error');
            resultados.error++;
            callback();
            return;
        }
        
        if (resultado.contador === 0) {
            log(`‚ùå ${nombreArchivo}: No se encontraron referencias v√°lidas`, 'error');
            resultados.error++;
            callback();
            return;
        }
        
        // Guardar en Firebase bajo /referencias usando funci√≥n unificada
        guardarReferenciasEAS(resultado.datos, false)
            .then(() => {
                log(`‚úÖ ${nombreArchivo}: ${resultado.contador} referencias cargadas (Granada/Andaluc√≠a)`, 'ok');
                resultados.ok++;
                callback();
            })
            .catch(err => {
                log(`‚ùå ${nombreArchivo}: Error al guardar - ${err.message}`, 'error');
                resultados.error++;
                callback();
            });
    } catch (e) {
        log(`‚ùå ${nombreArchivo}: Error procesando - ${e.message}`, 'error');
        resultados.error++;
        callback();
    }
}

// Procesar CSV en carga masiva (usa parsearCSV central)
function procesarCSVMasivo(tipo, municipio, contenido, nombreArchivo, resultados, log, callback) {
    try {
        const resultado = parsearCSV(contenido, tipo);
        
        if (resultado.error) {
            log(`‚ùå ${nombreArchivo}: ${resultado.error}`, 'error');
            resultados.error++;
            callback();
            return;
        }
        
        // Para priorizaci√≥n, el contador real est√° en resultado.datos.areas
        const contador = tipo === 'priorizacion' 
            ? (resultado.datos.areas ? Object.keys(resultado.datos.areas).length : 0)
            : resultado.contador;
        
        if (contador === 0) {
            log(`‚ö†Ô∏è ${nombreArchivo}: No se encontraron datos v√°lidos`, 'warn');
            resultados.error++;
            callback();
            return;
        }
        
        // Guardar en Firebase
        db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/' + tipo).set(resultado.datos)
            .then(() => {
                // Si es determinantes y tiene referencias, guardarlas usando funci√≥n unificada
                if (tipo === 'determinantes' && Object.keys(resultado.referencias).length > 0) {
                    return guardarReferenciasEAS(resultado.referencias, true).then(() => {
                        log(`   üìä ${Object.keys(resultado.referencias).length} referencias Granada/Andaluc√≠a actualizadas`, 'ok');
                        return true;
                    });
                }
                return true;
            })
            .then(() => {
                log(`‚úÖ ${nombreArchivo}: ${contador} registros ‚Üí ${municipio}/${tipo}`, 'ok');
                resultados.ok++;
                resultados.detalles.push({ archivo: nombreArchivo, municipio, tipo, registros: contador });
                callback();
            })
            .catch(err => {
                log(`‚ùå ${nombreArchivo}: Error Firebase - ${err.message}`, 'error');
                resultados.error++;
                callback();
            });
            
    } catch (err) {
        log(`‚ùå ${nombreArchivo}: Error procesando - ${err.message}`, 'error');
        resultados.error++;
        callback();
    }
}

// =====================================================

// Descargar plantillas
function descargarPlantillaIndicadores() {
    let csv = 'Numero;Indicador;Valor;Unidad;TendenciaObservada;TendenciaDeseada\n';
    csv += '1;Personas con Consumo de Alcohol de alto riesgo;198;N;‚ñ≤;‚ñº\n';
    csv += '2;Personas con Dependencia otras sustancias;24;N;‚ñ≤;‚ñº\n';
    csv += '3;Autonom√≠a funcional (65 y m√°s a√±os);86.5;%;‚ñ≤;‚ñ≤\n';
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'plantilla_indicadores.csv';
    a.click();
}

function descargarPlantillaConclusiones() {
    let csv = 'Conclusion\n';
    csv += '"Los trastornos de ansiedad aparecen entre las causas de morbilidad m√°s frecuentes"\n';
    csv += '"La Estrategia es una oportunidad para incorporarse a una herramienta validada"\n';
    csv += '"El enfoque de Salud comunitaria basada en activos es el m√°s adecuado"\n';
    csv += '"La planificaci√≥n requiere datos que no siempre est√°n disponibles a nivel municipal"\n';
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'plantilla_conclusiones.csv';
    a.click();
}

function descargarPlantillaRecomendaciones() {
    let csv = 'Recomendacion\n';
    csv += '"Establecer el bienestar emocional como eje central articulador del Plan"\n';
    csv += '"Acompasar el dise√±o y la evaluaci√≥n del Plan a la Estrategia EPVSA"\n';
    csv += '"Promover el Mapeo continuo de activos y la Recomendaci√≥n social"\n';
    csv += '"Realizar la II Encuesta local de salud durante el periodo de ejecuci√≥n del Plan"\n';
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'plantilla_recomendaciones.csv';
    a.click();
}

function descargarPlantillaDeterminantes() {
    let csv = 'Codigo;Indicador;Valor;Unidad\n';
    csv += 'P7;"Salud percibida buena o muy buena";69.3;%\n';
    csv += 'P7b;"Salud mental buena o muy buena";62.1;%\n';
    csv += 'P23;"Fumadores diarios";20.8;%\n';
    csv += 'P29;"Consumo de riesgo de alcohol";1.9;%\n';
    csv += 'P33a;"Descanso suficiente";51.2;%\n';
    csv += 'P34a_nada;"No realiza ejercicio";40.5;%\n';
    csv += 'PREDIMED;"Alta adherencia dieta mediterr√°nea";20.4;%\n';
    csv += 'DUKE_bajo;"Apoyo social bajo";14.3;%\n';
    csv += 'P57b1;"Se siente deprimido frecuentemente";16.2;%\n';
    csv += 'P57b3;"Se siente solo frecuentemente";13.7;%\n';
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'plantilla_determinantes.csv';
    a.click();
}

function descargarPlantillaPriorizacion() {
    let csv = 'Campo;Valor;Descripcion\n';
    csv += 'fecha;febrero 2026;Fecha de la sesi√≥n de priorizaci√≥n\n';
    csv += 'eje;Percepci√≥n de calidad de vida y bienestar emocional;Eje central del plan\n';
    csv += 'linea1;1;Promoci√≥n de h√°bitos de vida saludable\n';
    csv += 'linea2;0;Responsabilidad social empresarial en salud\n';
    csv += 'linea3;1;Informaci√≥n y comunicaci√≥n\n';
    csv += 'linea4;1;Formaci√≥n investigaci√≥n e innovaci√≥n\n';
    csv += 'texto;Texto adicional opcional;Cualquier texto adicional\n';
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'plantilla_priorizacion.csv';
    a.click();
}

function guardarTodoFirebase() {
    alert('Los datos ya se guardan autom√°ticamente en Firebase al cargar cada secci√≥n.\n\nUsa el bot√≥n "Recargar vista" para ver los cambios aplicados.');
}

/**
 * Guarda la configuraci√≥n del Marco estrat√©gico en Firebase
 */
function guardarConfigMarco() {
    const municipioKey = getMunicipioActual();
    if (!municipioKey || !db) return;
    
    const config = {
        anioInforme: parseInt(document.getElementById('config-anio-informe')?.value) || new Date().getFullYear(),
        anioEncuesta: parseInt(document.getElementById('config-anio-encuesta')?.value) || (new Date().getFullYear() - 1),
        mesPriorizacion: document.getElementById('config-mes-priorizacion')?.value || 'febrero',
        anioPriorizacion: parseInt(document.getElementById('config-anio-priorizacion')?.value) || new Date().getFullYear(),
        lineasEstrategia: document.getElementById('config-lineas-estrategia')?.value || '1, 3 y 4',
        distrito: document.getElementById('config-distrito')?.value || 'Distrito sanitario Granada-Metropolitano'
    };
    
    const updates = {};
    updates['municipios/' + municipioKey + '/anioInforme'] = config.anioInforme;
    updates['municipios/' + municipioKey + '/anioEncuesta'] = config.anioEncuesta;
    updates['municipios/' + municipioKey + '/mesPriorizacion'] = config.mesPriorizacion;
    updates['municipios/' + municipioKey + '/anioPriorizacion'] = config.anioPriorizacion;
    updates['municipios/' + municipioKey + '/lineasEstrategia'] = config.lineasEstrategia;
    updates['municipios/' + municipioKey + '/distrito'] = config.distrito;
    
    db.ref().update(updates).then(() => {
        console.log('‚úÖ Configuraci√≥n del Marco guardada');
        const estado = document.getElementById('estado-config-marco');
        if (estado) {
            estado.innerHTML = '<span class="estado-ok">‚úÖ Guardado</span>';
        }
        // Actualizar datos locales
        if (datosMunicipioActual) {
            Object.assign(datosMunicipioActual, config);
        }
    }).catch(err => {
        console.error('Error guardando configuraci√≥n:', err);
    });
}

/**
 * Carga la configuraci√≥n del Marco estrat√©gico desde Firebase a los inputs
 */
function cargarConfigMarcoUI() {
    if (!datosMunicipioActual) return;
    
    const campos = {
        'config-anio-informe': datosMunicipioActual.anioInforme || new Date().getFullYear(),
        'config-anio-encuesta': datosMunicipioActual.anioEncuesta || (new Date().getFullYear() - 1),
        'config-mes-priorizacion': datosMunicipioActual.mesPriorizacion || 'febrero',
        'config-anio-priorizacion': datosMunicipioActual.anioPriorizacion || new Date().getFullYear(),
        'config-lineas-estrategia': datosMunicipioActual.lineasEstrategia || '1, 3 y 4',
        'config-distrito': datosMunicipioActual.distrito || 'Distrito sanitario Granada-Metropolitano'
    };
    
    for (const [id, valor] of Object.entries(campos)) {
        const elem = document.getElementById(id);
        if (elem) elem.value = valor;
    }
    
    const estado = document.getElementById('estado-config-marco');
    if (estado) {
        estado.innerHTML = '<span class="estado-ok">‚úÖ Cargado desde Firebase</span>';
    }
}


// =====================================================
// CONTENIDO DIN√ÅMICO - SE CARGA DESDE FIREBASE
// =====================================================
// Los datos de cada municipio se cargan desde Firebase mediante:
// - Informe: archivo Word (.docx) ‚Üí municipios/{key}/informe
// - Indicadores: CSV ‚Üí municipios/{key}/indicadores
// - Determinantes EAS: CSV ‚Üí municipios/{key}/determinantes
// - Conclusiones: edici√≥n directa ‚Üí municipios/{key}/conclusiones  
// - Priorizaci√≥n: edici√≥n directa ‚Üí municipios/{key}/priorizacion
// =====================================================

// =====================================================
// MARCO ESTRAT√âGICO - Plantilla din√°mica
// Aparece en: Tab 2 (Perfil) y Tab plan local de salud
// =====================================================

/**
 * Genera el Marco estrat√©gico con variables din√°micas del municipio
 * @param {Object} config - Configuraci√≥n del municipio
 * @returns {string} HTML del Marco estrat√©gico
 */
function generarMarcoEstrategico(config = {}) {
    const nombre = config.municipio || getNombreMunicipio(getMunicipioActual());
    const distrito = config.distrito || 'Distrito sanitario Granada-Metropolitano';
    const anioInforme = config.anioInforme || new Date().getFullYear();
    const anioEncuesta = config.anioEncuesta || (new Date().getFullYear() - 1);
    const mesPriorizacion = config.mesPriorizacion || 'febrero';
    const anioPriorizacion = config.anioPriorizacion || new Date().getFullYear();
    const lineasEstrategia = config.lineasEstrategia || '1, 3 y 4';
    
    return `<div class="marco-estrategico acordeon-item">
        <div class="acordeon-header" onclick="toggleAcordeon(this)">
            <span>01 Marco estrat√©gico de la acci√≥n local en salud</span>
            <span class="flecha">‚ñº</span>
        </div>
        <div class="acordeon-contenido">
            <p>Este informe ha sido elaborado por profesionales de la <strong>Unidad de Prevenci√≥n, Promoci√≥n y Vigilancia de la Salud</strong> del <strong>${distrito}</strong>, en el marco de la <strong>Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a</strong> (la Estrategia en adelante), que promueve la <strong>Consejer√≠a de Salud y Consumo</strong>, a trav√©s de la <strong>Direcci√≥n General de salud p√∫blica y ordenaci√≥n farmac√©utica</strong>, con el objetivo de mejorar la salud y el bienestar de la poblaci√≥n andaluza, e incluye la informaci√≥n epidemiol√≥gica m√°s reciente y relevante de <strong>${nombre}</strong>, adem√°s de alguna informaci√≥n de utilidad sobre programas de salud y sobre h√°bitos de vida saludable.</p>
            
            <div class="destacado destacado-azul">
                <p>La Estrategia pretende <strong>promover los h√°bitos saludables en toda la poblaci√≥n y edades</strong>, mediante intervenciones en el <strong>√°mbito local</strong>, <strong>en todos los entornos de vida y en todas las pol√≠ticas y actuaciones sobre los determinantes que generan desigualdades en salud</strong>. As√≠ mismo, propone <strong>potenciar los activos personales y comunitarios</strong> que generan salud a lo largo de la vida, para que la ciudadan√≠a pueda afrontar el d√≠a a d√≠a con <strong>mayores cotas de bienestar</strong>.</p>
            </div>
            
            <p>El <strong>Informe sobre la situaci√≥n de salud de ${nombre} (${anioInforme})</strong> y la <strong>Encuesta local de salud de ${nombre} (${anioEncuesta})</strong> han facilitado el paso del diagn√≥stico a la acci√≥n. De acuerdo con lo acordado por el Grupo-Motor en su sesi√≥n de priorizaci√≥n del mes de <strong>${mesPriorizacion} de ${anioPriorizacion}</strong>, se adaptar√° el dise√±o del plan de acci√≥n a las <strong>l√≠neas ${lineasEstrategia}</strong> de la Estrategia, situando la <strong>percepci√≥n de calidad de vida y el bienestar emocional</strong> en el centro neur√°lgico del plan.</p>
            
            <p>Al acompasar el Plan local de salud de ${nombre} a la Estrategia, se incorporan de manera autom√°tica al mismo las <strong>l√≠neas estrat√©gicas</strong>, los <strong>objetivos</strong> seleccionados dentro de cada l√≠nea y los <strong>indicadores de contexto e impacto</strong> vinculados a cada objetivo. Lo que deber√≠a permitir no solo el seguimiento y la evaluaci√≥n, sino tambi√©n la <strong>comparaci√≥n de resultados con otros territorios de referencia</strong>.</p>
            
            <h4 style="margin:1.5rem 0 0.75rem;color:#0074c8;border-bottom:2px solid #94d40b;padding-bottom:0.5rem;">Fuentes de informaci√≥n</h4>
            <p>El informe incorpora una <strong>herramienta para el seguimiento y la evaluaci√≥n</strong>, y se ha construido a partir de informaci√≥n disponible en fuentes oficiales como el <strong>Instituto Nacional de Estad√≠stica (INE)</strong> o el <strong>Instituto de Estad√≠stica y Cartograf√≠a de Andaluc√≠a (IECA)</strong>, as√≠ como tambi√©n en fuentes propias del sistema sanitario P√∫blico de Andaluc√≠a (<strong>INFOWEB, BPS, Registro Andaluz de C√°ncer y el M√≥dulo IAHS de Diraya</strong>).</p>
        </div>
    </div>`;
}

// Versi√≥n simplificada para compatibilidad (se reemplaza por la funci√≥n)
const MARCO_ESTRATEGICO = generarMarcoEstrategico();

// Para el Perfil de salud local, el informe se muestra como acorde√≥n
function getInformeParaPerfil() {
    return `<div class="acordeon-item">
    <div class="acordeon-header" onclick="toggleAcordeon(this)"><span>02 Informe sobre la situaci√≥n de salud</span><span class="flecha">‚ñº</span></div>
    <div class="acordeon-contenido">
        <div class="destacado destacado-rojo">
            <strong>‚ö†Ô∏è Informe pendiente de cargar</strong><br>
            Carga el informe Word en <strong>‚öôÔ∏è Gestionar datos</strong>.
        </div>
    </div>
</div>`;
}

// Esta funci√≥n ya no se usa - todo se carga desde Firebase
function generarContenidoPerfilGenerico() {
    const nombre = getNombreMunicipio(getMunicipioActual());
    return generarPanelSinDatos(nombre);
}

function generarPanelSinDatos(nombre) {
    return `<div class="destacado destacado-rojo">
        <strong>‚ö†Ô∏è Datos pendientes de cargar</strong><br>
        El municipio de ${nombre} a√∫n no tiene datos cargados.<br><br>
        Utiliza el bot√≥n <strong>"‚öôÔ∏è Gestionar datos"</strong> para cargar:
        <ul style="margin:0.5rem 0 0 1.5rem;">
            <li>Informe de Situaci√≥n de Salud (Word)</li>
            <li>Indicadores (CSV)</li>
            <li>Determinantes EAS (CSV)</li>
            <li>Conclusiones y Recomendaciones</li>
            <li>Priorizaci√≥n</li>
        </ul>
    </div>`;
}

// =====================================================
// SISTEMA DE NOTIFICACIONES TOAST
// =====================================================

// ==================== MODAL METODOLOG√çA ====================

function mostrarMetodologia() {
    document.getElementById('modal-metodologia').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function cerrarMetodologia() {
    document.getElementById('modal-metodologia').style.display = 'none';
    document.body.style.overflow = '';
}

// ==================== NOTA METODOL√ìGICA PARA INFORMES ====================

/**
 * Genera la nota metodol√≥gica completa para incluir en informes
 * Cumple requisitos ACSA y est√°ndares de agencias europeas de evaluaci√≥n
 */
function generarNotaMetodologicaInforme() {
    const meta = ESTRUCTURA_DETERMINANTES._metadatos;
    
    return `
    <div class="nota-metodologica" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0; font-size: 0.9rem;">
        <h4 style="color: #1e293b; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.2rem;">üìã</span> Nota metodol√≥gica
        </h4>
        
        <div style="margin-bottom: 1rem;">
            <strong>Fuente de datos:</strong> ${meta.fuente}<br>
            <strong>Metodolog√≠a:</strong> ${meta.metodologia}<br>
            <strong>T√©cnica de recogida:</strong> ${meta.tecnicaRecogida}<br>
            <strong>Procesamiento local:</strong> ${meta.procesamientoLocal}
        </div>
        
        <div style="margin-bottom: 1rem;">
            <strong>Clasificaci√≥n de indicadores por tipo de dato:</strong>
            <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                <li><strong>Autorreporte de conducta:</strong> Conductas autodeclaradas (consumo, ejercicio, alimentaci√≥n). Sujetas a sesgo de deseabilidad social.</li>
                <li><strong>Autorreporte de percepci√≥n:</strong> Valoraciones subjetivas (salud percibida, calidad del entorno). Reflejan experiencia vivida, no mediciones objetivas.</li>
                <li><strong>Escalas validadas:</strong> Instrumentos psicom√©tricos con propiedades establecidas (SF-12, Duke-UNC, CAGE, PREDIMED).</li>
                <li><strong>Autorreporte de situaci√≥n:</strong> Situaciones objetivables declaradas (vivienda, econom√≠a).</li>
            </ul>
        </div>
        
        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.75rem; border-radius: 0 4px 4px 0; margin-bottom: 1rem;">
            <strong>‚ö†Ô∏è Limitaciones:</strong>
            <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0; font-size: 0.85rem;">
                ${meta.limitaciones.map(l => `<li>${l}</li>`).join('')}
            </ul>
        </div>
        
        <div style="font-size: 0.8rem; color: #64748b;">
            <strong>Referencias metodol√≥gicas:</strong><br>
            ${meta.referencias.map(r => `<span style="display: block; margin-left: 1rem;">¬∑ ${r}</span>`).join('')}
        </div>
    </div>`;
}

/**
 * Genera aviso espec√≠fico para indicadores de percepci√≥n ambiental
 */
function generarAvisoPercepcionAmbiental() {
    return `
    <div class="aviso-percepcion" style="background: #fef2f2; border: 1px solid #fecaca; border-left: 4px solid #dc2626; border-radius: 0 8px 8px 0; padding: 1rem; margin: 1rem 0; font-size: 0.85rem;">
        <strong style="color: #dc2626;">‚ö†Ô∏è Importante: Datos de percepci√≥n subjetiva</strong>
        <p style="margin: 0.5rem 0 0 0; color: #7f1d1d;">
            Los indicadores de esta secci√≥n reflejan la <strong>percepci√≥n ciudadana</strong> sobre el medio ambiente de su barrio, 
            obtenida mediante encuesta poblacional. <strong>No son mediciones objetivas</strong> de calidad ambiental.
        </p>
        <p style="margin: 0.5rem 0 0 0; color: #7f1d1d;">
            Para la toma de decisiones sobre intervenciones ambientales, estos datos deben contrastarse con:
        </p>
        <ul style="margin: 0.5rem 0 0 1rem; padding: 0; color: #7f1d1d;">
            <li>Datos de la Red de Vigilancia de la Calidad del Aire de Andaluc√≠a</li>
            <li>Mapas estrat√©gicos de ruido municipales</li>
            <li>Inventarios de zonas verdes y espacios p√∫blicos</li>
            <li>Estad√≠sticas oficiales de seguridad ciudadana</li>
        </ul>
    </div>`;
}

// Cerrar modal metodolog√≠a con Escape o clic fuera
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('modal-metodologia')?.style.display === 'block') {
        cerrarMetodologia();
    }
});

document.addEventListener('click', function(e) {
    if (e.target.id === 'modal-metodologia') {
        cerrarMetodologia();
    }
});

// ==================== SISTEMA DE NOTIFICACIONES ====================

/**
 * Muestra una notificaci√≥n toast
 * @param {Object} options - Opciones de la notificaci√≥n
 * @param {string} options.title - T√≠tulo de la notificaci√≥n
 * @param {string} options.message - Mensaje de la notificaci√≥n
 * @param {string} options.type - Tipo: success|error|warning|info|loading
 * @param {number} options.duration - Duraci√≥n en ms (0 = permanente)
 * @param {boolean} options.showProgress - Mostrar barra de progreso
 * @returns {HTMLElement} - Elemento toast para manipulaci√≥n posterior
 */
function mostrarNotificacion(options = {}) {
    const {
        title = '',
        message = '',
        type = 'info',
        duration = 3000,
        showProgress = true,
        closable = true
    } = options;
    
    const container = document.getElementById('toast-container');
    if (!container) return null;
    
    const iconos = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è',
        loading: '<div class="spinner"></div>'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-icon">${iconos[type] || iconos.info}</div>
        <div class="toast-content">
            ${title ? `<div class="toast-title">${title}</div>` : ''}
            ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
        ${closable ? '<button class="toast-close" onclick="cerrarNotificacion(this.parentElement)">√ó</button>' : ''}
        ${showProgress && duration > 0 ? `<div class="toast-progress"><div class="toast-progress-bar" style="animation-duration: ${duration}ms;"></div></div>` : ''}
    `;
    
    container.appendChild(toast);
    
    // Auto-cerrar despu√©s de la duraci√≥n
    if (duration > 0) {
        setTimeout(() => cerrarNotificacion(toast), duration);
    }
    
    return toast;
}

/**
 * Cierra una notificaci√≥n con animaci√≥n
 * @param {HTMLElement} toast - Elemento toast a cerrar
 */
function cerrarNotificacion(toast) {
    if (!toast || toast.classList.contains('closing')) return;
    
    toast.classList.add('closing');
    setTimeout(() => {
        if (toast.parentElement) {
            toast.parentElement.removeChild(toast);
        }
    }, 300);
}

/**
 * Actualiza una notificaci√≥n existente
 * @param {HTMLElement} toast - Elemento toast a actualizar
 * @param {Object} options - Nuevas opciones
 */
function actualizarNotificacion(toast, options = {}) {
    if (!toast) return;
    
    const { title, message, type } = options;
    
    if (type) {
        toast.className = `toast toast-${type}`;
        const iconEl = toast.querySelector('.toast-icon');
        const iconos = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è', loading: '<div class="spinner"></div>' };
        if (iconEl) iconEl.innerHTML = iconos[type] || iconos.info;
    }
    
    if (title !== undefined) {
        const titleEl = toast.querySelector('.toast-title');
        if (titleEl) titleEl.textContent = title;
    }
    
    if (message !== undefined) {
        const msgEl = toast.querySelector('.toast-message');
        if (msgEl) msgEl.textContent = message;
    }
}

// Funciones de conveniencia para notificaciones r√°pidas
function notificarExito(mensaje, titulo = '√âxito') {
    return mostrarNotificacion({ title: titulo, message: mensaje, type: 'success' });
}

function notificarError(mensaje, titulo = 'Error') {
    return mostrarNotificacion({ title: titulo, message: mensaje, type: 'error', duration: 5000 });
}

function notificarAdvertencia(mensaje, titulo = 'Atenci√≥n') {
    return mostrarNotificacion({ title: titulo, message: mensaje, type: 'warning', duration: 4000 });
}

function notificarInfo(mensaje, titulo = '') {
    return mostrarNotificacion({ title: titulo, message: mensaje, type: 'info' });
}

function notificarCargando(mensaje, titulo = 'Procesando...') {
    return mostrarNotificacion({ title: titulo, message: mensaje, type: 'loading', duration: 0, showProgress: false, closable: false });
}

// =====================================================
// FUNCIONES PRINCIPALES
// =====================================================

// Funciones principales
function getMunicipioActual() { return document.getElementById('municipio').value; }
function getNombreMunicipio(key) { return MUNICIPIOS[key]?.nombre || key.charAt(0).toUpperCase() + key.slice(1).replace(/-/g, ' '); }

// Cargar municipios disponibles desde Firebase y actualizar selector
function cargarMunicipiosDisponibles() {
    const select = document.getElementById('municipio');
    const territorios = TERRITORIOS[estrategiaActual];
    
    if (!territorios) {
        console.warn('‚ö†Ô∏è No hay territorios definidos para:', estrategiaActual);
        return;
    }
    
    // Primero cargar los municipios de TERRITORIOS (siempre disponibles)
    select.innerHTML = `<option value="">${territorios.placeholder}</option>`;
    
    territorios.items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = item.nombre;
        select.appendChild(option);
    });
    
    console.log('üìç Municipios cargados de TERRITORIOS para ' + estrategiaActual + ':', territorios.items.length);
    
    // Luego intentar a√±adir municipios adicionales de Firebase (si los hay)
    db.ref('estrategias/' + estrategiaActual + '/municipios').once('value', snap => {
        const data = snap.val();
        if (!data) return;
        
        const opcionesActuales = Array.from(select.options).map(o => o.value);
        let a√±adidos = 0;
        
        Object.keys(data).forEach(muni => {
            if (!opcionesActuales.includes(muni)) {
                const option = document.createElement('option');
                option.value = muni;
                option.textContent = data[muni].nombre || getNombreMunicipio(muni);
                select.appendChild(option);
                a√±adidos++;
            }
        });
        
        if (a√±adidos > 0) {
            console.log('üìç Municipios adicionales de Firebase:', a√±adidos);
            // Reordenar alfab√©ticamente
            const options = Array.from(select.options);
            const placeholderOpt = options.shift();
            options.sort((a, b) => a.textContent.localeCompare(b.textContent));
            select.innerHTML = '';
            select.appendChild(placeholderOpt);
            options.forEach(opt => select.appendChild(opt));
        }
    });
}

// Versi√≥n async para usar con await (a√±ade municipio espec√≠fico si no existe)
async function cargarMunicipiosDisponiblesAsync(municipioNuevo) {
    const select = document.getElementById('municipio');
    
    // Primero a√±adir el municipio nuevo si no existe en el selector
    const opcionesActuales = Array.from(select.options).map(o => o.value);
    if (municipioNuevo && !opcionesActuales.includes(municipioNuevo)) {
        const option = document.createElement('option');
        option.value = municipioNuevo;
        option.textContent = getNombreMunicipio(municipioNuevo);
        select.appendChild(option);
        console.log('  ‚ûï Municipio nuevo a√±adido al selector:', municipioNuevo);
        
        // Ordenar opciones alfab√©ticamente
        const options = Array.from(select.options);
        options.sort((a, b) => a.textContent.localeCompare(b.textContent));
        select.innerHTML = '';
        options.forEach(opt => select.appendChild(opt));
    }
    
    return municipioNuevo;
}

// =====================================================
// GESTI√ìN UNIFICADA DE REFERENCIAS EAS (Granada/Andaluc√≠a)
// =====================================================

/**
 * Guarda referencias EAS en Firebase y actualiza la variable global
 * Funci√≥n unificada para uso desde cualquier flujo de carga
 * @param {Object} referencias - Objeto con las referencias {codigo: {refGranada, refAndalucia, ...}}
 * @param {boolean} merge - Si true, hace update (merge). Si false, hace set (reemplaza todo)
 * @returns {Promise} - Promesa que resuelve cuando se completa el guardado
 */
function guardarReferenciasEAS(referencias, merge = true) {
    return new Promise((resolve, reject) => {
        if (!referencias || Object.keys(referencias).length === 0) {
            console.log('‚ö†Ô∏è guardarReferenciasEAS: No hay referencias para guardar');
            resolve();
            return;
        }
        
        console.log(`üì§ Guardando ${Object.keys(referencias).length} referencias en Firebase (merge: ${merge})`);
        // Mostrar ejemplo de datos
        const ejemplo = Object.entries(referencias)[0];
        if (ejemplo) {
            console.log(`   Ejemplo: ${ejemplo[0]} =>`, ejemplo[1]);
        }
        
        const operacion = merge 
            ? db.ref('referencias').update(referencias)
            : db.ref('referencias').set(referencias);
        
        operacion
            .then(() => {
                // Actualizar variable global
                if (merge) {
                    Object.assign(referenciasEAS, referencias);
                } else {
                    referenciasEAS = referencias;
                }
                console.log(`‚úÖ Referencias EAS ${merge ? 'actualizadas' : 'guardadas'}:`, Object.keys(referencias).length, 'indicadores');
                console.log(`   Total en memoria ahora:`, Object.keys(referenciasEAS).length);
                // Actualizar UI si est√° visible
                actualizarCeldasReferencia();
                resolve();
            })
            .catch(err => {
                console.error('‚ùå Error guardando referencias EAS:', err);
                reject(err);
            });
    });
}

// Cargar referencias EAS (Granada y Andaluc√≠a) desde Firebase
function cargarReferenciasEAS(callback, forzarRecarga = false) {
    console.log('üì• cargarReferenciasEAS llamada. forzarRecarga:', forzarRecarga, 'refs en memoria:', Object.keys(referenciasEAS).length);
    
    // Si ya est√°n cargadas y no se fuerza recarga, usar la cach√©
    if (!forzarRecarga && Object.keys(referenciasEAS).length > 0) {
        console.log('   Usando cach√© de referencias');
        actualizarCeldasReferencia();
        if (callback) callback();
        return;
    }
    
    console.log('   Cargando desde Firebase...');
    db.ref('referencias').once('value', snap => {
        const data = snap.val();
        if (data) {
            referenciasEAS = data;
            console.log('‚úÖ Referencias EAS cargadas desde Firebase:', Object.keys(referenciasEAS).length, 'indicadores');
            // Mostrar algunos c√≥digos como ejemplo
            const codigos = Object.keys(referenciasEAS).slice(0, 5);
            console.log('   Ejemplo c√≥digos:', codigos.join(', '));
            // Actualizar las celdas de la tabla con los nuevos valores
            actualizarCeldasReferencia();
        } else {
            console.log('‚ö†Ô∏è No hay referencias EAS en Firebase. Carga el CSV de referencias.');
        }
        if (callback) callback();
    }, error => {
        console.error('‚ùå Error cargando referencias desde Firebase:', error);
        if (callback) callback();
    });
}

// Actualizar celdas de referencia Granada/Andaluc√≠a en la tabla de determinantes
function actualizarCeldasReferencia() {
    const inputs = document.querySelectorAll('.det-input');
    let celdasActualizadas = 0;
    
    if (inputs.length === 0) {
        console.log('‚ö†Ô∏è No hay inputs de determinantes en el DOM');
        return;
    }
    
    console.log('üîÑ Actualizando celdas de referencia. Inputs encontrados:', inputs.length);
    console.log('   Referencias EAS disponibles:', Object.keys(referenciasEAS).length);
    
    inputs.forEach(input => {
        const codigo = input.id.replace('det-', '');
        const ref = referenciasEAS[codigo];
        const tr = input.closest('tr');
        
        if (tr && ref) {
            const celdas = tr.querySelectorAll('.valor-referencia');
            const unidadSpan = input.nextElementSibling;
            const unidad = unidadSpan ? unidadSpan.textContent.trim() : '%';
            
            if (celdas[0] && ref.refGranada !== null && ref.refGranada !== undefined) {
                celdas[0].textContent = ref.refGranada + ' ' + unidad;
                celdasActualizadas++;
            }
            if (celdas[1] && ref.refAndalucia !== null && ref.refAndalucia !== undefined) {
                celdas[1].textContent = ref.refAndalucia + ' ' + unidad;
                celdasActualizadas++;
            }
        }
    });
    
    console.log('üìä Celdas de referencia actualizadas:', celdasActualizadas);
}

function actualizarMunicipio() {
    console.log('========================================');
    console.log('üîÑ actualizarMunicipio() INICIO');
    const key = getMunicipioActual();
    
    // Si no hay municipio seleccionado, mostrar mensaje inicial
    if (!key) {
        console.log('  ‚ö†Ô∏è No hay municipio seleccionado');
        const mensajeInicial = `
            <div class="panel-gestion">
                <h3>üìç Seleccione un territorio</h3>
                <p>Selecciona un territorio en el desplegable superior para comenzar o carga un paquete ZIP.</p>
            </div>`;
        document.getElementById('contenido-informe-dinamico').innerHTML = mensajeInicial;
        // Tab 2 nuevo: no sobreescribir, solo limpiar secciones
        limpiarSeccionesPerfil();
        document.querySelectorAll('.nombre-municipio-dinamico').forEach(el => el.textContent = 'del territorio');
        return;
    }
    
    const nombre = getNombreMunicipio(key);
    console.log('  Municipio:', key, '/', nombre);
    
    // *** RESETEAR EL COMPILADOR AL CAMBIAR DE MUNICIPIO ***
    resetearPlanLocal();
    
    // *** LIMPIAR INPUTS DE DETERMINANTES ***
    document.querySelectorAll('.det-input').forEach(input => input.value = '');
    
    document.querySelectorAll('.nombre-municipio-dinamico').forEach(el => el.textContent = nombre);
    
    // Mostrar carga con mensaje unificado
    const mensajeCarga = '<div class="panel-gestion"><p>‚è≥ Cargando datos de ' + nombre + '...</p></div>';
    document.getElementById('contenido-informe-dinamico').innerHTML = mensajeCarga;
    // Tab 2 nuevo: no sobreescribir durante carga
    
    // Primero cargar referencias, luego datos del municipio
    cargarReferenciasEAS(function() {
        // Cargar datos desde Firebase
        cargarDatosMunicipioFirebase(key, function(datos) {
            let perfilHTML = '';
            // Siempre cargar el perfil con los datos disponibles (aunque est√©n vac√≠os)
            datos = datos || {};
            document.getElementById('contenido-informe-dinamico').innerHTML = generarInformeDesdeFirebase(datos, nombre, true);
            // Nuevo perfil modular: poblar secciones individuales
            poblarPerfilNuevo(datos, nombre);
            perfilHTML = generarPerfilDesdeFirebase(datos, nombre); // para compilador PDF
        
        // Cargar determinantes en los inputs si hay
        if (datos.determinantes) {
            // Funci√≥n para poblar los inputs de determinantes
            const poblarDeterminantes = function() {
                let inputsEncontrados = 0;
                let valoresCargados = 0;
                Object.entries(datos.determinantes).forEach(([codigo, data]) => {
                    const input = document.getElementById('det-' + codigo);
                    if (input) {
                        inputsEncontrados++;
                        // Manejar tanto formato {valor: X} como valor directo
                        const valor = typeof data === 'object' ? data.valor : data;
                        if (valor !== null && valor !== undefined) {
                            input.value = valor;
                            valoresCargados++;
                            // Actualizar color del input
                            actualizarColorDeterminante(input);
                        }
                    }
                });
                console.log(`üìä Determinantes municipales: ${valoresCargados}/${inputsEncontrados} inputs poblados`);
                // Actualizar tambi√©n las celdas de referencia
                actualizarCeldasReferencia();
            };
            
            // Intentar poblar ahora, y tambi√©n con delay por si el DOM no est√° listo
            setTimeout(poblarDeterminantes, 100);
            setTimeout(poblarDeterminantes, 500);
        } else {
            // Aunque no haya datos de determinantes, actualizar celdas de referencia
            setTimeout(actualizarCeldasReferencia, 300);
        }
        
        // *** NOTA: El perfil se guarda autom√°ticamente si hay informe cargado ***
        // Esto permite que el Tab plan local de salud muestre el estado correcto
        
        // *** CARGAR CONFIGURACI√ìN DEL MARCO EN UI ***
        cargarConfigMarcoUI();
        
        // *** CARGAR CUADRO DE MANDOS INTEGRAL ***
        setTimeout(function() {
            const cuadroContainer = document.getElementById('cuadro-mandos-contenido');
            if (cuadroContainer) {
                const indicadores = datos && datos.indicadores ? datos.indicadores : null;
                cuadroContainer.innerHTML = generarCuadroMandosIntegral(indicadores);
            }
        }, 500);
        
        // *** ACTUALIZAR BADGES DE FASE 4 ***
        actualizarBadgesFase4();
        
        // *** GUARDAR PERFIL SI HAY INFORME ***
        if (datos && datos.informe && datos.informe.htmlCompleto) {
            setTimeout(function() {
                guardarPerfilParaCompilador(perfilHTML);
                console.log('‚úÖ Perfil cargado en compilador desde Firebase');
            }, 600);
        }
    });
    }); // Cierre de cargarReferenciasEAS callback
    
    // Cargar datos de participaci√≥n ciudadana si existen
    cargarParticipacionCiudadana(key);
    cargarDecisionPriorizacion(key);
    
    cargarMiembros();
    inicializarHojaRuta();
    cerrarTodosLosPaneles();
    
    // *** VERIFICAR Y GENERAR AN√ÅLISIS AUTOM√ÅTICO ***
    // Si hay datos base pero faltan conclusiones/recomendaciones/priorizaci√≥n, generarlas
    setTimeout(verificarYGenerarAnalisisAutomatico, 1000);
}

// =====================================================
// GENERACI√ìN AUTOM√ÅTICA DE AN√ÅLISIS
// Si hay determinantes+indicadores pero faltan conclusiones/recomendaciones/priorizaci√≥n,
// las genera autom√°ticamente usando el motor de an√°lisis salutog√©nico
// =====================================================

async function verificarYGenerarAnalisisAutomatico() {
    const municipio = getMunicipioActual();
    if (!municipio) return;
    
    // Verificar que tenemos datos cargados en memoria
    if (!datosMunicipioActual) return;
    
    const datos = datosMunicipioActual;
    
    // Verificar datos base: necesitamos al menos determinantes O indicadores
    const tieneDeterminantes = datos.determinantes && Object.keys(datos.determinantes).length > 0;
    const tieneIndicadores = datos.indicadores && Object.keys(datos.indicadores).length > 0;
    
    // Si no hay datos base, no podemos generar an√°lisis
    if (!tieneDeterminantes && !tieneIndicadores) {
        console.log('üìä Sin datos base para an√°lisis autom√°tico');
        return;
    }
    
    // Verificar qu√© falta
    const tieneConclusiones = datos.conclusiones && Object.keys(datos.conclusiones).length > 0;
    const tieneRecomendaciones = datos.recomendaciones && Object.keys(datos.recomendaciones).length > 0;
    const tienePriorizacion = datos.priorizacion && (
        (typeof datos.priorizacion === 'object' && Object.keys(datos.priorizacion).length > 0) ||
        (datos.priorizacion.areas && Object.keys(datos.priorizacion.areas).length > 0)
    );
    
    // Si ya tiene todo, no hacer nada
    if (tieneConclusiones && tieneRecomendaciones && tienePriorizacion) {
        console.log('üìä Datos completos (grupo motor) - no se genera autom√°ticamente');
        return;
    }
    
    console.log('üìä Generando an√°lisis autom√°tico...');
    console.log('   - Determinantes:', tieneDeterminantes ? '‚úÖ' : '‚ùå');
    console.log('   - Indicadores:', tieneIndicadores ? '‚úÖ' : '‚ùå');
    console.log('   - Conclusiones:', tieneConclusiones ? '‚úÖ (grupo motor)' : '‚è≥ (auto)');
    console.log('   - Recomendaciones:', tieneRecomendaciones ? '‚úÖ (grupo motor)' : '‚è≥ (auto)');
    console.log('   - Priorizaci√≥n:', tienePriorizacion ? '‚úÖ (grupo motor)' : '‚è≥ (auto)');
    
    // Ejecutar an√°lisis
    const analisis = analizarDatosMunicipio();
    
    if (analisis.sinDatos) {
        console.log('üìä An√°lisis sin datos suficientes');
        return;
    }
    
    // Guardar an√°lisis generado en window para uso posterior
    window.analisisActual = analisis;
    
    const updates = {};
    let generados = [];
    
    // Generar conclusiones si no existen
    if (!tieneConclusiones && analisis.conclusiones && analisis.conclusiones.length > 0) {
        const conclusionesObj = {};
        analisis.conclusiones.forEach((c, idx) => {
            conclusionesObj[idx + 1] = c.texto;
        });
        updates['municipios/' + municipio + '/conclusiones'] = conclusionesObj;
        updates['municipios/' + municipio + '/conclusiones_auto'] = true; // Marcar como auto-generadas
        generados.push('conclusiones');
    }
    
    // Generar recomendaciones si no existen
    if (!tieneRecomendaciones && analisis.recomendaciones && analisis.recomendaciones.length > 0) {
        const recomendacionesObj = {};
        analisis.recomendaciones.forEach((r, idx) => {
            recomendacionesObj[idx + 1] = r.texto;
        });
        updates['municipios/' + municipio + '/recomendaciones'] = recomendacionesObj;
        updates['municipios/' + municipio + '/recomendaciones_auto'] = true;
        generados.push('recomendaciones');
    }
    
    // Generar priorizaci√≥n si no existe
    if (!tienePriorizacion && analisis.priorizacion && analisis.priorizacion.length > 0) {
        const priorizacionObj = {
            areas: {},
            fecha: new Date().toISOString(),
            auto: true
        };
        analisis.priorizacion.slice(0, 8).forEach((p, idx) => {
            priorizacionObj.areas[p.areaKey || p.area.toLowerCase().replace(/\s+/g, '_')] = {
                nombre: p.area,
                prioridad: idx + 1,
                justificacion: p.justificacion,
                lineaEPVSA: p.lineaEPVSA,
                objetivoEPVSA: p.objetivoEPVSA
            };
        });
        updates['municipios/' + municipio + '/priorizacion'] = priorizacionObj;
        generados.push('priorizaci√≥n');
    }
    
    // Guardar narrativa salutog√©nica si se gener√≥
    if (analisis.narrativa) {
        updates['municipios/' + municipio + '/narrativa'] = {
            contexto: analisis.narrativa.contexto,
            activos: analisis.narrativa.activos,
            oportunidades: analisis.narrativa.oportunidades,
            patrones: analisis.narrativa.patrones,
            sintesis: analisis.narrativa.sintesis,
            fecha: new Date().toISOString()
        };
    }
    
    // Guardar en Firebase si hay algo que guardar
    if (Object.keys(updates).length > 0) {
        try {
            await db.ref().update(updates);
            console.log('‚úÖ An√°lisis autom√°tico guardado:', generados.join(', '));
            
            // Notificar al usuario
            if (typeof mostrarNotificacion === 'function') {
                mostrarNotificacion({
                    title: 'üìä An√°lisis generado',
                    message: `Se han generado autom√°ticamente: ${generados.join(', ')}. Puedes editarlos en Gestionar datos.`,
                    type: 'success',
                    duration: 5000
                });
            }
            
            // Actualizar estados visuales en panel de carga
            if (generados.includes('conclusiones')) {
                const estadoConc = document.getElementById('estado-conclusiones');
                if (estadoConc) estadoConc.innerHTML = '<span class="estado-ok">‚úÖ Auto-generadas</span>';
            }
            if (generados.includes('recomendaciones')) {
                const estadoRec = document.getElementById('estado-recomendaciones');
                if (estadoRec) estadoRec.innerHTML = '<span class="estado-ok">‚úÖ Auto-generadas</span>';
            }
            if (generados.includes('priorizaci√≥n')) {
                const estadoPrio = document.getElementById('estado-priorizacion');
                if (estadoPrio) estadoPrio.innerHTML = '<span class="estado-ok">‚úÖ Auto-generada</span>';
            }
            
            // Recargar datos para reflejar cambios
            const datos_actualizados = await new Promise(resolve => {
                cargarDatosMunicipioFirebase(municipio, resolve);
            });
            
            // Actualizar vistas (nuevo perfil modular)
            const nombre = getNombreMunicipio(municipio);
            poblarPerfilNuevo(datos_actualizados || {}, nombre);
            
        } catch (err) {
            console.error('‚ùå Error guardando an√°lisis autom√°tico:', err);
        }
    }
}

// Generar HTML del informe desde datos de Firebase
function generarInformeDesdeFirebase(datos, nombre, conCabecera = false) {
    let html = '';
    
    // A√±adir cabecera institucional si se solicita (Tab 1)
    if (conCabecera) {
        html += generarCabeceraInstitucional('informe', nombre);
    }
    
    // Si hay HTML completo almacenado, usarlo directamente
    if (datos.informe && datos.informe.htmlCompleto) {
        html += datos.informe.htmlCompleto;
        return html;
    }
    
    // Si no hay datos, mostrar panel indicando que hay que cargarlos
    html += `<div class="destacado destacado-rojo">
        <strong>‚ö†Ô∏è Informe pendiente de cargar</strong><br>
        El informe de situaci√≥n de salud de ${nombre} debe cargarse desde un archivo Word (.docx).<br>
        Ve a <strong>‚öôÔ∏è Gestionar datos</strong> y usa el cargador de informe Word.
    </div>`;
    return html;
}

// Generar Perfil de salud local desde Firebase
function generarPerfilDesdeFirebase(datos, nombre) {
    let html = '';
    
    // Obtener configuraci√≥n del municipio para el Marco estrat√©gico
    const configMarco = {
        municipio: nombre,
        distrito: 'Distrito sanitario Granada-Metropolitano',
        anioInforme: datos.anioInforme || new Date().getFullYear(),
        anioEncuesta: datos.anioEncuesta || (new Date().getFullYear() - 1),
        mesPriorizacion: datos.mesPriorizacion || 'febrero',
        anioPriorizacion: datos.anioPriorizacion || new Date().getFullYear(),
        lineasEstrategia: datos.lineasEstrategia || '1, 3 y 4'
    };
    
    // Marco estrat√©gico (din√°mico seg√∫n municipio)
    html += generarMarcoEstrategico(configMarco);
    
    // Informe como acorde√≥n (siempre replegado)
    const tieneInforme = datos.informe && datos.informe.htmlCompleto;
    html += `<div class="acordeon-item">
        <div class="acordeon-header" onclick="toggleAcordeon(this)"><span>02 Informe sobre la situaci√≥n de salud</span><span class="flecha">‚ñº</span></div>
        <div class="acordeon-contenido">${generarInformeDesdeFirebase(datos, nombre)}</div>
    </div>`;
    
    // Determinantes
    html += generarSeccionDeterminantes();
    
    // Conclusiones y Recomendaciones desde Firebase
    if (datos.conclusiones || datos.recomendaciones) {
        html += generarConclusionesDesdeFirebase(datos.conclusiones, datos.recomendaciones);
    } else {
        html += `<div class="acordeon-item">
            <div class="acordeon-header" onclick="toggleAcordeon(this)"><span>04 Conclusiones y recomendaciones</span><span class="flecha">‚ñº</span></div>
            <div class="acordeon-contenido">
                <div class="destacado destacado-rojo">
                    <strong>‚ö†Ô∏è Conclusiones pendientes de cargar</strong><br>
                    Carga el archivo CSV de conclusiones y recomendaciones en <strong>‚öôÔ∏è Gestionar datos</strong>.
                </div>
            </div>
        </div>`;
    }
    
    // Priorizaci√≥n desde Firebase
    if (datos.priorizacion) {
        html += generarPriorizacionDesdeFirebase(datos.priorizacion, nombre);
    } else {
        html += `<div class="acordeon-item">
            <div class="acordeon-header" onclick="toggleAcordeon(this)"><span>05 Priorizaci√≥n</span><span class="flecha">‚ñº</span></div>
            <div class="acordeon-contenido">
                <div class="destacado destacado-rojo">
                    <strong>‚ö†Ô∏è Priorizaci√≥n pendiente de configurar</strong><br>
                    Configura la priorizaci√≥n en <strong>‚öôÔ∏è Gestionar datos</strong> o carga un CSV de priorizaci√≥n.
                </div>
            </div>
        </div>`;
    }
    
    // Herramienta de seguimiento
    html += generarHerramientaSeguimientoDesdeFirebase(datos, nombre);
    
    // Bot√≥n GENERAR PERFIL DE SALUD LOCAL
    html += `<div style="text-align: center; margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); border-radius: 12px;">
        <button class="btn-accion" onclick="generarPerfilSaludLocal()" style="margin: 0.5rem; padding: 1rem 2rem; font-size: 1.1rem;">
            üìï Generar PDF
        </button>
        <p style="color: #64748b; margin-top: 0.75rem; font-size: 0.9rem;">Exportar perfil de salud local completo</p>
    </div>`;
    
    return html;
}

// Generar conclusiones desde Firebase
function generarConclusionesDesdeFirebase(conclusiones, recomendaciones) {
    // Formato nuevo: conclusiones y recomendaciones son arrays/objetos separados
    const conclArray = typeof conclusiones === 'object' ? Object.values(conclusiones) : [];
    const recomArray = typeof recomendaciones === 'object' ? Object.values(recomendaciones) : [];
    
    let cards = '';
    const maxItems = Math.max(conclArray.length, recomArray.length);
    
    for (let i = 0; i < maxItems; i++) {
        const concl = conclArray[i] || '';
        const recom = recomArray[i] || '';
        
        // Si es el formato antiguo (objeto con conclusion/recomendacion)
        const textoConclusion = typeof concl === 'object' ? concl.conclusion : concl;
        const textoRecomendacion = typeof concl === 'object' ? concl.recomendacion : recom;
        
        cards += `
            <div class="conclusion-card">
                <h4>${String(i + 1).padStart(2, '0')}</h4>
                <div class="tipo">Conclusi√≥n</div>
                <p>${textoConclusion}</p>
                ${textoRecomendacion ? `<div class="recomendacion">
                    <div class="tipo">Recomendaci√≥n</div>
                    <p>${textoRecomendacion}</p>
                </div>` : ''}
            </div>`;
    }
    
    return `<div class="acordeon-item">
        <div class="acordeon-header" onclick="toggleAcordeon(this)"><span>04 Conclusiones y recomendaciones</span><span class="flecha">‚ñº</span></div>
        <div class="acordeon-contenido">
            <div class="conclusion-grid">${cards}</div>
        </div>
    </div>`;
}

// Generar priorizaci√≥n desde Firebase
function generarPriorizacionDesdeFirebase(prio, nombre) {
    // Manejar formato antiguo (lineas) y formato nuevo (areas)
    let contenidoHTML = '';
    
    // Si tiene el formato nuevo de areas (desde CSV de paquetes)
    if (prio.areas && Object.keys(prio.areas).length > 0) {
        const areasHTML = Object.entries(prio.areas).map(([num, area]) => `
            <div class="area-prioritaria" style="background: #f8fafc; border-left: 4px solid #0074c8; padding: 1rem; margin: 0.5rem 0; border-radius: 0 8px 8px 0;">
                <h5 style="margin: 0 0 0.5rem 0; color: #0074c8;">√Årea ${num}: ${area.areaPrioritaria || ''}</h5>
                ${area.problema ? `<p style="margin: 0.25rem 0;"><strong>Problema:</strong> ${area.problema}</p>` : ''}
                ${area.justificacion ? `<p style="margin: 0.25rem 0;"><strong>Justificaci√≥n:</strong> ${area.justificacion}</p>` : ''}
                ${area.indicador ? `<p style="margin: 0.25rem 0;"><strong>Indicador:</strong> ${area.indicador}</p>` : ''}
                ${area.meta ? `<p style="margin: 0.25rem 0;"><strong>Meta:</strong> ${area.meta}</p>` : ''}
                ${area.programasRelacionados && area.programasRelacionados.length > 0 ? `<p style="margin: 0.25rem 0;"><strong>Programas:</strong> ${area.programasRelacionados.join(', ')}</p>` : ''}
            </div>`).join('');
        
        contenidoHTML = `
            <p>El <strong>Informe sobre la situaci√≥n de salud de ${nombre}</strong> y la <strong>Encuesta local de salud</strong> han facilitado la identificaci√≥n de las siguientes <strong>√°reas prioritarias</strong>:</p>
            
            <div class="areas-prioritarias">${areasHTML}</div>
            
            <div class="destacado destacado-azul" style="margin-top: 1rem;">
                <strong>el Plan local de salud de ${nombre}</strong> se centra en estas √°reas prioritarias, aline√°ndose con la Estrategia de Promoci√≥n de vida saludable en Andaluc√≠a.
            </div>`;
    }
    // Si tiene el formato antiguo (lineas)
    else if (prio.lineas) {
        const lineasHTML = Object.entries(prio.lineas)
            .filter(([id, l]) => l.seleccionada)
            .map(([id, l]) => `
                <div class="linea-estrategica">
                    <h5>L√≠nea ${id}</h5>
                    <p>${l.nombre}</p>
                </div>`).join('');
        
        contenidoHTML = `
            <p>El <strong>Informe sobre la situaci√≥n de salud de ${nombre} (2026)</strong> y la <strong>Encuesta local de salud de ${nombre} (2024)</strong> han facilitado el paso del diagn√≥stico a la acci√≥n.</p>
            
            <div class="priorizacion-resultado">
                <h4>üó≥Ô∏è Resultado de la sesi√≥n de priorizaci√≥n del Grupo-Motor${prio.fechaSesion ? ' (' + prio.fechaSesion + ')' : ''}</h4>
                <p>De acuerdo con lo acordado por el Grupo-Motor, se adaptar√° el dise√±o del plan de acci√≥n a las <strong>l√≠neas seleccionadas de la Estrategia</strong>, situando la <strong>${prio.ejeCentral || 'percepci√≥n de calidad de vida y el bienestar emocional'}</strong> en el centro neur√°lgico del plan.</p>
                
                <div class="lineas-estrategicas">${lineasHTML}</div>
            </div>
            
            <div class="destacado destacado-azul">
                <strong>Eje central del II Plan local de salud de ${nombre} 2026-2030:</strong><br>
                <em>${prio.ejeCentral || 'Percepci√≥n de calidad de vida y bienestar emocional'}</em>
            </div>
            
            ${prio.textoAdicional ? '<p>' + prio.textoAdicional + '</p>' : ''}
            
            <p>Al acompasar el Plan local de salud de ${nombre} a la Estrategia, se incorporan de manera autom√°tica al mismo las <strong>l√≠neas estrat√©gicas</strong>, los <strong>objetivos</strong> seleccionados dentro de cada l√≠nea y los <strong>indicadores de contexto e impacto</strong> vinculados a cada objetivo.</p>`;
    }
    // Sin datos
    else {
        contenidoHTML = `
            <div class="destacado destacado-rojo">
                <strong>‚ö†Ô∏è Priorizaci√≥n pendiente de configurar</strong><br>
                Configura la priorizaci√≥n en <strong>‚öôÔ∏è Gestionar datos</strong> o carga un CSV de priorizaci√≥n.
            </div>`;
    }
    
    return `<div class="acordeon-item">
        <div class="acordeon-header" onclick="toggleAcordeon(this)"><span>05 Priorizaci√≥n</span><span class="flecha">‚ñº</span></div>
        <div class="acordeon-contenido">
            ${contenidoHTML}
        </div>
    </div>`;
}

// Generar herramienta de seguimiento desde Firebase
function generarHerramientaSeguimientoDesdeFirebase(datos, nombre) {
    if (!datos.indicadores) {
        return `<div class="acordeon-item">
            <div class="acordeon-header" onclick="toggleAcordeon(this)"><span>06 Herramienta para el seguimiento y la evaluaci√≥n: Cuadro de mandos integral</span><span class="flecha">‚ñº</span></div>
            <div class="acordeon-contenido">
                <div class="destacado destacado-rojo">
                    <strong>‚ö†Ô∏è Indicadores pendientes de cargar</strong><br>
                    Carga el archivo CSV de indicadores en <strong>‚öôÔ∏è Gestionar datos</strong>.
                </div>
            </div>
        </div>`;
    }
    
    // Agrupar indicadores por categor√≠a
    const categorias = {};
    Object.entries(datos.indicadores).forEach(([num, ind]) => {
        const cat = ind.categoria || 'General';
        if (!categorias[cat]) categorias[cat] = [];
        categorias[cat].push({num: num, ...ind});
    });
    
    let tablasHTML = '';
    Object.entries(categorias).forEach(([cat, inds]) => {
        tablasHTML += `<h3 class="tabla-categoria">${cat}</h3>
        <table class="tabla-indicadores">
            <thead><tr><th>N¬∫</th><th>Indicador</th><th>Dato</th><th>Unidad</th><th>T.Obs.</th><th>T.Des.</th><th>Sem√°foro</th></tr></thead>
            <tbody>${inds.map(i => {
                const tObs = i.tendenciaObservada || i.tObs || '';
                const tDes = i.tendenciaDeseada || i.tDes || '';
                let semaforo = '‚ö™';
                
                // L√≥gica del sem√°foro
                if (tObs && tDes && tObs !== '=' && tDes !== '=') {
                    if (tObs === tDes) {
                        semaforo = 'üü¢'; // Verde: tendencia va bien
                    } else if ((tObs === '‚Üë' && tDes === '‚Üì') || (tObs === '‚Üì' && tDes === '‚Üë') ||
                               (tObs === '‚ñ≤' && tDes === '‚ñº') || (tObs === '‚ñº' && tDes === '‚ñ≤')) {
                        semaforo = 'üî¥'; // Rojo: tendencia va mal
                    } else {
                        semaforo = 'üü°'; // Amarillo: situaci√≥n intermedia
                    }
                } else if (tObs === '=' || tDes === '=') {
                    semaforo = 'üü°'; // Amarillo: estable
                }
                
                return `<tr>
                    <td>${i.num}</td>
                    <td>${i.nombre || i.indicador || ''}</td>
                    <td>${i.dato !== null && i.dato !== undefined ? i.dato : ''}</td>
                    <td>${i.unidad || ''}</td>
                    <td>${tObs}</td>
                    <td>${tDes}</td>
                    <td>${semaforo}</td>
                </tr>`;
            }).join('')}</tbody>
        </table>`;
    });
    
    return `<div class="acordeon-item">
        <div class="acordeon-header" onclick="toggleAcordeon(this)"><span>06 Herramienta para el seguimiento y la evaluaci√≥n: Cuadro de mandos integral</span><span class="flecha">‚ñº</span></div>
        <div class="acordeon-contenido">
            <p>El <strong>Cuadro de mandos integral</strong> incluye <strong>${Object.keys(datos.indicadores).length} indicadores</strong>:</p>
            ${tablasHTML}
            <p class="fuente">Fuente: IECA, INE, INFOWEB, BPS, Registro de C√°ncer, HERMES</p>
        </div>
    </div>`;
}

function cerrarTodosLosPaneles() {
    ['informe-container','registro-container','hoja-ruta-container'].forEach(id => {
        const el = document.getElementById(id); if (el) el.classList.remove('visible');
    });
    ['btn-valoracion','btn-registro','btn-hoja-ruta'].forEach(id => {
        const el = document.getElementById(id); if (el) el.classList.remove('activo');
    });
}

function toggleAcordeon(header) { header.parentElement.classList.toggle('abierto'); }

// Navegaci√≥n
document.querySelectorAll('.fase').forEach(fase => {
    fase.addEventListener('click', function() {
        const numFase = this.dataset.fase;
        
        // Verificar si es Fase 6 (Implantaci√≥n/Agenda) y si hay plan de acci√≥n
        if (numFase === '6') {
            if (!planLocalSalud.planAccion.completado) {
                // Mostrar alerta y bloquear acceso
                alert('‚ö†Ô∏è FASE BLOQUEADA\n\n' +
                      'Para acceder a la Agenda anual (Fase 6) primero debe completar:\n\n' +
                      '‚úÖ Fase 3 - Plan de acci√≥n\n' +
                      '   (Seleccionar l√≠neas estrat√©gicas, objetivos e indicadores)\n\n' +
                      'No tiene sentido planificar programas y actuaciones sin un Plan de acci√≥n previo.');
                
                // Redirigir a Fase 3
                document.querySelectorAll('.fase').forEach(f => f.classList.remove('activa'));
                document.querySelector('.fase[data-fase="3"]').classList.add('activa');
                document.querySelectorAll('.fase-contenido').forEach(c => c.classList.remove('activa'));
                document.getElementById('fase-3-contenido')?.classList.add('activa');
                cerrarTodosLosPaneles();
                return;
            }
        }
        
        // Si pasa la verificaci√≥n o no es Fase 6, proceder normalmente
        document.querySelectorAll('.fase').forEach(f => f.classList.remove('activa'));
        this.classList.add('activa');
        document.querySelectorAll('.fase-contenido').forEach(c => c.classList.remove('activa'));
        document.getElementById('fase-' + this.dataset.fase + '-contenido')?.classList.add('activa');
        cerrarTodosLosPaneles();
        // Al activar Tab 2, refrescar perfil si hay datos
        if (this.dataset.fase === '2' && typeof poblarPerfilNuevo === 'function') {
            const _k = getMunicipioActual();
            if (_k && datosMunicipioActual) {
                poblarPerfilNuevo(datosMunicipioActual, getNombreMunicipio(_k));
            } else if (_k) {
                actualizarMunicipio();
            }
        }
    });
});

// Botones
document.getElementById('btn-valoracion').addEventListener('click', function() {
    document.getElementById('registro-container').classList.remove('visible');
    document.getElementById('hoja-ruta-container').classList.remove('visible');
    document.getElementById('btn-registro').classList.remove('activo');
    document.getElementById('btn-hoja-ruta').classList.remove('activo');
    document.getElementById('informe-container').classList.toggle('visible');
    this.classList.toggle('activo');
});

document.getElementById('btn-registro').addEventListener('click', function() {
    document.getElementById('informe-container').classList.remove('visible');
    document.getElementById('hoja-ruta-container').classList.remove('visible');
    document.getElementById('btn-valoracion').classList.remove('activo');
    document.getElementById('btn-hoja-ruta').classList.remove('activo');
    document.getElementById('registro-container').classList.toggle('visible');
    this.classList.toggle('activo');
});

document.getElementById('btn-hoja-ruta').addEventListener('click', function() {
    document.getElementById('informe-container').classList.remove('visible');
    document.getElementById('registro-container').classList.remove('visible');
    document.getElementById('btn-valoracion').classList.remove('activo');
    document.getElementById('btn-registro').classList.remove('activo');
    document.getElementById('hoja-ruta-container').classList.toggle('visible');
    this.classList.toggle('activo');
});

document.getElementById('btn-exportar-json').addEventListener('click', function() {
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + getMunicipioActual()).once('value', snap => {
        const blob = new Blob([JSON.stringify(snap.val() || {}, null, 2)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = getMunicipioActual() + '.json'; a.click();
    });
});

// Grupo motor
function registrarMiembro() {
    const nombre = document.getElementById('nombre').value.trim();
    const email = document.getElementById('email').value.trim();
    const sector = document.getElementById('sector').value;
    if (!nombre || !email || !sector) { alert('Complete campos obligatorios'); return; }
    
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + getMunicipioActual() + '/grupoMotor').push({
        nombre, email, sector,
        telefono: document.getElementById('telefono').value.trim(),
        organizacion: document.getElementById('organizacion').value.trim(),
        cargo: document.getElementById('cargo').value.trim(),
        fecha: new Date().toISOString()
    }).then(() => {
        ['nombre','telefono','email','organizacion','cargo'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('sector').value = '';
    });
}

function cargarMiembros() {
    const municipio = getMunicipioActual();
    if (!municipio) return; // No cargar si no hay municipio seleccionado
    
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/grupoMotor').on('value', snap => {
        const div = document.getElementById('tabla-miembros');
        const data = snap.val();
        if (!data) { div.innerHTML = '<p class="sin-miembros">Sin miembros.</p>'; return; }
        let html = '<table><tr><th>Nombre</th><th>Organizaci√≥n</th><th>Sector</th><th>Email</th><th></th></tr>';
        Object.entries(data).forEach(([k,m]) => {
            html += `<tr><td>${m.nombre}</td><td>${m.organizacion||'-'}</td><td>${m.sector}</td><td>${m.email}</td>
            <td><button class="btn-eliminar" onclick="eliminarMiembro('${k}')">üóëÔ∏è</button></td></tr>`;
        });
        div.innerHTML = html + '</table>';
    });
}

function eliminarMiembro(k) { if(confirm('¬øEliminar?')) db.ref('estrategias/' + estrategiaActual + '/municipios/' + getMunicipioActual()+'/grupoMotor/'+k).remove(); }

// Hoja de ruta
const HITOS = [
    {id:'informe',nombre:'üìä Informe situaci√≥n'},
    {id:'taller',nombre:'üéì Taller formaci√≥n'},
    {id:'perfil',nombre:'üìã Perfil salud'},
    {id:'priorizacion',nombre:'üó≥Ô∏è Priorizaci√≥n'},
    {id:'planificacion',nombre:'üìù Planificaci√≥n'},
    {id:'compilacion',nombre:'üìö Compilaci√≥n PLS'},
    {id:'aprobacion',nombre:'‚úÖ Aprobaci√≥n'},
    {id:'implantacion',nombre:'üöÄ Implantaci√≥n'},
    {id:'evaluacion',nombre:'üìà Evaluaci√≥n'}
];

function inicializarHojaRuta() {
    console.log('üîÑ inicializarHojaRuta() llamada');
    const m = getMunicipioActual();
    if (!m) {
        console.log('  ‚ö†Ô∏è No hay municipio seleccionado, no se inicializa hoja de ruta');
        return;
    }
    
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + m + '/hojaRuta').once('value', snap => {
        console.log('  Firebase hojaRuta respondi√≥:', snap.exists() ? 'tiene datos' : 'vac√≠o');
        if (!snap.exists()) {
            console.log('  Creando hitos predeterminados...');
            const h = {};
            HITOS.forEach((x,i) => { h[x.id] = {...x, fecha:'', estado:'pendiente', orden:i}; });
            db.ref('estrategias/' + estrategiaActual + '/municipios/' + m + '/hojaRuta').set(h);
        }
        cargarHojaRuta();
    });
}

function cargarHojaRuta() {
    console.log('üîÑ cargarHojaRuta() llamada');
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + getMunicipioActual()+'/hojaRuta').on('value', snap => {
        const lista = document.getElementById('hitos-lista');
        const data = snap.val();
        console.log('  Hitos recibidos:', data ? Object.keys(data).length : 0);
        if (!data) { lista.innerHTML = '<p>Cargando...</p>'; return; }
        const arr = Object.entries(data).map(([k,h])=>({k,...h})).sort((a,b)=>(a.orden||0)-(b.orden||0));
        let html = '';
        arr.forEach(h => {
            html += `<div class="hito-card ${h.estado||'pendiente'}">
                <div class="hito-drag">‚ãÆ‚ãÆ</div>
                <div class="hito-info"><span class="hito-nombre">${h.nombre}</span></div>
                <input type="date" class="hito-fecha-input" value="${h.fecha||''}" onchange="actHito('${h.k}','fecha',this.value)">
                <select class="hito-estado-select" onchange="actHito('${h.k}','estado',this.value)">
                    <option value="pendiente"${h.estado==='pendiente'?' selected':''}>‚è≥ Pendiente</option>
                    <option value="en-curso"${h.estado==='en-curso'?' selected':''}>üîÑ En curso</option>
                    <option value="completado"${h.estado==='completado'?' selected':''}>‚úÖ Completado</option>
                </select>
            </div>`;
        });
        lista.innerHTML = html;
        console.log('  ‚úÖ Hitos renderizados:', arr.length);
    });
}

function actHito(k,c,v) { db.ref('estrategias/' + estrategiaActual + '/municipios/' + getMunicipioActual()+'/hojaRuta/'+k+'/'+c).set(v); }

function ordenarHitosPorFecha() {
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + getMunicipioActual()+'/hojaRuta').once('value', snap => {
        const d = snap.val(); if(!d) return;
        const arr = Object.entries(d).map(([k,h])=>({k,...h}));
        arr.sort((a,b) => { if(a.fecha&&b.fecha) return new Date(a.fecha)-new Date(b.fecha); return a.fecha?-1:b.fecha?1:0; });
        const u = {}; arr.forEach((h,i) => { u[h.k+'/orden'] = i; });
        db.ref('estrategias/' + estrategiaActual + '/municipios/' + getMunicipioActual()+'/hojaRuta').update(u);
    });
}

function mostrarFormularioHito() { document.getElementById('formulario-hito-personalizado').style.display = 'block'; }
function ocultarFormularioHito() { document.getElementById('formulario-hito-personalizado').style.display = 'none'; }

function guardarHitoPersonalizado() {
    const n = document.getElementById('hito-custom-nombre').value.trim();
    if (!n) { alert('Nombre requerido'); return; }
    const m = getMunicipioActual();
    const id = 'c-' + Date.now();
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + m + '/hojaRuta').once('value', snap => {
        const d = snap.val() || {};
        const max = Math.max(...Object.values(d).map(h=>h.orden||0), -1);
        db.ref('estrategias/' + estrategiaActual + '/municipios/' + m + '/hojaRuta/'+id).set({
            id, nombre: '‚úèÔ∏è '+n, fecha: document.getElementById('hito-custom-fecha').value||'',
            estado: 'pendiente', orden: max+1
        }).then(() => {
            ocultarFormularioHito();
            document.getElementById('hito-custom-nombre').value = '';
            document.getElementById('hito-custom-fecha').value = '';
        });
    });
}

// ==========================================
// PLAN DE ACCI√ìN - ESTRUCTURA EPVSA 2024-2030
// ==========================================

const ESTRUCTURA_EPVSA = [
    {
        id: 1,
        codigo: "LE1",
        nombre: "Promoci√≥n de h√°bitos de vida saludable mediante intervenciones en pol√≠ticas y entornos y dinamizaci√≥n de activos comunitarios para la salud",
        nombreCorto: "Promoci√≥n de h√°bitos de vida saludable",
        color: "#0074c8",
        objetivos: [
            {
                id: "1.1", codigo: "OE 1.1",
                nombre: "Incrementar los niveles de lactancia materna y el consumo de alimentos saludables en detrimento de los no saludables",
                indicadores: [
                    "Porcentaje de menores con lactancia materna exclusiva a los 6 meses",
                    "Porcentaje de menores de 2 a 17 a√±os con buena adherencia a la dieta mediterr√°nea",
                    "Porcentaje de poblaci√≥n adulta con buena adherencia a la dieta mediterr√°nea",
                    "Porcentaje de poblaci√≥n de 1 a 14 a√±os que consume fruta fresca a diario",
                    "Porcentaje de poblaci√≥n de 15 y m√°s a√±os que consume fruta fresca a diario"
                ]
            },
            {
                id: "1.2", codigo: "OE 1.2",
                nombre: "Aumentar los niveles de actividad f√≠sica y disminuir los h√°bitos sedentarios",
                indicadores: [
                    "Porcentaje de poblaci√≥n de 1 a 14 a√±os que realiza ejercicio f√≠sico regular en tiempo de ocio",
                    "Porcentaje de poblaci√≥n de 15 y m√°s a√±os que realiza ejercicio f√≠sico regular en tiempo de ocio",
                    "Porcentaje de poblaci√≥n de 1 a 14 a√±os con tiempo de ocio sedentario inferior a 2 horas/d√≠a",
                    "Porcentaje de poblaci√≥n de 15 y m√°s a√±os con actividad principal sedentaria"
                ]
            },
            {
                id: "1.3", codigo: "OE 1.3",
                nombre: "Incrementar las horas y la calidad del sue√±o en la poblaci√≥n",
                indicadores: [
                    "Porcentaje de poblaci√≥n de 15 y m√°s a√±os cuyas horas de sue√±o le permiten descansar lo suficiente"
                ]
            },
            {
                id: "1.4", codigo: "OE 1.4",
                nombre: "Incrementar la percepci√≥n de calidad de vida y de bienestar emocional",
                indicadores: [
                    "Puntuaci√≥n media de la escala de bienestar emocional (Warwick-Edinburgh) en poblaci√≥n de 15 y m√°s a√±os",
                    "Porcentaje de menores de 8 a 15 a√±os que manifiestan sentirse bien y en forma"
                ]
            },
            {
                id: "1.5", codigo: "OE 1.5",
                nombre: "Incrementar la percepci√≥n de satisfacci√≥n con las relaciones sexuales para todas las partes, independientemente de su sexo, orientaci√≥n o identidad sexual",
                indicadores: [
                    "Puntuaci√≥n media de satisfacci√≥n con la vida sexual en poblaci√≥n de 16 y m√°s a√±os"
                ]
            },
            {
                id: "1.6", codigo: "OE 1.6",
                nombre: "Disminuir el tiempo dedicado al uso de aparatos electr√≥nicos, en detrimento del tiempo dedicado a familiares y amistades",
                indicadores: [
                    "Porcentaje de menores de 1 a 14 a√±os que dedican menos de 2 horas diarias al uso de pantallas",
                    "Porcentaje de poblaci√≥n de 15 y m√°s a√±os que usa internet menos de 5 horas diarias"
                ]
            },
            {
                id: "1.7", codigo: "OE 1.7",
                nombre: "Incrementar las recomendaciones a la ciudadan√≠a sobre activos comunitarios que facilitan una vida saludable",
                indicadores: [
                    "N√∫mero de recomendaciones de activos para la salud desde el SSPA"
                ]
            }
        ],
        programas: [
            { 
                codigo: 'P01', 
                nombre: 'Promoci√≥n de h√°bitos saludables y redes de apoyo comunitario a trav√©s de la Red de acci√≥n local en salud (RELAS)',
                nombreCorto: 'RELAS',
                ambito: 'Comunitario',
                objetivos: ['1.1','1.2','1.3','1.4','1.5','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P01-A01', nombre: 'Consolidaci√≥n de la Red local de acci√≥n en salud'},
                    {codigo: 'P01-A02', nombre: 'Fortalecimiento de la participaci√≥n a nivel local'},
                    {codigo: 'P01-A03', nombre: 'Potenciaci√≥n de iniciativas (Por un mill√≥n de pasos, Rutas urbanas...)'},
                    {codigo: 'P01-A04', nombre: 'Generaci√≥n de espacios interprofesionales e interprovinciales'},
                    {codigo: 'P01-A05', nombre: 'Acuerdos para canales cortos de comercializaci√≥n'},
                    {codigo: 'P01-A06', nombre: 'Coordinaci√≥n para desarrollo de acciones intersectoriales'},
                    {codigo: 'P01-A07', nombre: 'Formaci√≥n sobre h√°bitos de vida saludable'},
                    {codigo: 'P01-A08', nombre: 'Colaboraci√≥n con farmacias comunitarias (CACOF)'},
                    {codigo: 'P01-A09', nombre: 'Talleres grupales en zonas desfavorecidas (ERASCIS)'},
                    {codigo: 'P01-A10', nombre: 'Convenios con comedores sociales y bancos de alimentos'},
                    {codigo: 'P01-A11', nombre: 'Criterios de calidad en bonos de alimentos'},
                    {codigo: 'P01-A12', nombre: 'Fomento consumo agua y alimentos saludables'},
                    {codigo: 'P01-A13', nombre: 'Impulso de iniciativas locales productos saludables'},
                    {codigo: 'P01-A14', nombre: 'Difusi√≥n informaci√≥n men√∫s saludables'},
                    {codigo: 'P01-A15', nombre: 'Plan de Deporte en Edad Escolar (PDEEA)'},
                    {codigo: 'P01-A16', nombre: 'Ayudas a familias para actividades deportivas'},
                    {codigo: 'P01-A17', nombre: 'Potenciaci√≥n instalaciones deportivas municipales'},
                    {codigo: 'P01-A18', nombre: 'Creaci√≥n de Unidades Activas de Ejercicio F√≠sico (UAEF)'},
                    {codigo: 'P01-A19', nombre: 'Adaptaci√≥n horarios equipamientos municipales'},
                    {codigo: 'P01-A20', nombre: 'Convenios con entidades para promoci√≥n h√°bitos saludables'},
                    {codigo: 'P01-A21', nombre: 'Colaboraci√≥n con Puntos Vuela (Guadalinfo)'},
                    {codigo: 'P01-A22', nombre: 'Coordinaci√≥n con IAJ, PDEEA, Forma Joven, En buena edad'},
                    {codigo: 'P01-A23', nombre: 'Desarrollo de recursos TRIC'},
                    {codigo: 'P01-A24', nombre: 'Fomento ocio nocturno saludable'},
                    {codigo: 'P01-A25', nombre: 'Oferta p√∫blica de ocio y tiempo libre saludable'},
                    {codigo: 'P01-A26', nombre: 'Fomento redes de apoyo comunitario'}
                ]
            },
            { 
                codigo: 'P02', 
                nombre: 'Medidas espec√≠ficas en entornos y sistemas de movilidad y transporte para facilitar los h√°bitos saludables',
                nombreCorto: 'Movilidad y transporte',
                ambito: 'Comunitario',
                objetivos: ['1.1','1.2','1.3','1.4','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P02-A01', nombre: 'Planes de movilidad con objetivos de salud'},
                    {codigo: 'P02-A02', nombre: 'Evaluaci√≥n de Impacto en Salud (EIS)'},
                    {codigo: 'P02-A03', nombre: 'Itinerarios peatonales para conectar servicios'},
                    {codigo: 'P02-A04', nombre: 'Caminos escolares seguros y saludables'},
                    {codigo: 'P02-A05', nombre: 'Rutas para la Vida Sana'},
                    {codigo: 'P02-A06', nombre: 'Fomento de desplazamientos no motorizados'},
                    {codigo: 'P02-A07', nombre: 'Infraestructuras ciclistas'},
                    {codigo: 'P02-A08', nombre: 'Espacios libres de humo en zonas de ocio'},
                    {codigo: 'P02-A09', nombre: 'Oferta alimentaria saludable en instalaciones deportivas'},
                    {codigo: 'P02-A10', nombre: 'Salas de lactancia en espacios p√∫blicos'}
                ]
            },
            { 
                codigo: 'P03', 
                nombre: 'Promoci√≥n de h√°bitos saludables en los centros sanitarios',
                nombreCorto: 'Centros sanitarios',
                ambito: 'Sanitario',
                objetivos: ['1.1','1.2','1.3','1.4','1.5','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P03-A01', nombre: 'Consejo diet√©tico en atenci√≥n primaria'},
                    {codigo: 'P03-A02', nombre: 'Intervenci√≥n en sobrepeso y obesidad infantil (PIOBIN)'},
                    {codigo: 'P03-A03', nombre: 'Prescripci√≥n de ejercicio f√≠sico (PAPEF)'},
                    {codigo: 'P03-A04', nombre: 'Intervenci√≥n en tabaquismo (PITA)'},
                    {codigo: 'P03-A05', nombre: 'Intervenci√≥n en consumo de riesgo de alcohol'},
                    {codigo: 'P03-A06', nombre: 'Promoci√≥n de lactancia materna (IHAN)'},
                    {codigo: 'P03-A07', nombre: 'Programa de Salud Infantil y Adolescente (PSIA-A)'},
                    {codigo: 'P03-A08', nombre: 'Forma Joven en el √°mbito sanitario'},
                    {codigo: 'P03-A09', nombre: 'Grupos Socioeducativos (GRUSE)'},
                    {codigo: 'P03-A10', nombre: 'Atenci√≥n a salud sexual y reproductiva'},
                    {codigo: 'P03-A11', nombre: 'Prescripci√≥n social de activos comunitarios'},
                    {codigo: 'P03-A12', nombre: 'Talleres grupales de educaci√≥n para la salud'}
                ]
            },
            { 
                codigo: 'P04', 
                nombre: 'Identificaci√≥n y dinamizaci√≥n de activos para la salud',
                nombreCorto: 'Activos para la salud',
                ambito: 'Sanitario',
                objetivos: ['1.1','1.2','1.3','1.4','1.5','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P04-A01', nombre: 'Mapeo de activos comunitarios para la salud'},
                    {codigo: 'P04-A02', nombre: 'Cat√°logo de activos en atenci√≥n primaria'},
                    {codigo: 'P04-A03', nombre: 'Plataforma digital de activos'},
                    {codigo: 'P04-A04', nombre: 'Formaci√≥n en identificaci√≥n y uso de activos'},
                    {codigo: 'P04-A05', nombre: 'Recomendaci√≥n de activos desde todos los √°mbitos'}
                ]
            },
            { 
                codigo: 'P05', 
                nombre: 'Promoci√≥n de h√°bitos saludables en los centros de atenci√≥n a personas con adicciones',
                nombreCorto: 'Centros de adicciones',
                ambito: 'Sanitario',
                objetivos: ['1.1','1.2','1.3','1.4','1.5','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P05-A01', nombre: 'Intervenci√≥n en alimentaci√≥n saludable'},
                    {codigo: 'P05-A02', nombre: 'Intervenci√≥n en actividad f√≠sica'},
                    {codigo: 'P05-A03', nombre: 'Intervenci√≥n en sue√±o saludable'},
                    {codigo: 'P05-A04', nombre: 'Intervenci√≥n en bienestar emocional'},
                    {codigo: 'P05-A05', nombre: 'Intervenci√≥n en sexualidad saludable'},
                    {codigo: 'P05-A06', nombre: 'Intervenci√≥n en uso positivo de TRIC'}
                ]
            },
            { 
                codigo: 'P06', 
                nombre: 'Promoci√≥n de h√°bitos saludables en centros educativos',
                nombreCorto: 'Centros educativos',
                ambito: 'Educativo',
                objetivos: ['1.1','1.2','1.3','1.4','1.5','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P06-A01', nombre: 'Programa CIMA: Creciendo en Salud'},
                    {codigo: 'P06-A02', nombre: 'Programa CIMA: Forma Joven en el √°mbito educativo'},
                    {codigo: 'P06-A03', nombre: 'Plan de consumo de frutas y hortalizas en la escuela'},
                    {codigo: 'P06-A04', nombre: 'Evaluaci√≥n de men√∫s escolares (EVACOLE)'},
                    {codigo: 'P06-A05', nombre: 'Comedores escolares saludables'},
                    {codigo: 'P06-A06', nombre: 'Huertos escolares (Ecohuertos)'},
                    {codigo: 'P06-A07', nombre: 'Descansos activos y recreos saludables'},
                    {codigo: 'P06-A08', nombre: 'Desplazamiento activo al centro educativo'},
                    {codigo: 'P06-A09', nombre: 'Enfermera Referente de Centros Educativos (ERc)'},
                    {codigo: 'P06-A10', nombre: 'Red de Escuelas Promotoras de Salud de Andaluc√≠a'}
                ]
            },
            { 
                codigo: 'P07', 
                nombre: 'Promoci√≥n de h√°bitos saludables en centros universitarios',
                nombreCorto: 'Universidades',
                ambito: 'Educativo',
                objetivos: ['1.1','1.2','1.3','1.4','1.6'],
                actuaciones: [
                    {codigo: 'P07-A01', nombre: 'Universidad Saludable'},
                    {codigo: 'P07-A02', nombre: 'Oferta alimentaria saludable en campus'},
                    {codigo: 'P07-A03', nombre: 'Instalaciones deportivas universitarias'},
                    {codigo: 'P07-A04', nombre: 'Programas de bienestar emocional universitario'},
                    {codigo: 'P07-A05', nombre: 'Educaci√≥n afectivo-sexual en universidades'}
                ]
            },
            { 
                codigo: 'P08', 
                nombre: 'Promoci√≥n de h√°bitos saludables en los centros de servicios sociales',
                nombreCorto: 'Servicios sociales',
                ambito: 'Servicios sociales',
                objetivos: ['1.1','1.2','1.3','1.4','1.5','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P08-A01', nombre: 'Intervenci√≥n en centros de d√≠a de mayores'},
                    {codigo: 'P08-A02', nombre: 'Intervenci√≥n en residencias de mayores'},
                    {codigo: 'P08-A03', nombre: 'Intervenci√≥n en centros de personas con discapacidad'},
                    {codigo: 'P08-A04', nombre: 'Alimentaci√≥n saludable en centros residenciales'},
                    {codigo: 'P08-A05', nombre: 'Actividad f√≠sica adaptada'},
                    {codigo: 'P08-A06', nombre: 'Bienestar emocional y prevenci√≥n de soledad'}
                ]
            },
            { 
                codigo: 'P09', 
                nombre: 'Promoci√≥n de h√°bitos saludables en los programas de apoyo social para personas con enfermedad mental',
                nombreCorto: 'Salud mental comunitaria',
                ambito: 'Servicios sociales',
                objetivos: ['1.1','1.2','1.3','1.4','1.5','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P09-A01', nombre: 'Intervenci√≥n en alimentaci√≥n y actividad f√≠sica'},
                    {codigo: 'P09-A02', nombre: 'Intervenci√≥n en sue√±o y descanso'},
                    {codigo: 'P09-A03', nombre: 'Fomento de relaciones sociales saludables'},
                    {codigo: 'P09-A04', nombre: 'Prevenci√≥n de conductas adictivas'},
                    {codigo: 'P09-A05', nombre: 'Uso positivo de tecnolog√≠as'}
                ]
            },
            { 
                codigo: 'P10', 
                nombre: 'Promoci√≥n de h√°bitos saludables en los centros de acogida temporal para inmigrantes',
                nombreCorto: 'Centros acogida inmigrantes',
                ambito: 'Servicios sociales',
                objetivos: ['1.1','1.2','1.3','1.4','1.5','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P10-A01', nombre: 'Alimentaci√≥n adaptada culturalmente'},
                    {codigo: 'P10-A02', nombre: 'Actividad f√≠sica y deportes'},
                    {codigo: 'P10-A03', nombre: 'Bienestar emocional y apoyo psicosocial'},
                    {codigo: 'P10-A04', nombre: 'Educaci√≥n para la salud intercultural'}
                ]
            },
            { 
                codigo: 'P11', 
                nombre: 'Promoci√≥n de h√°bitos saludables en centros y servicios de justicia juvenil y centros penitenciarios',
                nombreCorto: 'Justicia juvenil y penitenciarios',
                ambito: 'Servicios sociales',
                objetivos: ['1.1','1.2','1.3','1.4','1.5','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P11-A01', nombre: 'Alimentaci√≥n saludable en centros'},
                    {codigo: 'P11-A02', nombre: 'Actividad f√≠sica y deporte'},
                    {codigo: 'P11-A03', nombre: 'Intervenci√≥n en adicciones'},
                    {codigo: 'P11-A04', nombre: 'Bienestar emocional'},
                    {codigo: 'P11-A05', nombre: 'Educaci√≥n afectivo-sexual'}
                ]
            },
            { 
                codigo: 'P12', 
                nombre: 'Promoci√≥n de la Salud en el Lugar de Trabajo (PSLT)',
                nombreCorto: 'PSLT - Entorno laboral',
                ambito: 'Laboral',
                objetivos: ['1.1','1.2','1.3','1.4','1.5','1.6','1.7'],
                actuaciones: [
                    {codigo: 'P12-A01', nombre: 'Alimentaci√≥n saludable en el trabajo'},
                    {codigo: 'P12-A02', nombre: 'Pausas activas y actividad f√≠sica'},
                    {codigo: 'P12-A03', nombre: 'Espacios libres de humo'},
                    {codigo: 'P12-A04', nombre: 'Bienestar emocional laboral'},
                    {codigo: 'P12-A05', nombre: 'Conciliaci√≥n familiar y laboral'},
                    {codigo: 'P12-A06', nombre: 'Formaci√≥n en h√°bitos saludables'},
                    {codigo: 'P12-A07', nombre: 'Certificaci√≥n de empresas saludables'}
                ]
            }
        ]
    },
    {
        id: 2,
        codigo: "LE2",
        nombre: "Fomento de responsabilidad social ante la salud por parte del sector empresarial",
        nombreCorto: "Responsabilidad social empresarial",
        color: "#10b981",
        objetivos: [
            {
                id: "2.1", codigo: "OE 2.1",
                nombre: "Incrementar el n√∫mero de empresas que favorezcan en sus estrategias corporativas la adquisici√≥n y mantenimiento de h√°bitos saludables por parte de la ciudadan√≠a",
                indicadores: [
                    "N√∫mero de empresas adheridas a iniciativas de responsabilidad social en salud"
                ]
            }
        ],
        programas: [
            { 
                codigo: 'P13', 
                nombre: 'Establecimiento de alianzas con los operadores econ√≥micos en el campo de la alimentaci√≥n, la restauraci√≥n, el deporte y el ocio',
                nombreCorto: 'Alianzas con sector empresarial',
                ambito: 'Empresarial',
                objetivos: ['2.1'],
                actuaciones: [
                    {codigo: 'P13-A01', nombre: 'Acuerdos con industria alimentaria para reformulaci√≥n'},
                    {codigo: 'P13-A02', nombre: 'Reducci√≥n de az√∫cares, sal y grasas'},
                    {codigo: 'P13-A03', nombre: 'Promoci√≥n de porciones adecuadas'},
                    {codigo: 'P13-A04', nombre: 'Informaci√≥n nutricional clara'},
                    {codigo: 'P13-A05', nombre: 'Certificaci√≥n de establecimientos saludables'},
                    {codigo: 'P13-A06', nombre: 'Red de restaurantes saludables'},
                    {codigo: 'P13-A07', nombre: 'M√°quinas expendedoras con opciones saludables'}
                ]
            }
        ]
    },
    {
        id: 3,
        codigo: "LE3",
        nombre: "Difusi√≥n y comunicaci√≥n de informaci√≥n veraz a la ciudadan√≠a sobre los beneficios de una vida saludable y protecci√≥n de la poblaci√≥n frente a mensajes, publicidad y campa√±as perjudiciales para la salud",
        nombreCorto: "Informaci√≥n y comunicaci√≥n",
        color: "#f59e0b",
        objetivos: [
            {
                id: "3.1", codigo: "OE 3.1",
                nombre: "Incrementar la difusi√≥n de informaci√≥n veraz sobre h√°bitos saludables dirigida a la ciudadan√≠a",
                indicadores: [
                    "N√∫mero de visitas a portales web institucionales de promoci√≥n de salud",
                    "N√∫mero de seguidores en redes sociales institucionales"
                ]
            }
        ],
        programas: [
            { 
                codigo: 'P14', 
                nombre: 'Difusi√≥n de informaci√≥n veraz sobre h√°bitos saludables y medidas para hacer frente a la publicidad de productos y actividades perjudiciales para la salud',
                nombreCorto: 'Comunicaci√≥n y difusi√≥n',
                ambito: 'Informaci√≥n y comunicaci√≥n',
                objetivos: ['3.1'],
                actuaciones: [
                    {codigo: 'P14-A01', nombre: 'Portal Mi Gu√≠a de Salud'},
                    {codigo: 'P14-A02', nombre: 'Campa√±as de comunicaci√≥n en medios'},
                    {codigo: 'P14-A03', nombre: 'Redes sociales institucionales'},
                    {codigo: 'P14-A04', nombre: 'Material divulgativo'},
                    {codigo: 'P14-A05', nombre: 'Colaboraci√≥n con medios de comunicaci√≥n'},
                    {codigo: 'P14-A06', nombre: 'Vigilancia de publicidad enga√±osa'},
                    {codigo: 'P14-A07', nombre: 'Protecci√≥n frente a publicidad de alimentos no saludables'},
                    {codigo: 'P14-A08', nombre: 'Alfabetizaci√≥n medi√°tica en salud'}
                ]
            }
        ]
    },
    {
        id: 4,
        codigo: "LE4",
        nombre: "Impulso a la gesti√≥n del conocimiento, la investigaci√≥n y la innovaci√≥n en el √°rea de la promoci√≥n de h√°bitos de vida saludables",
        nombreCorto: "Formaci√≥n, investigaci√≥n e innovaci√≥n",
        color: "#dc143c",
        objetivos: [
            {
                id: "4.1", codigo: "OE 4.1",
                nombre: "Incrementar la formaci√≥n de profesionales y la investigaci√≥n e innovaci√≥n en el √°mbito de la promoci√≥n de h√°bitos saludables",
                indicadores: [
                    "N√∫mero de profesionales formados en promoci√≥n de salud",
                    "N√∫mero de proyectos de investigaci√≥n en promoci√≥n de salud"
                ]
            }
        ],
        programas: [
            { 
                codigo: 'P15', 
                nombre: 'Fomento de la formaci√≥n, investigaci√≥n e innovaci√≥n en promoci√≥n de h√°bitos saludables y los determinantes que los condicionan',
                nombreCorto: 'Formaci√≥n e investigaci√≥n',
                ambito: 'Formaci√≥n e investigaci√≥n',
                objetivos: ['4.1'],
                actuaciones: [
                    {codigo: 'P15-A01', nombre: 'Formaci√≥n de profesionales sanitarios'},
                    {codigo: 'P15-A02', nombre: 'Formaci√≥n de profesionales educativos'},
                    {codigo: 'P15-A03', nombre: 'Formaci√≥n de profesionales de servicios sociales'},
                    {codigo: 'P15-A04', nombre: 'Formaci√≥n en prescripci√≥n social'},
                    {codigo: 'P15-A05', nombre: 'Jornadas y congresos de promoci√≥n de salud'},
                    {codigo: 'P15-A06', nombre: 'L√≠neas de investigaci√≥n en promoci√≥n de salud'},
                    {codigo: 'P15-A07', nombre: 'Observatorio de h√°bitos saludables'},
                    {codigo: 'P15-A08', nombre: 'Innovaci√≥n en intervenciones de promoci√≥n de salud'},
                    {codigo: 'P15-A09', nombre: 'Evaluaci√≥n de programas de promoci√≥n de salud'}
                ]
            }
        ]
    }
];

// ==========================================


// Estado del Plan de acci√≥n
let planAccionState = {
    lineas: {},
    objetivos: {},
    indicadores: {},
    programas: {},
    actuaciones: {}
};

function renderPlanAccion() {
    const container = document.getElementById('plan-accion-container');
    if (!container) return;
    
    let html = getEstructuraActual().map(linea => `
        <div class="epvsa-linea" id="linea-${linea.id}" style="border-color: ${linea.color};">
            <div class="epvsa-linea-header" style="background: ${linea.color};" onclick="toggleLinea(${linea.id})">
                <input type="checkbox" id="chk-linea-${linea.id}" onchange="toggleLineaCheck(${linea.id})" onclick="event.stopPropagation();">
                <span class="epvsa-linea-title">${linea.codigo}: ${linea.nombreCorto || linea.nombre}</span>
                <span class="epvsa-linea-toggle">‚ñº</span>
            </div>
            <div class="epvsa-linea-content">
                <!-- Objetivos -->
                <div class="epvsa-seccion-titulo">üéØ Objetivos estrat√©gicos (${linea.objetivos.length})</div>
                ${linea.objetivos.map((obj, oi) => `
                    <div class="epvsa-objetivo" id="obj-${linea.id}-${oi}">
                        <div class="epvsa-objetivo-header" onclick="toggleObjetivo(${linea.id}, ${oi})">
                            <input type="checkbox" id="chk-obj-${linea.id}-${oi}" onchange="actualizarStatsPlan()" onclick="event.stopPropagation();">
                            <span class="epvsa-objetivo-codigo" style="background: ${linea.color};">${obj.codigo}</span>
                            <span class="epvsa-objetivo-nombre">${obj.nombre}</span>
                            <span>‚ñº</span>
                        </div>
                        <div class="epvsa-objetivo-content">
                            <div class="epvsa-seccion-titulo">üìä Indicadores (${obj.indicadores.length})</div>
                            ${obj.indicadores.map((ind, ii) => `
                                <div class="epvsa-indicador">
                                    <input type="checkbox" id="chk-ind-${linea.id}-${oi}-${ii}" onchange="actualizarStatsPlan()">
                                    <span>${ind}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                
                <!-- Programas -->
                <div class="epvsa-seccion-titulo" style="margin-top: 1.5rem; font-size: 1rem;">üìã Programas (${linea.programas ? linea.programas.length : 0})</div>
                ${(linea.programas || []).map((prog, pi) => `
                    <div class="epvsa-programa" id="prog-${linea.id}-${pi}">
                        <div class="epvsa-programa-header" onclick="togglePrograma(${linea.id}, ${pi})">
                            <input type="checkbox" id="chk-prog-${linea.id}-${pi}" onchange="actualizarStatsPlan()" onclick="event.stopPropagation();">
                            <span class="epvsa-programa-codigo">${prog.codigo}</span>
                            <span class="epvsa-programa-nombre">${prog.nombreCorto || prog.nombre}</span>
                            <span class="epvsa-programa-ambito" style="background: #f1f5f9; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.75rem; color: #64748b;">${prog.ambito}</span>
                            <span>‚ñº</span>
                        </div>
                        <div class="epvsa-programa-content" style="display:none;">
                            <div class="epvsa-programa-nombre-completo" style="font-size: 0.85rem; color: #555; margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                ${prog.nombre}
                            </div>
                            <div class="epvsa-seccion-titulo">Actuaciones-Tipo (${prog.actuaciones ? prog.actuaciones.length : 0})</div>
                            ${(prog.actuaciones || []).map((act, ai) => `
                                <div class="epvsa-actuacion">
                                    <input type="checkbox" id="chk-act-${linea.id}-${pi}-${ai}" onchange="actualizarStatsPlan()">
                                    <span class="epvsa-actuacion-codigo" style="background: #0074c8; color: white; padding: 0.1rem 0.35rem; border-radius: 3px; font-size: 0.7rem; font-weight: 600; font-family: monospace; margin-right: 0.5rem;">${act.codigo}</span>
                                    <span>${act.nombre}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
    
    // Por defecto, todo desmarcado
    actualizarStatsPlan();
}

function toggleLinea(id) {
    document.getElementById('linea-' + id).classList.toggle('abierta');
}

function toggleObjetivo(lineaId, objIdx) {
    document.getElementById('obj-' + lineaId + '-' + objIdx).classList.toggle('abierto');
}

function togglePrograma(lineaId, progIdx) {
    const prog = document.getElementById('prog-' + lineaId + '-' + progIdx);
    if (prog) {
        prog.classList.toggle('abierto');
        const content = prog.querySelector('.epvsa-programa-content');
        if (content) {
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }
    }
}

function toggleLineaCheck(id) {
    const checked = document.getElementById('chk-linea-' + id).checked;
    const linea = getEstructuraActual().find(l => l.id === id);
    if (!linea) return;
    
    // Marcar/desmarcar objetivos e indicadores
    linea.objetivos.forEach((obj, oi) => {
        const objChk = document.getElementById('chk-obj-' + id + '-' + oi);
        if (objChk) objChk.checked = checked;
        
        obj.indicadores.forEach((_, ii) => {
            const indChk = document.getElementById('chk-ind-' + id + '-' + oi + '-' + ii);
            if (indChk) indChk.checked = checked;
        });
    });
    
    // Marcar/desmarcar programas y actuaciones
    if (linea.programas) {
        linea.programas.forEach((prog, pi) => {
            const progChk = document.getElementById('chk-prog-' + id + '-' + pi);
            if (progChk) progChk.checked = checked;
            
            if (prog.actuaciones) {
                prog.actuaciones.forEach((_, ai) => {
                    const actChk = document.getElementById('chk-act-' + id + '-' + pi + '-' + ai);
                    if (actChk) actChk.checked = checked;
                });
            }
        });
    }
    
    actualizarStatsPlan();
}

function actualizarStatsPlan() {
    let lineas = 0, objetivos = 0, indicadores = 0, programas = 0, actuaciones = 0;
    
    getEstructuraActual().forEach(linea => {
        if (document.getElementById('chk-linea-' + linea.id)?.checked) lineas++;
        
        linea.objetivos.forEach((obj, oi) => {
            if (document.getElementById('chk-obj-' + linea.id + '-' + oi)?.checked) objetivos++;
            
            obj.indicadores.forEach((_, ii) => {
                if (document.getElementById('chk-ind-' + linea.id + '-' + oi + '-' + ii)?.checked) indicadores++;
            });
        });
        
        if (linea.programas) {
            linea.programas.forEach((prog, pi) => {
                if (document.getElementById('chk-prog-' + linea.id + '-' + pi)?.checked) programas++;
                
                if (prog.actuaciones) {
                    prog.actuaciones.forEach((_, ai) => {
                        if (document.getElementById('chk-act-' + linea.id + '-' + pi + '-' + ai)?.checked) actuaciones++;
                    });
                }
            });
        }
    });
    
    document.getElementById('stat-lineas').textContent = lineas;
    document.getElementById('stat-objetivos').textContent = objetivos;
    document.getElementById('stat-indicadores-plan').textContent = indicadores;
    document.getElementById('stat-programas').textContent = programas;
    document.getElementById('stat-actuaciones').textContent = actuaciones;
}

function generarResumenPlan() {
    const container = document.getElementById('plan-resumen-container');
    let html = '<h3>üìã Plan de acci√≥n</h3>';
    html += '<p><strong>Territorio:</strong> ' + getNombreMunicipio(getMunicipioActual()) + '</p>';
    
    getEstructuraActual().forEach(linea => {
        if (!document.getElementById('chk-linea-' + linea.id)?.checked) return;
        
        html += `<div class="destacado" style="border-left-color: ${linea.color}; margin: 1rem 0;">`;
        html += `<h4 style="color: ${linea.color};">${linea.codigo}: ${linea.nombreCorto || linea.nombre}</h4>`;
        
        // Objetivos seleccionados
        linea.objetivos.forEach((obj, oi) => {
            if (!document.getElementById('chk-obj-' + linea.id + '-' + oi)?.checked) return;
            
            html += `<p><strong>${obj.codigo}:</strong> ${obj.nombre}</p>`;
            
            const inds = obj.indicadores.filter((_, ii) => document.getElementById('chk-ind-' + linea.id + '-' + oi + '-' + ii)?.checked);
            if (inds.length) {
                html += '<p><em>Indicadores:</em> ' + inds.join('; ') + '</p>';
            }
        });
        
        // Programas seleccionados
        if (linea.programas) {
            linea.programas.forEach((prog, pi) => {
                if (!document.getElementById('chk-prog-' + linea.id + '-' + pi)?.checked) return;
                
                html += `<p>üìã <strong>${prog.codigo}</strong>: ${prog.nombreCorto || prog.nombre}</p>`;
                
                if (prog.actuaciones) {
                    const acts = prog.actuaciones.filter((_, ai) => document.getElementById('chk-act-' + linea.id + '-' + pi + '-' + ai)?.checked);
                    if (acts.length) {
                        html += '<ul style="margin: 0.25rem 0 0.5rem 1.5rem;">';
                        acts.forEach(a => html += '<li><strong>' + a.codigo + '</strong>: ' + a.nombre + '</li>');
                        html += '</ul>';
                    }
                }
            });
        }
        
        html += '</div>';
    });
    
    container.innerHTML = html;
    container.style.display = 'block';
}

function exportarPlanJSON() {
    const plan = { municipio: getMunicipioActual(), fecha: new Date().toISOString(), lineas: [] };
    
    getEstructuraActual().forEach(linea => {
        if (!document.getElementById('chk-linea-' + linea.id)?.checked) return;
        
        const lineaData = { 
            id: linea.id, 
            codigo: linea.codigo,
            nombre: linea.nombreCorto || linea.nombre, 
            objetivos: [],
            programas: []
        };
        
        linea.objetivos.forEach((obj, oi) => {
            if (!document.getElementById('chk-obj-' + linea.id + '-' + oi)?.checked) return;
            
            const objData = { codigo: obj.codigo, nombre: obj.nombre, indicadores: [] };
            
            obj.indicadores.forEach((ind, ii) => {
                if (document.getElementById('chk-ind-' + linea.id + '-' + oi + '-' + ii)?.checked) {
                    objData.indicadores.push(ind);
                }
            });
            
            lineaData.objetivos.push(objData);
        });
        
        if (linea.programas) {
            linea.programas.forEach((prog, pi) => {
                if (!document.getElementById('chk-prog-' + linea.id + '-' + pi)?.checked) return;
                
                const progData = { codigo: prog.codigo, nombre: prog.nombreCorto || prog.nombre, ambito: prog.ambito, actuaciones: [] };
                
                if (prog.actuaciones) {
                    prog.actuaciones.forEach((act, ai) => {
                        if (document.getElementById('chk-act-' + linea.id + '-' + pi + '-' + ai)?.checked) {
                            progData.actuaciones.push({ codigo: act.codigo, nombre: act.nombre });
                        }
                    });
                }
                
                lineaData.programas.push(progData);
            });
        }
        
        plan.lineas.push(lineaData);
    });
    
    const blob = new Blob([JSON.stringify(plan, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'plan_accion_' + getMunicipioActual() + '.json';
    a.click();
}

// Renderizar Plan de acci√≥n cuando se cambia a Fase 3
document.querySelectorAll('.fase').forEach(f => {
    f.addEventListener('click', () => {
        if (f.dataset.fase === '3') {
            setTimeout(renderPlanAccion, 100);
        }
    });
});

// ==========================================
// NUEVO SISTEMA PLAN DE ACCI√ìN - DUAL MODE
// ==========================================

let propuestaActual = null; // Guarda la propuesta generada

function cambiarModoPlan(modo) {
    document.querySelectorAll('.plan-modo-btn').forEach(b => b.classList.remove('activo'));
    document.getElementById('btn-modo-' + modo).classList.add('activo');
    
    document.getElementById('plan-modo-auto').style.display = modo === 'auto' ? 'block' : 'none';
    document.getElementById('plan-modo-manual').style.display = modo === 'manual' ? 'block' : 'none';
    document.getElementById('plan-documento-container').style.display = 'none';
    
    // Actualizar tarjetas visuales
    const cardAuto = document.getElementById('card-modo-auto');
    const cardManual = document.getElementById('card-modo-manual');
    const badgeAuto = document.getElementById('badge-modo-auto');
    const badgeManual = document.getElementById('badge-modo-manual');
    
    if (cardAuto && cardManual) {
        if (modo === 'auto') {
            cardAuto.style.border = '3px solid #10b981';
            cardAuto.style.boxShadow = '0 4px 20px rgba(16, 185, 129, 0.15)';
            cardManual.style.border = '3px solid #e2e8f0';
            cardManual.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';
            if (badgeAuto) { badgeAuto.style.display = 'block'; badgeAuto.style.background = 'white'; badgeAuto.style.color = '#10b981'; }
            if (badgeManual) { badgeManual.style.display = 'none'; }
        } else {
            cardManual.style.border = '3px solid #6366f1';
            cardManual.style.boxShadow = '0 4px 20px rgba(99, 102, 241, 0.15)';
            cardAuto.style.border = '3px solid #e2e8f0';
            cardAuto.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';
            if (badgeManual) { badgeManual.style.display = 'block'; badgeManual.style.background = 'white'; badgeManual.style.color = '#6366f1'; }
            if (badgeAuto) { badgeAuto.style.display = 'none'; }
        }
    }
    
    if (modo === 'manual') {
        setTimeout(renderPlanAccion, 100);
    }
    // En modo auto: asegurar que el estado inicial es visible (no el progreso)
    if (modo === 'auto') {
        const ini = document.getElementById('auto-ia-estado-inicial');
        const prog = document.getElementById('auto-ia-progreso');
        const res = document.getElementById('propuesta-automatica-container');
        if (ini && !res?.style.display !== 'block') ini.style.display = 'block';
        if (prog) prog.style.display = 'none';
    }
}

// Funci√≥n para cambiar entre tabs del modo manual
function cambiarTabManual(tab) {
    const tabSeleccion    = document.getElementById('tab-seleccion-epvsa');
    const tabVotacion     = document.getElementById('tab-votacion-ciudadana');
    const tabVotacionRelas= document.getElementById('tab-votacion-relas');
    const tabRelas        = document.getElementById('tab-analizador-relas');
    const contenidoSeleccion      = document.getElementById('contenido-tab-seleccion');
    const contenidoVotacion       = document.getElementById('contenido-tab-votacion');
    const contenidoVotacionRelas  = document.getElementById('contenido-tab-votacion-relas');
    const contenidoRelas          = document.getElementById('contenido-tab-relas');

    // Reset todos
    [tabSeleccion, tabVotacion, tabVotacionRelas, tabRelas].forEach(b => {
        if (b) { b.style.background = '#f1f5f9'; b.style.color = '#64748b'; }
    });
    [contenidoSeleccion, contenidoVotacion, contenidoVotacionRelas, contenidoRelas].forEach(c => {
        if (c) c.style.display = 'none';
    });

    if (tab === 'seleccion') {
        tabSeleccion.style.background = '#6366f1';
        tabSeleccion.style.color = 'white';
        contenidoSeleccion.style.display = 'block';
        setTimeout(renderPlanAccion, 100);
    } else if (tab === 'votacion') {
        tabVotacion.style.background = '#ec4899';
        tabVotacion.style.color = 'white';
        contenidoVotacion.style.display = 'block';
    } else if (tab === 'votacion-relas') {
        tabVotacionRelas.style.background = '#0074c8';
        tabVotacionRelas.style.color = 'white';
        contenidoVotacionRelas.style.display = 'block';
        vrelas_actualizarResultados();
        // Redimensionar gr√°ficos ahora que el contenedor es visible
        setTimeout(function() {
            ['bar','radar','dist'].forEach(function(k) {
                if (_vrelasCharts[k]) _vrelasCharts[k].resize();
            });
        }, 50);
    } else if (tab === 'relas') {
        tabRelas.style.background = '#2d6a4f';
        tabRelas.style.color = 'white';
        contenidoRelas.style.display = 'block';
        relas_initSimulatorUI();
    }
}




// Funci√≥n para generar propuesta desde paquete completo (CSV cargados)
function generarPropuestaDesdePaquete() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    // Usar conclusiones, recomendaciones y priorizaci√≥n del CSV
    const conclusiones = datosMunicipioActual.conclusiones || [];
    const recomendaciones = datosMunicipioActual.recomendaciones || [];
    const priorizacion = datosMunicipioActual.priorizacion || [];
    
    // Construir el resumen visual
    let resumenHTML = `<h3>üì¶ Paquete completo de ${nombre}</h3>`;
    
    // Indicar que viene de paquete cargado
    resumenHTML += `
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem; color: #92400e; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.2rem;">üì¶</span>
            <span>Utilizando <strong>conclusiones, recomendaciones y priorizaci√≥n</strong> del paquete cargado (elaboraci√≥n previa).</span>
        </div>`;
    
    // Secci√≥n de Conclusiones
    resumenHTML += `
        <div class="justificacion-box" style="margin-top: 1rem;">
            <h4>üìù Conclusiones</h4>
            <ol style="margin: 0.5rem 0 0 1.5rem; color: #374151;">
                ${conclusiones.map(c => `<li style="margin-bottom: 0.5rem;">${c.texto || c}</li>`).join('')}
            </ol>
        </div>`;
    
    // Secci√≥n de Recomendaciones
    resumenHTML += `
        <div class="justificacion-box" style="margin-top: 1rem; background: #f0fdf4; border-color: #86efac;">
            <h4>üí° Recomendaciones</h4>
            <ol style="margin: 0.5rem 0 0 1.5rem; color: #374151;">
                ${recomendaciones.map(r => `<li style="margin-bottom: 0.5rem;">${r.texto || r.recomendacion || r}</li>`).join('')}
            </ol>
        </div>`;
    
    // Secci√≥n de Priorizaci√≥n
    resumenHTML += `
        <div class="justificacion-box" style="margin-top: 1rem; background: #eff6ff; border-color: #93c5fd;">
            <h4>üéØ Priorizaci√≥n de √Åreas</h4>
            <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-size: 0.9rem;">
                <thead>
                    <tr style="background: #dbeafe;">
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #93c5fd;">√Årea</th>
                        <th style="padding: 0.5rem; text-align: center; border-bottom: 2px solid #93c5fd;">L√≠nea EPVSA</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #93c5fd;">Justificaci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    ${priorizacion.map((p, idx) => `
                        <tr style="background: ${idx % 2 === 0 ? '#f8fafc' : 'white'};">
                            <td style="padding: 0.5rem; font-weight: 600;">${p.area || p.Area || ''}</td>
                            <td style="padding: 0.5rem; text-align: center; font-weight: 700; color: #0074c8;">${p.linea || p.Linea || ''}</td>
                            <td style="padding: 0.5rem; font-size: 0.85rem; color: #64748b;">${p.justificacion || p.Justificacion || ''}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>`;
    
    // Generar propuesta EPVSA basada en la priorizaci√≥n del CSV
    propuestaActual = generarSeleccionDesdePriorizacionCSV(priorizacion);
    
    let detalleHTML = '<h3>üìã Propuesta de Plan de acci√≥n (EPVSA)</h3>';
    
    propuestaActual.forEach(lineaProp => {
        const linea = getEstructuraActual().find(l => l.id === lineaProp.lineaId);
        if (!linea) return;
        
        detalleHTML += `
            <div class="propuesta-linea" style="border-color: ${linea.color};">
                <div class="propuesta-linea-header" style="background: ${linea.color};">
                    <h4>${linea.codigo}: ${linea.nombreCorto || linea.nombre}</h4>
                    <span class="propuesta-linea-relevancia">${lineaProp.relevancia}% relevancia</span>
                </div>
                <div class="propuesta-linea-content">
                    <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">${lineaProp.justificacion || ''}</p>
                    
                    ${lineaProp.objetivos.map(objIdx => {
                        const obj = linea.objetivos[objIdx.objetivoIdx !== undefined ? objIdx.objetivoIdx : objIdx];
                        if (!obj) return '';
                        return `
                            <div class="propuesta-objetivo">
                                <div class="propuesta-objetivo-header">
                                    <span class="propuesta-objetivo-codigo" style="background: ${linea.color};">${obj.codigo}</span>
                                    <span class="propuesta-objetivo-nombre">${obj.nombre}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <div class="propuesta-programas">
                        <h5 style="margin: 1rem 0 0.5rem 0; color: #475569;">üìã programas recomendados</h5>
                        ${(lineaProp.programas || []).map(progIdx => {
                            const idx = progIdx.programaIdx !== undefined ? progIdx.programaIdx : progIdx;
                            const prog = linea.programas ? linea.programas[idx] : null;
                            if (!prog) return '';
                            return `
                                <div class="propuesta-programa">
                                    <div class="propuesta-programa-header">
                                        <span class="propuesta-programa-codigo">${prog.codigo}</span>
                                        <span class="propuesta-programa-nombre">${prog.nombreCorto || prog.nombre}</span>
                                        <span style="background: #f1f5f9; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; color: #64748b; margin-left: 0.5rem;">${prog.ambito}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('propuesta-resumen').innerHTML = resumenHTML;
    document.getElementById('propuesta-detalle').innerHTML = detalleHTML;
    document.getElementById('propuesta-automatica-container').style.display = 'block';
    
    mostrarNotificacion('Propuesta generada desde paquete completo', 'success');
}

// Funci√≥n para generar selecci√≥n EPVSA desde priorizaci√≥n CSV
function generarSeleccionDesdePriorizacionCSV(priorizacion) {
    const propuesta = [];
    const lineasMap = new Map();
    
    // Mapear √°reas del CSV a l√≠neas EPVSA
    const areaToLineaMap = {
        'bienestar emocional': { linea: 1, objetivo: 3, programas: [0, 2, 7] },
        'vida activa': { linea: 1, objetivo: 1, programas: [0, 1, 2, 5] },
        'alimentaci√≥n saludable': { linea: 1, objetivo: 0, programas: [0, 2, 5] },
        'alimentacion saludable': { linea: 1, objetivo: 0, programas: [0, 2, 5] },
        'sue√±o saludable': { linea: 1, objetivo: 2, programas: [0, 2] },
        'sueno saludable': { linea: 1, objetivo: 2, programas: [0, 2] },
        'vida sin humo': { linea: 1, objetivo: 0, programas: [0, 1, 2, 5] },
        'activos para la salud': { linea: 1, objetivo: 6, programas: [0, 3] },
        'entornos promotores': { linea: 1, objetivo: 6, programas: [0, 1, 3] },
        'participaci√≥n ciudadana': { linea: 1, objetivo: 6, programas: [0] },
        'participacion ciudadana': { linea: 1, objetivo: 6, programas: [0] },
        'informaci√≥n y comunicaci√≥n': { linea: 3, objetivo: 0, programas: [0] },
        'informacion y comunicacion': { linea: 3, objetivo: 0, programas: [0] },
        'formaci√≥n': { linea: 4, objetivo: 0, programas: [0] },
        'formacion': { linea: 4, objetivo: 0, programas: [0] }
    };
    
    priorizacion.forEach((p, idx) => {
        const areaNombre = (p.area || p.Area || '').toLowerCase();
        const lineaCSV = parseInt(p.linea || p.Linea || 1);
        
        // Buscar mapeo por nombre de √°rea
        let config = null;
        for (const [key, val] of Object.entries(areaToLineaMap)) {
            if (areaNombre.includes(key)) {
                config = val;
                break;
            }
        }
        
        // Si no encuentra, usar la l√≠nea del CSV
        if (!config) {
            config = { linea: lineaCSV, objetivo: 0, programas: [0] };
        }
        
        const lineaId = config.linea;
        
        if (!lineasMap.has(lineaId)) {
            lineasMap.set(lineaId, {
                lineaId,
                relevancia: 90 - (idx * 5),
                objetivos: new Set(),
                programas: new Set(),
                justificaciones: []
            });
        }
        
        const linea = lineasMap.get(lineaId);
        linea.objetivos.add(config.objetivo);
        config.programas.forEach(p => linea.programas.add(p));
        linea.justificaciones.push(p.area || p.Area);
    });
    
    // Convertir a array
    lineasMap.forEach(linea => {
        propuesta.push({
            lineaId: linea.lineaId,
            relevancia: linea.relevancia,
            justificacion: `√Åreas: ${linea.justificaciones.join(', ')}`,
            objetivos: [...linea.objetivos].map(idx => ({ objetivoIdx: idx, indicadores: [] })),
            programas: [...linea.programas].map(idx => ({ programaIdx: idx, actuaciones: [] }))
        });
    });
    
    // A√±adir L3 y L4 si no est√°n
    if (!propuesta.find(p => p.lineaId === 3)) {
        propuesta.push({
            lineaId: 3,
            relevancia: 70,
            justificacion: 'Informaci√≥n y comunicaci√≥n',
            objetivos: [{ objetivoIdx: 0, indicadores: [] }],
            programas: [{ programaIdx: 0, actuaciones: [] }]
        });
    }
    if (!propuesta.find(p => p.lineaId === 4)) {
        propuesta.push({
            lineaId: 4,
            relevancia: 65,
            justificacion: 'Formaci√≥n, investigaci√≥n e innovaci√≥n',
            objetivos: [{ objetivoIdx: 0, indicadores: [] }],
            programas: [{ programaIdx: 0, actuaciones: [] }]
        });
    }
    
    return propuesta.sort((a, b) => b.relevancia - a.relevancia);
}


// =====================================================
// SISTEMA DE AN√ÅLISIS SALUTOG√âNICO - ENFOQUE DE ACTIVOS
// =====================================================

// Mapeo tem√°tico: relaciona determinantes e indicadores con √°reas de promoci√≥n y l√≠neas EPVSA
const MAPEO_TEMATICO = {
    bienestarEmocional: {
        nombre: 'bienestar emocional',
        descripcion: 'Calidad de vida percibida y salud emocional',
        determinantes: ['P7', 'P7b', 'P12a', 'P12b', 'P12c', 'P57b1', 'P57b2', 'P57b3', 'P57b4', 'P57b5', 'P57b6'],
        indicadoresKeywords: ['ansiedad', '√°nimo', 'emocional', 'psicotrop', 'demencia'],
        lineaEPVSA: 1,
        objetivoEPVSA: 3, // OE 1.4
        programas: [0, 2, 7, 8] // P01, P03, P08, P09
    },
    vidaActiva: {
        nombre: 'vida activa',
        descripcion: 'Actividad f√≠sica y movilidad saludable',
        determinantes: ['P34', 'P34a_intenso', 'P34a_moderado', 'P34a_nada'],
        indicadoresKeywords: ['actividad f√≠sica', 'sedentarismo', 'ejercicio'],
        lineaEPVSA: 1,
        objetivoEPVSA: 1, // OE 1.2
        programas: [0, 1, 2, 5, 11] // P01, P02, P03, P06, P12
    },
    alimentacionSaludable: {
        nombre: 'alimentaci√≥n saludable',
        descripcion: 'Dieta mediterr√°nea y h√°bitos alimentarios',
        determinantes: ['P36b1', 'P36b_aceite', 'P36b_verdura', 'P36b_fruta', 'P36b_carne', 'P36b_azucar', 'P36b_legumbres', 'P36b_pescado', 'PREDIMED'],
        indicadoresKeywords: ['dieta', 'alimenta', 'obesidad', 'lactancia', 'fruta'],
        lineaEPVSA: 1,
        objetivoEPVSA: 0, // OE 1.1
        programas: [0, 2, 5, 6] // P01, P03, P06, P07
    },
    suenoSaludable: {
        nombre: 'sue√±o saludable',
        descripcion: 'Descanso y calidad del sue√±o',
        determinantes: ['P33', 'P33_fin', 'P33a', 'P33b_insomnio'],
        indicadoresKeywords: ['sue√±o', 'descanso', 'insomnio'],
        lineaEPVSA: 1,
        objetivoEPVSA: 2, // OE 1.3
        programas: [0, 2, 11] // P01, P03, P12
    },
    vidaSinHumo: {
        nombre: 'vida sin humo',
        descripcion: 'Prevenci√≥n del tabaquismo',
        determinantes: ['P23', 'P23_ex', 'P25d'],
        indicadoresKeywords: ['tabaco', 'fumador', 'cigarrillo'],
        lineaEPVSA: 1,
        objetivoEPVSA: 0,
        programas: [0, 1, 2, 5, 11] // P01, P02, P03, P06, P12
    },
    consumoResponsable: {
        nombre: 'consumo responsable de Alcohol',
        descripcion: 'Prevenci√≥n del consumo de riesgo',
        determinantes: ['P29', 'P32_CAGE'],
        indicadoresKeywords: ['alcohol', 'CAGE', 'sustancia'],
        lineaEPVSA: 1,
        objetivoEPVSA: 0,
        programas: [0, 2, 5] // P01, P03, P06
    },
    entornoSaludable: {
        nombre: 'Percepci√≥n de entornos promotores de salud',
        descripcion: 'Percepci√≥n ciudadana sobre calidad ambiental y vivienda (datos de autorreporte EAS)',
        determinantes: ['P4d_frio', 'P4d_calor', 'P5_ruido', 'P5_olores', 'P5_contaminacion', 'P5_industria', 'P5_zonas_verdes', 'P5_delincuencia', 'P5_trafico', 'P5b'],
        indicadoresKeywords: ['ambiente', 'vivienda', 'entorno'],
        lineaEPVSA: 1,
        objetivoEPVSA: 6, // OE 1.7
        programas: [0, 1, 3] // P01, P02, P04
    },
    apoyoSocial: {
        nombre: 'redes de apoyo social',
        descripcion: 'Apoyo comunitario y prevenci√≥n de soledad',
        determinantes: ['DUKE_bajo', 'DUKE_media'],
        indicadoresKeywords: ['apoyo', 'social', 'comunitario'],
        lineaEPVSA: 1,
        objetivoEPVSA: 6,
        programas: [0, 3, 7] // P01, P04, P08
    },
    situacionEconomica: {
        nombre: 'Equidad y determinantes sociales',
        descripcion: 'Reducci√≥n de inequidades en salud',
        determinantes: ['P71_dificultad', 'P71_mucha_dif'],
        indicadoresKeywords: ['econ√≥mic', 'social', 'inequidad'],
        lineaEPVSA: 1,
        objetivoEPVSA: 6,
        programas: [0, 7] // P01, P08
    }
};

// =====================================================
// =====================================================
// GENERADOR DE NARRATIVA SALUTOG√âNICA
// Produce texto profesional interpretando los datos
// =====================================================

function generarNarrativaSalutogenica(analisis) {
    const municipio = analisis.municipio || 'El municipio';
    const narrativa = {
        contexto: '',
        activos: '',
        oportunidades: '',
        patrones: '',
        sintesis: ''
    };
    
    // Datos del an√°lisis
    const fortalezas = analisis.fortalezas || [];
    const oportunidades = analisis.oportunidades || [];
    const datosAnalisis = analisis.datosAnalisis || {};
    
    // Agrupar por √°rea
    const areasConFortaleza = [...new Set(fortalezas.map(f => f.area))];
    const areasConOportunidad = [...new Set(oportunidades.map(o => o.area))];
    
    // Mapear nombres de √°rea a claves de plantilla
    const nombreAKey = {};
    Object.entries(PLANTILLAS_SALUTOGENICAS).forEach(([key, val]) => {
        nombreAKey[val.nombre.toLowerCase()] = key;
    });
    
    // =========================================
    // 1. CONTEXTO INTRODUCTORIO
    // =========================================
    const totalDeterminantes = datosAnalisis.totalDeterminantes || 0;
    const totalIndicadores = datosAnalisis.totalIndicadores || 0;
    
    narrativa.contexto = `El presente an√°lisis examina el perfil de salud de ${municipio} desde un enfoque salutog√©nico, ` +
        `priorizando la identificaci√≥n de recursos y activos que generan salud en la comunidad. ` +
        `Se han analizado ${totalDeterminantes} determinantes de la Encuesta Andaluza de Salud ` +
        `y ${totalIndicadores} indicadores del cuadro de mandos integral, comparando los valores locales ` +
        `con las referencias provinciales y auton√≥micas.\n\n` +
        `Este enfoque, coherente con la Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a (EPVSA 2024-2030), ` +
        `busca responder a la pregunta "¬øqu√© genera salud aqu√≠?" antes que centrarse √∫nicamente en los problemas. ` +
        `El objetivo es construir sobre las fortalezas existentes mientras se abordan las √°reas de mejora.`;
    
    // =========================================
    // 2. ACTIVOS Y FORTALEZAS
    // =========================================
    if (fortalezas.length > 0) {
        let textoActivos = `${municipio} presenta fortalezas significativas que constituyen activos para la salud comunitaria:\n\n`;
        
        areasConFortaleza.forEach(areaNombre => {
            const areaKey = nombreAKey[areaNombre.toLowerCase()];
            const plantilla = areaKey ? PLANTILLAS_SALUTOGENICAS[areaKey] : null;
            const fortalezasArea = fortalezas.filter(f => f.area === areaNombre);
            
            if (plantilla) {
                textoActivos += `**${plantilla.nombre}**: ${plantilla.fortaleza} `;
                
                // A√±adir datos concretos
                if (fortalezasArea.length > 0) {
                    const ejemplos = fortalezasArea.slice(0, 2).map(f => 
                        `${f.texto} (${f.valor}% frente a ${f.refAndalucia}% de media andaluza)`
                    );
                    textoActivos += `En concreto: ${ejemplos.join('; ')}. `;
                }
                
                // Mencionar activos potenciales
                if (plantilla.activos && plantilla.activos.length > 0) {
                    textoActivos += `Entre los activos a dinamizar: ${plantilla.activos.slice(0, 3).join(', ')}.\n\n`;
                } else {
                    textoActivos += '\n\n';
                }
            }
        });
        
        narrativa.activos = textoActivos;
    } else {
        narrativa.activos = `El an√°lisis no ha identificado √°reas con valores significativamente superiores a la media andaluza. ` +
            `Esto no implica ausencia de activos para la salud, sino que los indicadores cuantitativos se sit√∫an en rangos similares ` +
            `a los valores de referencia. El mapeo cualitativo de activos comunitarios complementar√° este an√°lisis.`;
    }
    
    // =========================================
    // 3. OPORTUNIDADES DE MEJORA
    // =========================================
    if (oportunidades.length > 0) {
        let textoOportunidades = `Se identifican √°reas donde la acci√≥n comunitaria puede facilitar mejoras en salud:\n\n`;
        
        areasConOportunidad.forEach(areaNombre => {
            const areaKey = nombreAKey[areaNombre.toLowerCase()];
            const plantilla = areaKey ? PLANTILLAS_SALUTOGENICAS[areaKey] : null;
            const oportunidadesArea = oportunidades.filter(o => o.area === areaNombre);
            
            if (plantilla) {
                textoOportunidades += `**${plantilla.nombre}**: ${plantilla.oportunidad} `;
                
                // A√±adir datos concretos
                if (oportunidadesArea.length > 0) {
                    const ejemplos = oportunidadesArea.slice(0, 2).map(o => 
                        `${o.texto} (${o.valor}% frente a ${o.refAndalucia}% andaluz)`
                    );
                    textoOportunidades += `Los datos muestran: ${ejemplos.join('; ')}.\n\n`;
                } else {
                    textoOportunidades += '\n\n';
                }
            }
        });
        
        narrativa.oportunidades = textoOportunidades;
    } else {
        narrativa.oportunidades = `No se han identificado √°reas con valores significativamente inferiores a la media andaluza. ` +
            `El municipio presenta un perfil favorable en los indicadores analizados, lo que permite orientar el Plan ` +
            `hacia la consolidaci√≥n de las fortalezas existentes y la prevenci√≥n.`;
    }
    
    // =========================================
    // 4. DETECCI√ìN DE PATRONES
    // =========================================
    let textoPatrones = '';
    const patronesDetectados = [];
    
    Object.entries(PATRONES_SALUTOGENICOS).forEach(([patronKey, patron]) => {
        // Contar cu√°ntas √°reas del patr√≥n tienen datos
        let areasConDatos = 0;
        let tieneFortaleza = false;
        let tieneOportunidad = false;
        
        patron.areas.forEach(areaKey => {
            const plantilla = PLANTILLAS_SALUTOGENICAS[areaKey];
            if (plantilla) {
                const nombreArea = plantilla.nombre.toLowerCase();
                if (areasConFortaleza.map(a => a.toLowerCase()).includes(nombreArea)) {
                    areasConDatos++;
                    tieneFortaleza = true;
                }
                if (areasConOportunidad.map(a => a.toLowerCase()).includes(nombreArea)) {
                    areasConDatos++;
                    tieneOportunidad = true;
                }
            }
        });
        
        // Si alcanza el umbral, a√±adir narrativa del patr√≥n
        if (areasConDatos >= patron.umbralMinimo) {
            let narrativaPatron = '';
            if (tieneFortaleza && !tieneOportunidad) {
                narrativaPatron = patron.narrativaFortaleza;
            } else if (!tieneFortaleza && tieneOportunidad) {
                narrativaPatron = patron.narrativaOportunidad;
            } else {
                narrativaPatron = patron.narrativaMixta;
            }
            
            patronesDetectados.push({
                nombre: patron.nombre,
                narrativa: narrativaPatron
            });
        }
    });
    
    if (patronesDetectados.length > 0) {
        textoPatrones = `El an√°lisis identifica patrones transversales que conectan diferentes √°reas:\n\n`;
        patronesDetectados.forEach(p => {
            textoPatrones += `**${p.nombre}**: ${p.narrativa}\n\n`;
        });
    } else {
        textoPatrones = `Los datos analizados no muestran patrones transversales marcados entre las diferentes √°reas. ` +
            `Esto sugiere que cada dimensi√≥n puede abordarse de forma relativamente independiente, ` +
            `aunque siempre manteniendo la visi√≥n integral de la salud comunitaria.`;
    }
    
    narrativa.patrones = textoPatrones;
    
    // =========================================
    // 5. S√çNTESIS Y ORIENTACI√ìN
    // =========================================
    const balanceGeneral = fortalezas.length >= oportunidades.length ? 'favorable' : 'con margen de mejora';
    const enfoquePrioritario = fortalezas.length >= oportunidades.length ? 
        'consolidar las fortalezas existentes y prevenir su deterioro' : 
        'abordar las oportunidades de mejora apoy√°ndose en los activos disponibles';
    
    narrativa.sintesis = `En s√≠ntesis, ${municipio} presenta un perfil de salud ${balanceGeneral}. ` +
        `El Plan local de salud deber√≠a ${enfoquePrioritario}.\n\n` +
        `Desde el enfoque salutog√©nico, la pregunta clave no es solo "¬øqu√© problemas debemos resolver?" ` +
        `sino "¬øqu√© recursos tenemos para generar salud?". Los activos identificados ‚Äîformales e informales, ` +
        `institucionales y comunitarios‚Äî constituyen la base sobre la que construir intervenciones sostenibles ` +
        `y culturalmente apropiadas.\n\n` +
        `Las recomendaciones que siguen traducen este an√°lisis en l√≠neas de actuaci√≥n concretas, ` +
        `acompasadas con la EPVSA 2024-2030 y adaptadas a la realidad local.`;
    
    return narrativa;
}

// Funci√≥n auxiliar para obtener narrativa completa como texto
function obtenerNarrativaCompleta(analisis) {
    const n = generarNarrativaSalutogenica(analisis);
    return `## An√°lisis salutog√©nico del perfil de salud\n\n` +
        `### Contexto\n\n${n.contexto}\n\n` +
        `### Activos y fortalezas\n\n${n.activos}\n\n` +
        `### Oportunidades de mejora\n\n${n.oportunidades}\n\n` +
        `### Patrones transversales\n\n${n.patrones}\n\n` +
        `### S√≠ntesis\n\n${n.sintesis}`;
}

// Conclusiones fijas (estructurales) - aparecen siempre
// =====================================================
// MARCO TE√ìRICO: AN√ÅLISIS SALUTOG√âNICO PROFESIONAL
// Basado en: Antonovsky (SOC), Ottawa Charter, EPVSA
// =====================================================

// Plantillas narrativas por √°rea tem√°tica
const PLANTILLAS_SALUTOGENICAS = {
    bienestarEmocional: {
        nombre: 'Bienestar emocional',
        contexto: 'El bienestar emocional constituye un activo fundamental para la salud comunitaria. M√°s all√° de la ausencia de malestar, implica la capacidad de las personas para desarrollar su potencial, afrontar las tensiones de la vida y contribuir a su comunidad.',
        fortaleza: 'La poblaci√≥n presenta indicadores favorables de bienestar emocional, lo que sugiere la existencia de recursos comunitarios protectores que conviene identificar y potenciar.',
        oportunidad: 'Se identifica margen para fortalecer el bienestar emocional mediante la dinamizaci√≥n de activos comunitarios: espacios de encuentro, redes de apoyo mutuo y actividades que generen sentido de pertenencia.',
        activos: ['espacios de encuentro vecinal', 'asociaciones culturales y recreativas', 'programas de envejecimiento activo', 'grupos de apoyo mutuo', 'servicios de atenci√≥n comunitaria'],
        conexiones: ['apoyoSocial', 'suenoSaludable', 'vidaActiva']
    },
    vidaActiva: {
        nombre: 'Vida activa',
        contexto: 'La actividad f√≠sica regular es uno de los determinantes modificables con mayor impacto en la salud. El enfoque salutog√©nico prioriza facilitar entornos que inviten al movimiento cotidiano sobre la prescripci√≥n individual de ejercicio.',
        fortaleza: 'Los datos reflejan niveles favorables de actividad f√≠sica, indicando que el municipio cuenta con condiciones que facilitan una vida activa.',
        oportunidad: 'Existe potencial para incrementar la actividad f√≠sica cotidiana aprovechando y mejorando los activos existentes: espacios p√∫blicos, rutas peatonales y equipamientos deportivos accesibles.',
        activos: ['parques y zonas verdes', 'carriles bici y rutas peatonales', 'instalaciones deportivas municipales', 'programas de actividad f√≠sica comunitaria', 'entorno natural cercano'],
        conexiones: ['alimentacionSaludable', 'bienestarEmocional', 'entornoSaludable']
    },
    alimentacionSaludable: {
        nombre: 'Alimentaci√≥n saludable',
        contexto: 'La alimentaci√≥n saludable depende tanto de las elecciones individuales como del entorno alimentario. Un enfoque salutog√©nico busca que la opci√≥n saludable sea la opci√≥n f√°cil, accesible y asequible.',
        fortaleza: 'Los patrones alimentarios de la poblaci√≥n muestran aspectos positivos que reflejan la cultura alimentaria local y el acceso a productos de calidad.',
        oportunidad: 'Se detecta margen para mejorar h√°bitos alimentarios mediante el fortalecimiento del sistema alimentario local: mercados, comercio de proximidad y educaci√≥n alimentaria.',
        activos: ['mercados locales y de proximidad', 'huertos urbanos y comunitarios', 'tradici√≥n gastron√≥mica mediterr√°nea', 'comercio local de alimentaci√≥n', 'programas de comedores escolares saludables'],
        conexiones: ['vidaActiva', 'situacionEconomica']
    },
    suenoSaludable: {
        nombre: 'Sue√±o saludable',
        contexto: 'El descanso adecuado es un pilar frecuentemente invisibilizado de la salud. La calidad del sue√±o est√° influida por factores ambientales, laborales y de estilo de vida que pueden abordarse desde la acci√≥n comunitaria.',
        fortaleza: 'La poblaci√≥n presenta patrones de descanso favorables, lo que constituye un recurso protector para la salud f√≠sica y mental.',
        oportunidad: 'Se identifica la oportunidad de promover entornos y h√°bitos que favorezcan el descanso, especialmente la reducci√≥n de exposici√≥n a pantallas y la mejora de condiciones ambientales.',
        activos: ['espacios libres de contaminaci√≥n ac√∫stica', 'programas de higiene del sue√±o', 'regulaci√≥n de iluminaci√≥n nocturna', 'actividades de relajaci√≥n comunitarias'],
        conexiones: ['bienestarEmocional', 'entornoSaludable']
    },
    vidaSinHumo: {
        nombre: 'Vida sin humo',
        contexto: 'El tabaquismo sigue siendo la primera causa de mortalidad evitable. El enfoque salutog√©nico complementa la prevenci√≥n del consumo con la creaci√≥n de entornos libres de humo que desnormalicen el tabaco.',
        fortaleza: 'Los datos muestran una prevalencia de tabaquismo inferior a la media, reflejando el impacto positivo de las pol√≠ticas de espacios sin humo y la concienciaci√≥n ciudadana.',
        oportunidad: 'Existe margen para consolidar la tendencia hacia una vida sin humo, especialmente en la prevenci√≥n del inicio del consumo en j√≥venes y el apoyo a quienes desean dejar de fumar.',
        activos: ['espacios p√∫blicos libres de humo', 'consultas de deshabituaci√≥n tab√°quica', 'centros educativos promotores de salud', 'normativa local de protecci√≥n'],
        conexiones: ['consumoResponsable', 'entornoSaludable']
    },
    consumoResponsable: {
        nombre: 'Consumo responsable de alcohol',
        contexto: 'El consumo de alcohol est√° normalizado culturalmente, lo que dificulta su abordaje. Un enfoque salutog√©nico busca ofrecer alternativas de ocio saludable y reducir la presi√≥n social hacia el consumo.',
        fortaleza: 'Los indicadores de consumo de riesgo se sit√∫an por debajo de la media regional, sugiriendo la existencia de factores protectores en la comunidad.',
        oportunidad: 'Se detecta potencial para promover el consumo responsable mediante alternativas de ocio, regulaci√≥n de la disponibilidad y sensibilizaci√≥n sobre riesgos.',
        activos: ['oferta de ocio alternativo', 'asociaciones juveniles', 'programas de prevenci√≥n en centros educativos', 'normativa local sobre venta y consumo'],
        conexiones: ['bienestarEmocional', 'vidaSinHumo']
    },
    entornoSaludable: {
        nombre: 'Percepci√≥n de entornos promotores de salud',
        contexto: 'La percepci√≥n ciudadana del entorno f√≠sico refleja la experiencia vivida de las condiciones ambientales. Estos datos de autorreporte (EAS) complementan, pero no sustituyen, mediciones objetivas de calidad ambiental.',
        fortaleza: 'La poblaci√≥n percibe condiciones ambientales favorables en su entorno, lo que puede indicar tanto calidad objetiva como adaptaci√≥n o satisfacci√≥n subjetiva.',
        oportunidad: 'Se identifican percepciones negativas del entorno f√≠sico que, requiriendo verificaci√≥n con datos objetivos, se√±alan √°reas de potencial intervenci√≥n.',
        activos: ['zonas verdes y espacios naturales', 'calidad del aire', 'infraestructura peatonal segura', 'vivienda adecuada', 'reducci√≥n de contaminaci√≥n ac√∫stica'],
        conexiones: ['vidaActiva', 'suenoSaludable', 'bienestarEmocional'],
        nota: 'IMPORTANTE: Estos datos reflejan percepciones ciudadanas, no mediciones objetivas. Para intervenciones ambientales, contrastar con datos de calidad del aire, mapas de ruido u otras fuentes t√©cnicas.'
    },
    apoyoSocial: {
        nombre: 'Redes de apoyo social',
        contexto: 'El apoyo social es uno de los determinantes m√°s potentes de la salud. Las redes de relaciones protegen frente a la enfermedad, facilitan la recuperaci√≥n y generan sentido de pertenencia.',
        fortaleza: 'La poblaci√≥n presenta niveles adecuados de apoyo social percibido, indicando la existencia de redes relacionales que act√∫an como recurso protector.',
        oportunidad: 'Se detecta la necesidad de fortalecer las redes de apoyo, especialmente para prevenir la soledad no deseada en personas mayores y otros colectivos vulnerables.',
        activos: ['tejido asociativo', 'centros de mayores', 'redes vecinales', 'voluntariado organizado', 'espacios de encuentro intergeneracional'],
        conexiones: ['bienestarEmocional', 'situacionEconomica']
    },
    situacionEconomica: {
        nombre: 'Equidad y determinantes sociales',
        contexto: 'Las condiciones socioecon√≥micas son el determinante m√°s estructural de la salud. Aunque escapan al √°mbito estrictamente sanitario, el Plan local puede contribuir a reducir su impacto en las desigualdades en salud.',
        fortaleza: 'Los indicadores socioecon√≥micos del municipio se sit√∫an en niveles que facilitan el acceso a recursos para la salud.',
        oportunidad: 'Se identifica la necesidad de incorporar la perspectiva de equidad en todas las actuaciones, priorizando intervenciones en zonas o colectivos con mayores dificultades.',
        activos: ['servicios sociales municipales', 'programas de inclusi√≥n', 'recursos de empleo y formaci√≥n', 'ayudas municipales', 'bancos de alimentos y recursos comunitarios'],
        conexiones: ['apoyoSocial', 'alimentacionSaludable']
    }
};

// Patrones salutog√©nicos (clusters narrativos)
const PATRONES_SALUTOGENICOS = {
    bienestarIntegral: {
        nombre: 'Bienestar integral',
        areas: ['bienestarEmocional', 'suenoSaludable', 'apoyoSocial'],
        umbralMinimo: 2,
        narrativaFortaleza: 'Se observa un patr√≥n coherente de bienestar integral: la calidad del descanso, el apoyo social percibido y la salud emocional se refuerzan mutuamente, constituyendo un c√≠rculo virtuoso que el Plan puede consolidar.',
        narrativaOportunidad: 'Los datos sugieren una interconexi√≥n entre descanso, apoyo social y bienestar emocional que requiere un abordaje integrado. Las intervenciones en cualquiera de estas √°reas pueden tener efectos positivos en las dem√°s.',
        narrativaMixta: 'El municipio presenta un perfil mixto en el eje de bienestar integral: mientras algunas dimensiones muestran fortalezas, otras ofrecen margen de mejora. Este patr√≥n sugiere priorizar intervenciones que refuercen las conexiones entre √°reas.'
    },
    estilosVidaActivos: {
        nombre: 'Estilos de vida activos',
        areas: ['vidaActiva', 'alimentacionSaludable', 'entornoSaludable'],
        umbralMinimo: 2,
        narrativaFortaleza: 'El municipio cuenta con condiciones favorables para estilos de vida activos: entorno f√≠sico adecuado, niveles de actividad f√≠sica y patrones alimentarios que se refuerzan mutuamente.',
        narrativaOportunidad: 'Existe potencial para desarrollar un ecosistema de vida activa que conecte alimentaci√≥n, movimiento y entorno. Las mejoras en infraestructura, acceso a alimentaci√≥n saludable y promoci√≥n de actividad f√≠sica pueden potenciarse mutuamente.',
        narrativaMixta: 'El perfil de estilos de vida muestra aspectos positivos junto con oportunidades de mejora. Un enfoque integrado que conecte entorno, alimentaci√≥n y actividad f√≠sica maximizar√° el impacto de las intervenciones.'
    },
    prevencionConsumos: {
        nombre: 'Prevenci√≥n de consumos de riesgo',
        areas: ['vidaSinHumo', 'consumoResponsable'],
        umbralMinimo: 2,
        narrativaFortaleza: 'Los indicadores de consumo de tabaco y alcohol se sit√∫an en niveles favorables, reflejando el impacto de las pol√≠ticas preventivas y la existencia de alternativas de ocio saludable.',
        narrativaOportunidad: 'La prevenci√≥n de consumos de riesgo requiere un abordaje coordinado que combine regulaci√≥n, alternativas de ocio saludable y apoyo a quienes desean modificar sus h√°bitos.',
        narrativaMixta: 'El perfil de consumos muestra resultados dispares entre tabaco y alcohol, sugiriendo la necesidad de estrategias diferenciadas pero coordinadas.'
    },
    cohesionComunitaria: {
        nombre: 'Cohesi√≥n comunitaria',
        areas: ['apoyoSocial', 'situacionEconomica', 'bienestarEmocional'],
        umbralMinimo: 2,
        narrativaFortaleza: 'El municipio presenta indicadores de cohesi√≥n comunitaria que act√∫an como factor protector: redes de apoyo, inclusi√≥n social y bienestar emocional configuran una comunidad resiliente.',
        narrativaOportunidad: 'El fortalecimiento de la cohesi√≥n comunitaria es una estrategia transversal que puede mejorar m√∫ltiples indicadores de salud. Invertir en redes de apoyo, reducir desigualdades y promover la participaci√≥n genera retornos en todas las √°reas.',
        narrativaMixta: 'Los indicadores de cohesi√≥n comunitaria muestran un perfil heterog√©neo. Fortalecer los v√≠nculos entre apoyo social, inclusi√≥n y bienestar emocional potenciar√° la capacidad de la comunidad para generar salud.'
    }
};

// Dimensiones del Sentido de Coherencia (Antonovsky)
const DIMENSIONES_SOC = {
    comprensibilidad: {
        nombre: 'Comprensibilidad',
        descripcion: 'Capacidad de entender los est√≠mulos del entorno como informaci√≥n ordenada, coherente y predecible',
        indicadores: ['acceso informaci√≥n salud', 'alfabetizaci√≥n en salud', 'comunicaci√≥n clara'],
        preguntaClave: '¬øLa comunidad entiende los factores que influyen en su salud?'
    },
    manejabilidad: {
        nombre: 'Manejabilidad',
        descripcion: 'Percepci√≥n de que se dispone de recursos adecuados para afrontar las demandas del entorno',
        indicadores: ['apoyo social', 'acceso servicios', 'recursos econ√≥micos', 'redes comunitarias'],
        preguntaClave: '¬øLa comunidad percibe que tiene recursos suficientes para cuidar su salud?'
    },
    significatividad: {
        nombre: 'Significatividad',
        descripcion: 'Sentido de que la vida tiene sentido y merece la pena invertir energ√≠a en los desaf√≠os',
        indicadores: ['bienestar emocional', 'participaci√≥n', 'sentido de pertenencia', 'proyectos vitales'],
        preguntaClave: '¬øLa comunidad encuentra sentido y motivaci√≥n para cuidar su salud?'
    }
};

// Determinantes sociales estructurales (Dahlgren & Whitehead adaptado)
const CAPAS_DETERMINANTES = {
    individual: {
        nombre: 'Factores individuales',
        descripcion: 'Edad, sexo, factores hereditarios',
        modificable: false,
        indicadores: ['P7', 'P7b', 'P8a', 'P8b']
    },
    estilosVida: {
        nombre: 'Estilos de vida',
        descripcion: 'Comportamientos relacionados con la salud',
        modificable: true,
        indicadores: ['P23', 'P29', 'P34', 'P34a_nada', 'PREDIMED', 'P33a']
    },
    redesSociales: {
        nombre: 'Redes sociales y comunitarias',
        descripcion: 'Apoyo social, cohesi√≥n comunitaria, participaci√≥n',
        modificable: true,
        indicadores: ['DUKE_bajo', 'DUKE_media', 'P57b3', 'P13']
    },
    condicionesVida: {
        nombre: 'Condiciones de vida y trabajo',
        descripcion: 'Vivienda, entorno, condiciones laborales',
        modificable: true,
        indicadores: ['P4d_frio', 'P4d_calor', 'P5_ruido', 'P5_contaminacion', 'P5_zonas_verdes', 'P34']
    },
    estructurales: {
        nombre: 'Condiciones socioecon√≥micas',
        descripcion: 'Situaci√≥n econ√≥mica, educaci√≥n, empleo',
        modificable: true,
        indicadores: ['P71_dificultad', 'P71_mucha_dif']
    }
};

// Ciclo vital y vulnerabilidades espec√≠ficas
const CICLO_VITAL = {
    infancia: {
        nombre: 'Infancia (0-14)',
        prioridades: ['alimentaci√≥n', 'actividad f√≠sica', 'entorno seguro', 'desarrollo emocional'],
        activos: ['centros educativos', 'espacios de juego', 'programas de salud infantil', 'familias'],
        vulnerabilidades: ['pobreza infantil', 'sedentarismo', 'alimentaci√≥n inadecuada', 'exposiciones ambientales']
    },
    juventud: {
        nombre: 'Juventud (15-29)',
        prioridades: ['salud mental', 'consumos', 'relaciones', 'proyecto vital'],
        activos: ['centros educativos', 'espacios de ocio', 'asociaciones juveniles', 'empleo'],
        vulnerabilidades: ['consumo de sustancias', 'salud mental', 'precariedad', 'presi√≥n social']
    },
    adultos: {
        nombre: 'Adultos (30-64)',
        prioridades: ['conciliaci√≥n', 'enfermedades cr√≥nicas', 'estr√©s laboral', 'cuidados'],
        activos: ['centros de trabajo', 'servicios sanitarios', 'redes familiares', 'ocio'],
        vulnerabilidades: ['sedentarismo laboral', 'estr√©s', 'sobrecarga de cuidados', 'aislamiento']
    },
    mayores: {
        nombre: 'Personas mayores (65+)',
        prioridades: ['autonom√≠a', 'soledad', 'fragilidad', 'participaci√≥n'],
        activos: ['centros de mayores', 'programas de envejecimiento activo', 'voluntariado', 'redes vecinales'],
        vulnerabilidades: ['soledad no deseada', 'fragilidad', 'pobreza energ√©tica', 'dependencia']
    }
};

// Conclusiones estructurales (marco conceptual)
const CONCLUSIONES_FIJAS = [
    {
        id: 'marco_salutogenico',
        texto: 'El presente an√°lisis se fundamenta en el modelo salutog√©nico de Antonovsky, que orienta la mirada hacia los recursos y capacidades que generan salud (activos para la salud) m√°s que hacia los factores de riesgo y d√©ficits. Este enfoque permite identificar las fortalezas comunitarias sobre las que construir el Plan local de salud.',
        prioridad: 1,
        categoria: 'marco_teorico'
    },
    {
        id: 'determinantes_sociales',
        texto: 'La salud de la poblaci√≥n est√° determinada por factores que van m√°s all√° de los comportamientos individuales: las condiciones socioecon√≥micas, el entorno f√≠sico, las redes de apoyo social y el acceso a recursos configuran el gradiente social en salud. El Plan local de salud debe actuar sobre estos determinantes estructurales.',
        prioridad: 2,
        categoria: 'marco_teorico'
    },
    {
        id: 'epvsa_alineamiento',
        texto: 'El Plan local de salud se articula con la Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a (EPVSA 2024-2030), incorporando sus l√≠neas estrat√©gicas, objetivos operativos y sistema de indicadores, garantizando la coherencia con la pol√≠tica auton√≥mica de promoci√≥n de la salud.',
        prioridad: 3,
        categoria: 'alineamiento'
    },
    {
        id: 'principios_transversales',
        texto: 'La intersectorialidad, la participaci√≥n ciudadana efectiva y la reducci√≥n de las inequidades en salud constituyen principios transversales irrenunciables que orientan todas las actuaciones del Plan, reconociendo que la salud se construye fundamentalmente fuera del sistema sanitario.',
        prioridad: 4,
        categoria: 'principios'
    }
];

// Recomendaciones estructurales (siempre aplicables)
const RECOMENDACIONES_FIJAS = [
    {
        id: 'mapeo_activos',
        texto: 'Realizar un mapeo participativo de activos para la salud que identifique los recursos comunitarios disponibles: espacios p√∫blicos promotores de salud, equipamientos deportivos y culturales, redes asociativas, comercio de proximidad saludable, profesionales y personas clave, y programas existentes. Este mapeo debe actualizarse peri√≥dicamente y ser accesible a la ciudadan√≠a.',
        prioridad: 1,
        categoria: 'diagnostico'
    },
    {
        id: 'relas_gobernanza',
        texto: 'Consolidar la Red local de acci√≥n en salud (RELAS) como estructura de gobernanza participativa, garantizando la representaci√≥n de todos los sectores (sanitario, educativo, social, urbanismo, medio ambiente, deportes) y la participaci√≥n ciudadana efectiva, especialmente de colectivos en situaci√≥n de vulnerabilidad.',
        prioridad: 2,
        categoria: 'gobernanza'
    },
    {
        id: 'equidad_gradiente',
        texto: 'Incorporar la perspectiva de equidad en todas las actuaciones, aplicando el universalismo proporcional: intervenciones universales con intensidad proporcional al nivel de desventaja, para reducir el gradiente social en salud sin estigmatizar a los grupos m√°s vulnerables.',
        prioridad: 3,
        categoria: 'equidad'
    },
    {
        id: 'evaluacion_participativa',
        texto: 'Establecer un sistema de seguimiento y evaluaci√≥n participativa que incorpore indicadores cuantitativos (alineados con EPVSA) e indicadores cualitativos que recojan la percepci√≥n ciudadana, permitiendo la Jornada anual de salud y el aprendizaje continuo.',
        prioridad: 4,
        categoria: 'evaluacion'
    }
];

// FUNCI√ìN PRINCIPAL DE AN√ÅLISIS
function analizarDatosMunicipio() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    const analisis = {
        municipio: nombre,
        fortalezas: [],           // Activos y aspectos positivos
        oportunidades: [],        // √Åreas con margen de mejora (no "problemas")
        conclusiones: [],         // Fijas + espec√≠ficas
        recomendaciones: [],      // Fijas + espec√≠ficas
        priorizacion: [],         // √Åreas priorizadas con justificaci√≥n
        propuestaEPVSA: [],       // Preselecci√≥n de l√≠neas/objetivos/programas
        datosAnalisis: {},        // Datos usados para el an√°lisis
        // Nuevos campos salutog√©nicos
        perfilSOC: null,          // Perfil Sentido de Coherencia (Antonovsky)
        alertasInequidad: [],     // Alertas de inequidad detectadas
        analisisPorCapas: {},     // An√°lisis por capas Dahlgren-Whitehead
        patronesTransversales: [] // Patrones detectados entre √°reas
    };
    
    // Verificar si tiene datos
    const tieneDatos = datosMunicipioActual && (datosMunicipioActual.informe || datosMunicipioActual.indicadores || datosMunicipioActual.determinantes);
    
    if (!tieneDatos) {
        return {
            sinDatos: true,
            mensaje: 'El municipio de ' + nombre + ' a√∫n no tiene datos cargados. Utilice el bot√≥n "‚öôÔ∏è Gestionar datos" en la Fase 2 para cargar la informaci√≥n necesaria.'
        };
    }
    
    // Obtener datos
    const determinantesFirebase = datosMunicipioActual?.determinantes || {};
    const indicadoresFirebase = datosMunicipioActual?.indicadores || {};
    
    // Funci√≥n auxiliar para obtener valor de un determinante
    function getValorDeterminante(codigo) {
        if (determinantesFirebase[codigo] !== undefined) {
            const data = determinantesFirebase[codigo];
            return typeof data === 'object' ? data.valor : parseFloat(data);
        }
        return null;
    }
    
    // Funci√≥n auxiliar para obtener referencia de Andaluc√≠a
    function getRefAndalucia(codigo) {
        const ref = referenciasEAS[codigo];
        return ref?.refAndalucia ?? null;
    }
    
    // Funci√≥n para obtener polaridad de un determinante
    function getPolaridad(codigo) {
        for (const area of Object.values(ESTRUCTURA_DETERMINANTES)) {
            if (area.indicadores) {
                const ind = area.indicadores.find(i => i.codigo === codigo);
                if (ind) return ind.polaridad || 1;
            }
            if (area.grupos) {
                for (const grupo of area.grupos) {
                    const ind = grupo.indicadores.find(i => i.codigo === codigo);
                    if (ind) return ind.polaridad || 1;
                }
            }
        }
        return 1;
    }
    
    // Funci√≥n para obtener texto de un determinante
    function getTextoDeterminante(codigo) {
        for (const area of Object.values(ESTRUCTURA_DETERMINANTES)) {
            if (area.indicadores) {
                const ind = area.indicadores.find(i => i.codigo === codigo);
                if (ind) return ind.texto;
            }
            if (area.grupos) {
                for (const grupo of area.grupos) {
                    const ind = grupo.indicadores.find(i => i.codigo === codigo);
                    if (ind) return ind.texto;
                }
            }
        }
        return codigo;
    }
    
    // =====================================================
    // 1. AN√ÅLISIS DE DETERMINANTES (55 variables EAS)
    // =====================================================
    const umbral = 0.05; // 5% de diferencia significativa
    const analisisPorArea = {};
    
    Object.entries(MAPEO_TEMATICO).forEach(([areaKey, area]) => {
        analisisPorArea[areaKey] = {
            nombre: area.nombre,
            fortalezas: [],
            oportunidades: [],
            neutros: []
        };
        
        area.determinantes.forEach(codigo => {
            const valor = getValorDeterminante(codigo);
            const refAnd = getRefAndalucia(codigo);
            const polaridad = getPolaridad(codigo);
            const texto = getTextoDeterminante(codigo);
            
            if (valor === null || refAnd === null) return;
            
            const diferencia = (valor - refAnd) / refAnd;
            let esMejor = false;
            let esPeor = false;
            
            if (polaridad === 1) {
                // Mayor es mejor
                esMejor = diferencia > umbral;
                esPeor = diferencia < -umbral;
            } else if (polaridad === -1) {
                // Menor es mejor
                esMejor = diferencia < -umbral;
                esPeor = diferencia > umbral;
            }
            // polaridad 0 = neutral, no se clasifica
            
            const dato = {
                codigo,
                texto,
                valor,
                refAndalucia: refAnd,
                diferenciaPct: (diferencia * 100).toFixed(1)
            };
            
            if (esMejor) {
                analisisPorArea[areaKey].fortalezas.push(dato);
                analisis.fortalezas.push({
                    area: area.nombre,
                    ...dato,
                    mensaje: `${texto}: ${valor}% (Andaluc√≠a: ${refAnd}%)`
                });
            } else if (esPeor) {
                analisisPorArea[areaKey].oportunidades.push(dato);
                analisis.oportunidades.push({
                    area: area.nombre,
                    ...dato,
                    mensaje: `${texto}: ${valor}% presenta margen de mejora respecto a Andaluc√≠a (${refAnd}%)`
                });
            } else {
                analisisPorArea[areaKey].neutros.push(dato);
            }
        });
    });
    
    // =====================================================
    // 2. AN√ÅLISIS DE INDICADORES (Cuadro de mandos)
    // =====================================================
    const indicadoresFavorables = [];
    const indicadoresAMejorar = [];
    
    Object.entries(indicadoresFirebase).forEach(([key, ind]) => {
        if (!ind || typeof ind !== 'object') return;
        
        const nombre = ind.nombre || ind.indicador || key;
        const tObs = ind.tendenciaObservada || ind.tObs || '';
        const tDes = ind.tendenciaDeseada || ind.tDes || '';
        
        if (tObs && tDes) {
            // Tendencia favorable: observada coincide con deseada
            if (tObs === tDes || 
                (tObs === '‚ñ≤' && tDes === '‚ñ≤') || 
                (tObs === '‚ñº' && tDes === '‚ñº') ||
                (tObs === '‚Üë' && tDes === '‚Üë') ||
                (tObs === '‚Üì' && tDes === '‚Üì')) {
                indicadoresFavorables.push({ nombre, valor: ind.dato || ind.valor, tendencia: 'favorable' });
            } 
            // Tendencia a mejorar: observada opuesta a deseada
            else if ((tObs === '‚ñ≤' && tDes === '‚ñº') || 
                     (tObs === '‚ñº' && tDes === '‚ñ≤') ||
                     (tObs === '‚Üë' && tDes === '‚Üì') ||
                     (tObs === '‚Üì' && tDes === '‚Üë')) {
                indicadoresAMejorar.push({ nombre, valor: ind.dato || ind.valor, tendencia: 'a mejorar' });
            }
        }
    });
    
    analisis.datosAnalisis = {
        determinantes: analisisPorArea,
        indicadoresFavorables,
        indicadoresAMejorar,
        totalDeterminantes: Object.keys(determinantesFirebase).length,
        totalIndicadores: Object.keys(indicadoresFirebase).length
    };
    
    // =====================================================
    // 3. GENERAR CONCLUSIONES
    // =====================================================
    
    // A√±adir conclusiones fijas
    analisis.conclusiones = [...CONCLUSIONES_FIJAS];
    
    // Generar conclusiones espec√≠ficas basadas en datos
    
    // Conclusi√≥n sobre perfil demogr√°fico (si hay datos)
    const fortalezasCount = analisis.fortalezas.length;
    const oportunidadesCount = analisis.oportunidades.length;
    
    if (fortalezasCount > 0) {
        const areasFortaleza = [...new Set(analisis.fortalezas.map(f => f.area))];
        analisis.conclusiones.push({
            id: 'fortalezas',
            texto: `${nombre} presenta fortalezas destacadas en ${areasFortaleza.slice(0, 3).join(', ')}${areasFortaleza.length > 3 ? ' y otras √°reas' : ''}, constituyendo activos a consolidar mediante el Plan local de salud.`,
            prioridad: 4,
            especifica: true
        });
    }
    
    if (oportunidadesCount > 0) {
        const areasOportunidad = [...new Set(analisis.oportunidades.map(o => o.area))];
        analisis.conclusiones.push({
            id: 'oportunidades',
            texto: `Se identifican oportunidades de mejora en ${areasOportunidad.slice(0, 3).join(', ')}, donde las intervenciones de promoci√≥n de salud pueden facilitar que la opci√≥n saludable sea la opci√≥n m√°s f√°cil para la ciudadan√≠a.`,
            prioridad: 5,
            especifica: true
        });
    }
    
    // Conclusi√≥n sobre indicadores
    if (indicadoresFavorables.length > indicadoresAMejorar.length) {
        analisis.conclusiones.push({
            id: 'tendencias',
            texto: `La mayor√≠a de los indicadores de seguimiento muestran tendencias favorables (${indicadoresFavorables.length} de ${indicadoresFavorables.length + indicadoresAMejorar.length}), reflejando una evoluci√≥n positiva que el Plan puede consolidar.`,
            prioridad: 6,
            especifica: true
        });
    }
    
    // =====================================================
    // 4. GENERAR RECOMENDACIONES
    // =====================================================
    
    // A√±adir recomendaciones fijas
    analisis.recomendaciones = [...RECOMENDACIONES_FIJAS];
    
    // Generar recomendaciones espec√≠ficas por √°rea con oportunidades
    const areasConOportunidades = {};
    analisis.oportunidades.forEach(o => {
        if (!areasConOportunidades[o.area]) {
            areasConOportunidades[o.area] = [];
        }
        areasConOportunidades[o.area].push(o);
    });
    
    Object.entries(areasConOportunidades).forEach(([area, items], idx) => {
        let recomendacion = '';
        
        switch(area) {
            case 'bienestar emocional':
                recomendacion = `Situar el bienestar emocional como eje del Plan local de salud, con programas de apoyo social y dinamizaci√≥n de activos comunitarios que promuevan la salud mental positiva.`;
                break;
            case 'vida activa':
                recomendacion = `Promover la vida activa aprovechando los espacios verdes, infraestructuras ciclistas y equipamientos deportivos del municipio como activos para facilitar la actividad f√≠sica cotidiana.`;
                break;
            case 'alimentaci√≥n saludable':
                recomendacion = `Impulsar la alimentaci√≥n saludable mediante el acceso a productos frescos y de proximidad, la mejora de la oferta alimentaria en entornos p√∫blicos y la educaci√≥n nutricional.`;
                break;
            case 'sue√±o saludable':
                recomendacion = `Incorporar el sue√±o saludable como componente del bienestar integral, sensibilizando sobre su importancia y facilitando entornos que favorezcan el descanso.`;
                break;
            case 'vida sin humo':
                recomendacion = `Consolidar la tendencia hacia una vida sin humo mediante espacios libres de humo, apoyo a la deshabituaci√≥n tab√°quica y prevenci√≥n del inicio del consumo.`;
                break;
            case 'redes de apoyo social':
                recomendacion = `Fortalecer las redes de apoyo social para prevenir la soledad no deseada, especialmente en personas mayores, mediante la dinamizaci√≥n de recursos comunitarios.`;
                break;
            case 'entornos promotores de salud':
                recomendacion = `Mejorar la calidad de los entornos promotores de salud, reduciendo exposiciones ambientales nocivas y potenciando los espacios p√∫blicos saludables.`;
                break;
            default:
                recomendacion = `Desarrollar actuaciones espec√≠ficas en el √°rea de ${area} para facilitar opciones saludables a la ciudadan√≠a.`;
        }
        
        analisis.recomendaciones.push({
            id: `rec_${area.toLowerCase().replace(/\s/g, '_')}`,
            texto: recomendacion,
            prioridad: 5 + idx,
            especifica: true,
            area: area
        });
    });
    
    // =====================================================
    // 5. GENERAR PRIORIZACI√ìN
    // =====================================================
    
    Object.entries(MAPEO_TEMATICO).forEach(([areaKey, area]) => {
        const datosArea = analisisPorArea[areaKey];
        if (!datosArea) return;
        
        const numFortalezas = datosArea.fortalezas.length;
        const numOportunidades = datosArea.oportunidades.length;
        const total = numFortalezas + numOportunidades + datosArea.neutros.length;
        
        if (total === 0) return;
        
        // Calcular puntuaci√≥n: oportunidades pesan m√°s para priorizar
        const puntuacion = (numOportunidades * 3) + numFortalezas;
        
        let justificacion = '';
        if (numOportunidades > 0 && numFortalezas > 0) {
            justificacion = `√Årea con ${numFortalezas} fortaleza(s) a consolidar y ${numOportunidades} oportunidad(es) de mejora.`;
        } else if (numOportunidades > 0) {
            justificacion = `√Årea prioritaria con ${numOportunidades} oportunidad(es) de mejora identificada(s).`;
        } else if (numFortalezas > 0) {
            justificacion = `√Årea de fortaleza con ${numFortalezas} indicador(es) favorable(s) a consolidar.`;
        }
        
        // A√±adir datos espec√≠ficos a la justificaci√≥n
        if (datosArea.fortalezas.length > 0) {
            const ejemploF = datosArea.fortalezas[0];
            justificacion += ` Destaca: ${ejemploF.texto} (${ejemploF.valor}%).`;
        }
        if (datosArea.oportunidades.length > 0) {
            const ejemploO = datosArea.oportunidades[0];
            justificacion += ` Mejorable: ${ejemploO.texto} (${ejemploO.valor}% vs ${ejemploO.refAndalucia}% Andaluc√≠a).`;
        }
        
        analisis.priorizacion.push({
            area: area.nombre,
            areaKey,
            puntuacion,
            numFortalezas,
            numOportunidades,
            justificacion,
            lineaEPVSA: area.lineaEPVSA,
            objetivoEPVSA: area.objetivoEPVSA,
            programas: area.programas
        });
    });
    
    // Ordenar por puntuaci√≥n (mayor primero)
    analisis.priorizacion.sort((a, b) => b.puntuacion - a.puntuacion);
    
    // =====================================================
    // 6. GENERAR PROPUESTA EPVSA
    // =====================================================
    
    // Mapear √°reas priorizadas a l√≠neas/objetivos/programas EPVSA
    const lineasSeleccionadas = new Map();
    
    analisis.priorizacion.forEach(prio => {
        const lineaId = prio.lineaEPVSA;
        
        if (!lineasSeleccionadas.has(lineaId)) {
            lineasSeleccionadas.set(lineaId, {
                lineaId,
                relevancia: 0,
                objetivos: new Set(),
                programas: new Set(),
                justificaciones: []
            });
        }
        
        const linea = lineasSeleccionadas.get(lineaId);
        linea.relevancia += prio.puntuacion;
        linea.objetivos.add(prio.objetivoEPVSA);
        prio.programas.forEach(p => linea.programas.add(p));
        linea.justificaciones.push(prio.area);
    });
    
    // Convertir a array y normalizar relevancia
    const maxRelevancia = Math.max(...[...lineasSeleccionadas.values()].map(l => l.relevancia));
    
    analisis.propuestaEPVSA = [...lineasSeleccionadas.values()].map(linea => ({
        lineaId: linea.lineaId,
        relevancia: Math.round((linea.relevancia / maxRelevancia) * 100),
        objetivos: [...linea.objetivos],
        programas: [...linea.programas],
        justificacion: `√Åreas relacionadas: ${linea.justificaciones.join(', ')}`
    })).sort((a, b) => b.relevancia - a.relevancia);
    
    // A√±adir siempre L3 (Informaci√≥n) y L4 (Formaci√≥n) con relevancia base
    if (!analisis.propuestaEPVSA.find(p => p.lineaId === 3)) {
        analisis.propuestaEPVSA.push({
            lineaId: 3,
            relevancia: 70,
            objetivos: [0],
            programas: [0],
            justificacion: 'Difusi√≥n de informaci√≥n veraz sobre h√°bitos saludables'
        });
    }
    if (!analisis.propuestaEPVSA.find(p => p.lineaId === 4)) {
        analisis.propuestaEPVSA.push({
            lineaId: 4,
            relevancia: 65,
            objetivos: [0],
            programas: [0],
            justificacion: 'Formaci√≥n de profesionales e investigaci√≥n en promoci√≥n de salud'
        });
    }
    
    // =====================================================
    // INTEGRACI√ìN DE PRIORIZACI√ìN CIUDADANA
    // Si existe una decisi√≥n de priorizaci√≥n, ajustar la propuesta
    // =====================================================
    const decision = window.decisionPriorizacionActual;
    const participacion = window.datosParticipacionCiudadana;
    
    if (decision && participacion) {
        analisis.incluyeParticipacionCiudadana = true;
        analisis.metodoDecision = decision.metodo;
        
        if (decision.metodo === 'ciudadana' || decision.metodo === 'integracion') {
            // Buscar l√≠nea/objetivo relacionado con el objetivo ciudadano prioritario
            const objCiudadano = participacion.objetivoPrioritario;
            const colectivoCiudadano = participacion.colectivoPrioritario;
            
            // Mapeo de objetivos ciudadanos a l√≠neas EPVSA (basado en OBJETIVOS_EPVSA)
            // Los objetivos 1-7 corresponden a la L√≠nea 1 principalmente
            const mapeoObjetivoLinea = {
                1: { linea: 1, objetivo: 0, justificacion: 'Alimentaci√≥n saludable (prioridad ciudadana)' },
                2: { linea: 1, objetivo: 1, justificacion: 'Actividad f√≠sica (prioridad ciudadana)' },
                3: { linea: 1, objetivo: 2, justificacion: 'Bienestar emocional (prioridad ciudadana)' },
                4: { linea: 1, objetivo: 3, justificacion: 'Consumo responsable de sustancias (prioridad ciudadana)' },
                5: { linea: 1, objetivo: 4, justificacion: 'Sexualidad saludable (prioridad ciudadana)' },
                6: { linea: 1, objetivo: 5, justificacion: 'Seguridad y prevenci√≥n de lesiones (prioridad ciudadana)' },
                7: { linea: 1, objetivo: 6, justificacion: 'Entornos promotores de salud (prioridad ciudadana)' }
            };
            
            const mapeoCiudadano = mapeoObjetivoLinea[objCiudadano.id];
            
            if (mapeoCiudadano) {
                // Buscar si ya existe la l√≠nea en la propuesta
                const lineaExistente = analisis.propuestaEPVSA.find(p => p.lineaId === mapeoCiudadano.linea);
                
                if (lineaExistente) {
                    // Aumentar relevancia por decisi√≥n ciudadana
                    if (decision.metodo === 'ciudadana') {
                        lineaExistente.relevancia = 100; // M√°xima prioridad
                    } else {
                        lineaExistente.relevancia = Math.min(100, lineaExistente.relevancia + 20);
                    }
                    
                    // Asegurar que el objetivo ciudadano est√© incluido
                    if (!lineaExistente.objetivos.includes(mapeoCiudadano.objetivo)) {
                        lineaExistente.objetivos.unshift(mapeoCiudadano.objetivo);
                    }
                    
                    // Actualizar justificaci√≥n
                    lineaExistente.justificacion += ` | üó≥Ô∏è ${mapeoCiudadano.justificacion} (${objCiudadano.porcentaje}% votos)`;
                    
                    // A√±adir colectivo prioritario
                    if (colectivoCiudadano) {
                        lineaExistente.colectivoPrioritario = colectivoCiudadano.texto;
                    }
                } else {
                    // A√±adir nueva l√≠nea basada en la decisi√≥n ciudadana
                    analisis.propuestaEPVSA.unshift({
                        lineaId: mapeoCiudadano.linea,
                        relevancia: decision.metodo === 'ciudadana' ? 100 : 90,
                        objetivos: [mapeoCiudadano.objetivo],
                        programas: [0],
                        justificacion: `üó≥Ô∏è ${mapeoCiudadano.justificacion} (${objCiudadano.porcentaje}% votos)`,
                        colectivoPrioritario: colectivoCiudadano?.texto,
                        origenCiudadano: true
                    });
                }
            }
            
            // Reordenar por relevancia
            analisis.propuestaEPVSA.sort((a, b) => b.relevancia - a.relevancia);
        }
        
        // Si el m√©todo es solo epidemiol√≥gico, no modificamos nada adicional
        // La propuesta ya est√° basada en datos epidemiol√≥gicos
    } else {
        analisis.incluyeParticipacionCiudadana = false;
    }
    
    // =====================================================
    // 7. AN√ÅLISIS DE PERFIL SOC (Sentido de Coherencia)
    // Basado en Antonovsky: Comprensibilidad, Manejabilidad, Significatividad
    // =====================================================
    
    // Funci√≥n auxiliar para evaluar una dimensi√≥n SOC
    function evaluarDimensionSOC(indicadores, determinantesFirebase, getValorDeterminante, getRefAndalucia) {
        let puntuacion = 50; // Base neutra
        let indicadoresEvaluados = 0;
        
        indicadores.forEach(codigo => {
            const valor = getValorDeterminante(codigo);
            const refAnd = getRefAndalucia(codigo);
            if (valor !== null && refAnd !== null && refAnd !== 0) {
                const diferencia = ((valor - refAnd) / refAnd) * 100;
                // Ajustar puntuaci√≥n seg√∫n diferencia
                if (diferencia > 10) puntuacion += 15;
                else if (diferencia > 5) puntuacion += 10;
                else if (diferencia > 0) puntuacion += 5;
                else if (diferencia < -10) puntuacion -= 15;
                else if (diferencia < -5) puntuacion -= 10;
                else if (diferencia < 0) puntuacion -= 5;
                indicadoresEvaluados++;
            }
        });
        
        // Normalizar entre 0 y 100
        puntuacion = Math.max(0, Math.min(100, puntuacion));
        
        let nivel = 'medio';
        let interpretacion = '';
        
        if (puntuacion >= 70) {
            nivel = 'alto';
            interpretacion = 'Fortaleza comunitaria consolidada';
        } else if (puntuacion >= 40) {
            nivel = 'medio';
            interpretacion = 'Nivel adecuado con margen de mejora';
        } else {
            nivel = 'bajo';
            interpretacion = '√Årea prioritaria de intervenci√≥n';
        }
        
        return { puntuacion: Math.round(puntuacion), nivel, interpretacion, indicadoresEvaluados };
    }
    
    // Indicadores proxy para cada dimensi√≥n SOC
    const indicadoresComprensibilidad = ['P7', 'P7b', 'P8a', 'P8b']; // Autopercepci√≥n salud
    const indicadoresManejabilidad = ['DUKE_bajo', 'P71_dificultad', 'P4d_frio']; // Recursos y apoyo
    const indicadoresSignificatividad = ['P12a', 'P12b', 'P12c', 'P57b1']; // Bienestar emocional
    
    analisis.perfilSOC = {
        comprensibilidad: evaluarDimensionSOC(indicadoresComprensibilidad, determinantesFirebase, getValorDeterminante, getRefAndalucia),
        manejabilidad: evaluarDimensionSOC(indicadoresManejabilidad, determinantesFirebase, getValorDeterminante, getRefAndalucia),
        significatividad: evaluarDimensionSOC(indicadoresSignificatividad, determinantesFirebase, getValorDeterminante, getRefAndalucia)
    };
    
    // Calcular SOC global
    const socGlobal = Math.round(
        (analisis.perfilSOC.comprensibilidad.puntuacion + 
         analisis.perfilSOC.manejabilidad.puntuacion + 
         analisis.perfilSOC.significatividad.puntuacion) / 3
    );
    analisis.perfilSOC.global = {
        puntuacion: socGlobal,
        nivel: socGlobal >= 70 ? 'alto' : (socGlobal >= 40 ? 'medio' : 'bajo'),
        interpretacion: socGlobal >= 70 ? 
            'La comunidad presenta un perfil salutog√©nico favorable' : 
            (socGlobal >= 40 ? 
                'La comunidad tiene capacidades de afrontamiento moderadas' : 
                'Se requiere fortalecer los recursos generadores de salud')
    };
    
    // =====================================================
    // 8. ALERTAS DE INEQUIDAD
    // =====================================================
    
    const umbralesInequidad = [
        { codigo: 'P71_dificultad', umbral: 30, mensaje: 'Dificultad econ√≥mica para llegar a fin de mes', tipo: 'economica' },
        { codigo: 'P71_mucha_dif', umbral: 15, mensaje: 'Mucha dificultad econ√≥mica', tipo: 'economica' },
        { codigo: 'P4d_frio', umbral: 15, mensaje: 'Pobreza energ√©tica (fr√≠o en invierno)', tipo: 'vivienda' },
        { codigo: 'P4d_calor', umbral: 20, mensaje: 'Pobreza energ√©tica (calor en verano)', tipo: 'vivienda' },
        { codigo: 'DUKE_bajo', umbral: 20, mensaje: 'Bajo apoyo social percibido', tipo: 'social' }
    ];
    
    umbralesInequidad.forEach(alerta => {
        const valor = getValorDeterminante(alerta.codigo);
        if (valor !== null && valor > alerta.umbral) {
            analisis.alertasInequidad.push({
                codigo: alerta.codigo,
                valor: valor,
                umbral: alerta.umbral,
                mensaje: alerta.mensaje,
                tipo: alerta.tipo,
                severidad: valor > alerta.umbral * 1.5 ? 'alta' : 'moderada',
                recomendacion: `Priorizar intervenciones con perspectiva de equidad en ${alerta.mensaje.toLowerCase()}`
            });
        }
    });
    
    // =====================================================
    // 9. AN√ÅLISIS POR CAPAS DAHLGREN-WHITEHEAD
    // =====================================================
    
    Object.entries(CAPAS_DETERMINANTES).forEach(([capaKey, capa]) => {
        const analisisCapa = {
            nombre: capa.nombre,
            descripcion: capa.descripcion,
            modificable: capa.modificable,
            indicadores: [],
            balance: { fortalezas: 0, oportunidades: 0, neutros: 0 }
        };
        
        capa.indicadores.forEach(codigo => {
            const valor = getValorDeterminante(codigo);
            const refAnd = getRefAndalucia(codigo);
            const texto = getTextoDeterminante(codigo);
            
            if (valor !== null && refAnd !== null) {
                const diferencia = refAnd !== 0 ? ((valor - refAnd) / refAnd) * 100 : 0;
                let clasificacion = 'neutro';
                
                if (diferencia > 5) {
                    clasificacion = 'fortaleza';
                    analisisCapa.balance.fortalezas++;
                } else if (diferencia < -5) {
                    clasificacion = 'oportunidad';
                    analisisCapa.balance.oportunidades++;
                } else {
                    analisisCapa.balance.neutros++;
                }
                
                analisisCapa.indicadores.push({
                    codigo, texto, valor, refAnd,
                    diferencia: diferencia.toFixed(1),
                    clasificacion
                });
            }
        });
        
        // Valoraci√≥n global de la capa
        const totalCapa = analisisCapa.balance.fortalezas + analisisCapa.balance.oportunidades + analisisCapa.balance.neutros;
        if (totalCapa > 0) {
            if (analisisCapa.balance.fortalezas > analisisCapa.balance.oportunidades) {
                analisisCapa.valoracionGlobal = 'favorable';
            } else if (analisisCapa.balance.oportunidades > analisisCapa.balance.fortalezas) {
                analisisCapa.valoracionGlobal = 'mejorable';
            } else {
                analisisCapa.valoracionGlobal = 'mixto';
            }
        }
        
        analisis.analisisPorCapas[capaKey] = analisisCapa;
    });
    
    // =====================================================
    // 10. DETECCI√ìN DE PATRONES TRANSVERSALES
    // =====================================================
    
    const areasConFortaleza = [...new Set(analisis.fortalezas.map(f => f.area.toLowerCase()))];
    const areasConOportunidad = [...new Set(analisis.oportunidades.map(o => o.area.toLowerCase()))];
    
    // Mapear nombres de √°rea a claves
    const nombreAKey = {};
    Object.entries(PLANTILLAS_SALUTOGENICAS).forEach(([key, val]) => {
        nombreAKey[val.nombre.toLowerCase()] = key;
    });
    
    Object.entries(PATRONES_SALUTOGENICOS).forEach(([patronKey, patron]) => {
        let areasConDatos = 0;
        let tieneFortaleza = false;
        let tieneOportunidad = false;
        
        patron.areas.forEach(areaKey => {
            const plantilla = PLANTILLAS_SALUTOGENICAS[areaKey];
            if (plantilla) {
                const nombreArea = plantilla.nombre.toLowerCase();
                if (areasConFortaleza.includes(nombreArea)) {
                    areasConDatos++;
                    tieneFortaleza = true;
                }
                if (areasConOportunidad.includes(nombreArea)) {
                    areasConDatos++;
                    tieneOportunidad = true;
                }
            }
        });
        
        if (areasConDatos >= patron.umbralMinimo) {
            let tipo = 'mixto';
            let narrativa = patron.narrativaMixta;
            
            if (tieneFortaleza && !tieneOportunidad) {
                tipo = 'fortaleza';
                narrativa = patron.narrativaFortaleza;
            } else if (!tieneFortaleza && tieneOportunidad) {
                tipo = 'oportunidad';
                narrativa = patron.narrativaOportunidad;
            }
            
            analisis.patronesTransversales.push({
                key: patronKey,
                nombre: patron.nombre,
                tipo,
                narrativa,
                areasRelacionadas: patron.areas.map(k => PLANTILLAS_SALUTOGENICAS[k]?.nombre || k)
            });
        }
    });
    
    // =====================================================
    // 11. GENERAR NARRATIVA SALUTOG√âNICA
    // =====================================================
    analisis.narrativa = generarNarrativaSalutogenica(analisis);
    
    return analisis;
}

// =====================================================
// FUNCI√ìN PARA GENERAR LA PROPUESTA VISUAL
// =====================================================
function generarPropuestaAutomatica() {
    // Redirigir a la nueva funci√≥n con IA si est√° disponible
    if (typeof generarPropuestaIA === 'function') { generarPropuestaIA(); return; }
    const analisis = analizarDatosMunicipio();
    const municipio = analisis.municipio || getNombreMunicipio(getMunicipioActual());
    
    if (analisis.sinDatos) {
        document.getElementById('propuesta-automatica-container').style.display = 'block';
        document.getElementById('propuesta-resumen').innerHTML = `
            <div class="justificacion-box" style="background: #fef2f2; border-color: #fca5a5;">
                <h4>‚ö†Ô∏è Datos no disponibles</h4>
                <p>${analisis.mensaje}</p>
            </div>`;
        document.getElementById('propuesta-detalle').innerHTML = '';
        return;
    }
    
    // Guardar an√°lisis para uso posterior
    window.analisisActual = analisis;
    
    // =====================================================
    // SECCI√ìN 1: RESUMEN DEL AN√ÅLISIS
    // =====================================================
    let resumenHTML = `<h3>üìä An√°lisis de ${municipio}</h3>`;
    
    // Cards de fortalezas (activos)
    if (analisis.fortalezas.length > 0) {
        resumenHTML += `
            <h4 style="color: #059669; margin: 1rem 0 0.5rem;">‚úÖ Activos y Fortalezas Identificadas</h4>
            <div class="analisis-grid">
                ${analisis.fortalezas.slice(0, 6).map(f => `
                    <div class="analisis-card positivo">
                        <h4>${f.area}</h4>
                        <div class="valor">${f.valor}%</div>
                        <div class="detalle">${f.texto}</div>
                    </div>
                `).join('')}
            </div>`;
    }
    
    // Cards de oportunidades de mejora
    if (analisis.oportunidades.length > 0) {
        resumenHTML += `
            <h4 style="color: #f59e0b; margin: 1rem 0 0.5rem;">üéØ Oportunidades de Promoci√≥n</h4>
            <div class="analisis-grid">
                ${analisis.oportunidades.slice(0, 6).map(o => `
                    <div class="analisis-card" style="border-left-color: #f59e0b;">
                        <h4>${o.area}</h4>
                        <div class="valor">${o.valor}%</div>
                        <div class="detalle">${o.texto} (Andaluc√≠a: ${o.refAndalucia}%)</div>
                    </div>
                `).join('')}
            </div>`;
    }
    
    // =====================================================
    // SECCI√ìN 1B: PERFIL SOC (Sentido de Coherencia)
    // =====================================================
    if (analisis.perfilSOC) {
        const soc = analisis.perfilSOC;
        const getColorSOC = (nivel) => {
            if (nivel === 'alto') return { bg: '#ecfdf5', border: '#10b981', text: '#065f46' };
            if (nivel === 'medio') return { bg: '#fffbeb', border: '#f59e0b', text: '#92400e' };
            return { bg: '#fef2f2', border: '#ef4444', text: '#991b1b' };
        };
        
        resumenHTML += `
            <div class="justificacion-box" style="margin-top: 1.5rem; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-color: #38bdf8;">
                <h4>üß† Perfil salutog√©nico (Sentido de Coherencia - Antonovsky)</h4>
                <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">El Sentido de Coherencia eval√∫a la capacidad de la comunidad para comprender, manejar y dar significado a los desaf√≠os de salud.</p>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    ${['comprensibilidad', 'manejabilidad', 'significatividad'].map(dim => {
                        const d = soc[dim];
                        const color = getColorSOC(d.nivel);
                        const dimInfo = DIMENSIONES_SOC[dim];
                        return `
                            <div style="background: ${color.bg}; border: 2px solid ${color.border}; border-radius: 12px; padding: 1rem; text-align: center;">
                                <div style="font-size: 0.85rem; font-weight: 600; color: ${color.text}; text-transform: uppercase;">${dimInfo.nombre}</div>
                                <div style="font-size: 2rem; font-weight: 700; color: ${color.border}; margin: 0.5rem 0;">${d.puntuacion}</div>
                                <div style="font-size: 0.8rem; color: ${color.text}; padding: 0.25rem 0.5rem; background: white; border-radius: 4px; display: inline-block;">${d.interpretacion}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px; text-align: center;">
                    <span style="font-weight: 600;">SOC Global:</span> 
                    <span style="font-size: 1.25rem; font-weight: 700; color: ${getColorSOC(soc.global.nivel).border};">${soc.global.puntuacion}/100</span>
                    <span style="margin-left: 0.5rem; color: #64748b;">‚Äî ${soc.global.interpretacion}</span>
                </div>
            </div>`;
    }
    
    // =====================================================
    // SECCI√ìN 1C: ALERTAS DE INEQUIDAD
    // =====================================================
    if (analisis.alertasInequidad && analisis.alertasInequidad.length > 0) {
        resumenHTML += `
            <div class="justificacion-box" style="margin-top: 1rem; background: #fef2f2; border-color: #fca5a5;">
                <h4>‚ö†Ô∏è Alertas de inequidad</h4>
                <p style="font-size: 0.85rem; color: #991b1b; margin-bottom: 0.75rem;">Se han detectado indicadores que superan los umbrales de alerta y requieren intervenci√≥n prioritaria con perspectiva de equidad:</p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${analisis.alertasInequidad.map(a => `
                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; background: white; border-radius: 6px; border-left: 4px solid ${a.severidad === 'alta' ? '#dc2626' : '#f59e0b'};">
                            <span style="font-size: 1.25rem;">${a.tipo === 'economica' ? 'üí∞' : (a.tipo === 'vivienda' ? 'üè†' : 'üë•')}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1f2937;">${a.mensaje}</div>
                                <div style="font-size: 0.85rem; color: #64748b;">Valor: ${a.valor}% (umbral: ${a.umbral}%)</div>
                            </div>
                            <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; background: ${a.severidad === 'alta' ? '#fee2e2' : '#fef3c7'}; color: ${a.severidad === 'alta' ? '#991b1b' : '#92400e'};">${a.severidad.toUpperCase()}</span>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }
    
    // =====================================================
    // SECCI√ìN 1D: PATRONES TRANSVERSALES
    // =====================================================
    if (analisis.patronesTransversales && analisis.patronesTransversales.length > 0) {
        resumenHTML += `
            <div class="justificacion-box" style="margin-top: 1rem; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-color: #a855f7;">
                <h4>üîó Patrones transversales detectados</h4>
                <p style="font-size: 0.85rem; color: #6b21a8; margin-bottom: 0.75rem;">Se identifican conexiones entre diferentes √°reas que sugieren intervenciones integradas:</p>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    ${analisis.patronesTransversales.map(p => `
                        <div style="padding: 0.75rem; background: white; border-radius: 8px; border-left: 4px solid ${p.tipo === 'fortaleza' ? '#10b981' : (p.tipo === 'oportunidad' ? '#f59e0b' : '#8b5cf6')};">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-weight: 700; color: #1f2937;">${p.nombre}</span>
                                <span style="padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; background: ${p.tipo === 'fortaleza' ? '#d1fae5' : (p.tipo === 'oportunidad' ? '#fef3c7' : '#ede9fe')}; color: ${p.tipo === 'fortaleza' ? '#065f46' : (p.tipo === 'oportunidad' ? '#92400e' : '#5b21b6')};">${p.tipo.toUpperCase()}</span>
                            </div>
                            <div style="font-size: 0.9rem; color: #374151;">${p.narrativa}</div>
                            <div style="font-size: 0.8rem; color: #9ca3af; margin-top: 0.5rem;">√Åreas: ${p.areasRelacionadas.join(' ‚Ä¢ ')}</div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }
    
    // =====================================================
    // SECCI√ìN 2: CONCLUSIONES
    // =====================================================
    resumenHTML += `
        <div class="justificacion-box" style="margin-top: 1.5rem;">
            <h4>üìù Conclusiones</h4>
            <ol style="margin: 0.5rem 0 0 1.5rem; color: #374151;">
                ${analisis.conclusiones.map(c => `
                    <li style="margin-bottom: 0.5rem; ${c.especifica ? 'font-weight: 500;' : ''}">${c.texto}</li>
                `).join('')}
            </ol>
        </div>`;
    
    // =====================================================
    // SECCI√ìN 3: RECOMENDACIONES
    // =====================================================
    resumenHTML += `
        <div class="justificacion-box" style="margin-top: 1rem; background: #f0fdf4; border-color: #86efac;">
            <h4>üí° Recomendaciones</h4>
            <ol style="margin: 0.5rem 0 0 1.5rem; color: #374151;">
                ${analisis.recomendaciones.map(r => `
                    <li style="margin-bottom: 0.5rem; ${r.especifica ? 'font-weight: 500;' : ''}">${r.texto}</li>
                `).join('')}
            </ol>
        </div>`;
    
    // =====================================================
    // SECCI√ìN 4: PRIORIZACI√ìN
    // =====================================================
    resumenHTML += `
        <div class="justificacion-box" style="margin-top: 1rem; background: #eff6ff; border-color: #93c5fd;">
            <h4>üéØ Priorizaci√≥n de √Åreas</h4>
            <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-size: 0.9rem;">
                <thead>
                    <tr style="background: #dbeafe;">
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #93c5fd;">Prioridad</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #93c5fd;">√Årea</th>
                        <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #93c5fd;">Justificaci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    ${analisis.priorizacion.slice(0, 8).map((p, idx) => `
                        <tr style="background: ${idx % 2 === 0 ? '#f8fafc' : 'white'};">
                            <td style="padding: 0.5rem; font-weight: 700; color: #0074c8;">${idx + 1}¬∫</td>
                            <td style="padding: 0.5rem; font-weight: 600;">${p.area}</td>
                            <td style="padding: 0.5rem; font-size: 0.85rem; color: #64748b;">${p.justificacion}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>`;
    
    // =====================================================
    // SECCI√ìN 4B: PARTICIPACI√ìN CIUDADANA (si existe)
    // =====================================================
    if (window.datosParticipacionCiudadana) {
        const participacion = window.datosParticipacionCiudadana;
        const decision = window.decisionPriorizacionActual;
        
        resumenHTML += `
            <div class="justificacion-box" style="margin-top: 1rem; background: linear-gradient(135deg, #dbeafe 0%, #ede9fe 100%); border-color: #818cf8;">
                <h4>üó≥Ô∏è Participaci√≥n ciudadana <span style="font-weight: normal; font-size: 0.85rem;">(${participacion.totalParticipantes} participantes - ${new Date(participacion.fechaVotacion).toLocaleDateString('es-ES')})</span></h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.75rem;">
                    <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid #c7d2fe;">
                        <div style="font-size: 0.85rem; color: #6366f1; font-weight: 600;">üéØ Objetivo prioritario</div>
                        <div style="font-size: 1.25rem; margin-top: 0.25rem;">${participacion.objetivoPrioritario.icono} ${participacion.objetivoPrioritario.texto}</div>
                        <div style="font-size: 0.85rem; color: #64748b;">${participacion.objetivoPrioritario.porcentaje}% de los votos</div>
                    </div>
                    <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid #c7d2fe;">
                        <div style="font-size: 0.85rem; color: #6366f1; font-weight: 600;">üë• Colectivo prioritario</div>
                        <div style="font-size: 1.25rem; margin-top: 0.25rem;">${participacion.colectivoPrioritario.icono} ${participacion.colectivoPrioritario.texto}</div>
                        <div style="font-size: 0.85rem; color: #64748b;">${participacion.colectivoPrioritario.porcentaje}% de los votos</div>
                    </div>
                </div>
                
                ${decision ? `
                    <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid #c7d2fe;">
                        <div style="font-size: 0.85rem; color: #4f46e5; font-weight: 600;">üìã Decisi√≥n adoptada: 
                            <span style="font-weight: 700;">${decision.metodo === 'epidemiologica' ? 'Prioridad epidemiol√≥gica' : decision.metodo === 'ciudadana' ? 'Prioridad ciudadana' : 'Integraci√≥n de ambas'}</span>
                        </div>
                        ${decision.justificacion ? `<div style="font-size: 0.85rem; color: #64748b; margin-top: 0.25rem;">${decision.justificacion}</div>` : ''}
                        <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem;">Decidido el ${new Date(decision.fechaDecision).toLocaleDateString('es-ES')}</div>
                    </div>
                ` : `
                    <div style="margin-top: 1rem; text-align: center;">
                        <button onclick="mostrarPriorizacionDual()" style="padding: 0.5rem 1rem; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            Decidir priorizaci√≥n
                        </button>
                    </div>
                `}
            </div>`;
    }
    
    // =====================================================
    // SECCI√ìN 5: PROPUESTA DE PLAN (EPVSA)
    // =====================================================
    propuestaActual = generarSeleccionPropuesta(analisis);
    
    let detalleHTML = '<h3>üìã Propuesta de Plan de acci√≥n (EPVSA)</h3>';
    
    propuestaActual.forEach(lineaProp => {
        const linea = getEstructuraActual().find(l => l.id === lineaProp.lineaId);
        if (!linea) return;
        
        detalleHTML += `
            <div class="propuesta-linea" style="border-color: ${linea.color};">
                <div class="propuesta-linea-header" style="background: ${linea.color};">
                    <h4>${linea.codigo}: ${linea.nombreCorto || linea.nombre}</h4>
                    <span class="propuesta-linea-relevancia">${lineaProp.relevancia}% relevancia</span>
                </div>
                <div class="propuesta-linea-content">
                    <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">${lineaProp.justificacion}</p>
                    
                    <!-- Objetivos seleccionados -->
                    ${lineaProp.objetivos.map(objIdx => {
                        const obj = linea.objetivos[objIdx];
                        if (!obj) return '';
                        return `
                            <div class="propuesta-objetivo">
                                <div class="propuesta-objetivo-header">
                                    <span class="propuesta-objetivo-codigo" style="background: ${linea.color};">${obj.codigo}</span>
                                    <span class="propuesta-objetivo-nombre">${obj.nombre}</span>
                                    <span class="propuesta-objetivo-match">‚úì Recomendado</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <!-- Programas seleccionados -->
                    <div class="propuesta-programas">
                        <h5 style="margin: 1rem 0 0.5rem 0; color: #475569;">üìã programas recomendados</h5>
                        ${lineaProp.programas.map(progData => {
                            const progIdx = typeof progData === 'object' ? progData.programaIdx : progData;
                            const prog = linea.programas ? linea.programas[progIdx] : null;
                            if (!prog) return '';
                            return `
                                <div class="propuesta-programa">
                                    <div class="propuesta-programa-header">
                                        <span class="propuesta-programa-codigo">${prog.codigo}</span>
                                        <span class="propuesta-programa-nombre">${prog.nombreCorto || prog.nombre}</span>
                                        <span style="background: #f1f5f9; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; color: #64748b; margin-left: 0.5rem;">${prog.ambito}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        `;
    });
    
    // =====================================================
    // SECCI√ìN 6: NARRATIVA SALUTOG√âNICA
    // =====================================================
    if (analisis.narrativa) {
        const n = analisis.narrativa;
        resumenHTML += `
            <div class="justificacion-box" style="margin-top: 1.5rem; background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border-color: #10b981;">
                <h4 style="color: #059669; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="this.parentElement.classList.toggle('narrativa-expandida'); this.querySelector('.flecha-narrativa').style.transform = this.parentElement.classList.contains('narrativa-expandida') ? 'rotate(180deg)' : 'rotate(0deg)';">
                    üìñ An√°lisis salutog√©nico del perfil de salud
                    <span class="flecha-narrativa" style="transition: transform 0.3s; font-size: 0.8rem;">‚ñº</span>
                </h4>
                <div class="narrativa-contenido" style="display: none; margin-top: 1rem; line-height: 1.7; color: #374151;">
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="color: #059669; margin-bottom: 0.5rem;">Contexto</h5>
                        <p style="text-align: justify;">${n.contexto}</p>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="color: #059669; margin-bottom: 0.5rem;">Activos y fortalezas</h5>
                        <div style="text-align: justify;">${n.activos.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>').replace(/\n\n/g, '</p><p style="margin-top: 0.75rem;">')}</div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="color: #f59e0b; margin-bottom: 0.5rem;">Oportunidades de mejora</h5>
                        <div style="text-align: justify;">${n.oportunidades.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>').replace(/\n\n/g, '</p><p style="margin-top: 0.75rem;">')}</div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h5 style="color: #6366f1; margin-bottom: 0.5rem;">Patrones transversales</h5>
                        <div style="text-align: justify;">${n.patrones.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>').replace(/\n\n/g, '</p><p style="margin-top: 0.75rem;">')}</div>
                    </div>
                    
                    <div style="background: #ecfdf5; padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981;">
                        <h5 style="color: #059669; margin-bottom: 0.5rem;">S√≠ntesis</h5>
                        <p style="text-align: justify; margin: 0;">${n.sintesis.replace(/\n\n/g, '</p><p style="margin-top: 0.75rem; text-align: justify;">')}</p>
                    </div>
                </div>
            </div>
            <style>
                .narrativa-expandida .narrativa-contenido { display: block !important; }
            </style>
        `;
    }
    
    document.getElementById('propuesta-resumen').innerHTML = resumenHTML;
    document.getElementById('propuesta-detalle').innerHTML = detalleHTML;
    document.getElementById('propuesta-automatica-container').style.display = 'block';
    
    // Resetear estado de propuesta aceptada (por si se regenera)
    window.propuestaAceptada = false;
    window.seleccionAceptada = null;
    const btnAceptar = document.getElementById('btn-aceptar-propuesta');
    if (btnAceptar) btnAceptar.style.display = 'inline-flex';
    const accionesAceptada = document.getElementById('propuesta-aceptada-acciones');
    if (accionesAceptada) accionesAceptada.style.display = 'none';
}

// =====================================================
// FUNCI√ìN PARA CONVERTIR AN√ÅLISIS A SELECCI√ìN EPVSA
// =====================================================
function generarSeleccionPropuesta(analisis) {
    const propuesta = [];
    
    analisis.propuestaEPVSA.forEach(prop => {
        const linea = getEstructuraActual().find(l => l.id === prop.lineaId);
        if (!linea) return;
        
        const lineaPropuesta = {
            lineaId: prop.lineaId,
            relevancia: prop.relevancia,
            justificacion: prop.justificacion,
            objetivos: prop.objetivos.map(objIdx => ({
                objetivoIdx: objIdx,
                indicadores: linea.objetivos[objIdx]?.indicadores?.map((_, i) => i).slice(0, 3) || []
            })),
            programas: prop.programas.map(progIdx => ({
                programaIdx: progIdx,
                actuaciones: linea.programas?.[progIdx]?.actuaciones?.map((_, i) => i).slice(0, 5) || []
            }))
        };
        
        propuesta.push(lineaPropuesta);
    });
    
    return propuesta;
}


function aceptarPropuesta() {
    if (!propuestaActual || propuestaActual.length === 0) {
        mostrarNotificacion({
            title: 'Sin propuesta',
            message: 'No hay propuesta autom√°tica para aceptar. Ejecute primero el an√°lisis.',
            type: 'warning'
        });
        return;
    }
    
    // Marcar la propuesta como aceptada (guardar en variable global)
    window.propuestaAceptada = true;
    window.seleccionAceptada = convertirPropuestaASeleccion(propuestaActual);
    
    // Ocultar bot√≥n de aceptar y mostrar bot√≥n de generar documento
    const btnAceptar = document.getElementById('btn-aceptar-propuesta');
    if (btnAceptar) {
        btnAceptar.style.display = 'none';
    }
    
    const accionesAceptada = document.getElementById('propuesta-aceptada-acciones');
    if (accionesAceptada) {
        accionesAceptada.style.display = 'block';
        accionesAceptada.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Tambi√©n preparar el modo manual por si el usuario quiere editar despu√©s
    const container = document.getElementById('plan-accion-container');
    if (!container || container.innerHTML.trim() === '') {
        renderPlanAccion();
    }
    
    // Aplicar selecci√≥n a los checkboxes del modo manual (en background)
    setTimeout(() => {
        aplicarPropuestaACheckboxes(false); // false = sin notificaci√≥n ni scroll
    }, 300);
    
    mostrarNotificacion({
        title: 'Propuesta aceptada',
        message: 'Pulse ¬´Generar documento¬ª para completar el plan de acci√≥n.',
        type: 'success',
        duration: 4000
    });
}

function aplicarPropuestaACheckboxes(mostrarFeedback = true) {
    // Limpiar todas las selecciones
    document.querySelectorAll('#plan-accion-container input[type="checkbox"]').forEach(chk => chk.checked = false);
    
    let aplicados = 0;
    
    // Aplicar la propuesta
    propuestaActual.forEach(lineaProp => {
        const linea = getEstructuraActual().find(l => l.id === lineaProp.lineaId);
        if (!linea) {
            console.warn('L√≠nea no encontrada:', lineaProp.lineaId);
            return;
        }
        
        // Marcar l√≠nea
        const lineaChk = document.getElementById('chk-linea-' + lineaProp.lineaId);
        if (lineaChk) {
            lineaChk.checked = true;
            aplicados++;
        }
        
        const lineaEl = document.getElementById('linea-' + lineaProp.lineaId);
        if (lineaEl) lineaEl.classList.add('abierta');
        
        // Marcar objetivos e indicadores
        if (lineaProp.objetivos) {
            lineaProp.objetivos.forEach(objProp => {
                const objIdx = typeof objProp === 'object' ? objProp.objetivoIdx : objProp;
                const objId = lineaProp.lineaId + '-' + objIdx;
                
                const objChk = document.getElementById('chk-obj-' + objId);
                if (objChk) {
                    objChk.checked = true;
                    aplicados++;
                }
                
                const objEl = document.getElementById('obj-' + objId);
                if (objEl) objEl.classList.add('abierto');
                
                const indicadores = typeof objProp === 'object' ? objProp.indicadores : [];
                if (indicadores) {
                    indicadores.forEach(ii => {
                        const indChk = document.getElementById('chk-ind-' + objId + '-' + ii);
                        if (indChk) {
                            indChk.checked = true;
                            aplicados++;
                        }
                    });
                }
            });
        }
        
        // Marcar programas y actuaciones
        if (lineaProp.programas) {
            lineaProp.programas.forEach(progProp => {
                const progIdx = typeof progProp === 'object' ? progProp.programaIdx : progProp;
                const progId = lineaProp.lineaId + '-' + progIdx;
                
                const progChk = document.getElementById('chk-prog-' + progId);
                if (progChk) {
                    progChk.checked = true;
                    aplicados++;
                }
                
                const progEl = document.getElementById('prog-' + progId);
                if (progEl) {
                    progEl.classList.add('abierto');
                    const content = progEl.querySelector('.epvsa-programa-content');
                    if (content) content.style.display = 'block';
                }
                
                const actuaciones = typeof progProp === 'object' ? progProp.actuaciones : [];
                if (actuaciones) {
                    actuaciones.forEach(ai => {
                        const actChk = document.getElementById('chk-act-' + progId + '-' + ai);
                        if (actChk) {
                            actChk.checked = true;
                            aplicados++;
                        }
                    });
                }
            });
        }
    });
    
    actualizarStatsPlan();
    console.log('‚úÖ Propuesta aplicada:', aplicados, 'elementos seleccionados');
    
    if (mostrarFeedback) {
        mostrarNotificacion({
            title: 'Propuesta aceptada',
            message: `Se han seleccionado ${aplicados} elementos. Pulse ¬´Generar plan de acci√≥n¬ª para completar.`,
            type: 'success',
            duration: 5000
        });
        
        // Scroll al bot√≥n de generar
        const btnGenerar = document.querySelector('.plan-accion-footer .btn-accion');
        if (btnGenerar) {
            btnGenerar.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

function editarPropuesta() {
    aceptarPropuesta(); // Igual que aceptar, permite editar en modo manual
}

// ============================================
// SECCI√ìN METODOLOG√çA DE PRIORIZACI√ìN
// Transparencia sobre fusi√≥n epidemio/ciudadana
// ============================================

function generarSeccionMetodologiaPriorizacion() {
    const decision = window.decisionPriorizacionActual;
    const participacion = window.datosParticipacionCiudadana;
    const datosFusion = window.datosFusionPriorizacion;
    
    // Si no hay decisi√≥n de priorizaci√≥n, no mostrar nada
    if (!decision) {
        return '';
    }
    
    let html = `
        <div class="plan-documento-seccion" style="background: linear-gradient(135deg, #f0fdf4 0%, #dbeafe 100%); border: 2px solid #0074c8; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;">
            <h2 style="color: #0074c8; margin-top: 0;">üìä Metodolog√≠a de Priorizaci√≥n</h2>
    `;
    
    // M√©todo aplicado
    const metodoLabels = {
        'epidemiologica': 'üî¨ Priorizaci√≥n Epidemiol√≥gica',
        'ciudadana': 'üó≥Ô∏è Priorizaci√≥n Ciudadana',
        'integracion': '‚öñÔ∏è Priorizaci√≥n Integrada (Epidemiolog√≠a + Ciudadan√≠a)'
    };
    
    html += `
        <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <h3 style="color: #1e293b; font-size: 1.1rem; margin-top: 0;">M√©todo aplicado</h3>
            <p style="font-size: 1rem; font-weight: 600; color: #0074c8; margin: 0;">${metodoLabels[decision.metodo] || decision.metodo}</p>
            ${decision.fechaDecision ? `<p style="font-size: 0.85rem; color: #64748b; margin: 0.5rem 0 0;">Fecha de decisi√≥n: ${new Date(decision.fechaDecision).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>` : ''}
        </div>
    `;
    
    // Si hay justificaci√≥n
    if (decision.justificacion && decision.justificacion.trim()) {
        html += `
            <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                <h4 style="margin: 0 0 0.5rem; color: #92400e;">üí° Justificaci√≥n de la decisi√≥n</h4>
                <p style="margin: 0; color: #78350f; font-style: italic;">"${decision.justificacion}"</p>
            </div>
        `;
    }
    
    // CASO 1: Priorizaci√≥n Integrada (FUSI√ìN 70/30)
    if (decision.metodo === 'integracion' && decision.metodologiaFusion) {
        const metodo = decision.metodologiaFusion;
        
        html += `
            <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <h3 style="color: #7c3aed; font-size: 1.1rem; margin-top: 0;">üßÆ Algoritmo de Fusi√≥n Aplicado</h3>
                <p style="color: #374151;">Este plan de acci√≥n ha sido priorizado mediante un <strong>modelo h√≠brido √©tico</strong> que combina:</p>
                <ul style="color: #374151; line-height: 1.8;">
                    <li><strong>${Math.round(metodo.pesoEpidemiologico * 100)}%</strong> Evidencia epidemiol√≥gica (an√°lisis de indicadores de salud)</li>
                    <li><strong>${Math.round(metodo.pesoCiudadano * 100)}%</strong> Voluntad ciudadana (votaci√≥n popular con ${participacion ? participacion.totalParticipantes : 0} participantes)</li>
                </ul>
            </div>
        `;
        
        // Salvaguardas aplicadas
        if (metodo.salvaguardasAplicadas && metodo.salvaguardasAplicadas.length > 0) {
            html += `
                <div style="background: #ecfdf5; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                    <h4 style="margin: 0 0 0.75rem; color: #065f46;">üõ°Ô∏è Salvaguardas √âticas Activadas</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${metodo.salvaguardasAplicadas.map(s => `
                            <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid #a7f3d0;">
                                <div style="font-weight: 600; color: #047857; margin-bottom: 0.25rem;">
                                    ${s.tipo === 'proteccion_epidemiologica' ? 'üî¨ Protecci√≥n Epidemiol√≥gica' : 'üó≥Ô∏è Boost Democr√°tico'}: ${s.area}
                                </div>
                                <div style="font-size: 0.9rem; color: #065f46;">${s.mensaje}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Conflictos detectados
        if (metodo.conflictosDetectados && metodo.conflictosDetectados.length > 0) {
            html += `
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                    <h4 style="margin: 0 0 0.75rem; color: #92400e;">‚ö†Ô∏è Discrepancias Detectadas</h4>
                    <p style="font-size: 0.9rem; color: #78350f; margin-bottom: 0.75rem;">Se identificaron diferencias significativas (‚â•5 posiciones) entre rankings:</p>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${metodo.conflictosDetectados.slice(0, 3).map(c => `
                            <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid #fde68a;">
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem;">${c.area}</div>
                                <div style="font-size: 0.85rem; color: #78350f;">${c.mensaje}</div>
                            </div>
                        `).join('')}
                    </div>
                    ${metodo.conflictosDetectados.length > 3 ? `
                        <p style="font-size: 0.85rem; color: #78350f; margin: 0.5rem 0 0; font-style: italic;">
                            Y ${metodo.conflictosDetectados.length - 3} discrepancia(s) adicional(es).
                        </p>
                    ` : ''}
                </div>
            `;
        }
        
        // Ranking fusionado TOP-5
        if (metodo.rankingFusionado && metodo.rankingFusionado.length > 0) {
            html += `
                <div style="background: white; border-radius: 8px; padding: 1rem;">
                    <h4 style="margin: 0 0 0.75rem; color: #1e293b;">üéØ Ranking Final Fusionado (TOP-5)</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="background: #f1f5f9; border-bottom: 2px solid #cbd5e1;">
                                <th style="padding: 0.5rem; text-align: left; color: #475569;">Posici√≥n</th>
                                <th style="padding: 0.5rem; text-align: left; color: #475569;">√Årea / Objetivo</th>
                                <th style="padding: 0.5rem; text-align: center; color: #475569;">Score Final</th>
                                <th style="padding: 0.5rem; text-align: center; color: #475569;">Pos. Epidemio</th>
                                <th style="padding: 0.5rem; text-align: center; color: #475569;">Pos. Ciudadana</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${metodo.rankingFusionado.slice(0, 5).map((item, idx) => `
                                <tr style="border-bottom: 1px solid #e5e7eb; ${idx < 3 ? 'background: #f0fdf4;' : ''}">
                                    <td style="padding: 0.5rem; font-weight: 600; color: #0074c8;">#${idx + 1}</td>
                                    <td style="padding: 0.5rem; color: #1e293b;">${item.area}</td>
                                    <td style="padding: 0.5rem; text-align: center; font-weight: 600; color: #059669;">${item.scoreFusionado.toFixed(2)}</td>
                                    <td style="padding: 0.5rem; text-align: center; color: #64748b;">#${item.posicionEpi !== 999 ? item.posicionEpi : '-'}</td>
                                    <td style="padding: 0.5rem; text-align: center; color: #64748b;">#${item.posicionCiudadana !== 999 ? item.posicionCiudadana : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p style="font-size: 0.8rem; color: #64748b; margin: 0.75rem 0 0; font-style: italic;">
                        Score final = (Score epidemio √ó 0.70) + (Score ciudadano √ó 0.30) + salvaguardas
                    </p>
                </div>
            `;
        }
        
    // CASO 2: Priorizaci√≥n Epidemiol√≥gica Pura
    } else if (decision.metodo === 'epidemiologica' && decision.fuenteEpidemiologica) {
        html += `
            <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                <h4 style="margin: 0 0 0.75rem; color: #065f46;">üî¨ Fuente: An√°lisis Epidemiol√≥gico</h4>
                <p style="color: #047857; margin: 0;">Las prioridades se han establecido exclusivamente en base al an√°lisis de indicadores de salud y determinantes epidemiol√≥gicos del territorio.</p>
            </div>
        `;
        if (decision.fuenteEpidemiologica.length > 0) {
            html += `
                <div style="background: white; border-radius: 8px; padding: 1rem;">
                    <h4 style="margin: 0 0 0.75rem; color: #1e293b;">üéØ Prioridades Epidemiol√≥gicas Seleccionadas</h4>
                    <ol style="margin: 0; padding-left: 1.5rem; color: #374151; line-height: 1.8;">
                        ${decision.fuenteEpidemiologica.map(p => `
                            <li><strong>${p.area}</strong> - ${p.justificacion || 'Sin justificaci√≥n disponible'}</li>
                        `).join('')}
                    </ol>
                </div>
            `;
        }
        
    // CASO 3: Priorizaci√≥n Ciudadana Pura
    } else if (decision.metodo === 'ciudadana' && decision.fuenteCiudadana) {
        const fc = decision.fuenteCiudadana;
        html += `
            <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                <h4 style="margin: 0 0 0.75rem; color: #1e40af;">üó≥Ô∏è Fuente: Consulta Ciudadana</h4>
                <p style="color: #1e40af; margin: 0;">Las prioridades se han establecido exclusivamente en base a la votaci√≥n popular realizada con <strong>${fc.participantes} ciudadanos/as</strong>.</p>
            </div>
        `;
        if (fc.objetivo) {
            html += `
                <div style="background: white; border-radius: 8px; padding: 1rem;">
                    <h4 style="margin: 0 0 0.75rem; color: #1e293b;">üéØ Prioridad Ciudadana Seleccionada</h4>
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
                        <span style="font-size: 2.5rem;">${fc.objetivo.icono}</span>
                        <div>
                            <div style="font-weight: 600; color: #0c4a6e; font-size: 1.1rem;">${fc.objetivo.texto}</div>
                            <div style="color: #0369a1; font-size: 0.9rem;">${fc.objetivo.porcentaje}% de los votos (${fc.objetivo.votos} participantes)</div>
                        </div>
                    </div>
                    ${fc.colectivo ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: #f5f3ff; border-radius: 8px; border: 1px solid #e9d5ff;">
                            <strong style="color: #6b21a8;">Colectivo prioritario:</strong> ${fc.colectivo.icono} ${fc.colectivo.texto} (${fc.colectivo.porcentaje}%)
                        </div>
                    ` : ''}
                </div>
            `;
        }
    }
    
    html += `
        </div>
    `;
    
    return html;
}

function generarDocumentoPlan() {
    // Si hay votaci√≥n ciudadana pero no hay decisi√≥n de priorizaci√≥n, mostrar modal primero
    if (window.datosParticipacionCiudadana && !window.decisionPriorizacionActual) {
        mostrarPriorizacionDual();
        mostrarNotificacion('Antes de generar el plan, debe decidir c√≥mo integrar la votaci√≥n ciudadana', 'warning');
        return;
    }
    
    const municipio = getNombreMunicipio(getMunicipioActual());
    const fecha = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
    
    // Intentar obtener selecci√≥n del modo manual primero
    let seleccion = obtenerSeleccionActual();
    
    // Si no hay selecci√≥n manual pero hay propuesta autom√°tica, usar la propuesta
    if (seleccion.length === 0 && propuestaActual && propuestaActual.length > 0) {
        seleccion = convertirPropuestaASeleccion(propuestaActual);
    }
    
    if (seleccion.length === 0) {
        alert('No hay elementos seleccionados. Por favor, genere una propuesta autom√°tica o seleccione elementos en el modo manual.');
        return;
    }
    
    let html = `
        <div class="plan-documento-header">
            <h1>üìã Plan de acci√≥n</h1>
            <div class="subtitulo">Alineado con la Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a</div>
            <div class="municipio-nombre">${municipio}</div>
            <div class="fecha">${fecha}</div>
        </div>
        
        <div class="plan-documento-seccion">
            <h2>1. Introducci√≥n</h2>
            <p>El presente Plan de acci√≥n de ${municipio} se ha elaborado en el marco del diagn√≥stico comunitario de salud, tomando como referencia la Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a (EPVSA) y el an√°lisis de la situaci√≥n de salud del municipio.</p>
            <p>Este plan recoge las l√≠neas estrat√©gicas, objetivos, indicadores, programas y actuaciones priorizadas para mejorar la salud y el bienestar de la poblaci√≥n de ${municipio}.</p>
        </div>
        
        ${generarSeccionMetodologiaPriorizacion()}
        
        <div class="plan-documento-seccion">
            <h2>2. Resumen ejecutivo</h2>
            <p>El plan contempla <strong>${seleccion.length} l√≠neas estrat√©gicas</strong> con sus correspondientes objetivos, indicadores de seguimiento, programas y actuaciones-tipo.</p>
        </div>
        
        <div class="plan-documento-seccion">
            <h2>3. L√≠neas estrat√©gicas y actuaciones</h2>
            ${seleccion.map(lineaSel => {
                const linea = getEstructuraActual().find(l => l.id === lineaSel.id);
                if (!linea) return '';
                return `
                    <div class="doc-linea" style="border-color: ${linea.color};">
                        <h3 style="color: ${linea.color};">${linea.codigo}: ${linea.nombreCorto || linea.nombre}</h3>
                        
                        <!-- Objetivos e indicadores -->
                        ${(lineaSel.objetivos || []).map(objSel => {
                            const obj = linea.objetivos[objSel.idx];
                            if (!obj) return '';
                            return `
                                <div class="doc-objetivo">
                                    <div class="doc-objetivo-titulo">${obj.codigo}: ${obj.nombre}</div>
                                    ${(objSel.indicadores || []).length > 0 ? `
                                        <div class="doc-indicadores">
                                            <strong>Indicadores:</strong><br>
                                            ${objSel.indicadores.map(i => '‚Ä¢ ' + (obj.indicadores[i] || '')).join('<br>')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                        
                        <!-- Programas y actuaciones (ahora a nivel de l√≠nea) -->
                        ${lineaSel.programas && lineaSel.programas.length > 0 ? `
                            <div class="doc-programas-section">
                                <h4 style="margin-top: 1rem; color: #475569;">üìã Programas y Actuaciones</h4>
                                ${lineaSel.programas.map(progSel => {
                                    const prog = linea.programas ? linea.programas[progSel.idx] : null;
                                    if (!prog) return '';
                                    return `
                                        <div class="doc-programa">
                                            <div class="doc-programa-titulo">${prog.codigo}: ${prog.nombreCorto || prog.nombre} <span style="font-size: 0.85rem; color: #64748b;">(${prog.ambito})</span></div>
                                            ${(progSel.actuaciones || []).length > 0 ? `
                                                <div class="doc-actuaciones">
                                                    ${progSel.actuaciones.map(a => {
                                                        const act = prog.actuaciones ? prog.actuaciones[a] : null;
                                                        return act ? '‚ñ∏ <strong>' + act.codigo + '</strong>: ' + act.nombre : '';
                                                    }).join('<br>')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('')}
        </div>
        
        <div class="plan-documento-seccion">
            <h2>4. Seguimiento y evaluaci√≥n</h2>
            <p>El seguimiento del plan se realizar√° mediante los indicadores seleccionados para cada objetivo estrat√©gico. Se establecer√°n reuniones peri√≥dicas del grupo motor para evaluar el grado de avance y realizar los ajustes necesarios.</p>
        </div>
        
        <div class="plan-documento-footer">
            <p>Documento generado con COMP√ÅS - Dise√±o ciudadano de la salud</p>
            <p>${fecha}</p>
        </div>
    `;
    
    document.getElementById('plan-documento').innerHTML = html;
    document.getElementById('plan-documento-container').style.display = 'block';
    document.getElementById('plan-documento-container').scrollIntoView({ behavior: 'smooth' });
    
    // *** GUARDAR PARA EL COMPILADOR ***
    guardarPlanAccionParaCompilador(html, seleccion);
}

// Convierte la propuesta autom√°tica al formato de selecci√≥n
function convertirPropuestaASeleccion(propuesta) {
    return propuesta.map(lineaProp => ({
        id: lineaProp.lineaId,
        objetivos: (lineaProp.objetivos || []).map(objProp => ({
            idx: objProp.objetivoIdx,
            indicadores: objProp.indicadores || []
        })),
        programas: (lineaProp.programas || []).map(progProp => ({
            idx: progProp.programaIdx,
            actuaciones: progProp.actuaciones || []
        }))
    }));
}

function obtenerSeleccionActual() {
    const seleccion = [];
    
    getEstructuraActual().forEach(linea => {
        if (!document.getElementById('chk-linea-' + linea.id)?.checked) return;
        
        const lineaSel = { id: linea.id, objetivos: [], programas: [] };
        
        // Obtener objetivos e indicadores seleccionados
        linea.objetivos.forEach((obj, oi) => {
            if (!document.getElementById('chk-obj-' + linea.id + '-' + oi)?.checked) return;
            
            const objSel = { idx: oi, indicadores: [] };
            
            obj.indicadores.forEach((_, ii) => {
                if (document.getElementById('chk-ind-' + linea.id + '-' + oi + '-' + ii)?.checked) {
                    objSel.indicadores.push(ii);
                }
            });
            
            lineaSel.objetivos.push(objSel);
        });
        
        // Obtener programas y actuaciones seleccionados (ahora a nivel de l√≠nea)
        if (linea.programas) {
            linea.programas.forEach((prog, pi) => {
                if (!document.getElementById('chk-prog-' + linea.id + '-' + pi)?.checked) return;
                
                const progSel = { idx: pi, actuaciones: [] };
                
                if (prog.actuaciones) {
                    prog.actuaciones.forEach((_, ai) => {
                        if (document.getElementById('chk-act-' + linea.id + '-' + pi + '-' + ai)?.checked) {
                            progSel.actuaciones.push(ai);
                        }
                    });
                }
                
                lineaSel.programas.push(progSel);
            });
        }
        
        seleccion.push(lineaSel);
    });
    
    return seleccion;
}

function imprimirPlan() {
    window.print();
}

function exportarPlanPDF() {
    alert('Para exportar a PDF, utilice la funci√≥n de imprimir (Ctrl+P) y seleccione ¬´Guardar como PDF¬ª como destino.');
    window.print();
}

function cerrarDocumentoPlan() {
    document.getElementById('plan-documento-container').style.display = 'none';
}

// Init
// ==========================================
// AGENDAS ANUALES - FASE 6 IMPLANTACI√ìN
// ==========================================

let accionesAgenda = [];
let accionIdCounter = 1;

// ACTUACIONES-TIPO EPVSA PARA PADUL - AGENDA 2026
const ACTUACIONES_PADUL_2026 = [
    // ========== ENTORNO SANITARIO ==========
    {
        id: 1, entorno: 'sanitario', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Consejo diet√©tico estructurado en consulta de atenci√≥n primaria',
        codigoEPVSA: 'P03-A01', programa: 'Promoci√≥n en centros sanitarios',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Incrementar consumo alimentos saludables',
        descripcion: 'Intervenci√≥n breve sobre alimentaci√≥n saludable en consultas de medicina y enfermer√≠a de familia, siguiendo el protocolo IAHS de consejo diet√©tico.',
        poblacion: 'Poblaci√≥n adulta con factores de riesgo cardiovascular',
        etapaVida: 'Adultos (30-64 a√±os)',
        responsable: 'Enfermer√≠a de atenci√≥n primaria',
        organizacion: 'Centro de Salud',
        profesionales: 'Enfermeras/os de familia, M√©dicas/os de familia',
        indicador: 'N¬∫ de consejos diet√©ticos registrados en Diraya / Poblaci√≥n diana',
        meta: '‚â•15% de la poblaci√≥n diana con consejo registrado',
        recursos: 'Material IAHS alimentaci√≥n, gu√≠as PREDIMED, b√°scula e IMC',
        frecuencia: 'Continua durante todo el a√±o',
        evidencia: 'Recomendaci√≥n PAPPS, Gu√≠a NICE',
        orden: 100
    },
    {
        id: 2, entorno: 'sanitario', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Prescripci√≥n de ejercicio f√≠sico desde atenci√≥n primaria',
        codigoEPVSA: 'P03-A02', programa: 'Promoci√≥n en centros sanitarios',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.2 - Aumentar niveles de actividad f√≠sica',
        descripcion: 'Prescripci√≥n personalizada de actividad f√≠sica adaptada a las condiciones de salud del paciente, con derivaci√≥n a recursos comunitarios cuando proceda.',
        poblacion: 'Poblaci√≥n sedentaria, pacientes con patolog√≠a cr√≥nica',
        etapaVida: 'Adultos y mayores',
        responsable: 'Medicina y Enfermer√≠a de familia',
        organizacion: 'Centro de Salud',
        profesionales: 'M√©dicas/os de familia, Enfermeras/os, Fisioterapeutas',
        indicador: 'N¬∫ de prescripciones de ejercicio / Poblaci√≥n sedentaria identificada',
        meta: '‚â•10% de pacientes sedentarios con prescripci√≥n',
        recursos: 'Receta de ejercicio, cat√°logo de activos comunitarios deportivos',
        frecuencia: 'Continua durante todo el a√±o',
        evidencia: 'Estrategia NAOS, Plan integral actividad f√≠sica Andaluc√≠a',
        orden: 101
    },
    {
        id: 3, entorno: 'sanitario', anio: '2026', trimestre: 'T2', prioridad: 'alta',
        nombre: 'Cribado e intervenci√≥n breve en consumo de alcohol (AUDIT)',
        codigoEPVSA: 'P03-A03', programa: 'Promoci√≥n en centros sanitarios',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.4 - Disminuir consumo bebidas alcoh√≥licas',
        descripcion: 'Aplicaci√≥n sistem√°tica del cuestionario AUDIT en poblaci√≥n de riesgo e intervenci√≥n breve motivacional en casos positivos.',
        poblacion: 'Poblaci√≥n adulta en consultas de AP',
        etapaVida: 'Adultos (18-64 a√±os)',
        responsable: 'Medicina de familia',
        organizacion: 'Centro de Salud',
        profesionales: 'M√©dicas/os de familia, Enfermeras/os',
        indicador: 'N¬∫ AUDIT realizados / N¬∫ intervenciones breves',
        meta: '‚â•500 cribados anuales',
        recursos: 'Cuestionario AUDIT, material intervenci√≥n breve',
        frecuencia: 'Continua durante todo el a√±o',
        evidencia: 'PAPPS, Gu√≠a cl√≠nica alcohol MSC',
        orden: 102
    },
    {
        id: 4, entorno: 'sanitario', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Programa de Intervenci√≥n en Tabaquismo (PITA)',
        codigoEPVSA: 'P03-A04', programa: 'Promoci√≥n en centros sanitarios',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.3 - Disminuir consumo de tabaco',
        descripcion: 'Intervenci√≥n individual y grupal para la deshabituaci√≥n tab√°quica seg√∫n protocolo PITA del SSPA.',
        poblacion: 'Poblaci√≥n fumadora que desea dejar de fumar',
        etapaVida: 'Adultos',
        responsable: 'Enfermer√≠a de atenci√≥n primaria',
        organizacion: 'Centro de Salud',
        profesionales: 'Enfermeras/os referentes PITA',
        indicador: 'N¬∫ personas en programa / Tasa de abstinencia a 12 meses',
        meta: '‚â•60 personas en programa, ‚â•30% abstinencia',
        recursos: 'Material PITA, coox√≠metro, parches nicotina',
        frecuencia: 'Grupos trimestrales + seguimiento individual',
        evidencia: 'Gu√≠a cl√≠nica tabaquismo SSPA',
        orden: 103
    },
    {
        id: 5, entorno: 'sanitario', anio: '2026', trimestre: 'T2', prioridad: 'media',
        nombre: 'Consulta joven de salud sexual y reproductiva',
        codigoEPVSA: 'P03-A05', programa: 'Promoci√≥n en centros sanitarios',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.5 - Promover salud sexual y reproductiva',
        descripcion: 'Espacio de atenci√≥n espec√≠fico para adolescentes y j√≥venes sobre anticoncepci√≥n, ITS y salud afectivo-sexual.',
        poblacion: 'Adolescentes y j√≥venes (14-25 a√±os)',
        etapaVida: 'Adolescencia y juventud',
        responsable: 'Matrona del Centro de Salud',
        organizacion: 'Centro de Salud',
        profesionales: 'Matrona, M√©dico/a de familia',
        indicador: 'N¬∫ consultas realizadas / Satisfacci√≥n usuarios',
        meta: '‚â•100 consultas anuales',
        recursos: 'Espacio consulta joven, material anticonceptivo, tests r√°pidos ITS',
        frecuencia: 'Semanal (1 d√≠a/semana)',
        evidencia: 'Forma Joven, Estrategia salud sexual SSR',
        orden: 104
    },
    {
        id: 6, entorno: 'sanitario', anio: '2026', trimestre: 'T3', prioridad: 'alta',
        nombre: 'Prescripci√≥n social de activos comunitarios',
        codigoEPVSA: 'P03-A06', programa: 'Promoci√≥n en centros sanitarios',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.7 - Incrementar recomendaciones sobre activos',
        descripcion: 'Derivaci√≥n estructurada desde consulta a recursos comunitarios (asociaciones, actividades municipales, grupos de ayuda mutua).',
        poblacion: 'Pacientes con aislamiento social, soledad, malestar emocional',
        etapaVida: 'Todas las edades',
        responsable: 'trabajo social Sanitario',
        organizacion: 'Centro de Salud',
        profesionales: 'Trabajadora Social, Enfermer√≠a, Medicina familia',
        indicador: 'N¬∫ prescripciones sociales / Adherencia a recursos',
        meta: '‚â•50 prescripciones sociales anuales',
        recursos: 'Cat√°logo activos comunitarios, receta social',
        frecuencia: 'Continua durante todo el a√±o',
        evidencia: 'Estrategia prescripci√≥n social SAS',
        orden: 105
    },
    {
        id: 7, entorno: 'sanitario', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Detecci√≥n precoz de malestar emocional y ansiedad',
        codigoEPVSA: 'P03-A07', programa: 'Promoci√≥n en centros sanitarios',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Bienestar emocional',
        descripcion: 'Cribado sistem√°tico de ansiedad y depresi√≥n con escalas validadas (PHQ-9, GAD-7) en poblaci√≥n de riesgo.',
        poblacion: 'Poblaci√≥n adulta con indicadores de riesgo',
        etapaVida: 'Adultos',
        responsable: 'Medicina y Enfermer√≠a de familia',
        organizacion: 'Centro de Salud',
        profesionales: 'M√©dicas/os, Enfermeras/os, Psicolog√≠a cl√≠nica',
        indicador: 'N¬∫ cribados realizados / Casos detectados',
        meta: '‚â•300 cribados anuales',
        recursos: 'Escalas PHQ-9, GAD-7, protocolo derivaci√≥n salud mental',
        frecuencia: 'Continua durante todo el a√±o',
        evidencia: 'Plan integral salud mental Andaluc√≠a',
        orden: 106
    },
    {
        id: 8, entorno: 'sanitario', anio: '2026', trimestre: 'T2', prioridad: 'media',
        nombre: 'Taller grupal de manejo de la ansiedad',
        codigoEPVSA: 'P03-A08', programa: 'Promoci√≥n en centros sanitarios',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Bienestar emocional',
        descripcion: 'Intervenci√≥n grupal psicoeducativa sobre t√©cnicas de manejo de ansiedad y estr√©s.',
        poblacion: 'Personas con ansiedad leve-moderada',
        etapaVida: 'Adultos',
        responsable: 'Enfermer√≠a de salud mental',
        organizacion: 'Centro de Salud / USMC',
        profesionales: 'Enfermera especialista salud mental',
        indicador: 'N¬∫ participantes / Reducci√≥n puntuaci√≥n GAD-7',
        meta: '4 grupos de 12 personas/a√±o',
        recursos: 'Sala grupal, material psicoeducativo',
        frecuencia: 'Trimestral (8 sesiones por grupo)',
        evidencia: 'NICE Guidelines Anxiety',
        orden: 107
    },
    
    // ========== ENTORNO COMUNITARIO ==========
    {
        id: 9, entorno: 'comunitario', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Mapeo participativo de activos para la salud',
        codigoEPVSA: 'P01-A01', programa: 'RELAS - Red de acci√≥n local en salud',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.7 - Incrementar recomendaciones sobre activos',
        descripcion: 'Proceso participativo de identificaci√≥n y geolocalizaci√≥n de recursos comunitarios que generan salud en el municipio.',
        poblacion: 'Comunidad general',
        etapaVida: 'Todas las edades',
        responsable: 'T√©cnico/a de Salud Municipal',
        organizacion: 'Ayuntamiento + Centro de Salud',
        profesionales: 'T√©cnico municipal, Enfermera comunitaria, trabajo social',
        indicador: 'N¬∫ activos mapeados / Actualizaci√≥n del cat√°logo',
        meta: '‚â•50 activos identificados y geolocalizados',
        recursos: 'Plataforma digital mapeo, sesiones participativas',
        frecuencia: 'Enero-Marzo 2026 + actualizaci√≥n continua',
        evidencia: 'Metodolog√≠a Asset Mapping, Observatorio Salud Activos',
        orden: 200
    },
    {
        id: 10, entorno: 'comunitario', anio: '2026', trimestre: 'T2', prioridad: 'alta',
        nombre: 'Rutas saludables por el municipio',
        codigoEPVSA: 'P01-A02', programa: 'RELAS - Red de acci√≥n local en salud',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.2 - Aumentar niveles de actividad f√≠sica',
        descripcion: 'Dise√±o, se√±alizaci√≥n y dinamizaci√≥n de itinerarios peatonales saludables por el casco urbano y entorno natural.',
        poblacion: 'Poblaci√≥n general',
        etapaVida: 'Todas las edades',
        responsable: 'Concejal√≠a de Deportes',
        organizacion: 'Ayuntamiento',
        profesionales: 'T√©cnico deportes, Agente desarrollo local',
        indicador: 'Km de rutas se√±alizadas / N¬∫ usuarios',
        meta: '3 rutas se√±alizadas, ‚â•200 usuarios/mes',
        recursos: 'Se√±al√©tica, folletos informativos, app m√≥vil',
        frecuencia: 'Dise√±o T2, inauguraci√≥n T3, uso continuo',
        evidencia: 'Plan integral actividad f√≠sica Andaluc√≠a',
        orden: 201
    },
    {
        id: 11, entorno: 'comunitario', anio: '2026', trimestre: 'T2', prioridad: 'alta',
        nombre: 'Grupos de caminata comunitaria',
        codigoEPVSA: 'P01-A03', programa: 'RELAS - Red de acci√≥n local en salud',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.2 - Aumentar niveles de actividad f√≠sica',
        descripcion: 'Organizaci√≥n de grupos regulares de paseo saludable con monitor, especialmente dirigidos a personas mayores y sedentarias.',
        poblacion: 'Personas mayores, poblaci√≥n sedentaria',
        etapaVida: 'Adultos mayores (‚â•65 a√±os)',
        responsable: 'Asociaci√≥n de mayores + Centro de Salud',
        organizacion: 'Ayuntamiento + Centro de Salud',
        profesionales: 'Monitor deportivo, Enfermera comunitaria',
        indicador: 'N¬∫ participantes regulares / Sesiones realizadas',
        meta: '2 grupos estables, ‚â•25 participantes',
        recursos: 'Monitor, material identificativo, seguro RC',
        frecuencia: '3 d√≠as/semana',
        evidencia: 'OMS Actividad f√≠sica mayores',
        orden: 202
    },
    {
        id: 12, entorno: 'comunitario', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Talleres de alimentaci√≥n saludable y cocina mediterr√°nea',
        codigoEPVSA: 'P01-A04', programa: 'RELAS - Red de acci√≥n local en salud',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Incrementar consumo alimentos saludables',
        descripcion: 'Talleres pr√°cticos de cocina saludable con productos locales, basados en la dieta mediterr√°nea.',
        poblacion: 'Poblaci√≥n general, familias',
        etapaVida: 'Adultos y familias',
        responsable: 'Concejal√≠a de Bienestar Social',
        organizacion: 'Ayuntamiento',
        profesionales: 'Dietista-nutricionista, Chef local',
        indicador: 'N¬∫ participantes / Satisfacci√≥n',
        meta: '6 talleres, ‚â•120 participantes totales',
        recursos: 'Cocina comunitaria, ingredientes, recetario',
        frecuencia: 'Bimestral',
        evidencia: 'Estudio PREDIMED, dieta mediterr√°nea UNESCO',
        orden: 203
    },
    {
        id: 13, entorno: 'comunitario', anio: '2026', trimestre: 'T3', prioridad: 'media',
        nombre: 'Huertos urbanos comunitarios',
        codigoEPVSA: 'P01-A05', programa: 'RELAS - Red de acci√≥n local en salud',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Incrementar consumo alimentos saludables',
        descripcion: 'Creaci√≥n y dinamizaci√≥n de espacios de cultivo comunitario que fomenten alimentaci√≥n saludable y relaciones sociales.',
        poblacion: 'Poblaci√≥n general, especialmente mayores',
        etapaVida: 'Adultos y mayores',
        responsable: 'Concejal√≠a de Medio Ambiente',
        organizacion: 'Ayuntamiento',
        profesionales: 'T√©cnico medio ambiente, Agente desarrollo',
        indicador: 'N¬∫ parcelas / N¬∫ usuarios',
        meta: '20 parcelas, ‚â•40 usuarios',
        recursos: 'Terreno municipal, agua, herramientas, semillas',
        frecuencia: 'Continuo (temporada agr√≠cola)',
        evidencia: 'FAO Urban Agriculture',
        orden: 204
    },
    {
        id: 14, entorno: 'comunitario', anio: '2026', trimestre: 'T2', prioridad: 'alta',
        nombre: 'Campa√±a "Espacios sin humo" en zonas infantiles',
        codigoEPVSA: 'P01-A06', programa: 'RELAS - Red de acci√≥n local en salud',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.3 - Disminuir consumo tabaco y exposici√≥n humo',
        descripcion: 'Se√±alizaci√≥n y promoci√≥n de parques infantiles y zonas deportivas como espacios libres de humo de tabaco.',
        poblacion: 'Familias con menores',
        etapaVida: 'Infancia y familias',
        responsable: 'Concejal√≠a de Salud',
        organizacion: 'Ayuntamiento',
        profesionales: 'T√©cnico salud, Polic√≠a local',
        indicador: 'N¬∫ espacios se√±alizados / Cumplimiento',
        meta: '100% parques infantiles se√±alizados',
        recursos: 'Se√±al√©tica, campa√±a comunicaci√≥n',
        frecuencia: 'Implementaci√≥n T2, mantenimiento continuo',
        evidencia: 'Ley 28/2005 antitabaco',
        orden: 205
    },
    {
        id: 15, entorno: 'comunitario', anio: '2026', trimestre: 'T4', prioridad: 'media',
        nombre: 'Semana de la salud mental Comunitaria',
        codigoEPVSA: 'P01-A07', programa: 'RELAS - Red de acci√≥n local en salud',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Bienestar emocional',
        descripcion: 'Programaci√≥n de actividades de sensibilizaci√≥n y promoci√≥n de la salud mental coincidiendo con el D√≠a Mundial (10 octubre).',
        poblacion: 'Poblaci√≥n general',
        etapaVida: 'Todas las edades',
        responsable: 'Mesa Local de Salud',
        organizacion: 'Ayuntamiento + Asociaciones + Centro de Salud',
        profesionales: 'Equipo multisectorial',
        indicador: 'N¬∫ actividades / Participantes',
        meta: '‚â•10 actividades, ‚â•300 participantes',
        recursos: 'Espacios municipales, material divulgativo',
        frecuencia: 'Anual (octubre)',
        evidencia: 'OMS D√≠a Mundial salud mental',
        orden: 206
    },
    {
        id: 16, entorno: 'comunitario', anio: '2026', trimestre: 'T3', prioridad: 'media',
        nombre: 'Programa de ocio saludable juvenil sin alcohol',
        codigoEPVSA: 'P01-A08', programa: 'RELAS - Red de acci√≥n local en salud',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.4 - Disminuir consumo bebidas alcoh√≥licas',
        descripcion: 'Oferta de actividades de ocio nocturno y fin de semana para j√≥venes sin presencia de alcohol.',
        poblacion: 'J√≥venes 14-25 a√±os',
        etapaVida: 'Adolescencia y juventud',
        responsable: 'Concejal√≠a de Juventud',
        organizacion: 'Ayuntamiento',
        profesionales: 'T√©cnico juventud, Educadores sociales',
        indicador: 'N¬∫ actividades / Participantes j√≥venes',
        meta: '12 actividades/a√±o, ‚â•50 j√≥venes diferentes',
        recursos: 'Espacios juveniles, material actividades',
        frecuencia: 'Mensual (viernes/s√°bados)',
        evidencia: 'Plan nacional Drogas',
        orden: 207
    },
    {
        id: 17, entorno: 'comunitario', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Grupo de apoyo a la lactancia materna',
        codigoEPVSA: 'P01-A09', programa: 'RELAS - Red de acci√≥n local en salud',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Incrementar niveles lactancia materna',
        descripcion: 'Grupo de apoyo madre a madre facilitado por profesional sanitario para promoci√≥n y mantenimiento de la lactancia.',
        poblacion: 'Madres lactantes y embarazadas',
        etapaVida: 'Primera infancia (0-2 a√±os)',
        responsable: 'Matrona Centro de Salud',
        organizacion: 'Centro de Salud + Asociaci√≥n madres',
        profesionales: 'Matrona, Madres voluntarias formadas',
        indicador: 'N¬∫ madres atendidas / Duraci√≥n lactancia',
        meta: '‚â•30 madres/a√±o, ‚â•50% lactancia 6 meses',
        recursos: 'Sala reuniones, material apoyo lactancia',
        frecuencia: 'Semanal',
        evidencia: 'OMS/UNICEF IHAN',
        orden: 208
    },
    
    // ========== ENTORNO EDUCATIVO ==========
    {
        id: 18, entorno: 'educativo', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Programa Creciendo en Salud: Alimentaci√≥n',
        codigoEPVSA: 'P06-A01', programa: 'Promoci√≥n en centros educativos',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Incrementar consumo alimentos saludables',
        descripcion: 'Desarrollo del m√≥dulo de alimentaci√≥n saludable del programa Creciendo en Salud en todos los centros educativos.',
        poblacion: 'Alumnado de infantil, primaria y secundaria',
        etapaVida: 'Infancia y adolescencia (3-16 a√±os)',
        responsable: 'Coordinador/a Creciendo en Salud',
        organizacion: 'CEIP y IES',
        profesionales: 'Profesorado, Enfermera escolar referente',
        indicador: 'N¬∫ centros participantes / Alumnado alcanzado',
        meta: '100% centros, ‚â•1.500 alumnos',
        recursos: 'Material did√°ctico programa, formaci√≥n profesorado',
        frecuencia: 'Curso escolar completo',
        evidencia: 'Programa Creciendo en Salud Junta Andaluc√≠a',
        orden: 300
    },
    {
        id: 19, entorno: 'educativo', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Desayunos y almuerzos saludables en centros escolares',
        codigoEPVSA: 'P06-A02', programa: 'Promoci√≥n en centros educativos',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Incrementar consumo alimentos saludables',
        descripcion: 'Promoci√≥n del desayuno saludable y regulaci√≥n de almuerzos escolares con frutas y alimentos no procesados.',
        poblacion: 'Alumnado de infantil y primaria',
        etapaVida: 'Infancia (3-12 a√±os)',
        responsable: 'Equipos directivos centros',
        organizacion: 'CEIP',
        profesionales: 'Profesorado, AMPA, Monitores comedor',
        indicador: '% alumnado con almuerzo saludable',
        meta: '‚â•70% alumnado con almuerzo saludable',
        recursos: 'Gu√≠a almuerzos, comunicaci√≥n familias',
        frecuencia: 'Curso escolar completo',
        evidencia: 'Estrategia NAOS, Documento consenso desayuno',
        orden: 301
    },
    {
        id: 20, entorno: 'educativo', anio: '2026', trimestre: 'T2', prioridad: 'media',
        nombre: 'Huerto escolar educativo',
        codigoEPVSA: 'P06-A03', programa: 'Promoci√≥n en centros educativos',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Incrementar consumo alimentos saludables',
        descripcion: 'Creaci√≥n y mantenimiento de huertos escolares como recurso educativo transversal.',
        poblacion: 'Alumnado de infantil y primaria',
        etapaVida: 'Infancia (3-12 a√±os)',
        responsable: 'Coordinador/a medioambiental centro',
        organizacion: 'CEIP',
        profesionales: 'Profesorado, Familias voluntarias',
        indicador: 'N¬∫ centros con huerto activo / Alumnado participante',
        meta: '‚â•2 centros con huerto',
        recursos: 'Espacio, herramientas, semillas, agua',
        frecuencia: 'Curso escolar (temporada cultivo)',
        evidencia: 'Red Huertos Escolares Andaluc√≠a',
        orden: 302
    },
    {
        id: 21, entorno: 'educativo', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Programa Creciendo en Salud: actividad f√≠sica',
        codigoEPVSA: 'P06-A04', programa: 'Promoci√≥n en centros educativos',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.2 - Aumentar niveles de actividad f√≠sica',
        descripcion: 'Desarrollo del m√≥dulo de actividad f√≠sica del programa, incluyendo recreos activos y desplazamiento activo al centro.',
        poblacion: 'Alumnado de todos los niveles',
        etapaVida: 'Infancia y adolescencia (3-16 a√±os)',
        responsable: 'Profesorado Educaci√≥n F√≠sica',
        organizacion: 'Centros educativos',
        profesionales: 'Profesorado EF, Tutores/as',
        indicador: 'Minutos actividad f√≠sica/d√≠a / % desplazamiento activo',
        meta: '‚â•60 min AF/d√≠a, ‚â•30% desplazamiento activo',
        recursos: 'Material deportivo, se√±alizaci√≥n caminos escolares',
        frecuencia: 'Curso escolar completo',
        evidencia: 'OMS Actividad f√≠sica menores',
        orden: 303
    },
    {
        id: 22, entorno: 'educativo', anio: '2026', trimestre: 'T2', prioridad: 'media',
        nombre: 'Recreos activos e inclusivos',
        codigoEPVSA: 'P06-A05', programa: 'Promoci√≥n en centros educativos',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.2 - Aumentar niveles de actividad f√≠sica',
        descripcion: 'Organizaci√≥n de los recreos con actividades f√≠sicas dirigidas y juegos cooperativos.',
        poblacion: 'Alumnado de infantil y primaria',
        etapaVida: 'Infancia (3-12 a√±os)',
        responsable: 'Profesorado de guardia recreo',
        organizacion: 'CEIP',
        profesionales: 'Profesorado, Alumnado mediador',
        indicador: '% alumnado activo en recreo',
        meta: '‚â•80% alumnado activo',
        recursos: 'Material juegos, formaci√≥n dinamizadores',
        frecuencia: 'Diario (recreos)',
        evidencia: 'Programa Recreos Residuo Cero',
        orden: 304
    },
    {
        id: 23, entorno: 'educativo', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Programa Forma Joven: Sexualidad y relaciones',
        codigoEPVSA: 'P06-A06', programa: 'Promoci√≥n en centros educativos',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.5 - Promover salud sexual y reproductiva',
        descripcion: 'Intervenci√≥n en IES sobre educaci√≥n afectivo-sexual, prevenci√≥n ITS y relaciones igualitarias.',
        poblacion: 'Alumnado de ESO y Bachillerato',
        etapaVida: 'Adolescencia (12-18 a√±os)',
        responsable: 'Enfermera referente Forma Joven',
        organizacion: 'IES + Centro de Salud',
        profesionales: 'Enfermera, Orientador/a, Profesorado',
        indicador: 'N¬∫ sesiones / Alumnado alcanzado',
        meta: '100% grupos ESO, ‚â•400 alumnos',
        recursos: 'Material Forma Joven, Asesor√≠a centro',
        frecuencia: 'Curso escolar (sesiones programadas)',
        evidencia: 'Programa Forma Joven Andaluc√≠a',
        orden: 305
    },
    {
        id: 24, entorno: 'educativo', anio: '2026', trimestre: 'T2', prioridad: 'alta',
        nombre: 'Programa Forma Joven: Prevenci√≥n adicciones',
        codigoEPVSA: 'P06-A07', programa: 'Promoci√≥n en centros educativos',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.3/1.4 - Disminuir consumo tabaco y alcohol',
        descripcion: 'Intervenci√≥n preventiva sobre tabaco, alcohol, cannabis y otras sustancias en ESO.',
        poblacion: 'Alumnado de ESO',
        etapaVida: 'Adolescencia (12-16 a√±os)',
        responsable: 'Enfermera referente + Orientaci√≥n',
        organizacion: 'IES + Centro de Salud',
        profesionales: 'Enfermera, Orientador/a, Polic√≠a (Plan director)',
        indicador: 'N¬∫ sesiones / Conocimientos pre-post',
        meta: '100% grupos ESO',
        recursos: 'Material preventivo, testimonios',
        frecuencia: 'Curso escolar',
        evidencia: 'Plan nacional Drogas, Forma Joven',
        orden: 306
    },
    {
        id: 25, entorno: 'educativo', anio: '2026', trimestre: 'T3', prioridad: 'alta',
        nombre: 'Programa de bienestar emocional en el aula',
        codigoEPVSA: 'P06-A08', programa: 'Promoci√≥n en centros educativos',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.1 - Bienestar emocional',
        descripcion: 'Desarrollo de competencias socioemocionales en el alumnado: gesti√≥n emocional, resoluci√≥n conflictos, mindfulness.',
        poblacion: 'Alumnado de todos los niveles',
        etapaVida: 'Infancia y adolescencia',
        responsable: 'Orientador/a + Tutores/as',
        organizacion: 'Centros educativos',
        profesionales: 'Orientadores, Tutores, PT/AL',
        indicador: 'N¬∫ sesiones / Clima escolar (encuesta)',
        meta: '‚â•1 sesi√≥n/semana acci√≥n tutorial',
        recursos: 'Programa DULCINEA, material mindfulness',
        frecuencia: 'Semanal (tutor√≠a)',
        evidencia: 'CASEL, Programa MindUp',
        orden: 307
    },
    {
        id: 26, entorno: 'educativo', anio: '2026', trimestre: 'T2', prioridad: 'media',
        nombre: 'Uso saludable de pantallas y prevenci√≥n adicci√≥n digital',
        codigoEPVSA: 'P06-A09', programa: 'Promoci√≥n en centros educativos',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.6 - Disminuir tiempo pantallas',
        descripcion: 'Intervenci√≥n educativa sobre uso responsable de m√≥viles, redes sociales y videojuegos.',
        poblacion: 'Alumnado de primaria y ESO',
        etapaVida: 'Infancia y adolescencia (8-16 a√±os)',
        responsable: 'Coordinador/a TIC + Orientaci√≥n',
        organizacion: 'Centros educativos',
        profesionales: 'Profesorado, Orientadores, Polic√≠a (Plan director)',
        indicador: 'Horas pantalla/d√≠a (encuesta) / Casos detectados',
        meta: 'Reducir <2h/d√≠a recreativo',
        recursos: 'Material educativo, control parental',
        frecuencia: 'Trimestral',
        evidencia: 'AAP Screen Time Guidelines',
        orden: 308
    },
    
    // ========== ENTORNO LABORAL ==========
    {
        id: 27, entorno: 'laboral', anio: '2026', trimestre: 'T1', prioridad: 'media',
        nombre: 'Programa de empresa saludable - Ayuntamiento',
        codigoEPVSA: 'P13-A01', programa: 'Alianzas operadores econ√≥micos',
        lineaEpvsa: '2', objetivoEPVSA: 'OE 2.1 - Incrementar empresas h√°bitos saludables',
        descripcion: 'Implementaci√≥n de medidas de promoci√≥n de salud en el Ayuntamiento como empleador modelo.',
        poblacion: 'Personal empleado p√∫blico municipal',
        etapaVida: 'Adultos (trabajadores)',
        responsable: 'Concejal√≠a de Personal',
        organizacion: 'Ayuntamiento',
        profesionales: 'RRHH, Prevenci√≥n riesgos laborales, Salud laboral',
        indicador: 'N¬∫ medidas implementadas / Participaci√≥n',
        meta: '‚â•5 medidas, ‚â•50% participaci√≥n',
        recursos: 'Presupuesto salud laboral, instalaciones',
        frecuencia: 'Anual con evaluaci√≥n',
        evidencia: 'Red Europea Promoci√≥n Salud Trabajo',
        orden: 400
    },
    {
        id: 28, entorno: 'laboral', anio: '2026', trimestre: 'T2', prioridad: 'media',
        nombre: 'Pausas activas en el trabajo',
        codigoEPVSA: 'P13-A02', programa: 'Alianzas operadores econ√≥micos',
        lineaEpvsa: '2', objetivoEPVSA: 'OE 2.1 - Incrementar empresas h√°bitos saludables',
        descripcion: 'Implantaci√≥n de pausas activas de 10 minutos con ejercicios de estiramiento y movilidad.',
        poblacion: 'Trabajadores/as con trabajo sedentario',
        etapaVida: 'Adultos (trabajadores)',
        responsable: 'Servicio Prevenci√≥n + RRHH',
        organizacion: 'Ayuntamiento + Empresas adheridas',
        profesionales: 'T√©cnico prevenci√≥n, Fisioterapeuta',
        indicador: 'N¬∫ empresas / Trabajadores participantes',
        meta: '‚â•3 organizaciones, ‚â•100 trabajadores',
        recursos: 'Gu√≠a ejercicios, app recordatorio',
        frecuencia: '2 pausas/d√≠a laboral',
        evidencia: 'INSST Pausas activas',
        orden: 401
    },
    {
        id: 29, entorno: 'laboral', anio: '2026', trimestre: 'T2', prioridad: 'media',
        nombre: 'Promoci√≥n desplazamiento activo al trabajo',
        codigoEPVSA: 'P02-A01', programa: 'Movilidad y transporte',
        lineaEpvsa: '1', objetivoEPVSA: 'OE 1.2 - Aumentar niveles de actividad f√≠sica',
        descripcion: 'Fomento del uso de bicicleta y desplazamiento a pie para ir al trabajo: aparcabicis, vestuarios, incentivos.',
        poblacion: 'Trabajadores/as del municipio',
        etapaVida: 'Adultos (trabajadores)',
        responsable: 'Concejal√≠a de Movilidad',
        organizacion: 'Ayuntamiento',
        profesionales: 'T√©cnico movilidad, Agente desarrollo',
        indicador: '% trabajadores desplazamiento activo',
        meta: '‚â•15% desplazamiento activo',
        recursos: 'Aparcabicis, duchas, carril bici',
        frecuencia: 'Continuo',
        evidencia: 'Plan movilidad sostenible',
        orden: 402
    },
    {
        id: 30, entorno: 'laboral', anio: '2026', trimestre: 'T3', prioridad: 'baja',
        nombre: 'M√°quinas expendedoras saludables',
        codigoEPVSA: 'P13-A03', programa: 'Alianzas operadores econ√≥micos',
        lineaEpvsa: '3', objetivoEPVSA: 'OE 3.1 - Difusi√≥n h√°bitos saludables',
        descripcion: 'Sustituci√≥n progresiva de productos ultraprocesados por opciones saludables en m√°quinas vending.',
        poblacion: 'Trabajadores/as y usuarios servicios p√∫blicos',
        etapaVida: 'Adultos',
        responsable: 'Servicios Generales',
        organizacion: 'Ayuntamiento + Empresas',
        profesionales: 'Responsable contrataci√≥n, Dietista',
        indicador: '% productos saludables en vending',
        meta: '‚â•50% productos saludables',
        recursos: 'Negociaci√≥n proveedores, se√±alizaci√≥n',
        frecuencia: 'Implementaci√≥n T3, mantenimiento continuo',
        evidencia: 'Estrategia NAOS',
        orden: 403
    },
    {
        id: 31, entorno: 'laboral', anio: '2026', trimestre: 'T1', prioridad: 'alta',
        nombre: 'Formaci√≥n en gesti√≥n del estr√©s laboral',
        codigoEPVSA: 'P15-A01', programa: 'Formaci√≥n e investigaci√≥n',
        lineaEpvsa: '4', objetivoEPVSA: 'OE 4.1 - Formaci√≥n promoci√≥n salud',
        descripcion: 'Curso de formaci√≥n para trabajadores/as sobre t√©cnicas de manejo del estr√©s y prevenci√≥n del burnout.',
        poblacion: 'Trabajadores/as, especialmente sanitarios y educativos',
        etapaVida: 'Adultos (trabajadores)',
        responsable: 'Servicio de Formaci√≥n',
        organizacion: 'Ayuntamiento + Centro de Salud + Centros educativos',
        profesionales: 'Psic√≥logo/a, T√©cnico prevenci√≥n',
        indicador: 'N¬∫ participantes / Satisfacci√≥n / Reducci√≥n estr√©s',
        meta: '‚â•60 trabajadores formados',
        recursos: 'Aula formaci√≥n, material did√°ctico',
        frecuencia: '2 ediciones/a√±o',
        evidencia: 'INSST Riesgos psicosociales',
        orden: 404
    },
    {
        id: 32, entorno: 'laboral', anio: '2026', trimestre: 'T4', prioridad: 'media',
        nombre: 'Reconocimiento "Empresa comprometida con la salud"',
        codigoEPVSA: 'P13-A04', programa: 'Alianzas operadores econ√≥micos',
        lineaEpvsa: '2', objetivoEPVSA: 'OE 2.1 - Incrementar empresas h√°bitos saludables',
        descripcion: 'Creaci√≥n de distintivo municipal para empresas que cumplan criterios de promoci√≥n de salud en el trabajo.',
        poblacion: 'Empresas y comercios locales',
        etapaVida: 'Entorno laboral',
        responsable: 'Concejal√≠a de Comercio y Salud',
        organizacion: 'Ayuntamiento',
        profesionales: 'T√©cnico desarrollo local, T√©cnico salud',
        indicador: 'N¬∫ empresas adheridas / Criterios cumplidos',
        meta: '‚â•10 empresas reconocidas',
        recursos: 'Distintivo, checklist criterios, difusi√≥n',
        frecuencia: 'Convocatoria anual',
        evidencia: 'Red Empresa Saludable INSST',
        orden: 405
    }
];

function initAgendas() {
    console.log('üîÑ initAgendas() llamada');
    const municipio = getMunicipioActual();
    console.log('  Municipio:', municipio);
    // Cargar acciones desde Firebase
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/agendas').once('value', snap => {
        console.log('  Firebase respondi√≥, datos:', snap.exists() ? 'S√ç' : 'NO');
        const data = snap.val();
        if (data && Object.keys(data).length > 0) {
            accionesAgenda = Object.values(data);
            accionIdCounter = Math.max(...accionesAgenda.map(a => a.id), 0) + 1;
        } else {
            // Sin datos en Firebase, empezar vac√≠o
            accionesAgenda = [];
            accionIdCounter = 1;
        }
        renderAgendas();
        renderAgendaTipo();
        inicializarFiltrosProgramaTipo();
        
        // *** GUARDAR PARA EL COMPILADOR ***
        guardarAgendaParaCompilador(accionesAgenda);
    });
}

// ========== AGENDA TIPO ==========
function cambiarTipoAgenda(tipo) {
    document.querySelectorAll('.btn-agenda-tipo').forEach(btn => btn.classList.remove('activo'));
    document.getElementById('btn-agenda-' + tipo).classList.add('activo');
    
    if (tipo === 'tipo') {
        document.getElementById('agenda-tipo-contenido').style.display = 'block';
        document.getElementById('agenda-municipio-contenido').style.display = 'none';
    } else {
        document.getElementById('agenda-tipo-contenido').style.display = 'none';
        document.getElementById('agenda-municipio-contenido').style.display = 'block';
    }
}

function inicializarFiltrosProgramaTipo() {
    const select = document.getElementById('filtro-programa-tipo');
    if (!select) return;
    
    select.innerHTML = '<option value="todos">Todos los programas</option>';
    
    getEstructuraActual().forEach(linea => {
        if (linea.programas) {
            linea.programas.forEach(prog => {
                const option = document.createElement('option');
                option.value = prog.codigo;
                option.textContent = prog.codigo + ' - ' + (prog.nombreCorto || prog.nombre);
                select.appendChild(option);
            });
        }
    });
}

function renderAgendaTipo() {
    console.log('üîÑ renderAgendaTipo() llamada');
    const container = document.getElementById('agenda-tipo-listado');
    if (!container) {
        console.error('  ‚ùå Container agenda-tipo-listado NO encontrado');
        return;
    }
    console.log('  ‚úÖ Container encontrado');
    
    const filtroAmbito = document.getElementById('filtro-ambito-tipo')?.value || 'todos';
    const filtroPrograma = document.getElementById('filtro-programa-tipo')?.value || 'todos';
    const filtroLinea = document.getElementById('filtro-linea-tipo')?.value || 'todos';
    
    let html = '';
    
    getEstructuraActual().forEach(linea => {
        // Filtrar por l√≠nea estrat√©gica
        if (filtroLinea !== 'todos' && linea.codigo !== filtroLinea) return;
        
        // Verificar que la l√≠nea tiene programas
        if (!linea.programas || linea.programas.length === 0) return;
        
        let programasHtml = '';
        let programasCount = 0;
        
        linea.programas.forEach(prog => {
            // Filtrar por √°mbito
            if (filtroAmbito !== 'todos' && prog.ambito !== filtroAmbito) return;
            // Filtrar por programa
            if (filtroPrograma !== 'todos' && prog.codigo !== filtroPrograma) return;
            
            programasCount++;
            
            // Obtener objetivos vinculados
            const objetivosVinculados = prog.objetivos ? prog.objetivos.map(oe => 'OE ' + oe).join(', ') : '';
            
            programasHtml += `
                <div class="agenda-tipo-programa" id="agenda-prog-${prog.codigo}">
                    <div class="agenda-tipo-programa-header" onclick="toggleAgendaPrograma('${prog.codigo}')">
                        <span class="agenda-tipo-programa-codigo">${prog.codigo}</span>
                        <span class="agenda-tipo-programa-nombre">${prog.nombreCorto || prog.nombre}</span>
                        <span class="agenda-tipo-programa-ambito">${prog.ambito}</span>
                        <span class="agenda-tipo-programa-count">${prog.actuaciones ? prog.actuaciones.length : 0} actuaciones-tipo</span>
                        <span class="agenda-tipo-toggle">‚ñº</span>
                    </div>
                    <div class="agenda-tipo-programa-content">
                        <div class="agenda-tipo-programa-info">
                            <p><strong>Nombre completo:</strong> ${prog.nombre}</p>
                            <p><strong>Objetivos estrat√©gicos vinculados:</strong> ${objetivosVinculados || 'Todos los de la l√≠nea'}</p>
                        </div>
                        <div class="agenda-tipo-actuaciones-titulo">üìã Actuaciones-Tipo:</div>
                        ${(prog.actuaciones || []).map((act, idx) => `
                            <div class="agenda-tipo-actuacion">
                                <span class="agenda-tipo-actuacion-num">${idx + 1}</span>
                                <span class="agenda-tipo-actuacion-codigo">${act.codigo}</span>
                                <span class="agenda-tipo-actuacion-nombre">${act.nombre}</span>
                                <button class="agenda-tipo-actuacion-btn" onclick="trasladarActuacionAAgenda('${linea.codigo}', '${prog.codigo}', '${act.codigo}')" title="Crear acci√≥n basada en esta actuaci√≥n-tipo">
                                    ‚ûï A√±adir a agenda
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
        
        if (programasCount > 0) {
            html += `
                <div class="agenda-tipo-linea" style="border-left: 4px solid ${linea.color}; margin-bottom: 1.5rem;">
                    <div class="agenda-tipo-linea-header" style="background: ${linea.color}15; border-bottom: 2px solid ${linea.color};">
                        <span class="agenda-tipo-linea-codigo" style="background: ${linea.color};">${linea.codigo}</span>
                        <span class="agenda-tipo-linea-nombre">${linea.nombreCorto || linea.nombre}</span>
                        <span class="agenda-tipo-linea-count">${programasCount} programas</span>
                    </div>
                    <div class="agenda-tipo-linea-objetivos">
                        <strong>Objetivos estrat√©gicos:</strong>
                        ${linea.objetivos.map(obj => `<span class="objetivo-badge" style="background: ${linea.color}20; color: ${linea.color}; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.25rem;">${obj.codigo}</span>`).join(' ')}
                    </div>
                    <div class="agenda-tipo-programas">
                        ${programasHtml}
                    </div>
                </div>
            `;
        }
    });
    
    container.innerHTML = html || '<p style="text-align: center; color: #64748b; padding: 2rem;">No hay elementos que coincidan con los filtros seleccionados.</p>';
}

function toggleAgendaPrograma(codigo) {
    const prog = document.getElementById('agenda-prog-' + codigo);
    if (prog) prog.classList.toggle('abierto');
}

function filtrarAgendaTipo() {
    renderAgendaTipo();
}

// Traslada informaci√≥n de una actuaci√≥n-tipo al formulario de nueva acci√≥n
function trasladarActuacionAAgenda(lineaCodigo, programaCodigo, actuacionCodigo) {
    // Buscar los datos en la estructura EPVSA
    const linea = getEstructuraActual().find(l => l.codigo === lineaCodigo);
    if (!linea || !linea.programas) return;
    
    const programa = linea.programas.find(p => p.codigo === programaCodigo);
    if (!programa || !programa.actuaciones) return;
    
    const actuacion = programa.actuaciones.find(a => a.codigo === actuacionCodigo);
    if (!actuacion) return;
    
    // Abrir el modal
    document.getElementById('modal-titulo').textContent = '‚ûï Nueva acci√≥n Local';
    document.getElementById('accion-id').value = '';
    
    // Pre-rellenar nombre de la acci√≥n con el nombre de la actuaci√≥n-tipo
    document.getElementById('accion-nombre').value = actuacion.nombre;
    
    // Pre-rellenar c√≥digo EPVSA
    const codigoEpvsaInput = document.getElementById('accion-codigo-epvsa');
    if (codigoEpvsaInput) codigoEpvsaInput.value = actuacionCodigo;
    
    // Pre-rellenar programa
    const programaInput = document.getElementById('accion-programa');
    if (programaInput) programaInput.value = programa.nombreCorto || programa.nombre;
    
    // Determinar entorno seg√∫n √°mbito del programa
    const ambitoToEntorno = {
        'Comunitario': 'comunitario',
        'Sanitario': 'sanitario',
        'Educativo': 'educativo',
        'Laboral': 'laboral',
        'Servicios sociales': 'comunitario',
        'Empresarial': 'laboral',
        'Informaci√≥n y comunicaci√≥n': 'comunitario',
        'Formaci√≥n e investigaci√≥n': 'sanitario'
    };
    document.getElementById('accion-entorno').value = ambitoToEntorno[programa.ambito] || 'comunitario';
    
    // Limpiar otros campos para que el usuario los complete
    const descripcionEl = document.getElementById('accion-descripcion');
    if (descripcionEl) descripcionEl.value = '';
    
    document.getElementById('accion-anio').value = '2026';
    
    const trimestreEl = document.getElementById('accion-trimestre');
    if (trimestreEl) trimestreEl.value = 'T1';
    
    const poblacionEl = document.getElementById('accion-poblacion');
    if (poblacionEl) poblacionEl.value = '';
    
    // Mostrar modal
    document.getElementById('modal-accion').style.display = 'flex';
    
    // Cambiar a la vista de agenda del municipio despu√©s de guardar
    // (esto se har√° autom√°ticamente cuando el usuario guarde la acci√≥n)
}

function renderAgendas() {
    const filtroAnio = document.getElementById('filtro-anio')?.value || 'todos';
    const filtroEntorno = document.getElementById('filtro-entorno')?.value || 'todos';
    
    // Filtrar acciones
    let accionesFiltradas = accionesAgenda.filter(a => {
        if (filtroAnio !== 'todos' && a.anio !== filtroAnio) return false;
        if (filtroEntorno !== 'todos' && a.entorno !== filtroEntorno) return false;
        return true;
    });
    
    // Limpiar columnas kanban
    ['sanitario', 'comunitario', 'educativo', 'laboral'].forEach(entorno => {
        const container = document.getElementById('kanban-' + entorno);
        if (container) container.innerHTML = '';
    });
    
    // Contadores por entorno
    const contadores = { sanitario: 0, comunitario: 0, educativo: 0, laboral: 0 };
    
    // Ordenar por orden personalizado o por fecha
    accionesFiltradas.sort((a, b) => (a.orden || 0) - (b.orden || 0));
    
    // Renderizar tarjetas
    accionesFiltradas.forEach(accion => {
        const container = document.getElementById('kanban-' + accion.entorno);
        if (!container) return;
        
        contadores[accion.entorno]++;
        container.appendChild(crearTarjetaAccion(accion));
    });
    
    // Actualizar contadores
    Object.keys(contadores).forEach(entorno => {
        const countEl = document.getElementById('count-' + entorno);
        if (countEl) countEl.textContent = contadores[entorno];
    });
    
    // Mostrar empty states
    ['sanitario', 'comunitario', 'educativo', 'laboral'].forEach(entorno => {
        const container = document.getElementById('kanban-' + entorno);
        if (container && container.children.length === 0) {
            container.innerHTML = `
                <div class="kanban-empty">
                    <div class="kanban-empty-icon">üì≠</div>
                    <div class="kanban-empty-text">Sin acciones<br>Arrastra aqu√≠ o crea una nueva</div>
                </div>`;
        }
    });
    
    // Actualizar stats
    document.getElementById('stat-total-acciones').textContent = accionesFiltradas.length + ' acciones';
    
    // Renderizar timeline
    renderTimeline(accionesFiltradas);
}

function crearTarjetaAccion(accion) {
    const card = document.createElement('div');
    card.className = 'accion-card prioridad-' + (accion.prioridad || 'media');
    card.draggable = true;
    card.dataset.id = accion.id;
    
    card.ondragstart = (e) => {
        e.dataTransfer.setData('text/plain', accion.id);
        card.classList.add('dragging');
    };
    card.ondragend = () => card.classList.remove('dragging');
    
    // Determinar icono de etapa de vida
    const iconoEtapa = {
        'Primera infancia': 'üë∂',
        'Infancia': 'üßí',
        'Adolescencia': 'üßë',
        'Juventud': 'üë©‚Äçüéì',
        'Adultos': 'üë®‚Äçüíº',
        'Mayores': 'üë¥',
        'Todas': 'üë•'
    };
    let etapaIcon = 'üë•';
    if (accion.etapaVida) {
        Object.keys(iconoEtapa).forEach(key => {
            if (accion.etapaVida.toLowerCase().includes(key.toLowerCase())) {
                etapaIcon = iconoEtapa[key];
            }
        });
    }
    
    const lineaColores = { '1': '#0074c8', '2': '#10b981', '3': '#f59e0b', '4': '#dc143c' };
    const lineaColor = lineaColores[accion.lineaEpvsa] || '#6b7280';
    
    card.innerHTML = `
        <div class="accion-card-header">
            <div class="accion-nombre">${accion.nombre}</div>
            <div class="accion-menu">
                <button class="accion-menu-btn" onclick="toggleMenuAccion(event, ${accion.id})">‚ãÆ</button>
                <div class="accion-menu-dropdown" id="menu-${accion.id}">
                    <div class="accion-menu-item" onclick="verDetalleAccion(${accion.id})">üëÅÔ∏è Ver detalle</div>
                    <div class="accion-menu-item" onclick="editarAccion(${accion.id})">‚úèÔ∏è Editar</div>
                    <div class="accion-menu-item" onclick="duplicarAccion(${accion.id})">üìã Duplicar</div>
                    <div class="accion-menu-item eliminar" onclick="eliminarAccion(${accion.id})">üóëÔ∏è Eliminar</div>
                </div>
            </div>
        </div>
        
        <div class="accion-badges">
            ${accion.codigoEPVSA ? `<span class="badge-epvsa">${accion.codigoEPVSA}</span>` : ''}
            ${accion.lineaEpvsa ? `<span class="badge-linea" style="background:${lineaColor}">L${accion.lineaEpvsa}</span>` : ''}
            <span class="badge-anio">${accion.anio}</span>
            <span class="badge-trimestre">${accion.trimestre || 'Anual'}</span>
        </div>
        
        ${accion.programa ? `<div class="accion-programa-ref">üìÇ ${accion.programa}</div>` : ''}
        
        ${accion.descripcion ? `<div class="accion-descripcion">${accion.descripcion}</div>` : ''}
        
        <div class="accion-info-grid">
            ${accion.etapaVida ? `<div class="info-item"><span class="info-icon">${etapaIcon}</span><span class="info-text">${accion.etapaVida}</span></div>` : ''}
            ${accion.poblacion ? `<div class="info-item"><span class="info-icon">üéØ</span><span class="info-text">${accion.poblacion}</span></div>` : ''}
        </div>
        
        <div class="accion-footer">
            <div class="accion-responsable">
                ${accion.responsable ? `<span class="resp-icon">üë§</span><span>${accion.responsable}</span>` : ''}
            </div>
            ${accion.organizacion ? `<div class="accion-org" title="${accion.organizacion}">üè¢ ${accion.organizacion.substring(0, 25)}${accion.organizacion.length > 25 ? '...' : ''}</div>` : ''}
        </div>
    `;
    
    // Click para ver detalle
    card.addEventListener('dblclick', () => verDetalleAccion(accion.id));
    
    return card;
}

function verDetalleAccion(id) {
    const accion = accionesAgenda.find(a => a.id === id);
    if (!accion) return;
    
    const lineaColores = { '1': '#0074c8', '2': '#10b981', '3': '#f59e0b', '4': '#dc143c' };
    const lineaNombres = { '1': 'Bienestar emocional y salud mental', '2': 'Responsabilidad social empresarial', '3': 'Alimentaci√≥n saludable', '4': 'Actividad f√≠sica' };
    const entornoIconos = { 'sanitario': 'üè•', 'comunitario': 'üèòÔ∏è', 'educativo': 'üéì', 'laboral': 'üè¢' };
    const entornoNombres = { 'sanitario': 'entorno sanitario', 'comunitario': 'entorno comunitario', 'educativo': 'entorno educativo', 'laboral': 'entorno laboral' };
    const prioridadColores = { 'alta': '#dc143c', 'media': '#f59e0b', 'baja': '#94d40b' };
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'modal-detalle-accion';
    modal.innerHTML = `
        <div class="modal-detalle">
            <div class="modal-detalle-header" style="background: linear-gradient(135deg, ${lineaColores[accion.lineaEpvsa] || '#0074c8'} 0%, ${lineaColores[accion.lineaEpvsa] || '#0074c8'}99 100%);">
                <div class="modal-detalle-badges">
                    <span class="badge-entorno">${entornoIconos[accion.entorno]} ${entornoNombres[accion.entorno]}</span>
                    ${accion.codigoEPVSA ? `<span class="badge-codigo">${accion.codigoEPVSA}</span>` : ''}
                    <span class="badge-prioridad" style="background:${prioridadColores[accion.prioridad]}">‚óè ${accion.prioridad?.toUpperCase() || 'MEDIA'}</span>
                </div>
                <h2>${accion.nombre}</h2>
                <button class="modal-cerrar-detalle" onclick="document.getElementById('modal-detalle-accion').remove()">‚úï</button>
            </div>
            
            <div class="modal-detalle-body">
                <div class="detalle-seccion">
                    <h4>üìã Informaci√≥n General</h4>
                    <div class="detalle-grid">
                        <div class="detalle-item">
                            <span class="detalle-label">Programa EPVSA</span>
                            <span class="detalle-value">${accion.programa || '‚Äî'}</span>
                        </div>
                        <div class="detalle-item">
                            <span class="detalle-label">L√≠nea estrat√©gica</span>
                            <span class="detalle-value">${accion.lineaEpvsa ? `L${accion.lineaEpvsa}: ${lineaNombres[accion.lineaEpvsa]}` : '‚Äî'}</span>
                        </div>
                        <div class="detalle-item">
                            <span class="detalle-label">Objetivo EPVSA</span>
                            <span class="detalle-value">${accion.objetivoEPVSA || '‚Äî'}</span>
                        </div>
                        <div class="detalle-item">
                            <span class="detalle-label">A√±o / Trimestre</span>
                            <span class="detalle-value">${accion.anio} / ${accion.trimestre || 'Todo el a√±o'}</span>
                        </div>
                    </div>
                </div>
                
                ${accion.descripcion ? `
                <div class="detalle-seccion">
                    <h4>üìù Descripci√≥n</h4>
                    <p class="detalle-descripcion">${accion.descripcion}</p>
                </div>
                ` : ''}
                
                <div class="detalle-seccion">
                    <h4>üéØ Poblaci√≥n y Etapa de Vida</h4>
                    <div class="detalle-grid">
                        <div class="detalle-item">
                            <span class="detalle-label">Poblaci√≥n diana</span>
                            <span class="detalle-value">${accion.poblacion || '‚Äî'}</span>
                        </div>
                        <div class="detalle-item">
                            <span class="detalle-label">Etapa de vida</span>
                            <span class="detalle-value">${accion.etapaVida || '‚Äî'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detalle-seccion">
                    <h4>üë• Responsables y Organizaci√≥n</h4>
                    <div class="detalle-grid">
                        <div class="detalle-item">
                            <span class="detalle-label">Responsable</span>
                            <span class="detalle-value">${accion.responsable || '‚Äî'}</span>
                        </div>
                        <div class="detalle-item">
                            <span class="detalle-label">Organizaci√≥n</span>
                            <span class="detalle-value">${accion.organizacion || '‚Äî'}</span>
                        </div>
                        <div class="detalle-item full-width">
                            <span class="detalle-label">Profesionales implicados</span>
                            <span class="detalle-value">${accion.profesionales || '‚Äî'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detalle-seccion">
                    <h4>üìä Seguimiento y Evaluaci√≥n</h4>
                    <div class="detalle-grid">
                        <div class="detalle-item">
                            <span class="detalle-label">Indicador</span>
                            <span class="detalle-value">${accion.indicador || '‚Äî'}</span>
                        </div>
                        <div class="detalle-item">
                            <span class="detalle-label">Meta</span>
                            <span class="detalle-value">${accion.meta || '‚Äî'}</span>
                        </div>
                        <div class="detalle-item">
                            <span class="detalle-label">Frecuencia</span>
                            <span class="detalle-value">${accion.frecuencia || '‚Äî'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detalle-seccion">
                    <h4>üîß Recursos y Evidencia</h4>
                    <div class="detalle-grid">
                        <div class="detalle-item full-width">
                            <span class="detalle-label">Recursos necesarios</span>
                            <span class="detalle-value">${accion.recursos || '‚Äî'}</span>
                        </div>
                        <div class="detalle-item full-width">
                            <span class="detalle-label">Base de evidencia</span>
                            <span class="detalle-value">${accion.evidencia || '‚Äî'}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-detalle-footer">
                <button class="btn-editar-detalle" onclick="document.getElementById('modal-detalle-accion').remove(); editarAccion(${accion.id});">‚úèÔ∏è Editar</button>
                <button class="btn-cerrar-detalle" onclick="document.getElementById('modal-detalle-accion').remove()">Cerrar</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
}

function toggleMenuAccion(event, id) {
    event.stopPropagation();
    // Cerrar otros men√∫s
    document.querySelectorAll('.accion-menu-dropdown.visible').forEach(m => m.classList.remove('visible'));
    const menu = document.getElementById('menu-' + id);
    menu.classList.toggle('visible');
}

// Cerrar men√∫s al hacer clic fuera
document.addEventListener('click', () => {
    document.querySelectorAll('.accion-menu-dropdown.visible').forEach(m => m.classList.remove('visible'));
});

function mostrarModalNuevaAccion() {
    document.getElementById('modal-titulo').textContent = '‚ûï Nueva acci√≥n';
    document.getElementById('accion-id').value = '';
    document.getElementById('accion-nombre').value = '';
    document.getElementById('accion-codigo-epvsa').value = '';
    document.getElementById('accion-programa').value = '';
    document.getElementById('accion-entorno').value = 'sanitario';
    document.getElementById('accion-anio').value = '2026';
    document.getElementById('accion-trimestre').value = 'T1';
    document.getElementById('accion-descripcion').value = '';
    document.getElementById('accion-linea-epvsa').value = '';
    document.getElementById('accion-objetivo-epvsa').value = '';
    document.getElementById('accion-poblacion').value = '';
    document.getElementById('accion-etapa-vida').value = '';
    document.getElementById('accion-responsable').value = '';
    document.getElementById('accion-organizacion').value = '';
    document.getElementById('accion-profesionales').value = '';
    document.getElementById('accion-indicador').value = '';
    document.getElementById('accion-meta').value = '';
    document.getElementById('accion-frecuencia').value = '';
    document.getElementById('accion-prioridad').value = 'media';
    document.getElementById('accion-recursos').value = '';
    document.getElementById('accion-evidencia').value = '';
    document.getElementById('modal-accion').style.display = 'flex';
}

function cerrarModalAccion() {
    document.getElementById('modal-accion').style.display = 'none';
}

function guardarAccion() {
    const nombre = document.getElementById('accion-nombre').value.trim();
    if (!nombre) {
        alert('El nombre de la acci√≥n es obligatorio');
        return;
    }
    
    const idExistente = document.getElementById('accion-id').value;
    const accionExistente = idExistente ? accionesAgenda.find(a => a.id == idExistente) : null;
    
    const accion = {
        id: idExistente ? parseInt(idExistente) : accionIdCounter++,
        nombre: nombre,
        codigoEPVSA: document.getElementById('accion-codigo-epvsa').value.trim(),
        programa: document.getElementById('accion-programa').value.trim(),
        entorno: document.getElementById('accion-entorno').value,
        anio: document.getElementById('accion-anio').value,
        trimestre: document.getElementById('accion-trimestre').value,
        descripcion: document.getElementById('accion-descripcion').value.trim(),
        lineaEpvsa: document.getElementById('accion-linea-epvsa').value,
        objetivoEPVSA: document.getElementById('accion-objetivo-epvsa').value.trim(),
        poblacion: document.getElementById('accion-poblacion').value.trim(),
        etapaVida: document.getElementById('accion-etapa-vida').value.trim(),
        responsable: document.getElementById('accion-responsable').value.trim(),
        organizacion: document.getElementById('accion-organizacion').value.trim(),
        profesionales: document.getElementById('accion-profesionales').value.trim(),
        indicador: document.getElementById('accion-indicador').value.trim(),
        meta: document.getElementById('accion-meta').value.trim(),
        frecuencia: document.getElementById('accion-frecuencia').value.trim(),
        prioridad: document.getElementById('accion-prioridad').value,
        recursos: document.getElementById('accion-recursos').value.trim(),
        evidencia: document.getElementById('accion-evidencia').value.trim(),
        orden: accionExistente?.orden || Date.now()
    };
    
    if (idExistente) {
        const idx = accionesAgenda.findIndex(a => a.id == idExistente);
        if (idx !== -1) accionesAgenda[idx] = accion;
    } else {
        accionesAgenda.push(accion);
    }
    
    guardarAgendasFirebase();
    cerrarModalAccion();
    renderAgendas();
    
    // Cambiar a la vista de agenda del municipio
    cambiarTipoAgenda('municipio');
}

function editarAccion(id) {
    const accion = accionesAgenda.find(a => a.id === id);
    if (!accion) return;
    
    document.getElementById('modal-titulo').textContent = '‚úèÔ∏è Editar acci√≥n';
    document.getElementById('accion-id').value = accion.id;
    document.getElementById('accion-nombre').value = accion.nombre || '';
    document.getElementById('accion-codigo-epvsa').value = accion.codigoEPVSA || '';
    document.getElementById('accion-programa').value = accion.programa || '';
    document.getElementById('accion-entorno').value = accion.entorno || 'sanitario';
    document.getElementById('accion-anio').value = accion.anio || '2026';
    document.getElementById('accion-trimestre').value = accion.trimestre || 'T1';
    document.getElementById('accion-descripcion').value = accion.descripcion || '';
    document.getElementById('accion-linea-epvsa').value = accion.lineaEpvsa || '';
    document.getElementById('accion-objetivo-epvsa').value = accion.objetivoEPVSA || '';
    document.getElementById('accion-poblacion').value = accion.poblacion || '';
    document.getElementById('accion-etapa-vida').value = accion.etapaVida || '';
    document.getElementById('accion-responsable').value = accion.responsable || '';
    document.getElementById('accion-organizacion').value = accion.organizacion || '';
    document.getElementById('accion-profesionales').value = accion.profesionales || '';
    document.getElementById('accion-indicador').value = accion.indicador || '';
    document.getElementById('accion-meta').value = accion.meta || '';
    document.getElementById('accion-frecuencia').value = accion.frecuencia || '';
    document.getElementById('accion-prioridad').value = accion.prioridad || 'media';
    document.getElementById('accion-recursos').value = accion.recursos || '';
    document.getElementById('accion-evidencia').value = accion.evidencia || '';
    document.getElementById('modal-accion').style.display = 'flex';
}

function duplicarAccion(id) {
    const accion = accionesAgenda.find(a => a.id === id);
    if (!accion) return;
    
    const nueva = { ...accion, id: accionIdCounter++, nombre: accion.nombre + ' (copia)', orden: Date.now() };
    accionesAgenda.push(nueva);
    guardarAgendasFirebase();
    renderAgendas();
}

function eliminarAccion(id) {
    if (!confirm('¬øEliminar esta acci√≥n?')) return;
    accionesAgenda = accionesAgenda.filter(a => a.id !== id);
    guardarAgendasFirebase();
    renderAgendas();
}

// Drag & Drop
function allowDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function dropAccion(event, nuevoEntorno) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
    
    const id = parseInt(event.dataTransfer.getData('text/plain'));
    const accion = accionesAgenda.find(a => a.id === id);
    if (!accion) return;
    
    // Cambiar entorno
    accion.entorno = nuevoEntorno;
    
    // Reordenar dentro del entorno
    const accionesEntorno = accionesAgenda.filter(a => a.entorno === nuevoEntorno);
    const dropY = event.clientY;
    
    // Encontrar posici√≥n de inserci√≥n
    const cards = event.currentTarget.querySelectorAll('.accion-card');
    let insertIndex = accionesEntorno.length;
    
    cards.forEach((card, idx) => {
        const rect = card.getBoundingClientRect();
        if (dropY < rect.top + rect.height / 2) {
            insertIndex = Math.min(insertIndex, idx);
        }
    });
    
    // Actualizar √≥rdenes
    accionesEntorno.forEach((a, idx) => {
        a.orden = idx < insertIndex ? idx * 10 : (idx + 1) * 10;
    });
    accion.orden = insertIndex * 10 - 5;
    
    guardarAgendasFirebase();
    renderAgendas();
}

// Quitar clase drag-over si se sale del √°rea
document.querySelectorAll('.kanban-body').forEach(body => {
    body.addEventListener('dragleave', (e) => {
        if (!body.contains(e.relatedTarget)) {
            body.classList.remove('drag-over');
        }
    });
});

function filtrarAgendas() {
    renderAgendas();
}

function guardarAgendasFirebase() {
    const municipio = getMunicipioActual();
    const data = {};
    accionesAgenda.forEach(a => data[a.id] = a);
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/agendas').set(data);
    
    // *** ACTUALIZAR EL COMPILADOR ***
    guardarAgendaParaCompilador(accionesAgenda);
}

function renderTimeline(acciones) {
    const container = document.getElementById('timeline-container');
    if (!container) return;
    
    const anios = ['2026', '2027', '2028', '2029', '2030'];
    const entornos = [
        { id: 'sanitario', nombre: 'üè• Sanitario' },
        { id: 'comunitario', nombre: 'üèòÔ∏è Comunitario' },
        { id: 'educativo', nombre: 'üéì Educativo' },
        { id: 'laboral', nombre: 'üè¢ Laboral' }
    ];
    
    let html = '<div class="timeline-grid">';
    
    // Header
    html += '<div class="timeline-header">Entorno</div>';
    anios.forEach(a => html += `<div class="timeline-header">${a}</div>`);
    
    // Filas por entorno
    entornos.forEach(entorno => {
        html += `<div class="timeline-row-label">${entorno.nombre}</div>`;
        anios.forEach(anio => {
            const accionesCell = acciones.filter(a => a.entorno === entorno.id && a.anio === anio);
            html += '<div class="timeline-cell">';
            accionesCell.forEach(a => {
                html += `<div class="timeline-item ${a.entorno}" onclick="editarAccion(${a.id})" title="${a.nombre}">${a.nombre}</div>`;
            });
            html += '</div>';
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function exportarAgendas() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    let csv = 'ID;Nombre;Entorno;A√±o;Trimestre;Descripci√≥n;Responsable;Poblaci√≥n;L√≠nea EPVSA;Prioridad;Indicador;Recursos\n';
    
    accionesAgenda.forEach(a => {
        csv += `${a.id};"${a.nombre}";${a.entorno};${a.anio};${a.trimestre || ''};"${a.descripcion || ''}";"${a.responsable || ''}";"${a.poblacion || ''}";${a.lineaEpvsa || ''};${a.prioridad || ''};"${a.indicador || ''}";"${a.recursos || ''}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'agendas_' + municipio + '_' + new Date().toISOString().split('T')[0] + '.csv';
    link.click();
}

// Inicializar agendas cuando se accede a la Fase 6
document.querySelectorAll('.fase').forEach(f => {
    f.addEventListener('click', () => {
        if (f.dataset.fase === '6') {
            setTimeout(initAgendas, 100);
        }
    });
});

document.getElementById('municipio').addEventListener('change', function() {
    actualizarMunicipio();
    verificarAccesoFase6(); // Verificar acceso a Fase 6 al cambiar municipio
    // Re-inicializar agendas si estamos en Fase 6
    if (document.querySelector('.fase[data-fase="5"]').classList.contains('activa')) {
        setTimeout(initAgendas, 200);
    }
});

// Cargar municipios disponibles desde Firebase (actualiza el selector din√°micamente)
cargarMunicipiosDisponibles();

// Mostrar mensaje de bienvenida inicial
setTimeout(function() {
    actualizarMunicipio(); // Mostrar√° mensaje de bienvenida si no hay municipio seleccionado
}, 100);

verificarAccesoFase6(); // Verificar acceso a Fase 6 al cargar la p√°gina

// Inicializar Agenda-Tipo inmediatamente (no depende de Firebase para el cat√°logo EPVSA)
setTimeout(function() {
    renderAgendaTipo();
    inicializarFiltrosProgramaTipo();
    console.log('‚úÖ Agenda-Tipo EPVSA inicializada');
}, 300);

// ==========================================
// COMPILADOR DE PLAN LOCAL DE SALUD - FASE 4
// ==========================================

// Funci√≥n para navegar a una fase espec√≠fica
function irAFase(numFase) {
    // Si es fase 6, verificar primero si el plan de acci√≥n est√° completado
    if (numFase === 6 || numFase === '6') {
        if (!planLocalSalud.planAccion.completado) {
            mostrarNotificacion({
                title: 'Fase bloqueada',
                message: 'Para acceder a la Agenda anual (Fase 6) primero debe completar el Plan de acci√≥n en la Fase 3.',
                type: 'warning',
                duration: 5000
            });
            return; // No hacer nada m√°s, ya estamos en fase 3
        }
    }
    
    const faseElement = document.querySelector('.fase[data-fase="' + numFase + '"]');
    if (faseElement) {
        faseElement.click();
    }
}

function previsualizarPLS() {
    const container = document.getElementById('pls-preview-container');
    const content = document.getElementById('pls-preview-content');
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    // Obtener logos base64
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    const logoRelas = typeof LOGO_RELAS_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_RELAS_B64 : '';
    const logoViolencia = typeof LOGO_VIOLENCIA_B64 !== 'undefined' ? 'data:image/gif;base64,' + LOGO_VIOLENCIA_B64 : '';
    const logoRasselh = typeof LOGO_RASSELH_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_RASSELH_B64 : '';
    
    // DOCUMENTO EX NOVO - Estilo Perfil de salud local
    const htmlCompleto = `
        <style>
            :root { --azul:#0074c8; --verde:#94d40b; --cyan:#00acd9; --amarillo:#ffb61b; --naranja:#ff6600; --rojo:#dc143c; }
            .pls-doc { font-family:'Segoe UI', 'Source Sans Pro', sans-serif; color:#2d3748; line-height:1.7; }
            
            /* HEADER INSTITUCIONAL - Representando la alianza */
            .pls-header { 
                text-align: center; 
                padding: 2rem 0; 
                background: linear-gradient(180deg, #fafbfc 0%, #fff 100%);
                border-bottom: 5px solid;
                border-image: linear-gradient(90deg, var(--azul), var(--cyan), var(--verde), var(--amarillo), var(--naranja), var(--rojo)) 1;
                margin: -1.5rem -1.5rem 1.5rem -1.5rem;
            }
            .pls-logos { 
                display: flex; 
                flex-wrap: nowrap; 
                justify-content: space-between; 
                align-items: center; 
                gap: 0.5rem; 
                margin-bottom: 1.5rem;
                padding: 0;
                width: 100%;
            }
            .pls-logos img { 
                height: 75px; 
                width: auto; 
                flex: 1;
                max-width: 20%; 
                object-fit: contain; 
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.08));
            }
            .pls-branding { 
                margin: 1.25rem 0; 
                padding: 1rem 0;
                background: linear-gradient(90deg, transparent, rgba(0,116,200,0.03), transparent);
            }
            .pls-compas { 
                font-size: 2.75rem; 
                font-weight: 700; 
                letter-spacing: 14px; 
                color: #2c3e50; 
                display: block; 
                margin-bottom: 0.5rem; 
                text-transform: uppercase;
            }
            .pls-subtitulo { 
                font-size: 0.85rem; 
                letter-spacing: 6px; 
                color: #64748b; 
                text-transform: uppercase; 
                font-weight: 300;
            }
            .pls-titulo-doc { margin-top: 1.5rem; }
            .pls-titulo-doc h1 { 
                font-size: 1.4rem; 
                color: var(--azul); 
                margin: 0 0 0.5rem 0; 
                font-weight: 600; 
            }
            .pls-titulo-doc .municipio { 
                font-size: 2.25rem; 
                font-weight: 700; 
                color: #1e293b; 
                margin-bottom: 0.4rem;
                letter-spacing: 2px;
            }
            .pls-titulo-doc .periodo { 
                font-size: 1.1rem; 
                color: var(--cyan); 
                letter-spacing: 4px; 
                font-weight: 500;
            }
            
            /* SECCIONES - Estilo acorde√≥n como Perfil */
            .pls-seccion { margin-bottom: 1.5rem; }
            .pls-seccion-header { 
                padding: 0.875rem 1rem; 
                color: white; 
                border-radius: 8px 8px 0 0; 
                display: flex; 
                align-items: center; 
                gap: 0.75rem;
            }
            .pls-seccion-header.perfil { background: linear-gradient(135deg, var(--azul), var(--cyan)); }
            .pls-seccion-header.plan { background: linear-gradient(135deg, var(--verde), #7cb518); }
            .pls-seccion-header.agenda { background: linear-gradient(135deg, var(--naranja), var(--rojo)); }
            .pls-seccion-header .num { 
                width: 28px; height: 28px; 
                background: rgba(255,255,255,0.2); 
                border-radius: 50%; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                font-weight: 700; 
                font-size: 0.85rem; 
            }
            .pls-seccion-header .titulo { font-weight: 600; font-size: 0.95rem; }
            .pls-seccion-body { 
                background: #fff; 
                border: 1px solid #e9ecef; 
                border-top: none; 
                border-radius: 0 0 8px 8px; 
                padding: 1.25rem; 
            }
            
            /* SUBSECCIONES */
            .pls-sub { 
                background: #fff; 
                border-radius: 8px; 
                margin-bottom: 1.25rem; 
                box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
                border: 1px solid #e9ecef; 
                overflow: hidden; 
            }
            .pls-sub-header { 
                background: linear-gradient(135deg, #f8fafc, #f1f5f9); 
                padding: 0.75rem 1rem; 
                border-bottom: 1px solid #e9ecef; 
                display: flex; 
                align-items: center; 
                gap: 0.6rem; 
            }
            .pls-sub-header .icono { font-size: 1.1rem; }
            .pls-sub-header .titulo { font-weight: 600; color: #1e293b; font-size: 0.9rem; }
            .pls-sub-body { padding: 1rem; }
            
            /* DESTACADOS */
            .pls-dest { padding: 0.875rem 1rem; border-radius: 8px; margin: 0.875rem 0; border-left: 4px solid; font-size: 0.85rem; }
            .pls-dest.azul { background: #e0f2fe; border-color: var(--azul); }
            .pls-dest.verde { background: #dcfce7; border-color: var(--verde); }
            .pls-dest.rojo { background: #fee2e2; border-color: var(--rojo); }
            .pls-dest strong { color: inherit; }
            
            /* TEXTOS */
            .pls-doc p { margin-bottom: 0.75rem; text-align: justify; font-size: 0.875rem; }
            .pls-doc h3 { color: var(--azul); margin: 1rem 0 0.5rem; font-size: 0.95rem; }
            .pls-doc h4 { color: #1e293b; margin: 0.875rem 0 0.4rem; font-size: 0.875rem; }
            .pls-doc ul, .pls-doc ol { margin: 0.5rem 0; padding-left: 1.25rem; font-size: 0.875rem; }
            .pls-doc li { margin-bottom: 0.3rem; }
            .pls-doc strong { color: var(--azul); }
            
            /* TABLAS */
            .pls-doc table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; font-size: 0.75rem; }
            .pls-doc table th { 
                background: linear-gradient(135deg, var(--azul), var(--cyan)); 
                color: #fff; 
                padding: 0.4rem 0.3rem; 
                text-align: center; 
                font-size: 0.7rem; 
                font-weight: 600; 
            }
            .pls-doc table td { padding: 0.35rem 0.3rem; border-bottom: 1px solid #e9ecef; font-size: 0.75rem; }
            .pls-doc table tr:nth-child(even) { background: #fafbfc; }
            .pls-doc .tabla-agenda th { background: linear-gradient(135deg, var(--naranja), var(--rojo)); }
            
            /* FOOTER */
            .pls-footer { 
                margin-top: 1.5rem; 
                padding-top: 1rem; 
                border-top: 2px solid #e9ecef; 
                text-align: center; 
                color: #64748b; 
                font-size: 0.75rem; 
            }
            .pls-footer p { text-align: center; margin-bottom: 0.2rem; }
        </style>
        
        <div class="pls-doc">
            <!-- HEADER SIMPLIFICADO -->
            <header class="pls-header">
                <div class="pls-logos">
                    <img src="${logoConsejeria}" alt="Consejer√≠a">
                    <img src="${logoDistrito}" alt="Distrito">
                    <img src="${logoRelas}" alt="RELAS">
                    <img src="${logoViolencia}" alt="Violencia">
                    <img src="${logoRasselh}" alt="RASSELH">
                </div>
                <div class="pls-branding">
                    <span class="pls-compas">COMP√ÅS</span>
                    <span class="pls-subtitulo">Dise√±o ciudadano de la salud</span>
                </div>
                <div class="pls-titulo-doc">
                    <h1>Plan local de salud</h1>
                    <div class="municipio">${nombre}</div>
                    <div class="periodo">2026 ‚Äî 2030</div>
                </div>
            </header>
            
            ${generarContenidoPLSPreview(nombre)}
            
            <footer class="pls-footer">
                <p><strong>Plan local de salud de ${nombre} 2026-2030</strong></p>
                <p>Elaborado en el marco de la EPVSA ¬∑ Distrito sanitario Granada-Metropolitano</p>
                <p>Generado con COMP√ÅS ¬∑ ${new Date().toLocaleDateString('es-ES')}</p>
            </footer>
        </div>
    `;
    
    content.innerHTML = htmlCompleto;
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
}

// Genera el contenido del Plan local de salud para el preview
function generarContenidoPLSPreview(nombre) {
    const acciones = planLocalSalud.agenda.completado ? planLocalSalud.agenda.actuaciones : (accionesAgenda || []);
    const planAccionHTML = planLocalSalud.planAccion.completado ? planLocalSalud.planAccion.html : null;
    
    // Configuraci√≥n del marco
    const config = {
        distrito: 'Distrito sanitario Granada-Metropolitano',
        anioInforme: (datosMunicipioActual && datosMunicipioActual.anioInforme) || new Date().getFullYear(),
        anioEncuesta: (datosMunicipioActual && datosMunicipioActual.anioEncuesta) || (new Date().getFullYear() - 1),
        mesPriorizacion: (datosMunicipioActual && datosMunicipioActual.mesPriorizacion) || 'febrero',
        anioPriorizacion: (datosMunicipioActual && datosMunicipioActual.anioPriorizacion) || new Date().getFullYear(),
        lineasEstrategia: (datosMunicipioActual && datosMunicipioActual.lineasEstrategia) || '1, 3 y 4'
    };
    
    let html = '';
    
    // ========== PARTE 1: PERFIL DE SALUD LOCAL ==========
    html += `
        <section class="pls-seccion">
            <div class="pls-seccion-header perfil">
                <span class="num">1</span>
                <span class="titulo">Perfil de salud local de ${nombre}</span>
            </div>
            <div class="pls-seccion-body">
                
                <!-- Marco estrat√©gico -->
                <div class="pls-sub">
                    <div class="pls-sub-header"><span class="icono">üéØ</span><span class="titulo">Marco estrat√©gico</span></div>
                    <div class="pls-sub-body">
                        <p>Este informe ha sido elaborado por profesionales de la <strong>Unidad de Prevenci√≥n, Promoci√≥n y Vigilancia de la Salud</strong> del <strong>${config.distrito}</strong>, en el marco de la <strong>Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a</strong> (EPVSA).</p>
                        <div class="pls-dest azul">
                            <strong>La Estrategia pretende promover los h√°bitos saludables en toda la poblaci√≥n</strong>, mediante intervenciones en el √°mbito local, en todos los entornos de vida y en todas las pol√≠ticas sobre los determinantes que generan desigualdades en salud.
                        </div>
                        <p>El <strong>Informe sobre la situaci√≥n de salud de ${nombre} (${config.anioInforme})</strong> y la <strong>Encuesta local de salud (${config.anioEncuesta})</strong> han facilitado el paso del diagn√≥stico a la acci√≥n. Seg√∫n lo acordado por el Grupo-Motor en ${config.mesPriorizacion} de ${config.anioPriorizacion}, se adaptar√° el plan a las <strong>l√≠neas ${config.lineasEstrategia}</strong> de la Estrategia.</p>
                    </div>
                </div>
                
                <!-- Informe epidemiol√≥gico -->
                <div class="pls-sub">
                    <div class="pls-sub-header"><span class="icono">üìä</span><span class="titulo">Informe sobre la Situaci√≥n de Salud</span></div>
                    <div class="pls-sub-body">
                        ${(datosMunicipioActual && datosMunicipioActual.informe && datosMunicipioActual.informe.htmlCompleto) 
                            ? datosMunicipioActual.informe.htmlCompleto 
                            : '<div class="pls-dest rojo"><strong>‚ö†Ô∏è Pendiente:</strong> Carga el informe epidemiol√≥gico en Fase 2.</div>'}
                    </div>
                </div>
                
                <!-- Determinantes -->
                <div class="pls-sub">
                    <div class="pls-sub-header"><span class="icono">üìà</span><span class="titulo">Determinantes de la salud</span></div>
                    <div class="pls-sub-body">
                        <div class="pls-dest azul">
                            <strong>üìä Valores estimados mediante reponderaci√≥n Bettersurveys</strong><br>
                            Estimaciones territoriales a partir de la Encuesta Andaluza de Salud 2023 para <strong>${nombre}</strong>.
                        </div>
                        ${typeof generarDeterminantesCompletosPDF === 'function' ? generarDeterminantesCompletosPDF() : '<p>Datos de determinantes pendientes.</p>'}
                    </div>
                </div>
                
                <!-- Conclusiones -->
                <div class="pls-sub">
                    <div class="pls-sub-header"><span class="icono">üí°</span><span class="titulo">Conclusiones y Recomendaciones</span></div>
                    <div class="pls-sub-body">
                        ${(datosMunicipioActual && datosMunicipioActual.conclusiones && typeof generarConclusionesCompletasPDF === 'function')
                            ? generarConclusionesCompletasPDF(datosMunicipioActual.conclusiones, datosMunicipioActual.recomendaciones, nombre)
                            : '<div class="pls-dest rojo"><strong>‚ö†Ô∏è Pendiente:</strong> Carga las conclusiones en Gestionar datos.</div>'}
                    </div>
                </div>
                
                <!-- Priorizaci√≥n -->
                <div class="pls-sub">
                    <div class="pls-sub-header"><span class="icono">üó≥Ô∏è</span><span class="titulo">Priorizaci√≥n</span></div>
                    <div class="pls-sub-body">
                        ${(datosMunicipioActual && datosMunicipioActual.priorizacion && typeof generarPriorizacionCompletaPDF === 'function')
                            ? generarPriorizacionCompletaPDF(datosMunicipioActual.priorizacion, nombre)
                            : '<div class="pls-dest rojo"><strong>‚ö†Ô∏è Pendiente:</strong> Configura la priorizaci√≥n en Gestionar datos.</div>'}
                    </div>
                </div>
                
            </div>
        </section>
    `;
    
    // ========== PARTE 2: PLAN DE ACCI√ìN ==========
    html += `
        <section class="pls-seccion">
            <div class="pls-seccion-header plan">
                <span class="num">2</span>
                <span class="titulo">Plan de acci√≥n 2026-2030</span>
            </div>
            <div class="pls-seccion-body">
                ${planAccionHTML 
                    ? '<div class="pls-sub"><div class="pls-sub-body">' + planAccionHTML + '</div></div>'
                    : '<div class="pls-dest rojo"><strong>‚ö†Ô∏è Pendiente:</strong> Genera el Plan de acci√≥n en la Fase 3.</div>'}
            </div>
        </section>
    `;
    
    // ========== PARTE 3: AGENDA ANUAL ==========
    html += `
        <section class="pls-seccion">
            <div class="pls-seccion-header agenda">
                <span class="num">3</span>
                <span class="titulo">Agenda anual Municipal 2026</span>
            </div>
            <div class="pls-seccion-body">
    `;
    
    if (acciones.length > 0) {
        html += `<p>la Agenda anual 2026 incluye <strong>${acciones.length} actuaciones</strong> distribuidas en los cuatro entornos de intervenci√≥n.</p>`;
        
        // Agrupar por entorno
        const entornos = {
            sanitario: { nombre: 'üè• entorno sanitario', color: 'var(--azul)', items: [] },
            comunitario: { nombre: 'üèòÔ∏è entorno comunitario', color: 'var(--verde)', items: [] },
            educativo: { nombre: 'üéì entorno educativo', color: 'var(--amarillo)', items: [] },
            laboral: { nombre: 'üè¢ entorno laboral', color: 'var(--naranja)', items: [] }
        };
        
        acciones.forEach(a => {
            if (entornos[a.entorno]) entornos[a.entorno].items.push(a);
        });
        
        for (const [key, ent] of Object.entries(entornos)) {
            if (ent.items.length === 0) continue;
            html += `
                <div class="pls-sub">
                    <div class="pls-sub-header"><span class="icono">${ent.nombre.split(' ')[0]}</span><span class="titulo">${ent.nombre} (${ent.items.length})</span></div>
                    <div class="pls-sub-body">
                        <table class="tabla-agenda">
                            <thead><tr><th>C√≥digo</th><th>Actuaci√≥n</th><th>Trim.</th></tr></thead>
                            <tbody>
                                ${ent.items.map(a => `<tr><td>${a.codigoEPVSA || '-'}</td><td>${a.nombre || a.descripcion || '-'}</td><td>${a.trimestre || '-'}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
    } else {
        html += '<div class="pls-dest rojo"><strong>‚ö†Ô∏è Pendiente:</strong> A√±ada actuaciones a la Agenda en la Fase 6.</div>';
    }
    
    html += '</div></section>';
    
    return html;
}

// Maximizar preview a pantalla completa
var previewMaximizado = false;

function maximizarPreviewPLS() {
    const content = document.getElementById('pls-preview-content');
    const container = document.getElementById('pls-preview-container');
    const btnMaximizar = container.querySelector('button[onclick="maximizarPreviewPLS()"]');
    
    if (previewMaximizado) {
        // Restaurar
        content.style.cssText = 'background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-height: 70vh; overflow-y: auto; overflow-x: hidden;';
        container.style.cssText = 'display: block; margin-top: 2rem;';
        btnMaximizar.innerHTML = 'üîç Ampliar';
        previewMaximizado = false;
    } else {
        // Maximizar - modal a pantalla completa
        container.style.cssText = 'display: block; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; background: rgba(0,0,0,0.8); padding: 1rem; margin: 0;';
        content.style.cssText = 'background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 40px rgba(0,0,0,0.4); max-height: calc(100vh - 80px); overflow-y: auto; overflow-x: hidden; margin-top: 0;';
        btnMaximizar.innerHTML = '‚¨áÔ∏è Reducir';
        previewMaximizado = true;
    }
}

// Abrir preview en nueva ventana
function abrirPreviewVentana() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    const html = generarDocumentoCompleto();
    
    const ventana = window.open('', '_blank', 'width=900,height=700');
    ventana.document.write(html);
    ventana.document.close();
}

function cerrarPreviewPLS() {
    const container = document.getElementById('pls-preview-container');
    const content = document.getElementById('pls-preview-content');
    
    // Restaurar estilos si estaba maximizado
    container.style.cssText = 'display: none; margin-top: 2rem;';
    content.style.cssText = 'background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-height: 70vh; overflow-y: auto; overflow-x: hidden;';
    previewMaximizado = false;
    
    // Restaurar texto del bot√≥n
    const btnMaximizar = container.querySelector('button[onclick="maximizarPreviewPLS()"]');
    if (btnMaximizar) btnMaximizar.innerHTML = 'üîç Ampliar';
}

function generarPLS() {
    const html = generarDocumentoCompleto();
    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const win = window.open(url, '_blank');
    if (win) {
        setTimeout(() => {
            win.focus();
            win.print();
        }, 1000);
    }
}

function exportarHTMLPlan() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    const html = generarDocumentoCompleto();
    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Plan_Local_Salud_${nombre.replace(/\s+/g, '_')}_2026-2030.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    mostrarNotificacion({
        title: '‚úÖ HTML descargado',
        message: `Plan local de salud de ${nombre} guardado correctamente`,
        type: 'success',
        duration: 3000
    });
}

// Exportar Plan local de salud completo como PDF
function exportarPDFPlanLocal() {
    const municipio = getMunicipioActual();
    if (!municipio) {
        mostrarNotificacion({
            title: '‚ö†Ô∏è Sin municipio',
            message: 'Seleccione un municipio primero',
            type: 'warning',
            duration: 3000
        });
        return;
    }
    
    const nombre = getNombreMunicipio(municipio);
    
    // Verificar que hay contenido
    const tienePerfil = planLocalSalud.perfil.completado;
    const tienePlan = planLocalSalud.planAccion.completado;
    
    if (!tienePerfil && !tienePlan) {
        mostrarNotificacion({
            title: '‚ö†Ô∏è Sin contenido',
            message: 'Genera al menos el Perfil de salud o el Plan de acci√≥n primero',
            type: 'warning',
            duration: 4000
        });
        return;
    }
    
    // Generar HTML completo optimizado para PDF
    const htmlDocumento = generarDocumentoCompletoPDF(nombre);
    
    // Abrir en nueva ventana para imprimir como PDF
    const ventana = window.open('', '_blank');
    ventana.document.write(htmlDocumento);
    ventana.document.close();
    
    // Esperar a que cargue y lanzar impresi√≥n
    setTimeout(() => {
        ventana.focus();
        ventana.print();
    }, 1500);
    
    mostrarNotificacion({
        title: 'üìë Generando PDF',
        message: 'Seleccione ¬´Guardar como PDF¬ª en el di√°logo de impresi√≥n',
        type: 'info',
        duration: 5000
    });
}

// Genera documento HTML completo optimizado para exportar a PDF
function generarDocumentoCompletoPDF(nombre) {
    const anio = new Date().getFullYear();
    
    // Obtener logos base64
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    const logoRelas = typeof LOGO_RELAS_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_RELAS_B64 : '';
    const logoViolencia = typeof LOGO_VIOLENCIA_B64 !== 'undefined' ? 'data:image/gif;base64,' + LOGO_VIOLENCIA_B64 : '';
    const logoRasselh = typeof LOGO_RASSELH_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_RASSELH_B64 : '';
    
    // Generar contenido del Plan Local (sin portada porque ya est√° en el header institucional)
    const contenidoPlan = generarHTMLPlanLocal(false);
    
    return `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan local de salud de ${nombre} 2026-2030</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap');
        :root { --azul:#0074c8; --verde:#94d40b; --cyan:#00acd9; --amarillo:#ffb61b; --naranja:#ff6600; --rojo:#dc143c; --oscuro:#1a1a2e; --texto:#2d3748; --claro:#64748b; }
        * { margin:0; padding:0; box-sizing:border-box; }
        @page { size:A4 portrait; margin:2cm; }
        @media print { 
            .no-print{display:none;} 
            .page-break{page-break-before:always;}
            body { font-size:10pt; }
        }
        body { font-family:'Source Sans Pro',sans-serif; color:var(--texto); line-height:1.7; background:#fff; font-size:11pt; }
        
        /* HEADER INSTITUCIONAL */
        .header-institucional { 
            text-align: center; 
            padding: 1.5rem 2rem;
            border-bottom: 6px solid;
            border-image: linear-gradient(90deg, #0074c8 0%, #00acd9 20%, #94d40b 40%, #ffb61b 60%, #ff6600 80%, #dc143c 100%) 1;
            margin-bottom: 2rem;
        }
        .header-logos { 
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .header-logos img { 
            height: 70px; 
            width: auto; 
            object-fit: contain;
        }
        .header-branding { margin: 1rem 0; }
        .header-compas { 
            font-size: 2.5rem; 
            font-weight: 700; 
            letter-spacing: 12px; 
            color: #2c3e50; 
        }
        .header-subtitulo { 
            font-size: 0.85rem; 
            letter-spacing: 5px; 
            color: #64748b; 
            text-transform: uppercase; 
            margin-top: 0.3rem;
            font-weight: 300;
        }
        .header-titulo h1 { 
            font-size: 1.4rem; 
            color: #0074c8; 
            margin: 1rem 0 0.3rem 0; 
            font-weight: 600; 
        }
        .header-municipio { 
            font-size: 2rem; 
            font-weight: 700; 
            color: #1e293b; 
            letter-spacing: 1px;
        }
        .header-anio { 
            font-size: 1.1rem; 
            color: #00acd9; 
            letter-spacing: 3px;
            font-weight: 500;
            margin-top: 0.3rem;
        }
        
        /* DOCUMENTO */
        .doc { max-width: 800px; margin: 0 auto; padding: 0 1rem; }
        
        /* Secciones */
        .seccion { 
            margin-bottom: 2rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        
        .sec-header {
            background: linear-gradient(135deg, var(--azul), var(--cyan));
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }
        .sec-header.plan { background: linear-gradient(135deg, var(--verde) 0%, #059669 100%); }
        .sec-header.agenda { background: linear-gradient(135deg, var(--naranja) 0%, var(--rojo) 100%); }
        .sec-header.participacion { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        
        .sec-header h2 {
            font-size: 1.15rem;
            margin: 0;
            font-weight: 600;
        }
        .sec-pre {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 0.2rem;
        }
        .sec-body {
            padding: 1.5rem;
            background: #fff;
        }
        
        /* Subsecciones */
        .sub { margin-bottom: 1.5rem; }
        .sub-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        .sub-icon {
            width: 32px;
            height: 32px;
            background: rgba(0, 116, 200, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .sub-titulo {
            font-size: 1.05rem;
            color: #1e293b;
            font-weight: 600;
            margin: 0;
        }
        
        /* Destacados */
        .dest {
            background: #f0f9ff;
            border-left: 4px solid var(--azul);
            padding: 1rem 1.25rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }
        .dest-rojo { background: #fef2f2; border-color: var(--rojo); }
        .dest-verde { background: #f0fdf4; border-color: #10b981; }
        .dest-naranja { background: #fff7ed; border-color: var(--naranja); }
        
        /* Tablas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        th, td {
            padding: 0.6rem 0.75rem;
            text-align: left;
            border: 1px solid #e2e8f0;
        }
        th {
            background: #f8fafc;
            font-weight: 600;
            color: #1e293b;
        }
        
        /* L√≠neas estrat√©gicas */
        .linea-card {
            border-left: 4px solid var(--azul);
            padding: 1rem;
            margin: 1rem 0;
            background: #f8fafc;
            border-radius: 0 8px 8px 0;
        }
        .linea-card h4 {
            color: var(--azul);
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }
        
        /* Contenido de acordeones */
        .acordeon-item { 
            margin-bottom: 1.5rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        .acordeon-header { 
            background: linear-gradient(135deg, var(--azul), var(--cyan)); 
            color: white; 
            padding: 1rem 1.5rem; 
            font-weight: 600; 
            font-size: 1.05rem;
        }
        .acordeon-header .flecha { display: none; }
        .acordeon-contenido { 
            display: block !important; 
            padding: 1.5rem; 
            background: #fff;
        }
        .acordeon-contenido h3 { 
            color: var(--azul); 
            margin: 1.5rem 0 1rem; 
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, rgba(0,116,200,0.08), rgba(0,172,217,0.04));
            border-left: 4px solid var(--azul);
            border-radius: 0 8px 8px 0;
            font-size: 1rem;
            font-weight: 600;
        }
        .acordeon-contenido h3:first-child { margin-top: 0; }
        .acordeon-contenido h4 { 
            color: var(--cyan); 
            margin: 1rem 0 0.5rem; 
            font-size: 0.95rem;
            font-weight: 600;
        }
        .acordeon-contenido p { 
            margin-bottom: 1rem; 
            text-align: justify; 
            line-height: 1.7;
        }
        .acordeon-contenido ul, .acordeon-contenido ol { 
            margin: 1rem 0; 
            padding-left: 1.5rem; 
        }
        .acordeon-contenido li { margin-bottom: 0.5rem; }
        
        /* Footer */
        .footer-doc {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 0.8rem;
            color: #64748b;
        }
        
        /* Utilidades */
        p { margin-bottom: 0.75rem; }
        ul, ol { margin: 0.75rem 0 0.75rem 1.5rem; }
        li { margin-bottom: 0.35rem; }
        strong { font-weight: 600; }
        
        .prior-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .prior-box h4 {
            margin: 0 0 0.75rem 0;
            color: #1e293b;
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header Institucional -->
    <div class="header-institucional">
        <div class="header-logos">
            ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a de Salud">` : ''}
            ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito sanitario">` : ''}
            ${logoRelas ? `<img src="${logoRelas}" alt="RELAS">` : ''}
            ${logoViolencia ? `<img src="${logoViolencia}" alt="Contra la Violencia">` : ''}
            ${logoRasselh ? `<img src="${logoRasselh}" alt="RASSELH">` : ''}
        </div>
        <div class="header-branding">
            <div class="header-compas">COMP√ÅS</div>
            <div class="header-subtitulo">Dise√±o ciudadano de la salud</div>
        </div>
        <div class="header-titulo">
            <h1>Plan local de salud</h1>
            <div class="header-municipio">${nombre}</div>
            <div class="header-anio">2026 ‚Äî 2030</div>
        </div>
    </div>
    
    <!-- Contenido -->
    <div class="doc">
        ${contenidoPlan}
    </div>
    
    <!-- Footer -->
    <div class="footer-doc">
        <p>Distrito sanitario Granada-Metropolitano ¬∑ Unidad de Prevenci√≥n, Promoci√≥n y Vigilancia de la Salud</p>
        <p>Documento generado con COMP√ÅS ¬∑ ${new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
        <p style="font-size: 0.7rem; margin-top: 0.5rem;">${typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.copyright : '¬© B. Hermoso ¬∑ Licencia MIT'}</p>
    </div>
</body>
</html>`;
}

// ==========================================
// GENERAR PERFIL DE SALUD LOCAL (Word/PDF)
// ==========================================
function generarPerfilSaludLocal() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    // Capturar el contenido del acorde√≥n del perfil
    const contenidoPerfil = document.getElementById('contenido-perfil-dinamico');
    if (!contenidoPerfil || !contenidoPerfil.innerHTML.trim()) {
        alert('‚ö†Ô∏è No hay datos del Perfil de salud local para exportar.\n\nCarga los datos del municipio primero.');
        return;
    }
    
    // Capturar valores de inputs ANTES de clonar (cloneNode no preserva valores de inputs)
    const valoresInputs = {};
    contenidoPerfil.querySelectorAll('.det-input').forEach(input => {
        valoresInputs[input.id] = {
            valor: input.value,
            color: input.style.color || '#333'
        };
    });
    
    // Clonar el contenido para procesarlo sin afectar la interfaz original
    const contenidoClonado = contenidoPerfil.cloneNode(true);
    
    // Convertir inputs de determinantes a texto est√°tico para el PDF
    contenidoClonado.querySelectorAll('.det-input').forEach(input => {
        const inputId = input.id;
        const datos = valoresInputs[inputId] || {};
        const valor = datos.valor || '';
        const color = datos.color || '#333';
        const parent = input.parentNode;
        
        // Buscar el span de unidad que est√° al lado
        const unidadSpan = parent.querySelector('.unidad');
        const unidad = unidadSpan ? unidadSpan.textContent.trim() : '%';
        
        // Crear texto est√°tico con el valor
        const textoValor = document.createElement('span');
        textoValor.style.cssText = `font-weight:600; color:${color};`;
        textoValor.textContent = valor !== '' ? valor + ' ' + unidad : '‚Äî';
        
        // Reemplazar input por texto
        input.replaceWith(textoValor);
        
        // Eliminar el span de unidad
        if (unidadSpan) unidadSpan.remove();
    });
    
    // Hacer visibles todas las √°reas de determinantes para el PDF
    contenidoClonado.querySelectorAll('.determinantes-area').forEach(area => {
        area.style.display = 'block';
        area.classList.add('activa');
    });
    
    // Ocultar botones y controles interactivos
    contenidoClonado.querySelectorAll('.btn-registrar, .determinantes-tabs, button').forEach(btn => {
        btn.style.display = 'none';
    });
    
    // Expandir todos los acordeones
    contenidoClonado.querySelectorAll('.acordeon-contenido').forEach(ac => {
        ac.style.display = 'block';
    });
    
    // Generar HTML completo del documento
    const htmlDocumento = generarHTMLPerfilSaludLocal(nombre, contenidoClonado.innerHTML);
    
    // Abrir en nueva ventana para imprimir como PDF
    const ventana = window.open('', '_blank');
    ventana.document.write(htmlDocumento);
    ventana.document.close();
    
    // Esperar a que cargue y lanzar impresi√≥n
    setTimeout(() => {
        ventana.focus();
        ventana.print();
    }, 1000);
    
    mostrarNotificacion({
        title: 'üìÑ Generando PDF',
        message: 'Seleccione ¬´Guardar como PDF¬ª en el di√°logo de impresi√≥n',
        type: 'info',
        duration: 5000
    });
}

function generarHTMLPerfilSaludLocal(nombre, contenido) {
    const anio = new Date().getFullYear();
    
    // Obtener logos base64
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    const logoRelas = typeof LOGO_RELAS_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_RELAS_B64 : '';
    const logoViolencia = typeof LOGO_VIOLENCIA_B64 !== 'undefined' ? 'data:image/gif;base64,' + LOGO_VIOLENCIA_B64 : '';
    const logoRasselh = typeof LOGO_RASSELH_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_RASSELH_B64 : '';
    
    return `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de salud local de ${nombre} ${anio}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap');
        :root { --azul:#0074c8; --verde:#94d40b; --cyan:#00acd9; --amarillo:#ffb61b; --naranja:#ff6600; --rojo:#dc143c; --oscuro:#1a1a2e; --texto:#2d3748; --claro:#64748b; }
        * { margin:0; padding:0; box-sizing:border-box; }
        @page { size:A4 portrait; margin:2cm; }
        @media print { 
            .no-print{display:none;} 
            .page-break{page-break-before:always;}
            body { font-size:10pt; }
        }
        body { font-family:'Source Sans Pro',sans-serif; color:var(--texto); line-height:1.8; background:#fff; font-size:11pt; }
        
        /* HEADER INSTITUCIONAL */
        .header-institucional { 
            text-align: center; 
            padding: 1.5rem 2rem;
            border-bottom: 6px solid;
            border-image: linear-gradient(90deg, #0074c8 0%, #00acd9 20%, #94d40b 40%, #ffb61b 60%, #ff6600 80%, #dc143c 100%) 1;
            margin-bottom: 2rem;
        }
        .header-logos { 
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .header-logos img { 
            height: 70px; 
            width: auto; 
            object-fit: contain;
        }
        .header-branding { margin: 1rem 0; }
        .header-compas { 
            font-size: 2.5rem; 
            font-weight: 700; 
            letter-spacing: 12px; 
            color: #2c3e50; 
        }
        .header-subtitulo { 
            font-size: 0.85rem; 
            letter-spacing: 5px; 
            color: #64748b; 
            text-transform: uppercase; 
            margin-top: 0.3rem;
            font-weight: 300;
        }
        .header-titulo h1 { 
            font-size: 1.4rem; 
            color: #0074c8; 
            margin: 1rem 0 0.3rem 0; 
            font-weight: 600; 
        }
        .header-municipio { 
            font-size: 2rem; 
            font-weight: 700; 
            color: #1e293b; 
            letter-spacing: 1px;
        }
        .header-anio { 
            font-size: 1.1rem; 
            color: #00acd9; 
            letter-spacing: 3px;
            font-weight: 500;
            margin-top: 0.3rem;
        }
        
        /* DOCUMENTO - Mancha elegante */
        .doc { max-width: 800px; margin: 0 auto; padding: 0 1.5rem; }
        
        /* Secciones del acorde√≥n como subsecciones elegantes */
        .acordeon-item { 
            margin-bottom: 2rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e2e8f0;
        }
        .acordeon-header { 
            background: linear-gradient(135deg, var(--azul), var(--cyan)); 
            color: white; 
            padding: 1rem 1.5rem; 
            font-weight: 600; 
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .acordeon-header .flecha { display: none; }
        .acordeon-contenido { 
            display: block !important; 
            padding: 1.5rem; 
            background: #fff;
        }
        
        /* Tipograf√≠a dentro del contenido */
        .acordeon-contenido h3 { 
            color: var(--azul); 
            margin: 1.5rem 0 1rem; 
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, rgba(0,116,200,0.08), rgba(0,172,217,0.04));
            border-left: 4px solid var(--azul);
            border-radius: 0 8px 8px 0;
            font-size: 1.05rem;
            font-weight: 600;
        }
        .acordeon-contenido h3:first-child { margin-top: 0; }
        .acordeon-contenido h4 { 
            color: var(--cyan); 
            margin: 1rem 0 0.5rem; 
            font-size: 0.95rem;
            font-weight: 600;
        }
        .acordeon-contenido p { 
            margin-bottom: 1rem; 
            text-align: justify; 
            line-height: 1.7;
        }
        .acordeon-contenido ul, .acordeon-contenido ol { 
            margin: 1rem 0; 
            padding-left: 1.5rem; 
        }
        .acordeon-contenido li { 
            margin-bottom: 0.5rem; 
            line-height: 1.6;
        }
        .acordeon-contenido strong { color: var(--azul); }
        
        /* Tablas */
        .acordeon-contenido table,
        .tabla-indicadores { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 1.25rem 0; 
            font-size: 0.9rem;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            border-radius: 8px;
            overflow: hidden;
        }
        .acordeon-contenido thead th,
        .tabla-indicadores thead th { 
            background: linear-gradient(135deg, var(--azul), var(--cyan)); 
            color: #fff; 
            padding: 0.75rem 1rem; 
            text-align: left; 
            font-size: 0.85rem;
            font-weight: 600;
        }
        .acordeon-contenido tbody td,
        .tabla-indicadores tbody td { 
            padding: 0.65rem 1rem; 
            border-bottom: 1px solid #e9ecef; 
            vertical-align: middle;
        }
        .acordeon-contenido tbody tr:nth-child(even),
        .tabla-indicadores tbody tr:nth-child(even) { background: #f8fafc; }
        .acordeon-contenido tbody tr:hover,
        .tabla-indicadores tbody tr:hover { background: rgba(0,116,200,0.04); }
        
        /* Destacados y cajas de informaci√≥n */
        .destacado, .dest { 
            padding: 1rem 1.25rem; 
            border-radius: 8px; 
            margin: 1.25rem 0;
            border-left: 4px solid;
            line-height: 1.6;
        }
        .destacado-azul, .dest-azul { 
            background: linear-gradient(135deg, rgba(0,116,200,0.08), rgba(0,172,217,0.04)); 
            border-color: var(--azul); 
        }
        .destacado-verde, .dest-verde { 
            background: linear-gradient(135deg, rgba(148,212,11,0.1), rgba(0,102,51,0.05)); 
            border-color: var(--verde); 
        }
        .destacado-rojo, .dest-rojo { 
            background: linear-gradient(135deg, rgba(220,20,60,0.08), rgba(255,102,0,0.05)); 
            border-color: var(--rojo); 
        }
        .destacado-amarillo { 
            background: linear-gradient(135deg, rgba(255,182,27,0.12), rgba(255,102,0,0.05)); 
            border-color: var(--amarillo); 
        }
        
        /* Cards de conclusiones */
        .conclusion-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 1.25rem;
            margin: 1.25rem 0;
        }
        .conclusion-card { 
            background: white; 
            border-radius: 10px; 
            padding: 1.25rem; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 4px solid var(--azul); 
            position: relative;
        }
        .conclusion-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: -4px; 
            right: 0; 
            height: 3px; 
            background: linear-gradient(90deg, var(--azul), var(--cyan)); 
            border-radius: 10px 10px 0 0; 
        }
        .conclusion-card h4 { 
            color: rgba(0,116,200,0.15); 
            font-size: 1.8rem; 
            margin: 0 0 0.5rem; 
        }
        .conclusion-card .tipo { 
            font-size: 0.7rem; 
            color: var(--azul); 
            text-transform: uppercase; 
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 0.5rem; 
        }
        .recomendacion { 
            margin-top: 1rem; 
            padding-top: 1rem; 
            border-top: 1px dashed #e9ecef; 
        }
        .recomendacion .tipo { color: var(--verde); }
        
        /* Indicadores grid */
        .indicadores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 1.25rem 0;
        }
        .indicador-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .indicador-valor {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--azul);
        }
        .indicador-label {
            font-size: 0.8rem;
            color: var(--claro);
            margin-top: 0.3rem;
        }
        
        /* Determinantes */
        .determinantes-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .determinante-tab { 
            padding: 0.5rem 1rem; 
            border-radius: 20px; 
            background: #f1f5f9; 
            font-size: 0.85rem;
            font-weight: 500;
        }
        .determinante-tab.activo { background: var(--azul); color: #fff; }
        
        /* Footer del documento */
        .doc-footer { 
            text-align: center; 
            padding: 2rem 1.5rem; 
            margin-top: 2.5rem; 
            border-top: 2px solid #e2e8f0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .doc-footer p { 
            font-size: 0.9rem; 
            color: var(--claro); 
            margin: 0.3rem 0;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <header class="header-institucional">
        <div class="header-logos">
            ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a">` : ''}
            ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito">` : ''}
            ${logoRelas ? `<img src="${logoRelas}" alt="RELAS">` : ''}
            ${logoViolencia ? `<img src="${logoViolencia}" alt="Violencia Cero">` : ''}
            ${logoRasselh ? `<img src="${logoRasselh}" alt="RASSELH">` : ''}
        </div>
        <div class="header-branding">
            <div class="header-compas">COMP√ÅS</div>
            <div class="header-subtitulo">Dise√±o ciudadano de la salud</div>
        </div>
        <div class="header-titulo">
            <h1>Perfil de salud local</h1>
            <div class="header-municipio">${nombre}</div>
            <div class="header-anio">${anio}</div>
        </div>
    </header>
    
    <div class="doc">
        ${contenido}
    </div>
    
    <div class="doc-footer">
        <p><strong>Perfil de salud local de ${nombre}</strong></p>
        <p>Elaborado en el marco de la Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a</p>
        <p style="margin-top:0.75rem;">Unidad de Prevenci√≥n, Promoci√≥n y Vigilancia de la Salud</p>
        <p>Distrito sanitario Granada-Metropolitano ¬∑ Servicio Andaluz de Salud</p>
        <p style="margin-top:0.75rem;font-size:0.75rem;">Documento generado con COMP√ÅS ¬∑ ¬© ${anio}</p>
    </div>
</body>
</html>`;
}

function generarDocumentoCompleto() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    const contenido = generarHTMLPlanLocal(true);
    
    return `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan local de salud de ${nombre} 2026-2030</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap');
        :root { --azul:#0074c8; --verde:#94d40b; --cyan:#00acd9; --lima:#94d40b; --amarillo:#ffb61b; --naranja:#ff6600; --rojo:#dc143c; --oscuro:#1a1a2e; --texto:#2d3748; --claro:#64748b; }
        * { margin:0; padding:0; box-sizing:border-box; }
        @page { size:A4; margin:2cm; }
        @media print { .no-print{display:none;} .page-break{page-break-before:always;} }
        body { font-family:'Source Sans Pro',sans-serif; color:var(--texto); line-height:1.8; background:#fff; font-size:11pt; }
        
        /* Estilos del header general - igual a la p√°gina principal */
        .header { padding: 1.5rem 2rem; page-break-after: always; }
        .header-content { display: flex; justify-content: center; align-items: center; text-align: center; flex-direction: column; }
        .logos-institucionales { display: flex; justify-content: center; align-items: center; gap: 1.5rem; margin-bottom: 2rem; flex-wrap: nowrap; }
        .logo-institucional { height: 120px; width: auto; max-width: 350px; object-fit: contain; }
        .logo-institucional.consejeria { height: 170px; }
        .logo-institucional.distrito { height: 140px; }
        .logo-institucional.relas { height: 150px; }
        .logo-institucional.violencia { height: 120px; }
        .logo-institucional.rasselh { height: 140px; }
        .franja { height: 6px; background: linear-gradient(90deg, #0074c8 0%, #00acd9 20%, #94d40b 40%, #ffb61b 60%, #ff6600 80%, #dc143c 100%); }
        .itaca-branding { text-align: center; margin-top: 1rem; }
        .itaca-nombre { font-size: 3.5rem; font-weight: 700; letter-spacing: 18px; text-transform: uppercase; color: #2c3e50; display: block; margin-bottom: 0.5rem; }
        .itaca-descripcion { font-size: 1rem; letter-spacing: 12px; text-transform: uppercase; font-weight: 300; color: #666; display: block; }
        
        /* Portada - Estilo institucional fondo BLANCO */
        .portada { min-height:100vh; background:#ffffff !important; display:flex; flex-direction:column; position:relative; color:#333; }
        
        /* Barra lateral con los 6 colores de la paleta */
        .portada-sidebar { position:absolute; left:0; top:0; bottom:0; width:70px; display:flex; flex-direction:column; }
        .sidebar-item { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:0.5rem 0.25rem; writing-mode:vertical-rl; text-orientation:mixed; transform:rotate(180deg); font-size:0.55rem; font-weight:600; text-transform:uppercase; letter-spacing:1px; }
        .sidebar-icon { font-size:1.2rem; margin-bottom:0.3rem; transform:rotate(90deg); }
        
        /* Header institucional */
        .portada-header { display:flex; justify-content:space-between; align-items:center; padding:1.5rem 2rem 1.5rem 90px; border-bottom:3px solid #94d40b; background:#fff; }
        .header-left { display:flex; align-items:center; gap:1rem; }
        .header-right { display:flex; align-items:center; gap:0.5rem; }
        .distrito-placeholder { text-align:right; font-size:0.65rem; color:#666; line-height:1.3; }
        .distrito-placeholder span { display:block; }
        .distrito-placeholder strong { color:#0074c8; font-size:0.75rem; }
        
        /* Contenido principal portada */
        .portada-main { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:2rem 2rem 2rem 90px; text-align:center; background:#fff; }
        .portada-titulo { font-size:2rem; font-weight:700; margin:0.5rem 0; color:#333; }
        .portada-municipio { font-size:3.5rem; font-weight:800; text-transform:uppercase; letter-spacing:4px; margin:0.75rem 0; color:#0074c8; }
        .portada-periodo { font-size:1.5rem; font-weight:400; color:#00acd9; letter-spacing:4px; margin-bottom:1.5rem; }
        
        /* Logos centrales */
        .portada-logos-central { display:flex; gap:2rem; justify-content:center; align-items:center; margin:2rem 0; flex-wrap:wrap; }
        .compas-box { background:#f8f9fa; border:2px solid #e9ecef; padding:0.75rem 1.5rem; border-radius:10px; text-align:center; }
        .compas-nombre { font-size:1.6rem; font-weight:700; background:linear-gradient(90deg,#0074c8,#00acd9,#94d40b,#ffb61b,#ff6600,#dc143c); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; letter-spacing:2px; }
        .compas-subtitulo { font-size:0.6rem; color:#666; margin-top:0.2rem; }
        
        /* Footer institucional */
        .portada-footer { display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem 1rem 90px; border-top:2px solid #e0e0e0; background:#fafafa; flex-wrap:wrap; gap:1rem; }
        .footer-item { display:flex; align-items:center; gap:0.4rem; font-size:0.55rem; color:#666; }
        .footer-item .footer-icon { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.7rem; }
        .footer-item .footer-icon img { width:24px; height:24px; object-fit:contain; }
        .footer-item.libres .footer-icon { background:#e8f5e9; color:#94d40b; }
        .footer-item.eps .footer-icon { background:#fff3e0; color:#e65100; }
        .footer-item.ugc .footer-icon { background:#e3f2fd; color:#0074c8; }
        .footer-item.violencia .footer-icon { background:#fce4ec; color:#c2185b; }
        .footer-item strong { color:#333; display:block; font-size:0.6rem; }
        .footer-item span { color:#888; }
        
        /* Documento principal - estilo Markdown */
        .doc { max-width:800px; margin:0 auto; padding:2.5rem; }
        .seccion { margin-bottom:3rem; }
        
        /* Cabeceras de secci√≥n */
        .sec-header { padding:1.5rem 2rem; color:white; border-radius:8px; position:relative; margin-bottom:2rem; }
        .sec-header.perfil { background:linear-gradient(135deg,var(--azul),var(--cyan)); }
        .sec-header.plan { background:linear-gradient(135deg,var(--verde),var(--lima)); }
        .sec-header.agenda { background:linear-gradient(135deg,var(--naranja),var(--rojo)); }
        .sec-num { font-size:3rem; font-weight:800; opacity:0.2; position:absolute; right:2rem; top:50%; transform:translateY(-50%); }
        .sec-pre { font-size:0.75rem; text-transform:uppercase; letter-spacing:2px; opacity:0.9; margin-bottom:0.25rem; }
        .sec-titulo { font-size:1.5rem; font-weight:700; margin:0; }
        .sec-body { padding:0; }
        
        /* Subsecciones - estilo Markdown */
        .sub { margin-bottom:2.5rem; }
        .sub-header { display:flex; align-items:center; gap:0.75rem; margin-bottom:1.25rem; padding-bottom:0.75rem; border-bottom:2px solid #e2e8f0; }
        .sub-icon { width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:1.1rem; }
        .sub-icon.blue { background:rgba(0,116,200,0.1); }
        .sub-icon.green { background:rgba(0,102,51,0.1); }
        .sub-icon.orange { background:rgba(255,102,0,0.1); }
        .sub-titulo { font-size:1.25rem; font-weight:600; color:var(--oscuro); }
        
        /* P√°rrafos con buen espaciado */
        .sub p, .sec-body p, p { 
            margin-bottom:1.25rem; 
            text-align:justify; 
            line-height:1.85;
        }
        .sub p:last-child { margin-bottom:0; }
        
        /* Listas con espaciado */
        ul, ol { margin:1.25rem 0; padding-left:1.5rem; }
        li { margin-bottom:0.6rem; line-height:1.7; }
        
        /* Tablas mejoradas */
        table { width:100%; border-collapse:collapse; margin:1.5rem 0 2rem; font-size:0.9rem; }
        thead { background:var(--azul); color:white; }
        th { padding:0.85rem 1rem; text-align:left; font-weight:600; }
        td { padding:0.75rem 1rem; border-bottom:1px solid #e2e8f0; vertical-align:top; }
        tbody tr:nth-child(even) { background:#f8fafc; }
        .tabla-total { background:#f1f5f9; font-weight:600; }
        
        /* Grids de indicadores */
        .ind-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:1rem; margin:1.5rem 0 2rem; }
        .ind-card { background:linear-gradient(135deg,#f8fafc,#f1f5f9); border-radius:10px; padding:1.25rem; text-align:center; }
        .ind-valor { font-size:1.6rem; font-weight:700; }
        .ind-label { font-size:0.8rem; color:var(--claro); margin-top:0.4rem; }
        
        /* Destacados */
        .dest { padding:1.25rem 1.5rem; border-radius:8px; margin:1.5rem 0 2rem; border-left:4px solid; line-height:1.75; }
        .dest-azul { background:linear-gradient(135deg,rgba(0,116,200,0.08),rgba(0,172,217,0.05)); border-color:var(--azul); }
        .dest-verde { background:linear-gradient(135deg,rgba(148,212,11,0.1),rgba(0,102,51,0.05)); border-color:var(--lima); }
        .dest-rojo { background:linear-gradient(135deg,rgba(220,20,60,0.08),rgba(255,102,0,0.05)); border-color:var(--rojo); }
        
        /* Conclusiones */
        .concl-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:1.25rem; margin:1.5rem 0 2rem; }
        .concl-card { background:white; border-radius:10px; padding:1.25rem; box-shadow:0 2px 8px rgba(0,0,0,0.06); border:1px solid #e2e8f0; position:relative; }
        .concl-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:linear-gradient(90deg,var(--azul),var(--cyan)); border-radius:10px 10px 0 0; }
        .concl-num { font-size:1.8rem; font-weight:800; color:rgba(0,116,200,0.1); position:absolute; top:0.2rem; right:0.6rem; }
        .concl-tipo { font-size:0.65rem; text-transform:uppercase; letter-spacing:1px; color:var(--azul); font-weight:600; margin-bottom:0.4rem; }
        .concl-card p { font-size:0.9rem; line-height:1.6; margin-bottom:0.5rem; }
        .recom { margin-top:1rem; padding-top:1rem; border-top:1px dashed #e2e8f0; }
        .recom .concl-tipo { color:var(--lima); }
        .prior-box { background:linear-gradient(135deg,#f8fafc,#e2e8f0); border-radius:10px; padding:1.5rem; margin:1.5rem 0 2rem; }
        .prior-box h4 { font-size:1.1rem; color:var(--oscuro); margin-bottom:1rem; }
        .lineas-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-top:1.25rem; }
        .linea-card { background:white; border-radius:10px; padding:1.25rem; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.05); border-top:3px solid var(--azul); }
        .linea-card h5 { font-size:1.3rem; color:var(--azul); margin-bottom:0.4rem; }
        .linea-card p { font-size:0.85rem; color:var(--texto); margin:0; }
        
        /* Kanban mejorado */
        .kanban { display:grid; grid-template-columns:repeat(2,1fr); gap:1.25rem; margin:1.5rem 0 2rem; }
        .kanban-col { background:#f8fafc; border-radius:10px; padding:1rem; }
        .kanban-head { display:flex; align-items:center; gap:0.5rem; padding-bottom:0.75rem; margin-bottom:0.75rem; border-bottom:2px solid; font-size:0.95rem; font-weight:700; }
        .kanban-col.sanitario .kanban-head { border-color:var(--azul); }
        .kanban-col.comunitario .kanban-head { border-color:var(--lima); }
        .kanban-col.educativo .kanban-head { border-color:var(--amarillo); }
        .kanban-col.laboral .kanban-head { border-color:var(--naranja); }
        .accion { background:white; border-radius:8px; padding:0.75rem 1rem; margin-bottom:0.6rem; box-shadow:0 1px 3px rgba(0,0,0,0.04); border-left:4px solid; }
        .accion.sanitario { border-color:var(--azul); }
        .accion.comunitario { border-color:var(--lima); }
        .accion.educativo { border-color:var(--amarillo); }
        .accion.laboral { border-color:var(--naranja); }
        .accion-nombre { font-weight:600; color:var(--oscuro); line-height:1.5; }
        .accion-tags { display:flex; gap:0.35rem; flex-wrap:wrap; margin-top:0.5rem; }
        .tag { font-size:0.65rem; padding:0.15rem 0.4rem; border-radius:4px; background:#f1f5f9; color:var(--claro); }
        .tag.alta { background:rgba(220,20,60,0.1); color:var(--rojo); }
        .tag.media { background:rgba(255,182,27,0.15); color:#b45309; }
        
        /* Elaboraci√≥n */
        .elab { background:linear-gradient(135deg,#f8fafc,#e9ecef); padding:1.5rem; border-radius:10px; margin:1.5rem 0 2rem; text-align:center; border:1px solid #dee2e6; }
        .elab-nombre { font-size:1.15rem; font-weight:700; color:var(--oscuro); }
        .elab-cargo { font-size:0.95rem; color:var(--texto); font-style:italic; margin-top:0.25rem; }
        .elab-entidad { font-size:0.85rem; color:var(--claro); margin-top:0.25rem; }
        
        /* Footer */
        .doc-footer { text-align:center; padding:2.5rem; margin-top:2rem; border-top:2px solid #e2e8f0; }
        .doc-footer p { font-size:0.9rem; color:var(--claro); margin:0.35rem 0; line-height:1.6; }
        .fuente { font-size:0.75rem; color:var(--claro); font-style:italic; margin-top:0.6rem; }
        
        /* Estilos para contenido completo del compilador */
        .perfil-completo, .plan-accion-completo { margin:0; }
        .perfil-completo .acordeon-item, .plan-accion-completo .plan-documento-seccion { margin-bottom:2rem; }
        .perfil-completo .acordeon-header { background:linear-gradient(135deg,#0074c8,#00acd9); color:white; padding:1rem 1.5rem; border-radius:8px; font-weight:600; cursor:default; margin-bottom:1rem; }
        .perfil-completo .acordeon-contenido { display:block !important; padding:0; background:transparent; }
        .plan-accion-completo .plan-documento-header { text-align:center; padding:1.5rem 2rem; background:linear-gradient(135deg,#94d40b,#94d40b); color:white; border-radius:8px; margin-bottom:2rem; }
        .plan-accion-completo .plan-documento-header h1 { font-size:1.5rem; margin:0; }
        .plan-accion-completo .doc-linea { border-left:4px solid; padding:1.25rem 1.5rem; margin:1.25rem 0; background:#f8fafc; border-radius:0 8px 8px 0; }
        .plan-accion-completo .doc-objetivo { margin:1rem 0; padding:1rem; background:white; border-radius:8px; }
        .plan-accion-completo .doc-programa { margin:0.75rem 0; padding:0.75rem 1rem; background:rgba(0,102,51,0.05); border-radius:6px; }
        
        /* Tablas de actuaciones */
        .tabla-actuaciones { width:100%; border-collapse:collapse; margin:1.5rem 0 2rem; }
        .tabla-actuaciones thead { background:var(--azul); color:white; }
        .tabla-actuaciones th { padding:1rem 1.25rem; text-align:left; font-weight:600; font-size:0.9rem; }
        .tabla-actuaciones td { padding:0.85rem 1.25rem; border-bottom:1px solid #e2e8f0; vertical-align:top; line-height:1.6; }
        .tabla-actuaciones tbody tr:nth-child(even) { background:#f8fafc; }
        .tabla-actuaciones tbody tr:hover { background:rgba(0,116,200,0.04); }
        .tabla-actuaciones code { font-family:'Consolas',monospace; background:#e2e8f0; padding:0.2rem 0.5rem; border-radius:4px; font-size:0.85rem; }
        
        /* Estilos heredados del perfil */
        .indicadores-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:1.25rem; margin:1.5rem 0 2rem; }
        .indicador-card { background:#f8fafc; border-radius:10px; padding:1.25rem; text-align:center; }
        .indicador-valor { font-size:1.6rem; font-weight:700; color:var(--azul); }
        .indicador-label { font-size:0.85rem; color:var(--claro); margin-top:0.4rem; }
        .conclusion-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1.25rem; }
        .conclusion-card { background:white; border-radius:10px; padding:1.5rem; box-shadow:0 2px 8px rgba(0,0,0,0.06); border-left:4px solid var(--azul); }
        .conclusion-card h4 { font-size:2rem; color:rgba(0,116,200,0.15); margin:0; }
        .tipo { font-size:0.7rem; text-transform:uppercase; letter-spacing:1px; color:var(--azul); font-weight:600; margin:0.6rem 0 0.35rem; }
        .recomendacion { margin-top:1rem; padding-top:1rem; border-top:1px dashed #e2e8f0; }
        .recomendacion .tipo { color:var(--lima); }
        .lineas-estrategicas { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1.25rem; margin-top:1.25rem; }
        .linea-estrategica { background:white; padding:1.25rem; border-radius:10px; border-top:3px solid var(--azul); text-align:center; }
        .linea-estrategica h5 { color:var(--azul); margin:0 0 0.6rem; font-size:1.3rem; }
        .priorizacion-resultado { background:linear-gradient(135deg,#f8fafc,#e2e8f0); padding:1.75rem; border-radius:10px; margin:1.5rem 0 2rem; }
        .priorizacion-resultado h4 { color:var(--oscuro); margin:0 0 1.25rem; font-size:1.1rem; }
        
        /* Separadores visuales */
        hr { border:none; height:1px; background:linear-gradient(90deg,transparent,#e2e8f0,transparent); margin:2rem 0; }
    </style>
</head>
<body>
${contenido}
</body>
</html>`;
}

function generarHTMLPlanLocal(completo) {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    // Usar datos del compilador si est√°n disponibles
    const acciones = planLocalSalud.agenda.completado ? planLocalSalud.agenda.actuaciones : (accionesAgenda || []);
    const planAccionHTML = planLocalSalud.planAccion.completado ? planLocalSalud.planAccion.html : null;
    
    // Portada
    let html = '';
    if (completo) {
        html += generarPortadaPLS(nombre);
    }
    
    html += '<div class="doc">';
    
    // ==========================================
    // PARTE 1: PERFIL DE SALUD LOCAL (COMPLETO)
    // ==========================================
    html += '<section class="seccion">';
    html += '<div class="sec-header perfil"><div class="sec-num">01</div><div class="sec-pre">Parte Primera</div><h2 class="sec-titulo">Perfil de salud local de ' + nombre + '</h2></div>';
    html += '<div class="sec-body">';
    
    // 1.1 Marco estrat√©gico (contenido din√°mico completo)
    html += '<div class="sub"><div class="sub-header"><div class="sub-icon blue">üéØ</div><h3 class="sub-titulo">Marco estrat√©gico de la acci√≥n local en salud</h3></div>';
    
    // Obtener configuraci√≥n del municipio
    const configMarcoPDF = {
        municipio: nombre,
        distrito: 'Distrito sanitario Granada-Metropolitano',
        anioInforme: (datosMunicipioActual && datosMunicipioActual.anioInforme) || new Date().getFullYear(),
        anioEncuesta: (datosMunicipioActual && datosMunicipioActual.anioEncuesta) || (new Date().getFullYear() - 1),
        mesPriorizacion: (datosMunicipioActual && datosMunicipioActual.mesPriorizacion) || 'febrero',
        anioPriorizacion: (datosMunicipioActual && datosMunicipioActual.anioPriorizacion) || new Date().getFullYear(),
        lineasEstrategia: (datosMunicipioActual && datosMunicipioActual.lineasEstrategia) || '1, 3 y 4'
    };
    
    html += '<p>Este informe ha sido elaborado por profesionales de la <strong>Unidad de Prevenci√≥n, Promoci√≥n y Vigilancia de la Salud</strong> del <strong>' + configMarcoPDF.distrito + '</strong>, en el marco de la <strong>Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a</strong> (la Estrategia en adelante), que promueve la <strong>Consejer√≠a de Salud y Consumo</strong>, a trav√©s de la <strong>Direcci√≥n General de salud p√∫blica y ordenaci√≥n farmac√©utica</strong>, con el objetivo de mejorar la salud y el bienestar de la poblaci√≥n andaluza, e incluye la informaci√≥n epidemiol√≥gica m√°s reciente y relevante de <strong>' + nombre + '</strong>, adem√°s de alguna informaci√≥n de utilidad sobre programas de salud y sobre h√°bitos de vida saludable.</p>';
    html += '<div class="dest dest-azul"><strong>La Estrategia pretende promover los h√°bitos saludables en toda la poblaci√≥n y edades</strong>, mediante intervenciones en el <strong>√°mbito local</strong>, en <strong>todos los entornos de vida</strong> y en <strong>todas las pol√≠ticas y actuaciones sobre los determinantes que generan desigualdades en salud</strong>. As√≠ mismo, propone <strong>potenciar los activos personales y comunitarios</strong> que generan salud a lo largo de la vida, para que la ciudadan√≠a pueda afrontar el d√≠a a d√≠a con <strong>mayores cotas de bienestar</strong>.</div>';
    html += '<p>El <strong>Informe sobre la situaci√≥n de salud de ' + nombre + ' (' + configMarcoPDF.anioInforme + ')</strong> y la <strong>Encuesta local de salud de ' + nombre + ' (' + configMarcoPDF.anioEncuesta + ')</strong> han facilitado el paso del diagn√≥stico a la acci√≥n. De acuerdo con lo acordado por el Grupo-Motor en su sesi√≥n de priorizaci√≥n del mes de <strong>' + configMarcoPDF.mesPriorizacion + ' de ' + configMarcoPDF.anioPriorizacion + '</strong>, se adaptar√° el dise√±o del plan de acci√≥n a las <strong>l√≠neas ' + configMarcoPDF.lineasEstrategia + '</strong> de la Estrategia, situando la <strong>percepci√≥n de calidad de vida y el bienestar emocional</strong> en el centro neur√°lgico del plan.</p>';
    html += '<p>Al acompasar el Plan local de salud de ' + nombre + ' a la Estrategia, se incorporan de manera autom√°tica al mismo las <strong>l√≠neas estrat√©gicas</strong>, los <strong>objetivos</strong> seleccionados dentro de cada l√≠nea y los <strong>indicadores de contexto e impacto</strong> vinculados a cada objetivo. Lo que deber√≠a permitir no solo el seguimiento y la evaluaci√≥n, sino tambi√©n la <strong>comparaci√≥n de resultados con otros territorios de referencia</strong>.</p>';
    html += '<h4 style="margin:1.5rem 0 0.75rem;color:#1e293b;">Fuentes de informaci√≥n</h4>';
    html += '<p>El informe incorpora una <strong>herramienta para el seguimiento y la evaluaci√≥n</strong>, y se ha construido a partir de informaci√≥n disponible en fuentes oficiales como el <strong>Instituto Nacional de Estad√≠stica (INE)</strong> o el <strong>Instituto de Estad√≠stica y Cartograf√≠a de Andaluc√≠a (IECA)</strong>, as√≠ como tambi√©n en fuentes propias del sistema sanitario P√∫blico de Andaluc√≠a (<strong>INFOWEB, BPS, Registro Andaluz de C√°ncer y el M√≥dulo IAHS de Diraya</strong>).</p>';
    html += '</div>';
    
    // 1.2 Informe epidemiol√≥gico COMPLETO
    html += '<div class="sub ' + (completo ? 'page-break' : '') + '"><div class="sub-header"><div class="sub-icon blue">üìä</div><h3 class="sub-titulo">Informe sobre la Situaci√≥n de Salud</h3></div>';
    // Usar el informe desde Firebase
    if (datosMunicipioActual && datosMunicipioActual.informe && datosMunicipioActual.informe.htmlCompleto) {
        html += datosMunicipioActual.informe.htmlCompleto;
    } else {
        html += '<div class="dest dest-rojo"><strong>‚ö†Ô∏è Contenido pendiente:</strong> Carga los datos del informe epidemiol√≥gico en la Fase 2.</div>';
    }
    html += '</div>';
    
    // 1.3 DETERMINANTES COMPLETOS (las 3 √°reas)
    html += '<div class="sub ' + (completo ? 'page-break' : '') + '"><div class="sub-header"><div class="sub-icon" style="background:rgba(102,126,234,0.1);">üìà</div><h3 class="sub-titulo">Determinantes de la salud</h3></div>';
    html += '<div class="dest" style="background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.05));border-color:#0074c8;"><strong>üìä Valores estimados mediante reponderaci√≥n Bettersurveys</strong><br>Estimaciones territoriales a partir de la Encuesta Andaluza de Salud 2023 para el municipio de <strong>' + nombre + '</strong>. Los valores se comparan con las referencias provinciales (Granada) y auton√≥micas (Andaluc√≠a).</div>';
    html += generarDeterminantesCompletosPDF();
    html += '</div>';
    
    // 1.4 Conclusiones y Recomendaciones COMPLETAS - Usar datos de Firebase
    html += '<div class="sub ' + (completo ? 'page-break' : '') + '"><div class="sub-header"><div class="sub-icon blue">üí°</div><h3 class="sub-titulo">Conclusiones y Recomendaciones</h3></div>';
    if (datosMunicipioActual && datosMunicipioActual.conclusiones) {
        html += generarConclusionesCompletasPDF(datosMunicipioActual.conclusiones, datosMunicipioActual.recomendaciones, nombre);
    } else {
        html += '<div class="dest dest-rojo"><strong>‚ö†Ô∏è Contenido pendiente:</strong> Carga las conclusiones y recomendaciones en Gestionar datos.</div>';
    }
    html += '</div>';
    
    // 1.5 Priorizaci√≥n COMPLETA - Usar datos de Firebase
    html += '<div class="sub"><div class="sub-header"><div class="sub-icon orange">üó≥Ô∏è</div><h3 class="sub-titulo">Priorizaci√≥n</h3></div>';
    if (datosMunicipioActual && datosMunicipioActual.priorizacion) {
        html += generarPriorizacionCompletaPDF(datosMunicipioActual.priorizacion, nombre);
    } else {
        html += '<div class="dest dest-rojo"><strong>‚ö†Ô∏è Contenido pendiente:</strong> Configura la priorizaci√≥n en Gestionar datos.</div>';
    }
    html += '</div>';
    
    // 1.6 participaci√≥n ciudadana (si existe)
    if (window.datosParticipacionCiudadana) {
        html += '<div class="sub"><div class="sub-header"><div class="sub-icon" style="background:rgba(99,102,241,0.1);">üó≥Ô∏è</div><h3 class="sub-titulo">Participaci√≥n ciudadana</h3></div>';
        html += generarSeccionParticipacionCiudadanaPDF();
        html += '</div>';
    }
    
    html += '</div></section>';
    
    // ==========================================
    // PARTE 2: PLAN DE ACCI√ìN (COMPLETO)
    // ==========================================
    html += '<section class="seccion ' + (completo ? 'page-break' : '') + '">';
    html += '<div class="sec-header plan"><div class="sec-num">02</div><div class="sec-pre">Parte Segunda</div><h2 class="sec-titulo">Plan de acci√≥n 2026-2030</h2></div>';
    html += '<div class="sec-body">';
    
    if (planAccionHTML) {
        // Incluir el plan de acci√≥n completo generado en Fase 3
        html += '<div class="plan-accion-completo">' + planAccionHTML + '</div>';
    } else {
        html += '<div class="dest dest-rojo"><strong>‚ö†Ô∏è Contenido pendiente:</strong> Genera el Plan de acci√≥n completo en la Fase 3.</div>';
    }
    
    html += '</div></section>';
    
    // ==========================================
    // PARTE 3: AGENDA ANUAL 2026 (COMPLETA)
    // ==========================================
    html += '<section class="seccion ' + (completo ? 'page-break' : '') + '">';
    html += '<div class="sec-header agenda"><div class="sec-num">03</div><div class="sec-pre">Parte Tercera</div><h2 class="sec-titulo">Agenda anual Municipal 2026</h2></div>';
    html += '<div class="sec-body">';
    
    if (acciones.length > 0) {
        html += '<p>la Agenda anual 2026 incluye <strong>' + acciones.length + ' actuaciones</strong> distribuidas en los cuatro entornos de intervenci√≥n.</p>';
        
        // Generar tabla completa de actuaciones por entorno
        html += generarAgendaCompletaPorEntorno(acciones);
        
        // Cronograma
        html += '<div class="sub ' + (completo ? 'page-break' : '') + '"><div class="sub-header"><div class="sub-icon orange">üìÜ</div><h3 class="sub-titulo">Cronograma por Trimestres</h3></div>';
        html += generarCronogramaCompilado(acciones);
        html += '</div>';
    } else {
        html += '<div class="dest dest-rojo"><strong>‚ö†Ô∏è Contenido pendiente:</strong> A√±ada actuaciones a la Agenda en la Fase 6.</div>';
    }
    
    html += '</div></section>';
    
    // Footer
    html += '<footer class="doc-footer">';
    html += '<p><strong>Plan local de salud de ' + nombre + ' 2026-2030</strong></p>';
    html += '<p>Elaborado en el marco de la Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a (EPVSA)</p>';
    html += '<p style="margin-top:0.75rem;">Unidad de Prevenci√≥n, Promoci√≥n y Vigilancia de la Salud</p>';
    html += '<p>Distrito sanitario Granada-Metropolitano ¬∑ Servicio Andaluz de Salud</p>';
    html += '<p style="margin-top:0.75rem;font-size:0.7rem;">' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>';
    html += '</footer>';
    html += '</div>';
    
    return html;
}

// Generar la agenda completa con TODAS las actuaciones por entorno
function generarAgendaCompletaPorEntorno(acciones) {
    const entornos = {
        sanitario: { nombre: 'üè• entorno sanitario', color: '#0074c8', acciones: [] },
        comunitario: { nombre: 'üèòÔ∏è entorno comunitario', color: '#94d40b', acciones: [] },
        educativo: { nombre: 'üéì entorno educativo', color: '#ffb61b', acciones: [] },
        laboral: { nombre: 'üè¢ entorno laboral', color: '#ff6600', acciones: [] }
    };
    
    // Clasificar acciones por entorno
    acciones.forEach(a => {
        if (entornos[a.entorno]) {
            entornos[a.entorno].acciones.push(a);
        }
    });
    
    let html = '';
    
    // Generar tabla completa para cada entorno
    for (const [key, entorno] of Object.entries(entornos)) {
        if (entorno.acciones.length === 0) continue;
        
        html += '<div class="sub"><div class="sub-header"><div class="sub-icon" style="background:' + entorno.color + '20;">' + entorno.nombre.split(' ')[0] + '</div><h3 class="sub-titulo">' + entorno.nombre + ' (' + entorno.acciones.length + ' actuaciones)</h3></div>';
        
        html += '<table class="tabla-actuaciones"><thead><tr><th>C√≥digo</th><th>Actuaci√≥n</th><th>Programa</th><th>Trimestre</th><th>Prioridad</th></tr></thead><tbody>';
        
        entorno.acciones.forEach(a => {
            const prioridadClass = a.prioridad === 'alta' ? 'color:#dc143c;font-weight:600;' : (a.prioridad === 'media' ? 'color:#b45309;' : 'color:#00acd9;');
            html += '<tr>';
            html += '<td><code style="background:#f1f5f9;padding:0.2rem 0.4rem;border-radius:3px;font-size:0.8rem;">' + (a.codigo || '-') + '</code></td>';
            html += '<td><strong>' + a.nombre + '</strong></td>';
            html += '<td style="font-size:0.85rem;">' + (a.programa || '-') + '</td>';
            html += '<td>' + (a.trimestre || '-') + '</td>';
            html += '<td style="' + prioridadClass + '">' + (a.prioridad ? a.prioridad.charAt(0).toUpperCase() + a.prioridad.slice(1) : '-') + '</td>';
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
    }
    
    return html;
}

// Generar los 3 √°reas de determinantes completas para el documento PDF
function generarDeterminantesCompletosPDF() {
    let html = '';
    
    ['area1', 'area2', 'area3'].forEach((areaId, idx) => {
        const area = DETERMINANTES_EAS[areaId];
        if (!area) return;
        
        html += '<div class="sub' + (idx > 0 ? ' page-break' : '') + '">';
        html += '<div class="sub-header"><div class="sub-icon" style="background:rgba(102,126,234,0.1);">' + area.icono + '</div>';
        html += '<h3 class="sub-titulo">' + area.nombre + '</h3></div>';
        html += '<p style="color:#666;font-style:italic;">' + area.descripcion + '</p>';
        
        // Escalas si las tiene
        if (area.escalas) {
            area.escalas.forEach(e => {
                html += '<div style="background:#f8fafc;padding:1rem;border-radius:8px;margin:1rem 0;border-left:3px solid #0074c8;">';
                html += '<strong>üìê ' + e.nombre + '</strong><br>';
                html += '<span style="font-size:0.9rem;color:#666;">√çtems: ' + e.items + ' | Mide: ' + e.mide + '</span></div>';
            });
        }
        
        // Indicadores directos
        if (area.indicadores) {
            html += generarTablaIndicadoresPDF(area.indicadores);
        }
        
        // Grupos de indicadores
        if (area.grupos) {
            area.grupos.forEach(g => {
                html += '<h4 style="margin:1.5rem 0 0.75rem;color:#475569;font-size:1rem;border-bottom:1px solid #e2e8f0;padding-bottom:0.5rem;">' + g.nombre + '</h4>';
                html += generarTablaIndicadoresPDF(g.indicadores);
            });
        }
        
        html += '</div>';
    });
    
    return html;
}

// Generar tabla de indicadores para el PDF (sin inputs, solo valores)
function generarTablaIndicadoresPDF(indicadores) {
    // Obtener determinantes desde Firebase
    const determinantesFirebase = datosMunicipioActual?.determinantes || {};
    
    let html = '<table class="tabla-actuaciones"><thead><tr>';
    html += '<th style="width:80px;">C√≥digo</th>';
    html += '<th>Indicador</th>';
    html += '<th style="width:90px;text-align:center;">Territorio</th>';
    html += '<th style="width:80px;text-align:center;">Granada</th>';
    html += '<th style="width:80px;text-align:center;">Andaluc√≠a</th>';
    html += '</tr></thead><tbody>';
    
    indicadores.forEach(ind => {
        // Obtener valor del municipio - primero desde DOM (m√°s actualizado), luego Firebase
        let valorNum = null;
        
        // 1. Intentar leer del DOM (inputs visibles en la interfaz)
        const inputDOM = document.getElementById('det-' + ind.codigo);
        if (inputDOM && inputDOM.value && inputDOM.value.trim() !== '') {
            valorNum = parseFloat(inputDOM.value);
        }
        
        // 2. Si no hay en DOM, intentar desde Firebase
        if (valorNum === null) {
            const dataFirebase = determinantesFirebase[ind.codigo];
            if (dataFirebase) {
                valorNum = typeof dataFirebase === 'object' ? dataFirebase.valor : dataFirebase;
            }
        }
        
        const valorMunicipio = valorNum !== null && !isNaN(valorNum) ? valorNum + ' ' + ind.unidad : '‚Äî';
        
        // Obtener referencias desde Firebase (variable global referenciasEAS)
        const ref = referenciasEAS[ind.codigo] || {};
        const refGranada = ref.refGranada;
        const refAndalucia = ref.refAndalucia;
        const valorGranada = refGranada !== undefined ? refGranada + ' ' + ind.unidad : '‚Äî';
        const valorAndalucia = refAndalucia !== undefined ? refAndalucia + ' ' + ind.unidad : '‚Äî';
        
        // Colorear seg√∫n comparaci√≥n
        let colorMunicipio = '';
        if (valorNum !== null && !isNaN(valorNum) && refAndalucia !== undefined) {
            // Para indicadores donde menor es mejor (ej: fumadores, problemas)
            const esMejorMenor = ind.texto.includes('dificultad') || ind.texto.includes('problem') || 
                                 ind.texto.includes('Limitaci√≥n') || ind.texto.includes('menos') ||
                                 ind.texto.includes('triste') || ind.texto.includes('solo') ||
                                 ind.texto.includes('deprimido') || ind.texto.includes('bajo') ||
                                 ind.texto.includes('Fumador') || ind.texto.includes('riesgo');
            if (esMejorMenor) {
                colorMunicipio = valorNum < refAndalucia ? 'color:#00acd9;' : (valorNum > refAndalucia ? 'color:#dc143c;' : '');
            } else {
                colorMunicipio = valorNum > refAndalucia ? 'color:#00acd9;' : (valorNum < refAndalucia ? 'color:#dc143c;' : '');
            }
        }
        
        html += '<tr>';
        html += '<td><code style="background:#e2e8f0;padding:0.15rem 0.4rem;border-radius:3px;font-size:0.8rem;">' + ind.codigo + '</code></td>';
        html += '<td>' + ind.texto + '</td>';
        html += '<td style="text-align:center;font-weight:600;' + colorMunicipio + '">' + valorMunicipio + '</td>';
        html += '<td style="text-align:center;color:#666;">' + valorGranada + '</td>';
        html += '<td style="text-align:center;color:#666;">' + valorAndalucia + '</td>';
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    return html;
}

// Generar informe epidemiol√≥gico completo para PDF
function generarInformeCompletoPDF(informe, nombre) {
    let html = '';
    
    if (informe.htmlCompleto) {
        // Si hay HTML completo almacenado, usarlo
        html += informe.htmlCompleto;
    } else {
        // Generar desde los datos estructurados
        if (informe.poblacion) {
            html += '<p><strong>' + nombre + '</strong> cuenta con una poblaci√≥n de <strong>' + (informe.poblacion.total || 'N/D') + ' habitantes</strong>.</p>';
        }
        
        if (informe.mortalidad) {
            html += '<h4 style="margin:1.5rem 0 1rem;color:#1e293b;">Mortalidad</h4>';
            html += '<p>Las principales causas de mortalidad son:</p>';
            html += '<ul>';
            if (informe.mortalidad.cardiovascular) html += '<li>Enfermedades cardiovasculares: ' + informe.mortalidad.cardiovascular + '%</li>';
            if (informe.mortalidad.tumores) html += '<li>Tumores: ' + informe.mortalidad.tumores + '%</li>';
            if (informe.mortalidad.infecciosas) html += '<li>Enfermedades infecciosas: ' + informe.mortalidad.infecciosas + '%</li>';
            html += '</ul>';
        }
        
        if (informe.cobertura) {
            html += '<h4 style="margin:1.5rem 0 1rem;color:#1e293b;">Cobertura de programas preventivos</h4>';
            html += '<ul>';
            if (informe.cobertura.vacunacion) html += '<li>Vacunaci√≥n infantil: ' + informe.cobertura.vacunacion + '%</li>';
            if (informe.cobertura.cribadoColon) html += '<li>Cribado c√°ncer de colon: ' + informe.cobertura.cribadoColon + '%</li>';
            if (informe.cobertura.cribadoMama) html += '<li>Cribado c√°ncer de mama: ' + informe.cobertura.cribadoMama + '%</li>';
            html += '</ul>';
        }
        
        if (informe.autor) {
            html += '<div class="elab"><p class="elab-nombre">' + informe.autor.nombre + '</p>';
            html += '<p class="elab-cargo">' + (informe.autor.cargo || 'Epidemi√≥logo') + '</p>';
            html += '<p class="elab-entidad">' + (informe.autor.entidad || 'Distrito sanitario Granada-Metropolitano') + '</p></div>';
        }
    }
    
    return html;
}

// Generar conclusiones completas para PDF - Compatible con m√∫ltiples formatos
function generarConclusionesCompletasPDF(conclusiones, recomendaciones, nombre) {
    let html = '<div class="concl-grid">';
    
    const conclArray = typeof conclusiones === 'object' ? Object.values(conclusiones) : [];
    const recomArray = typeof recomendaciones === 'object' ? Object.values(recomendaciones) : [];
    const maxItems = Math.max(conclArray.length, recomArray.length, 1);
    
    for (let i = 0; i < maxItems; i++) {
        const concl = conclArray[i] || '';
        const recom = recomArray[i] || '';
        
        // Manejar diferentes formatos de datos
        let textoConclusion = '';
        let textoRecomendacion = '';
        
        if (typeof concl === 'object') {
            // Formato antiguo: {conclusion: '...', recomendacion: '...'}
            textoConclusion = concl.conclusion || concl.texto || '';
            textoRecomendacion = concl.recomendacion || '';
        } else {
            // Formato nuevo: solo texto de conclusi√≥n
            textoConclusion = concl;
        }
        
        // Si recomendaciones vienen por separado
        if (!textoRecomendacion && recom) {
            textoRecomendacion = typeof recom === 'object' ? (recom.texto || recom.recomendacion || '') : recom;
        }
        
        // Reemplazar nombre de municipio si es gen√©rico
        textoConclusion = textoConclusion.replace(/\[MUNICIPIO\]/g, nombre);
        textoRecomendacion = textoRecomendacion.replace(/\[MUNICIPIO\]/g, nombre);
        
        html += '<div class="concl-card">';
        html += '<div class="concl-num">' + String(i + 1).padStart(2, '0') + '</div>';
        html += '<div class="concl-tipo">Conclusi√≥n</div>';
        html += '<p>' + textoConclusion + '</p>';
        if (textoRecomendacion) {
            html += '<div class="recom"><div class="concl-tipo">Recomendaci√≥n</div>';
            html += '<p>' + textoRecomendacion + '</p></div>';
        }
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

// Generar priorizaci√≥n completa para PDF - Compatible con m√∫ltiples formatos
function generarPriorizacionCompletaPDF(prio, nombre) {
    let html = '';
    
    // Texto introductorio
    html += '<p>El <strong>Informe sobre la situaci√≥n de salud de ' + nombre + '</strong> y la <strong>Encuesta local de salud</strong> han facilitado el paso del diagn√≥stico a la acci√≥n.</p>';
    
    html += '<div class="prior-box">';
    html += '<h4>üó≥Ô∏è Resultado de la sesi√≥n de priorizaci√≥n del Grupo-Motor</h4>';
    
    if (prio.fechaSesion) {
        html += '<p><strong>Fecha de la sesi√≥n:</strong> ' + prio.fechaSesion + '</p>';
    }
    
    if (prio.participantes) {
        html += '<p><strong>Participantes:</strong> ' + prio.participantes + '</p>';
    }
    
    // Eje central
    if (prio.ejeCentral) {
        html += '<p>De acuerdo con lo acordado por el Grupo-Motor, se adaptar√° el dise√±o del plan de acci√≥n situando <strong>' + prio.ejeCentral + '</strong> en el centro neur√°lgico del plan.</p>';
    }
    
    // √Åreas prioritarias desde CSV (formato: objeto con √°reas numeradas)
    const areas = [];
    Object.entries(prio).forEach(([key, val]) => {
        if (typeof val === 'object' && val.area) {
            areas.push(val);
        } else if (key.match(/^\d+$/) && typeof val === 'object') {
            areas.push({num: key, ...val});
        }
    });
    
    if (areas.length > 0) {
        html += '<h5 style="margin-top:1rem;">√Åreas prioritarias identificadas:</h5>';
        html += '<div class="areas-grid" style="display:grid;gap:1rem;margin:1rem 0;">';
        areas.forEach((a, i) => {
            html += '<div class="area-card" style="background:#f8fafc;padding:1rem;border-radius:8px;border-left:4px solid #0074c8;">';
            html += '<strong>' + (a.area || a.AreaPrioritaria || '√Årea ' + (i+1)) + '</strong>';
            if (a.problema || a.Problema) html += '<p style="margin:0.5rem 0;font-size:0.9rem;"><em>' + (a.problema || a.Problema) + '</em></p>';
            if (a.justificacion || a.Justificacion) html += '<p style="margin:0;font-size:0.85rem;color:#64748b;">' + (a.justificacion || a.Justificacion) + '</p>';
            html += '</div>';
        });
        html += '</div>';
    }
    
    // L√≠neas estrat√©gicas seleccionadas
    const lineasSeleccionadas = Object.entries(prio.lineas || {}).filter(([id, l]) => l.seleccionada);
    if (lineasSeleccionadas.length > 0) {
        html += '<h5 style="margin-top:1.5rem;">L√≠neas estrat√©gicas seleccionadas:</h5>';
        html += '<div class="lineas-grid">';
        lineasSeleccionadas.forEach(([id, l]) => {
            html += '<div class="linea-card"><h5>L√≠nea ' + id + '</h5><p>' + l.nombre + '</p></div>';
        });
        html += '</div>';
    }
    
    html += '</div>';
    
    // Eje central destacado
    if (prio.ejeCentral) {
        html += '<div class="dest dest-azul" style="margin-top:1rem;">';
        html += '<strong>Eje central del Plan local de salud de ' + nombre + ':</strong><br>';
        html += '<em>' + prio.ejeCentral + '</em>';
        html += '</div>';
    }
    
    html += '<p>Al acompasar el Plan local de salud de ' + nombre + ' a la Estrategia, se incorporan de manera autom√°tica al mismo las <strong>l√≠neas estrat√©gicas</strong>, los <strong>objetivos</strong> seleccionados dentro de cada l√≠nea y los <strong>indicadores de contexto e impacto</strong> vinculados a cada objetivo.</p>';
    
    return html;
}

// Genera secci√≥n de participaci√≥n ciudadana para PDF
function generarSeccionParticipacionCiudadanaPDF() {
    const participacion = window.datosParticipacionCiudadana;
    const decision = window.decisionPriorizacionActual;
    
    if (!participacion) return '';
    
    let html = '';
    
    html += '<p>El proceso de planificaci√≥n ha incorporado la <strong>participaci√≥n directa de la ciudadan√≠a</strong> mediante una consulta popular que ha permitido identificar las prioridades percibidas por la poblaci√≥n.</p>';
    
    html += '<div class="prior-box" style="background: linear-gradient(135deg, #eff6ff 0%, #f5f3ff 100%); border-color: #818cf8;">';
    html += '<h4>üó≥Ô∏è Resultados de la consulta ciudadana</h4>';
    
    html += '<p><strong>Fecha de la consulta:</strong> ' + new Date(participacion.fechaVotacion).toLocaleDateString('es-ES') + '</p>';
    html += '<p><strong>Total de participantes:</strong> ' + participacion.totalParticipantes + ' personas</p>';
    
    // Objetivo prioritario
    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">';
    
    html += '<div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #c7d2fe;">';
    html += '<h5 style="margin: 0 0 0.5rem; color: #4f46e5;">üéØ Objetivo Prioritario</h5>';
    html += '<div style="font-size: 1.5rem; margin-bottom: 0.25rem;">' + participacion.objetivoPrioritario.icono + '</div>';
    html += '<div style="font-weight: 600; color: #1e293b;">' + participacion.objetivoPrioritario.texto + '</div>';
    html += '<div style="font-size: 0.9rem; color: #0074c8; margin-top: 0.25rem;">' + participacion.objetivoPrioritario.porcentaje + '% de los votos (' + participacion.objetivoPrioritario.votos + ' votos)</div>';
    html += '</div>';
    
    html += '<div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #c7d2fe;">';
    html += '<h5 style="margin: 0 0 0.5rem; color: #4f46e5;">üë• Colectivo Prioritario</h5>';
    html += '<div style="font-size: 1.5rem; margin-bottom: 0.25rem;">' + participacion.colectivoPrioritario.icono + '</div>';
    html += '<div style="font-weight: 600; color: #1e293b;">' + participacion.colectivoPrioritario.texto + '</div>';
    html += '<div style="font-size: 0.9rem; color: #0074c8; margin-top: 0.25rem;">' + participacion.colectivoPrioritario.porcentaje + '% de los votos (' + participacion.colectivoPrioritario.votos + ' votos)</div>';
    html += '</div>';
    
    html += '</div>';
    
    // Rankings completos si existen
    if (participacion.rankingObjetivos && participacion.rankingObjetivos.length > 1) {
        html += '<h5 style="margin-top: 1rem;">Ranking de objetivos:</h5>';
        html += '<ol style="margin: 0.5rem 0 0 1.5rem; color: #374151;">';
        participacion.rankingObjetivos.forEach(obj => {
            html += '<li style="margin-bottom: 0.25rem;">' + obj.icono + ' ' + obj.texto + ' <span style="color: #64748b;">(' + obj.porcentaje + '%)</span></li>';
        });
        html += '</ol>';
    }
    
    html += '</div>';
    
    // Decisi√≥n de priorizaci√≥n adoptada
    if (decision) {
        html += '<div class="dest dest-azul" style="margin-top: 1rem;">';
        html += '<strong>üìã Metodolog√≠a de priorizaci√≥n adoptada:</strong> ';
        if (decision.metodo === 'epidemiologica') {
            html += 'Se ha optado por basar el plan en los <strong>datos epidemiol√≥gicos objetivos</strong>.';
        } else if (decision.metodo === 'ciudadana') {
            html += 'Se ha optado por priorizar seg√∫n la <strong>consulta a la poblaci√≥n</strong>.';
        } else {
            html += 'Se ha optado por una <strong>integraci√≥n de evidencia epidemiol√≥gica y participaci√≥n ciudadana</strong>.';
        }
        if (decision.justificacion) {
            html += '<br><em style="font-size: 0.9rem;">' + decision.justificacion + '</em>';
        }
        html += '<br><span style="font-size: 0.85rem; color: #64748b;">Decisi√≥n adoptada el ' + new Date(decision.fechaDecision).toLocaleDateString('es-ES') + '</span>';
        html += '</div>';
    }
    
    html += '<p style="margin-top: 1rem;">La incorporaci√≥n de la voz ciudadana en el proceso de priorizaci√≥n refuerza la <strong>legitimidad democr√°tica</strong> del plan y favorece la <strong>apropiaci√≥n comunitaria</strong> de las intervenciones propuestas.</p>';
    
    return html;
}

// ============================================
// CABECERA INSTITUCIONAL UNIFICADA (5 LOGOS)
// ============================================
// Genera cabecera centrada con los 5 logos institucionales
// Usada en: Informe de situaci√≥n, Perfil de salud, Plan local
function generarCabeceraInstitucional(tipoDocumento, nombreMunicipio, opciones = {}) {
    const anio = opciones.anio || new Date().getFullYear();
    const periodoVigencia = opciones.periodoVigencia || '2026 ‚Äî 2030';
    
    // Obtener logos base64
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    const logoRelas = typeof LOGO_RELAS_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_RELAS_B64 : '';
    const logoViolencia = typeof LOGO_VIOLENCIA_B64 !== 'undefined' ? 'data:image/gif;base64,' + LOGO_VIOLENCIA_B64 : '';
    const logoRasselh = typeof LOGO_RASSELH_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_RASSELH_B64 : '';
    
    // Determinar t√≠tulo seg√∫n tipo de documento
    let titulo = '';
    let mostrarPeriodo = false;
    switch(tipoDocumento) {
        case 'informe':
            titulo = 'Informe de la Situaci√≥n de Salud';
            break;
        case 'perfil':
            titulo = 'Perfil de salud local';
            break;
        case 'plan':
            titulo = 'Plan local de salud';
            mostrarPeriodo = true;
            break;
        default:
            titulo = tipoDocumento;
    }
    
    let html = '<header class="header-institucional" style="padding: 1.5rem 2rem; page-break-after: always;">\n';
    html += '    <div style="display: flex; justify-content: center; text-align: center; flex-direction: column; align-items: center;">\n';
    
    // Logos institucionales centrados
    html += '        <div style="display: flex; justify-content: center; align-items: center; gap: 1.5rem; margin-bottom: 2rem; flex-wrap: nowrap;">\n';
    html += '            <img src="' + logoConsejeria + '" alt="Consejer√≠a de Sanidad, Presidencia y Emergencias" style="height: 170px; width: auto; max-width: 350px; object-fit: contain;">\n';
    html += '            <img src="' + logoDistrito + '" alt="Distrito de atenci√≥n primaria Granada-Metropolitano" style="height: 140px; width: auto; max-width: 350px; object-fit: contain;">\n';
    html += '            <img src="' + logoRelas + '" alt="RELAS - Red de acci√≥n local en salud" style="height: 150px; width: auto; max-width: 350px; object-fit: contain;">\n';
    html += '            <img src="' + logoViolencia + '" alt="Centros comprometidos contra la Violencia de G√©nero" style="height: 120px; width: auto; max-width: 350px; object-fit: contain;">\n';
    html += '            <img src="' + logoRasselh + '" alt="RASSELH" style="height: 140px; width: auto; max-width: 350px; object-fit: contain;">\n';
    html += '        </div>\n';
    
    // Branding COMP√ÅS
    html += '        <div style="text-align: center; margin-top: 1rem;">\n';
    html += '            <span style="font-size: 3.5rem; font-weight: 700; letter-spacing: 18px; text-transform: uppercase; color: #2c3e50; display: block; margin-bottom: 0.5rem;">COMP√ÅS</span>\n';
    html += '            <span style="font-size: 1rem; letter-spacing: 12px; text-transform: uppercase; font-weight: 300; color: #666; display: block;">Dise√±o ciudadano de la salud</span>\n';
    html += '        </div>\n';
    
    // T√≠tulo del documento
    html += '        <div style="margin-top: 2rem; text-align: center;">\n';
    html += '            <h1 style="font-size: 2rem; color: #0074c8; margin-bottom: 0.5rem;">' + titulo + '</h1>\n';
    html += '            <div style="font-size: 2.5rem; font-weight: 700; color: #2c3e50; margin-bottom: 0.5rem;">' + nombreMunicipio + '</div>\n';
    if (mostrarPeriodo) {
        html += '            <div style="font-size: 1.2rem; color: #666; letter-spacing: 4px;">' + periodoVigencia + '</div>\n';
    } else {
        html += '            <div style="font-size: 1.2rem; color: #666; letter-spacing: 2px;">' + anio + '</div>\n';
    }
    html += '        </div>\n';
    
    html += '    </div>\n';
    html += '</header>\n';
    html += '<div style="height: 6px; background: linear-gradient(90deg, #0074c8 0%, #00acd9 20%, #94d40b 40%, #ffb61b 60%, #ff6600 80%, #dc143c 100%);"></div>\n';
    
    return html;
}

function generarPortadaPLS(nombre) {
    return generarCabeceraInstitucional('plan', nombre);
}

// Extraer datos del informe desde Firebase o datosMunicipioActual
function extraerDatosInformeDesdeFirebase(nombre) {
    let html = '';
    
    if (datosMunicipioActual && datosMunicipioActual.informe) {
        const inf = datosMunicipioActual.informe;
        
        // Poblaci√≥n
        if (inf.poblacion) {
            html += '<p>' + nombre + ' cuenta con una poblaci√≥n de <strong>' + (inf.poblacion.total || 'N/D') + ' habitantes</strong>.</p>';
        }
        
        // Indicadores de mortalidad/morbilidad si est√°n disponibles
        html += '<div class="ind-grid">';
        if (inf.mortalidad) {
            html += '<div class="ind-card"><div class="ind-valor" style="color:#dc143c;">' + (inf.mortalidad.cardiovascular || 'N/D') + '%</div><div class="ind-label">Cardiovasculares</div></div>';
            html += '<div class="ind-card"><div class="ind-valor" style="color:#ff6600;">' + (inf.mortalidad.tumores || 'N/D') + '%</div><div class="ind-label">Tumorales</div></div>';
        }
        html += '</div>';
        
        // Cobertura de programas
        if (inf.cobertura) {
            html += '<p><strong>Vacunaci√≥n infantil:</strong> ' + (inf.cobertura.vacunacion || 'N/D') + '%. ';
            html += '<strong>Cribado colon:</strong> ' + (inf.cobertura.cribadoColon || 'N/D') + '%. ';
            html += '<strong>Cribado mama:</strong> ' + (inf.cobertura.cribadoMama || 'N/D') + '%.</p>';
        }
        
        // Epidemi√≥logo
        if (inf.autor) {
            html += '<div class="elab"><p class="elab-nombre">' + inf.autor.nombre + '</p>';
            html += '<p class="elab-cargo">' + (inf.autor.cargo || 'Epidemi√≥logo') + '</p>';
            html += '<p class="elab-entidad">' + (inf.autor.entidad || 'Distrito sanitario Granada-Metropolitano') + '</p></div>';
        }
    } else {
        // Datos gen√©ricos si no hay datos espec√≠ficos
        html += '<p>Datos del informe epidemiol√≥gico pendientes de cargar.</p>';
    }
    
    return html;
}

function extraerContenidoInforme(informe) {
    // Extraer datos clave del informe desde Firebase
    if (!datosMunicipioActual || !datosMunicipioActual.indicadores) {
        return '<p>Datos del informe pendientes de cargar.</p>';
    }
    
    const ind = datosMunicipioActual.indicadores;
    const nombre = getNombreMunicipio(getMunicipioActual());
    
    // Buscar indicador de poblaci√≥n
    const poblacion = ind['1'] || ind.poblacion || {};
    let html = '<p>' + nombre + ' cuenta con una poblaci√≥n de <strong>' + (poblacion.dato || 'N/D') + ' habitantes</strong>.</p>';
    
    // Indicadores de mortalidad
    html += '<div class="ind-grid">';
    const cardio = ind['7'] || ind.mortalidad_cardiovascular || {};
    const tumores = ind['8'] || ind.mortalidad_tumoral || {};
    const infecciosas = ind['10'] || ind.mortalidad_infecciosa || {};
    
    if (cardio.dato) html += '<div class="ind-card"><div class="ind-valor" style="color:#dc143c;">' + cardio.dato + '%</div><div class="ind-label">Cardiovasculares</div></div>';
    if (tumores.dato) html += '<div class="ind-card"><div class="ind-valor" style="color:#ff6600;">' + tumores.dato + '%</div><div class="ind-label">Tumorales</div></div>';
    if (infecciosas.dato) html += '<div class="ind-card"><div class="ind-valor" style="color:#ffb61b;">' + infecciosas.dato + '%</div><div class="ind-label">Infecciosas</div></div>';
    html += '</div>';
    
    // Cobertura de vacunaci√≥n y cribados (si est√°n disponibles)
    const vacunacion = ind['45'] || ind.vacunacion || {};
    const cribadoColon = ind['46'] || ind.cribado_colon || {};
    const cribadoMama = ind['47'] || ind.cribado_mama || {};
    
    if (vacunacion.dato || cribadoColon.dato || cribadoMama.dato) {
        html += '<p>';
        if (vacunacion.dato) html += '<strong>Vacunaci√≥n infantil:</strong> ' + vacunacion.dato + '%. ';
        if (cribadoColon.dato) html += '<strong>Cribado colon:</strong> ' + cribadoColon.dato + '%. ';
        if (cribadoMama.dato) html += '<strong>Cribado mama:</strong> ' + cribadoMama.dato + '%.';
        html += '</p>';
    }
    
    // Epidemi√≥logo (si est√° en informe)
    if (datosMunicipioActual.informe && datosMunicipioActual.informe.autor) {
        const autor = datosMunicipioActual.informe.autor;
        html += '<div class="elab"><p class="elab-nombre">' + autor.nombre + '</p>';
        html += '<p class="elab-cargo">' + (autor.cargo || 'Epidemi√≥logo') + '</p>';
        html += '<p class="elab-entidad">' + (autor.entidad || 'Distrito sanitario') + '</p></div>';
    }
    
    return html;
}

// NOTA: Las funciones generarConclusionesCompiladas y generarPriorizacionCompilada 
// han sido eliminadas porque conten√≠an datos hardcodeados de Padul.
// Ahora se usa generarConclusionesCompletasPDF y generarPriorizacionCompletaPDF
// que obtienen los datos desde Firebase.

// Generar indicadores clave desde Firebase
function generarIndicadoresClave() {
    if (!datosMunicipioActual || !datosMunicipioActual.indicadores) {
        return '<p>Indicadores pendientes de cargar desde Gestionar datos.</p>';
    }
    
    const ind = datosMunicipioActual.indicadores;
    let html = '<table><thead><tr><th>Indicador</th><th>Dato</th><th>Objetivo</th></tr></thead><tbody>';
    
    // Mostrar los primeros indicadores disponibles
    const indicadoresArray = Object.entries(ind).slice(0, 5);
    indicadoresArray.forEach(([num, i]) => {
        html += '<tr><td>' + (i.nombre || i.indicador || 'Indicador ' + num) + '</td>';
        html += '<td>' + (i.dato !== null && i.dato !== undefined ? i.dato : 'N/D') + '</td>';
        html += '<td>' + (i.tDes || '') + '</td></tr>';
    });
    
    html += '</tbody></table>';
    return html;
}

function generarKanbanCompilado(acciones) {
    const entornos = {sanitario: [], comunitario: [], educativo: [], laboral: []};
    const iconos = {sanitario: 'üè•', comunitario: 'üèòÔ∏è', educativo: 'üéì', laboral: 'üè¢'};
    
    acciones.forEach(a => {
        if (entornos[a.entorno]) entornos[a.entorno].push(a);
    });
    
    let html = '<div class="kanban">';
    for (const [ent, acts] of Object.entries(entornos)) {
        html += '<div class="kanban-col ' + ent + '"><div class="kanban-head">' + iconos[ent] + ' ' + ent.charAt(0).toUpperCase() + ent.slice(1) + ' (' + acts.length + ')</div>';
        acts.slice(0, 5).forEach(a => {
            const prioridad = a.prioridad || 'media';
            html += '<div class="accion ' + ent + '"><div class="accion-nombre">' + a.nombre + '</div>';
            html += '<div class="accion-tags"><span class="tag ' + prioridad + '">' + prioridad.charAt(0).toUpperCase() + prioridad.slice(1) + '</span>';
            if (a.trimestre) html += '<span class="tag">' + a.trimestre + '</span>';
            html += '</div></div>';
        });
        if (acts.length > 5) html += '<p style="font-size:0.7rem;color:#94a3b8;text-align:center;margin-top:0.5rem;">+' + (acts.length - 5) + ' m√°s...</p>';
        html += '</div>';
    }
    html += '</div>';
    return html;
}

function generarCronogramaCompilado(acciones) {
    const trimestres = {T1: {s:0,c:0,e:0,l:0}, T2: {s:0,c:0,e:0,l:0}, T3: {s:0,c:0,e:0,l:0}, T4: {s:0,c:0,e:0,l:0}};
    const mapEnt = {sanitario:'s', comunitario:'c', educativo:'e', laboral:'l'};
    
    acciones.forEach(a => {
        const t = a.trimestre || 'T1';
        const e = mapEnt[a.entorno];
        if (trimestres[t] && e) trimestres[t][e]++;
    });
    
    let html = '<table><thead><tr><th>Trimestre</th><th>üè•</th><th>üèòÔ∏è</th><th>üéì</th><th>üè¢</th><th>Total</th></tr></thead><tbody>';
    let totales = {s:0,c:0,e:0,l:0};
    for (const [t, v] of Object.entries(trimestres)) {
        const total = v.s + v.c + v.e + v.l;
        html += '<tr><td><strong>' + t + '</strong></td><td>' + v.s + '</td><td>' + v.c + '</td><td>' + v.e + '</td><td>' + v.l + '</td><td><strong>' + total + '</strong></td></tr>';
        totales.s += v.s; totales.c += v.c; totales.e += v.e; totales.l += v.l;
    }
    const grandTotal = totales.s + totales.c + totales.e + totales.l;
    html += '<tr class="tabla-total"><td><strong>TOTAL</strong></td><td><strong>' + totales.s + '</strong></td><td><strong>' + totales.c + '</strong></td><td><strong>' + totales.e + '</strong></td><td><strong>' + totales.l + '</strong></td><td><strong>' + grandTotal + '</strong></td></tr>';
    html += '</tbody></table>';
    return html;
}

// Logos institucionales en base64

const LOGO_CONSEJERIA_B64 = (
    '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' +
    'LJrschm80pEJbhIsCDBWA9ibvRxtaN9L32QEjETG2dT/ACcxYwMU0a4RObOpLJMZ7to+gKrWrEAZG+oy' +
    'DqlTuz2Qt0HxV3DrQTI0TU5LTUunzWlgLjLDEi2+g+HSTYp4Y9aiP08zeyYUnNxXNAvTy30d3geaVb3p' +
    'IULFsjhQPBNXFxKhsb0yZbyUYJUDjxtZ/VGavgt0Wf1lTf8AvSwZMaISBE6fIkt7Ul8CWIQMzG32+JwO' +
    'AfSIC4glYsMeGxKKKVs8hhO//OJBhKjHNcijEUUokJh+9mcwhZqKG/kHBN1zHqU7lelh4DMYumTXhNVR' +
    '2shHZC4cak8JMZTlSmayfkQFvip9ejDCWbuTo3pjerAW063Impn1R5qsXZyGWpNS4nFcsFmM2VNMwL2k' +
    'Zsu/pSYkrQQm/vT4bZTCJx8+VS2CFwnPHzSrRNFIjVDjSnOQmbhNj2oC4A8Z2A5lN2AZa5/rfU+aBrOe' +
    'JQhxVdEE8iaKCREoVjGe96scySgkydFTiFBWzn+/dptIrIL9d9B23hurHenhNVRsikKRqpvctGA5FeNu' +
    'V3jXvlTGsYBghJ4PMqQzhq6EWM8q8PeqX4RDy8salGl/X4Qa1CZIMRuO3etTTBWXm9b++kBfoabtNsMS' +
    'R2GsfOLuWvHHnV61Wy4qg/L2cVParEgXrRMONqTNjy7LS1qRnwYR4y6fd2MqgcXhZfIoGu3RFYucg0a/' +
    'oKYcDGiTHrWqzo7CjS8azG82K3ZeFQmHNqRK9INrEYwSna2VKG2GSiMKKosjVYb6HRukpcojNQSrHlgI' +
    'mcpmK1ss3f270fHlMYC9KQmkMW+cKG7dQzjLV26zMPLLlU8zgSMzOOONR5Pa3ggR1pmNg6ewqEcUqs2t' +
    'ioHrJtL3H3eFt+VxR/mJSIBI8qzADGY7f87/AP/aAAwDAQACAAMAAAAQ888888888888888888888888' +
    '8888888888888888888888888888888888888BMIB888888888888888888888qCDG88888888888888' +
    '888888mBCjU88888888888888888888KCUCCL888888888888888888ECCEIDz888888888888888888' +
    'rCWcmDXB8888888888888888LACI8RpDL8888888888888888LCFG88bDA888888888888888iBCZ888' +
    'WCTO88888888888888ACAH8BSTJIh88888888888888CCX8UNCLCzQP8888888888880CDA8888BBDBH' +
    '8888888888883BV8888888hBL888888888888888888888888888888888888888888NNN8888888888' +
    '88884w80w4w8s400Ic04480888888oAMocIs8goQggYgcckU8888888880gM4sw44884488888888888' +
    '88soYMYQcAUIoc8888888888888s88888s8888888888888888888888888888888888888888888888' +
    '88888888888888888888888888888888888888888//EACgRAQABAwIGAQQDAAAAAAAAAAEAETFBECEw' +
    'QFFxkbHwIFBhcMHR8f/aAAgBAwEBPxD77XRQnwDPgGECw8tQRY96bJ1m/wC/pypu8R3uOuU4bbOVqIe7' +
    'pSR0/wAgqoyoqTrLnvyYIrEZs2m8t3eV5LbtKaM7nJ0APd0phjOm3b+mjEYYRCzyIBViKrzpuC760FlZ' +
    'iMY03vf0xyNLF31o5wAFDWmTOzpSxts/rkFAqx30VtXfX0Blcd4KSoqQvO9+PsG760QjmAAYiqKMVuvM' +
    'FZeZdmveK5XxETZlNXufzx68lsaUBfY0QB83glnNwV4lNBZ0kMIhZ4u0l3bRDGYAix9ObJkE6aAKMTIe' +
    'mOLYFZ+P4jdQHgLVRWfj+JYNPtQyqVSqL+0//8QAIhEBAAICAgIDAAMAAAAAAAAAAQARECExQTBAIFBh' +
    'UXCB/9oACAECAQE/EPvTNs/efrBvZ61tHWLrS6nqiyxK24oSj1W0OFozQPpkFYyLG/eWUYbPTUgcUpi6' +
    '2LFwb36KgWxUWNq94S9SqmLqfx6NdHeKEgVozswo9AtbZYuN47+FgZ3Hn0p3hzEAFEZEivbA+FOwuVWy' +
    'oN8Tk861esaV4CsIN2iPKyvCDdnm15y4YBCIHx58ibb4FGyf4/l4Bc/BFrDwJbSfknAK+rqVK/tT/8QA' +
    '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' +
    '9W8gsuxEzBvGm2mRpJUMoQhKSY4LbYWYWAFQ2kVM5vOPeotKMHBdr3+74aZGBhe8njMo15bgh2mu0fRA' +
    'cfQDuMkrEzHGS4Snpdukn95+1y/1fT9MJLTWQM6gQpl6TnBvwiFkgtGEpxgmcmGmaeoeSs0LKEhKzRKX' +
    'BkJ3uNAAasC6FNhvYpCQfMlB6jrjdJCyrCcAhhHWnIJTICGXVc1HGW77IfT3OYV+Rh2taRRlHBoeTCkv' +
    'BikJBI2Y3/OsLMzShEGpbmIxQHLt5AqkkfaYMJm8vYTPax1sRKxhgZx2oVsBpgDA2+71y++UmA6spJBZ' +
    '1kKD3ICk+7EuTIslIYIYezn+9/4xuJIeZqTrbIVL92xJC6ox37qvK2FF4lFCjA4Dq1kKyfKTtw3DyMnt' +
    'gvaQdAqBFhSxzbEbdv29LkroqiahxMp8bTJTCwzCgTM8QeMYvTEz1AqWVxCVGBIlNDwoiuECjNURCWYD' +
    'K7r1dI5T1Yip1zlpF2KuFmxEe7uMHog6YuYFJCxapUrO8Te3rEAmwBv5px4My9P2gvuE++cRE1tBBJRv' +
    'rzhnpyhzIwBTqZhvf3dtN5LmbAW+v8cGdVz9FSJ3yMcsB06nB7YAEH/rt//ZICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg' +
    'ICAgICAgICAgICAgICAgIA=='
);

const LOGO_DISTRITO_B64 = (
    'UklGRqIPAABXRUJQVlA4WAoAAAAgAAAAywAAvwAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZ' +
    'WiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAA' +
    'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAA' +
    'ACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAA' +
    'AChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAA' +
    'AAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAA' +
    'AAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAA' +
    'E9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBu' +
    'AGMALgAgADIAMAAxADZWUDggtA0AALBEAJ0BKswAwAA+USKPRaOhoRIrDgg4BQSm7dXryq3zzXoOq/kB' +
    '+VXYqbed2Pxc6500PS/97+5z2gPaj5gH6Rf4bqN+YD9Vf3I93L+hf73+8e5L0AP5X/X///2EHoAfyX/M' +
    'f//1zP3A+Fr90v2Z9n3//60D48/u3Y9/R/yi/onp34ZO8fsByF4i/x76p/Z/y7/un7d/Gf+j8IeAF+O/' +
    'y/+y/lbwV7IHwBesX0T/Rf279vfL+/k/Qn6lf5j3AP49/L/8z+Y/Mi/Xf9f+jvwBfyj+i/5f+9fvB/hv' +
    'pV/lv/J/l/Oz+c/4z/tf5z4Bv5X/Tv999xvgE/eH2Pv20M5iHBzUc1HNROOVb92zlSlDjlHTxuUc9owA' +
    'HeBRP/myUkT/4nI5I+RAHbi8Ho8zaijJ//wf8oSYedPedoAjn3bLwo0Ul4N8ixLHkpMwEDs96GVOMhqN' +
    'myFBgbTGezLPjnUqHheIOYcfzIH3ugorMD5FvdZM4V3D6BAzngFFMfOv/y8TWE+iCBzmR/9S9TUrci1R' +
    'kdG0XvP9VcsAjXOKXUHBvu+kiJdORS3yUz0ZdVmPDQ/NaMTgk+RqiXA90MbWA2Ke0doZ8EFVg7qdc0LU' +
    '9QM1QREg+bruI7BK/S/DZbFa/LNGZK6rtLqd4Iu7BKMUeSXW5W7F7CgsZVLx7RolV8poTGyGKvS/qqkS' +
    'Okr4t8X8T60R7pftAPfL9z4XPbMXLPb10kBvh0HCaM4VyFchXIVoAAD+/cCAAAH4PKR2mme7l179T4sU' +
    'nL4ZHntmJw1+e5m4L9WbcD+hVJ/+HWNCYEeX2erpZN8w+McXVNU4OlXLzuLmsofl4mRQfTy3OgA2aTU2' +
    '7JXbDtgS/WmX1zbWuW5KdJCHMrgf/2a1zaAcl2uLYhi1dUo10JDuHxtdTUZxIrslabt6Go3mMd9Kn8fl' +
    'wYFQbdCmPDeJB1wEx/SgJzRmMQGyiAFe4CyGC4n3HL3iYz7+2r3EYZ/N7kbGNf7XDqmXA19QvWBBeTki' +
    '/ZUhAV8ZxlIeFc9drZcPHK9txeGZ0jmrf5JumYqSTs2mqGy2cUPIppXLlg5iMy9UfHwKWTTSnWIjVQH9' +
    'PO76tBYO6bSXp8FL1WYUy6CjrLhTHo11tIXUf4H9cE0ty3v+Jy99+ED5xI8X9xZzi2seJArQZK2PXVQT' +
    'phz/cgasQVPVEJOnFisdwuwugVE5BlMuZRVjTjGPYXwLmoKPmpUrb6I9qTvmua2d1ORd/AwGJ/0a0Ivo' +
    '/sCrxyZa3d8CNQ445qbXmydmOPxkE0P8yCpiI6F2QMkisRAJmTSdfbCMcDasAiXASmvoSVBPpOKQf8uz' +
    'wQ6qc4OH0yCbROdDLBgBSYvEghriiJuqoE5ZvqLH0MfaQAB39VVycFG15BdoPmcgFprMH5/uom032MYv' +
    'TBwBNpe6BGN1T+QOwTxQZUnpfJMv7ADF5XVl8Ltw9F0BLs5csWwndYY/VPvoZ0YvSWZ63TFeKQvz/mMT' +
    'fLl6L3aKka6AI64iiTkd/riPUTpJFb0RDDUQAJ1yGJB/HgoBLMkfyim5IHQbk8YIChbFdSr32Lt1xKSB' +
    'ox1yxP42BZvkQMeuDmkuMvDvTd8+B5QTxy6ik0XSbxt6Tqx2f7cvXmcAJg9nJfnRmVcMg9NaADT4wFQs' +
    'Fdz+AjBm60yTyGK2RcbbygbJh4F4kXoNfGurCQeSr/tzUau0bAI1SwRNXrbMNAkxD8DU0ILbs2eX/F0Z' +
    'P0oLdBZNv1hAiI5d8ifAAY23y5pGv7zLc+4ini3MjZoPasLadLrDnZXxYaOhg9jvIE9qqVKouQ1A4nON' +
    'Lg7FkpdgKvV7DUeaB+hPnO3v8KuZcsrKEcF4BLxf0scNs+DcKYfktMIXnpbl4seAiK+wtG4+4IUcorDE' +
    'efcAhBbxwyLOP5ZvdvIq2XP1+nXUnXkYqKWDhHF/esKQIxWliuypfLB95BGrsskmIkznXNxKxg1wQ8rN' +
    'ftmz38I/weX/xXWs8qzyOv5Fq6Eso6AfObLrWPibDzdR9/1EzDksiEPs5dv8oQhZ5jEzANa22aXd4oo8' +
    'PR0NBNgr8hBVLwumMzzDaGrwSkrZlOpJWiuCYaRVB/H3mWZ1eEQDHcEs7NmwsUhoPg6VP6GDbvJAGqnI' +
    '2DxOJ3FxQiPrtU9C2drT8IX7Upkd6K/JXivOVdnmSBfZ9zJG228OPEqX/Df4GZp7nnb0oYBf0MVTKlQu' +
    '048Iw5R9VHS+8NPVU48lA/w2hQkkkLAk2JtiTWj+OMYO3fhHWI+cK7w57eyfReOkfke2moshWoZDUjbj' +
    'QL0z5b77e+CY7pLYsoGwBjvbsn6WoG9uRP7xNqbM4xAbY5D3aAsXMAtgfCUAA/5Oop91DRrdv87xSIp+' +
    'pWnNBMGR7XNot8l/IrTRrVjcPXps1JQq9zlxx+NU/1YZWK0KKd7DjAv9WNwPrOa53NeH6gMKJsKr1exw' +
    'moEy8NJHWnws9fzHfSTmUEgAAhBUbOBq4NAz1yer9Zc6UUS3UqsWQXIJ+/vKgAIIWtfBpew4m5Hrt0Ix' +
    '9Wve61m3cYTpOySOm7kBWaBOF8yMgqKGA0LX3TAGfolP3+9/w3VSiPiU6jk39AIM93CfA5qVtFPcyGmh' +
    'Zkr/PTptpP3U4wJZ9QK1nHaV86GjgTdPJWU4uzdtg/S6DAeV8nRKmQ/Hr0YlRHzmKrHEYKe4A1/DeON0' +
    'AAbxtTf9AQkEBewI/v6a1l06XWho0XgWZ1jzUMH7wOKffD0pJ9A+1nssKYauRbt2Bs61eCbK7eHfvus3' +
    'Vy5hLEQqJGhh/g+oYDPFVW7KwhUfmHfEbp4+6wipzidAA51SwGu5wzSaCMnwy0yZVN0V06tZ3QNHhqxh' +
    'TyAl2LW5FxHnVucu+PEaa5mIR0HnHK5KLc4wZufpESPyovi4TOHsOfpKyV0CyXKKjeclf1LlMu3DXmwF' +
    '8t0Cv+llcmuzRFRlt5P5gpkSWwlESUB2902ipEQTOMLnS7laFjw5Bk6JgxqWaoNtQis+MZtV451oq9qS' +
    'oCjwZd9ruAUo5zE+h7uF+vCM3QgWInOt+nXBtXVdgm+HOtJN8T7LJVtZHW6afzsGGfIQVpuYfB0Vs542' +
    'Gg/llVVvgzeT0lY5tl6aZf6IyTyHlwnoLHblPjALx7+YfzJOsvQt63aNW/m2lM13bbXtOD2qI2xIm+rB' +
    '+xUX6Ukvg/VLNUsxCwmXvGlbFWh0f5FPr8rNJWgBeNGXmL1GcgIELTny5JaTgQ/2b7ZS6bGc+ej42vNs' +
    '9xWJeXLu/Fx3P/WV7krrnK/SAsJy3U5u26AlJVzVYysSnvRcTtkD1ht81TQ+vlBhK6yFsakazl+iIHMC' +
    'ixLCPA+e9Xuq0knbKOReJM7PAuZciYhAybEWYvJlec9KusR7etcz0kATu+Zp3cylS90D+DXPdBvOuzJN' +
    'YpafZJRmeKG/6lPyYc0xaQAwsb4kcE7/pxTMdoyo+SLvRx0rzRYXp30pEVVqwzfnqLOH8TM0nTl80Y1z' +
    'gvoZLtOp8/rcPpyyOimKhIOnl6eM8L/wL5FklZAf2mrr39335SS19b7sxm0SiUdZ0bTfX/8oChSf9Ate' +
    'uZC/b/IdfZoDpv4nEqY+6GMHUMNxK6+x+vh4QAi/56ZqmZBz7z06WELxaFEetzTf+YK3Mtw9VvB3H14g' +
    'sWy990KZe8fc3+5j684o55yb3P2ZWHvvTbGXLb/Ed3JN42F2xSl6kiU2si6BEbIUs9E9HPC2Q5Ea+Ugv' +
    'aiV9eIQJpXWnl5HlpFt4XThR5NqHz9/eX59z14H2s7ia1Yg7dgk0C5expA+kSiKlA8EBTqkuH1Y/WL8q' +
    'w/xJaP+ZC7eTiJT/pMY7eyY0YK30c6roS9/kzBDdSGQRTLkfOw4ml08w2m6Aeyp/EvT+SQXh1cC/FjK1' +
    'Huf/F9azWIlmWAYT/fuU9UzFSQVXps95G3Ta/vMnbXaHpAvVmj/5Wa+RKXdXm0+fj7dPzMAwikdR/phO' +
    'EWDblYYBLBv/xZmkZRC+gx6PZuGY9YxUy+GAN0XCbiEWrC5Oy4D4Oedf11hL6V9xczAgeXc8IHZvxBfM' +
    'KdY3YU6dvnYMcSMvVEGNXbiE8FBCiL4ZrqHwx4RZESIY9MafBexWsS7CO1oQLeV/k1MtZoay6ZYMnZk3' +
    '/9/4O80rBu0WuIDOlf4k8wjoJBMXIQmI1n0DiTfLHzuHrDM0Z3Zc5yslpn8AlzJd5z6BMAHW8zz7/+zd' +
    'uyOHabTKDAUkCdLEM/lhb3SXpLMEPHEJtqtmVd/C3+aCG28NE6ffR5tiOMApn/qLAuoG9ln/zPx1m4C/' +
    '/GckoXT5gx+asXqygEjGFVa2P3i6bYwTHqGEf/vu1wz/Gz3YgqYGB/znXdkwcyWJZXbPZouYsLc09sc3' +
    'JjyOMWIrvikOY5zGgRCoway9gD66JO9v9jRKCEVc9qPfxaBwwjf6L7oxgUVlB59Q/eG/jzwKtGR0cONU' +
    'JjkumJx4BpqNrKGpqhHtnVFW/kra2pNgSi9H9Yeg4eWaGp7ING30ycYw64AzmAH0iRXYj5Zy/DyLJELr' +
    'EqYD6s5UJFmxk61eix8jJ5ESoOBvH6BU7hP7eIbMQRddn/Pyv3ArqRrInT7hVMV/XBm9Qjf/80Mu/656' +
    'BOLWJMr/fvzr45a/MyiKJgfiBpbJz2y/ew1TfxKoFCHuHsUKybwOp3ongMOQAAAAAAA='
);

const LOGO_RELAS_B64 = (
    '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' +
    'Zx3CstMcUNp0OQrIhWgUCgUH/9k='
);

const LOGO_VIOLENCIA_B64 = (
    'R0lGODlhGAO+AHAAACH5BAEAAP8ALAAAAAAYA74AhwAAAAAAMwAAZgAAmQAAzAAA/wArAAArMwArZgAr' +
    'mQArzAAr/wBVAABVMwBVZgBVmQBVzABV/wCAAACAMwCAZgCAmQCAzACA/wCqAACqMwCqZgCqmQCqzACq' +
    '/wDVAADVMwDVZgDVmQDVzADV/wD/AAD/MwD/ZgD/mQD/zAD//zMAADMAMzMAZjMAmTMAzDMA/zMrADMr' +
    'MzMrZjMrmTMrzDMr/zNVADNVMzNVZjNVmTNVzDNV/zOAADOAMzOAZjOAmTOAzDOA/zOqADOqMzOqZjOq' +
    'mTOqzDOq/zPVADPVMzPVZjPVmTPVzDPV/zP/ADP/MzP/ZjP/mTP/zDP//2YAAGYAM2YAZmYAmWYAzGYA' +
    '/2YrAGYrM2YrZmYrmWYrzGYr/2ZVAGZVM2ZVZmZVmWZVzGZV/2aAAGaAM2aAZmaAmWaAzGaA/2aqAGaq' +
    'M2aqZmaqmWaqzGaq/2bVAGbVM2bVZmbVmWbVzGbV/2b/AGb/M2b/Zmb/mWb/zGb//5kAAJkAM5kAZpkA' +
    'mZkAzJkA/5krAJkrM5krZpkrmZkrzJkr/5lVAJlVM5lVZplVmZlVzJlV/5mAAJmAM5mAZpmAmZmAzJmA' +
    '/5mqAJmqM5mqZpmqmZmqzJmq/5nVAJnVM5nVZpnVmZnVzJnV/5n/AJn/M5n/Zpn/mZn/zJn//8wAAMwA' +
    'M8wAZswAmcwAzMwA/8wrAMwrM8wrZswrmcwrzMwr/8xVAMxVM8xVZsxVmcxVzMxV/8yAAMyAM8yAZsyA' +
    'mcyAzMyA/8yqAMyqM8yqZsyqmcyqzMyq/8zVAMzVM8zVZszVmczVzMzV/8z/AMz/M8z/Zsz/mcz/zMz/' +
    '//8AAP8AM/8AZv8Amf8AzP8A//8rAP8rM/8rZv8rmf8rzP8r//9VAP9VM/9VZv9Vmf9VzP9V//+AAP+A' +
    'M/+AZv+Amf+AzP+A//+qAP+qM/+qZv+qmf+qzP+q///VAP/VM//VZv/Vmf/VzP/V////AP//M///Zv//' +
    'mf//zP///wAAAAAAAAAAAAAAAAj/APcJHEiwoMGDCBMqXMiwocOHECNKnEixosWLGDNq3Mixo8ePIEOK' +
    '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'
);

const LOGO_RASSELH_B64 = '/9j/4AAQSkZJRgABAQEAYABgAAD/4QBaRXhpZgAATU0AKgAAAAgABQMBAAUAAAABAAAASgMDAAEAAAABAAAAAFEQAAEAAAABAQAAAFERAAQAAAABAAAXEVESAAQAAAABAAAXEQAAAAAAAYagAACxj//bAEMAAgEBAgEBAgICAgICAgIDBQMDAwMDBgQEAwUHBgcHBwYHBwgJCwkICAoIBwcKDQoKCwwMDAwHCQ4PDQwOCwwMDP/bAEMBAgICAwMDBgMDBgwIBwgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDP/AABEIAWIF6QMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/AP38ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAoorjPiN+0L4L+E7PHr3iLT7K5jGTbBzNce37tMuM+pGK0pUZ1JctNNvslcxr4ilRh7StJRXdtJfezs6K+fdR/wCClPw6spgscXiO8XON8NkgUf8Afcin9K3PCX7fPwz8VXSwtrNxpcj/AHft9q0a/i4yo/EgV3SyfHRjzOlK3ozy6fEmVzlyRxEL+qPZqKq6Lrtj4k02O80+8tb+zmGY57eVZY3Hsykg1arzmmnZnsxkpK62GySLDGzMyqqgkknAA965HwF8fvB3xP1660vQfEFjqV9ZgtJDHuUlQcFkLAB1HHK5HIroPFvh6Pxd4V1PSppJIYdTtJbR3T7yLIhQke4zXzv+zJ+wrqnwU+Lq+I9U1uwvIdPSVLOK0Dhpi6FMyBgAuFYnaC3OOeOfjs+zPPcPmeDw+W4ZVKFSTVWbdnBaarVbK72d7W0epEpTUkorQ+mKKBwK83/at/ah8M/sf/BXVPG3iiZltLICK1tYyPO1K5YHy7eIHqzYJz0VVZjwpr62pUjTi5zdktycRiKdCnKtWfLGKu29kkejs4RSzHCrySe1cFqn7Vfwv0TVfsN78SPANnfbiv2efxDaRy5HUbTJnP4V+Ef7Y3/BSX4nftneILr+3NauNJ8MNITa+HtPmaKxgTsJMYM746vJnknaFB2jwGvjcTxhFStQp3Xdu1/kfkWY+LMI1XHBUOaK6ydr/JLT5v5I/qM0PX7HxPpcN9pt5aahZXAzHcWsyzRSD2ZSQfwq5X80HwJ/aW8efsz+KU1jwN4o1Xw9eKwaRbeXMFyP7ssTZjkXgcOpHFftl/wTC/4KZaX+3j4LudP1SC10X4g6DEJNR0+Jj5N7DkL9qgB52biAykkoSvJDKT6eVcRUcZL2Ulyy7bp+j/Q+l4Y4+wmbVPq1SPs6r2Td0/R6a+TXpc+raKKK+iPvgooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACmyyrDGzMyqqgksxwAB1Jp1fMv/BRz49SeDPCFr4P02Z4dQ1+Pzr10OGjtASu3P8A00YEH/ZRgetdmX4KeLrxoQ6/gurPNzbMqeAwk8VV2j07vovmzg/2rP2+77XtQufD/gW6ksdOhcxz6rE22a7I4IiP8Cf7Q+Zu2B1+XLi4ku53lld5JJGLO7nczE9ST3NMor9ewOX0MJT9nRVu76v1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RRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABTXhWRgxHzL0NOooAAaKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/2Q==';


// Cargar logos al iniciar
// Funci√≥n helper para obtener data URIs de los logos (no usada actualmente pero √∫til para futuras necesidades)
function obtenerLogosDataURI() {
    return {
        consejeria: 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64,
        distrito: 'data:image/png;base64,' + LOGO_DISTRITO_B64,
        relas: 'data:image/jpeg;base64,' + LOGO_RELAS_B64,
        violencia: 'data:image/gif;base64,' + LOGO_VIOLENCIA_B64,
        rasselh: 'data:image/jpeg;base64,' + LOGO_RASSELH_B64
    };
}

function cargarLogosInstitucionales() {
    // Cargar logos del header
    const imgConsejeria = document.querySelector('.logo-institucional.consejeria');
    const imgDistrito = document.querySelector('.logo-institucional.distrito');
    const imgRelas = document.querySelector('.logo-institucional.relas');
    const imgViolencia = document.querySelector('.logo-institucional.violencia');
    const imgRasselh = document.querySelector('.logo-institucional.rasselh');
    
    if (imgConsejeria) imgConsejeria.src = 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64;
    if (imgDistrito) imgDistrito.src = 'data:image/png;base64,' + LOGO_DISTRITO_B64;
    if (imgRelas) imgRelas.src = 'data:image/jpeg;base64,' + LOGO_RELAS_B64;
    if (imgViolencia) imgViolencia.src = 'data:image/gif;base64,' + LOGO_VIOLENCIA_B64;
    if (imgRasselh) imgRasselh.src = 'data:image/jpeg;base64,' + LOGO_RASSELH_B64;
}

document.addEventListener('DOMContentLoaded', cargarLogosInstitucionales);

// ============================================
// FUNCIONES DE EXPORTACI√ìN - FASE 1
// ============================================

// Funci√≥n auxiliar para crear documento HTML para impresi√≥n/exportaci√≥n
function crearDocumentoExportacion(titulo, contenido, estilosExtra = '') {
    const municipio = getMunicipioActual();
    const nombre = MUNICIPIOS && MUNICIPIOS[municipio] ? MUNICIPIOS[municipio].nombre : municipio || 'Municipio';
    const fecha = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' });
    
    return `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>${titulo} - ${nombre}</title>
    <style>
        @page { size: A4; margin: 2cm; }
        body { font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.5; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #0074c8; font-size: 18pt; border-bottom: 3px solid #0074c8; padding-bottom: 10px; margin-bottom: 20px; }
        h2 { color: #0074c8; font-size: 14pt; margin-top: 20px; }
        h3 { color: #333; font-size: 12pt; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #0074c8; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        .header-doc { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
        .header-doc h1 { border: none; margin-bottom: 5px; }
        .header-doc p { color: #64748b; margin: 5px 0; }
        .footer-doc { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center; color: #64748b; font-size: 9pt; }
        @media print { .no-print { display: none; } }
        ${estilosExtra}
    </style>
</head>
<body>
    <div class="header-doc">
        <h1>${titulo}</h1>
        <p><strong>${nombre}</strong></p>
        <p>Generado el ${fecha}</p>
    </div>
    ${contenido}
    <div class="footer-doc">
        <p>COMP√ÅS - Dise√±o ciudadano de la salud | Distrito sanitario Granada-Metropolitano</p>
    </div>
</body>
</html>`;
}

// Funci√≥n para descargar como Word (HTML con extensi√≥n .doc)
function descargarComoWord(html, nombreArchivo) {
    const blob = new Blob(['\\ufeff', html], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreArchivo + '.doc';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Funci√≥n para descargar como PDF (abre ventana de impresi√≥n)
function descargarComoPDF(html, titulo) {
    const ventana = window.open('', '_blank');
    ventana.document.write(html);
    ventana.document.close();
    ventana.focus();
    setTimeout(() => {
        ventana.print();
    }, 500);
}

// Funci√≥n para imprimir directamente
function imprimirContenido(html) {
    const ventana = window.open('', '_blank');
    ventana.document.write(html);
    ventana.document.close();
    ventana.focus();
    setTimeout(() => {
        ventana.print();
        ventana.close();
    }, 500);
}

// === EXPORTAR INFORME DE SALUD ===

function exportarInformeWord() {
    const contenido = document.getElementById('contenido-informe-dinamico').innerHTML;
    if (!contenido || contenido.includes('Selecciona un territorio')) {
        alert('No hay informe cargado para exportar');
        return;
    }
    const html = crearDocumentoExportacion('Informe de Situaci√≥n de Salud', contenido);
    const municipio = getMunicipioActual() || 'municipio';
    descargarComoWord(html, 'informe_salud_' + municipio);
}

function exportarInformePDF() {
    const contenido = document.getElementById('contenido-informe-dinamico').innerHTML;
    if (!contenido || contenido.includes('Selecciona un territorio')) {
        alert('No hay informe cargado para exportar');
        return;
    }
    const html = crearDocumentoExportacion('Informe de Situaci√≥n de Salud', contenido);
    descargarComoPDF(html, 'Informe de Salud');
}

function imprimirInforme() {
    const contenido = document.getElementById('contenido-informe-dinamico').innerHTML;
    if (!contenido || contenido.includes('Selecciona un territorio')) {
        alert('No hay informe cargado para imprimir');
        return;
    }
    const html = crearDocumentoExportacion('Informe de Situaci√≥n de Salud', contenido);
    imprimirContenido(html);
}

// === EXPORTAR MIEMBROS DEL GRUPO MOTOR ===

function obtenerHTMLMiembros() {
    const tabla = document.getElementById('tabla-miembros');
    if (!tabla || tabla.innerHTML.includes('No hay miembros')) {
        return null;
    }
    
    // Obtener miembros de Firebase
    const municipio = getMunicipioActual();
    let html = '<table><thead><tr><th>Nombre</th><th>Email</th><th>Tel√©fono</th><th>Organizaci√≥n</th><th>Cargo</th><th>Sector</th></tr></thead><tbody>';
    
    const filas = tabla.querySelectorAll('.miembro-item, tr');
    if (filas.length === 0) {
        return null;
    }
    
    // Si tiene formato de tabla
    const tablaMiembros = tabla.querySelector('table');
    if (tablaMiembros) {
        return '<h2>Listado de Miembros</h2>' + tablaMiembros.outerHTML;
    }
    
    // Si tiene formato de items
    filas.forEach(fila => {
        const nombre = fila.querySelector('.miembro-nombre')?.textContent || '';
        const email = fila.querySelector('.miembro-email')?.textContent || '';
        const org = fila.querySelector('.miembro-org')?.textContent || '';
        if (nombre) {
            html += '<tr><td>' + nombre + '</td><td>' + email + '</td><td>-</td><td>' + org + '</td><td>-</td><td>-</td></tr>';
        }
    });
    
    html += '</tbody></table>';
    return '<h2>Listado de Miembros</h2>' + html;
}

function exportarMiembrosWord() {
    const contenido = obtenerHTMLMiembros();
    if (!contenido) {
        alert('No hay miembros registrados para exportar');
        return;
    }
    const html = crearDocumentoExportacion('Grupo motor - Plan local de salud', contenido);
    const municipio = getMunicipioActual() || 'municipio';
    descargarComoWord(html, 'grupo_motor_' + municipio);
}

function exportarMiembrosPDF() {
    const contenido = obtenerHTMLMiembros();
    if (!contenido) {
        alert('No hay miembros registrados para exportar');
        return;
    }
    const html = crearDocumentoExportacion('Grupo motor - Plan local de salud', contenido);
    descargarComoPDF(html, 'Grupo motor');
}

function imprimirMiembros() {
    const contenido = obtenerHTMLMiembros();
    if (!contenido) {
        alert('No hay miembros registrados para imprimir');
        return;
    }
    const html = crearDocumentoExportacion('Grupo motor - Plan local de salud', contenido);
    imprimirContenido(html);
}

// === EXPORTAR HOJA DE RUTA ===

function obtenerHTMLHojaRuta() {
    const lista = document.getElementById('hitos-lista');
    if (!lista || lista.children.length === 0) {
        return null;
    }
    
    let html = '<h2>Hitos del Proceso</h2><table><thead><tr><th>N¬∫</th><th>Hito</th><th>Fecha</th><th>Estado</th></tr></thead><tbody>';
    
    const hitos = lista.querySelectorAll('.hito-item');
    if (hitos.length === 0) {
        return null;
    }
    
    hitos.forEach((hito, index) => {
        const nombre = hito.querySelector('.hito-nombre')?.textContent || hito.querySelector('strong')?.textContent || '-';
        const fecha = hito.querySelector('.hito-fecha')?.textContent || hito.querySelector('input[type="date"]')?.value || '-';
        const completado = hito.classList.contains('completado') || hito.querySelector('input[type="checkbox"]')?.checked;
        const estado = completado ? '‚úÖ Completado' : '‚è≥ Pendiente';
        html += '<tr><td>' + (index + 1) + '</td><td>' + nombre + '</td><td>' + fecha + '</td><td>' + estado + '</td></tr>';
    });
    
    html += '</tbody></table>';
    return html;
}

function exportarHojaRutaWord() {
    const contenido = obtenerHTMLHojaRuta();
    if (!contenido) {
        alert('No hay hitos en la hoja de ruta para exportar');
        return;
    }
    const html = crearDocumentoExportacion('Hoja de ruta - Plan local de salud', contenido);
    const municipio = getMunicipioActual() || 'municipio';
    descargarComoWord(html, 'hoja_ruta_' + municipio);
}

function exportarHojaRutaPDF() {
    const contenido = obtenerHTMLHojaRuta();
    if (!contenido) {
        alert('No hay hitos en la hoja de ruta para exportar');
        return;
    }
    const html = crearDocumentoExportacion('Hoja de ruta - Plan local de salud', contenido);
    descargarComoPDF(html, 'Hoja de ruta');
}

function imprimirHojaRuta() {
    const contenido = obtenerHTMLHojaRuta();
    if (!contenido) {
        alert('No hay hitos en la hoja de ruta para imprimir');
        return;
    }
    const html = crearDocumentoExportacion('Hoja de ruta - Plan local de salud', contenido);
    imprimirContenido(html);
}

// ============================================
// SISTEMA DE VOTACI√ìN PAELLA POPULAR
// ============================================

// Definici√≥n de objetivos EPVSA (10 objetivos estrat√©gicos)
const OBJETIVOS_EPVSA = [
    { id: 1, icono: 'ü§±', texto: 'Incrementar lactancia materna y consumo de alimentos saludables' },
    { id: 2, icono: 'üèÉ', texto: 'Aumentar actividad f√≠sica y disminuir h√°bitos sedentarios' },
    { id: 3, icono: 'üò¥', texto: 'Incrementar horas y calidad del sue√±o' },
    { id: 4, icono: 'üòä', texto: 'Incrementar percepci√≥n de calidad de vida y bienestar emocional' },
    { id: 5, icono: '‚ù§Ô∏è', texto: 'Incrementar satisfacci√≥n con las relaciones sexuales' },
    { id: 6, icono: 'üì±', texto: 'Disminuir tiempo de uso de aparatos electr√≥nicos' },
    { id: 7, icono: 'üèòÔ∏è', texto: 'Incrementar recomendaciones sobre activos comunitarios' },
    { id: 8, icono: 'üè¢', texto: 'Incrementar empresas comprometidas con h√°bitos saludables' },
    { id: 9, icono: 'üì¢', texto: 'Incrementar difusi√≥n de informaci√≥n sobre h√°bitos saludables' },
    { id: 10, icono: 'üéì', texto: 'Incrementar formaci√≥n e investigaci√≥n en promoci√≥n de salud' }
];

// Definici√≥n de colectivos prioritarios para votaci√≥n ciudadana
const COLECTIVOS_PRIORITARIOS = [
    { id: 1, icono: 'üë•', texto: 'Poblaci√≥n general' },
    { id: 2, icono: 'üë∂', texto: 'Infancia' },
    { id: 3, icono: 'üßí', texto: 'Adolescencia' },
    { id: 4, icono: 'üë®‚Äçüéì', texto: 'Juventud' },
    { id: 5, icono: 'üë¥', texto: 'Mayores' },
    { id: 6, icono: 'üë©', texto: 'Mujeres' },
    { id: 7, icono: 'üè≥Ô∏è‚Äçüåà', texto: 'LGTBIQ+' },
    { id: 8, icono: '‚ú®', texto: 'Otros' }
];

// ============================================
// L√ìGICA DEL SISTEMA DE VOTACI√ìN CIUDADANA
// ============================================

// URL de GitHub donde est√° alojado el index.html - CONFIGURAR
const GITHUB_COMPAS_URL = 'https://bhermoso.github.io/COMPAS/';

// Estado de la votaci√≥n
let votacionActiva = false;
let votacionSessionId = null;
let votacionRespuestas = [];
let votacionListener = null;

// Opciones de sexo para la encuesta
const OPCIONES_SEXO = [
    { id: 1, icono: 'üë®', texto: 'Hombre' },
    { id: 2, icono: 'üë©', texto: 'Mujer' },
    { id: 3, icono: 'üßë', texto: 'Otro' },
    { id: 4, icono: '‚ùì', texto: 'Prefiero no contestar' }
];

// Secciones de la encuesta ciudadana
const ENCUESTA_SECCIONES = [
    {
        titulo: 'Datos demogr√°ficos',
        preguntas: [
            { id: 'sexo', label: '¬øCu√°l es tu sexo?', tipo: 'opciones', opciones: 'OPCIONES_SEXO' },
            { id: 'edad', label: '¬øCu√°l es tu edad?', tipo: 'numero', min: 1, max: 120, nota: 'Indica tu edad en a√±os' }
        ]
    },
    {
        titulo: 'Objetivos prioritarios',
        preguntas: [
            { id: 'objetivos_epvsa', label: '¬øQu√© objetivos de salud consideras m√°s importantes?', tipo: 'opciones_multiples', opciones: 'OBJETIVOS_EPVSA', max: 3, nota: 'Selecciona hasta 3 opciones' }
        ]
    },
    {
        titulo: 'Colectivos prioritarios',
        preguntas: [
            { id: 'colectivos', label: '¬øA qu√© colectivos deber√≠an dirigirse principalmente las acciones?', tipo: 'opciones_multiples', opciones: 'COLECTIVOS_PRIORITARIOS', max: 3, nota: 'Selecciona hasta 3 opciones' }
        ]
    }
];

// Variables para la encuesta
let encuestaSeccionActual = 0;
let encuestaDatos = {};

// ==================== PANEL DE ADMINISTRACI√ìN ====================

function toggleVotacionPanel() {
    // Acceso directo a la votaci√≥n ciudadana
    // Cambia al modo manual y activa la pesta√±a de votaci√≥n
    cambiarModoPlan('manual');
    setTimeout(() => {
        cambiarTabManual('votacion');
        // Scroll suave hasta el panel
        const panel = document.getElementById('contenido-tab-votacion');
        if (panel) {
            panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 150);
}

function iniciarSesionVotacion() {
    const municipio = document.getElementById('selector-municipio')?.value || 'municipio';
    if (!municipio || municipio === '') {
        alert('Seleccione primero un municipio');
        return;
    }
    
    votacionActiva = true;
    votacionSessionId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    votacionRespuestas = [];
    
    // Guardar en localStorage para recuperar sesi√≥n
    localStorage.setItem('compas_votacion_session', JSON.stringify({
        sessionId: votacionSessionId,
        municipio: municipio,
        inicio: Date.now()
    }));
    
    // Actualizar UI
    document.getElementById('btn-iniciar-votacion').disabled = true;
    document.getElementById('btn-detener-votacion').disabled = false;
    document.getElementById('btn-votar-directo').disabled = false;
    document.getElementById('btn-agregar-manual').disabled = false;
    
    const estado = document.getElementById('votacion-estado');
    estado.className = 'votacion-estado activa';
    document.getElementById('votacion-estado-texto').textContent = 'Sesi√≥n activa ¬∑ ' + votacionSessionId;
    
    // Generar QR
    const surveyUrl = GITHUB_COMPAS_URL + '?v=' + votacionSessionId + '&m=' + encodeURIComponent(municipio);
    const urlElement = document.getElementById('votacion-url');
    urlElement.innerHTML = `<a href="${surveyUrl}" target="_blank" style="color: #0074c8; text-decoration: underline;">${surveyUrl}</a>`;
    
    // Mostrar bot√≥n de copiar
    const btnCopiar = document.getElementById('btn-copiar-url');
    if (btnCopiar) {
        btnCopiar.style.display = 'block';
        btnCopiar.dataset.url = surveyUrl; // Guardar URL en el bot√≥n
    }
    
    document.getElementById('votacion-qrcode').innerHTML = '';
    new QRCode(document.getElementById('votacion-qrcode'), {
        text: surveyUrl,
        width: 180,
        height: 180,
        colorDark: '#0074c8',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
    });
    
    // Configurar listener de Firebase
    setupVotacionListener(municipio);
    
    console.log('‚úÖ Sesi√≥n de votaci√≥n iniciada:', votacionSessionId);
}

function setupVotacionListener(municipio) {
    if (votacionListener) {
        db.ref('votaciones/' + municipio + '/' + votacionSessionId + '/respuestas').off();
    }
    
    votacionListener = db.ref('votaciones/' + municipio + '/' + votacionSessionId + '/respuestas');
    votacionListener.on('child_added', snapshot => {
        const voto = snapshot.val();
        if (!votacionRespuestas.find(v => v.id === voto.id)) {
            votacionRespuestas.push(voto);
            addVotoAlFeed(voto);
            actualizarEstadisticasVotacion();
        }
    });
}

function copiarEnlaceVotacion() {
    const btnCopiar = document.getElementById('btn-copiar-url');
    const url = btnCopiar?.dataset.url;
    
    if (!url) {
        alert('No hay enlace disponible');
        return;
    }
    
    // Copiar al portapapeles
    navigator.clipboard.writeText(url).then(() => {
        // Cambiar texto del bot√≥n temporalmente
        const textoOriginal = btnCopiar.innerHTML;
        btnCopiar.innerHTML = '‚úÖ ¬°Enlace copiado!';
        btnCopiar.style.background = '#10b981';
        
        setTimeout(() => {
            btnCopiar.innerHTML = textoOriginal;
            btnCopiar.style.background = '#0074c8';
        }, 2000);
        
        mostrarNotificacion({
            title: 'Enlace copiado',
            message: 'Ya puede compartir el enlace por WhatsApp, email, etc.',
            type: 'success',
            duration: 3000
        });
    }).catch(err => {
        console.error('Error al copiar:', err);
        alert('Error al copiar el enlace. Selecci√≥nelo manualmente.');
    });
}

function detenerSesionVotacion() {
    votacionActiva = false;
    document.getElementById('btn-iniciar-votacion').disabled = false;
    document.getElementById('btn-detener-votacion').disabled = true;
    document.getElementById('btn-votar-directo').disabled = true;
    document.getElementById('btn-agregar-manual').disabled = true;
    
    const estado = document.getElementById('votacion-estado');
    estado.className = 'votacion-estado inactiva';
    document.getElementById('votacion-estado-texto').textContent = 'Sesi√≥n cerrada ¬∑ ' + votacionRespuestas.length + ' votos';
    
    if (votacionListener) {
        const municipio = document.getElementById('selector-municipio')?.value || 'municipio';
        db.ref('votaciones/' + municipio + '/' + votacionSessionId + '/respuestas').off();
    }
}

function reiniciarVotacion() {
    if (!confirm('¬øBorrar todos los votos de esta sesi√≥n?')) return;
    
    const municipio = document.getElementById('selector-municipio')?.value || 'municipio';
    
    if (votacionSessionId) {
        db.ref('votaciones/' + municipio + '/' + votacionSessionId).remove();
    }
    
    localStorage.removeItem('compas_votacion_session');
    votacionRespuestas = [];
    votacionActiva = false;
    votacionSessionId = null;
    
    document.getElementById('btn-iniciar-votacion').disabled = false;
    document.getElementById('btn-detener-votacion').disabled = true;
    document.getElementById('btn-votar-directo').disabled = true;
    document.getElementById('btn-agregar-manual').disabled = true;
    
    const estado = document.getElementById('votacion-estado');
    estado.className = 'votacion-estado esperando';
    document.getElementById('votacion-estado-texto').textContent = 'Pulse ¬´Iniciar sesi√≥n¬ª para comenzar';
    
    document.getElementById('votacion-qrcode').innerHTML = '<div style="width:180px;height:180px;background:#f1f5f9;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:3rem;">üì±</div>';
    document.getElementById('votacion-url').textContent = 'El enlace aparecer√° aqu√≠';
    
    const btnCopiar = document.getElementById('btn-copiar-url');
    if (btnCopiar) btnCopiar.style.display = 'none';
    
    document.getElementById('votacion-feed').innerHTML = '<div style="text-align:center;color:#94a3b8;padding:2rem;">Esperando votos...</div>';
    
    actualizarEstadisticasVotacion();
}

function addVotoAlFeed(voto) {
    const feed = document.getElementById('votacion-feed');
    if (feed.querySelector('div[style*="text-align:center"]')) {
        feed.innerHTML = '';
    }
    
    const sexoInfo = OPCIONES_SEXO.find(s => s.id == voto.sexo) || { icono: 'üë§', texto: 'N/A' };
    
    // Manejar m√∫ltiples objetivos (compatible con formato antiguo)
    let objetivosTexto = '';
    if (voto.objetivos_epvsa && Array.isArray(voto.objetivos_epvsa)) {
        const objetivosInfo = voto.objetivos_epvsa.map(id => 
            OBJETIVOS_EPVSA.find(o => o.id == id) || { icono: '‚ùì', texto: 'N/A' }
        );
        objetivosTexto = objetivosInfo.map(o => `${o.icono}`).join(' ');
    } else if (voto.objetivo_epvsa) {
        const objInfo = OBJETIVOS_EPVSA.find(o => o.id == voto.objetivo_epvsa) || { icono: '‚ùì', texto: 'N/A' };
        objetivosTexto = objInfo.icono;
    }
    
    // Manejar m√∫ltiples colectivos (compatible con formato antiguo)
    let colectivosTexto = '';
    if (voto.colectivos && Array.isArray(voto.colectivos)) {
        const colectivosInfo = voto.colectivos.map(id => 
            COLECTIVOS_PRIORITARIOS.find(c => c.id == id) || { icono: '‚ùì', texto: 'N/A' }
        );
        colectivosTexto = colectivosInfo.map(c => `${c.icono}`).join(' ');
    } else if (voto.colectivo) {
        const colInfo = COLECTIVOS_PRIORITARIOS.find(c => c.id == voto.colectivo) || { icono: '‚ùì', texto: 'N/A' };
        colectivosTexto = colInfo.icono;
    }
    
    const hora = new Date(voto.timestamp || Date.now()).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    
    const item = document.createElement('div');
    item.className = 'votacion-feed-item';
    item.innerHTML = `
        <div class="icono">${sexoInfo.icono}</div>
        <div class="info">
            <div class="titulo">${sexoInfo.texto}, ${voto.edad || '?'} a√±os</div>
            <div class="meta">${objetivosTexto} ¬∑ ${colectivosTexto}</div>
        </div>
        <div class="hora">${hora}</div>
    `;
    feed.insertBefore(item, feed.firstChild);
    
    // Limitar a 15 items
    while (feed.children.length > 15) {
        feed.removeChild(feed.lastChild);
    }
}

function actualizarEstadisticasVotacion() {
    const total = votacionRespuestas.length;
    const hombres = votacionRespuestas.filter(v => v.sexo == 1).length;
    const mujeres = votacionRespuestas.filter(v => v.sexo == 2).length;
    const edades = votacionRespuestas.map(v => parseInt(v.edad)).filter(e => e && !isNaN(e));
    const edadMedia = edades.length > 0 ? Math.round(edades.reduce((a, b) => a + b, 0) / edades.length) : '--';
    
    document.getElementById('vot-stat-total').textContent = total;
    document.getElementById('vot-stat-hombres').textContent = hombres;
    document.getElementById('vot-stat-mujeres').textContent = mujeres;
    document.getElementById('vot-stat-edad-media').textContent = edadMedia;
    
    // Actualizar resultados de objetivos
    actualizarResultadosObjetivos();
    actualizarResultadosColectivos();
}

function actualizarResultadosObjetivos() {
    const container = document.getElementById('votacion-resultados-objetivos');
    if (votacionRespuestas.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#94a3b8;padding:1rem;">Sin datos a√∫n</p>';
        return;
    }
    
    const conteo = {};
    votacionRespuestas.forEach(v => {
        // Compatibilidad con formato antiguo (campo √∫nico) y nuevo (array)
        if (v.objetivos_epvsa && Array.isArray(v.objetivos_epvsa)) {
            // Nuevo formato: array de objetivos
            v.objetivos_epvsa.forEach(objId => {
                conteo[objId] = (conteo[objId] || 0) + 1;
            });
        } else if (v.objetivo_epvsa) {
            // Formato antiguo: campo √∫nico
            conteo[v.objetivo_epvsa] = (conteo[v.objetivo_epvsa] || 0) + 1;
        }
    });
    
    const total = votacionRespuestas.length || 1;
    const ordenado = Object.entries(conteo).sort((a, b) => b[1] - a[1]).slice(0, 5);
    
    const colores = ['#0074c8', '#00acd9', '#94d40b', '#ffb61b', '#ff6600'];
    
    container.innerHTML = ordenado.map(([id, count], i) => {
        const obj = OBJETIVOS_EPVSA.find(o => o.id == id);
        const pct = Math.round((count / total) * 100);
        return `
            <div class="votacion-resultado-item">
                <div class="votacion-resultado-label">${obj ? obj.icono : ''} ${obj ? obj.texto : 'Obj. ' + id}</div>
                <div class="votacion-resultado-bar">
                    <div class="votacion-resultado-fill" style="width:${pct}%;background:${colores[i] || '#94a3b8'}">
                        <span>${count}</span>
                    </div>
                </div>
                <div class="votacion-resultado-pct">${pct}%</div>
            </div>
        `;
    }).join('');
}

function actualizarResultadosColectivos() {
    const container = document.getElementById('votacion-resultados-colectivos');
    if (votacionRespuestas.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#94a3b8;padding:1rem;">Sin datos a√∫n</p>';
        return;
    }
    
    const conteo = {};
    votacionRespuestas.forEach(v => {
        // Compatibilidad con formato antiguo (campo √∫nico) y nuevo (array)
        if (v.colectivos && Array.isArray(v.colectivos)) {
            // Nuevo formato: array de colectivos
            v.colectivos.forEach(colId => {
                conteo[colId] = (conteo[colId] || 0) + 1;
            });
        } else if (v.colectivo) {
            // Formato antiguo: campo √∫nico
            conteo[v.colectivo] = (conteo[v.colectivo] || 0) + 1;
        }
    });
    
    const total = votacionRespuestas.length || 1;
    const ordenado = Object.entries(conteo).sort((a, b) => b[1] - a[1]).slice(0, 5);
    
    const colores = ['#ff6600', '#dc143c', '#94d40b', '#00acd9', '#0074c8'];
    
    container.innerHTML = ordenado.map(([id, count], i) => {
        const col = COLECTIVOS_PRIORITARIOS.find(c => c.id == id);
        const pct = Math.round((count / total) * 100);
        return `
            <div class="votacion-resultado-item">
                <div class="votacion-resultado-label">${col ? col.icono : ''} ${col ? col.texto : 'Col. ' + id}</div>
                <div class="votacion-resultado-bar">
                    <div class="votacion-resultado-fill" style="width:${pct}%;background:${colores[i] || '#94a3b8'}">
                        <span>${count}</span>
                    </div>
                </div>
                <div class="votacion-resultado-pct">${pct}%</div>
            </div>
        `;
    }).join('');
}

function exportarVotacionCSV() {
    if (votacionRespuestas.length === 0) {
        alert('No hay datos para exportar');
        return;
    }
    
    const municipio = document.getElementById('selector-municipio')?.value || 'municipio';
    let csv = 'id;timestamp;sexo;edad;objetivos_epvsa;colectivos\n';
    
    votacionRespuestas.forEach(v => {
        // Formatear arrays para CSV
        const objetivos = v.objetivos_epvsa && Array.isArray(v.objetivos_epvsa) 
            ? v.objetivos_epvsa.join('|') 
            : (v.objetivo_epvsa || '');
        const colectivos = v.colectivos && Array.isArray(v.colectivos) 
            ? v.colectivos.join('|') 
            : (v.colectivo || '');
        
        csv += `${v.id || ''};${v.timestamp || ''};${v.sexo || ''};${v.edad || ''};${objetivos};${colectivos}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `votacion_${municipio}_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
}

function incorporarResultadosAlPlan() {
    if (votacionRespuestas.length === 0) {
        alert('No hay datos de votaci√≥n para incorporar');
        return;
    }
    
    const municipio = getMunicipioActual();
    if (!municipio) {
        alert('Seleccione un municipio primero');
        return;
    }
    
    // Calcular objetivo m√°s votado (compatible con arrays)
    const conteoObjetivos = {};
    votacionRespuestas.forEach(v => {
        if (v.objetivos_epvsa && Array.isArray(v.objetivos_epvsa)) {
            v.objetivos_epvsa.forEach(objId => {
                conteoObjetivos[objId] = (conteoObjetivos[objId] || 0) + 1;
            });
        } else if (v.objetivo_epvsa) {
            conteoObjetivos[v.objetivo_epvsa] = (conteoObjetivos[v.objetivo_epvsa] || 0) + 1;
        }
    });
    const objetivosOrdenados = Object.entries(conteoObjetivos).sort((a, b) => b[1] - a[1]);
    const objetivoTop = objetivosOrdenados[0];
    
    // Calcular colectivo m√°s votado (compatible con arrays)
    const conteoColectivos = {};
    votacionRespuestas.forEach(v => {
        if (v.colectivos && Array.isArray(v.colectivos)) {
            v.colectivos.forEach(colId => {
                conteoColectivos[colId] = (conteoColectivos[colId] || 0) + 1;
            });
        } else if (v.colectivo) {
            conteoColectivos[v.colectivo] = (conteoColectivos[v.colectivo] || 0) + 1;
        }
    });
    const colectivosOrdenados = Object.entries(conteoColectivos).sort((a, b) => b[1] - a[1]);
    const colectivoTop = colectivosOrdenados[0];
    
    const objInfo = OBJETIVOS_EPVSA.find(o => o.id == objetivoTop[0]);
    const colInfo = COLECTIVOS_PRIORITARIOS.find(c => c.id == colectivoTop[0]);
    
    // Preparar datos para Firebase
    const datosParticipacion = {
        fechaVotacion: new Date().toISOString(),
        totalParticipantes: votacionRespuestas.length,
        objetivoPrioritario: {
            id: parseInt(objetivoTop[0]),
            texto: objInfo ? objInfo.texto : 'Objetivo ' + objetivoTop[0],
            icono: objInfo ? objInfo.icono : 'üéØ',
            votos: objetivoTop[1],
            porcentaje: Math.round((objetivoTop[1] / votacionRespuestas.length) * 100)
        },
        colectivoPrioritario: {
            id: parseInt(colectivoTop[0]),
            texto: colInfo ? colInfo.texto : 'Colectivo ' + colectivoTop[0],
            icono: colInfo ? colInfo.icono : 'üë•',
            votos: colectivoTop[1],
            porcentaje: Math.round((colectivoTop[1] / votacionRespuestas.length) * 100)
        },
        desglose: {
            objetivos: conteoObjetivos,
            colectivos: conteoColectivos
        },
        rankingObjetivos: objetivosOrdenados.slice(0, 5).map(([id, votos]) => {
            const obj = OBJETIVOS_EPVSA.find(o => o.id == id);
            return {
                id: parseInt(id),
                texto: obj ? obj.texto : 'Objetivo ' + id,
                icono: obj ? obj.icono : 'üéØ',
                votos,
                porcentaje: Math.round((votos / votacionRespuestas.length) * 100)
            };
        }),
        rankingColectivos: colectivosOrdenados.slice(0, 5).map(([id, votos]) => {
            const col = COLECTIVOS_PRIORITARIOS.find(c => c.id == id);
            return {
                id: parseInt(id),
                texto: col ? col.texto : 'Colectivo ' + id,
                icono: col ? col.icono : 'üë•',
                votos,
                porcentaje: Math.round((votos / votacionRespuestas.length) * 100)
            };
        })
    };
    
    // Guardar en Firebase
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/participacionCiudadana').set(datosParticipacion)
        .then(() => {
            // Guardar en variable global para acceso inmediato
            window.datosParticipacionCiudadana = datosParticipacion;
            
            console.log('‚úÖ Participaci√≥n ciudadana guardada en Firebase:', datosParticipacion);
            mostrarNotificacion('‚úÖ Datos de participaci√≥n ciudadana incorporados correctamente', 'success');
            
            // Mostrar modal de priorizaci√≥n dual
            mostrarPriorizacionDual();
        })
        .catch(err => {
            console.error('Error guardando participaci√≥n:', err);
            mostrarNotificacion('‚ùå Error al guardar: ' + err.message, 'error');
        });
}

// ============================================
// NUEVAS FUNCIONALIDADES DE VOTACI√ìN
// ============================================

// 1. VOTACI√ìN DIRECTA DESDE ORDENADOR
function abrirVotacionDirecta() {
    if (!votacionSessionId) {
        alert('Primero debe iniciar una sesi√≥n de votaci√≥n');
        return;
    }
    
    const municipio = document.getElementById('selector-municipio')?.value || 'municipio';
    
    // Crear modal full-screen con formulario de votaci√≥n
    const modalHTML = `
        <div id="modal-votacion-directa" style="position:fixed;top:0;left:0;right:0;bottom:0;background:#ffffff;z-index:10000;overflow-y:auto;">
            <!-- Pantalla de formulario -->
            <div id="pantalla-formulario-voto" style="display:block;">
                <div style="max-width:600px;margin:0 auto;padding:2rem;">
                    <!-- Header -->
                    <div style="text-align:center;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:3px solid #0074c8;">
                        <h1 style="color:#0074c8;font-size:2rem;margin:0 0 0.5rem 0;">üó≥Ô∏è Votaci√≥n Popular</h1>
                        <p style="color:#64748b;font-size:1rem;margin:0;">Plan Local de Salud - ${getNombreMunicipio(municipio)}</p>
                    </div>
                    
                    <!-- Formulario -->
                    <form id="form-voto-directo" onsubmit="event.preventDefault(); enviarVotoDirecto();" style="display:flex;flex-direction:column;gap:1.5rem;">
                        
                        <!-- Sexo -->
                        <div>
                            <label style="display:block;font-weight:700;font-size:1.1rem;margin-bottom:0.75rem;color:#1e293b;">¬øCu√°l es tu sexo?</label>
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;">
                                ${OPCIONES_SEXO.map(op => `
                                    <label style="display:flex;align-items:center;gap:0.75rem;padding:1rem;border:2px solid #e2e8f0;border-radius:8px;cursor:pointer;transition:all 0.2s;" 
                                           onmouseover="this.style.borderColor='#0074c8';this.style.background='#f0f9ff';" 
                                           onmouseout="this.style.borderColor='#e2e8f0';this.style.background='white';">
                                        <input type="radio" name="sexo-directo" value="${op.id}" required style="width:20px;height:20px;cursor:pointer;">
                                        <span style="font-size:1.5rem;">${op.icono}</span>
                                        <span style="flex:1;font-size:0.95rem;">${op.texto}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Edad -->
                        <div>
                            <label style="display:block;font-weight:700;font-size:1.1rem;margin-bottom:0.75rem;color:#1e293b;">¬øCu√°l es tu edad?</label>
                            <input type="number" id="edad-directo" min="1" max="120" required 
                                   placeholder="Edad en a√±os" 
                                   style="width:100%;padding:1rem;border:2px solid #e2e8f0;border-radius:8px;font-size:1.1rem;">
                        </div>
                        
                        <!-- Objetivo EPVSA -->
                        <div>
                            <label style="display:block;font-weight:700;font-size:1.1rem;margin-bottom:0.75rem;color:#1e293b;">üéØ ¬øQu√© objetivos de salud consideras m√°s importantes? <span style="font-size:0.85rem;color:#64748b;font-weight:400;">(Selecciona hasta 3)</span></label>
                            <div style="display:flex;flex-direction:column;gap:0.5rem;max-height:400px;overflow-y:auto;padding:0.5rem;border:2px solid #e2e8f0;border-radius:8px;">
                                ${OBJETIVOS_EPVSA.map(op => `
                                    <label style="display:flex;align-items:start;gap:0.75rem;padding:0.75rem;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;transition:all 0.2s;" 
                                           onmouseover="this.style.borderColor='#10b981';this.style.background='#f0fdf4';" 
                                           onmouseout="this.style.borderColor='#e2e8f0';this.style.background='white';">
                                        <input type="checkbox" class="objetivo-checkbox" value="${op.id}" onchange="limitarSeleccion('objetivo-checkbox', 3)" style="width:20px;height:20px;margin-top:2px;cursor:pointer;flex-shrink:0;">
                                        <span style="font-size:1.3rem;flex-shrink:0;">${op.icono}</span>
                                        <span style="flex:1;font-size:0.9rem;line-height:1.4;">${op.texto}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Colectivo -->
                        <div>
                            <label style="display:block;font-weight:700;font-size:1.1rem;margin-bottom:0.75rem;color:#1e293b;">üë• ¬øA qu√© colectivos deber√≠an dirigirse las acciones? <span style="font-size:0.85rem;color:#64748b;font-weight:400;">(Selecciona hasta 3)</span></label>
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem;">
                                ${COLECTIVOS_PRIORITARIOS.map(op => `
                                    <label style="display:flex;align-items:center;gap:0.75rem;padding:0.75rem;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;transition:all 0.2s;" 
                                           onmouseover="this.style.borderColor='#3b82f6';this.style.background='#eff6ff';" 
                                           onmouseout="this.style.borderColor='#e2e8f0';this.style.background='white';">
                                        <input type="checkbox" class="colectivo-checkbox" value="${op.id}" onchange="limitarSeleccion('colectivo-checkbox', 3)" style="width:20px;height:20px;cursor:pointer;">
                                        <span style="font-size:1.3rem;">${op.icono}</span>
                                        <span style="flex:1;font-size:0.9rem;">${op.texto}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Botones -->
                        <div style="display:flex;gap:1rem;margin-top:1rem;">
                            <button type="button" onclick="cerrarVotacionDirecta()" 
                                    style="flex:1;padding:1rem;background:#f1f5f9;color:#475569;border:1px solid #cbd5e1;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;">
                                ‚ùå Cerrar
                            </button>
                            <button type="submit" 
                                    style="flex:2;padding:1rem;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-size:1.1rem;font-weight:700;cursor:pointer;">
                                ‚úÖ Enviar voto
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Pantalla de agradecimiento -->
            <div id="pantalla-gracias-voto" style="display:none;position:absolute;top:0;left:0;right:0;bottom:0;align-items:center;justify-content:center;background:linear-gradient(135deg,#10b981,#059669);">
                <div style="text-align:center;color:white;">
                    <div style="font-size:5rem;margin-bottom:1rem;">‚úÖ</div>
                    <h1 style="font-size:3rem;margin:0 0 1rem 0;font-weight:700;">¬°Gracias por votar!</h1>
                    <p style="font-size:1.5rem;margin:0;opacity:0.9;">Tu opini√≥n es muy importante</p>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer.firstElementChild);
}

function limitarSeleccion(className, max) {
    const checkboxes = document.querySelectorAll('.' + className + ':checked');
    if (checkboxes.length >= max) {
        // Deshabilitar las que no est√°n marcadas cuando ya hay 'max' seleccionadas
        document.querySelectorAll('.' + className + ':not(:checked)').forEach(cb => {
            cb.disabled = true;
            cb.parentElement.style.opacity = '0.5';
            cb.parentElement.style.cursor = 'not-allowed';
        });
    } else {
        // Habilitar todas si hay menos de 'max' seleccionadas
        document.querySelectorAll('.' + className).forEach(cb => {
            cb.disabled = false;
            cb.parentElement.style.opacity = '1';
            cb.parentElement.style.cursor = 'pointer';
        });
    }
}

function cerrarVotacionDirecta() {
    const modal = document.getElementById('modal-votacion-directa');
    if (modal) modal.remove();
}

function enviarVotoDirecto() {
    console.log('=== INICIO enviarVotoDirecto ===');
    
    const sexo = parseInt(document.querySelector('input[name="sexo-directo"]:checked')?.value);
    const edad = parseInt(document.getElementById('edad-directo').value);
    
    // Capturar m√∫ltiples objetivos (hasta 3)
    const objetivosSeleccionados = Array.from(document.querySelectorAll('.objetivo-checkbox:checked'))
        .map(cb => parseInt(cb.value));
    
    // Capturar m√∫ltiples colectivos (hasta 3)
    const colectivosSeleccionados = Array.from(document.querySelectorAll('.colectivo-checkbox:checked'))
        .map(cb => parseInt(cb.value));
    
    console.log('Datos capturados:', { sexo, edad, objetivos: objetivosSeleccionados, colectivos: colectivosSeleccionados });
    
    // Validaci√≥n
    if (!sexo || !edad) {
        alert('Por favor, indica tu sexo y edad');
        return;
    }
    
    if (objetivosSeleccionados.length === 0) {
        alert('Por favor, selecciona al menos 1 objetivo de salud (m√°ximo 3)');
        return;
    }
    
    if (colectivosSeleccionados.length === 0) {
        alert('Por favor, selecciona al menos 1 colectivo prioritario (m√°ximo 3)');
        return;
    }
    
    const municipio = document.getElementById('selector-municipio')?.value || 'municipio';
    
    const voto = {
        id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
        timestamp: Date.now(),
        sexo: sexo,
        edad: edad,
        objetivos_epvsa: objetivosSeleccionados, // Array de IDs
        colectivos: colectivosSeleccionados,     // Array de IDs
        origen: 'directo'
    };
    
    console.log('Voto a guardar:', voto);
    
    // MOSTRAR GRACIAS INMEDIATAMENTE
    const pantallaFormulario = document.getElementById('pantalla-formulario-voto');
    const pantallaGracias = document.getElementById('pantalla-gracias-voto');
    
    console.log('Pantallas encontradas:', { 
        formulario: !!pantallaFormulario, 
        gracias: !!pantallaGracias 
    });
    
    if (pantallaFormulario) pantallaFormulario.style.display = 'none';
    if (pantallaGracias) pantallaGracias.style.display = 'flex';
    console.log('Pantalla de gracias mostrada');
    
    // Configurar el reseteo autom√°tico - BUSCAR ELEMENTOS DENTRO DEL TIMEOUT
    console.log('Configurando timeout...');
    setTimeout(function() {
        console.log('=== TIMEOUT EJECUTADO (2 segundos) ===');
        
        // BUSCAR ELEMENTOS DE NUEVO dentro del timeout
        const formReset = document.getElementById('form-voto-directo');
        const graciasOcultar = document.getElementById('pantalla-gracias-voto');
        const formularioMostrar = document.getElementById('pantalla-formulario-voto');
        
        console.log('Elementos dentro del timeout:', {
            form: !!formReset,
            gracias: !!graciasOcultar,
            formulario: !!formularioMostrar
        });
        
        // Resetear formulario
        if (formReset) {
            formReset.reset();
            console.log('Formulario reseteado');
            
            // REHABILITAR TODOS LOS CHECKBOXES - con un peque√±o delay adicional para asegurar que el DOM est√° listo
            setTimeout(() => {
                const modal = document.getElementById('modal-votacion-directa');
                if (modal) {
                    // Buscar checkboxes dentro del modal espec√≠ficamente
                    const objetivoCheckboxes = modal.querySelectorAll('.objetivo-checkbox');
                    const colectivoCheckboxes = modal.querySelectorAll('.colectivo-checkbox');
                    
                    console.log('Encontrados checkboxes:', {
                        objetivos: objetivoCheckboxes.length,
                        colectivos: colectivoCheckboxes.length
                    });
                    
                    // Rehabilitar checkboxes de objetivos
                    objetivoCheckboxes.forEach(cb => {
                        cb.disabled = false;
                        cb.checked = false;
                        const label = cb.parentElement;
                        if (label) {
                            label.style.opacity = '1';
                            label.style.cursor = 'pointer';
                            label.style.borderColor = '#e2e8f0';
                            label.style.background = 'white';
                        }
                    });
                    
                    // Rehabilitar checkboxes de colectivos
                    colectivoCheckboxes.forEach(cb => {
                        cb.disabled = false;
                        cb.checked = false;
                        const label = cb.parentElement;
                        if (label) {
                            label.style.opacity = '1';
                            label.style.cursor = 'pointer';
                            label.style.borderColor = '#e2e8f0';
                            label.style.background = 'white';
                        }
                    });
                    
                    console.log('‚úÖ Checkboxes rehabilitados completamente');
                } else {
                    console.error('ERROR: No se encontr√≥ modal-votacion-directa');
                }
            }, 50);
        } else {
            console.error('ERROR: No se encontr√≥ form-voto-directo');
        }
        
        // Volver a pantalla de formulario
        if (graciasOcultar) {
            graciasOcultar.style.display = 'none';
            console.log('Pantalla gracias ocultada');
        } else {
            console.error('ERROR: No se encontr√≥ pantalla-gracias-voto');
        }
        
        if (formularioMostrar) {
            formularioMostrar.style.display = 'block';
            console.log('Pantalla formulario mostrada');
        } else {
            console.error('ERROR: No se encontr√≥ pantalla-formulario-voto');
        }
        
        console.log('=== FIN TIMEOUT ===');
    }, 2000);
    
    console.log('Timeout configurado');
    
    // Guardar en Firebase (en paralelo, no bloquea el ciclo)
    db.ref('votaciones/' + decodeURIComponent(municipio) + '/' + votacionSessionId + '/respuestas').push(voto)
        .then(() => {
            console.log('‚úÖ Voto guardado en Firebase correctamente');
        })
        .catch(err => {
            console.error('‚ùå Error al guardar en Firebase:', err);
            // No mostrar alert para no interrumpir el ciclo
        });
}

// 2. FORMULARIO PARA AGREGAR VOTOS MANUALMENTE
function abrirFormularioManual() {
    if (!votacionSessionId) {
        alert('Primero debe iniciar una sesi√≥n de votaci√≥n');
        return;
    }
    
    const municipio = document.getElementById('selector-municipio')?.value || 'municipio';
    
    // Crear modal con formulario
    const modalHTML = `
        <div id="modal-voto-manual" onclick="if(event.target.id==='modal-voto-manual')cerrarModalVotoManual()" 
             style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;padding:1rem;">
            <div style="background:white;border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                <div style="padding:1.5rem;border-bottom:1px solid #e5e7eb;">
                    <h2 style="margin:0;color:#1e293b;font-size:1.5rem;">‚úçÔ∏è Agregar voto manual</h2>
                    <p style="margin:0.5rem 0 0;color:#64748b;font-size:0.9rem;">Introduce los datos de un voto recogido en papel</p>
                </div>
                
                <div style="padding:1.5rem;">
                    <!-- Sexo -->
                    <div style="margin-bottom:1.5rem;">
                        <label style="display:block;font-weight:600;margin-bottom:0.5rem;color:#1e293b;">Sexo:</label>
                        <select id="manual-sexo" style="width:100%;padding:0.75rem;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
                            <option value="">Seleccione...</option>
                            ${OPCIONES_SEXO.map(op => `<option value="${op.id}">${op.icono} ${op.texto}</option>`).join('')}
                        </select>
                    </div>
                    
                    <!-- Edad -->
                    <div style="margin-bottom:1.5rem;">
                        <label style="display:block;font-weight:600;margin-bottom:0.5rem;color:#1e293b;">Edad:</label>
                        <input type="number" id="manual-edad" min="1" max="120" placeholder="Edad en a√±os" 
                               style="width:100%;padding:0.75rem;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
                    </div>
                    
                    <!-- Objetivo -->
                    <div style="margin-bottom:1.5rem;">
                        <label style="display:block;font-weight:600;margin-bottom:0.5rem;color:#1e293b;">Objetivo de salud prioritario:</label>
                        <select id="manual-objetivo" style="width:100%;padding:0.75rem;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
                            <option value="">Seleccione...</option>
                            ${OBJETIVOS_EPVSA.map(op => `<option value="${op.id}">${op.icono} ${op.texto}</option>`).join('')}
                        </select>
                    </div>
                    
                    <!-- Colectivo -->
                    <div style="margin-bottom:1.5rem;">
                        <label style="display:block;font-weight:600;margin-bottom:0.5rem;color:#1e293b;">Colectivo prioritario:</label>
                        <select id="manual-colectivo" style="width:100%;padding:0.75rem;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
                            <option value="">Seleccione...</option>
                            ${COLECTIVOS_PRIORITARIOS.map(op => `<option value="${op.id}">${op.icono} ${op.texto}</option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <div style="padding:1rem 1.5rem;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:0.75rem;background:#f9fafb;">
                    <button onclick="cerrarModalVotoManual()" style="padding:0.6rem 1.25rem;background:#f1f5f9;color:#475569;border:1px solid #cbd5e1;border-radius:6px;cursor:pointer;font-weight:500;">Cancelar</button>
                    <button onclick="guardarVotoManual()" style="padding:0.6rem 1.25rem;background:#0074c8;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;">Guardar voto</button>
                </div>
            </div>
        </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer.firstElementChild);
}

function cerrarModalVotoManual() {
    const modal = document.getElementById('modal-voto-manual');
    if (modal) modal.remove();
}

function guardarVotoManual() {
    const sexo = parseInt(document.getElementById('manual-sexo').value);
    const edad = parseInt(document.getElementById('manual-edad').value);
    const objetivo = parseInt(document.getElementById('manual-objetivo').value);
    const colectivo = parseInt(document.getElementById('manual-colectivo').value);
    
    if (!sexo || !edad || !objetivo || !colectivo) {
        alert('Por favor, complete todos los campos');
        return;
    }
    
    const municipio = document.getElementById('selector-municipio')?.value || 'municipio';
    
    const voto = {
        id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
        timestamp: Date.now(),
        sexo: sexo,
        edad: edad,
        objetivo_epvsa: objetivo,
        colectivo: colectivo,
        origen: 'manual' // Marcar como voto manual
    };
    
    // Guardar en Firebase
    db.ref('votaciones/' + decodeURIComponent(municipio) + '/' + votacionSessionId + '/respuestas').push(voto)
        .then(() => {
            mostrarNotificacion('‚úÖ Voto manual agregado correctamente', 'success');
            cerrarModalVotoManual();
        })
        .catch(err => {
            alert('Error al guardar el voto: ' + err.message);
        });
}

// 3. GENERAR FLYER PARA IMPRIMIR
function generarFlyerPapel() {
    const municipio = document.getElementById('selector-municipio')?.value;
    const nombre = municipio ? getNombreMunicipio(municipio) : 'su municipio';
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Votaci√≥n Plan Local de Salud - ${nombre}</title>
    <style>
        @page { size: A4; margin: 15mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.4; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid #0074c8; padding-bottom: 10px; margin-bottom: 15px; }
        .header img { height: 50px; }
        .titulo { text-align: center; margin: 15px 0; }
        .titulo h1 { color: #0074c8; font-size: 22pt; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
        .titulo h2 { color: #64748b; font-size: 14pt; margin: 10px 0; font-weight: normal; }
        .instrucciones { background: #f0f9ff; border-left: 4px solid #0074c8; padding: 12px 15px; margin: 15px 0; border-radius: 4px; }
        .instrucciones p { margin: 0.5em 0; }
        .pregunta { margin: 20px 0; page-break-inside: avoid; }
        .pregunta-titulo { font-weight: 700; color: #0f172a; font-size: 12pt; margin-bottom: 10px; padding: 8px; background: #e0f2fe; border-radius: 4px; }
        .opciones { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
        .opcion { border: 2px solid #cbd5e1; padding: 10px; border-radius: 6px; display: flex; align-items: center; gap: 10px; min-height: 50px; }
        .opcion-checkbox { width: 24px; height: 24px; border: 2px solid #64748b; border-radius: 4px; flex-shrink: 0; }
        .opcion-icono { font-size: 20pt; flex-shrink: 0; }
        .opcion-texto { flex: 1; font-size: 10pt; }
        .edad-input { margin-top: 10px; }
        .edad-input input { width: 100px; height: 40px; border: 2px solid #cbd5e1; border-radius: 6px; font-size: 14pt; text-align: center; }
        .footer { margin-top: 30px; padding-top: 15px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b; font-size: 9pt; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a">` : '<div></div>'}
        ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito">` : '<div></div>'}
    </div>
    
    <div class="titulo">
        <h1>üó≥Ô∏è Votaci√≥n Popular</h1>
        <h2>Plan Local de Salud de ${nombre}</h2>
    </div>
    
    <div class="instrucciones">
        <p><strong>üìã Instrucciones:</strong></p>
        <p>‚úì Marque con una <strong>X</strong> las casillas de sus respuestas</p>
        <p>‚úì Responda todas las preguntas</p>
        <p>‚úì Deposite este formulario en el buz√≥n habilitado</p>
    </div>
    
    <!-- PREGUNTA 1: SEXO -->
    <div class="pregunta">
        <div class="pregunta-titulo">1. ¬øCu√°l es tu sexo?</div>
        <div class="opciones">
            ${OPCIONES_SEXO.map(op => `
                <div class="opcion">
                    <div class="opcion-checkbox"></div>
                    <div class="opcion-icono">${op.icono}</div>
                    <div class="opcion-texto">${op.texto}</div>
                </div>
            `).join('')}
        </div>
    </div>
    
    <!-- PREGUNTA 2: EDAD -->
    <div class="pregunta">
        <div class="pregunta-titulo">2. ¬øCu√°l es tu edad?</div>
        <div class="edad-input">
            <p style="margin-bottom: 8px;">Escribe tu edad en a√±os:</p>
            <input type="text" style="border: 2px solid #cbd5e1; padding: 10px; width: 150px; font-size: 14pt;" placeholder="Edad">
        </div>
    </div>
    
    <!-- PREGUNTA 3: OBJETIVO -->
    <div class="pregunta" style="page-break-before: always;">
        <div class="pregunta-titulo">3. ¬øQu√© objetivo de salud consideras m√°s importante?</div>
        <div class="opciones">
            ${OBJETIVOS_EPVSA.map(op => `
                <div class="opcion">
                    <div class="opcion-checkbox"></div>
                    <div class="opcion-icono">${op.icono}</div>
                    <div class="opcion-texto">${op.texto}</div>
                </div>
            `).join('')}
        </div>
    </div>
    
    <!-- PREGUNTA 4: COLECTIVO -->
    <div class="pregunta">
        <div class="pregunta-titulo">4. ¬øA qu√© colectivo deber√≠an dirigirse las acciones?</div>
        <div class="opciones">
            ${COLECTIVOS_PRIORITARIOS.map(op => `
                <div class="opcion">
                    <div class="opcion-checkbox"></div>
                    <div class="opcion-icono">${op.icono}</div>
                    <div class="opcion-texto">${op.texto}</div>
                </div>
            `).join('')}
        </div>
    </div>
    
    <div class="footer">
        <p><strong>Gracias por su participaci√≥n</strong></p>
        <p>Su opini√≥n es fundamental para definir las prioridades del Plan Local de Salud</p>
        <p style="margin-top: 10px;">Documento generado con COMP√ÅS - Dise√±o ciudadano de la salud</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Flyer_Votacion_' + nombre);
}

// Variable global para datos de participaci√≥n ciudadana
window.datosParticipacionCiudadana = null;

// Cargar participaci√≥n ciudadana al cargar municipio
function cargarParticipacionCiudadana(municipio) {
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/participacionCiudadana').once('value', snap => {
        const data = snap.val();
        if (data) {
            window.datosParticipacionCiudadana = data;
            console.log('üìä Participaci√≥n ciudadana cargada:', data);
            actualizarIndicadorParticipacion(true, data.totalParticipantes);
            // Actualizar secci√≥n 04 del nuevo perfil
            if (typeof renderizarSeccionPriorizacion === 'function') renderizarSeccionPriorizacion();
            if (typeof actualizarChecklistIA === 'function') actualizarChecklistIA();
        } else {
            window.datosParticipacionCiudadana = null;
            actualizarIndicadorParticipacion(false);
            if (typeof renderizarSeccionPriorizacion === 'function') renderizarSeccionPriorizacion();
        }
    });
}

// Indicador visual de participaci√≥n ciudadana
function actualizarIndicadorParticipacion(existe, participantes = 0) {
    let indicador = document.getElementById('indicador-participacion');
    if (!indicador) {
        // Crear indicador si no existe
        const propuestaContainer = document.getElementById('propuesta-automatica-container');
        if (propuestaContainer) {
            indicador = document.createElement('div');
            indicador.id = 'indicador-participacion';
            indicador.style.cssText = 'padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 1rem; display: none;';
            propuestaContainer.insertBefore(indicador, propuestaContainer.firstChild);
        }
    }
    
    if (indicador) {
        if (existe) {
            indicador.style.display = 'block';
            indicador.style.background = 'linear-gradient(135deg, #dbeafe 0%, #ede9fe 100%)';
            indicador.style.border = '1px solid #93c5fd';
            indicador.innerHTML = `
                <span style="font-weight: 600; color: #1e40af;">
                    üó≥Ô∏è Este municipio tiene datos de participaci√≥n ciudadana (${participantes} participantes)
                </span>
                <button onclick="mostrarPriorizacionDual()" style="margin-left: 1rem; padding: 0.25rem 0.75rem; background: #0074c8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                    Ver priorizaci√≥n dual
                </button>
            `;
        } else {
            indicador.style.display = 'none';
        }
    }
}

// Mostrar modal de priorizaci√≥n dual
function mostrarPriorizacionDual() {
    const participacion = window.datosParticipacionCiudadana;
    const analisis = window.analisisActual || analizarDatosMunicipio();
    
    if (!participacion) {
        mostrarNotificacion('No hay datos de participaci√≥n ciudadana para este municipio', 'warning');
        return;
    }
    
    // Obtener prioridades epidemiol√≥gicas
    const prioridadesEpi = analisis.priorizacion ? analisis.priorizacion.slice(0, 3) : [];
    
    // Construir HTML del modal
    let modalHTML = `
        <div id="modal-priorizacion-dual" onclick="if(event.target.id==='modal-priorizacion-dual')cerrarModalPriorizacion()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;">
                <!-- Bot√≥n cerrar X -->
                <button onclick="cerrarModalPriorizacion()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9';this.style.color='#1e293b'" onmouseout="this.style.background='none';this.style.color='#94a3b8'">√ó</button>
                
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <h2 style="margin: 0; color: #1e293b; font-size: 1.5rem;">üìä Priorizaci√≥n Dual</h2>
                    <p style="margin: 0.5rem 0 0; color: #64748b; font-size: 0.9rem;">Compare las prioridades seg√∫n datos epidemiol√≥gicos y consulta ciudadana</p>
                </div>
                
                <div style="padding: 1.5rem;">
                    <!-- Prioridad epidemiol√≥gica -->
                    <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h3 style="margin: 0 0 0.75rem; color: #166534; font-size: 1.1rem;">üî¨ Seg√∫n datos epidemiol√≥gicos</h3>
                        ${prioridadesEpi.length > 0 ? `
                            <ol style="margin: 0; padding-left: 1.5rem;">
                                ${prioridadesEpi.map((p, i) => `
                                    <li style="margin-bottom: 0.5rem; color: #374151;">
                                        <strong>${p.area}</strong>
                                        <span style="color: #6b7280; font-size: 0.85rem;"> - ${p.justificacion}</span>
                                    </li>
                                `).join('')}
                            </ol>
                        ` : '<p style="color: #6b7280; margin: 0;">Sin datos epidemiol√≥gicos disponibles</p>'}
                    </div>
                    
                    <!-- Prioridad ciudadana -->
                    <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 0.75rem; color: #1e40af; font-size: 1.1rem;">üó≥Ô∏è Seg√∫n consulta ciudadana <span style="font-weight: normal; font-size: 0.85rem;">(${participacion.totalParticipantes} participantes - ${new Date(participacion.fechaVotacion).toLocaleDateString('es-ES')})</span></h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem; color: #374151; font-size: 0.95rem;">üéØ Objetivo prioritario</h4>
                                <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid #dbeafe;">
                                    <span style="font-size: 1.5rem;">${participacion.objetivoPrioritario.icono}</span>
                                    <span style="display: block; font-weight: 600; color: #1e293b; margin-top: 0.25rem;">${participacion.objetivoPrioritario.texto}</span>
                                    <span style="font-size: 0.85rem; color: #0074c8;">${participacion.objetivoPrioritario.porcentaje}% de los votos</span>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 0.5rem; color: #374151; font-size: 0.95rem;">üë• Colectivo prioritario</h4>
                                <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 1px solid #dbeafe;">
                                    <span style="font-size: 1.5rem;">${participacion.colectivoPrioritario.icono}</span>
                                    <span style="display: block; font-weight: 600; color: #1e293b; margin-top: 0.25rem;">${participacion.colectivoPrioritario.texto}</span>
                                    <span style="font-size: 0.85rem; color: #0074c8;">${participacion.colectivoPrioritario.porcentaje}% de los votos</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Opciones de decisi√≥n -->
                    <div style="background: #fafafa; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                        <h3 style="margin: 0 0 1rem; color: #1e293b; font-size: 1.1rem;">¬øC√≥mo desea proceder?</h3>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;" id="opciones-priorizacion">
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#0074c8'" onmouseout="this.style.borderColor=this.querySelector('input').checked?'#0074c8':'#e5e7eb'">
                                <input type="radio" name="metodo-priorizacion" value="epidemiologica" style="margin-top: 0.25rem;">
                                <div>
                                    <strong style="color: #166534;">Aceptar prioridad epidemiol√≥gica</strong>
                                    <p style="margin: 0.25rem 0 0; color: #6b7280; font-size: 0.85rem;">Basar el plan en los datos de salud objetivos</p>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#0074c8'" onmouseout="this.style.borderColor=this.querySelector('input').checked?'#0074c8':'#e5e7eb'">
                                <input type="radio" name="metodo-priorizacion" value="ciudadana" style="margin-top: 0.25rem;">
                                <div>
                                    <strong style="color: #1e40af;">Aceptar prioridad ciudadana</strong>
                                    <p style="margin: 0.25rem 0 0; color: #6b7280; font-size: 0.85rem;">Priorizar seg√∫n la consulta a la poblaci√≥n</p>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#0074c8'" onmouseout="this.style.borderColor=this.querySelector('input').checked?'#0074c8':'#e5e7eb'">
                                <input type="radio" name="metodo-priorizacion" value="integracion" checked style="margin-top: 0.25rem;">
                                <div>
                                    <strong style="color: #7c3aed;">Integrar ambas prioridades</strong>
                                    <p style="margin: 0.25rem 0 0; color: #6b7280; font-size: 0.85rem;">Combinar evidencia epidemiol√≥gica con participaci√≥n ciudadana (recomendado)</p>
                                </div>
                            </label>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 500;">Justificaci√≥n (opcional):</label>
                            <textarea id="justificacion-priorizacion" placeholder="A√±ada una justificaci√≥n para la decisi√≥n adoptada..." style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; min-height: 60px; font-family: inherit;"></textarea>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem; background: #f9fafb;">
                    <button onclick="cerrarModalPriorizacion()" style="padding: 0.6rem 1.25rem; background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancelar</button>
                    <button onclick="confirmarPriorizacion()" style="padding: 0.6rem 1.25rem; background: #0074c8; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Confirmar decisi√≥n</button>
                </div>
            </div>
        </div>
    `;
    
    // Insertar modal en el DOM
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer.firstElementChild);
}

function cerrarModalPriorizacion() {
    const modal = document.getElementById('modal-priorizacion-dual');
    if (modal) modal.remove();
}

// Cierre con Escape para modal de priorizaci√≥n dual
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modalPriorizacion = document.getElementById('modal-priorizacion-dual');
        if (modalPriorizacion) cerrarModalPriorizacion();
    }
});

// ============================================
// FUNCI√ìN DE FUSI√ìN √âTICA DE PRIORIZACIONES
// Modelo: 70% Epidemiolog√≠a + 30% Ciudadan√≠a
// ============================================

function fusionarPriorizaciones(analisis, participacion) {
    // Par√°metros del modelo √©tico
    const PESO_EPIDEMIO = 0.70;
    const PESO_CIUDADANO = 0.30;
    const UMBRAL_PROTECCION_EPI = 8.5; // Score m√≠nimo para protecci√≥n
    const UMBRAL_BOOST_CIUDADANO = 60; // % votos para boost
    const BOOST_CIUDADANO = 1.5; // Puntos extra
    const UMBRAL_CONFLICTO = 5; // Diferencia de posiciones para alerta
    
    const salvaguardasAplicadas = [];
    const conflictos = [];
    
    // 1. Preparar rankings epidemiol√≥gicos (normalizar scores 0-10)
    const priorizacionEpi = analisis.priorizacion || [];
    const maxScoreEpi = priorizacionEpi.length > 0 ? Math.max(...priorizacionEpi.map(p => p.puntuacion || 0)) : 10;
    
    const rankingEpidemiologico = priorizacionEpi.map((item, idx) => ({
        area: item.area,
        scoreOriginal: item.puntuacion || 0,
        scoreNormalizado: ((item.puntuacion || 0) / maxScoreEpi) * 10,
        posicionEpi: idx + 1,
        justificacion: item.justificacion || ''
    }));
    
    // 2. Preparar ranking ciudadano (convertir votos a scores 0-10)
    const rankingObjetivos = participacion.rankingObjetivos || [];
    const maxVotos = rankingObjetivos.length > 0 ? Math.max(...rankingObjetivos.map(o => o.votos)) : 1;
    
    const rankingCiudadano = rankingObjetivos.map((obj, idx) => ({
        area: obj.texto,
        votos: obj.votos,
        porcentaje: obj.porcentaje,
        scoreNormalizado: (obj.votos / maxVotos) * 10,
        posicionCiudadana: idx + 1
    }));
    
    // 3. Crear mapa unificado de √°reas
    const areasUnicas = new Set([
        ...rankingEpidemiologico.map(r => r.area),
        ...rankingCiudadano.map(r => r.area)
    ]);
    
    // 4. Calcular scores fusionados
    const scoresFusionados = [];
    
    areasUnicas.forEach(area => {
        const itemEpi = rankingEpidemiologico.find(r => r.area === area);
        const itemCiud = rankingCiudadano.find(r => r.area === area);
        
        const scoreEpi = itemEpi ? itemEpi.scoreNormalizado : 0;
        const scoreCiud = itemCiud ? itemCiud.scoreNormalizado : 0;
        
        // Score base fusionado (70/30)
        let scoreFusionado = (scoreEpi * PESO_EPIDEMIO) + (scoreCiud * PESO_CIUDADANO);
        
        // SALVAGUARDA 1: Protecci√≥n epidemiol√≥gica cr√≠tica
        if (itemEpi && itemEpi.scoreNormalizado >= UMBRAL_PROTECCION_EPI) {
            salvaguardasAplicadas.push({
                tipo: 'proteccion_epidemiologica',
                area: area,
                scoreEpi: itemEpi.scoreNormalizado,
                mensaje: `Protegida por alto score epidemiol√≥gico (${itemEpi.scoreNormalizado.toFixed(1)}‚â•${UMBRAL_PROTECCION_EPI})`
            });
        }
        
        // SALVAGUARDA 2: Boost democr√°tico
        if (itemCiud && itemCiud.porcentaje >= UMBRAL_BOOST_CIUDADANO) {
            scoreFusionado += BOOST_CIUDADANO;
            salvaguardasAplicadas.push({
                tipo: 'boost_democratico',
                area: area,
                porcentaje: itemCiud.porcentaje,
                boost: BOOST_CIUDADANO,
                mensaje: `Boost por alto apoyo ciudadano (${itemCiud.porcentaje}%‚â•${UMBRAL_BOOST_CIUDADANO}%)`
            });
        }
        
        scoresFusionados.push({
            area: area,
            scoreEpi: scoreEpi,
            scoreCiud: scoreCiud,
            scoreFusionado: scoreFusionado,
            posicionEpi: itemEpi ? itemEpi.posicionEpi : 999,
            posicionCiudadana: itemCiud ? itemCiud.posicionCiudadana : 999,
            votosCiudadanos: itemCiud ? itemCiud.votos : 0,
            porcentajeCiudadano: itemCiud ? itemCiud.porcentaje : 0
        });
    });
    
    // 5. Ordenar por score fusionado
    scoresFusionados.sort((a, b) => b.scoreFusionado - a.scoreFusionado);
    
    // Asignar posiciones finales
    scoresFusionados.forEach((item, idx) => {
        item.posicionFinal = idx + 1;
    });
    
    // 6. SALVAGUARDA 3: Detectar conflictos cr√≠ticos
    scoresFusionados.forEach(item => {
        const discrepanciaEpi = Math.abs(item.posicionFinal - item.posicionEpi);
        const discrepanciaCiud = Math.abs(item.posicionFinal - item.posicionCiudadana);
        
        if (discrepanciaEpi >= UMBRAL_CONFLICTO || discrepanciaCiud >= UMBRAL_CONFLICTO) {
            conflictos.push({
                area: item.area,
                posicionFinal: item.posicionFinal,
                posicionEpi: item.posicionEpi,
                posicionCiudadana: item.posicionCiudadana,
                discrepanciaEpi: discrepanciaEpi,
                discrepanciaCiud: discrepanciaCiud,
                mensaje: `Discrepancia significativa: Epidemio #${item.posicionEpi}, Ciudadana #${item.posicionCiudadana}, Final #${item.posicionFinal}`
            });
        }
    });
    
    // SALVAGUARDA 1 (aplicaci√≥n): Forzar TOP-5 a √°reas protegidas
    const areasProtegidas = salvaguardasAplicadas
        .filter(s => s.tipo === 'proteccion_epidemiologica')
        .map(s => s.area);
    
    if (areasProtegidas.length > 0) {
        // Reordenar: √°reas protegidas primero
        const itemsProtegidos = scoresFusionados.filter(i => areasProtegidas.includes(i.area));
        const itemsNoProtegidos = scoresFusionados.filter(i => !areasProtegidas.includes(i.area));
        
        // Asegurar que protegidos est√°n en TOP-5
        itemsProtegidos.sort((a, b) => b.scoreFusionado - a.scoreFusionado);
        itemsNoProtegidos.sort((a, b) => b.scoreFusionado - a.scoreFusionado);
        
        const rankingFinal = [...itemsProtegidos.slice(0, 5), ...itemsNoProtegidos];
        scoresFusionados.length = 0;
        scoresFusionados.push(...rankingFinal);
    }
    
    // 7. Extraer TOP-3 como √°reas resultantes
    const areasResultantes = scoresFusionados.slice(0, 3).map(item => item.area);
    
    return {
        areasResultantes: areasResultantes,
        rankingCompleto: scoresFusionados,
        salvaguardasAplicadas: salvaguardasAplicadas,
        conflictos: conflictos,
        parametros: {
            pesoEpidemiologico: PESO_EPIDEMIO,
            pesoCiudadano: PESO_CIUDADANO,
            umbralProteccion: UMBRAL_PROTECCION_EPI,
            umbralBoost: UMBRAL_BOOST_CIUDADANO,
            boostPuntos: BOOST_CIUDADANO,
            umbralConflicto: UMBRAL_CONFLICTO
        }
    };
}

function confirmarPriorizacion() {
    const metodo = document.querySelector('input[name="metodo-priorizacion"]:checked')?.value;
    const justificacion = document.getElementById('justificacion-priorizacion')?.value || '';
    const municipio = getMunicipioActual();
    
    if (!metodo) {
        alert('Seleccione un m√©todo de priorizaci√≥n');
        return;
    }
    
    const participacion = window.datosParticipacionCiudadana;
    const analisis = window.analisisActual || analizarDatosMunicipio();
    
    // Construir decisi√≥n seg√∫n m√©todo elegido
    let areasResultantes = [];
    let colectivoResultante = null;
    
    if (metodo === 'epidemiologica') {
        areasResultantes = analisis.priorizacion ? analisis.priorizacion.slice(0, 3).map(p => p.area) : [];
    } else if (metodo === 'ciudadana') {
        areasResultantes = [participacion.objetivoPrioritario.texto];
        colectivoResultante = participacion.colectivoPrioritario.texto;
    } else if (metodo === 'integracion') {
        // ============================================
        // ALGORITMO DE FUSI√ìN √âTICA 70/30
        // Epidemiolog√≠a 70% + Votos Ciudadanos 30%
        // Con 3 salvaguardas de protecci√≥n
        // ============================================
        
        const resultadoFusion = fusionarPriorizaciones(analisis, participacion);
        areasResultantes = resultadoFusion.areasResultantes;
        colectivoResultante = participacion.colectivoPrioritario.texto;
        
        // Almacenar datos de fusi√≥n para transparencia documental
        window.datosFusionPriorizacion = resultadoFusion;
    }
    
    const decisionPriorizacion = {
        metodo: metodo,
        fechaDecision: new Date().toISOString(),
        justificacion: justificacion,
        areasResultantes: areasResultantes,
        colectivoResultante: colectivoResultante,
        fuenteEpidemiologica: analisis.priorizacion ? analisis.priorizacion.slice(0, 3) : [],
        fuenteCiudadana: {
            objetivo: participacion.objetivoPrioritario,
            colectivo: participacion.colectivoPrioritario,
            participantes: participacion.totalParticipantes
        },
        // Datos adicionales si fue fusi√≥n
        ...(metodo === 'integracion' && window.datosFusionPriorizacion ? {
            metodologiaFusion: {
                pesoEpidemiologico: 0.70,
                pesoCiudadano: 0.30,
                salvaguardasAplicadas: window.datosFusionPriorizacion.salvaguardasAplicadas || [],
                conflictosDetectados: window.datosFusionPriorizacion.conflictos || [],
                rankingFusionado: window.datosFusionPriorizacion.rankingCompleto || []
            }
        } : {})
    };
    
    // Detectar el modo actual antes de guardar
    const modoManualVisible = document.getElementById('plan-modo-manual')?.style.display === 'block';
    
    // Guardar decisi√≥n en Firebase
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/decisionPriorizacion').set(decisionPriorizacion)
        .then(() => {
            window.decisionPriorizacionActual = decisionPriorizacion;
            console.log('‚úÖ Decisi√≥n de priorizaci√≥n guardada:', decisionPriorizacion);
            
            cerrarModalPriorizacion();
            
            if (modoManualVisible) {
                // Si estaba en modo manual, cambiar a pesta√±a de selecci√≥n y hacer scroll al bot√≥n
                cambiarTabManual('seleccion');
                mostrarNotificacion({
                    title: 'Priorizaci√≥n completada',
                    message: 'La decisi√≥n se ha registrado. Ya puede generar el plan de acci√≥n.',
                    type: 'success',
                    duration: 5000
                });
                // Scroll al bot√≥n de generar plan
                setTimeout(() => {
                    const btnGenerar = document.querySelector('#contenido-tab-seleccion .plan-accion-footer');
                    if (btnGenerar) {
                        btnGenerar.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300);
            } else {
                // Si estaba en modo autom√°tico, regenerar la propuesta
                mostrarNotificacion({
                    title: 'Priorizaci√≥n completada',
                    message: 'Ahora pulse ¬´Aceptar propuesta¬ª y luego ¬´Generar documento¬ª para completar el plan de acci√≥n.',
                    type: 'success',
                    duration: 6000
                });
                
                cambiarModoPlan('auto');
                
                // Regenerar propuesta con la nueva priorizaci√≥n
                if (typeof generarPropuestaAutomatica === 'function') {
                    setTimeout(() => {
                        generarPropuestaAutomatica();
                        // Scroll a la propuesta
                        const propuestaContainer = document.getElementById('propuesta-automatica-container');
                        if (propuestaContainer) {
                            propuestaContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 300);
                }
            }
        })
        .catch(err => {
            console.error('Error guardando decisi√≥n:', err);
            mostrarNotificacion({
                title: 'Error',
                message: 'Error al guardar decisi√≥n: ' + err.message,
                type: 'error'
            });
        });
}

// Cargar decisi√≥n de priorizaci√≥n al cargar municipio
function cargarDecisionPriorizacion(municipio) {
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/decisionPriorizacion').once('value', snap => {
        const data = snap.val();
        if (data) {
            window.decisionPriorizacionActual = data;
            console.log('üìã Decisi√≥n de priorizaci√≥n cargada:', data);
        } else {
            window.decisionPriorizacionActual = null;
        }
    });
}

function simularVotos() {
    if (!votacionSessionId) {
        alert('Primero inicia una sesi√≥n de votaci√≥n');
        return;
    }
    if (!confirm('¬øGenerar 150 votos simulados?\n\nEsto simula una consulta ciudadana piloto (N=150, tama√±o recomendado para estudios exploratorios en salud).')) return;
    
    const municipio = document.getElementById('selector-municipio')?.value || 'municipio';
    
    let count = 0;
    const totalVotos = 150;
    const toast = mostrarNotificacion({mensaje: 'Generando votos: 0/' + totalVotos, tipo: 'loading', duracion: 0});
    
    const interval = setInterval(() => {
        if (count >= totalVotos) {
            clearInterval(interval);
            if (toast) cerrarNotificacion(toast);
            mostrarNotificacion({mensaje: '‚úÖ ' + totalVotos + ' votos simulados generados', tipo: 'success'});
            
            // Preguntar si desea incorporar los resultados al plan
            setTimeout(() => {
                if (confirm('Se han generado ' + totalVotos + ' votos simulados.\n\n¬øDesea incorporar estos resultados al plan de acci√≥n?\n\n(Esto abrir√° el panel de priorizaci√≥n dual)')) {
                    incorporarResultadosAlPlan();
                }
            }, 500);
            return;
        }
        
        // Distribuci√≥n m√°s realista de sexo (1=Hombre, 2=Mujer, 3=Otro, 4=Prefiero no decir)
        const sexoRand = Math.random();
        const sexo = sexoRand < 0.48 ? 2 : sexoRand < 0.94 ? 1 : sexoRand < 0.97 ? 3 : 4;
        
        // Distribuci√≥n de edad m√°s realista (sesgo hacia adultos)
        const edadBase = Math.random();
        const edad = edadBase < 0.15 ? Math.floor(Math.random() * 12) + 18 :  // 18-29: 15%
                     edadBase < 0.40 ? Math.floor(Math.random() * 15) + 30 :  // 30-44: 25%
                     edadBase < 0.70 ? Math.floor(Math.random() * 15) + 45 :  // 45-59: 30%
                     Math.floor(Math.random() * 25) + 60;                      // 60-84: 30%
        
        // Generar 1-3 objetivos aleatorios (sin repetir)
        const numObjetivos = Math.floor(Math.random() * 3) + 1; // 1, 2 o 3
        const objetivosDisponibles = [1,2,3,4,5,6,7,8,9,10];
        const objetivosSeleccionados = [];
        for (let i = 0; i < numObjetivos; i++) {
            const idx = Math.floor(Math.random() * objetivosDisponibles.length);
            objetivosSeleccionados.push(objetivosDisponibles[idx]);
            objetivosDisponibles.splice(idx, 1);
        }
        
        // Generar 1-3 colectivos aleatorios (sin repetir)
        const numColectivos = Math.floor(Math.random() * 3) + 1; // 1, 2 o 3
        const colectivosDisponibles = [1,2,3,4,5,6,7,8];
        const colectivosSeleccionados = [];
        for (let i = 0; i < numColectivos; i++) {
            const idx = Math.floor(Math.random() * colectivosDisponibles.length);
            colectivosSeleccionados.push(colectivosDisponibles[idx]);
            colectivosDisponibles.splice(idx, 1);
        }
        
        const voto = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            timestamp: Date.now(),
            sexo: sexo,
            edad: edad,
            objetivos_epvsa: objetivosSeleccionados,
            colectivos: colectivosSeleccionados
        };
        
        db.ref('votaciones/' + municipio + '/' + votacionSessionId + '/respuestas').push(voto);
        count++;
        
        // Actualizar progreso cada 10 votos
        if (count % 10 === 0 && toast) {
            actualizarNotificacion(toast, {mensaje: 'Generando votos: ' + count + '/' + totalVotos});
        }
    }, 100);
}

// ==================== MODO ENCUESTA (CIUDADANOS) ====================

function initEncuestaMode() {
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('v');
    const municipio = params.get('m');
    
    if (sessionId) {
        // Ocultar todos los elementos del panel principal
        document.querySelectorAll('header.header, .franja, .relas-container, .main, #toast-container').forEach(el => {
            if (el) el.style.display = 'none';
        });
        
        // Mostrar modo encuesta
        const encuestaMode = document.getElementById('encuesta-mode');
        if (encuestaMode) {
            encuestaMode.style.display = 'block';
        }
        
        // Establecer el t√≠tulo
        const h1Element = document.querySelector('#encuesta-mode .header h1');
        if (h1Element) {
            h1Element.innerHTML = `‚öñÔ∏è Votaci√≥n popular`;
        }
        
        votacionSessionId = sessionId;
        encuestaSeccionActual = 0;
        encuestaDatos = {};
        
        renderizarEncuesta();
    }
}

function renderizarEncuesta() {
    const seccion = ENCUESTA_SECCIONES[encuestaSeccionActual];
    const progress = ((encuestaSeccionActual + 1) / ENCUESTA_SECCIONES.length) * 100;
    document.getElementById('encuesta-progress-bar').style.width = progress + '%';
    
    let html = `
        <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.25rem;">
                Paso ${encuestaSeccionActual + 1} de ${ENCUESTA_SECCIONES.length}
            </div>
            <h3 style="color: #1e293b; margin: 0;">${seccion.titulo}</h3>
        </div>
    `;
    
    seccion.preguntas.forEach(p => {
        html += renderizarPreguntaEncuesta(p);
    });
    
    html += `
        <div class="encuesta-nav">
            <button class="encuesta-nav-btn anterior" onclick="encuestaAnterior()" ${encuestaSeccionActual === 0 ? 'disabled' : ''}>
                ‚Üê Anterior
            </button>
            ${encuestaSeccionActual === ENCUESTA_SECCIONES.length - 1 
                ? '<button class="encuesta-nav-btn enviar" onclick="enviarEncuesta()">Enviar ‚úì</button>'
                : '<button class="encuesta-nav-btn siguiente" onclick="encuestaSiguiente()">Siguiente ‚Üí</button>'
            }
        </div>
    `;
    
    document.getElementById('encuesta-contenido').innerHTML = html;
}

function renderizarPreguntaEncuesta(pregunta) {
    let html = `<div class="encuesta-pregunta"><label>${pregunta.label}</label>`;
    
    if (pregunta.nota) {
        html += `<div class="nota">${pregunta.nota}</div>`;
    }
    
    if (pregunta.tipo === 'opciones') {
        const opciones = pregunta.opciones === 'OPCIONES_SEXO' ? OPCIONES_SEXO 
                       : pregunta.opciones === 'OBJETIVOS_EPVSA' ? OBJETIVOS_EPVSA 
                       : COLECTIVOS_PRIORITARIOS;
        
        html += '<div class="encuesta-opciones">';
        opciones.forEach(op => {
            const selected = encuestaDatos[pregunta.id] == op.id ? 'selected' : '';
            html += `
                <div class="encuesta-opcion ${selected}" onclick="seleccionarOpcion('${pregunta.id}', ${op.id}, this)">
                    <input type="radio" name="${pregunta.id}" value="${op.id}">
                    <span class="icono">${op.icono}</span>
                    <span class="texto">${op.texto}</span>
                </div>
            `;
        });
        html += '</div>';
    } else if (pregunta.tipo === 'opciones_multiples') {
        const opciones = pregunta.opciones === 'OPCIONES_SEXO' ? OPCIONES_SEXO 
                       : pregunta.opciones === 'OBJETIVOS_EPVSA' ? OBJETIVOS_EPVSA 
                       : COLECTIVOS_PRIORITARIOS;
        
        const maxSeleccion = pregunta.max || 3;
        
        html += '<div class="encuesta-opciones">';
        opciones.forEach(op => {
            const seleccionados = encuestaDatos[pregunta.id] || [];
            const selected = Array.isArray(seleccionados) && seleccionados.includes(op.id) ? 'selected' : '';
            html += `
                <div class="encuesta-opcion ${selected}" onclick="seleccionarOpcionMultiple('${pregunta.id}', ${op.id}, ${maxSeleccion}, this)">
                    <input type="checkbox" class="checkbox-${pregunta.id}" value="${op.id}" ${selected ? 'checked' : ''}>
                    <span class="icono">${op.icono}</span>
                    <span class="texto">${op.texto}</span>
                </div>
            `;
        });
        html += '</div>';
    } else if (pregunta.tipo === 'numero') {
        html += `
            <input type="number" class="encuesta-input-edad" 
                   min="${pregunta.min || ''}" max="${pregunta.max || ''}" 
                   value="${encuestaDatos[pregunta.id] || ''}" 
                   onchange="encuestaDatos['${pregunta.id}'] = this.value"
                   placeholder="Introduce tu edad">
        `;
    }
    
    html += '</div>';
    return html;
}

function seleccionarOpcion(campo, valor, elemento) {
    encuestaDatos[campo] = valor;
    elemento.parentElement.querySelectorAll('.encuesta-opcion').forEach(op => op.classList.remove('selected'));
    elemento.classList.add('selected');
}

function seleccionarOpcionMultiple(campo, valor, maxSeleccion, elemento) {
    // Inicializar array si no existe
    if (!encuestaDatos[campo]) {
        encuestaDatos[campo] = [];
    }
    
    const index = encuestaDatos[campo].indexOf(valor);
    
    if (index > -1) {
        // Ya est√° seleccionado, deseleccionar
        encuestaDatos[campo].splice(index, 1);
        elemento.classList.remove('selected');
        const checkbox = elemento.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = false;
    } else {
        // Verificar l√≠mite
        if (encuestaDatos[campo].length >= maxSeleccion) {
            alert(`Solo puedes seleccionar hasta ${maxSeleccion} opciones`);
            return;
        }
        // Agregar selecci√≥n
        encuestaDatos[campo].push(valor);
        elemento.classList.add('selected');
        const checkbox = elemento.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = true;
    }
}

function encuestaSiguiente() {
    // Validar secci√≥n actual
    const seccion = ENCUESTA_SECCIONES[encuestaSeccionActual];
    for (const p of seccion.preguntas) {
        const valor = encuestaDatos[p.id];
        // Validar que exista y si es array que tenga al menos un elemento
        if (!valor || (Array.isArray(valor) && valor.length === 0)) {
            alert('Por favor, responde todas las preguntas antes de continuar');
            return;
        }
    }
    
    if (encuestaSeccionActual < ENCUESTA_SECCIONES.length - 1) {
        encuestaSeccionActual++;
        renderizarEncuesta();
        window.scrollTo(0, 0);
    }
}

function encuestaAnterior() {
    if (encuestaSeccionActual > 0) {
        encuestaSeccionActual--;
        renderizarEncuesta();
        window.scrollTo(0, 0);
    }
}

function enviarEncuesta() {
    // Validar √∫ltima secci√≥n
    const seccion = ENCUESTA_SECCIONES[encuestaSeccionActual];
    for (const p of seccion.preguntas) {
        const valor = encuestaDatos[p.id];
        // Validar que exista y si es array que tenga al menos un elemento
        if (!valor || (Array.isArray(valor) && valor.length === 0)) {
            alert('Por favor, responde todas las preguntas antes de enviar');
            return;
        }
    }
    
    // Preparar datos
    const params = new URLSearchParams(window.location.search);
    const municipio = params.get('m') || 'municipio';
    
    encuestaDatos.id = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    encuestaDatos.timestamp = Date.now();
    
    // Guardar en Firebase
    db.ref('votaciones/' + decodeURIComponent(municipio) + '/' + votacionSessionId + '/respuestas').push(encuestaDatos);
    
    // Mostrar confirmaci√≥n
    document.getElementById('encuesta-contenido').innerHTML = `
        <div class="encuesta-completada">
            <div class="icono">‚úÖ</div>
            <h2>¬°Gracias por participar!</h2>
            <p>Tu voto ha sido registrado correctamente.</p>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #94a3b8;">
                Tu opini√≥n contribuir√° a definir las prioridades del Plan local de salud.
            </p>
        </div>
    `;
    document.getElementById('encuesta-progress-bar').style.width = '100%';
}

// Inicializar modo encuesta al cargar
document.addEventListener('DOMContentLoaded', function() {
    // Peque√±o delay para asegurar que Firebase est√° inicializado
    setTimeout(initEncuestaMode, 100);
    
    // Cargar selector de territorios seg√∫n la estrategia inicial
    recargarSelectorTerritorios();
    
    // Actualizar footer con versi√≥n
    const footerVersion = document.getElementById('footer-version');
    if (footerVersion && typeof COMPAS_VERSION !== 'undefined') {
        footerVersion.innerHTML = COMPAS_VERSION.footer;
    }
});

// =====================================================
// VERIFICACI√ìN DE CONTENIDO CARGADO
// =====================================================

// NUEVA FUNCI√ìN: Verificar contenido cargado
function verificarContenido() {
    const contenido = {
        firebase: {
            conectado: typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0,
            db: null
        },
        municipios: {
            total: 0,
            lista: [],
            conDatos: 0,
            sinDatos: 0,
            detalles: []
        }
    };
    
    // Verificar Firebase
    try {
        if (contenido.firebase.conectado) {
            contenido.firebase.db = firebase.database();
        }
    } catch(e) {
        contenido.firebase.conectado = false;
    }
    
    // Contar municipios en el selector
    const selector = document.getElementById('municipio');
    if (selector) {
        const opciones = Array.from(selector.options).filter(opt => opt.value !== '');
        contenido.municipios.total = opciones.length;
        contenido.municipios.lista = opciones.map(opt => ({
            id: opt.value,
            nombre: opt.textContent
        }));
        
        // Verificar qu√© municipios tienen datos
        opciones.forEach(opt => {
            const municipioId = opt.value;
            const detalle = {
                id: municipioId,
                nombre: opt.textContent,
                archivos: {
                    indicadores: false,
                    determinantes: false,
                    conclusiones: false,
                    recomendaciones: false,
                    priorizacion: false,
                    informe: false
                },
                completitud: 0,
                total: 6
            };
            
            // Verificar en Firebase (si est√° conectado)
            if (contenido.firebase.conectado && typeof paquetesMunicipales !== 'undefined' && paquetesMunicipales[municipioId]) {
                const paquete = paquetesMunicipales[municipioId];
                detalle.archivos.indicadores = !!(paquete.indicadores);
                detalle.archivos.determinantes = !!(paquete.determinantes);
                detalle.archivos.conclusiones = !!(paquete.conclusiones);
                detalle.archivos.recomendaciones = !!(paquete.recomendaciones);
                detalle.archivos.priorizacion = !!(paquete.priorizacion);
                detalle.archivos.informe = !!(paquete.informe);
                
                const cargados = Object.values(detalle.archivos).filter(Boolean).length;
                detalle.completitud = Math.round((cargados / detalle.total) * 100);
                
                if (cargados > 0) {
                    contenido.municipios.conDatos++;
                } else {
                    contenido.municipios.sinDatos++;
                }
            } else {
                contenido.municipios.sinDatos++;
            }
            
            contenido.municipios.detalles.push(detalle);
        });
    }
    
    return contenido;
}

function actualizarUIAutoDiagnostico(resultados, stats) {
    // Actualizar estado principal
    const estadoDiv = document.getElementById('diagnostico-estado');
    const emoji = stats.criticos === 0 ? '‚úÖ' : (stats.criticos <= 2 ? '‚ö†Ô∏è' : '‚ùå');
    const estado = stats.criticos === 0 ? 'OPERATIVO' : (stats.criticos <= 2 ? 'DEGRADADO' : 'CR√çTICO');
    const color = stats.criticos === 0 ? '#10b981' : (stats.criticos <= 2 ? '#ffb61b' : '#dc143c');
    
    estadoDiv.innerHTML = `
        <div style="font-size: 1.2rem; color: #64748b; margin-bottom: 0.5rem;">
            Estado del Sistema
        </div>
        <div style="font-size: 3rem; margin-bottom: 0.5rem;">
            ${emoji}
        </div>
        <div style="font-size: 1.3rem; color: ${color}; font-weight: 700;">
            ${estado}
        </div>
        <div style="font-size: 0.85rem; color: #94a3b8; margin-top: 0.5rem;">
            ${stats.pasados}/${stats.total} tests (${stats.porcentaje}%)
        </div>
        <div style="font-size: 0.85rem; color: #94a3b8;">
            √öltima verificaci√≥n: ${new Date().toLocaleString('es-ES')}
        </div>
    `;
    estadoDiv.style.borderColor = color;
    estadoDiv.style.background = `linear-gradient(135deg, ${color}15 0%, ${color}10 100%)`;
    
    // Mostrar resultados detallados
    const resultadosDiv = document.getElementById('diagnostico-resultados');
    resultadosDiv.style.display = 'block';
    
    let html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: ${stats.criticos === 0 ? '#10b981' : '#dc143c'};">
                    ${stats.criticos}
                </div>
                <div style="font-size: 0.85rem; color: #64748b; text-transform: uppercase;">
                    Cr√≠ticos
                </div>
            </div>
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1.5rem; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: 700; color: #0074c8;">
                    ${stats.porcentaje}%
                </div>
                <div style="font-size: 0.85rem; color: #64748b; text-transform: uppercase;">
                    √âxito
                </div>
            </div>
        </div>
        
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Constantes: ${Object.values(resultados.constantes).filter(Boolean).length}/${Object.keys(resultados.constantes).length}</div>
            ${Object.entries(resultados.constantes).map(([k, v]) => 
                `<div style="padding: 0.25rem 0; color: ${v ? '#10b981' : '#dc143c'};">
                    ${v ? '‚úì' : '‚úó'} ${k}
                </div>`
            ).join('')}
        </div>
        
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Funciones: ${Object.values(resultados.funciones).filter(Boolean).length}/${Object.keys(resultados.funciones).length}</div>
            ${Object.entries(resultados.funciones).slice(0, 5).map(([k, v]) => 
                `<div style="padding: 0.25rem 0; color: ${v ? '#10b981' : '#dc143c'};">
                    ${v ? '‚úì' : '‚úó'} ${k}()
                </div>`
            ).join('')}
            ${Object.keys(resultados.funciones).length > 5 ? `<div style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem;">... y ${Object.keys(resultados.funciones).length - 5} m√°s</div>` : ''}
        </div>
        
        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Paleta de Colores</div>
            <div style="padding: 0.25rem 0; color: ${resultados.paleta.prohibidos.length === 0 ? '#10b981' : '#dc143c'};">
                ${resultados.paleta.prohibidos.length === 0 ? '‚úì' : '‚úó'} ${resultados.paleta.prohibidos.length} colores prohibidos
            </div>
            ${resultados.paleta.prohibidos.length > 0 ? 
                `<div style="margin-top: 0.5rem; padding: 0.5rem; background: #fef2f2; border-radius: 4px; font-size: 0.85rem;">
                    ${resultados.paleta.prohibidos.slice(0, 5).join(', ')}
                    ${resultados.paleta.prohibidos.length > 5 ? ` ... +${resultados.paleta.prohibidos.length - 5}` : ''}
                </div>` 
                : ''
            }
        </div>
        
        <!-- NUEVA SECCI√ìN: AN√ÅLISIS DE CONTENIDO -->
        <div style="background: linear-gradient(135deg, #0074c815 0%, #00acd915 100%); border: 2px solid #0074c8; border-radius: 12px; padding: 1.5rem; margin: 2rem 0;">
            <h3 style="color: #0074c8; margin: 0 0 1rem 0; display: flex; align-items: center; gap: 0.5rem;">
                üìä An√°lisis de Contenido
            </h3>
            
            <!-- Firebase -->
            <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; margin-bottom: 0.5rem;">
                    ${resultados.contenido.firebase.conectado ? 'üî•' : '‚ö†Ô∏è'} Firebase
                    <span style="margin-left: auto; color: ${resultados.contenido.firebase.conectado ? '#10b981' : '#ff6600'}; font-size: 0.85rem;">
                        ${resultados.contenido.firebase.conectado ? 'Conectado' : 'Desconectado'}
                    </span>
                </div>
            </div>
            
            <!-- Municipios -->
            <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <div style="font-weight: 600;">üìç Municipios en Selector</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #0074c8;">
                        ${resultados.contenido.municipios.total}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">
                    <div style="background: #f0fff4; padding: 0.75rem; border-radius: 6px; text-align: center; border-left: 3px solid #10b981;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${resultados.contenido.municipios.conDatos}</div>
                        <div style="font-size: 0.75rem; color: #64748b;">Con datos</div>
                    </div>
                    <div style="background: #fef2f2; padding: 0.75rem; border-radius: 6px; text-align: center; border-left: 3px solid #dc143c;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #dc143c;">${resultados.contenido.municipios.sinDatos}</div>
                        <div style="font-size: 0.75rem; color: #64748b;">Sin datos</div>
                    </div>
                </div>
                
                <!-- Detalles por municipio -->
                ${resultados.contenido.municipios.detalles.map(m => {
                    const emoji = m.completitud === 100 ? '‚úÖ' : (m.completitud > 0 ? '‚ö†Ô∏è' : '‚ùå');
                    const color = m.completitud === 100 ? '#10b981' : (m.completitud > 0 ? '#ffb61b' : '#dc143c');
                    const archivosTexto = Object.entries(m.archivos)
                        .filter(([k, v]) => v)
                        .map(([k, v]) => k)
                        .join(', ') || 'ninguno';
                    
                    return `
                        <div style="border-top: 1px solid #e2e8f0; padding: 0.75rem 0;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                <span style="font-size: 1.2rem;">${emoji}</span>
                                <span style="font-weight: 600;">${m.nombre}</span>
                                <span style="margin-left: auto; font-size: 0.85rem; font-weight: 600; color: ${color};">
                                    ${m.completitud}%
                                </span>
                            </div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-left: 2rem;">
                                ${Object.values(m.archivos).filter(Boolean).length}/${m.total} archivos: ${archivosTexto}
                            </div>
                            <!-- Barra de progreso -->
                            <div style="background: #e2e8f0; height: 4px; border-radius: 2px; margin: 0.5rem 0 0 2rem; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${m.completitud}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 2rem;">
            <button onclick="exportarInformeDiagnostico()" class="btn-accion secundario">
                üì• Exportar informe completo
            </button>
        </div>
    `;
    
    resultadosDiv.innerHTML = html;
}

function guardarHistorialDiagnostico(datos) {
    try {
        let historial = JSON.parse(localStorage.getItem('diagnostico_historial') || '[]');
        historial.unshift({
            fecha: new Date().toISOString(),
            ...datos.stats
        });
        historial = historial.slice(0, 10); // M√°ximo 10 entradas
        localStorage.setItem('diagnostico_historial', JSON.stringify(historial));
        actualizarHistorialUI();
    } catch(e) {
        console.error('Error guardando historial:', e);
    }
}

function actualizarHistorialUI() {
    try {
        const historial = JSON.parse(localStorage.getItem('diagnostico_historial') || '[]');
        const listaDiv = document.getElementById('diagnostico-historial-lista');
        
        if (historial.length === 0) {
            listaDiv.innerHTML = '<p style="color: #94a3b8; text-align: center;">No hay verificaciones previas</p>';
            return;
        }
        
        listaDiv.innerHTML = historial.map(h => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #f1f5f9;">
                <div>
                    <div style="font-weight: 500;">${new Date(h.fecha).toLocaleString('es-ES')}</div>
                    <div style="font-size: 0.85rem; color: #64748b;">${h.pasados}/${h.total} tests (${h.porcentaje}%)</div>
                </div>
                <div style="font-size: 1.5rem;">
                    ${h.criticos === 0 ? '‚úÖ' : (h.criticos <= 2 ? '‚ö†Ô∏è' : '‚ùå')}
                </div>
            </div>
        `).join('');
    } catch(e) {}
}

function exportarInformeDiagnostico() {
    // Crear informe similar al del validador externo
    const timestamp = new Date().toISOString();
    const informe = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë              COMP√ÅS v2.4 - AUTO-DIAGN√ìSTICO DEL SISTEMA                   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìÖ FECHA: ${new Date().toLocaleString('es-ES')}
‚è±Ô∏è  GENERADO: Internamente por el sistema

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Este informe fue generado por el propio sistema COMP√ÅS mediante metareflexividad.

Para m√°s detalles, ejecuta el diagn√≥stico desde la Fase 6 (üîç Sistema).

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;
    
    const blob = new Blob([informe], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `compas_autodiagnostico_${timestamp.split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ============================================
// KITS DE REUNI√ìN - DOCUMENTOS DEL PROCESO
// ============================================

function toggleKitReunion(num) {
    const contenido = document.getElementById('kit-' + num + '-contenido');
    const toggle = document.getElementById('kit-' + num + '-toggle');
    if (contenido.style.display === 'none') {
        contenido.style.display = 'block';
        toggle.textContent = '‚ñº';
    } else {
        contenido.style.display = 'none';
        toggle.textContent = '‚ñ∂';
    }
}

// ============================================
// REUNI√ìN 1: TALLER DE IMPULSO
// ============================================

function generarConvocatoriaTaller() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    const fecha = document.getElementById('taller-fecha')?.value || '';
    const hora = document.getElementById('taller-hora')?.value || '10:00';
    const lugar = document.getElementById('taller-lugar')?.value || 'Sal√≥n de Plenos del Ayuntamiento';
    
    if (!fecha) {
        mostrarNotificacion({ title: '‚ö†Ô∏è Fecha requerida', message: 'Indica la fecha del Taller', type: 'warning', duration: 3000 });
        return;
    }
    
    const fechaFormateada = new Date(fecha).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Convocatoria Taller de Impulso - ${nombre}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.6; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #0074c8; padding-bottom: 15px; margin-bottom: 25px; }
        .header img { height: 50px; }
        .titulo { text-align: center; margin: 30px 0; }
        .titulo h1 { color: #0074c8; font-size: 18pt; margin: 0; }
        .titulo h2 { color: #1e293b; font-size: 14pt; margin: 10px 0 0 0; font-weight: normal; }
        .datos { background: #f8fafc; border-left: 4px solid #0074c8; padding: 15px 20px; margin: 25px 0; }
        .datos p { margin: 8px 0; }
        .datos strong { color: #0074c8; }
        .orden-dia { margin: 25px 0; }
        .orden-dia h3 { color: #1e293b; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        .orden-dia ol { margin: 15px 0 15px 25px; }
        .orden-dia li { margin: 10px 0; padding-left: 10px; }
        .nota { background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 15px; margin: 25px 0; font-size: 10pt; }
        .footer { margin-top: 40px; text-align: center; color: #64748b; font-size: 9pt; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    </style>
</head>
<body>
    <div class="header">
        ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a de Salud">` : '<div></div>'}
        ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito sanitario">` : '<div></div>'}
    </div>
    
    <div class="titulo">
        <h1>CONVOCATORIA</h1>
        <h2>Taller de Impulso del Plan local de salud de ${nombre}</h2>
    </div>
    
    <p>Desde la <strong>Unidad de Prevenci√≥n, Promoci√≥n y Vigilancia de la Salud</strong> del Distrito sanitario Granada-Metropolitano, en el marco de la <strong>Red local de acci√≥n en salud de Andaluc√≠a (RELAS)</strong>, tenemos el placer de invitarle al <strong>Taller de Impulso</strong> del Plan local de salud de ${nombre}.</p>
    
    <div class="datos">
        <p><strong>üìÖ Fecha:</strong> ${fechaFormateada}</p>
        <p><strong>üïê Hora:</strong> ${hora} h</p>
        <p><strong>üìç Lugar:</strong> ${lugar}</p>
    </div>
    
    <div class="orden-dia">
        <h3>Orden del d√≠a</h3>
        <ol>
            <li><strong>Bienvenida y presentaci√≥n</strong> ‚Äî Representante municipal</li>
            <li><strong>Marco de la acci√≥n local en salud</strong> ‚Äî Estrategia de Promoci√≥n de vida saludable en Andaluc√≠a (EPVSA) y Red local de acci√≥n en salud (RELAS)</li>
            <li><strong>Presentaci√≥n del Informe sobre la Situaci√≥n de Salud de ${nombre}</strong> ‚Äî Unidad de Epidemiolog√≠a</li>
            <li><strong>Hoja de ruta del Plan local de salud</strong> ‚Äî Metodolog√≠a y fases del proceso</li>
            <li><strong>Constituci√≥n del Grupo motor</strong> ‚Äî Inscripci√≥n de participantes</li>
            <li><strong>Turno abierto de palabra</strong></li>
        </ol>
    </div>
    
    <div class="nota">
        <strong>üìù Nota:</strong> Se ruega confirmaci√≥n de asistencia. Las personas interesadas en formar parte del <strong>Grupo motor</strong> del Plan local de salud podr√°n inscribirse durante el taller o mediante el formulario adjunto.
    </div>
    
    <p>Quedamos a su disposici√≥n para cualquier consulta.</p>
    
    <p style="margin-top: 30px;">Atentamente,</p>
    <p><strong>Unidad de Prevenci√≥n, Promoci√≥n y Vigilancia de la Salud</strong><br>
    Distrito sanitario Granada-Metropolitano</p>
    
    <div class="footer">
        <p>' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Convocatoria_Taller_' + nombre);
}

function generarFormularioGrupoMotor() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario grupo motor - ${nombre}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.6; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; border-bottom: 3px solid #0074c8; padding-bottom: 15px; margin-bottom: 25px; }
        .header img { height: 50px; }
        .titulo { text-align: center; margin: 20px 0 30px 0; }
        .titulo h1 { color: #0074c8; font-size: 16pt; margin: 0; }
        .titulo p { color: #64748b; margin: 8px 0 0 0; }
        .campo { margin: 20px 0; }
        .campo label { display: block; font-weight: 600; color: #1e293b; margin-bottom: 5px; }
        .campo input, .campo select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 11pt; box-sizing: border-box; }
        .campo-linea { border-bottom: 1px solid #1e293b; min-height: 25px; margin-top: 5px; }
        .seccion { background: #f8fafc; padding: 15px; border-radius: 8px; margin: 25px 0; }
        .seccion h3 { color: #0074c8; margin: 0 0 15px 0; font-size: 12pt; }
        .checkbox-grupo { margin: 15px 0; }
        .checkbox-grupo label { display: flex; align-items: center; gap: 10px; margin: 8px 0; font-weight: normal; }
        .checkbox-grupo input[type="checkbox"] { width: 18px; height: 18px; }
        .firma { margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .firma div { text-align: center; }
        .firma-linea { border-bottom: 1px solid #1e293b; height: 60px; margin-bottom: 5px; }
        .nota { background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; padding: 12px; margin: 20px 0; font-size: 9pt; }
        .footer { margin-top: 30px; text-align: center; color: #64748b; font-size: 8pt; }
    </style>
</head>
<body>
    <div class="header">
        ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a de Salud">` : ''}
    </div>
    
    <div class="titulo">
        <h1>FORMULARIO DE INSCRIPCI√ìN AL GRUPO MOTOR</h1>
        <p>Plan local de salud de ${nombre} 2026-2030</p>
    </div>
    
    <div class="seccion">
        <h3>Datos personales</h3>
        <div class="campo">
            <label>Nombre y apellidos</label>
            <div class="campo-linea"></div>
        </div>
        <div class="campo">
            <label>Tel√©fono de contacto</label>
            <div class="campo-linea"></div>
        </div>
        <div class="campo">
            <label>Correo electr√≥nico</label>
            <div class="campo-linea"></div>
        </div>
    </div>
    
    <div class="seccion">
        <h3>Datos de representaci√≥n</h3>
        <div class="campo">
            <label>Organizaci√≥n / Entidad / Colectivo</label>
            <div class="campo-linea"></div>
        </div>
        <div class="campo">
            <label>Cargo / Funci√≥n</label>
            <div class="campo-linea"></div>
        </div>
        <div class="campo">
            <label>Sector</label>
            <div class="checkbox-grupo">
                <label><input type="checkbox"> Ayuntamiento</label>
                <label><input type="checkbox"> Sanidad</label>
                <label><input type="checkbox"> Educaci√≥n</label>
                <label><input type="checkbox"> Servicios Sociales</label>
                <label><input type="checkbox"> Asociaciones / Ciudadan√≠a</label>
                <label><input type="checkbox"> Otro: ________________</label>
            </div>
        </div>
    </div>
    
    <div class="seccion">
        <h3>Participaci√≥n</h3>
        <p>Deseo participar en: (puede marcar varias opciones)</p>
        <div class="checkbox-grupo">
            <label><input type="checkbox"> <strong>Grupo motor</strong> ‚Äî √ìrgano de coordinaci√≥n y seguimiento del Plan</label>
            <label><input type="checkbox"> <strong>Grupos de Trabajo</strong> ‚Äî Equipos tem√°ticos seg√∫n √°reas priorizadas</label>
            <label><input type="checkbox"> <strong>Actividades puntuales</strong> ‚Äî Colaboraci√≥n en acciones concretas</label>
        </div>
    </div>
    
    <div class="nota">
        <strong>Protecci√≥n de datos:</strong> Los datos recogidos ser√°n tratados conforme a la normativa vigente de protecci√≥n de datos (RGPD) y utilizados exclusivamente para la gesti√≥n del Plan local de salud.
    </div>
    
    <div class="firma">
        <div>
            <div class="firma-linea"></div>
            <p>Firma</p>
        </div>
        <div>
            <div class="firma-linea"></div>
            <p>Fecha</p>
        </div>
    </div>
    
    <div class="footer">
        <p>' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Formulario_GrupoMotor_' + nombre);
}

function generarActaTaller() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    const fecha = document.getElementById('taller-fecha')?.value || '';
    const hora = document.getElementById('taller-hora')?.value || '10:00';
    const lugar = document.getElementById('taller-lugar')?.value || '';
    
    const fechaFormateada = fecha ? new Date(fecha).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : '[FECHA]';
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Acta Taller de Impulso - ${nombre}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.6; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #0074c8; padding-bottom: 15px; margin-bottom: 25px; }
        .header img { height: 50px; }
        .titulo { text-align: center; margin: 20px 0 30px 0; }
        .titulo h1 { color: #0074c8; font-size: 16pt; margin: 0; }
        .titulo h2 { color: #1e293b; font-size: 12pt; margin: 8px 0 0 0; font-weight: normal; }
        .datos { background: #f8fafc; border-left: 4px solid #0074c8; padding: 15px 20px; margin: 20px 0; }
        .seccion { margin: 25px 0; }
        .seccion h3 { color: #0074c8; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; font-size: 12pt; }
        .campo-rellenar { border-bottom: 1px dotted #64748b; min-height: 20px; display: inline-block; min-width: 200px; }
        .campo-area { border: 1px solid #d1d5db; border-radius: 6px; min-height: 80px; padding: 10px; margin: 10px 0; }
        .asistentes-tabla { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .asistentes-tabla th, .asistentes-tabla td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
        .asistentes-tabla th { background: #f8fafc; }
        .firma { margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .firma div { text-align: center; }
        .firma-linea { border-bottom: 1px solid #1e293b; height: 60px; margin-bottom: 5px; }
        .footer { margin-top: 30px; text-align: center; color: #64748b; font-size: 8pt; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    </style>
</head>
<body>
    <div class="header">
        ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a de Salud">` : '<div></div>'}
        ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito sanitario">` : '<div></div>'}
    </div>
    
    <div class="titulo">
        <h1>ACTA DEL TALLER DE IMPULSO</h1>
        <h2>Plan local de salud de ${nombre} 2026-2030</h2>
    </div>
    
    <div class="datos">
        <p><strong>Fecha:</strong> ${fechaFormateada}</p>
        <p><strong>Hora de inicio:</strong> ${hora} h ‚Äî <strong>Hora de finalizaci√≥n:</strong> <span class="campo-rellenar"></span></p>
        <p><strong>Lugar:</strong> ${lugar || '[LUGAR]'}</p>
    </div>
    
    <div class="seccion">
        <h3>1. Asistentes</h3>
        <table class="asistentes-tabla">
            <tr><th style="width:35%">Nombre</th><th style="width:35%">Organizaci√≥n</th><th style="width:30%">Sector</th></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
        </table>
        <p><strong>Total asistentes:</strong> <span class="campo-rellenar" style="min-width: 50px;"></span></p>
    </div>
    
    <div class="seccion">
        <h3>2. Desarrollo de la sesi√≥n</h3>
        <p><strong>2.1. Bienvenida institucional</strong></p>
        <div class="campo-area"></div>
        
        <p><strong>2.2. Presentaci√≥n del Informe de Situaci√≥n de Salud</strong></p>
        <div class="campo-area"></div>
        
        <p><strong>2.3. Hoja de ruta del Plan local de salud</strong></p>
        <div class="campo-area"></div>
    </div>
    
    <div class="seccion">
        <h3>3. Constituci√≥n del Grupo motor</h3>
        <p>Se constituye el Grupo motor del Plan local de salud de ${nombre} con las siguientes personas:</p>
        <div class="campo-area" style="min-height: 100px;"></div>
    </div>
    
    <div class="seccion">
        <h3>4. Acuerdos adoptados</h3>
        <div class="campo-area"></div>
    </div>
    
    <div class="seccion">
        <h3>5. Pr√≥ximos pasos</h3>
        <div class="campo-area"></div>
    </div>
    
    <div class="firma">
        <div>
            <div class="firma-linea"></div>
            <p>Por el Ayuntamiento de ${nombre}</p>
        </div>
        <div>
            <div class="firma-linea"></div>
            <p>Por el Distrito sanitario</p>
        </div>
    </div>
    
    <div class="footer">
        <p>' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Acta_Taller_' + nombre);
}

// ============================================
// REUNI√ìN 4: RENDICI√ìN DE CUENTAS
// ============================================

function generarPropuestaPleno() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    const fechaPleno = document.getElementById('pleno-fecha')?.value || '';
    const tipoSesion = document.getElementById('pleno-tipo')?.value || 'ordinaria';
    
    const fechaFormateada = fechaPleno ? new Date(fechaPleno).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' }) : '[FECHA]';
    
    // Obtener datos de participaci√≥n si existen
    const participacion = window.datosParticipacionCiudadana;
    const decision = window.decisionPriorizacionActual;
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    
    let seccionParticipacion = '';
    if (participacion) {
        seccionParticipacion = `
        <p>El proceso ha incorporado <strong>participaci√≥n ciudadana directa</strong> mediante consulta popular (${participacion.totalParticipantes} participantes), identificando como objetivo prioritario "${participacion.objetivoPrioritario.texto}" y como colectivo prioritario "${participacion.colectivoPrioritario.texto}".</p>
        `;
    }
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Propuesta de Acuerdo - Plan local de salud ${nombre}</title>
    <style>
        @page { size: A4; margin: 25mm 20mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.7; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid #1e293b; }
        .header h1 { font-size: 14pt; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
        .header h2 { font-size: 11pt; margin: 10px 0 0 0; font-weight: normal; color: #64748b; }
        .meta { background: #f8fafc; padding: 12px 15px; margin: 20px 0; border-radius: 6px; }
        .meta p { margin: 5px 0; }
        .seccion { margin: 25px 0; }
        .seccion h3 { font-size: 11pt; color: #1e293b; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .propuesta-acuerdo { background: #eff6ff; border: 2px solid #0074c8; border-radius: 8px; padding: 20px; margin: 30px 0; }
        .propuesta-acuerdo h3 { color: #0074c8; text-align: center; margin: 0 0 15px 0; }
        .propuesta-acuerdo p { text-align: justify; }
        .compromiso { margin: 10px 0; padding-left: 20px; }
        .compromiso li { margin: 8px 0; }
        .firma { margin-top: 50px; }
        .firma p { margin: 5px 0; }
        .footer { margin-top: 40px; text-align: center; color: #64748b; font-size: 8pt; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Ayuntamiento de ${nombre}</h1>
        <h2>Propuesta de Acuerdo al pleno municipal</h2>
    </div>
    
    <div class="meta">
        <p><strong>Sesi√≥n:</strong> ${tipoSesion.charAt(0).toUpperCase() + tipoSesion.slice(1)}</p>
        <p><strong>Fecha:</strong> ${fechaFormateada}</p>
        <p><strong>Asunto:</strong> Aprobaci√≥n del Plan local de salud de ${nombre} 2026-2030</p>
    </div>
    
    <div class="seccion">
        <h3>I. Antecedentes</h3>
        <p>El Ayuntamiento de ${nombre} formaliz√≥ su adhesi√≥n a la <strong>Red local de acci√≥n en salud de Andaluc√≠a (RELAS)</strong>, comprometi√©ndose a la elaboraci√≥n de un Plan local de salud acompasado con la <strong>Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a (EPVSA) 2024-2030</strong>.</p>
        <p>Durante el proceso de elaboraci√≥n se ha desarrollado un <strong>diagn√≥stico comunitario de salud</strong>, incluyendo el Informe sobre la Situaci√≥n de Salud del municipio, el an√°lisis de determinantes y un proceso de priorizaci√≥n participativo.</p>
        ${seccionParticipacion}
    </div>
    
    <div class="seccion">
        <h3>II. Marco Normativo</h3>
        <ul>
            <li>Ley 16/2011, de 23 de diciembre, de salud p√∫blica de Andaluc√≠a</li>
            <li>Estrategia de promoci√≥n de una vida saludable en Andaluc√≠a 2024-2030</li>
            <li>Compromisos derivados de la adhesi√≥n a RELAS</li>
            <li>Competencias municipales en materia de protecci√≥n de la salubridad p√∫blica (art. 25.2.j LRBRL)</li>
        </ul>
    </div>
    
    <div class="seccion">
        <h3>III. Contenido del Plan</h3>
        <p>el Plan local de salud de ${nombre} 2026-2030 incluye:</p>
        <ul>
            <li><strong>Perfil de salud local:</strong> Diagn√≥stico de la situaci√≥n de salud, determinantes y activos para la salud</li>
            <li><strong>Plan de acci√≥n:</strong> L√≠neas estrat√©gicas, objetivos e indicadores alineados con la EPVSA</li>
            <li><strong>Agenda anual:</strong> Programaci√≥n de actuaciones para el primer a√±o de vigencia</li>
        </ul>
    </div>
    
    <div class="seccion">
        <h3>IV. Compromisos</h3>
        <p>La aprobaci√≥n del Plan implica los siguientes compromisos municipales:</p>
        <ol class="compromiso">
            <li>Mantener el <strong>Grupo motor</strong> como √≥rgano de coordinaci√≥n y seguimiento</li>
            <li>Facilitar los recursos necesarios para la ejecuci√≥n de las actuaciones programadas</li>
            <li>Presentar <strong>informe anual de seguimiento</strong> ante el Pleno</li>
            <li>Colaborar con el Distrito sanitario en la evaluaci√≥n de resultados</li>
        </ol>
    </div>
    
    <div class="propuesta-acuerdo">
        <h3>PROPUESTA DE ACUERDO</h3>
        <p><strong>Primero.</strong> Aprobar el <strong>Plan local de salud de ${nombre} 2026-2030</strong>, que se adjunta como Anexo al presente acuerdo.</p>
        <p><strong>Segundo.</strong> Facultar al Sr./Sra. Alcalde/sa-Presidente/a para la firma de cuantos documentos sean necesarios para la ejecuci√≥n del presente acuerdo.</p>
        <p><strong>Tercero.</strong> Dar traslado del presente acuerdo a la Delegaci√≥n Territorial de Salud y Consumo de Granada y al Distrito sanitario Granada-Metropolitano.</p>
    </div>
    
    <div class="firma">
        <p>En ${nombre}, a ${fechaFormateada}</p>
        <p style="margin-top: 20px;"><strong>El/La Concejal/a Delegado/a</strong></p>
    </div>
    
    <div class="footer">
        <p>' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Propuesta_Pleno_' + nombre);
}

function generarDevolucionCiudadana() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    const participacion = window.datosParticipacionCiudadana;
    const decision = window.decisionPriorizacionActual;
    
    if (!participacion) {
        mostrarNotificacion({ title: '‚ö†Ô∏è Sin datos', message: 'No hay datos de participaci√≥n ciudadana para este municipio', type: 'warning', duration: 3000 });
        return;
    }
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    
    let metodoTexto = 'integraci√≥n de evidencia epidemiol√≥gica y participaci√≥n ciudadana';
    if (decision) {
        if (decision.metodo === 'epidemiologica') metodoTexto = 'prioridad epidemiol√≥gica';
        else if (decision.metodo === 'ciudadana') metodoTexto = 'prioridad ciudadana';
    }
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>devoluci√≥n ciudadana - ${nombre}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.6; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #6366f1; padding-bottom: 15px; margin-bottom: 25px; }
        .header img { height: 50px; }
        .titulo { text-align: center; margin: 30px 0; }
        .titulo h1 { color: #6366f1; font-size: 20pt; margin: 0; }
        .titulo h2 { color: #1e293b; font-size: 14pt; margin: 10px 0 0 0; font-weight: normal; }
        .gracias { background: linear-gradient(135deg, #eff6ff 0%, #f5f3ff 100%); border: 2px solid #6366f1; border-radius: 12px; padding: 25px; text-align: center; margin: 30px 0; }
        .gracias p { font-size: 12pt; margin: 0; }
        .resultado { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin: 20px 0; }
        .resultado h3 { color: #6366f1; margin: 0 0 15px 0; }
        .resultado-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; margin: 10px 0; }
        .resultado-icono { font-size: 2rem; }
        .resultado-dato { flex: 1; }
        .resultado-dato strong { display: block; font-size: 1.1rem; color: #1e293b; }
        .resultado-dato span { color: #6366f1; font-weight: 600; }
        .decision { background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin: 30px 0; }
        .decision h3 { color: #059669; margin: 0 0 10px 0; }
        .siguiente { margin: 30px 0; }
        .siguiente h3 { color: #1e293b; }
        .siguiente ul { margin: 10px 0 10px 20px; }
        .siguiente li { margin: 8px 0; }
        .footer { margin-top: 40px; text-align: center; color: #64748b; font-size: 9pt; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    </style>
</head>
<body>
    <div class="header">
        ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a de Salud">` : '<div></div>'}
        ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito sanitario">` : '<div></div>'}
    </div>
    
    <div class="titulo">
        <h1>üó≥Ô∏è ¬°GRACIAS POR PARTICIPAR!</h1>
        <h2>Resultados de la consulta ciudadana<br>Plan local de salud de ${nombre}</h2>
    </div>
    
    <div class="gracias">
        <p>Un total de <strong style="font-size: 1.5rem; color: #6366f1;">${participacion.totalParticipantes}</strong> personas hab√©is participado en la consulta ciudadana para definir las prioridades de salud de ${nombre}.</p>
    </div>
    
    <div class="resultado">
        <h3>üìä Esto es lo que dijisteis</h3>
        
        <div class="resultado-item">
            <div class="resultado-icono">${participacion.objetivoPrioritario.icono}</div>
            <div class="resultado-dato">
                <strong>Objetivo prioritario</strong>
                ${participacion.objetivoPrioritario.texto}
                <span>${participacion.objetivoPrioritario.porcentaje}% de los votos</span>
            </div>
        </div>
        
        <div class="resultado-item">
            <div class="resultado-icono">${participacion.colectivoPrioritario.icono}</div>
            <div class="resultado-dato">
                <strong>Colectivo prioritario</strong>
                ${participacion.colectivoPrioritario.texto}
                <span>${participacion.colectivoPrioritario.porcentaje}% de los votos</span>
            </div>
        </div>
    </div>
    
    <div class="decision">
        <h3>‚úÖ Esto es lo que hemos decidido</h3>
        <p>Tras analizar vuestras prioridades junto con los datos de salud del municipio, el Plan local de salud se ha elaborado con un enfoque de <strong>${metodoTexto}</strong>.</p>
        ${decision && decision.justificacion ? `<p><em>"${decision.justificacion}"</em></p>` : ''}
    </div>
    
    <div class="siguiente">
        <h3>üöÄ ¬øY ahora qu√©?</h3>
        <ul>
            <li>el Plan local de salud ser√° presentado al <strong>pleno municipal</strong> para su aprobaci√≥n</li>
            <li>Las actuaciones comenzar√°n a ejecutarse durante <strong>2026</strong></li>
            <li>Habr√° nuevas oportunidades de participaci√≥n en el seguimiento del Plan</li>
            <li>Pod√©is seguir informados a trav√©s del Ayuntamiento y el Centro de Salud</li>
        </ul>
    </div>
    
    <p style="text-align: center; font-size: 12pt; margin-top: 30px;">
        <strong>Vuestra voz importa.</strong><br>
        Entre todos y todas construimos un ${nombre} m√°s saludable.
    </p>
    
    <div class="footer">
        <p>Ayuntamiento de ${nombre} ¬∑ Distrito sanitario Granada-Metropolitano</p>
        <p>' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Devolucion_Ciudadana_' + nombre);
}

// Funci√≥n auxiliar para abrir ventana de impresi√≥n
function abrirVentanaImpresion(html, nombreArchivo) {
    const ventana = window.open('', '_blank');
    ventana.document.write(html);
    ventana.document.close();
    
    setTimeout(() => {
        ventana.focus();
        ventana.print();
    }, 500);
    
    mostrarNotificacion({
        title: 'üìÑ Documento generado',
        message: 'Seleccione ¬´Guardar como PDF¬ª en el di√°logo de impresi√≥n',
        type: 'info',
        duration: 4000
    });
}

// ============================================
// REUNI√ìN 2: SESI√ìN DE DATOS
// ============================================

function generarConvocatoriaSesionDatos() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Convocatoria sesi√≥n de datos - ${nombre}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.6; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #059669; padding-bottom: 15px; margin-bottom: 25px; }
        .header img { height: 50px; }
        .titulo { text-align: center; margin: 30px 0; }
        .titulo h1 { color: #059669; font-size: 18pt; margin: 0; }
        .titulo h2 { color: #1e293b; font-size: 14pt; margin: 10px 0 0 0; font-weight: normal; }
        .datos { background: #f0fdf4; border-left: 4px solid #059669; padding: 15px 20px; margin: 25px 0; }
        .datos p { margin: 8px 0; }
        .datos strong { color: #059669; }
        .orden-dia { margin: 25px 0; }
        .orden-dia h3 { color: #1e293b; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        .orden-dia ol { margin: 15px 0 15px 25px; }
        .orden-dia li { margin: 10px 0; padding-left: 10px; }
        .nota { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 15px; margin: 25px 0; font-size: 10pt; }
        .tarea-previa { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 15px; margin: 20px 0; }
        .tarea-previa h4 { color: #b45309; margin: 0 0 10px 0; }
        .footer { margin-top: 40px; text-align: center; color: #64748b; font-size: 9pt; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    </style>
</head>
<body>
    <div class="header">
        ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a de Salud">` : '<div></div>'}
        ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito sanitario">` : '<div></div>'}
    </div>
    
    <div class="titulo">
        <h1>CONVOCATORIA</h1>
        <h2>Sesi√≥n de datos del Plan local de salud de ${nombre}</h2>
    </div>
    
    <p>Desde el <strong>Grupo motor</strong> del Plan local de salud de ${nombre}, le convocamos a la <strong>Sesi√≥n de datos</strong>, segunda reuni√≥n del ciclo anual de planificaci√≥n.</p>
    
    <div class="datos">
        <p><strong>üìÖ Fecha:</strong> [FECHA]</p>
        <p><strong>üïê Hora:</strong> [HORA] h</p>
        <p><strong>üìç Lugar:</strong> [LUGAR]</p>
    </div>
    
    <div class="orden-dia">
        <h3>Orden del d√≠a</h3>
        <ol>
            <li><strong>Bienvenida y repaso de la sesi√≥n anterior</strong></li>
            <li><strong>Presentaci√≥n de los Determinantes de Salud de ${nombre}</strong> ‚Äî Encuesta de Activos y Salud (EAS)</li>
            <li><strong>Presentaci√≥n de los Indicadores de Salud</strong> ‚Äî Datos epidemiol√≥gicos actualizados</li>
            <li><strong>Resultados de la elecci√≥n de prioridades</strong> ‚Äî Prioridades identificadas por la poblaci√≥n</li>
            <li><strong>Debate y an√°lisis conjunto</strong></li>
            <li><strong>Pr√≥ximos pasos</strong></li>
        </ol>
    </div>
    
    <div class="tarea-previa">
        <h4>üìù Tarea previa (opcional)</h4>
        <p>Si a√∫n no lo ha hecho, le animamos a participar en la <strong>elecci√≥n de prioridades</strong> de salud. El enlace estar√° disponible hasta [FECHA L√çMITE].</p>
    </div>
    
    <div class="nota">
        <strong>üìä Material de la sesi√≥n:</strong> Los informes de determinantes e indicadores se enviar√°n por correo electr√≥nico con antelaci√≥n a la reuni√≥n para facilitar su revisi√≥n previa.
    </div>
    
    <p>Se ruega confirmaci√≥n de asistencia.</p>
    
    <p style="margin-top: 30px;">Atentamente,</p>
    <p><strong>Grupo motor del Plan local de salud de ${nombre}</strong></p>
    
    <div class="footer">
        <p>' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Convocatoria_SesionDatos_' + nombre);
}

function generarEnlaceVotacion() { 
    // Ir a la secci√≥n de votaci√≥n
    document.querySelector('[data-fase="3"]')?.click();
    setTimeout(() => {
        const seccionVotacion = document.getElementById('votacion-ciudadana-contenido');
        if (seccionVotacion) seccionVotacion.scrollIntoView({ behavior: 'smooth' });
    }, 300);
}

function generarActaSesionDatos() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    const participacion = window.datosParticipacionCiudadana;
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    
    let seccionVotacion = '';
    if (participacion) {
        seccionVotacion = `
        <p><strong>4.1. Participaci√≥n:</strong> ${participacion.totalParticipantes} personas</p>
        <p><strong>4.2. Objetivo prioritario:</strong> ${participacion.objetivoPrioritario.texto} (${participacion.objetivoPrioritario.porcentaje}%)</p>
        <p><strong>4.3. Colectivo prioritario:</strong> ${participacion.colectivoPrioritario.texto} (${participacion.colectivoPrioritario.porcentaje}%)</p>
        `;
    } else {
        seccionVotacion = `<div class="campo-area"></div>`;
    }
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Acta Sesi√≥n de datos - ${nombre}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.6; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #059669; padding-bottom: 15px; margin-bottom: 25px; }
        .header img { height: 50px; }
        .titulo { text-align: center; margin: 20px 0 30px 0; }
        .titulo h1 { color: #059669; font-size: 16pt; margin: 0; }
        .titulo h2 { color: #1e293b; font-size: 12pt; margin: 8px 0 0 0; font-weight: normal; }
        .datos { background: #f0fdf4; border-left: 4px solid #059669; padding: 15px 20px; margin: 20px 0; }
        .seccion { margin: 25px 0; }
        .seccion h3 { color: #059669; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; font-size: 12pt; }
        .campo-rellenar { border-bottom: 1px dotted #64748b; min-height: 20px; display: inline-block; min-width: 200px; }
        .campo-area { border: 1px solid #d1d5db; border-radius: 6px; min-height: 80px; padding: 10px; margin: 10px 0; }
        .asistentes-tabla { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .asistentes-tabla th, .asistentes-tabla td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
        .asistentes-tabla th { background: #f0fdf4; }
        .firma { margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .firma div { text-align: center; }
        .firma-linea { border-bottom: 1px solid #1e293b; height: 60px; margin-bottom: 5px; }
        .footer { margin-top: 30px; text-align: center; color: #64748b; font-size: 8pt; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    </style>
</head>
<body>
    <div class="header">
        ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a de Salud">` : '<div></div>'}
        ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito sanitario">` : '<div></div>'}
    </div>
    
    <div class="titulo">
        <h1>ACTA DE LA SESI√ìN DE DATOS</h1>
        <h2>Plan local de salud de ${nombre} 2026-2030</h2>
    </div>
    
    <div class="datos">
        <p><strong>Fecha:</strong> <span class="campo-rellenar"></span></p>
        <p><strong>Hora de inicio:</strong> <span class="campo-rellenar" style="min-width:80px;"></span> ‚Äî <strong>Hora de finalizaci√≥n:</strong> <span class="campo-rellenar" style="min-width:80px;"></span></p>
        <p><strong>Lugar:</strong> <span class="campo-rellenar"></span></p>
    </div>
    
    <div class="seccion">
        <h3>1. Asistentes</h3>
        <table class="asistentes-tabla">
            <tr><th style="width:35%">Nombre</th><th style="width:35%">Organizaci√≥n</th><th style="width:30%">Sector</th></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
        </table>
    </div>
    
    <div class="seccion">
        <h3>2. Determinantes de Salud presentados</h3>
        <p>Principales hallazgos de la Encuesta de Activos y Salud (EAS):</p>
        <div class="campo-area"></div>
    </div>
    
    <div class="seccion">
        <h3>3. Indicadores de Salud presentados</h3>
        <p>Principales datos epidemiol√≥gicos destacados:</p>
        <div class="campo-area"></div>
    </div>
    
    <div class="seccion">
        <h3>4. Resultados de la elecci√≥n de prioridades</h3>
        ${seccionVotacion}
    </div>
    
    <div class="seccion">
        <h3>5. Debate y conclusiones</h3>
        <div class="campo-area"></div>
    </div>
    
    <div class="seccion">
        <h3>6. Acuerdos adoptados</h3>
        <div class="campo-area"></div>
    </div>
    
    <div class="firma">
        <div>
            <div class="firma-linea"></div>
            <p>Coordinador/a Grupo motor</p>
        </div>
        <div>
            <div class="firma-linea"></div>
            <p>Secretario/a de Actas</p>
        </div>
    </div>
    
    <div class="footer">
        <p>' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Acta_SesionDatos_' + nombre);
}

function generarResultadosVotacion() { 
    if (window.datosParticipacionCiudadana) {
        generarDevolucionCiudadana();
    } else {
        mostrarNotificacion({ title: '‚ö†Ô∏è Sin datos', message: 'No hay resultados de votaci√≥n', type: 'warning', duration: 2000 });
    }
}

// ============================================
// REUNI√ìN 3: PRIORIZACI√ìN Y PLAN
// ============================================

function generarConvocatoriaPriorizacion() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Convocatoria sesi√≥n de Priorizaci√≥n - ${nombre}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.6; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #f59e0b; padding-bottom: 15px; margin-bottom: 25px; }
        .header img { height: 50px; }
        .titulo { text-align: center; margin: 30px 0; }
        .titulo h1 { color: #f59e0b; font-size: 18pt; margin: 0; }
        .titulo h2 { color: #1e293b; font-size: 14pt; margin: 10px 0 0 0; font-weight: normal; }
        .datos { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 15px 20px; margin: 25px 0; }
        .datos p { margin: 8px 0; }
        .datos strong { color: #b45309; }
        .orden-dia { margin: 25px 0; }
        .orden-dia h3 { color: #1e293b; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        .orden-dia ol { margin: 15px 0 15px 25px; }
        .orden-dia li { margin: 10px 0; padding-left: 10px; }
        .objetivo { background: #fff7ed; border: 1px solid #fed7aa; border-radius: 8px; padding: 15px; margin: 20px 0; }
        .objetivo h4 { color: #c2410c; margin: 0 0 10px 0; }
        .nota { background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 15px; margin: 25px 0; font-size: 10pt; }
        .footer { margin-top: 40px; text-align: center; color: #64748b; font-size: 9pt; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    </style>
</head>
<body>
    <div class="header">
        ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a de Salud">` : '<div></div>'}
        ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito sanitario">` : '<div></div>'}
    </div>
    
    <div class="titulo">
        <h1>CONVOCATORIA</h1>
        <h2>Sesi√≥n de Priorizaci√≥n y Plan de acci√≥n<br>Plan local de salud de ${nombre}</h2>
    </div>
    
    <p>Desde el <strong>Grupo motor</strong> del Plan local de salud de ${nombre}, le convocamos a la <strong>Sesi√≥n de Priorizaci√≥n</strong>, tercera reuni√≥n del ciclo anual donde definiremos las l√≠neas de actuaci√≥n.</p>
    
    <div class="datos">
        <p><strong>üìÖ Fecha:</strong> [FECHA]</p>
        <p><strong>üïê Hora:</strong> [HORA] h</p>
        <p><strong>üìç Lugar:</strong> [LUGAR]</p>
    </div>
    
    <div class="objetivo">
        <h4>üéØ Objetivo de la sesi√≥n</h4>
        <p>Validar las <strong>prioridades de salud</strong> identificadas, aprobar el <strong>Plan de acci√≥n</strong> y seleccionar al menos una <strong>actuaci√≥n concreta</strong> para la Agenda anual 2026.</p>
    </div>
    
    <div class="orden-dia">
        <h3>Orden del d√≠a</h3>
        <ol>
            <li><strong>Bienvenida y s√≠ntesis de las sesiones anteriores</strong></li>
            <li><strong>Presentaci√≥n del an√°lisis de priorizaci√≥n</strong> ‚Äî Integraci√≥n de datos epidemiol√≥gicos y participaci√≥n ciudadana</li>
            <li><strong>Debate y validaci√≥n de las prioridades</strong> ‚Äî Decisi√≥n del Grupo motor</li>
            <li><strong>Presentaci√≥n del borrador de Plan de acci√≥n</strong> ‚Äî L√≠neas estrat√©gicas, objetivos e indicadores</li>
            <li><strong>Selecci√≥n de actuaciones para la Agenda 2026</strong></li>
            <li><strong>Decisi√≥n sobre creaci√≥n de Grupos de Trabajo</strong></li>
            <li><strong>Pr√≥ximos pasos hacia la aprobaci√≥n plenaria</strong></li>
        </ol>
    </div>
    
    <div class="nota">
        <strong>üìé Documentaci√≥n adjunta:</strong> Se env√≠a junto a esta convocatoria el <strong>Borrador de Priorizaci√≥n</strong> con la propuesta de √°reas prioritarias y el <strong>Borrador de Plan de acci√≥n</strong> para su revisi√≥n previa.
    </div>
    
    <p>Se ruega confirmaci√≥n de asistencia.</p>
    
    <p style="margin-top: 30px;">Atentamente,</p>
    <p><strong>Grupo motor del Plan local de salud de ${nombre}</strong></p>
    
    <div class="footer">
        <p>' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Convocatoria_Priorizacion_' + nombre);
}

function generarBorradorPriorizacion() { 
    // Ir a la propuesta autom√°tica
    document.querySelector('[data-fase="3"]')?.click();
    setTimeout(() => {
        if (typeof generarPropuestaAutomatica === 'function') generarPropuestaAutomatica();
    }, 300);
}

function generarActaPriorizacion() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    const participacion = window.datosParticipacionCiudadana;
    const decision = window.decisionPriorizacionActual;
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    
    let seccionDecision = '';
    if (decision) {
        let metodoTexto = 'Integraci√≥n epidemiol√≥gica y ciudadana';
        if (decision.metodo === 'epidemiologica') metodoTexto = 'Prioridad epidemiol√≥gica';
        else if (decision.metodo === 'ciudadana') metodoTexto = 'Prioridad ciudadana';
        
        seccionDecision = `
        <p><strong>M√©todo adoptado:</strong> ${metodoTexto}</p>
        <p><strong>Justificaci√≥n:</strong> ${decision.justificacion || '[Sin justificaci√≥n registrada]'}</p>
        `;
    } else {
        seccionDecision = `<div class="campo-area"></div>`;
    }
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Acta Sesi√≥n de Priorizaci√≥n - ${nombre}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.6; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #f59e0b; padding-bottom: 15px; margin-bottom: 25px; }
        .header img { height: 50px; }
        .titulo { text-align: center; margin: 20px 0 30px 0; }
        .titulo h1 { color: #f59e0b; font-size: 16pt; margin: 0; }
        .titulo h2 { color: #1e293b; font-size: 12pt; margin: 8px 0 0 0; font-weight: normal; }
        .datos { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 15px 20px; margin: 20px 0; }
        .seccion { margin: 25px 0; }
        .seccion h3 { color: #b45309; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; font-size: 12pt; }
        .campo-rellenar { border-bottom: 1px dotted #64748b; min-height: 20px; display: inline-block; min-width: 200px; }
        .campo-area { border: 1px solid #d1d5db; border-radius: 6px; min-height: 80px; padding: 10px; margin: 10px 0; }
        .acuerdo { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .acuerdo h4 { color: #059669; margin: 0 0 10px 0; }
        .asistentes-tabla { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .asistentes-tabla th, .asistentes-tabla td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
        .asistentes-tabla th { background: #fffbeb; }
        .firma { margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .firma div { text-align: center; }
        .firma-linea { border-bottom: 1px solid #1e293b; height: 60px; margin-bottom: 5px; }
        .footer { margin-top: 30px; text-align: center; color: #64748b; font-size: 8pt; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    </style>
</head>
<body>
    <div class="header">
        ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a de Salud">` : '<div></div>'}
        ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito sanitario">` : '<div></div>'}
    </div>
    
    <div class="titulo">
        <h1>ACTA DE LA SESI√ìN DE PRIORIZACI√ìN</h1>
        <h2>Plan local de salud de ${nombre} 2026-2030</h2>
    </div>
    
    <div class="datos">
        <p><strong>Fecha:</strong> <span class="campo-rellenar"></span></p>
        <p><strong>Hora de inicio:</strong> <span class="campo-rellenar" style="min-width:80px;"></span> ‚Äî <strong>Hora de finalizaci√≥n:</strong> <span class="campo-rellenar" style="min-width:80px;"></span></p>
        <p><strong>Lugar:</strong> <span class="campo-rellenar"></span></p>
    </div>
    
    <div class="seccion">
        <h3>1. Asistentes</h3>
        <table class="asistentes-tabla">
            <tr><th style="width:35%">Nombre</th><th style="width:35%">Organizaci√≥n</th><th style="width:30%">Sector</th></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
            <tr><td>&nbsp;</td><td></td><td></td></tr>
        </table>
    </div>
    
    <div class="seccion">
        <h3>2. Decisi√≥n de Priorizaci√≥n</h3>
        ${seccionDecision}
    </div>
    
    <div class="seccion">
        <h3>3. √Åreas Prioritarias acordadas</h3>
        <div class="campo-area"></div>
    </div>
    
    <div class="seccion">
        <h3>4. Plan de acci√≥n</h3>
        <div class="acuerdo">
            <h4>‚úÖ Acuerdo</h4>
            <p>Se aprueba el Plan de acci√≥n del Plan local de salud de ${nombre} 2026-2030, que incluye las siguientes l√≠neas estrat√©gicas:</p>
            <div class="campo-area" style="min-height: 60px;"></div>
        </div>
    </div>
    
    <div class="seccion">
        <h3>5. Actuaciones seleccionadas para Agenda 2026</h3>
        <div class="campo-area"></div>
    </div>
    
    <div class="seccion">
        <h3>6. Grupos de Trabajo</h3>
        <p>¬øSe acuerda crear Grupos de Trabajo tem√°ticos?</p>
        <p>‚òê S√≠ ‚Äî Grupos: <span class="campo-rellenar"></span></p>
        <p>‚òê No ‚Äî El Grupo motor asume la coordinaci√≥n de todas las √°reas</p>
    </div>
    
    <div class="seccion">
        <h3>7. Pr√≥ximos pasos</h3>
        <div class="campo-area" style="min-height: 60px;"></div>
    </div>
    
    <div class="firma">
        <div>
            <div class="firma-linea"></div>
            <p>Coordinador/a Grupo motor</p>
        </div>
        <div>
            <div class="firma-linea"></div>
            <p>Secretario/a de Actas</p>
        </div>
    </div>
    
    <div class="footer">
        <p>' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Acta_Priorizacion_' + nombre);
}

function exportarPlanAccionPDF() { 
    if (typeof exportarPlanPDF === 'function') exportarPlanPDF();
}

// ============================================
// REUNI√ìN 4: RENDICI√ìN DE CUENTAS
// ============================================

function generarConvocatoriaRendicion() {
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);
    
    const logoConsejeria = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoDistrito = typeof LOGO_DISTRITO_B64 !== 'undefined' ? 'data:image/png;base64,' + LOGO_DISTRITO_B64 : '';
    
    const html = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Convocatoria Jornada de Rendici√≥n de cuentas - ${nombre}</title>
    <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Segoe UI', sans-serif; font-size: 11pt; line-height: 1.6; color: #1e293b; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #6366f1; padding-bottom: 15px; margin-bottom: 25px; }
        .header img { height: 50px; }
        .titulo { text-align: center; margin: 30px 0; }
        .titulo h1 { color: #6366f1; font-size: 18pt; margin: 0; }
        .titulo h2 { color: #1e293b; font-size: 14pt; margin: 10px 0 0 0; font-weight: normal; }
        .datos { background: #eef2ff; border-left: 4px solid #6366f1; padding: 15px 20px; margin: 25px 0; }
        .datos p { margin: 8px 0; }
        .datos strong { color: #4f46e5; }
        .orden-dia { margin: 25px 0; }
        .orden-dia h3 { color: #1e293b; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        .orden-dia ol { margin: 15px 0 15px 25px; }
        .orden-dia li { margin: 10px 0; padding-left: 10px; }
        .destacado { background: linear-gradient(135deg, #eef2ff 0%, #faf5ff 100%); border: 2px solid #6366f1; border-radius: 12px; padding: 20px; margin: 25px 0; text-align: center; }
        .destacado h4 { color: #6366f1; margin: 0 0 10px 0; font-size: 14pt; }
        .nota { background: #f5f3ff; border: 1px solid #c4b5fd; border-radius: 8px; padding: 15px; margin: 25px 0; font-size: 10pt; }
        .footer { margin-top: 40px; text-align: center; color: #64748b; font-size: 9pt; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    </style>
</head>
<body>
    <div class="header">
        ${logoConsejeria ? `<img src="${logoConsejeria}" alt="Consejer√≠a de Salud">` : '<div></div>'}
        ${logoDistrito ? `<img src="${logoDistrito}" alt="Distrito sanitario">` : '<div></div>'}
    </div>
    
    <div class="titulo">
        <h1>CONVOCATORIA</h1>
        <h2>Jornada de Rendici√≥n de cuentas<br>Plan local de salud de ${nombre}</h2>
    </div>
    
    <p>Desde el <strong>Ayuntamiento de ${nombre}</strong> y el <strong>Grupo motor</strong> del Plan local de salud, tenemos el placer de invitarle a la <strong>Jornada de Rendici√≥n de cuentas</strong>, cierre del primer ciclo anual de planificaci√≥n participativa en salud.</p>
    
    <div class="datos">
        <p><strong>üìÖ Fecha:</strong> [FECHA]</p>
        <p><strong>üïê Hora:</strong> [HORA] h</p>
        <p><strong>üìç Lugar:</strong> [LUGAR]</p>
    </div>
    
    <div class="destacado">
        <h4>üèõÔ∏è Acto de Aprobaci√≥n del Plan local de salud</h4>
        <p>el Plan local de salud de ${nombre} 2026-2030 ser√° presentado para su <strong>aprobaci√≥n por el pleno municipal</strong>.</p>
    </div>
    
    <div class="orden-dia">
        <h3>Orden del d√≠a</h3>
        <ol>
            <li><strong>Bienvenida institucional</strong> ‚Äî Alcald√≠a de ${nombre}</li>
            <li><strong>Balance del proceso participativo</strong> ‚Äî Hitos alcanzados durante el a√±o</li>
            <li><strong>Presentaci√≥n del Plan local de salud 2026-2030</strong>
                <ul style="margin: 5px 0 5px 20px;">
                    <li>Perfil de salud de ${nombre}</li>
                    <li>Plan de acci√≥n: l√≠neas estrat√©gicas y objetivos</li>
                    <li>Agenda anual 2026: actuaciones programadas</li>
                </ul>
            </li>
            <li><strong>Devoluci√≥n a la ciudadan√≠a</strong> ‚Äî Resultados de la participaci√≥n ciudadana</li>
            <li><strong>Compromisos institucionales</strong></li>
            <li><strong>Turno abierto de palabra</strong></li>
            <li><strong>Clausura</strong></li>
        </ol>
    </div>
    
    <div class="nota">
        <strong>üë• Evento abierto a la ciudadan√≠a:</strong> Esta jornada est√° abierta a toda la ciudadan√≠a de ${nombre}. Se anima especialmente a participar a quienes colaboraron en la elecci√≥n de prioridades y en las fases de elaboraci√≥n del Plan.
    </div>
    
    <p>Ser√° un placer contar con su presencia.</p>
    
    <p style="margin-top: 30px;">Atentamente,</p>
    <p><strong>Alcald√≠a de ${nombre}</strong><br>
    <strong>Grupo motor del Plan local de salud</strong></p>
    
    <div class="footer">
        <p>' + (typeof COMPAS_VERSION !== 'undefined' ? COMPAS_VERSION.docFooter : 'Documento generado con COMP√ÅS') + '</p>
    </div>
</body>
</html>`;
    
    abrirVentanaImpresion(html, 'Convocatoria_Rendicion_' + nombre);
}

// =====================================================================
// ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ANALIZADOR RELAS  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
// Motor JS integrado en COMP√ÅS ‚Äî namespace relas_
// =====================================================================

// ‚îÄ‚îÄ Diccionarios ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RELAS_HABITOS = {1:'Alimentaci√≥n Saludable',2:'Actividad f√≠sica',3:'Bienestar emocional',4:'Sexualidad responsable',5:'Uso positivo TRICs',6:'Otras'};
const RELAS_PROBLEMAS = {1:'Adicciones c/sustancias',2:'Adicciones s/sustancias',3:'Enf. cr√≥nicas',4:'ITS/Sexual',5:'Malestar emocional',6:'TCA',7:'Trastornos sue√±o',8:'Otros'};
const RELAS_COLECTIVOS = {1:'Madres/Padres',2:'J√≥venes',3:'Mayores +65',4:'Personas cuidadoras',5:'Colectivos ciudadanos',6:'Otros'};

const RELAS_EPVSA_HABITOS = {1:{nivel:'alta',eje:'Eje 1: Alimentaci√≥n saludable'},2:{nivel:'alta',eje:'Eje 2: Actividad f√≠sica'},3:{nivel:'alta',eje:'Eje 3: Salud mental y bienestar'},4:{nivel:'media',eje:'Eje 5: Sexualidad y salud reproductiva'},5:{nivel:'media',eje:'Eje 6: Uso saludable de tecnolog√≠as'},6:{nivel:'baja',eje:'Otros √°mbitos'}};
const RELAS_EPVSA_PROBLEMAS = {1:{nivel:'alta',eje:'Eje 4: Reducci√≥n de da√±os por sustancias'},2:{nivel:'alta',eje:'Eje 6: Adicciones conductuales digitales'},3:{nivel:'alta',eje:'Eje 1+2: Prevenci√≥n ECNT'},4:{nivel:'media',eje:'Eje 5: ITS y salud sexual'},5:{nivel:'alta',eje:'Eje 3: Salud mental'},6:{nivel:'media',eje:'Eje 1: TCA y alimentaci√≥n'},7:{nivel:'media',eje:'Eje 3: Higiene del sue√±o'},8:{nivel:'baja',eje:'Otros'}};
const RELAS_ESCA_COLECTIVOS = {1:{nivel:'alta',linea:'L√≠nea 2: Crianza positiva y parentalidad'},2:{nivel:'alta',linea:'L√≠nea 3: Juventud y adolescencia saludable'},3:{nivel:'alta',linea:'L√≠nea 4: Envejecimiento activo y saludable'},4:{nivel:'alta',linea:'L√≠nea 5: Apoyo a personas cuidadoras'},5:{nivel:'media',linea:'L√≠nea 1: Participaci√≥n comunitaria'},6:{nivel:'baja',linea:'Otros colectivos'}};
const RELAS_ESCA_HABITOS = {1:{nivel:'alta',linea:'L√≠nea 6: Entornos alimentarios saludables'},2:{nivel:'alta',linea:'L√≠nea 7: Comunidades activas'},3:{nivel:'alta',linea:'L√≠nea 8: Salud mental comunitaria'},4:{nivel:'media',linea:'L√≠nea 9: Salud sexual comunitaria'},5:{nivel:'baja',linea:'L√≠nea 10: Alfabetizaci√≥n digital en salud'},6:{nivel:'baja',linea:'Otras l√≠neas'}};

// ‚îÄ‚îÄ Estado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let relas_globalData = null;
let relas_charts = {};
let relas_lastSimResult = null;
let relas_simState = { sh:[], sp:[], sc:[] };

// ‚îÄ‚îÄ Paletas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RELAS_PAL_GREEN  = ['#2d6a4f','#40916c','#52b788','#74c69d','#95d5b2','#b7e4c7','#d8f3dc'];
const RELAS_PAL_MIXED  = ['#264653','#2a9d8f','#e9c46a','#f4a261','#e76f51','#7b2d8b','#c77dff','#5f0f40'];
const RELAS_PAL_ACCENT = ['#e76f51','#f4a261','#e9c46a','#2a9d8f','#52b788','#264653','#7b2d8b','#c77dff'];

// ‚îÄ‚îÄ Base de conocimiento KB (intervenciones RELAS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RELAS_KB = [
  {id:'A',nombre:'Taller de Alimentaci√≥n Saludable',habitos:[1],problemas:[3,6],colectivos:[1,3,5],duracion:'6 sesiones / 2h',formato:'Grupal presencial',sesiones:6,evidencia:88,efectividad:82,viabilidad:90,coste:'Muy bajo (‚âà400‚Ç¨)',epvsa:'Eje 1',esca:'L6',responsable:'Enfermer√≠a / Nutricionista',recursos:['Sala equipada','Material educativo','Alimentos demo'],perfil_profesional:['Enfermer√≠a comunitaria','Nutricionista','Educador/a de salud'],coordinacion:['Atenci√≥n Primaria','Farmacia','Servicios Sociales'],indicadores:['IMC / CC pre-post (3m)','Adherencia dieta mediterr√°nea (PREDIMED)','Satisfacci√≥n participantes (>80%)'],pasos:['Diagn√≥stico participativo de h√°bitos alimentarios del grupo','Sesiones de educaci√≥n nutricional con demostraciones pr√°cticas','Taller de lectura de etiquetas y compra saludable','T√©cnicas de cocina saludable adaptadas a recursos econ√≥micos','Sesi√≥n de cierre y plan personal de mejora'],desc:'Taller pr√°ctico de alimentaci√≥n saludable con enfoque participativo.',metodologia:'Aprendizaje experiencial, din√°micas grupales, demostraci√≥n pr√°ctica',referencia:'Gu√≠a NAOS 2021 / Estrategia Alimentaci√≥n Saludable JJAA',alertas:[]},
  {id:'B',nombre:'Programa de Actividad F√≠sica Comunitaria',habitos:[2],problemas:[3,7],colectivos:[3,5],duracion:'12 semanas continuas',formato:'Grupal / Espacio p√∫blico',sesiones:24,evidencia:92,efectividad:88,viabilidad:85,coste:'Muy bajo (‚âà200‚Ç¨)',epvsa:'Eje 2',esca:'L7',responsable:'Fisioterapeuta / Monitor deportivo',recursos:['Parque o espacio p√∫blico','Material deportivo b√°sico'],perfil_profesional:['Fisioterapeuta','Monitor de actividad f√≠sica'],coordinacion:['Ayuntamiento','RELAS','Atenci√≥n Primaria'],indicadores:['Capacidad aer√≥bica (test 6min marcha)','Adherencia ‚â•60%','Calidad de vida (SF-12)'],pasos:['Evaluaci√≥n inicial de capacidad funcional','Grupos adaptados por nivel','Sesiones bissemanales con progresi√≥n gradual','Integraci√≥n de componentes de socializaci√≥n','Evaluaci√≥n final y derivaci√≥n a recursos permanentes'],desc:'Programa de ejercicio adaptado en espacios comunitarios.',metodologia:'Prescripci√≥n de ejercicio, grupos de camino, gimnasia adaptada',referencia:'Revisi√≥n Cochrane 2022 / Plan MOVE de Andaluc√≠a',alertas:[]},
  {id:'C',nombre:'Grupo de Apoyo Emocional',habitos:[3],problemas:[5,7],colectivos:[1,4,3],duracion:'10 sesiones / 90 min',formato:'Grupal semipresencial',sesiones:10,evidencia:85,efectividad:80,viabilidad:88,coste:'Bajo (‚âà800‚Ç¨)',epvsa:'Eje 3',esca:'L8',responsable:'Psic√≥logo/a cl√≠nico',recursos:['Sala intimista','Protocolo de intervenci√≥n','Escala GHQ-12'],perfil_profesional:['Psic√≥logo/a comunitario','Trabajador/a social'],coordinacion:['Salud Mental Comunitaria','Atenci√≥n Primaria','Servicios Sociales'],indicadores:['Puntuaci√≥n GHQ-12 pre/post','Reducci√≥n visitas urgencias (3m)','Satisfacci√≥n participantes'],pasos:['Valoraci√≥n psicosocial inicial y consentimiento','Sesiones de psicoeducaci√≥n en regulaci√≥n emocional','T√©cnicas de mindfulness y gesti√≥n del estr√©s','Din√°micas de grupo para refuerzo de red de apoyo social','Plan individual de seguimiento y derivaci√≥n si precisa'],desc:'Espacio de escucha activa y t√©cnicas de regulaci√≥n emocional.',metodologia:'ACT, Mindfulness, Terapia de Aceptaci√≥n y Compromiso',referencia:'Plan Andaluz de Salud Mental 2016-2020 / PAIPS 2021',alertas:[5]},
  {id:'D',nombre:'Taller de Sexualidad Responsable',habitos:[4],problemas:[4],colectivos:[2,1],duracion:'4 sesiones / 2h',formato:'Grupal presencial',sesiones:4,evidencia:79,efectividad:75,viabilidad:92,coste:'Muy bajo (‚âà300‚Ç¨)',epvsa:'Eje 5',esca:'L9',responsable:'Matrona / Educador/a sexual',recursos:['Material informativo','Kits de demostraci√≥n','Sala privada'],perfil_profesional:['Matrona','Educador/a de salud','Trabajador/a social'],coordinacion:['Atenci√≥n Primaria','Centros educativos','ITS'],indicadores:['Conocimientos pre/post (cuestionario)','Uso anticonceptivos (6m)','Detecci√≥n ITS'],pasos:['Evaluaci√≥n de conocimientos y actitudes previas','M√≥dulo de anatom√≠a y fisiolog√≠a sexual','M√≥dulo de m√©todos anticonceptivos y prevenci√≥n ITS','Perspectiva de g√©nero y relaciones afectivas saludables','Recursos y derivaci√≥n a servicios especializados'],desc:'Educaci√≥n sexual integral con perspectiva de g√©nero.',metodologia:'Educaci√≥n entre iguales, role-playing, recursos audiovisuales',referencia:'Estrategia Nacional de Salud Sexual y Reproductiva',alertas:[]},
  {id:'E',nombre:'Alfabetizaci√≥n Digital en Salud',habitos:[5],problemas:[2],colectivos:[3,2,5],duracion:'6 sesiones / 1.5h',formato:'Presencial/Online h√≠brido',sesiones:6,evidencia:72,efectividad:68,viabilidad:80,coste:'Bajo (‚âà400‚Ç¨)',epvsa:'Eje 6',esca:'L10',responsable:'T√©cnico/a en salud + Dinamizador TIC',recursos:['Dispositivos (tablet/pc)','Conexi√≥n a internet','Material impreso'],perfil_profesional:['Educador/a de salud','T√©cnico/a de informaci√≥n'],coordinacion:['Centros TIC municipales','Bibliotecas','Farmacia comunitaria'],indicadores:['Nivel alfabetizaci√≥n digital (pre/post)','Uso apps de salud','Reducci√≥n bulos compartidos'],pasos:['Diagn√≥stico de competencias digitales del grupo','Uso seguro de internet y redes sociales','Identificaci√≥n de bulos y fuentes fiables de salud','Aplicaciones de salud recomendadas','Prevenci√≥n de adicciones digitales'],desc:'Uso seguro y saludable de internet.',metodologia:'Aprendizaje basado en casos, alfabetizaci√≥n medi√°tica',referencia:'Plan Nac. Competencias Digitales 2021 / OMS eHealth',alertas:[]},
  {id:'F',nombre:'Programa de Prevenci√≥n de Adicciones',habitos:[3,2],problemas:[1,2],colectivos:[2,5],duracion:'6 sesiones + seguimiento individual',formato:'Grupal + individual',sesiones:6,evidencia:83,efectividad:78,viabilidad:82,coste:'Medio (‚âà1.200‚Ç¨)',epvsa:'Eje 4',esca:'L3',responsable:'Psic√≥logo/a + Trabajador/a social',recursos:['Sala privada','Escala AUDIT/CAGE','Material motivacional'],perfil_profesional:['Psic√≥logo/a','Enfermer√≠a','Trabajador/a social'],coordinacion:['UCA Unidad Conductas Adictivas','Proyecto Hombre','CCAA'],indicadores:['Puntuaci√≥n AUDIT/CAGE pre/post','Episodios consumo (30d)','Derivaciones especializadas'],pasos:['Cribado de consumo mediante herramientas validadas (AUDIT, CRAFFT)','Intervenci√≥n Motivacional Breve (FRAMES)','Habilidades de resistencia a la presi√≥n grupal','Manejo de situaciones de riesgo y reca√≠das','Plan de seguimiento y conexi√≥n con recursos especializados'],desc:'Intervenci√≥n motivacional breve y trabajo en habilidades de resistencia.',metodologia:'Entrevista motivacional, FRAMES, habilidades sociales',referencia:'Gu√≠a cl√≠nica SOCIDROGALCOHOL / Plan Andaluz Drogas 2021',alertas:[1,2]},
  {id:'G',nombre:'Apoyo Integral a Personas Cuidadoras',habitos:[3,1],problemas:[5,7,3],colectivos:[4],duracion:'8 sesiones / 1.5h + grupos de apoyo',formato:'Grupal presencial',sesiones:8,evidencia:87,efectividad:85,viabilidad:86,coste:'Bajo (‚âà700‚Ç¨)',epvsa:'Eje 3',esca:'L5',responsable:'Trabajo Social + Psicolog√≠a',recursos:['Sala equipada','Coordinaci√≥n con servicio respiro','Gu√≠a cuidadoras'],perfil_profesional:['Trabajador/a social','Psic√≥logo/a','Terapeuta ocupacional'],coordinacion:['Servicios Sociales Comunitarios','Unidad de Memoria','IMSERSO'],indicadores:['Escala Zarit (sobrecarga)','Calidad sue√±o (PSQI)','Uso recursos respiro'],pasos:['Valoraci√≥n de sobrecarga mediante escala Zarit','Psicoeducaci√≥n sobre el s√≠ndrome del cuidador','T√©cnicas de autocuidado y gesti√≥n emocional','Informaci√≥n sobre recursos y derechos (Ley Dependencia)','Creaci√≥n de red de apoyo entre cuidadoras y seguimiento'],desc:'Programa integral de cuidado al cuidador.',metodologia:'Psicoeducaci√≥n, grupos de apoyo mutuo, coaching de autocuidado',referencia:'Gu√≠a Cuidadoras Junta Andaluc√≠a / Estrategia PAPPS',alertas:[4]},
  {id:'H',nombre:'Envejecimiento Activo y Saludable',habitos:[1,2,3],problemas:[3,5,7],colectivos:[3],duracion:'Programa anual (36 sesiones)',formato:'Grupal comunitario',sesiones:36,evidencia:91,efectividad:89,viabilidad:84,coste:'Medio (‚âà2.000‚Ç¨/a√±o)',epvsa:'Eje 1+2+3',esca:'L4',responsable:'Equipo multidisciplinar AP',recursos:['Centro de mayores','Parque equipado','Coordinaci√≥n AP'],perfil_profesional:['M√©dico/a de familia','Enfermer√≠a','Fisioterapeuta','Trabajador/a social'],coordinacion:['Centro de mayores','Atenci√≥n Primaria','Ayuntamiento'],indicadores:['√çndice de Barthel','Test de Tinetti ca√≠das','Calidad de vida SF-12','Adherencia ‚â•60%'],pasos:['Evaluaci√≥n geri√°trica integral (Barthel, Tinetti, GDS)','Programa de actividad f√≠sica adaptada bisemanal','Talleres de nutrici√≥n para mayores','Sesiones de estimulaci√≥n cognitiva','Grupo de apoyo emocional mensual'],desc:'Programa integral de envejecimiento activo y saludable.',metodologia:'Modelo PISTA JJAA, enfoque multidisciplinar, activos en salud',referencia:'Estrategia Envejecimiento Activo IMSERSO / Plan MOVE JJAA',alertas:[]},
  {id:'I',nombre:'Intervenci√≥n en Salud Mental Comunitaria',habitos:[3],problemas:[5,2,1],colectivos:[2,5,4],duracion:'10 sesiones / 90min + grupos seguimiento',formato:'Grupal comunitario',sesiones:10,evidencia:83,efectividad:79,viabilidad:80,coste:'Medio (‚âà1.000‚Ç¨)',epvsa:'Eje 3',esca:'L8+L1',responsable:'Psic√≥logo/a + Trabajo Social',recursos:['Espacio comunitario','Protocolo detecci√≥n','Gu√≠a de recursos SM'],perfil_profesional:['Psic√≥logo/a comunitario','Trabajador/a social','Agente de salud'],coordinacion:['Unidad Salud Mental Comunitaria','Atenci√≥n Primaria','Tejido asociativo'],indicadores:['PHQ-9 pre/post','Derivaciones SM (adecuadas)','Red de apoyo social'],pasos:['Detecci√≥n proactiva de malestar emocional','Psicoeducaci√≥n grupal y desestigmatizaci√≥n','Talleres de regulaci√≥n emocional','Mapeo de recursos comunitarios','Protocolo de derivaci√≥n coordinada con USMC'],desc:'Intervenci√≥n comunitaria de base que combina detecci√≥n precoz y activaci√≥n de recursos.',metodologia:'Salud mental comunitaria, recuperaci√≥n, activos en salud',referencia:'Plan Andaluz Salud Mental / PAIPS / WHO mhGAP',alertas:[5,2]},
  {id:'J',nombre:'Programa de Actividad F√≠sica para Cr√≥nicas',habitos:[2,1],problemas:[3,7],colectivos:[3,5],duracion:'16 semanas / 3 sesiones semana',formato:'Grupal supervisado',sesiones:48,evidencia:89,efectividad:86,viabilidad:78,coste:'Medio (‚âà1.500‚Ç¨)',epvsa:'Eje 2',esca:'L7',responsable:'Fisioterapeuta + M√©dico/a AP',recursos:['Gimnasio o sala equipada','Puls√≠metros','Protocolo m√©dico'],perfil_profesional:['Fisioterapeuta','M√©dico/a de familia','Enfermer√≠a'],coordinacion:['Cardiolog√≠a','Endocrinolog√≠a','Atenci√≥n Primaria','Farmacia'],indicadores:['HbA1c / tensi√≥n arterial','Distancia 6-min marcha','Calidad de vida SF-36'],pasos:['Valoraci√≥n m√©dica previa y autorizaci√≥n cl√≠nica','Ejercicio aer√≥bico de intensidad moderada adaptado','Ejercicio de fuerza y equilibrio','Educaci√≥n en autocuidado de la patolog√≠a cr√≥nica','Transici√≥n a actividad aut√≥noma y comunitaria permanente'],desc:'Ejercicio terap√©utico grupal para personas con enfermedades cr√≥nicas.',metodologia:'Ejercicio terap√©utico, prescripci√≥n m√©dica, autocuidado',referencia:'Gu√≠a SEMERGEN Ejercicio / ACC/AHA Guidelines 2022',alertas:[3]}
];

// ‚îÄ‚îÄ Helpers de Chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_destroyChart(id) {
  if (relas_charts[id]) { relas_charts[id].destroy(); delete relas_charts[id]; }
}
function relas_baseBarOpts(yLabel, n) {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label: ctx=>`${ctx.parsed.y} respuestas (${Math.round(ctx.parsed.y/n*100)}%)` }}},
    scales:{ y:{ beginAtZero:true, title:{display:true,text:yLabel,font:{size:10}} }, x:{ ticks:{font:{size:9}} }}
  };
}

// ‚îÄ‚îÄ Carga de datos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_handleFile(evt) {
  const file = evt.target.files[0];
  if (!file) return;
  Papa.parse(file, { header:true, skipEmptyLines:true, complete: r => relas_processData(r.data) });
}

function relas_loadDemo() {
  const n = 120;
  const records = [];
  const habWeights=[0.30,0.25,0.22,0.06,0.10,0.07];
  const probWeights=[0.10,0.13,0.17,0.06,0.28,0.08,0.12,0.06];
  const colWeights=[0.16,0.24,0.19,0.15,0.18,0.08];
  function wSample(weights,k){
    const indices=Array.from({length:weights.length},(_,i)=>i+1);
    const chosen=[];const w=[...weights];
    while(chosen.length<k){const r=Math.random();let cum=0;for(let i=0;i<w.length;i++){cum+=w[i];if(r<cum&&!chosen.includes(indices[i])){chosen.push(indices[i]);break;}}}
    return chosen;
  }
  for(let i=1;i<=n;i++){
    const hab=wSample(habWeights,Math.random()<0.7?3:Math.random()<0.5?2:1);
    const prob=wSample(probWeights,Math.random()<0.65?3:Math.random()<0.5?2:1);
    const col=wSample(colWeights,Math.random()<0.60?3:Math.random()<0.5?2:1);
    const rec={record_id:i};
    for(let j=1;j<=6;j++) rec[`habitos_vida___${j}`]=hab.includes(j)?'1':'0';
    for(let j=1;j<=8;j++) rec[`problemas_salud___${j}`]=prob.includes(j)?'1':'0';
    for(let j=1;j<=6;j++) rec[`colectivos___${j}`]=col.includes(j)?'1':'0';
    records.push(rec);
  }
  relas_processData(records);
}

function relas_cargarDesdeFirebase(municipio) {
  if (!municipio || typeof db === 'undefined') {
    alert('No hay municipio activo o Firebase no disponible.');
    return;
  }
  const path = 'estrategias/' + estrategiaActual + '/municipios/' + municipio + '/relas_datos';
  db.ref(path).once('value', snap => {
    const data = snap.val();
    if (data && Array.isArray(data)) {
      relas_processData(data);
      console.log('‚úÖ RELAS: datos cargados desde Firebase para', municipio);
    } else {
      alert('No hay datos RELAS en Firebase para este municipio. Usa "Datos demo" o carga un CSV.');
    }
  });
}

function relas_guardarEnFirebase(municipio) {
  if (!municipio || typeof db === 'undefined' || !relas_globalData) return;
  const path = 'estrategias/' + estrategiaActual + '/municipios/' + municipio + '/relas_datos';
  db.ref(path).set(relas_globalData)
    .then(() => console.log('‚úÖ RELAS: datos guardados en Firebase'))
    .catch(e => console.error('‚ùå RELAS: error guardando', e));
}

// ‚îÄ‚îÄ Procesar datos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_processData(records) {
  relas_globalData = records;
  const habFreq = relas_computeFreq(records,'habitos_vida',6);
  const probFreq = relas_computeFreq(records,'problemas_salud',8);
  const colFreq  = relas_computeFreq(records,'colectivos',6);
  const n = records.length;
  relas_globalData._n = n;
  relas_globalData._habFreq = habFreq;
  relas_globalData._probFreq = probFreq;
  relas_globalData._colFreq = colFreq;

  // Status bar
  const topHab = Object.entries(habFreq).sort((a,b)=>b[1]-a[1])[0];
  const topProb = Object.entries(probFreq).sort((a,b)=>b[1]-a[1])[0];
  const topCol  = Object.entries(colFreq).sort((a,b)=>b[1]-a[1])[0];
  const sb = document.getElementById('relas-statusbar');
  if (sb) {
    sb.style.display = 'flex';
    document.getElementById('relas-st-total').textContent = n;
    document.getElementById('relas-st-hab').textContent = RELAS_HABITOS[topHab[0]].split(' ')[0];
    document.getElementById('relas-st-prob').textContent = RELAS_PROBLEMAS[topProb[0]].split(' ')[0];
    document.getElementById('relas-st-col').textContent = RELAS_COLECTIVOS[topCol[0]].split(' ')[0];
  }
  document.getElementById('relas-dropZone').style.display = 'none';
  document.getElementById('relas-mainTabs').style.display = 'flex';

  relas_renderFrecuencias(records, habFreq, probFreq, colFreq, n);
  relas_renderRanking(habFreq, probFreq, colFreq, n);
  relas_renderCorrelaciones(records, habFreq, probFreq, colFreq, n);
  relas_renderEstrategias(habFreq, probFreq, colFreq, n);
  relas_renderInsights(habFreq, probFreq, colFreq, n, records);
  relas_renderRecomendaciones(habFreq, probFreq, colFreq, n);
  relas_showTab('frecuencias');
  relas_mostrarBtnPresentar();

  // Guardar en Firebase si hay municipio activo
  const mun = getMunicipioActual();
  if (mun) relas_guardarEnFirebase(mun);
}

function relas_computeFreq(records, prefix, max) {
  const freq = {};
  for (let i=1;i<=max;i++) freq[i] = records.filter(r=>r[`${prefix}___${i}`]==='1').length;
  return freq;
}

// ‚îÄ‚îÄ Navegaci√≥n interna RELAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_showTab(name) {
  document.querySelectorAll('.relas-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.relas-panel').forEach(p=>p.classList.remove('active'));
  const btn = document.querySelector(`.relas-tab[onclick="relas_showTab('${name}')"]`);
  if (btn) btn.classList.add('active');
  const panel = document.getElementById(`relas-panel-${name}`);
  if (panel) panel.classList.add('active');
}

// ‚îÄ‚îÄ Render Frecuencias ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_renderFrecuencias(records, habFreq, probFreq, colFreq, n) {
  document.getElementById('relas-empty-frecuencias').style.display='none';
  document.getElementById('relas-content-frecuencias').style.display='block';
  const habSel=Object.values(habFreq).reduce((a,b)=>a+b,0);
  const probSel=Object.values(probFreq).reduce((a,b)=>a+b,0);
  const colSel=Object.values(colFreq).reduce((a,b)=>a+b,0);
  document.getElementById('relas-kpiGrid').innerHTML=`
    <div class="relas-kpi"><div class="relas-kpi-val">${n}</div><div class="relas-kpi-lbl">Participantes</div></div>
    <div class="relas-kpi"><div class="relas-kpi-val">${(habSel/n).toFixed(1)}</div><div class="relas-kpi-lbl">Media h√°bitos/participante</div></div>
    <div class="relas-kpi"><div class="relas-kpi-val">${(probSel/n).toFixed(1)}</div><div class="relas-kpi-lbl">Media problemas/participante</div></div>
    <div class="relas-kpi"><div class="relas-kpi-val">${(colSel/n).toFixed(1)}</div><div class="relas-kpi-lbl">Media colectivos/participante</div></div>`;
  relas_destroyChart('relas-chartHabitos');
  relas_charts['relas-chartHabitos']=new Chart(document.getElementById('relas-chartHabitos'),{type:'bar',data:{labels:Object.values(RELAS_HABITOS),datasets:[{label:'Frecuencia',data:Object.values(habFreq),backgroundColor:RELAS_PAL_GREEN,borderRadius:4}]},options:relas_baseBarOpts('Frecuencia',n)});
  relas_destroyChart('relas-chartProblemas');
  relas_charts['relas-chartProblemas']=new Chart(document.getElementById('relas-chartProblemas'),{type:'bar',data:{labels:Object.values(RELAS_PROBLEMAS),datasets:[{label:'Frecuencia',data:Object.values(probFreq),backgroundColor:RELAS_PAL_ACCENT,borderRadius:4}]},options:relas_baseBarOpts('Frecuencia',n)});
  relas_destroyChart('relas-chartColectivos');
  relas_charts['relas-chartColectivos']=new Chart(document.getElementById('relas-chartColectivos'),{type:'bar',data:{labels:Object.values(RELAS_COLECTIVOS),datasets:[{label:'Frecuencia',data:Object.values(colFreq),backgroundColor:RELAS_PAL_MIXED,borderRadius:4}]},options:{...relas_baseBarOpts('Frecuencia',n),indexAxis:'y'}});
  const habCts=[0,1,2,3];
  const hCF=habCts.map(k=>records.filter(r=>{let s=0;for(let i=1;i<=6;i++)if(r[`habitos_vida___${i}`]==='1')s++;return s===k;}).length);
  const pCF=habCts.map(k=>records.filter(r=>{let s=0;for(let i=1;i<=8;i++)if(r[`problemas_salud___${i}`]==='1')s++;return s===k;}).length);
  const cCF=habCts.map(k=>records.filter(r=>{let s=0;for(let i=1;i<=6;i++)if(r[`colectivos___${i}`]==='1')s++;return s===k;}).length);
  relas_destroyChart('relas-chartSelCount');
  relas_charts['relas-chartSelCount']=new Chart(document.getElementById('relas-chartSelCount'),{type:'bar',data:{labels:['0 sel.','1 sel.','2 sel.','3 sel.'],datasets:[{label:'H√°bitos',data:hCF,backgroundColor:'rgba(64,145,108,0.8)',borderRadius:3},{label:'Problemas',data:pCF,backgroundColor:'rgba(231,111,81,0.8)',borderRadius:3},{label:'Colectivos',data:cCF,backgroundColor:'rgba(38,70,83,0.8)',borderRadius:3}]},options:{...relas_baseBarOpts('N¬∫ participantes',n),plugins:{legend:{display:true}}}});
}

// ‚îÄ‚îÄ Render Ranking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_renderRanking(habFreq, probFreq, colFreq, n) {
  document.getElementById('relas-empty-ranking').style.display='none';
  document.getElementById('relas-content-ranking').style.display='block';
  relas_renderRankList('relas-rankHabitos',habFreq,RELAS_HABITOS,n);
  relas_renderRankList('relas-rankProblemas',probFreq,RELAS_PROBLEMAS,n);
  relas_renderRankList('relas-rankColectivos',colFreq,RELAS_COLECTIVOS,n);
  const habTop=Object.entries(habFreq).sort((a,b)=>b[1]-a[1]).slice(0,4);
  const probTop=Object.entries(probFreq).sort((a,b)=>b[1]-a[1]).slice(0,4);
  const colTop=Object.entries(colFreq).sort((a,b)=>b[1]-a[1]).slice(0,3);
  const rLabels=[...habTop.map(([k])=>'ü•ó '+RELAS_HABITOS[k]),...probTop.map(([k])=>'üè• '+RELAS_PROBLEMAS[k]),...colTop.map(([k])=>'üë• '+RELAS_COLECTIVOS[k])];
  const rData=[...habTop.map(([,v])=>Math.round(v/n*100)),...probTop.map(([,v])=>Math.round(v/n*100)),...colTop.map(([,v])=>Math.round(v/n*100))];
  relas_destroyChart('relas-chartRadar');
  relas_charts['relas-chartRadar']=new Chart(document.getElementById('relas-chartRadar'),{type:'radar',data:{labels:rLabels,datasets:[{label:'% participantes',data:rData,backgroundColor:'rgba(64,145,108,0.2)',borderColor:'#40916c',pointBackgroundColor:'#2d6a4f',pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{r:{min:0,max:100,ticks:{stepSize:20,font:{size:9}},pointLabels:{font:{size:9}}}},plugins:{legend:{display:false}}}});
}
function relas_renderRankList(containerId,freq,labels,n){
  const sorted=Object.entries(freq).sort((a,b)=>b[1]-a[1]);
  const top=sorted[0][1];
  document.getElementById(containerId).innerHTML=sorted.map(([k,v],i)=>`
    <div class="relas-rank-item">
      <div class="relas-rank-num">${i+1}</div>
      <div class="relas-rank-label">${labels[k]}</div>
      <div class="relas-rank-bar-wrap"><div class="relas-rank-bar" style="width:${Math.round(v/top*100)}%"></div></div>
      <div class="relas-rank-pct">${v} (${Math.round(v/n*100)}%)</div>
    </div>`).join('');
}

// ‚îÄ‚îÄ Render Correlaciones ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_renderCorrelaciones(records, habFreq, probFreq, colFreq, n) {
  document.getElementById('relas-empty-correlaciones').style.display='none';
  document.getElementById('relas-content-correlaciones').style.display='block';
  // Top combinaciones hab+prob
  const combos={};
  records.forEach(r=>{
    const hs=[],ps=[];
    for(let i=1;i<=6;i++) if(r[`habitos_vida___${i}`]==='1') hs.push(i);
    for(let i=1;i<=8;i++) if(r[`problemas_salud___${i}`]==='1') ps.push(i);
    hs.forEach(h=>ps.forEach(p=>{const k=`H${h}+P${p}`;combos[k]=(combos[k]||0)+1;}));
  });
  const topCombos=Object.entries(combos).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const decodeK=k=>{const m=k.match(/H(\d+)\+P(\d+)/);return m?`${RELAS_HABITOS[m[1]]} + ${RELAS_PROBLEMAS[m[2]]}`:k;};
  document.getElementById('relas-topCombos').innerHTML=topCombos.map(([k,v],i)=>`
    <div class="relas-rank-item">
      <div class="relas-rank-num">${i+1}</div>
      <div class="relas-rank-label" style="font-size:.7rem;width:180px">${decodeK(k)}</div>
      <div class="relas-rank-bar-wrap"><div class="relas-rank-bar" style="width:${Math.round(v/topCombos[0][1]*100)}%"></div></div>
      <div class="relas-rank-pct">${v} (${Math.round(v/n*100)}%)</div>
    </div>`).join('');
  relas_renderHeatmap('relas-heatmap-hp',records,n,{prefix:'habitos_vida',max:6,labels:RELAS_HABITOS},{prefix:'problemas_salud',max:8,labels:RELAS_PROBLEMAS});
  relas_renderHeatmap('relas-heatmap-pc',records,n,{prefix:'problemas_salud',max:8,labels:RELAS_PROBLEMAS},{prefix:'colectivos',max:6,labels:RELAS_COLECTIVOS});
}
function relas_renderHeatmap(cId,records,n,rowDef,colDef){
  let html=`<table class="relas-heatmap-table"><thead><tr><th></th>`;
  for(let j=1;j<=colDef.max;j++) html+=`<th title="${colDef.labels[j]}">${colDef.labels[j].substring(0,7)}‚Ä¶</th>`;
  html+='</tr></thead><tbody>';
  let maxVal=0;const matrix={};
  for(let i=1;i<=rowDef.max;i++){matrix[i]={};for(let j=1;j<=colDef.max;j++){const c=records.filter(r=>r[`${rowDef.prefix}___${i}`]==='1'&&r[`${colDef.prefix}___${j}`]==='1').length;matrix[i][j]=c;if(c>maxVal)maxVal=c;}}
  for(let i=1;i<=rowDef.max;i++){html+=`<tr><td class="row-label">${rowDef.labels[i]}</td>`;for(let j=1;j<=colDef.max;j++){const v=matrix[i][j],p=Math.round(v/n*100),int=maxVal>0?v/maxVal:0,bg=`rgba(64,145,108,${0.1+int*0.7})`,col=int>0.5?'#fff':'#333';html+=`<td style="background:${bg};color:${col}" title="${rowDef.labels[i]} √ó ${colDef.labels[j]}: ${v} (${p}%)">${p}%</td>`;}html+='</tr>';}
  html+='</tbody></table>';
  document.getElementById(cId).innerHTML=html;
}

// ‚îÄ‚îÄ Render Estrategias ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_renderEstrategias(habFreq, probFreq, colFreq, n) {
  document.getElementById('relas-empty-estrategias').style.display='none';
  document.getElementById('relas-content-estrategias').style.display='block';
  const epvsaItems=[];
  Object.entries(habFreq).forEach(([k,v])=>{const m=RELAS_EPVSA_HABITOS[k];if(m)epvsaItems.push({label:RELAS_HABITOS[k],eje:m.eje,nivel:m.nivel,pct:Math.round(v/n*100)});});
  Object.entries(probFreq).forEach(([k,v])=>{const m=RELAS_EPVSA_PROBLEMAS[k];if(m)epvsaItems.push({label:RELAS_PROBLEMAS[k],eje:m.eje,nivel:m.nivel,pct:Math.round(v/n*100)});});
  document.getElementById('relas-epvsaBlock').innerHTML=`<div class="relas-strategy-block"><div class="relas-strategy-header"><div class="relas-strategy-icon">üå±</div><div><div class="relas-strategy-name">EPVSA</div><div class="relas-strategy-subtitle">Ejes de acci√≥n priorizados</div></div></div><div class="relas-strategy-items">${epvsaItems.sort((a,b)=>b.pct-a.pct).map(it=>`<div class="relas-strategy-item ${it.nivel}"><span class="relas-dot relas-dot-${it.nivel}"></span><span><strong>${it.label}</strong> (${it.pct}%) ¬∑ <em style="color:#888;font-size:.68rem">${it.eje}</em></span></div>`).join('')}</div></div>`;
  const escaItems=[];
  Object.entries(colFreq).forEach(([k,v])=>{const m=RELAS_ESCA_COLECTIVOS[k];if(m)escaItems.push({label:RELAS_COLECTIVOS[k],linea:m.linea,nivel:m.nivel,pct:Math.round(v/n*100)});});
  Object.entries(habFreq).forEach(([k,v])=>{const m=RELAS_ESCA_HABITOS[k];if(m&&m.nivel==='alta')escaItems.push({label:RELAS_HABITOS[k],linea:m.linea,nivel:m.nivel,pct:Math.round(v/n*100)});});
  document.getElementById('relas-escaBlock').innerHTML=`<div class="relas-strategy-block"><div class="relas-strategy-header"><div class="relas-strategy-icon">üèòÔ∏è</div><div><div class="relas-strategy-name">ESCA</div><div class="relas-strategy-subtitle">L√≠neas comunitarias priorizadas</div></div></div><div class="relas-strategy-items">${escaItems.sort((a,b)=>b.pct-a.pct).map(it=>`<div class="relas-strategy-item ${it.nivel}"><span class="relas-dot relas-dot-${it.nivel}"></span><span><strong>${it.label}</strong> (${it.pct}%) ¬∑ <em style="color:#888;font-size:.68rem">${it.linea}</em></span></div>`).join('')}</div></div>`;
  const epAlta=epvsaItems.filter(i=>i.nivel==='alta').reduce((a,i)=>a+i.pct,0)/Math.max(epvsaItems.filter(i=>i.nivel==='alta').length,1);
  const epMedia=epvsaItems.filter(i=>i.nivel==='media').reduce((a,i)=>a+i.pct,0)/Math.max(epvsaItems.filter(i=>i.nivel==='media').length,1);
  const esAlta=escaItems.filter(i=>i.nivel==='alta').reduce((a,i)=>a+i.pct,0)/Math.max(escaItems.filter(i=>i.nivel==='alta').length,1);
  relas_destroyChart('relas-chartAlineacion');
  relas_charts['relas-chartAlineacion']=new Chart(document.getElementById('relas-chartAlineacion'),{type:'doughnut',data:{labels:['EPVSA Alta','EPVSA Media','ESCA Alta'],datasets:[{data:[Math.round(epAlta)||35,Math.round(epMedia)||20,Math.round(esAlta)||30],backgroundColor:['#2d6a4f','#74c69d','#264653'],borderWidth:3,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}});
}

// ‚îÄ‚îÄ Render Insights ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_renderInsights(habFreq, probFreq, colFreq, n, records) {
  document.getElementById('relas-empty-insights').style.display='none';
  document.getElementById('relas-content-insights').style.display='block';
  const sH=Object.entries(habFreq).sort((a,b)=>b[1]-a[1]);
  const sP=Object.entries(probFreq).sort((a,b)=>b[1]-a[1]);
  const sC=Object.entries(colFreq).sort((a,b)=>b[1]-a[1]);
  const emH=habFreq[3],emP=probFreq[5];
  const emBoth=records.filter(r=>r['habitos_vida___3']==='1'&&r['problemas_salud___5']==='1').length;
  const insights=[
    {title:'ü•á Prioridad dominante en h√°bitos',text:`<strong>${RELAS_HABITOS[sH[0][0]]}</strong> es el h√°bito m√°s priorizado (${Math.round(sH[0][1]/n*100)}%), seguido de <strong>${RELAS_HABITOS[sH[1][0]]}</strong> (${Math.round(sH[1][1]/n*100)}%). Ejes 1 y 2 de la EPVSA y l√≠neas 6 y 7 de la ESCA.`},
    {title:'üß† Salud mental: se√±al transversal',text:`Bienestar emocional (${Math.round(emH/n*100)}%) y Malestar emocional (${Math.round(emP/n*100)}%) con alta demanda simult√°nea (${Math.round(emBoth/n*100)}%). Eje 3 EPVSA y L√≠nea 8 ESCA.`},
    {title:`üë• Colectivo focal: ${RELAS_COLECTIVOS[sC[0][0]]}`,text:`Colectivo m√°s priorizado: <strong>${RELAS_COLECTIVOS[sC[0][0]]}</strong> (${Math.round(sC[0][1]/n*100)}%), seguido de <strong>${RELAS_COLECTIVOS[sC[1][0]]}</strong> (${Math.round(sC[1][1]/n*100)}%).`},
    {title:`üè• Problema prioritario: ${RELAS_PROBLEMAS[sP[0][0]]}`,text:`<strong>${RELAS_PROBLEMAS[sP[0][0]]}</strong> encabeza los problemas (${Math.round(sP[0][1]/n*100)}%). Respaldo metodol√≥gico en la EPVSA.`},
    {title:'üîó Oportunidad de intervenci√≥n integrada',text:`Co-ocurrencia entre ${RELAS_HABITOS[sH[0][0]]} y ${RELAS_PROBLEMAS[sP[0][0]]} apunta a intervenciones integradas de alta eficiencia (modelo de activos ESCA).`}
  ];
  document.getElementById('relas-insightsContainer').innerHTML=insights.map(i=>`<div class="relas-insight"><div class="relas-ins-title">${i.title}</div><p style="font-size:.78rem;color:#444;margin:0">${i.text}</p></div>`).join('');
  const topH=sH.slice(0,3).map(([k,v])=>({label:'ü•ó '+RELAS_HABITOS[k],pct:Math.round(v/n*100)}));
  const topP=sP.slice(0,3).map(([k,v])=>({label:'üè• '+RELAS_PROBLEMAS[k],pct:Math.round(v/n*100)}));
  const topC=sC.slice(0,2).map(([k,v])=>({label:'üë• '+RELAS_COLECTIVOS[k],pct:Math.round(v/n*100)}));
  const all=[...topH,...topP,...topC];
  relas_destroyChart('relas-chartPerfil');
  relas_charts['relas-chartPerfil']=new Chart(document.getElementById('relas-chartPerfil'),{type:'bar',data:{labels:all.map(a=>a.label),datasets:[{label:'% participantes',data:all.map(a=>a.pct),backgroundColor:[...RELAS_PAL_GREEN.slice(0,3),...RELAS_PAL_ACCENT.slice(0,3),...RELAS_PAL_MIXED.slice(0,2)],borderRadius:4}]},options:{...relas_baseBarOpts('% participantes',100),plugins:{legend:{display:false}}}});
}

// ‚îÄ‚îÄ Render Recomendaciones ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_renderRecomendaciones(habFreq, probFreq, colFreq, n) {
  document.getElementById('relas-empty-recomendaciones').style.display='none';
  document.getElementById('relas-content-recomendaciones').style.display='block';
  const sH=Object.entries(habFreq).sort((a,b)=>b[1]-a[1]);
  const sP=Object.entries(probFreq).sort((a,b)=>b[1]-a[1]);
  const sC=Object.entries(colFreq).sort((a,b)=>b[1]-a[1]);
  const mkT=(p,cls)=>`<span class="relas-priority-tag relas-${cls}">${p}</span>`;
  const recs=[
    {intervencion:`Taller: ${RELAS_HABITOS[sH[0][0]]} para ${RELAS_COLECTIVOS[sC[0][0]]}`,ambito:'H√°bitos saludables',colectivo:RELAS_COLECTIVOS[sC[0][0]],prioridad:'Alta',marco:'EPVSA Eje 1/2 ¬∑ ESCA L6/7'},
    {intervencion:`Grupo de apoyo: ${RELAS_PROBLEMAS[sP[0][0]]}`,ambito:'Problemas de salud',colectivo:`${RELAS_COLECTIVOS[sC[0][0]]} + ${RELAS_COLECTIVOS[sC[1][0]]}`,prioridad:'Alta',marco:'EPVSA Eje 3 ¬∑ ESCA L8'},
    {intervencion:`Intervenci√≥n integrada: ${RELAS_HABITOS[sH[1][0]]} + ${RELAS_PROBLEMAS[sP[1][0]]}`,ambito:'Transversal',colectivo:RELAS_COLECTIVOS[sC[1][0]],prioridad:'Alta',marco:'EPVSA + ESCA'},
    {intervencion:'Programa de bienestar emocional comunitario',ambito:'Salud mental',colectivo:'Poblaci√≥n general',prioridad:'Alta',marco:'EPVSA Eje 3 ¬∑ ESCA L8'},
    {intervencion:`Taller: ${RELAS_HABITOS[sH[2][0]]} ‚Äî ${RELAS_COLECTIVOS[sC[2]?.[0]||1]}`,ambito:'H√°bitos saludables',colectivo:RELAS_COLECTIVOS[sC[2]?.[0]||1],prioridad:'Media',marco:'EPVSA Eje 2 ¬∑ ESCA L7'}
  ];
  document.getElementById('relas-recomBody').innerHTML=recs.map(r=>`<tr><td><strong>${r.intervencion}</strong></td><td>${r.ambito}</td><td>${r.colectivo}</td><td>${mkT(r.prioridad,r.prioridad==='Alta'?'p-alta':'p-media')}</td><td><span class="relas-strategy-link">${r.marco}</span></td></tr>`).join('');
  // Bubble chart recomendaciones
  const allItems=[...sH.slice(0,5).map(([k,v])=>({label:RELAS_HABITOS[k],x:Math.round(v/n*100),y:70+Math.random()*20,r:v/n*30,tipo:'h√°bito'})),...sP.slice(0,5).map(([k,v])=>({label:RELAS_PROBLEMAS[k],x:Math.round(v/n*100),y:40+Math.random()*25,r:v/n*30,tipo:'problema'})),...sC.slice(0,4).map(([k,v])=>({label:RELAS_COLECTIVOS[k],x:Math.round(v/n*100),y:15+Math.random()*20,r:v/n*30,tipo:'colectivo'}))];
  relas_destroyChart('relas-chartMatriz');
  relas_charts['relas-chartMatriz']=new Chart(document.getElementById('relas-chartMatriz'),{type:'bubble',data:{datasets:[{label:'H√°bitos',data:allItems.filter(i=>i.tipo==='h√°bito').map(i=>({x:i.x,y:i.y,r:Math.max(6,i.r)})),backgroundColor:'rgba(64,145,108,0.6)',borderColor:'#2d6a4f'},{label:'Problemas',data:allItems.filter(i=>i.tipo==='problema').map(i=>({x:i.x,y:i.y,r:Math.max(6,i.r)})),backgroundColor:'rgba(231,111,81,0.6)',borderColor:'#c25e3e'},{label:'Colectivos',data:allItems.filter(i=>i.tipo==='colectivo').map(i=>({x:i.x,y:i.y,r:Math.max(6,i.r)})),backgroundColor:'rgba(38,70,83,0.6)',borderColor:'#264653'}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{title:{display:true,text:'% participantes'},min:0,max:100},y:{title:{display:true,text:'Dimensi√≥n'},min:0,max:100,ticks:{display:false}}},plugins:{legend:{display:true}}}});
}

// ‚îÄ‚îÄ Simulador ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_initSimulatorUI() {
  const habGrid = document.getElementById('relas-sim-hab');
  const probGrid = document.getElementById('relas-sim-prob');
  const colGrid  = document.getElementById('relas-sim-col');
  if (!habGrid || habGrid.children.length > 0) return; // ya inicializado
  Object.entries(RELAS_HABITOS).forEach(([k,v])=>{
    const b=document.createElement('span');b.className='relas-chip';b.textContent=v;
    b.onclick=()=>relas_toggleChip(b,'sh',+k);habGrid.appendChild(b);
  });
  Object.entries(RELAS_PROBLEMAS).forEach(([k,v])=>{
    const b=document.createElement('span');b.className='relas-chip';b.textContent=v;
    b.onclick=()=>relas_toggleChip(b,'sp',+k);probGrid.appendChild(b);
  });
  Object.entries(RELAS_COLECTIVOS).forEach(([k,v])=>{
    const b=document.createElement('span');b.className='relas-chip';b.textContent=v;
    b.onclick=()=>relas_toggleChip(b,'sc',+k);colGrid.appendChild(b);
  });
}

function relas_toggleChip(el, key, val) {
  const arr = relas_simState[key];
  const idx = arr.indexOf(val);
  if (idx>-1) { arr.splice(idx,1); el.classList.remove('sel'); }
  else { arr.push(val); el.classList.add('sel'); }
}

function relas_scoreV2(iv, selHab, selProb, selCol) {
  const hM=selHab.filter(h=>iv.habitos.includes(h));
  const pM=selProb.filter(p=>iv.problemas.includes(p));
  const cM=selCol.filter(c=>iv.colectivos.includes(c));
  const totalSel=selHab.length+selProb.length+selCol.length;
  const totalMatch=hM.length+pM.length+cM.length;
  const cob=totalSel>0?totalMatch/totalSel:0;
  const totalKB=iv.habitos.length+iv.problemas.length+iv.colectivos.length;
  const esp=totalKB>0?totalMatch/totalKB:0;
  const cal=iv.evidencia/100*0.4+iv.efectividad/100*0.4+iv.viabilidad/100*0.2;
  const score=Math.round(Math.min((cob*0.55+esp*0.25+cal*0.2)*100,100));
  return {score,cobertura:Math.round(cob*100),especificidad:Math.round(esp*100),calidad:Math.round(cal*100),habMatch:hM,probMatch:pM,colMatch:cM,totalMatch};
}

function relas_calcAlineacion(selHab, selProb, selCol) {
  const score=(items,map)=>items.reduce((a,k)=>{const m=map[k];return a+(m?m.nivel==='alta'?3:m.nivel==='media'?2:1:0);},0);
  const maxS=n=>n*3;
  const epvsa=selHab.length+selProb.length>0?Math.min(100,Math.round((score(selHab,RELAS_EPVSA_HABITOS)+score(selProb,RELAS_EPVSA_PROBLEMAS))/maxS(selHab.length+selProb.length)*100)):0;
  const esca=selCol.length+selHab.length>0?Math.min(100,Math.round((score(selCol,RELAS_ESCA_COLECTIVOS)+score(selHab,RELAS_ESCA_HABITOS))/maxS(selCol.length+selHab.length)*100)):0;
  return {epvsa,esca};
}

function relas_calcCongruencia(selHab, selProb, selCol) {
  const pairs=[{h:[1],p:[3,6],bonus:2},{h:[2],p:[3,7],bonus:2},{h:[3],p:[5,7],bonus:3},{h:[4],p:[4],bonus:3},{h:[5],p:[2],bonus:3},{h:[1,2],c:[3],bonus:2},{h:[3],c:[4],bonus:2},{h:[3,1],c:[1],bonus:2},{h:[2,3],c:[2],bonus:2},{p:[1,2],c:[2],bonus:2},{p:[5],c:[4],bonus:2}];
  let total=0;
  pairs.forEach(p=>{const hOK=!p.h||p.h.every(h=>selHab.includes(h));const pOK=!p.p||p.p.some(x=>selProb.includes(x));const cOK=!p.c||p.c.some(c=>selCol.includes(c));if(hOK&&pOK&&cOK)total+=p.bonus;});
  return Math.min(100,total*12);
}

function relas_runSimulator() {
  const selHab=[...relas_simState.sh],selProb=[...relas_simState.sp],selCol=[...relas_simState.sc];
  if(selHab.length+selProb.length+selCol.length===0){alert('Selecciona al menos una opci√≥n.');return;}
  const nombre=document.getElementById('relas-simNombre').value.trim()||'Escenario sin nombre';
  const alin=relas_calcAlineacion(selHab,selProb,selCol);
  const cong=relas_calcCongruencia(selHab,selProb,selCol);
  const globalScore=Math.round(alin.epvsa*0.35+alin.esca*0.35+cong*0.3);
  const scored=RELAS_KB.map(iv=>({...iv,...relas_scoreV2(iv,selHab,selProb,selCol)})).filter(i=>i.score>0).sort((a,b)=>b.score-a.score);
  relas_lastSimResult={nombre,selHab,selProb,selCol,alin,cong,globalScore,scored};
  relas_renderSimResults(nombre,selHab,selProb,selCol,scored,alin,cong,globalScore);
}

function relas_renderSimResults(nombre, selHab, selProb, selCol, scored, alin, cong, globalScore) {
  const scoreLbl=globalScore>=75?'Muy alta':globalScore>=50?'Alta':globalScore>=30?'Moderada':'Baja';
  const mkChip=(items,dict)=>items.map(i=>`<span style="background:#d8f3dc;color:#2d6a4f;padding:.1rem .4rem;border-radius:3px;font-size:.7rem;margin:.1rem">${dict[i]}</span>`).join('');
  const ivCards=scored.slice(0,7).map((iv,i)=>{
    const c=RELAS_PAL_GREEN[i%RELAS_PAL_GREEN.length];
    const cc=iv.score>=70?'#2d6a4f':iv.score>=45?'#f4a261':'#e76f51';
    return `<div class="relas-iv-card" onclick="relas_abrirFicha('${iv.id}')">
      <div class="relas-iv-title">${i+1}. ${iv.nombre} <span style="color:${cc};float:right">${iv.score}%</span></div>
      <div class="relas-iv-meta">‚è± ${iv.duracion} ¬∑ ${iv.formato} ¬∑ ${iv.epvsa} ¬∑ ${iv.esca}</div>
      <div style="font-size:.7rem;color:#777">${iv.desc}</div>
      <div class="relas-ev-bar"><div class="relas-ev-fill" style="width:${iv.score}%;background:${cc}"></div></div>
    </div>`;
  }).join('');
  document.getElementById('relas-simResultsArea').innerHTML=`
    <div style="background:#f4faf6;border-radius:10px;padding:1rem;margin-bottom:1rem">
      <div class="relas-ssh-top">
        <div><div class="relas-ssh-title">üß™ ${nombre}</div><div class="relas-ssh-sub">${selHab.length} h√°bito(s) ¬∑ ${selProb.length} problema(s) ¬∑ ${selCol.length} colectivo(s) ¬∑ ${scored.length} intervenciones</div></div>
        <div class="relas-score-circle"><div class="relas-score-num">${globalScore}</div><div class="relas-score-lbl">√çndice</div></div>
      </div>
      <div class="relas-dims">
        <div class="relas-dim"><div class="relas-dim-label">EPVSA</div><div class="relas-dim-bar"><div class="relas-dim-fill" style="width:${alin.epvsa}%"></div></div><div class="relas-dim-val">${alin.epvsa}%</div></div>
        <div class="relas-dim"><div class="relas-dim-label">ESCA</div><div class="relas-dim-bar"><div class="relas-dim-fill" style="width:${alin.esca}%"></div></div><div class="relas-dim-val">${alin.esca}%</div></div>
        <div class="relas-dim"><div class="relas-dim-label">Coherencia</div><div class="relas-dim-bar"><div class="relas-dim-fill" style="width:${cong}%"></div></div><div class="relas-dim-val">${cong}%</div></div>
        <div class="relas-dim"><div class="relas-dim-label">Global</div><div class="relas-dim-bar"><div class="relas-dim-fill" style="width:${globalScore}%"></div></div><div class="relas-dim-val">${scoreLbl}</div></div>
      </div>
    </div>
    <div>${ivCards}</div>
    ${scored.length===0?'<div style="text-align:center;padding:2rem;color:#aaa">Sin intervenciones coincidentes. Ampl√≠a los criterios.</div>':''}`;
}

// ‚îÄ‚îÄ Ficha t√©cnica de intervenci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_abrirFicha(id) {
  const iv=RELAS_KB.find(i=>i.id===id);if(!iv)return;
  const mkEv=(lbl,val,col)=>`<div class="relas-ev-meter"><div class="relas-ev-label">${lbl} ‚Äî ${val}%</div><div class="relas-ev-bar"><div class="relas-ev-fill" style="width:${val}%;background:${col}"></div></div></div>`;
  document.getElementById('relas-fichaModal').innerHTML=`
    <div class="relas-ficha-header">
      <div><h3 style="margin:0;font-size:1rem">${iv.nombre}</h3><p style="margin:.25rem 0 0;font-size:.75rem;opacity:.8">Ficha t√©cnica RELAS ¬∑ ${iv.id}</p></div>
      <button class="relas-ficha-close" onclick="relas_closeFicha({target:document.getElementById('relas-fichaOverlay')})">‚úï</button>
    </div>
    <div class="relas-ficha-body">
      <div class="relas-ficha-section"><div class="relas-ficha-section-title">Descripci√≥n</div><p style="font-size:.8rem;color:#444">${iv.desc}</p></div>
      <div class="relas-ficha-section"><div class="relas-ficha-section-title">Datos operativos</div>
        <div class="relas-ficha-grid">
          <div class="relas-ficha-field"><div class="relas-ficha-field-label">Duraci√≥n</div><div class="relas-ficha-field-val">${iv.duracion}</div></div>
          <div class="relas-ficha-field"><div class="relas-ficha-field-label">N¬∫ sesiones</div><div class="relas-ficha-field-val">${iv.sesiones}</div></div>
          <div class="relas-ficha-field"><div class="relas-ficha-field-label">Formato</div><div class="relas-ficha-field-val">${iv.formato}</div></div>
          <div class="relas-ficha-field"><div class="relas-ficha-field-label">Coste</div><div class="relas-ficha-field-val">${iv.coste}</div></div>
          <div class="relas-ficha-field"><div class="relas-ficha-field-label">EPVSA</div><div class="relas-ficha-field-val">${iv.epvsa}</div></div>
          <div class="relas-ficha-field"><div class="relas-ficha-field-label">ESCA</div><div class="relas-ficha-field-val">${iv.esca}</div></div>
          <div class="relas-ficha-field"><div class="relas-ficha-field-label">Responsable</div><div class="relas-ficha-field-val">${iv.responsable}</div></div>
          <div class="relas-ficha-field"><div class="relas-ficha-field-label">Metodolog√≠a</div><div class="relas-ficha-field-val">${iv.metodologia}</div></div>
        </div>
      </div>
      <div class="relas-ficha-section"><div class="relas-ficha-section-title">Indicadores de calidad</div>
        <div class="relas-ficha-grid">
          ${mkEv('Evidencia cient√≠fica',iv.evidencia,'#2d6a4f')}${mkEv('Efectividad esperada',iv.efectividad,'#40916c')}${mkEv('Viabilidad contextual',iv.viabilidad,'#74c69d')}
        </div>
      </div>
      <div class="relas-ficha-section"><div class="relas-ficha-section-title">Pasos de implementaci√≥n</div><ul class="relas-int-steps">${iv.pasos.map(p=>`<li>${p}</li>`).join('')}</ul></div>
      <div class="relas-ficha-section"><div class="relas-ficha-section-title">Indicadores de evaluaci√≥n</div><ul class="relas-int-steps">${(iv.indicadores||[]).map(i=>`<li>${i}</li>`).join('')}</ul></div>
      <div class="relas-ficha-grid">
        <div class="relas-ficha-section"><div class="relas-ficha-section-title">Perfil profesional</div><div class="relas-int-recursos">${(iv.perfil_profesional||[]).map(r=>`<span>${r}</span>`).join('')}</div></div>
        <div class="relas-ficha-section"><div class="relas-ficha-section-title">Coordinaci√≥n</div><div class="relas-int-recursos">${(iv.coordinacion||[]).map(r=>`<span>${r}</span>`).join('')}</div></div>
      </div>
      <div class="relas-ficha-section" style="background:#f9f9f7;padding:.7rem;border-radius:.5rem;font-size:.75rem;color:#555">${iv.referencia}</div>
      <button class="relas-ficha-print-btn" onclick="window.print()">üñ® Imprimir / PDF</button>
    </div>`;
  document.getElementById('relas-fichaOverlay').classList.add('open');
}
function relas_closeFicha(e) {
  if(!e||e.target.id==='relas-fichaOverlay'||e.target.classList.contains('relas-ficha-close'))
    document.getElementById('relas-fichaOverlay').classList.remove('open');
}

// ‚îÄ‚îÄ Fusi√≥n triple ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_mostrarPriorizacionTriple() {
  // Recoger ranking epidemiol√≥gico
  const rankE = (() => {
    if (!window.datosMunicipioActual) return [];
    const dm = window.datosMunicipioActual;
    const priList = dm.priorizacion || [];
    return priList.map((p,i)=>({nombre:typeof p==='string'?p:p.nombre||p.texto||JSON.stringify(p),posicion:i+1}));
  })();

  // Recoger ranking ciudadano
  const rankC = (() => {
    if (!window.datosParticipacionCiudadana) return [];
    const vot = window.datosParticipacionCiudadana;
    const conteos = {};
    (vot.votos||[]).forEach(v=>{const obj=v.objetivo||v.opcion||v.respuesta1||'';if(obj)conteos[obj]=(conteos[obj]||0)+1;});
    return Object.entries(conteos).sort((a,b)=>b[1]-a[1]).map(([nombre,votos],i)=>({nombre,votos,posicion:i+1}));
  })();

  // Recoger ranking RELAS
  const rankR = (() => {
    if (!relas_globalData||!relas_globalData._habFreq) return [];
    const hF=relas_globalData._habFreq,pF=relas_globalData._probFreq;
    const n=relas_globalData._n;
    const items=[];
    Object.entries(hF).forEach(([k,v])=>items.push({nombre:'ü•ó '+RELAS_HABITOS[k],pct:Math.round(v/n*100)}));
    Object.entries(pF).forEach(([k,v])=>items.push({nombre:'üè• '+RELAS_PROBLEMAS[k],pct:Math.round(v/n*100)}));
    return items.sort((a,b)=>b.pct-a.pct).map((it,i)=>({...it,posicion:i+1}));
  })();

  // Fusi√≥n: crear conjunto de √°reas √∫nicas y puntuar
  const areasUnicas = new Set([
    ...rankE.map(r=>r.nombre),
    ...rankC.map(r=>r.nombre),
    ...rankR.map(r=>r.nombre)
  ]);

  const fusionada = Array.from(areasUnicas).map(nombre=>{
    const epi = rankE.find(r=>r.nombre===nombre);
    const ciu = rankC.find(r=>r.nombre===nombre);
    const rel = rankR.find(r=>r.nombre===nombre);
    const nE = rankE.length, nC = rankC.length, nR = rankR.length;
    const pE = epi ? Math.round((1 - (epi.posicion-1)/Math.max(nE,1))*100) : 0;
    const pC = ciu ? Math.round((1 - (ciu.posicion-1)/Math.max(nC,1))*100) : 0;
    const pR = rel ? Math.round((1 - (rel.posicion-1)/Math.max(nR,1))*100) : 0;
    const score = Math.round(pE*0.55 + pC*0.30 + pR*0.15);
    return {nombre, pE, pC, pR, score};
  }).sort((a,b)=>b.score-a.score);

  // Renderizar columnas comparativas
  const mkCol=(title,items,cls,color)=>`
    <div class="relas-triple-col ${cls}">
      <h4 style="color:${color}">${title}</h4>
      ${items.slice(0,6).map((it,i)=>`<div style="font-size:.75rem;padding:.25rem 0;border-bottom:1px solid #f0f0f0">${i+1}. ${it.nombre}</div>`).join('') || '<div style="font-size:.75rem;color:#aaa">Sin datos disponibles</div>'}
    </div>`;

  const colsHTML = `
    ${mkCol('üî¨ Epidemiol√≥gico (55%)', rankE, 'epi', '#6366f1')}
    ${mkCol('üó≥Ô∏è Ciudadano (30%)', rankC, 'ciu', '#ec4899')}
    ${mkCol('üìã RELAS (15%)', rankR, 'rel', '#10b981')}`;

  const fusionHTML = `<div style="margin-top:1rem"><h4 style="color:#1a1a1a;margin-bottom:.5rem">‚ö° Ranking fusionado</h4>
    ${fusionada.slice(0,8).map((it,i)=>`
      <div style="display:flex;align-items:center;gap:.5rem;padding:.4rem 0;border-bottom:1px solid #f0f0f0;font-size:.78rem">
        <div style="width:22px;height:22px;border-radius:50%;background:#2d6a4f;color:#fff;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;flex-shrink:0">${i+1}</div>
        <div style="flex:1">${it.nombre}</div>
        <div style="display:flex;gap:.35rem">
          <span style="background:#ede9fe;color:#6366f1;padding:.1rem .35rem;border-radius:3px;font-size:.65rem">Epi:${it.pE}</span>
          <span style="background:#fce7f3;color:#ec4899;padding:.1rem .35rem;border-radius:3px;font-size:.65rem">Ciu:${it.pC}</span>
          <span style="background:#d1fae5;color:#10b981;padding:.1rem .35rem;border-radius:3px;font-size:.65rem">REL:${it.pR}</span>
          <span style="background:#2d6a4f;color:#fff;padding:.1rem .4rem;border-radius:3px;font-size:.68rem;font-weight:700">${it.score}</span>
        </div>
      </div>`).join('')}
  </div>`;

  document.getElementById('relas-triple-cols-content').innerHTML = colsHTML + fusionHTML;
  // Guardar fusi√≥n para confirmar
  window._relas_fusionActual = fusionada;
  document.getElementById('relas-tripleModal').classList.add('open');
}

function relas_confirmarPriorizacionTriple() {
  const fusionada = window._relas_fusionActual;
  if (!fusionada || fusionada.length === 0) return;
  const top5 = fusionada.slice(0,5).map(it=>it.nombre);
  const decision = {
    tipo: 'triple_fusion',
    fecha: new Date().toISOString(),
    algoritmo: '55% epidemiol√≥gico + 30% ciudadano + 15% RELAS',
    prioridades: top5,
    fusionCompleta: fusionada.slice(0,10)
  };
  window.decisionPriorizacionActual = decision;
  // Guardar en Firebase
  const mun = getMunicipioActual();
  if (mun && typeof db !== 'undefined') {
    db.ref('estrategias/' + estrategiaActual + '/municipios/' + mun + '/decisionPriorizacion').set(decision)
      .then(()=>console.log('‚úÖ Priorizaci√≥n triple guardada'))
      .catch(e=>console.error('‚ùå Error guardando priorizaci√≥n triple',e));
  }
  document.getElementById('relas-tripleModal').classList.remove('open');
  mostrarNotificacion('‚úÖ Priorizaci√≥n triple guardada como decisi√≥n oficial del municipio', 'exito');
}

// ‚îÄ‚îÄ Exportaci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_exportarInforme() {
  if (!relas_lastSimResult) { alert('Ejecuta primero una simulaci√≥n.'); return; }
  const {nombre,selHab,selProb,selCol,alin,cong,globalScore,scored} = relas_lastSimResult;
  const fecha = new Date().toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});
  const mun = getMunicipioActual()||'Sin municipio';
  const w = window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">
  <title>Informe RELAS ‚Äì ${nombre}</title>
  <style>body{font-family:Georgia,serif;max-width:820px;margin:0 auto;padding:2rem;color:#222;font-size:13px}h1{font-size:1.5rem;color:#2d6a4f}h2{font-size:1rem;color:#264653;border-bottom:2px solid #d8f3dc;padding-bottom:.3rem;margin-top:1.5rem}.meta{color:#888;font-size:.8rem;margin-bottom:1.5rem}.badge{display:inline-block;background:#d8f3dc;color:#2d6a4f;border-radius:.3rem;padding:.1rem .4rem;font-size:.72rem;font-weight:700;margin:.1rem}.score-row{display:flex;gap:2rem;margin:1rem 0;background:#f4faf6;padding:.8rem;border-radius:.4rem}.sc{text-align:center}.sc-val{font-size:1.4rem;font-weight:700;color:#2d6a4f}.sc-lbl{font-size:.65rem;color:#888;text-transform:uppercase}.iv-card{border:1px solid #d0e0d6;border-left:4px solid #2d6a4f;border-radius:.3rem;padding:.7rem;margin-bottom:.6rem}.iv-title{font-weight:700;color:#264653}.iv-meta{font-size:.72rem;color:#777;margin:.25rem 0}.footer{border-top:1px solid #ddd;margin-top:2rem;padding-top:1rem;font-size:.7rem;color:#aaa;text-align:center}@media print{body{padding:0}}</style>
  </head><body>
  <h1>üß™ Informe RELAS ‚Äî ${nombre}</h1>
  <div class="meta">Municipio: <strong>${mun}</strong> ¬∑ Generado: ${fecha} ¬∑ Analizador RELAS integrado en COMP√ÅS</div>
  <h2>1. Configuraci√≥n del escenario</h2>
  <p><strong>H√°bitos:</strong> ${selHab.map(h=>`<span class="badge">${RELAS_HABITOS[h]}</span>`).join(' ')||'‚Äî'}</p>
  <p><strong>Problemas:</strong> ${selProb.map(p=>`<span class="badge">${RELAS_PROBLEMAS[p]}</span>`).join(' ')||'‚Äî'}</p>
  <p><strong>Colectivos:</strong> ${selCol.map(c=>`<span class="badge">${RELAS_COLECTIVOS[c]}</span>`).join(' ')||'‚Äî'}</p>
  <h2>2. Alineaci√≥n estrat√©gica</h2>
  <div class="score-row">
    <div class="sc"><div class="sc-val">${globalScore}%</div><div class="sc-lbl">Global</div></div>
    <div class="sc"><div class="sc-val">${alin.epvsa}%</div><div class="sc-lbl">EPVSA</div></div>
    <div class="sc"><div class="sc-val">${alin.esca}%</div><div class="sc-lbl">ESCA</div></div>
    <div class="sc"><div class="sc-val">${cong}%</div><div class="sc-lbl">Coherencia</div></div>
  </div>
  <h2>3. Intervenciones recomendadas</h2>
  ${scored.slice(0,7).map((iv,i)=>`<div class="iv-card"><div class="iv-title">${i+1}. ${iv.nombre} ‚Äî <span style="color:#2d6a4f">${iv.score}%</span></div><div class="iv-meta">‚è± ${iv.duracion} ¬∑ ${iv.formato} ¬∑ üí∞ ${iv.coste} ¬∑ ${iv.epvsa} ¬∑ ${iv.esca}</div><p style="font-size:.77rem;color:#444;margin:.25rem 0">${iv.desc}</p></div>`).join('')}
  <div class="footer">COMP√ÅS ¬∑ Analizador RELAS ¬∑ SAS ‚Äì Servicio Andaluz de Salud ¬∑ Documento generado autom√°ticamente.</div>
  <script>window.onload=()=>window.print()<\/script></body></html>`);
  w.document.close();
}

function relas_exportarCSVResumen() {
  if (!relas_globalData||!relas_globalData._habFreq) { alert('No hay datos RELAS cargados.'); return; }
  const hF=relas_globalData._habFreq,pF=relas_globalData._probFreq,cF=relas_globalData._colFreq,n=relas_globalData._n;
  const mun = getMunicipioActual()||'sin_municipio';
  const fecha = new Date().toISOString().slice(0,10);
  const rows=[['Dimensi√≥n','C√≥digo','Etiqueta','Frecuencia','Porcentaje']];
  Object.entries(hF).forEach(([k,v])=>rows.push(['H√°bito',k,RELAS_HABITOS[k],v,Math.round(v/n*100)+'%']));
  Object.entries(pF).forEach(([k,v])=>rows.push(['Problema',k,RELAS_PROBLEMAS[k],v,Math.round(v/n*100)+'%']));
  Object.entries(cF).forEach(([k,v])=>rows.push(['Colectivo',k,RELAS_COLECTIVOS[k],v,Math.round(v/n*100)+'%']));
  const csv=rows.map(r=>r.join(';')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`RELAS_${mun}_${fecha}.csv`;a.click();
}

// ‚îÄ‚îÄ Gancho al cambio de municipio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Se inyecta llamada en cargarParticipacionCiudadana que ya se invoca al cambiar municipio
// (No tocamos esa funci√≥n ‚Äî este hook es pasivo: si el tab RELAS est√° abierto, recarga)


// =====================================================================
// PRESENTACI√ìN DE RESULTADOS RELAS ‚Äî SISTEMA DE EVENTOS
// =====================================================================

// ‚îÄ‚îÄ Estado de eventos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let relas_eventos = [];
let relas_eventoActual = null;

// ‚îÄ‚îÄ Cargar/guardar eventos en localStorage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_cargarEventos() {
  try {
    const raw = localStorage.getItem('relas_eventos');
    relas_eventos = raw ? JSON.parse(raw) : [];
  } catch(e) { relas_eventos = []; }
}
function relas_guardarEventos() {
  try { localStorage.setItem('relas_eventos', JSON.stringify(relas_eventos)); } catch(e) {}
}

// ‚îÄ‚îÄ UI del selector de eventos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_poblarSelectorEventos() {
  const sel = document.getElementById('relas-pres-evento-sel');
  if (!sel) return;
  sel.innerHTML = '<option value="">‚Äî Sin evento seleccionado ‚Äî</option>';
  relas_eventos.forEach(ev => {
    const opt = document.createElement('option');
    opt.value = ev.id;
    opt.textContent = ev.nombre;
    if (ev.id === relas_eventoActual) opt.selected = true;
    sel.appendChild(opt);
  });
}

function relas_seleccionarEvento() {
  const sel = document.getElementById('relas-pres-evento-sel');
  relas_eventoActual = sel.value || null;
  const ev = relas_eventos.find(e => e.id === relas_eventoActual);
  document.getElementById('relas-pres-titulo').textContent =
    ev ? ev.nombre : 'Priorizaci√≥n Popular de Salud';
  document.getElementById('relas-pres-subtitulo').textContent =
    ev ? (ev.subtitulo || '') : 'Selecciona o crea un evento para personalizar esta pantalla';
  const btnBorrar = document.getElementById('relas-btn-borrar-ev');
  if (btnBorrar) { btnBorrar.style.opacity = ev ? '1' : '0.3'; btnBorrar.disabled = !ev; }
}

function relas_nuevoEventoUI() {
  const mun = (typeof getNombreMunicipio === 'function' && typeof getMunicipioActual === 'function')
    ? getNombreMunicipio(getMunicipioActual()) : '';
  const anyo = new Date().getFullYear();
  document.getElementById('relas-nuevo-evento-nombre').value =
    mun ? `Priorizaci√≥n Popular de Salud ${mun} ${anyo}` : '';
  document.getElementById('relas-nuevo-evento-subtitulo').value = '';
  document.getElementById('relas-nuevo-evento-modal').style.display = 'flex';
  setTimeout(() => document.getElementById('relas-nuevo-evento-nombre').focus(), 100);
}

function relas_crearEvento() {
  const nombre = document.getElementById('relas-nuevo-evento-nombre').value.trim();
  if (!nombre) { document.getElementById('relas-nuevo-evento-nombre').focus(); return; }
  const subtitulo = document.getElementById('relas-nuevo-evento-subtitulo').value.trim();
  const ev = { id: Date.now().toString(36), nombre, subtitulo, creadoEn: new Date().toISOString() };
  relas_eventos.unshift(ev);
  relas_guardarEventos();
  relas_eventoActual = ev.id;
  document.getElementById('relas-nuevo-evento-modal').style.display = 'none';
  relas_poblarSelectorEventos();
  relas_seleccionarEvento();
}

function relas_borrarEvento() {
  if (!relas_eventoActual) return;
  const ev = relas_eventos.find(e => e.id === relas_eventoActual);
  if (!ev) return;
  if (!confirm('¬øEliminar el evento "' + ev.nombre + '"?')) return;
  relas_eventos = relas_eventos.filter(e => e.id !== relas_eventoActual);
  relas_eventoActual = null;
  relas_guardarEventos();
  relas_poblarSelectorEventos();
  relas_seleccionarEvento();
}

// ‚îÄ‚îÄ Abrir / cerrar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_abrirPresentacion() {
  // Si no hay CSV pero hay votos de simulaci√≥n/acto, construir datos desde ellos
  if (!relas_globalData || !relas_globalData._habFreq) {
    const todos = (typeof vrelas_obtenerVotosCombinados === 'function') ? vrelas_obtenerVotosCombinados() : [];
    if (!todos.length) {
      alert('Carga primero un CSV en el Analizador RELAS, o inicia una sesi√≥n de votaci√≥n y simula votos.');
      return;
    }
    // Construir frecuencias desde los votos disponibles (nueva dimensi√≥n √∫nica)
    const temasFreq = {};
    for(let i=1;i<=10;i++) temasFreq[i]=0;
    todos.forEach(function(v) {
      (v.temas||[]).forEach(function(k){ temasFreq[k]=(temasFreq[k]||0)+1; });
    });
    relas_globalData = { _temasFreq: temasFreq, _habFreq: temasFreq, _n: todos.length };
  }
  relas_cargarEventos();
  relas_poblarSelectorEventos();
  const overlay = document.getElementById('relas-presentacion-overlay');
  overlay.style.display = 'block';
  document.body.style.overflow = 'hidden';
  relas_seleccionarEvento();
  relas_renderPodio();
}

function relas_cerrarPresentacion() {
  document.getElementById('relas-presentacion-overlay').style.display = 'none';
  document.body.style.overflow = '';
  if (document.fullscreenElement) document.exitFullscreen().catch(function(){});
}

function relas_toggleFullscreen() {
  const el = document.getElementById('relas-presentacion-overlay');
  if (!document.fullscreenElement) {
    el.requestFullscreen().catch(function(e){ console.warn('Fullscreen no disponible:', e); });
  } else {
    document.exitFullscreen().catch(function(){});
  }
}

// ‚îÄ‚îÄ Render del podio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_renderPodio() {
  const tF = relas_globalData._temasFreq || relas_globalData._habFreq || {};
  const n  = relas_globalData._n;

  const badge = document.getElementById('relas-pres-badge-n');
  if (badge) badge.textContent = n + ' participante' + (n !== 1 ? 's' : '');

  const info = document.getElementById('relas-pres-info');
  if (info) info.textContent = 'N = ' + n + ' ¬∑ ' + new Date().toLocaleDateString('es-ES');

  relas_renderColumnasPodio('relas-pres-hab', tF, VRELAS_TEMAS, n,
    { top:'#00acd9', bar:'linear-gradient(90deg,#0074c8,#00acd9)', glow:'rgba(0,172,217,.4)', text:'#e0f2fe', dim:'rgba(0,116,200,.12)', border:'rgba(0,172,217,.25)' });
}

function relas_renderColumnasPodio(containerId, freq, labels, n, pal) {
  const container = document.getElementById(containerId);
  if (!container) return;

  const sorted = Object.entries(freq)
    .map(function(entry){ return { k: entry[0], v: entry[1], pct: Math.round(entry[1] / n * 100) }; })
    .sort(function(a, b){ return b.v - a.v; });

  const maxV = sorted[0] ? sorted[0].v : 1;
  const medallas = ['ü•á', 'ü•à', 'ü•â'];

  container.innerHTML = sorted.map(function(item, i) {
    const k = item.k, v = item.v, pct = item.pct;
    const isTop = i === 0;
    const medal = medallas[i] || '';
    const barW  = Math.round(v / maxV * 100);

    return '<div style="' +
      'background:' + (isTop ? '#fff' : '#f8fafc') + ';' +
      'border:1px solid ' + (isTop ? pal.top : pal.border) + ';' +
      'border-left:4px solid ' + (isTop ? pal.top : 'transparent') + ';' +
      'border-radius:10px;' +
      'padding:' + (isTop ? '.95rem 1.1rem' : '.7rem 1rem') + ';' +
      (isTop ? 'box-shadow:0 0 24px ' + pal.glow + ';' : '') +
      'position:relative;overflow:hidden;margin-bottom:0">' +
      '' +
      '<div style="position:relative;display:flex;align-items:center;gap:.7rem;margin-bottom:.55rem">' +
        (medal
          ? '<span style="font-size:' + (isTop ? '1.5rem' : '1.1rem') + ';flex-shrink:0">' + medal + '</span>'
          : '<span style="width:1.1rem;text-align:center;color:#475569;font-size:.75rem;font-weight:700;flex-shrink:0">' + (i+1) + '</span>') +
        '<div style="flex:1;min-width:0">' +
          '<div style="' +
            'color:' + (isTop ? pal.top : '#475569') + ';' +
            'font-weight:' + (isTop ? '700' : '500') + ';' +
            'font-size:' + (isTop ? 'clamp(.85rem,1.4vw,1.05rem)' : 'clamp(.75rem,1.1vw,.9rem)') + ';' +
            'line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' +
          (labels[k] || '‚Äî') + '</div>' +
        '</div>' +
        '<div style="' +
          'color:' + (isTop ? pal.top : '#64748b') + ';' +
          'font-weight:800;' +
          'font-size:' + (isTop ? 'clamp(1.1rem,2vw,1.5rem)' : 'clamp(.85rem,1.4vw,1.1rem)') + ';' +
          'flex-shrink:0;' +
          (isTop ? 'text-shadow:0 0 20px ' + pal.glow + ';' : '') +
        '">' + pct + '%</div>' +
      '</div>' +
      '<div style="height:' + (isTop ? '8px' : '5px') + ';background:rgba(255,255,255,.07);border-radius:4px;overflow:hidden">' +
        '<div style="' +
          'height:100%;width:' + barW + '%;' +
          'background:' + pal.bar + ';' +
          'border-radius:4px;' +
          (isTop ? 'box-shadow:0 0 10px ' + pal.glow + ';' : '') +
        '"></div>' +
      '</div>' +
      (isTop ? '<div style="margin-top:.4rem;color:#94a3b8;font-size:.68rem">' + v + ' de ' + n + ' participantes</div>' : '') +
    '</div>';
  }).join('');
}

// ‚îÄ‚îÄ Mostrar bot√≥n presentar cuando hay datos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function relas_mostrarBtnPresentar() {
  const btn = document.getElementById('relas-btn-presentar');
  if (btn) btn.style.display = 'block';
}


// =====================================================================
// VOTACI√ìN RELAS ‚Äî SISTEMA COMPLETO (H√°bitos + Problemas + Colectivos)
// =====================================================================

// ‚îÄ‚îÄ Estado global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let vrelas_activa = false;
let vrelas_paginaVotoUrl = null; // URL blob de la p√°gina de voto autocontenida
let vrelas_sessionId = null;
let vrelas_listener = null;
let vrelas_votosActo = [];          // votos recogidos en el acto (Firebase)
let vrelas_presentacionInterval = null; // para actualizar la pantalla en vivo

// ‚îÄ‚îÄ Diccionarios (alias de los RELAS existentes) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const VRELAS_HABITOS   = { 1:'Alimentaci√≥n Saludable', 2:'Actividad f√≠sica', 3:'Bienestar emocional', 4:'Sexualidad responsable', 5:'Uso positivo de las TRICs', 6:'Otras' };
const VRELAS_PROBLEMAS = { 1:'Adicciones con sustancias', 2:'Adicciones sin sustancias', 3:'Enfermedades cr√≥nicas', 4:'ITS y problemas sexuales', 5:'Malestar emocional', 6:'TCA', 7:'Trastornos del sue√±o', 8:'Otros' };
const VRELAS_COLECTIVOS= { 1:'Madres/Padres', 2:'J√≥venes', 3:'Personas mayores +65', 4:'Personas cuidadoras', 5:'Colectivos ciudadanos', 6:'Otros' };

const VRELAS_ICONOS_HAB = { 1:'ü•ó', 2:'üèÉ', 3:'üòä', 4:'‚ù§Ô∏è', 5:'üì±', 6:'‚ûï' };
const VRELAS_ICONOS_PROB= { 1:'üö¨', 2:'üìµ', 3:'üíä', 4:'ü©∫', 5:'üò∞', 6:'üçΩÔ∏è', 7:'üò¥', 8:'‚ûï' };
const VRELAS_ICONOS_COL = { 1:'üë®‚Äçüë©‚Äçüëß', 2:'üßí', 3:'üë¥', 4:'ü§≤', 5:'üë•', 6:'‚ûï' };

// ‚îÄ‚îÄ Nueva dimensi√≥n √∫nica: √Åreas de salud para la votaci√≥n ciudadana ‚îÄ‚îÄ‚îÄ‚îÄ
const VRELAS_TEMAS = {
  1:'Alimentaci√≥n', 2:'Actividad f√≠sica', 3:'Bienestar emocional y salud mental',
  4:'Uso de pantallas y redes sociales', 5:'Sue√±o y descanso',
  6:'Tabaco, vapeadores, alcohol y otras drogas', 7:'Sexualidad y salud',
  8:'Violencia de g√©nero', 9:'Medioambiente y municipio',
  10:'Accidentes en el hogar y la v√≠a p√∫blica'
};
const VRELAS_ICONOS_TEMAS = {
  1:'ü•ó', 2:'üèÉ', 3:'üß†', 4:'üì±', 5:'üò¥', 6:'üö¨', 7:'‚ù§Ô∏è', 8:'‚úä', 9:'üåø', 10:'‚ö†Ô∏è'
};
const VRELAS_COLORES_TEMAS = {
  1:  { bg:'#f0fdf4', border:'#86efac', acc:'#166534' },
  2:  { bg:'#eff6ff', border:'#93c5fd', acc:'#1d4ed8' },
  3:  { bg:'#fdf4ff', border:'#d8b4fe', acc:'#6b21a8' },
  4:  { bg:'#fff7ed', border:'#fdba74', acc:'#c2410c' },
  5:  { bg:'#f0f9ff', border:'#7dd3fc', acc:'#0369a1' },
  6:  { bg:'#fef2f2', border:'#fca5a5', acc:'#991b1b' },
  7:  { bg:'#fff1f2', border:'#fda4af', acc:'#be123c' },
  8:  { bg:'#fdf2f8', border:'#f0abfc', acc:'#86198f' },
  9:  { bg:'#f0fdf4', border:'#4ade80', acc:'#15803d' },
  10: { bg:'#fefce8', border:'#fde047', acc:'#a16207' }
};

// ‚îÄ‚îÄ Iniciar sesi√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_iniciarSesion() {
    const municipio = getMunicipioActual();
    if (!municipio) { alert('Seleccione primero un municipio'); return; }

    vrelas_activa = true;
    vrelas_sessionId = Date.now().toString(36) + Math.random().toString(36).substr(2,5);
    vrelas_votosActo = [];

    // Guardar sesi√≥n en localStorage
    localStorage.setItem('vrelas_session', JSON.stringify({
        sessionId: vrelas_sessionId, municipio, inicio: Date.now()
    }));

    // Actualizar UI botones
    const btnIniciar = document.getElementById('vrelas-btn-iniciar');
    const btnDetener = document.getElementById('vrelas-btn-detener');
    const btnVotar   = document.getElementById('vrelas-btn-votar');
    const btnManual  = document.getElementById('vrelas-btn-manual');
    if (btnIniciar) btnIniciar.disabled = true;
    [btnDetener, btnVotar, btnManual].forEach(b => { if(b){b.disabled=false;b.style.opacity='1';} });

    // Estado
    const dot = document.getElementById('vrelas-estado-dot');
    const txt = document.getElementById('vrelas-estado-txt');
    const est = document.getElementById('vrelas-estado');
    if (dot) dot.style.background = '#10b981';
    if (txt) txt.textContent = 'Sesi√≥n activa ¬∑ ' + vrelas_sessionId;
    if (est) { est.style.background = '#ecfdf5'; est.style.color = '#065f46'; }
    document.getElementById('vrelas-stat-ahora').textContent = 'üî¥';

    // P√°gina de voto autocontenida ‚Äî se abre en nueva pesta√±a y escribe en Firebase
    const paginaVoto = vrelas_generarPaginaVoto(municipio, vrelas_sessionId);
    const blob = new Blob([paginaVoto], { type: 'text/html;charset=utf-8' });
    const surveyUrl = URL.createObjectURL(blob);
    vrelas_paginaVotoUrl = surveyUrl; // guardar para copiar

    const urlEl = document.getElementById('vrelas-url');
    if (urlEl) urlEl.innerHTML = '<span style="color:#64748b;font-size:.72rem;">‚ö†Ô∏è Enlace local (v√°lido en este dispositivo). Comparte abriendo la p√°gina y copiando la URL desde el navegador, o usa <strong>Votar desde aqu√≠</strong> para votaci√≥n en pantalla t√°ctil.</span>';

    const btnCopiar = document.getElementById('vrelas-btn-copiar');
    if (btnCopiar) {
        btnCopiar.style.display = 'block';
        btnCopiar.textContent = 'üîó Abrir p√°gina de votaci√≥n';
        btnCopiar.onclick = function() { window.open(surveyUrl, '_blank'); };
    }

    // QR apunta a la misma URL del blob
    const qrDiv = document.getElementById('vrelas-qr');
    if (qrDiv && typeof QRCode !== 'undefined') {
        qrDiv.innerHTML = '';
        new QRCode(qrDiv, { text: surveyUrl, width: 160, height: 160, colorDark: '#0074c8', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
    } else if (qrDiv) {
        const abrirBtn = document.createElement('button');
        abrirBtn.textContent = 'üîó Abrir formulario';
        abrirBtn.style.cssText = 'padding:.4rem .8rem;background:#0074c8;color:white;border:none;border-radius:6px;font-size:.75rem;cursor:pointer;';
        abrirBtn.onclick = function() { window.open(vrelas_paginaVotoUrl, '_blank'); };
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'width:160px;height:160px;background:#e0f2fe;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.5rem;padding:.5rem;box-sizing:border-box;';
        wrapper.innerHTML = '<span style="font-size:2rem;">üîó</span>';
        wrapper.appendChild(abrirBtn);
        qrDiv.innerHTML = '';
        qrDiv.appendChild(wrapper);
    }

    // Escuchar Firebase
    if (vrelas_listener) vrelas_listener.off();
    vrelas_listener = db.ref('votaciones_relas/' + municipio + '/' + vrelas_sessionId + '/respuestas');
    vrelas_listener.on('child_added', function(snap) {
        const voto = snap.val();
        if (!vrelas_votosActo.find(v => v.id === voto.id)) {
            vrelas_votosActo.push(voto);
            vrelas_actualizarFeed(voto);
            vrelas_actualizarResultados();
            vrelas_actualizarPresentacionEnVivo();
        }
    });
}

// ‚îÄ‚îÄ Detener sesi√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_detenerSesion() {
    vrelas_activa = false;
    const municipio = getMunicipioActual();
    if (vrelas_listener) {
        db.ref('votaciones_relas/' + municipio + '/' + vrelas_sessionId + '/respuestas').off();
        vrelas_listener = null;
    }
    const btnIniciar = document.getElementById('vrelas-btn-iniciar');
    const btnDetener = document.getElementById('vrelas-btn-detener');
    const btnVotar   = document.getElementById('vrelas-btn-votar');
    const btnManual  = document.getElementById('vrelas-btn-manual');
    if (btnIniciar) btnIniciar.disabled = false;
    [btnDetener, btnVotar, btnManual].forEach(b => { if(b){b.disabled=true;b.style.opacity='.5';} });
    const dot = document.getElementById('vrelas-estado-dot');
    const txt = document.getElementById('vrelas-estado-txt');
    const est = document.getElementById('vrelas-estado');
    if (dot) dot.style.background = '#94a3b8';
    if (txt) txt.textContent = 'Sesi√≥n cerrada ¬∑ ' + vrelas_votosActo.length + ' votos en el acto';
    if (est) { est.style.background = '#f1f5f9'; est.style.color = '#64748b'; }
    document.getElementById('vrelas-stat-ahora').textContent = '‚èπÔ∏è';
}

// ‚îÄ‚îÄ Reiniciar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_reiniciar() {
    if (!confirm('¬øReiniciar la sesi√≥n de votaci√≥n? Se perder√°n los votos del acto (los previos del CSV se conservan).')) return;
    vrelas_detenerSesion();
    const municipio = getMunicipioActual();
    if (vrelas_sessionId && municipio && typeof db !== 'undefined') {
        db.ref('votaciones_relas/' + municipio + '/' + vrelas_sessionId).remove();
    }
    vrelas_votosActo = [];
    vrelas_sessionId = null;
    vrelas_actualizarResultados();
    const qrDiv = document.getElementById('vrelas-qr');
    if (qrDiv) qrDiv.innerHTML = '<div style="width:160px;height:160px;background:#f1f5f9;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:2.5rem;">üì±</div>';
    const urlEl = document.getElementById('vrelas-url');
    if (urlEl) urlEl.textContent = 'El enlace aparecer√° aqu√≠';
    document.getElementById('vrelas-feed').innerHTML = '<div style="text-align:center;color:#94a3b8;font-size:.8rem;padding:.5rem;">Esperando votos...</div>';
}

// ‚îÄ‚îÄ Simular votos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_simular() {
    const municipio = getMunicipioActual();
    // Pesos aproximados por tema (1..10): alimentaci√≥n, actividad, emocional, pantallas, sue√±o, drogas, sexualidad, violencia, medioambiente, accidentes
    const pesoTemas = [22, 20, 18, 14, 16, 15, 12, 10, 11, 8];

    const pickTemas = function() {
        const scored = pesoTemas.map(function(p, i){ return { k: i+1, s: Math.random() * p }; });
        scored.sort(function(a,b){ return b.s - a.s; });
        const n = 1 + Math.floor(Math.random() * 5);
        return scored.slice(0, n).map(function(x){ return x.k; });
    };

    for (var i = 0; i < 50; i++) {
        var voto = {
            id: Date.now().toString(36) + i + Math.random().toString(36).substr(2,3),
            ts: Date.now(), fuente: 'acto',
            temas: pickTemas()
        };
        vrelas_votosActo.push(voto);
        vrelas_actualizarFeed(voto);
        if (typeof db !== 'undefined' && vrelas_activa && vrelas_sessionId) {
            db.ref('votaciones_relas/' + municipio + '/' + vrelas_sessionId + '/respuestas').push(voto);
        }
    }
    vrelas_actualizarResultados();
    vrelas_actualizarPresentacionEnVivo();
    mostrarNotificacion({ title: 'üß™ Simulaci√≥n completada', message: '50 votos generados', type: 'success', duration: 2500 });
}

// ‚îÄ‚îÄ Copiar enlace ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_copiarEnlace() {
    const btn = document.getElementById('vrelas-btn-copiar');
    const url = btn && btn._url;
    if (url) { navigator.clipboard.writeText(url).catch(()=>{}); mostrarNotificacion({title:'Enlace copiado',type:'success',duration:2000}); }
}

// ‚îÄ‚îÄ Combinar votos CSV + acto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_obtenerVotosCombinados() {
    const previos = [];
    // Leer de relas_globalData si hay datos cargados
    if (relas_globalData && relas_globalData._n > 0 && relas_globalData.records) {
        relas_globalData.records.forEach(function(r) {
            const hab=[], prob=[], col=[];
            for(let i=1;i<=6;i++) if(r['habitos_vida___'+i]==='1') hab.push(i);
            for(let i=1;i<=8;i++) if(r['problemas_salud___'+i]==='1') prob.push(i);
            for(let i=1;i<=6;i++) if(r['colectivos___'+i]==='1') col.push(i);
            previos.push({ fuente:'csv', habitos_vida:hab, problemas_salud:prob, colectivos:col });
        });
    }
    return previos.concat(vrelas_votosActo);
}

// ‚îÄ‚îÄ Actualizar resultados en panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// instancias Chart para el tab ciudadano
var _vrelasCharts = {};
function _vrelasDC(id) { if (_vrelasCharts[id]) { _vrelasCharts[id].destroy(); delete _vrelasCharts[id]; } }

function vrelas_actualizarResultados() {
    const todos = vrelas_obtenerVotosCombinados();
    const previos = todos.filter(function(v){return v.fuente==='csv';}).length;
    const acto    = todos.filter(function(v){return v.fuente!=='csv';}).length;

    var stTotal   = document.getElementById('vrelas-stat-total');
    var stPrevios = document.getElementById('vrelas-stat-previos');
    var stActo    = document.getElementById('vrelas-stat-acto');
    if (stTotal)   stTotal.textContent   = todos.length;
    if (stPrevios) stPrevios.textContent = previos;
    if (stActo)    stActo.textContent    = acto;

    if (!todos.length) return;

    // ‚îÄ‚îÄ frecuencias por tema ‚îÄ‚îÄ
    var freq = {};
    for (var i=1;i<=10;i++) freq[i]=0;
    todos.forEach(function(v){ (v.temas||[]).forEach(function(k){ freq[k]=(freq[k]||0)+1; }); });

    // ‚îÄ‚îÄ distribuci√≥n n¬∫ selecciones ‚îÄ‚îÄ
    var dist = {1:0,2:0,3:0,4:0,5:0};
    todos.forEach(function(v){ var n=(v.temas||[]).length; if(n>=1&&n<=5) dist[n]++; });

    // colores por tema
    var bgColors = [
        'rgba(134,239,172,.8)','rgba(147,197,253,.8)','rgba(216,180,254,.8)',
        'rgba(253,186,116,.8)','rgba(125,211,252,.8)','rgba(252,165,165,.8)',
        'rgba(253,164,175,.8)','rgba(240,171,252,.8)','rgba(74,222,128,.8)',
        'rgba(253,224,71,.8)'
    ];
    var borderColors = [
        '#166534','#1d4ed8','#6b21a8','#c2410c','#0369a1',
        '#991b1b','#be123c','#86198f','#15803d','#a16207'
    ];

    var labels  = Object.values(VRELAS_TEMAS);
    var iconos  = Object.values(VRELAS_ICONOS_TEMAS);
    var labelsCortos = labels.map(function(l){ return l.length>18 ? l.substr(0,16)+'‚Ä¶' : l; });
    var dataVals = Object.values(freq);
    var n = todos.length;

    // ‚îÄ‚îÄ 1. Barra horizontal ranking ‚îÄ‚îÄ
    var cBar = document.getElementById('vrelas-chartBar');
    var emptyBar = document.getElementById('vrelas-res-temas');
    if (cBar) {
        cBar.style.display = 'block';
        if (emptyBar) emptyBar.style.display = 'none';
        _vrelasDC('bar');
        var idx = dataVals.map(function(_,i){return i;}).sort(function(a,b){return dataVals[b]-dataVals[a];});
        _vrelasCharts['bar'] = new Chart(cBar, {
            type: 'bar',
            data: {
                labels: idx.map(function(i){ return iconos[i]+' '+labelsCortos[i]; }),
                datasets: [{
                    label: 'Votos',
                    data: idx.map(function(i){ return dataVals[i]; }),
                    backgroundColor: idx.map(function(i){ return bgColors[i]; }),
                    borderColor:     idx.map(function(i){ return borderColors[i]; }),
                    borderWidth: 1.5,
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: function(c){ return ' '+c.raw+' votos ('+(n?Math.round(c.raw/n*100):0)+'%)'; }}}
                },
                scales: {
                    x: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { color: 'rgba(0,0,0,.05)' } },
                    y: { ticks: { font: { size: 11 } } }
                }
            }
        });
        _vrelasCharts['bar'].resize(cBar.parentElement.offsetWidth || 600, 300);
    }

    // ‚îÄ‚îÄ 2. Radar ‚îÄ‚îÄ
    var cRadar = document.getElementById('vrelas-chartRadarCiu');
    var emptyRadar = document.getElementById('vrelas-radar-empty');
    if (cRadar) {
        cRadar.style.display = 'block';
        if (emptyRadar) emptyRadar.style.display = 'none';
        _vrelasDC('radar');
        _vrelasCharts['radar'] = new Chart(cRadar, {
            type: 'radar',
            data: {
                labels: labels.map(function(l){ return l.length>14 ? l.substr(0,12)+'‚Ä¶' : l; }),
                datasets: [{
                    label: 'Votos',
                    data: dataVals,
                    backgroundColor: 'rgba(0,116,200,.15)',
                    borderColor: '#0074c8',
                    borderWidth: 2,
                    pointBackgroundColor: borderColors,
                    pointBorderColor: '#fff',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    r: {
                        beginAtZero: true,
                        ticks: { stepSize: 1, font: { size: 9 } },
                        pointLabels: { font: { size: 10 } }
                    }
                }
            }
        });
        _vrelasCharts['radar'].resize(cRadar.parentElement.offsetWidth || 400, 300);
    }

    // ‚îÄ‚îÄ 3. Distribuci√≥n n¬∫ selecciones ‚îÄ‚îÄ
    var cDist = document.getElementById('vrelas-chartDist');
    var emptyDist = document.getElementById('vrelas-dist-empty');
    if (cDist) {
        cDist.style.display = 'block';
        if (emptyDist) emptyDist.style.display = 'none';
        _vrelasDC('dist');
        _vrelasCharts['dist'] = new Chart(cDist, {
            type: 'bar',
            data: {
                labels: ['1 tema','2 temas','3 temas','4 temas','5 temas'],
                datasets: [{
                    label: 'Votantes',
                    data: [dist[1],dist[2],dist[3],dist[4],dist[5]],
                    backgroundColor: [
                        'rgba(0,172,217,.7)','rgba(0,116,200,.7)','rgba(124,58,237,.7)',
                        'rgba(5,150,105,.7)','rgba(234,88,12,.7)'
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: function(c){ return ' '+c.raw+' votantes ('+(n?Math.round(c.raw/n*100):0)+'%)'; }}}
                },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } },
                    x: { grid: { display: false } }
                }
            }
        });
        _vrelasCharts['dist'].resize(cDist.parentElement.offsetWidth || 400, 280);
    }

    // ‚îÄ‚îÄ P√°rrafos interpretativos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var sorted = Object.entries(freq).sort(function(a,b){return b[1]-a[1];});
    var top1  = sorted[0], top2 = sorted[1], top3 = sorted[2];
    var last1 = sorted[sorted.length-1];
    var top1pct  = top1  ? Math.round(top1[1]/n*100)  : 0;
    var top3pct  = top3  ? Math.round(top3[1]/n*100)  : 0;
    var last1pct = last1 ? Math.round(last1[1]/n*100) : 0;

    // Concentraci√≥n: cu√°ntos temas acumulan el 50% de todos los votos
    var totalVotos = sorted.reduce(function(s,e){return s+e[1];}, 0);
    var acum = 0; var temAs50 = 0;
    for (var si=0; si<sorted.length; si++) {
        acum += sorted[si][1]; temAs50++;
        if (acum >= totalVotos * 0.5) break;
    }

    // Media de temas por votante
    var totalSel = todos.reduce(function(s,v){return s+(v.temas||[]).length;}, 0);
    var mediaSel = n ? (totalSel/n).toFixed(1) : 0;

    // Texto ranking
    var pBar = document.getElementById('vrelas-txt-bar');
    if (pBar && top1) {
        var txt = '<strong>' + VRELAS_ICONOS_TEMAS[top1[0]] + ' ' + VRELAS_TEMAS[top1[0]] + '</strong> lidera la demanda ciudadana';
        if (top1pct >= 60) txt += ', con una mayor√≠a muy clara (' + top1pct + '% de participantes lo se√±alaron).';
        else if (top1pct >= 40) txt += ' con respaldo amplio (' + top1pct + '% de participantes).';
        else txt += ', aunque sin consenso dominante (' + top1pct + '%), lo que indica una ciudadan√≠a con preocupaciones diversas.';
        if (top2 && top3) txt += ' Le siguen <strong>' + VRELAS_TEMAS[top2[0]] + '</strong> y <strong>' + VRELAS_TEMAS[top3[0]] + '</strong>';
        if (temAs50 <= 3) txt += '. La demanda est√° <strong>concentrada</strong>: ' + temAs50 + ' temas re√∫nen la mitad de todas las selecciones, lo que facilita priorizar intervenciones.';
        else txt += '. La demanda es <strong>diversa</strong>: se necesitan ' + temAs50 + ' temas para alcanzar la mitad de las selecciones, lo que sugiere atender varios frentes de forma simult√°nea.';
        if (last1 && last1pct <= 10) txt += ' El tema <strong>' + VRELAS_TEMAS[last1[0]] + '</strong> recibi√≥ menor atenci√≥n (' + last1pct + '%), aunque puede ser relevante para colectivos espec√≠ficos.';
        pBar.textContent = '';
        pBar.innerHTML = txt;
        pBar.style.display = 'block';
    }

    // Texto radar
    var pRadar = document.getElementById('vrelas-txt-radar');
    if (pRadar) {
        var maxV2 = sorted[0] ? sorted[0][1] : 1;
        var minV2 = sorted[sorted.length-1] ? sorted[sorted.length-1][1] : 0;
        var rango = maxV2 - minV2;
        var txtR;
        if (rango <= maxV2 * 0.25) txtR = 'La figura del radar muestra un <strong>perfil equilibrado</strong>: ning√∫n tema destaca ni queda muy rezagado respecto al resto. Esto refleja una ciudadan√≠a con preocupaciones distribuidas o una muestra todav√≠a peque√±a que se ir√° definiendo con m√°s votos.';
        else if (rango <= maxV2 * 0.55) txtR = 'El radar presenta un <strong>perfil moderadamente asim√©trico</strong>: hay temas que sobresalen con claridad pero el inter√©s ciudadano se extiende a varios √°mbitos. Conviene plantear una estrategia que refuerce los ejes m√°s demandados sin descuidar los secundarios.';
        else txtR = 'El radar muestra un <strong>perfil muy asim√©trico</strong>: la demanda ciudadana se concentra en pocos v√©rtices mientras otros quedan casi planos. Esta se√±al es √∫til para focalizar recursos, aunque merece contraste con el diagn√≥stico epidemiol√≥gico antes de descartar los temas menos votados.';
        pRadar.innerHTML = txtR;
        pRadar.style.display = 'block';
    }

    // Texto distribuci√≥n
    var pDist = document.getElementById('vrelas-txt-dist');
    if (pDist) {
        var pct5 = n ? Math.round((dist[5]||0)/n*100) : 0;
        var pct1 = n ? Math.round((dist[1]||0)/n*100) : 0;
        var txtD = 'Cada participante eligi√≥ de media <strong>' + mediaSel + ' temas</strong>. ';
        if (parseFloat(mediaSel) >= 4) txtD += 'La tendencia a usar casi todas las selecciones disponibles indica que la ciudadan√≠a percibe <strong>m√∫ltiples necesidades simult√°neas</strong>: puede ser √∫til explorar si hay un perfil de preocupaci√≥n transversal.';
        else if (parseFloat(mediaSel) >= 2.5) txtD += 'El uso moderado de las selecciones disponibles sugiere que la ciudadan√≠a tiene <strong>prioridades definidas</strong> aunque reconoce m√°s de un √°mbito de actuaci√≥n.';
        else txtD += 'El uso bajo de las selecciones disponibles indica <strong>preferencias muy focalizadas</strong>: los participantes tienden a se√±alar un √∫nico tema prioritario, lo que simplifica la toma de decisiones.';
        if (pct5 >= 30) txtD += ' Un ' + pct5 + '% eligi√≥ los 5 temas permitidos, lo que podr√≠a reflejar saturaci√≥n del instrumento o bien una percepci√≥n generalizada de que todos los temas son urgentes.';
        if (pct1 >= 30) txtD += ' Un ' + pct1 + '% eligi√≥ un solo tema, se√±al de prioridades muy claras en ese grupo de participantes.';
        pDist.innerHTML = txtD;
        pDist.style.display = 'block';
    }
}

function vrelas_renderMiniRanking(containerId, votos, campo, labels, iconos, color) {
    // Mantenida por compatibilidad, ya no se usa activamente
    var el = document.getElementById(containerId);
    if (!el) return;
}

// ‚îÄ‚îÄ Feed en vivo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_actualizarFeed(voto) {
    var feed = document.getElementById('vrelas-feed');
    if (!feed) return;
    var temas = (voto.temas||[]).map(function(k){ return VRELAS_ICONOS_TEMAS[k]||''; }).join(' ');
    var div = document.createElement('div');
    div.style.cssText = 'font-size:.72rem;padding:.25rem .4rem;background:#f0f9ff;border-radius:4px;display:flex;gap:.4rem;align-items:center;';
    div.innerHTML = '<span style="color:#0074c8;letter-spacing:.1em;">'+temas+'</span><span style="color:#94a3b8;margin-left:auto">'+new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit',second:'2-digit'})+'</span>';
    feed.insertBefore(div, feed.firstChild);
    while (feed.children.length > 8) feed.removeChild(feed.lastChild);
}

// ‚îÄ‚îÄ Conexi√≥n con la pantalla de presentaci√≥n en vivo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_conectarPresentacion() {
    // Cuando la presentaci√≥n est√° abierta y hay sesi√≥n activa, actualiza cada vez que llegue un voto
    // (ya se llama vrelas_actualizarPresentacionEnVivo desde el listener de Firebase)
}

function vrelas_actualizarPresentacionEnVivo() {
    const overlay = document.getElementById('relas-presentacion-overlay');
    if (!overlay || overlay.style.display === 'none') return;

    const todos = vrelas_obtenerVotosCombinados();
    if (!todos.length) return;

    const temasFreq = {};
    for(let i=1;i<=10;i++) temasFreq[i]=0;
    todos.forEach(function(v) {
        (v.temas||[]).forEach(function(k){ temasFreq[k]=(temasFreq[k]||0)+1; });
    });

    const badge = document.getElementById('relas-pres-badge-n');
    if (badge) badge.textContent = todos.length + ' participante' + (todos.length!==1?'s':'');

    const info = document.getElementById('relas-pres-info');
    if (info) info.textContent = 'N = ' + todos.length + ' ¬∑ üî¥ En vivo ¬∑ ' + new Date().toLocaleTimeString('es');

    relas_globalData = { _temasFreq: temasFreq, _habFreq: temasFreq, _n: todos.length };
    relas_renderPodio();
}

// ‚îÄ‚îÄ Votar desde aqu√≠ (pantalla t√°ctil) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_votarAhora() {
    if (!vrelas_activa || !vrelas_sessionId) { alert('Inicie primero una sesi√≥n'); return; }
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);

    const html = '<div id="vrelas-modal-voto" style="position:fixed;inset:0;z-index:100002;background:#f1f5f9;overflow-y:auto;font-family:system-ui,sans-serif;">' +
        '<div style="max-width:600px;margin:0 auto;padding:2rem;">' +
        '<div style="text-align:center;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:3px solid #0074c8;">' +
        '<h1 style="color:#0074c8;font-size:2rem;margin:0 0 .5rem;">üó≥Ô∏è Votaci√≥n Popular</h1>' +
        '<p style="color:#64748b;margin:0;">Plan Local de Salud ¬∑ ' + nombre + '</p></div>' +
        vrelas_buildForm() +
        '<div style="display:flex;gap:1rem;margin-top:1.5rem;">' +
        '<button onclick="document.getElementById(\'vrelas-modal-voto\').remove()" style="flex:1;padding:1rem;background:#f1f5f9;color:#475569;border:1px solid #cbd5e1;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;">‚ùå Cerrar</button>' +
        '<button onclick="vrelas_enviarVoto(\''+municipio+'\')" style="flex:2;padding:1rem;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-size:1.1rem;font-weight:700;cursor:pointer;">‚úÖ Enviar voto</button>' +
        '</div></div></div>';

    const el = document.createElement('div');
    el.innerHTML = html;
    document.body.appendChild(el.firstElementChild);
}

function vrelas_buildForm() {
    const tarjetas = Object.entries(VRELAS_TEMAS).map(function(entry) {
        const k = entry[0], label = entry[1];
        const ic  = VRELAS_ICONOS_TEMAS[k] || '‚Ä¢';
        const col = VRELAS_COLORES_TEMAS[k] || { bg:'#f8fafc', border:'#e2e8f0', acc:'#334155' };
        return '<label id="lbl-t-' + k + '" style="' +
            'display:flex;flex-direction:column;align-items:center;justify-content:center;' +
            'gap:.45rem;padding:1rem .5rem;border:2.5px solid ' + col.border + ';' +
            'border-radius:14px;cursor:pointer;transition:all .18s;background:' + col.bg + ';' +
            'text-align:center;position:relative;user-select:none;">' +
            '<input type="checkbox" class="vrelas-cb-t" value="' + k + '" ' +
              'onchange="vrelas_limitarCB(\'vrelas-cb-t\',5);vrelas_estiloTema(document.getElementById(\'lbl-t-'+k+'\'),\''+k+'\')" ' +
              'style="position:absolute;top:.45rem;right:.45rem;width:16px;height:16px;accent-color:' + col.acc + ';cursor:pointer;">' +
            '<span style="font-size:2.2rem;line-height:1;pointer-events:none;">' + ic + '</span>' +
            '<span style="font-size:.76rem;font-weight:700;color:' + col.acc + ';line-height:1.3;pointer-events:none;">' + label + '</span>' +
            '</label>';
    }).join('');

    return '<div style="margin-bottom:1.5rem;">' +
        '<p style="font-weight:700;font-size:1.05rem;margin-bottom:.35rem;color:#1e293b;">' +
        '¬øSobre qu√© temas de salud deber√≠a actuar tu Ayuntamiento?</p>' +
        '<p style="font-size:.82rem;color:#64748b;margin-bottom:1rem;">' +
        'Elige hasta <strong>5 temas</strong> que consideres m√°s importantes</p>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.6rem;">' +
        tarjetas + '</div></div>';
}

function vrelas_estiloTema(el, k) {
    const cb  = el ? el.querySelector('input[type=checkbox]') : null;
    const col = VRELAS_COLORES_TEMAS[k] || { border:'#e2e8f0', acc:'#334155' };
    if (!el) return;
    if (cb && cb.checked) {
        el.style.borderColor = col.acc;
        el.style.boxShadow   = '0 0 0 3px ' + col.border;
        el.style.transform   = 'scale(1.04)';
    } else {
        el.style.borderColor = col.border;
        el.style.boxShadow   = 'none';
        el.style.transform   = 'scale(1)';
    }
}

function vrelas_limitarCB(cls, max) {
    const checked = document.querySelectorAll('.' + cls + ':checked');
    if (checked.length >= max) {
        document.querySelectorAll('.' + cls + ':not(:checked)').forEach(function(cb) {
            cb.disabled = true;
            const lbl = cb.closest('label');
            if (lbl) { lbl.style.opacity = '.45'; lbl.style.cursor = 'not-allowed'; }
        });
    } else {
        document.querySelectorAll('.' + cls).forEach(function(cb) {
            cb.disabled = false;
            const lbl = cb.closest('label');
            if (lbl) { lbl.style.opacity = '1'; lbl.style.cursor = 'pointer'; }
        });
    }
}

function vrelas_enviarVoto(municipio) {
    const temas = Array.from(document.querySelectorAll('.vrelas-cb-t:checked')).map(function(cb){return parseInt(cb.value);});
    if (!temas.length) { alert('Selecciona al menos un tema'); return; }
    const voto = {
        id: Date.now().toString(36)+Math.random().toString(36).substr(2,4),
        ts: Date.now(), fuente:'acto',
        temas: temas
    };
    db.ref('votaciones_relas/' + municipio + '/' + vrelas_sessionId + '/respuestas').push(voto)
        .then(function() {
            const modal = document.getElementById('vrelas-modal-voto');
            if (modal) {
                modal.innerHTML = '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0074c8,#00acd9);">' +
                    '<div style="text-align:center;color:white;"><div style="font-size:5rem;">‚úÖ</div>' +
                    '<h1 style="font-size:2.5rem;margin:.5rem 0;font-weight:800;">¬°Gracias por votar!</h1>' +
                    '<p style="font-size:1.2rem;opacity:.9">Tu opini√≥n es muy importante</p></div></div>';
                setTimeout(function(){ if(modal.parentNode) modal.parentNode.removeChild(modal); }, 2500);
            }
        })
        .catch(function(e){ console.error('Error guardando voto RELAS:', e); alert('Error al enviar. Int√©ntalo de nuevo.'); });
}

// ‚îÄ‚îÄ Voto manual ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_votoManual() {
    // El t√©cnico puede a√±adir votos en nombre del ciudadano, con o sin sesi√≥n Firebase activa
    const municipio = getMunicipioActual();
    const nombre = getNombreMunicipio(municipio);

    const html = '<div id="vrelas-modal-voto" style="position:fixed;inset:0;z-index:100002;background:#f1f5f9;overflow-y:auto;font-family:system-ui,sans-serif;">' +
        '<div style="max-width:600px;margin:0 auto;padding:2rem;">' +
        '<div style="text-align:center;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:3px solid #f59e0b;">' +
        '<h1 style="color:#f59e0b;font-size:2rem;margin:0 0 .5rem;">‚úçÔ∏è Voto manual</h1>' +
        '<p style="color:#64748b;margin:0;">Introduce el voto en nombre del ciudadano ¬∑ ' + nombre + '</p></div>' +
        vrelas_buildForm() +
        '<div style="display:flex;gap:1rem;margin-top:1.5rem;">' +
        '<button onclick="document.getElementById(\'vrelas-modal-voto\').remove()" style="flex:1;padding:1rem;background:#f1f5f9;color:#475569;border:1px solid #cbd5e1;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;">‚ùå Cancelar</button>' +
        '<button onclick="vrelas_enviarVotoManual(\''+municipio+'\')" style="flex:2;padding:1rem;background:linear-gradient(135deg,#f59e0b,#d97706);color:white;border:none;border-radius:8px;font-size:1.1rem;font-weight:700;cursor:pointer;">‚úÖ Registrar voto</button>' +
        '</div></div></div>';

    const el = document.createElement('div');
    el.innerHTML = html;
    document.body.appendChild(el.firstElementChild);
}

function vrelas_enviarVotoManual(municipio) {
    const temas = Array.from(document.querySelectorAll('.vrelas-cb-t:checked')).map(function(cb){return parseInt(cb.value);});
    if (!temas.length) { alert('Selecciona al menos un tema'); return; }
    const voto = {
        id: Date.now().toString(36) + Math.random().toString(36).substr(2,4),
        ts: Date.now(), fuente: 'manual',
        temas: temas
    };
    // Siempre al array local
    vrelas_votosActo.push(voto);
    vrelas_actualizarFeed(voto);
    // A Firebase solo si hay sesi√≥n activa
    if (typeof db !== 'undefined' && vrelas_activa && vrelas_sessionId && municipio) {
        db.ref('votaciones_relas/' + municipio + '/' + vrelas_sessionId + '/respuestas').push(voto);
    }
    vrelas_actualizarResultados();
    vrelas_actualizarPresentacionEnVivo();
    const modal = document.getElementById('vrelas-modal-voto');
    if (modal) {
        modal.innerHTML = '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#f59e0b,#d97706);">' +
            '<div style="text-align:center;color:white;"><div style="font-size:5rem;">‚úÖ</div>' +
            '<h1 style="font-size:2rem;margin:.5rem 0;font-weight:800;">Voto registrado</h1></div></div>';
        setTimeout(function(){ if(modal.parentNode) modal.parentNode.removeChild(modal); }, 1800);
    }
}
function vrelas_generarFlyer() {
    const municipio = getMunicipioActual();
    const nombre = municipio ? getNombreMunicipio(municipio) : 'su municipio';
    const logoC = typeof LOGO_CONSEJERIA_B64 !== 'undefined' ? 'data:image/jpeg;base64,' + LOGO_CONSEJERIA_B64 : '';
    const logoD = typeof LOGO_DISTRITO_B64   !== 'undefined' ? 'data:image/png;base64,'  + LOGO_DISTRITO_B64  : '';

    const opciones = Object.entries(VRELAS_TEMAS).map(function(entry) {
        const k=entry[0], label=entry[1];
        const ic = VRELAS_ICONOS_TEMAS[k] || '';
        return '<div class="opcion">' +
            '<div class="opcion-check"></div>' +
            '<div class="opcion-icono">' + ic + '</div>' +
            '<div class="opcion-texto">' + label + '</div>' +
            '</div>';
    }).join('');

    const html = '<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Votaci√≥n ¬∑ ' + nombre + '</title>' +
        '<style>@page{size:A4;margin:12mm}' +
        'body{font-family:"Segoe UI",sans-serif;font-size:11pt;line-height:1.4;color:#1e293b;max-width:800px;margin:0 auto;padding:8px}' +
        '.header{display:flex;justify-content:space-between;align-items:center;border-bottom:4px solid #0074c8;padding-bottom:10px;margin-bottom:14px}.header img{height:48px}' +
        '.titulo{text-align:center;margin:12px 0}.titulo h1{color:#0074c8;font-size:20pt;margin:0;text-transform:uppercase;letter-spacing:1px}.titulo h2{color:#64748b;font-size:12pt;margin:6px 0;font-weight:normal}' +
        '.aviso{background:#f0f9ff;border-left:4px solid #0074c8;padding:9px 13px;margin:10px 0;border-radius:4px;font-size:10pt}' +
        '.pregunta-titulo{font-weight:700;font-size:12pt;color:#0f172a;margin:14px 0 10px;padding:8px 12px;background:#e0f2fe;border-radius:6px}' +
        '.opciones{display:grid;grid-template-columns:repeat(2,1fr);gap:7px}' +
        '.opcion{border:2px solid #cbd5e1;padding:9px 11px;border-radius:8px;display:flex;align-items:center;gap:10px;min-height:50px}' +
        '.opcion-check{width:22px;height:22px;border:2px solid #64748b;border-radius:4px;flex-shrink:0}' +
        '.opcion-icono{font-size:18pt;flex-shrink:0;line-height:1}.opcion-texto{flex:1;font-size:9.5pt;font-weight:500;color:#1e293b}' +
        '.footer{margin-top:18px;padding-top:10px;border-top:2px solid #e2e8f0;text-align:center;color:#64748b;font-size:8.5pt}' +
        '@media print{.no-print{display:none}}</style></head><body>' +
        '<div class="header">' + (logoC?'<img src="'+logoC+'" alt="">':'<div></div>') + (logoD?'<img src="'+logoD+'" alt="">':'<div></div>') + '</div>' +
        '<div class="titulo"><h1>üó≥Ô∏è Votaci√≥n Popular de Salud</h1><h2>Plan Local de Salud de ' + nombre + '</h2></div>' +
        '<div class="aviso">üìã <strong>Instrucciones:</strong> Marque hasta <strong>5 temas</strong> que considere m√°s importantes. Deposite el formulario en el buz√≥n habilitado o entr√©guelo al t√©cnico.</div>' +
        '<div class="pregunta-titulo">üéØ ¬øSobre qu√© temas de salud deber√≠a actuar tu Ayuntamiento? <em style="font-weight:400;font-size:9pt;">(Elige hasta 5)</em></div>' +
        '<div class="opciones">' + opciones + '</div>' +
        '<div class="footer">Plan Local de Salud de ' + nombre + ' ¬∑ COMP√ÅS ¬∑ Servicio Andaluz de Salud</div>' +
        '<div class="no-print" style="text-align:center;margin-top:1rem;"><button onclick="window.print()" style="padding:.75rem 2rem;background:#0074c8;color:white;border:none;border-radius:8px;font-size:1rem;cursor:pointer;">üñ®Ô∏è Imprimir</button></div>' +
        '</body></html>';

    const w = window.open('', '_blank');
    if (w) { w.document.write(html); w.document.close(); }
}

// ‚îÄ‚îÄ Exportar CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_exportarCSV() {
    const todos = vrelas_obtenerVotosCombinados();
    if (!todos.length) { alert('No hay datos para exportar'); return; }
    const municipio = getMunicipioActual() || 'municipio';
    let csv = '\uFEFF'; // BOM UTF-8
    csv += 'id;fuente;temas\n';
    todos.forEach(function(v, i) {
        csv += (v.id||i) + ';' + (v.fuente||'csv') + ';' +
            (v.temas||[]).join('|') + '\n';
    });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'VotacionRELAS_' + municipio + '_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
}

// ‚îÄ‚îÄ Incorporar al plan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_incorporarAlPlan() {
    const todos = vrelas_obtenerVotosCombinados();
    if (!todos.length) { alert('No hay datos de votaci√≥n'); return; }
    // Calcular frecuencias por tema
    const temasFreq = {};
    todos.forEach(function(v) {
        (v.temas||[]).forEach(function(k){ temasFreq[k]=(temasFreq[k]||0)+1; });
    });
    // Guardar como datosParticipacionCiudadana para fusi√≥n triple
    window.datosParticipacionCiudadana = {
        fuente: 'votacion_relas',
        n: todos.length,
        temasFreq: temasFreq,
        votos: Object.entries(temasFreq).sort(function(a,b){return b[1]-a[1];}).map(function(e){return { nombre: VRELAS_TEMAS[e[0]], votos: e[1] };})
    };
    // Guardar en Firebase
    const municipio = getMunicipioActual();
    if (municipio && typeof db !== 'undefined') {
        db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipio + '/votacionRelas')
          .set(window.datosParticipacionCiudadana);
    }
    mostrarNotificacion({title:'‚úÖ Resultados incorporados','message':'Los datos de votaci√≥n RELAS est√°n disponibles para la fusi√≥n triple.',type:'success',duration:3000});
}


// ‚îÄ‚îÄ Generar p√°gina de voto autocontenida ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function vrelas_generarPaginaVoto(municipio, sessionId) {
    const nombre = getNombreMunicipio(municipio);

    const dTemas = JSON.stringify(VRELAS_TEMAS);
    const dIT    = JSON.stringify(VRELAS_ICONOS_TEMAS);
    const dCols  = JSON.stringify(VRELAS_COLORES_TEMAS);
    const dMun   = JSON.stringify(municipio);
    const dSes   = JSON.stringify(sessionId);
    const fbConf = JSON.stringify({
        apiKey: "AIzaSyCdAivJATiX76xuOJAMc4Yt7sLq-3GDuDw",
        authDomain: "itaca-3ba7b.firebaseapp.com",
        databaseURL: "https://itaca-3ba7b-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "itaca-3ba7b"
    });
    const S = '<scr' + 'ipt';
    const ES = '</' + 'script>';

    const css = [
        '*{box-sizing:border-box;margin:0;padding:0}',
        'body{font-family:system-ui,sans-serif;background:#f1f5f9;min-height:100vh;padding:1rem}',
        '.wrap{max-width:640px;margin:0 auto}',
        '.cab{background:linear-gradient(135deg,#0074c8,#00acd9);color:white;border-radius:14px;padding:1.5rem;text-align:center;margin-bottom:1.2rem}',
        '.cab h1{font-size:1.6rem;font-weight:800;margin-bottom:.3rem}',
        '.cab p{opacity:.9;font-size:.9rem}',
        '.sec{background:white;border-radius:12px;padding:1.25rem;margin-bottom:1rem;border:1px solid #e2e8f0}',
        '.sec-tit{font-weight:700;font-size:1rem;color:#1e293b;margin-bottom:.25rem}',
        '.sec-sub{font-size:.82rem;color:#64748b;margin-bottom:1rem}',
        '.ops{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.55rem}',
        'label.op{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.4rem;padding:.9rem .5rem;border:2.5px solid #e2e8f0;border-radius:12px;cursor:pointer;transition:all .18s;text-align:center;position:relative;background:#f8fafc;user-select:none}',
        'label.op.sel{transform:scale(1.04)}',
        'label.op.dis{opacity:.4;cursor:not-allowed;transform:none}',
        'label.op input{position:absolute;top:.4rem;right:.4rem;width:15px;height:15px;cursor:pointer}',
        '.ic{font-size:2rem;line-height:1;pointer-events:none}',
        '.tx{font-size:.72rem;font-weight:700;line-height:1.3;pointer-events:none}',
        '.btn-ok{width:100%;padding:1.1rem;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:700;cursor:pointer;margin-top:1rem}',
        '.btn-ok:disabled{opacity:.5;cursor:not-allowed}',
        '.gracias{display:none;text-align:center;padding:3rem 1rem;background:white;border-radius:14px}',
        '.gracias .ck{font-size:5rem;margin-bottom:1rem}',
        '.gracias h2{color:#10b981;font-size:2rem;margin-bottom:.5rem}',
        '.gracias p{color:#64748b}',
        '.av{background:#fef9ee;border:1px solid #fcd34d;border-radius:8px;padding:.75rem 1rem;font-size:.82rem;color:#92400e;margin-bottom:1rem}'
    ].join('\n');

    const js = [
        'var T='+dTemas+';',
        'var IT='+dIT+';',
        'var CL='+dCols+';',
        'var MUN='+dMun+';',
        'var SES='+dSes+';',
        'firebase.initializeApp('+fbConf+');',
        'var db=firebase.database();',
        'function build(){',
        '  var el=document.getElementById("ops");',
        '  Object.entries(T).forEach(function(e){',
        '    var k=e[0],lbl=e[1],c=CL[k]||{bg:"#f8fafc",border:"#e2e8f0",acc:"#334155"};',
        '    var d=document.createElement("label");',
        '    d.className="op"; d.id="lbl"+k;',
        '    d.style.background=c.bg; d.style.borderColor=c.border;',
        '    d.innerHTML=\'<input type="checkbox" class="cb" value="\'+k+\'"><span class="ic">\'+( IT[k]||"")+\'</span><span class="tx" style="color:\'+c.acc+\'">\'+lbl+\'</span>\';',
        '    d.querySelector("input").addEventListener("change",function(){ lim(); sty(k,d,c); });',
        '    el.appendChild(d);',
        '  });',
        '}',
        'function lim(){',
        '  var cbs=document.querySelectorAll(".cb");',
        '  var n=Array.from(cbs).filter(function(c){return c.checked;}).length;',
        '  cbs.forEach(function(c){',
        '    var l=c.closest("label");',
        '    if(!c.checked&&n>=5){c.disabled=true;l.classList.add("dis");}',
        '    else{c.disabled=false;l.classList.remove("dis");}',
        '  });',
        '  document.getElementById("cnt").textContent=n+"/5 seleccionados";',
        '}',
        'function sty(k,d,c){',
        '  var cb=d.querySelector("input");',
        '  if(cb.checked){d.classList.add("sel");d.style.borderColor=c.acc;d.style.boxShadow="0 0 0 3px "+c.border;}',
        '  else{d.classList.remove("sel");d.style.borderColor=c.border;d.style.boxShadow="none";}',
        '}',
        'function enviar(){',
        '  var t=Array.from(document.querySelectorAll(".cb:checked")).map(function(c){return parseInt(c.value);});',
        '  if(!t.length){alert("Selecciona al menos un tema");return;}',
        '  var btn=document.getElementById("btn");',
        '  btn.disabled=true;btn.textContent="Enviando...";',
        '  var v={id:Date.now().toString(36)+Math.random().toString(36).substr(2,4),ts:Date.now(),fuente:"acto",temas:t};',
        '  db.ref("votaciones_relas/"+MUN+"/"+SES+"/respuestas").push(v)',
        '    .then(function(){',
        '      document.getElementById("form").style.display="none";',
        '      document.getElementById("ok").style.display="block";',
        '    })',
        '    .catch(function(e){btn.disabled=false;btn.textContent="‚úÖ Enviar mi voto";alert("Error. Comprueba tu conexi√≥n.");console.error(e);});',
        '}',
        'build();'
    ].join('\n');

    var h='<!DOCTYPE html>\n<html lang="es">\n<head>\n';
    h+='<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width,initial-scale=1">\n';
    h+='<title>Vota tu salud ¬∑ '+nombre+'</title>\n';
    h+='<style>\n'+css+'\n</style>\n</head>\n<body>\n';
    h+='<div class="wrap" id="form">\n';
    h+='  <div class="cab"><h1>üó≥Ô∏è Vota tu salud</h1><p>Plan Local de Salud ¬∑ '+nombre+'</p></div>\n';
    h+='  <div class="av">‚ÑπÔ∏è Tu voto es an√≥nimo. Elige hasta <strong>5 temas</strong> importantes para tu salud.</div>\n';
    h+='  <div class="sec">';
    h+='<div class="sec-tit">üéØ ¬øSobre qu√© temas de salud deber√≠a actuar tu Ayuntamiento?</div>';
    h+='<div class="sec-sub">Hasta 5 temas ‚Äî <span id="cnt" style="font-weight:700;color:#0074c8">0/5 seleccionados</span></div>';
    h+='<div class="ops" id="ops"></div></div>\n';
    h+='  <button class="btn-ok" id="btn" onclick="enviar()">‚úÖ Enviar mi voto</button>\n';
    h+='</div>\n';
    h+='<div class="gracias" id="ok"><div class="ck">‚úÖ</div>';
    h+='<h2>¬°Gracias por votar!</h2><p>Tu opini√≥n contribuye al Plan Local de Salud de '+nombre+'.</p>';
    h+='<p style="margin-top:1rem;font-size:.85rem;color:#94a3b8;">Puedes cerrar esta ventana.</p></div>\n';
    h+=S+' src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js">'+ES+'\n';
    h+=S+' src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js">'+ES+'\n';
    h+=S+'>\n'+js+'\n'+ES+'\n';
    h+='</body>\n</html>';
    return h;
}


// =====================================================================
// FIN VOTACI√ìN RELAS
// =====================================================================
// =====================================================================
// FIN ANALIZADOR RELAS
// =====================================================================

</script>


<!-- =====================================================
     MODAL PRESENTACI√ìN RESULTADOS RELAS ‚Äî FULLSCREEN
     ===================================================== -->
<div id="relas-presentacion-overlay" style="display:none;position:fixed;inset:0;z-index:99999;background:#f1f5f9;overflow-y:auto;font-family:system-ui,sans-serif">

  <!-- ‚îÄ‚îÄ BARRA SUPERIOR ‚îÄ‚îÄ -->
  <div id="relas-pres-topbar" style="position:sticky;top:0;z-index:10;background:linear-gradient(135deg,#0074c8 0%,#00acd9 100%);border-bottom:none;padding:.75rem 1.5rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
    <!-- Selector de evento -->
    <div style="display:flex;align-items:center;gap:.6rem;flex:1;min-width:240px">
      <span style="color:rgba(255,255,255,.8);font-size:.75rem;white-space:nowrap">EVENTO:</span>
      <select id="relas-pres-evento-sel" onchange="relas_seleccionarEvento()" style="flex:1;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3);border-radius:6px;padding:.4rem .7rem;font-size:.82rem;cursor:pointer">
        <option value="">‚Äî Sin evento seleccionado ‚Äî</option>
      </select>
      <button onclick="relas_nuevoEventoUI()" title="Crear evento" style="padding:.35rem .7rem;background:#0074c8;color:#fff;border:none;border-radius:6px;font-size:.8rem;cursor:pointer;font-weight:700;white-space:nowrap">Ôºã Crear</button>
      <button onclick="relas_borrarEvento()" title="Borrar evento seleccionado" style="padding:.35rem .6rem;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3);border-radius:6px;font-size:.8rem;cursor:pointer" id="relas-btn-borrar-ev">üóë</button>
    </div>
    <!-- Info participantes -->
    <div id="relas-pres-info" style="color:rgba(255,255,255,.75);font-size:.78rem;white-space:nowrap">Sin datos</div>
    <!-- Controles derecha -->
    <div style="display:flex;gap:.5rem;margin-left:auto">
      <button onclick="relas_toggleFullscreen()" style="padding:.4rem .9rem;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3);border-radius:6px;font-size:.78rem;cursor:pointer">‚õ∂ Pantalla completa</button>
      <button onclick="relas_cerrarPresentacion()" style="padding:.4rem .9rem;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3);border-radius:6px;font-size:.78rem;cursor:pointer;font-weight:700">‚úï Cerrar</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ CABECERA EVENTO ‚îÄ‚îÄ -->
  <div style="text-align:center;padding:2.5rem 2rem 1.5rem">
    <div id="relas-pres-titulo" style="font-size:clamp(1.6rem,3.5vw,2.8rem);font-weight:800;color:#1e293b;letter-spacing:-.02em;line-height:1.15;margin-bottom:.5rem">
      Priorizaci√≥n Popular de Salud
    </div>
    <div id="relas-pres-subtitulo" style="font-size:clamp(.9rem,1.8vw,1.2rem);color:#475569;font-weight:400">
      Selecciona o crea un evento para personalizar esta pantalla
    </div>
    <div id="relas-pres-badge-n" style="display:inline-block;margin-top:.8rem;background:#e0f2fe;border:1px solid #0074c8;color:#0074c8;border-radius:20px;padding:.3rem 1.1rem;font-size:.82rem;font-weight:600"></div>
  </div>

  <!-- ‚îÄ‚îÄ RANKING √öNICO DE TEMAS ‚îÄ‚îÄ -->
  <div style="padding:0 1.5rem 2rem;max-width:900px;margin:0 auto" id="relas-pres-columnas">
    <div>
      <div style="display:flex;align-items:center;gap:.7rem;margin-bottom:1.2rem;padding:.7rem 1rem;background:#e0f2fe;border-radius:10px;border:1px solid #bae6fd">
        <span style="font-size:1.8rem">üéØ</span>
        <div>
          <div style="color:#0074c8;font-weight:700;font-size:.7rem;text-transform:uppercase;letter-spacing:.1em">Temas prioritarios de salud</div>
          <div style="color:#0369a1;font-size:clamp(.85rem,1.3vw,1rem);font-weight:600">¬øSobre qu√© deber√≠a actuar el Ayuntamiento?</div>
        </div>
      </div>
      <div id="relas-pres-hab" style="display:flex;flex-direction:column;gap:.65rem"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ -->
  <div style="text-align:center;padding:1rem 1.5rem 2rem;border-top:1px solid rgba(255,255,255,.06)">
    <div style="color:#94a3b8;font-size:.72rem" id="relas-pres-footer">
      COMP√ÅS ¬∑ Analizador RELAS ¬∑ Servicio Andaluz de Salud
    </div>
    <button onclick="relas_confirmarPriorizacionTriple()" style="margin-top:.8rem;padding:.6rem 1.6rem;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:8px;font-weight:700;font-size:.85rem;cursor:pointer;box-shadow:0 4px 16px rgba(16,185,129,.3)">
      ‚ö° Confirmar como priorizaci√≥n oficial del municipio
    </button>
  </div>

</div><!-- /relas-presentacion-overlay -->


<!-- DRAWER: DOCUMENTOS DEL PROCESO -->
<div id="drawer-documentos-overlay" onclick="cerrarDrawerDocumentos()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000;"></div>
<div id="drawer-documentos" style="display:none; position:fixed; top:0; right:0; height:100vh; width:min(520px,95vw); background:white; z-index:2001; box-shadow:-4px 0 24px rgba(0,0,0,0.15); overflow-y:auto;">
    <div style="background:linear-gradient(135deg,#6366f1,#8b5cf6); color:white; padding:1.25rem 1.5rem; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:1;">
        <div>
            <h2 style="margin:0; font-size:1.2rem;">&#128203; Documentos del proceso</h2>
            <p style="margin:0.25rem 0 0; font-size:0.8rem; opacity:0.85;">Kits documentales para las 4 reuniones del ciclo anual</p>
        </div>
        <button onclick="cerrarDrawerDocumentos()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:1.2rem;">&#x2715;</button>
    </div>
    <div style="padding:1.5rem;">
        <div class="compilador-header" style="background: linear-gradient(135deg, #6366f115 0%, #8b5cf615 100%); border: 2px solid #6366f1; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h2 style="color: #1e293b; margin: 0;">üìã Documentos del Proceso</h2>
                    <p style="color: #475569; margin: 0.5rem 0 0 0;">Kits documentales para las 4 reuniones del ciclo anual</p>
                </div>
            </div>
        </div>
        
        <!-- REUNI√ìN 1: TALLER DE IMPULSO -->
        <div class="kit-reunion" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #0074c8 0%, #00acd9 100%); color: white; padding: 1rem 1.5rem; cursor: pointer;" onclick="toggleKitReunion(1)">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 0.85rem; opacity: 0.9;">REUNI√ìN 1</span>
                        <h3 style="margin: 0.25rem 0 0 0; font-size: 1.2rem;">üéì Taller de Impulso</h3>
                    </div>
                    <span id="kit-1-toggle" style="font-size: 1.5rem;">‚ñº</span>
                </div>
            </div>
            <div id="kit-1-contenido" style="padding: 1.5rem; display: block;">
                <p style="color: #64748b; margin-bottom: 1rem;">Presentaci√≥n del Informe de Salud, Hoja de ruta RELAS y constituci√≥n del Grupo motor.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                    <!-- Kit previo -->
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #0074c8; margin: 0 0 0.75rem 0; font-size: 0.95rem;">üì§ Kit previo</h4>
                        <button class="btn-export" onclick="generarConvocatoriaTaller()" style="width: 100%; margin-bottom: 0.5rem;">
                            <span>üìÑ</span> Convocatoria
                        </button>
                        <button class="btn-export" onclick="generarFormularioGrupoMotor()" style="width: 100%;">
                            <span>üìù</span> Formulario grupo motor
                        </button>
                    </div>
                    
                    <!-- Kit posterior -->
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #059669; margin: 0 0 0.75rem 0; font-size: 0.95rem;">üì• Kit posterior</h4>
                        <button class="btn-export" onclick="generarActaTaller()" style="width: 100%; margin-bottom: 0.5rem;">
                            <span>üìã</span> Acta del taller
                        </button>
                        <button class="btn-export" onclick="exportarGrupoMotorPDF()" style="width: 100%;">
                            <span>üë•</span> Lista Grupo motor
                        </button>
                    </div>
                </div>
                
                <!-- Datos del Taller -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e2e8f0;">
                    <h4 style="color: #1e293b; margin: 0 0 0.75rem 0; font-size: 0.9rem;">‚öôÔ∏è Datos del Taller</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                        <div>
                            <label style="font-size: 0.8rem; color: #64748b;">Fecha</label>
                            <input type="date" id="taller-fecha" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: #64748b;">Hora</label>
                            <input type="time" id="taller-hora" value="10:00" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: #64748b;">Lugar</label>
                            <input type="text" id="taller-lugar" placeholder="Ej: Sal√≥n de Plenos del Ayuntamiento" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- REUNI√ìN 2: SESI√ìN DE DATOS -->
        <div class="kit-reunion" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #94d40b 0%, #059669 100%); color: white; padding: 1rem 1.5rem; cursor: pointer;" onclick="toggleKitReunion(2)">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 0.85rem; opacity: 0.9;">REUNI√ìN 2</span>
                        <h3 style="margin: 0.25rem 0 0 0; font-size: 1.2rem;">üìä Sesi√≥n de datos</h3>
                    </div>
                    <span id="kit-2-toggle" style="font-size: 1.5rem;">‚ñ∂</span>
                </div>
            </div>
            <div id="kit-2-contenido" style="padding: 1.5rem; display: none;">
                <p style="color: #64748b; margin-bottom: 1rem;">Carga de Determinantes, Indicadores y votaci√≥n ciudadana.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #0074c8; margin: 0 0 0.75rem 0; font-size: 0.95rem;">üì§ Kit previo</h4>
                        <button class="btn-export" onclick="generarConvocatoriaSesionDatos()" style="width: 100%; margin-bottom: 0.5rem;">
                            <span>üìÑ</span> Convocatoria
                        </button>
                        <button class="btn-export" onclick="generarEnlaceVotacion()" style="width: 100%;">
                            <span>üó≥Ô∏è</span> Enlace Votaci√≥n
                        </button>
                    </div>
                    
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #059669; margin: 0 0 0.75rem 0; font-size: 0.95rem;">üì• Kit posterior</h4>
                        <button class="btn-export" onclick="generarActaSesionDatos()" style="width: 100%; margin-bottom: 0.5rem;">
                            <span>üìã</span> Acta de la Sesi√≥n
                        </button>
                        <button class="btn-export" onclick="generarResultadosVotacion()" style="width: 100%;">
                            <span>üìä</span> Resultados Votaci√≥n
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- REUNI√ìN 3: PRIORIZACI√ìN Y PLAN -->
        <div class="kit-reunion" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #ff6600 100%); color: white; padding: 1rem 1.5rem; cursor: pointer;" onclick="toggleKitReunion(3)">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 0.85rem; opacity: 0.9;">REUNI√ìN 3</span>
                        <h3 style="margin: 0.25rem 0 0 0; font-size: 1.2rem;">üéØ Priorizaci√≥n y Plan</h3>
                    </div>
                    <span id="kit-3-toggle" style="font-size: 1.5rem;">‚ñ∂</span>
                </div>
            </div>
            <div id="kit-3-contenido" style="padding: 1.5rem; display: none;">
                <p style="color: #64748b; margin-bottom: 1rem;">Validaci√≥n de prioridades, Plan de acci√≥n y primera actuaci√≥n de Agenda.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #0074c8; margin: 0 0 0.75rem 0; font-size: 0.95rem;">üì§ Kit previo</h4>
                        <button class="btn-export" onclick="generarConvocatoriaPriorizacion()" style="width: 100%; margin-bottom: 0.5rem;">
                            <span>üìÑ</span> Convocatoria
                        </button>
                        <button class="btn-export" onclick="generarBorradorPriorizacion()" style="width: 100%;">
                            <span>üìã</span> Borrador Priorizaci√≥n
                        </button>
                    </div>
                    
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #059669; margin: 0 0 0.75rem 0; font-size: 0.95rem;">üì• Kit posterior</h4>
                        <button class="btn-export" onclick="generarActaPriorizacion()" style="width: 100%; margin-bottom: 0.5rem;">
                            <span>üìã</span> Acta de priorizaci√≥n
                        </button>
                        <button class="btn-export" onclick="exportarPlanAccionPDF()" style="width: 100%;">
                            <span>üìä</span> Plan de acci√≥n
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- REUNI√ìN 4: RENDICI√ìN DE CUENTAS -->
        <div class="kit-reunion" style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 1.5rem; overflow: hidden;">
            <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 1rem 1.5rem; cursor: pointer;" onclick="toggleKitReunion(4)">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 0.85rem; opacity: 0.9;">REUNI√ìN 4</span>
                        <h3 style="margin: 0.25rem 0 0 0; font-size: 1.2rem;">üèõÔ∏è Rendici√≥n de cuentas</h3>
                    </div>
                    <span id="kit-4-toggle" style="font-size: 1.5rem;">‚ñ∂</span>
                </div>
            </div>
            <div id="kit-4-contenido" style="padding: 1.5rem; display: none;">
                <p style="color: #64748b; margin-bottom: 1rem;">Plan Local completo, Aprobaci√≥n Plenaria y devoluci√≥n ciudadana.</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #0074c8; margin: 0 0 0.75rem 0; font-size: 0.95rem;">üì§ Kit previo</h4>
                        <button class="btn-export" onclick="generarConvocatoriaRendicion()" style="width: 100%; margin-bottom: 0.5rem;">
                            <span>üìÑ</span> Convocatoria
                        </button>
                        <button class="btn-export" onclick="generarPropuestaPleno()" style="width: 100%;">
                            <span>üèõÔ∏è</span> Propuesta al pleno
                        </button>
                    </div>
                    
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 1rem;">
                        <h4 style="color: #059669; margin: 0 0 0.75rem 0; font-size: 0.95rem;">üì• Kit posterior</h4>
                        <button class="btn-export" onclick="generarDevolucionCiudadana()" style="width: 100%; margin-bottom: 0.5rem;">
                            <span>üì¢</span> devoluci√≥n ciudadana
                        </button>
                        <button class="btn-export" onclick="exportarPDFPlanLocal()" style="width: 100%;">
                            <span>üìë</span> Plan local completo
                        </button>
                    </div>
                </div>
                
                <!-- Datos de la sesi√≥n plenaria -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e2e8f0;">
                    <h4 style="color: #1e293b; margin: 0 0 0.75rem 0; font-size: 0.9rem;">‚öôÔ∏è Datos de la sesi√≥n plenaria</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                        <div>
                            <label style="font-size: 0.8rem; color: #64748b;">Fecha del Pleno</label>
                            <input type="date" id="pleno-fecha" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: #64748b;">Tipo de Sesi√≥n</label>
                            <select id="pleno-tipo" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="ordinaria">Ordinaria</option>
                                <option value="extraordinaria">Extraordinaria</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function abrirDrawerDocumentos() {
    document.getElementById("drawer-documentos-overlay").style.display = "block";
    document.getElementById("drawer-documentos").style.display = "block";
}
function cerrarDrawerDocumentos() {
    document.getElementById("drawer-documentos-overlay").style.display = "none";
    document.getElementById("drawer-documentos").style.display = "none";
}
document.addEventListener("keydown", function(e) { if (e.key === "Escape") cerrarDrawerDocumentos(); });
// Gesti√≥n API key persistente
function guardarApiKey(val) {
    val = val.trim();
    if (val) {
        localStorage.setItem("compas_ak", val);
        document.getElementById("ia-apikey-bloque").style.display = "none";
        document.getElementById("ia-apikey-ok").style.display = "block";
    }
}
function olvidarApiKey() {
    localStorage.removeItem("compas_ak");
    const inp = document.getElementById("anthropic-api-key");
    if (inp) inp.value = "";
    document.getElementById("ia-apikey-bloque").style.display = "block";
    document.getElementById("ia-apikey-ok").style.display = "none";
}
document.addEventListener("DOMContentLoaded", function() {
    const saved = localStorage.getItem("compas_ak");
    if (saved) {
        const inp = document.getElementById("anthropic-api-key");
        if (inp) inp.value = saved;
        const ok = document.getElementById("ia-apikey-ok");
        if (ok) ok.style.display = "block";
    } else {
        const bloque = document.getElementById("ia-apikey-bloque");
        if (bloque) bloque.style.display = "block";
    }
});
</script>

<script>
// ============================================================
// TAB 2: NUEVO PERFIL DE SALUD LOCAL
// ============================================================

// Variable global para estudios complementarios
window.estudiosComplementarios = [];

// Cargar estudios complementarios (IBSE u otros)
function cargarEstudiosComplementarios(input) {
    const files = Array.from(input.files);
    if (!files.length) return;

    const estadoEl = document.getElementById('estado-estudios');
    estadoEl.innerHTML = '<span style="color:#0369a1;">‚è≥ Procesando ' + files.length + ' archivo(s)...</span>';

    const promesas = files.map(file => new Promise((resolve) => {
        if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
            const reader = new FileReader();
            reader.onload = e => resolve({ nombre: file.name, texto: e.target.result });
            reader.readAsText(file);
        } else if (typeof mammoth !== 'undefined' && (file.name.endsWith('.docx') || file.name.endsWith('.doc'))) {
            const reader = new FileReader();
            reader.onload = e => {
                mammoth.extractRawText({ arrayBuffer: e.target.result })
                    .then(r => resolve({ nombre: file.name, texto: r.value }))
                    .catch(() => resolve({ nombre: file.name, texto: '(error al leer)' }));
            };
            reader.readAsArrayBuffer(file);
        } else {
            // PDF u otros: solo registrar nombre por ahora
            resolve({ nombre: file.name, texto: '(archivo PDF - contenido no extra√≠ble en este navegador)' });
        }
    }));

    Promise.all(promesas).then(resultados => {
        window.estudiosComplementarios = resultados;
        estadoEl.innerHTML = '<span style="color:#16a34a;">‚úÖ ' + resultados.length + ' estudio(s) cargado(s): ' +
            resultados.map(r => r.nombre).join(', ') + '</span>';
        actualizarChecklistIA();
        // Actualizar secci√≥n 03
        renderizarSeccionEstudios();
    });
}

// Actualizar el checklist de fuentes de la IA
function actualizarChecklistIA() {
    const datos = datosMunicipioActual || {};
    const chk = (id, ok) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = (ok ? '‚úÖ' : '‚¨ú') + ' ' + el.innerHTML.slice(2);
    };
    const tieneInforme = datos.informe && datos.informe.htmlCompleto;
    const tieneEstudios = window.estudiosComplementarios && window.estudiosComplementarios.length > 0;
    const tienePopular = !!(window.datosParticipacionCiudadana);
    const tieneDet = datos.determinantes && Object.keys(datos.determinantes).length > 0;
    const tieneInd = datos.indicadores && Object.keys(datos.indicadores).length > 0;

    const checks = {
        'ia-check-informe': tieneInforme,
        'ia-check-estudios': tieneEstudios,
        'ia-check-priorizacion': tienePopular,
        'ia-check-determinantes': tieneDet,
        'ia-check-indicadores': tieneInd,
    };
    const textosFijos = {
        'ia-check-informe': ' Informe de Situaci√≥n de Salud',
        'ia-check-estudios': ' Estudios complementarios',
        'ia-check-priorizacion': ' Prioridades ciudadanas',
        'ia-check-determinantes': ' Determinantes EAS',
        'ia-check-indicadores': ' Indicadores de salud',
    };
    Object.entries(checks).forEach(([id, ok]) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = (ok ? '‚úÖ' : '‚¨ú') + (textosFijos[id] || '');
        el.style.color = ok ? '#166534' : '#94a3b8';
    });

    // Priorizaci√≥n popular badge
    const estPop = document.getElementById('estado-priorizacion-popular');
    if (estPop) {
        if (tienePopular) {
            const p = window.datosParticipacionCiudadana;
            const n = p.totalParticipantes || p.n || '?';
            estPop.innerHTML = '<span style="color:#166534;">‚úÖ ' + n + ' participantes ¬∑ datos disponibles</span>';
        } else {
            estPop.innerHTML = '<span style="color:#94a3b8;">‚è≥ Pendiente de realizar en Tab 3</span>';
        }
    }
}

// Renderizar secci√≥n 03 estudios
// Cargar estudio desde textarea de texto libre
function cargarEstudioTextoLibre(textarea) {
    const texto = textarea.value.trim();
    if (!texto) return;
    if (!window.estudiosComplementarios) window.estudiosComplementarios = [];
    // Reemplazar o a√±adir entrada de texto libre
    const idx = window.estudiosComplementarios.findIndex(e => e.nombre === 'Texto pegado');
    const entrada = { nombre: 'Texto pegado', texto: texto };
    if (idx >= 0) window.estudiosComplementarios[idx] = entrada;
    else window.estudiosComplementarios.push(entrada);
    document.getElementById('estado-estudios').innerHTML = '<span style="color:#0369a1;">‚úÖ Texto cargado (' + texto.length + ' caracteres)</span>';
    actualizarChecklistIA();
    renderizarSeccionEstudios();
}

function renderizarSeccionEstudios() {
    const el = document.getElementById('seccion-estudios-complementarios');
    if (!el) return;
    if (!window.estudiosComplementarios || !window.estudiosComplementarios.length) {
        el.innerHTML = '<div style="padding:1.5rem; text-align:center; color:#94a3b8;"><p>üß† Carga estudios complementarios en ‚öôÔ∏è Gestionar fuentes</p></div>';
        return;
    }
    el.innerHTML = '<div style="padding:1rem;">' +
        window.estudiosComplementarios.map(e =>
            '<div style="padding:0.75rem; background:#f0f9ff; border-radius:8px; margin-bottom:0.5rem; border-left:3px solid #0284c7;">' +
            '<strong style="font-size:0.9rem;">üìé ' + e.nombre + '</strong>' +
            '<p style="font-size:0.8rem; color:#475569; margin:0.25rem 0 0; max-height:80px; overflow:hidden;">' + (e.texto || '').slice(0, 300) + '‚Ä¶</p>' +
            '</div>'
        ).join('') + '</div>';
}

// Renderizar secci√≥n 04 priorizaci√≥n popular
function renderizarSeccionPriorizacion() {
    const el = document.getElementById('seccion-priorizacion-popular');
    if (!el) return;
    const p = window.datosParticipacionCiudadana;
    if (!p) {
        el.innerHTML = '<div style="padding:1.5rem; text-align:center; color:#94a3b8;"><p>üó≥Ô∏è Realiza la votaci√≥n ciudadana en el <strong>Tab 3</strong></p></div>';
        return;
    }
    const n = p.totalParticipantes || p.n || '?';
    let html = '<div style="padding:1rem;">';
    html += '<p style="color:#475569; margin:0 0 0.75rem; font-size:0.9rem;">üë• <strong>' + n + ' participantes</strong></p>';
    if (p.rankingObjetivos && p.rankingObjetivos.length) {
        html += '<h5 style="margin:0 0 0.5rem; color:#6d28d9;">Top objetivos EPVSA votados:</h5>';
        p.rankingObjetivos.slice(0,3).forEach((o,i) => {
            html += '<div style="display:flex; align-items:center; gap:0.75rem; padding:0.5rem; background:#f5f3ff; border-radius:6px; margin-bottom:0.35rem;">' +
                '<span style="font-weight:700; color:#6d28d9;">' + (i+1) + '¬∫</span>' +
                '<span style="flex:1;">' + (o.icono||'üéØ') + ' ' + o.texto + '</span>' +
                '<span style="font-size:0.8rem; color:#7c3aed;">' + o.votos + ' votos (' + o.porcentaje + '%)</span>' +
                '</div>';
        });
    }
    if (p.habFreq) {
        const habTop = Object.entries(p.habFreq).sort((a,b)=>b[1]-a[1]).slice(0,3);
        if (habTop.length) {
            html += '<h5 style="margin:0.75rem 0 0.5rem; color:#059669;">H√°bitos m√°s se√±alados (RELAS):</h5>';
            habTop.forEach(([k,v]) => {
                html += '<div style="font-size:0.85rem; padding:0.35rem 0.5rem; background:#f0fdf4; border-radius:4px; margin-bottom:0.25rem;">' + k + ' ‚Äî ' + v + ' votos</div>';
            });
        }
    }
    html += '</div>';
    el.innerHTML = html;
}

// ============================================================
// GENERADOR DE AN√ÅLISIS IA
// ============================================================

async function generarAnalisisIA() {
    actualizarChecklistIA();
    renderizarSeccionPriorizacion();

    const datos = datosMunicipioActual || {};
    const municipio = getNombreMunicipio(getMunicipioActual()) || 'el municipio';

    // Construir contexto
    let contexto = 'MUNICIPIO: ' + municipio + '\n\n';
    let fuentesUsadas = [];

    if (datos.informe && datos.informe.htmlCompleto) {
        const texto = datos.informe.htmlCompleto.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').slice(0, 8000);
        contexto += '=== INFORME DE SITUACI√ìN DE SALUD ===\n' + texto + '\n\n';
        fuentesUsadas.push('Informe de Situaci√≥n');
    }

    if (window.estudiosComplementarios && window.estudiosComplementarios.length) {
        window.estudiosComplementarios.forEach(e => {
            contexto += '=== ESTUDIO: ' + e.nombre + ' ===\n' + (e.texto || '').slice(0, 3000) + '\n\n';
        });
        fuentesUsadas.push('Estudios complementarios');
    }

    // Priorizaci√≥n de h√°bitos, problemas y colectivos (RELAS) + votaci√≥n ciudadana
    const pop = window.datosParticipacionCiudadana;
    const popRelas = window.datosVotacionRelas || (pop && pop.fuente === 'votacion_relas' ? pop : null);
    const popEpvsa = pop && pop.fuente !== 'votacion_relas' ? pop : null;
    const hayPop = pop || popRelas;
    if (hayPop) {
        let popTexto = '';
        // H√°bitos, problemas y colectivos (RELAS)
        const freqObj = (popRelas || pop);
        if (freqObj && freqObj.habFreq && Object.keys(freqObj.habFreq).length) {
            const top = Object.entries(freqObj.habFreq).sort((a,b)=>b[1]-a[1]).slice(0,8);
            popTexto += 'H√ÅBITOS DE VIDA m√°s se√±alados por la ciudadan√≠a:\n' + top.map(([k,v]) => '  - ' + k + ' (' + v + ' menciones)').join('\n') + '\n\n';
        }
        if (freqObj && freqObj.probFreq && Object.keys(freqObj.probFreq).length) {
            const top = Object.entries(freqObj.probFreq).sort((a,b)=>b[1]-a[1]).slice(0,8);
            popTexto += 'PROBLEMAS DE SALUD m√°s se√±alados por la ciudadan√≠a:\n' + top.map(([k,v]) => '  - ' + k + ' (' + v + ' menciones)').join('\n') + '\n\n';
        }
        if (freqObj && freqObj.colFreq && Object.keys(freqObj.colFreq).length) {
            const top = Object.entries(freqObj.colFreq).sort((a,b)=>b[1]-a[1]).slice(0,5);
            popTexto += 'COLECTIVOS prioritarios seg√∫n la ciudadan√≠a:\n' + top.map(([k,v]) => '  - ' + k + ' (' + v + ' menciones)').join('\n') + '\n\n';
        }
        const nPart = (freqObj && (freqObj.n || freqObj.totalParticipantes)) || '?';
        popTexto = 'Participantes en la priorizaci√≥n popular: ' + nPart + '\n\n' + popTexto;
        contexto += '=== PRIORIZACI√ìN POPULAR (ciudadan√≠a) ===\n' + popTexto;
        fuentesUsadas.push('Priorizaci√≥n popular');
    }

    if (!fuentesUsadas.length) {
        alert('‚ö†Ô∏è No hay ninguna fuente cargada. Carga al menos el Informe de Situaci√≥n de Salud.');
        return;
    }

    // UI: mostrar progreso
    document.getElementById('ia-estado-inicial').style.display = 'none';
    document.getElementById('ia-resultado').style.display = 'none';
    document.getElementById('ia-progreso').style.display = 'block';
    document.getElementById('ia-progreso-texto').textContent = 'Analizando ' + fuentesUsadas.join(', ') + '...';

    const prompt = `Eres un experto en salud p√∫blica y planificaci√≥n local de salud en Andaluc√≠a (Espa√±a).

Analiza las siguientes fuentes de informaci√≥n sobre ${municipio} y genera un informe estructurado en JSON con este formato EXACTO:

{
  "conclusiones": [
    {"titulo": "string (ej: Envejecimiento poblacional)", "texto": "string (2-3 frases)"},
    ...
  ],
  "recomendaciones": [
    {"titulo": "string", "texto": "string (2-3 frases)"},
    ...
  ],
  "prioridades_epvsa": [
    {"linea": "string (n¬∫ l√≠nea EPVSA)", "objetivo": "string", "justificacion": "string (1-2 frases que conecten los h√°bitos/problemas ciudadanos con la evidencia epidemiol√≥gica)", "fuentes": "string (qu√© fuente lo respalda)"},
    ...
  ]
}

Genera entre 4 y 6 conclusiones, 4-6 recomendaciones, y 3-5 prioridades EPVSA.
Las PRIORIDADES deben surgir de cruzar: (1) los h√°bitos/problemas/colectivos se√±alados por la ciudadan√≠a, (2) los datos epidemiol√≥gicos del informe, y (3) los estudios complementarios disponibles.
Basa las l√≠neas y objetivos en la EPVSA (Estrategia para la Promoci√≥n de la Salud y Prevenci√≥n, Andaluc√≠a).
Responde SOLO con el JSON, sin texto adicional.

FUENTES DISPONIBLES:
${contexto}`;

    try {
        // Recuperar API key
        const apiKey = (localStorage.getItem('compas_ak') || document.getElementById('anthropic-api-key')?.value || '').trim();
        if (!apiKey) {
            document.getElementById('ia-progreso').style.display = 'none';
            document.getElementById('ia-estado-inicial').style.display = 'block';
            document.getElementById('ia-apikey-bloque').style.display = 'block';
            document.getElementById('ia-apikey-ok').style.display = 'none';
            document.getElementById('anthropic-api-key')?.focus();
            return;
        }
        const resp = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 3000,
                messages: [{ role: 'user', content: prompt }]
            })
        });

        const data = await resp.json();
        const textoRespuesta = data.content && data.content[0] ? data.content[0].text : '';

        // Parsear JSON
        const jsonLimpio = textoRespuesta.replace(/```json|```/g, '').trim();
        const resultado = JSON.parse(jsonLimpio);

        // Guardar en Firebase
        const municipioId = getMunicipioActual();
        if (municipioId && typeof db !== 'undefined') {
            db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipioId + '/analisisIA').set({
                ...resultado,
                fechaGeneracion: new Date().toISOString(),
                fuentes: fuentesUsadas
            });
        }

        // Renderizar resultado
        renderizarResultadoIA(resultado);

    } catch (err) {
        document.getElementById('ia-progreso').style.display = 'none';
        document.getElementById('ia-estado-inicial').style.display = 'block';
        alert('‚ùå Error al generar el an√°lisis: ' + err.message);
        console.error(err);
    }
}

function regenerarAnalisisIA() {
    document.getElementById('ia-resultado').style.display = 'none';
    document.getElementById('ia-estado-inicial').style.display = 'block';
    actualizarChecklistIA();
}

function renderizarResultadoIA(r) {
    document.getElementById('ia-progreso').style.display = 'none';
    document.getElementById('ia-resultado').style.display = 'block';
    document.getElementById('ia-fecha-generacion').textContent = 'Generado: ' + new Date().toLocaleString('es-ES');

    // Conclusiones
    const elConc = document.getElementById('ia-conclusiones');
    elConc.innerHTML = (r.conclusiones || []).map((c, i) =>
        '<div style="padding:0.9rem 1rem; background:#eff6ff; border-left:3px solid #3b82f6; border-radius:0 8px 8px 0;">' +
        '<strong style="font-size:0.85rem; color:#1d4ed8;">' + String(i+1).padStart(2,'0') + '. ' + c.titulo + '</strong>' +
        '<p style="margin:0.35rem 0 0; font-size:0.9rem; color:#1e293b; line-height:1.5;">' + c.texto + '</p>' +
        '</div>'
    ).join('');

    // Recomendaciones
    const elRec = document.getElementById('ia-recomendaciones');
    elRec.innerHTML = (r.recomendaciones || []).map((rec, i) =>
        '<div style="padding:0.9rem 1rem; background:#f0fdf4; border-left:3px solid #22c55e; border-radius:0 8px 8px 0;">' +
        '<strong style="font-size:0.85rem; color:#166534;">' + String(i+1).padStart(2,'0') + '. ' + rec.titulo + '</strong>' +
        '<p style="margin:0.35rem 0 0; font-size:0.9rem; color:#1e293b; line-height:1.5;">' + rec.texto + '</p>' +
        '</div>'
    ).join('');

    // Prioridades EPVSA
    const elPri = document.getElementById('ia-prioridades');
    elPri.innerHTML = (r.prioridades_epvsa || []).map((p, i) =>
        '<div style="padding:0.9rem 1rem; background:#f5f3ff; border-left:3px solid #7c3aed; border-radius:0 8px 8px 0;">' +
        '<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; flex-wrap:wrap;">' +
        '<div style="flex:1;">' +
        '<strong style="font-size:0.85rem; color:#6d28d9;">' + String(i+1) + '¬™ prioridad ¬∑ L√≠nea ' + p.linea + '</strong>' +
        '<p style="margin:0.25rem 0; font-size:0.9rem; color:#1e293b; font-weight:600;">' + p.objetivo + '</p>' +
        '<p style="margin:0.25rem 0 0; font-size:0.8rem; color:#64748b;">' + p.justificacion + '</p>' +
        '</div>' +
        '<span style="background:white; border:1px solid #ddd6fe; padding:0.2rem 0.5rem; border-radius:6px; font-size:0.7rem; color:#7c3aed; white-space:nowrap;">' + (p.fuentes || '') + '</span>' +
        '</div></div>'
    ).join('');
}

// Actualizar checklist cuando cambian datos globales (hook sobre actualizarMunicipio)
const _actualizarMunicipioOriginal = typeof actualizarMunicipio === 'function' ? actualizarMunicipio : null;
function actualizarChecklistSiTab2() {
    if (document.getElementById('ia-check-informe')) actualizarChecklistIA();
}
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(actualizarChecklistSiTab2, 500);
});
</script>

<script>
// ============================================================
// POBLAR PERFIL NUEVO - secciones individuales Tab 2
// ============================================================

function limpiarSeccionesPerfil() {
    const vacioPH = '<div style="padding:1.5rem; text-align:center; color:#94a3b8;"><p>Selecciona un municipio para ver los datos</p></div>';
    ['seccion-marco-estrategico','seccion-informe-situacion','seccion-estudios-complementarios',
     'seccion-priorizacion-popular','seccion-determinantes','seccion-indicadores'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = vacioPH;
    });
    // Resetear IA
    const iaInicial = document.getElementById('ia-estado-inicial');
    const iaResultado = document.getElementById('ia-resultado');
    const iaProgreso = document.getElementById('ia-progreso');
    if (iaInicial) iaInicial.style.display = 'block';
    if (iaResultado) iaResultado.style.display = 'none';
    if (iaProgreso) iaProgreso.style.display = 'none';
}

function poblarPerfilNuevo(datos, nombre) {
    datos = datos || {};

    // ‚îÄ‚îÄ 01 MARCO ESTRAT√âGICO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const elMarco = document.getElementById('seccion-marco-estrategico');
    if (elMarco) {
        const config = {
            municipio: nombre,
            distrito: datos.distrito || 'Distrito sanitario Granada-Metropolitano',
            anioInforme: datos.anioInforme || new Date().getFullYear(),
            anioEncuesta: datos.anioEncuesta || (new Date().getFullYear() - 1),
            mesPriorizacion: datos.mesPriorizacion || 'febrero',
            anioPriorizacion: datos.anioPriorizacion || new Date().getFullYear(),
            lineasEstrategia: datos.lineasEstrategia || '1, 3 y 4'
        };
        elMarco.innerHTML = generarMarcoEstrategico(config);
    }

    // ‚îÄ‚îÄ 02 INFORME DE SITUACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const elInforme = document.getElementById('seccion-informe-situacion');
    if (elInforme) {
        if (datos.informe && datos.informe.htmlCompleto) {
            elInforme.innerHTML =
                '<div style="padding:0.75rem 1rem; background:#dcfce7; border-radius:6px; font-size:0.8rem; color:#166534; margin-bottom:0.75rem;">' +
                '‚úÖ Cargado: <strong>' + (datos.informe.nombreArchivo || 'informe.docx') + '</strong>' +
                (datos.informe.fechaCarga ? ' ¬∑ ' + new Date(datos.informe.fechaCarga).toLocaleDateString('es-ES') : '') +
                '</div>' +
                '<div style="max-height:500px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; padding:1.25rem; font-size:0.9rem; line-height:1.6;">' +
                datos.informe.htmlCompleto +
                '</div>';
            // Actualizar estado en panel de carga
            const estInforme = document.getElementById('estado-informe');
            if (estInforme) estInforme.innerHTML = '<span style="color:#16a34a;">‚úÖ ' + (datos.informe.nombreArchivo || 'Cargado') + '</span>';
        } else {
            elInforme.innerHTML =
                '<div style="padding:1.5rem; text-align:center; color:#94a3b8;">' +
                '<p>üìÑ Carga el Informe de Situaci√≥n de Salud en <strong>‚öôÔ∏è Gestionar fuentes</strong></p></div>';
        }
    }

    // ‚îÄ‚îÄ 03 ESTUDIOS COMPLEMENTARIOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    renderizarSeccionEstudios();

    // ‚îÄ‚îÄ 04 PRIORIZACI√ìN POPULAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    renderizarSeccionPriorizacion();

    // ‚îÄ‚îÄ 05 DETERMINANTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const elDet = document.getElementById('seccion-determinantes');
    if (elDet) {
        // Extraer el interior del acorde√≥n de determinantes
        const _tmpDet = document.createElement('div');
        _tmpDet.innerHTML = generarSeccionDeterminantes();
        const _innerDet = _tmpDet.querySelector('.acordeon-contenido');
        elDet.innerHTML = _innerDet ? _innerDet.innerHTML : _tmpDet.innerHTML;
        // Poblar inputs si hay datos
        if (datos.determinantes) {
            setTimeout(() => {
                Object.entries(datos.determinantes).forEach(([codigo, data]) => {
                    const input = document.getElementById('det-' + codigo);
                    if (input) {
                        const valor = typeof data === 'object' ? data.valor : data;
                        if (valor !== null && valor !== undefined) {
                            input.value = valor;
                            actualizarColorDeterminante(input);
                        }
                    }
                });
                actualizarCeldasReferencia();
            }, 150);
        } else {
            setTimeout(actualizarCeldasReferencia, 300);
        }
        // Estado en panel de carga
        const estDet = document.getElementById('estado-determinantes');
        if (estDet) {
            const nDet = datos.determinantes ? Object.keys(datos.determinantes).length : 0;
            estDet.innerHTML = nDet > 0
                ? '<span style="color:#d97706;">‚úÖ ' + nDet + ' determinantes cargados</span>'
                : '<span style="color:#94a3b8;">‚è≥ Sin cargar</span>';
        }
    }

    // ‚îÄ‚îÄ 06 INDICADORES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const elInd = document.getElementById('seccion-indicadores');
    if (elInd) {
        setTimeout(() => {
            const cuadroHTML = generarCuadroMandosIntegral(datos.indicadores || null);
            elInd.innerHTML = cuadroHTML;
            // Tambi√©n actualizar el contenedor original para compatibilidad
            const cuadroContainer = document.getElementById('cuadro-mandos-contenido');
            if (cuadroContainer) cuadroContainer.innerHTML = cuadroHTML;
        }, 500);
        // Estado en panel de carga
        const estInd = document.getElementById('estado-indicadores');
        if (estInd) {
            const nInd = datos.indicadores ? Object.keys(datos.indicadores).length : 0;
            estInd.innerHTML = nInd > 0
                ? '<span style="color:#dc2626;">‚úÖ ' + nInd + ' indicadores cargados</span>'
                : '<span style="color:#94a3b8;">‚è≥ Sin cargar</span>';
        }
    }

    // ‚îÄ‚îÄ IA: actualizar checklist ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    setTimeout(actualizarChecklistIA, 300);

    // ‚îÄ‚îÄ Cargar an√°lisis IA guardado en Firebase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (datos.analisisIA) {
        const iaInicial = document.getElementById('ia-estado-inicial');
        if (iaInicial) iaInicial.style.display = 'none';
        renderizarResultadoIA(datos.analisisIA);
    }
}
</script>

<script>
// ============================================================
// MODO AUTOM√ÅTICO: PROPUESTA EPVSA CON IA
// ============================================================

function regenerarPropuestaIA() {
    document.getElementById('propuesta-automatica-container').style.display = 'none';
    document.getElementById('auto-ia-estado-inicial').style.display = 'block';
    document.getElementById('auto-ia-progreso').style.display = 'none';
}

async function generarPropuestaIA() {
    const municipio = getNombreMunicipio(getMunicipioActual()) || 'el municipio';
    const datos = datosMunicipioActual || {};

    // ‚îÄ‚îÄ Construir contexto (igual que Tab 2 pero orientado a plan) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let contexto = '';
    let fuentesUsadas = [];

    if (datos.informe && datos.informe.htmlCompleto) {
        const texto = datos.informe.htmlCompleto.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').slice(0, 7000);
        contexto += '=== INFORME DE SITUACI√ìN DE SALUD ===\n' + texto + '\n\n';
        fuentesUsadas.push('Informe de Situaci√≥n');
    }

    if (window.estudiosComplementarios && window.estudiosComplementarios.length) {
        window.estudiosComplementarios.forEach(e => {
            contexto += '=== ESTUDIO: ' + e.nombre + ' ===\n' + (e.texto || '').slice(0, 2500) + '\n\n';
        });
        fuentesUsadas.push('Estudios complementarios');
    }

    const pop = window.datosParticipacionCiudadana;
    if (pop) {
        let popTxt = 'Participantes: ' + (pop.totalParticipantes || pop.n || '?') + '\n';
        if (pop.habFreq && Object.keys(pop.habFreq).length) {
            const top = Object.entries(pop.habFreq).sort((a,b)=>b[1]-a[1]).slice(0,8);
            popTxt += 'H√ÅBITOS m√°s se√±alados:\n' + top.map(([k,v])=>'  - '+k+' ('+v+')').join('\n') + '\n';
        }
        if (pop.probFreq && Object.keys(pop.probFreq).length) {
            const top = Object.entries(pop.probFreq).sort((a,b)=>b[1]-a[1]).slice(0,8);
            popTxt += 'PROBLEMAS m√°s se√±alados:\n' + top.map(([k,v])=>'  - '+k+' ('+v+')').join('\n') + '\n';
        }
        if (pop.colFreq && Object.keys(pop.colFreq).length) {
            const top = Object.entries(pop.colFreq).sort((a,b)=>b[1]-a[1]).slice(0,5);
            popTxt += 'COLECTIVOS prioritarios:\n' + top.map(([k,v])=>'  - '+k+' ('+v+')').join('\n') + '\n';
        }
        contexto += '=== PRIORIZACI√ìN CIUDADANA ===\n' + popTxt + '\n';
        fuentesUsadas.push('Priorizaci√≥n ciudadana');
    }

    // A√±adir determinantes/indicadores si existen (como contexto complementario, no principal)
    if (datos.determinantes && Object.keys(datos.determinantes).length) {
        const detResumen = Object.entries(datos.determinantes).slice(0,20)
            .map(([k,v]) => k + ': ' + (typeof v === 'object' ? v.valor : v)).join(', ');
        contexto += '=== DATOS EAS (estimaciones) ===\n' + detResumen + '\n\n';
    }

    if (!fuentesUsadas.length) {
        document.getElementById('auto-ia-estado-inicial').style.display = 'block';
        alert('‚ö†Ô∏è Carga al menos el Informe de Situaci√≥n de Salud en el Tab 2 antes de generar la propuesta autom√°tica.');
        return;
    }

    const apiKey = (localStorage.getItem('compas_ak') || '').trim();
    if (!apiKey) {
        alert('‚ö†Ô∏è Configura primero la API Key de Anthropic en el Tab 2 ‚Üí secci√≥n 07 An√°lisis IA.');
        return;
    }

    // UI progreso
    document.getElementById('auto-ia-estado-inicial').style.display = 'none';
    document.getElementById('auto-ia-progreso').style.display = 'block';
    document.getElementById('propuesta-automatica-container').style.display = 'none';

    // Obtener estructura EPVSA disponible para dar contexto al modelo
    let epvsaContexto = '';
    try {
        const estructura = getEstructuraActual();
        epvsaContexto = estructura.slice(0,4).map(l =>
            'L√≠nea ' + l.id + ': ' + l.titulo + '\n' +
            (l.objetivos || []).slice(0,3).map((o,i) => '  Obj ' + i + ': ' + o.titulo).join('\n')
        ).join('\n\n');
    } catch(e) {}

    const prompt = `Eres un experto en salud p√∫blica y planificaci√≥n local de salud en Andaluc√≠a (Espa√±a).

Analiza la informaci√≥n de ${municipio} y genera una PROPUESTA DE PLAN DE ACCI√ìN en formato JSON exacto:

{
  "justificacion_global": "string (2-3 frases resumiendo los principales hallazgos)",
  "fortalezas": [
    {"area": "string", "texto": "string"}
  ],
  "oportunidades": [
    {"area": "string", "texto": "string"}
  ],
  "propuestaEPVSA": [
    {
      "lineaId": n√∫mero (1-4),
      "titulo": "string (t√≠tulo de la l√≠nea)",
      "relevancia": n√∫mero (1-10),
      "justificacion": "string (por qu√© esta l√≠nea, conectando con los datos)",
      "objetivos": [√≠ndice_num√©rico, ...],
      "programas": [√≠ndice_num√©rico, ...]
    }
  ]
}

IMPORTANTE:
- lineaId debe ser 1, 2, 3 o 4 seg√∫n la EPVSA
- objetivos y programas son √≠ndices (0, 1, 2...) dentro de esa l√≠nea
- Prop√≥n 2-3 l√≠neas ordenadas por relevancia (mayor primero)
- Las fortalezas y oportunidades deben surgir de los datos reales, no de estimaciones
- Responde SOLO con el JSON

ESTRUCTURA EPVSA disponible:
${epvsaContexto}

FUENTES (${fuentesUsadas.join(', ')}):
${contexto}`;

    try {
        const resp = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 2000,
                messages: [{ role: 'user', content: prompt }]
            })
        });

        const data = await resp.json();
        const textoRespuesta = data.content && data.content[0] ? data.content[0].text : '';
        const jsonLimpio = textoRespuesta.replace(/```json|```/g, '').trim();
        const resultado = JSON.parse(jsonLimpio);

        // Guardar en Firebase
        const municipioId = getMunicipioActual();
        if (municipioId && typeof db !== 'undefined') {
            db.ref('estrategias/' + estrategiaActual + '/municipios/' + municipioId + '/propuestaIA').set({
                ...resultado,
                fechaGeneracion: new Date().toISOString(),
                fuentes: fuentesUsadas
            });
        }

        // Renderizar en propuesta-automatica-container (formato compatible con aceptarPropuesta)
        renderizarPropuestaIA(resultado, municipio, fuentesUsadas);

    } catch(err) {
        document.getElementById('auto-ia-progreso').style.display = 'none';
        document.getElementById('auto-ia-estado-inicial').style.display = 'block';
        alert('‚ùå Error al generar propuesta: ' + err.message);
        console.error(err);
    }
}

function renderizarPropuestaIA(r, municipio, fuentes) {
    document.getElementById('auto-ia-progreso').style.display = 'none';

    // ‚îÄ‚îÄ Resumen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let resumenHTML = '<h3 style="color:#059669; margin:0 0 1rem;">üìä Propuesta para ' + municipio + '</h3>';
    resumenHTML += '<p style="background:#ecfdf5; padding:0.75rem 1rem; border-radius:8px; border-left:3px solid #10b981; color:#064e3b; margin-bottom:1.25rem;">' + (r.justificacion_global || '') + '</p>';
    resumenHTML += '<p style="font-size:0.8rem; color:#94a3b8; margin-bottom:1rem;">Fuentes: ' + fuentes.join(' ¬∑ ') + '</p>';

    if (r.fortalezas && r.fortalezas.length) {
        resumenHTML += '<h4 style="color:#059669; margin:1rem 0 0.5rem;">‚úÖ Fortalezas identificadas</h4><div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:0.5rem;">';
        r.fortalezas.forEach(f => {
            resumenHTML += '<div style="background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; padding:0.75rem;"><strong style="font-size:0.85rem; color:#166534;">' + f.area + '</strong><p style="margin:0.25rem 0 0; font-size:0.8rem; color:#374151;">' + f.texto + '</p></div>';
        });
        resumenHTML += '</div>';
    }

    if (r.oportunidades && r.oportunidades.length) {
        resumenHTML += '<h4 style="color:#d97706; margin:1rem 0 0.5rem;">üéØ Oportunidades de mejora</h4><div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:0.5rem;">';
        r.oportunidades.forEach(o => {
            resumenHTML += '<div style="background:#fffbeb; border:1px solid #fde68a; border-radius:8px; padding:0.75rem;"><strong style="font-size:0.85rem; color:#92400e;">' + o.area + '</strong><p style="margin:0.25rem 0 0; font-size:0.8rem; color:#374151;">' + o.texto + '</p></div>';
        });
        resumenHTML += '</div>';
    }

    document.getElementById('propuesta-resumen').innerHTML = resumenHTML;

    // ‚îÄ‚îÄ Detalle EPVSA propuesto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let detalleHTML = '<h4 style="color:#1e293b; margin:1.5rem 0 0.75rem;">üìã L√≠neas EPVSA propuestas</h4>';
    (r.propuestaEPVSA || []).forEach((p, i) => {
        detalleHTML += '<div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:1rem; margin-bottom:0.75rem; border-left:4px solid #10b981;">';
        detalleHTML += '<div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.5rem;">';
        detalleHTML += '<span style="background:#10b981; color:white; width:24px; height:24px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.8rem; font-weight:700;">' + (i+1) + '</span>';
        detalleHTML += '<strong>L√≠nea ' + p.lineaId + ': ' + (p.titulo || '') + '</strong>';
        detalleHTML += '<span style="margin-left:auto; background:#d1fae5; color:#065f46; padding:0.15rem 0.5rem; border-radius:10px; font-size:0.75rem;">Relevancia ' + (p.relevancia || '?') + '/10</span>';
        detalleHTML += '</div>';
        detalleHTML += '<p style="font-size:0.85rem; color:#475569; margin:0;">' + (p.justificacion || '') + '</p>';
        detalleHTML += '</div>';
    });
    document.getElementById('propuesta-detalle').innerHTML = detalleHTML;

    // ‚îÄ‚îÄ Guardar propuestaActual en formato compatible con aceptarPropuesta ‚îÄ‚îÄ‚îÄ‚îÄ
    window.propuestaActual = r.propuestaEPVSA || [];

    // Mostrar contenedor
    document.getElementById('propuesta-automatica-container').style.display = 'block';
    document.getElementById('propuesta-automatica-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>

<!-- ‚ïê‚ïê MODALES RELAS ‚Äî fuera de contenedor display:none ‚ïê‚ïê -->
<div id="relas-nuevo-evento-modal" style="display:none;position:fixed;inset:0;z-index:100001;background:rgba(0,0,0,.7);align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:14px;padding:1.8rem;width:90%;max-width:460px;box-shadow:0 20px 60px rgba(0,0,0,.2);border:1px solid #e2e8f0">
    <h3 style="color:#1e293b;margin:0 0 1.2rem;font-size:1.1rem">‚úèÔ∏è Nuevo evento de priorizaci√≥n</h3>
    <div style="margin-bottom:1rem">
      <label style="color:#64748b;font-size:.78rem;font-weight:600;display:block;margin-bottom:.4rem">NOMBRE DEL EVENTO</label>
      <input id="relas-nuevo-evento-nombre" placeholder="Ej: Priorizaci√≥n Popular de Salud Zagra 2026"
        style="width:100%;padding:.7rem .9rem;background:#f8fafc;color:#1e293b;border:1px solid #e2e8f0;border-radius:8px;font-size:.9rem;box-sizing:border-box"
        onkeydown="if(event.key==='Enter')relas_crearEvento()">
    </div>
    <div style="margin-bottom:1rem">
      <label style="color:#64748b;font-size:.78rem;font-weight:600;display:block;margin-bottom:.4rem">SUBT√çTULO (opcional)</label>
      <input id="relas-nuevo-evento-subtitulo" placeholder="Ej: Sesi√≥n participativa ¬∑ Junio 2026"
        style="width:100%;padding:.7rem .9rem;background:#f8fafc;color:#1e293b;border:1px solid #e2e8f0;border-radius:8px;font-size:.9rem;box-sizing:border-box">
    </div>
    <div style="display:flex;gap:.75rem;margin-top:1.4rem">
      <button onclick="document.getElementById('relas-nuevo-evento-modal').style.display='none'" style="flex:1;padding:.7rem;background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer;font-weight:600">Cancelar</button>
      <button onclick="relas_crearEvento()" style="flex:2;padding:.7rem;background:linear-gradient(135deg,#0074c8,#00acd9);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:.9rem">‚úÖ Crear evento</button>
    </div>
  </div>
</div>
<div class="relas-triple-modal" id="relas-tripleModal">
  <div class="relas-triple-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <h3 style="margin:0;color:#2d6a4f">‚ö° Priorizaci√≥n triple fusionada</h3>
      <button onclick="document.getElementById('relas-tripleModal').classList.remove('open')" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:#888">‚úï</button>
    </div>
    <p style="font-size:.78rem;color:#666;margin-bottom:.5rem">Algoritmo de fusi√≥n ponderada: <strong>55% epidemiol√≥gico</strong> + <strong>30% ciudadano</strong> + <strong>15% RELAS</strong></p>
    <div class="relas-triple-cols" id="relas-triple-cols-content"></div>
    <button class="relas-confirm-btn" onclick="relas_confirmarPriorizacionTriple()">‚úÖ Confirmar y guardar como priorizaci√≥n oficial</button>
  </div>
</div>
<div class="relas-ficha-overlay" id="relas-fichaOverlay" onclick="relas_closeFicha(event)">
  <div class="relas-ficha-box" id="relas-fichaModal"></div>
</div>

</body>
</html>
